<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note PR20: LaserWriter Driver Surprises in 5.0 and Newer</title><meta name="categories" content="Printing"><meta name="week-posted" content="Mar 28, 1988 - Apr 1, 1988"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002641" title="LaserWriter Driver Surprises in 5.0 and Newer"></a><a name="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxPrinting-date.html">Printing</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/Printing/index.html" target="_blank">Reference Library > Printing</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note PR20</div>
<div id="pageheadsub">LaserWriter Driver Surprises in 5.0 and Newer</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext">					 <A HREF="#Section1">Introduction</A><BR><BR><A HREF="#Section2">No Mo' Low</A><BR><BR><A HREF="#Section3">Are You Convertible?</A><BR><BR><A HREF="#Section4">Really Unsupported Features</A><BR><BR><A HREF="#Section5">A Little Less Control</A><BR><BR><A HREF="#Section6">Background Preparations</A><BR><BR>				  <A HREF="#Section7">Fonts In An Application?</A><BR><BR><A HREF="#Section8">Headin' For Trouble</A><BR><BR><A HREF="#Section9"> No Go With Zero </A><BR><BR><A HREF="#References">References</A><BR><BR> <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><p id="introtext">This Technical Note describes some changes in version 5.0 and later LaserWriterdrivers.</p> <!-- end_intro_text --><!-- begin_date --><h3 align=center>[Apr 01 1988]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content --><a name=Section1></A> <H2>Introduction</h2> <p>With the release of LaserWriter 5.0 and background printing, a few changes hadto be made to the LaserWriter driver.  Although these changes were transparentto most applications, some have had problems.  Most of these problems arerelated to use of unsupported features.  This Note details a partial list ofthe changes.</p><a name="Section2"></a><P><A HREF="#top">Back to top</A></P><h2>No Mo' Low</h2><p>Because of the problems supporting both the high-level and low-level interfacesin the background, the low-level interface is all but removed.  Instead of thelow-level calls being executed by the device driver, the _<code>PrCtlCall</code>procedure converts the call into its high-level equivalent before execution.This way, the LaserWriter driver has a common entry point for both thelow-level and high-level interfaces.  Because of this conversion, the low-levelcalls may not be faster than using the high-level equivalents.  In some cases,they may even be slower.</p><p>Version 5.x of the LaserWriter driver also contains a bug with the low-levelinterface.  If an application which uses the low-level Printing Managerinterface encounters an error during the course of the print job, theLaserWriter driver crashes before the application has a chance to see theerror.  Because the error occurs inside the driver, there is no way for anapplication to predict or work around this problem.  The only solution to thisproblem is to use the high-level Printing Manager interface or to upgrade toversion 6.0 or later of the LaserWriter driver which fixes this bug.</p><a name="Section3"></a><P><A HREF="#top">Back to top</A></P><h2>Are You Convertible?</h2><p>Whereas the conversion of the low-level calls should be transparent, theconversion routines make some assumptions.  The conversion routines require acontext in which to operate; the Printing Manager maintains a certain statewhile executing commands, and the conversion routines need access to this stateto perform the conversion.  To provide this context, an application must haveopened a document and a page.  This requirement means that the original methodof using the low-level interface, which is documented in <i>InsideMacintosh</i>, Volume II-164, no longer works, as in the following example:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    PrDrvrOpen;    PrCtlCall(iPrDevCtl, lPrReset, 0, 0);    { Send data to be printed. }    PrCtlCall(iPrDevCtl, lPrPageEnd, 0, 0);</pre>	</TD></TR></TABLE></CENTER><p>Instead, an application should use the following:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    PrDrvrOpen;    PrCtlCall(iPrDevCtl, lPrDocOpen, 0, 0);    PrCtlCall(iPrDevCtl, lPrPageOpen, 0, 0);    { Send data to be printed. }    PrCtlCall(iPrDevCtl, lPrPageClose, 0, 0);    PrCtlCall(iPrDevCtl, lPrDocClose, 0, 0);</pre>	</TD></TR></TABLE></CENTER><p>This method provides the Printing Manager with the context it needs to convertthe calls.</p><a name="Section4"></a><P><A HREF="#top">Back to top</A></P><h2>Really Unsupported Features</h2><p>Sending data to the printer between the <code>_PrOpenDoc</code> or<code>lPrDocOpen</code> and the <code>_PrOpenPage</code> or <code>lPrPageOpen</code> callsis not currently, and has never been supported.  LaserWriter drivers prior to5.0 interpreted this data, but 5.0 and later drivers ignore it.  To download anapplication-specific PostScript dictionary as a headerwith each document, Apple recommends that the application provide a<code>'PREC'</code> resource of <code>ID = 103</code>, as is described in the<i>LaserWriter Reference</i>.</p><a name="Section5"></a><P><A HREF="#top">Back to top</A></P><h2>A Little Less Control</h2><p>Four of the six printer control calls originally supported by the LaserWriterdriver have been discontinued due to lack of use and difficulty supporting withbackground printing.  The four calls which follow were only supported by theLaserWriter driver and only documented in the <i>LaserWriter ReferenceManual.</i></p><p>In addition to these calls, the <code>stdBuf</code> call is also affected.  Thereare two versions of the <code>stdBuf</code> call depending upon the sign of the<code>bytes</code> parameter.  If <code>bytes</code> is negative, the text passed tothe <code>stdBuf</code> call is converted to PostScript text before being sent tothe LaserWriter.  This conversion means that special PostScript characters inthe text are preceded by a PostScript escape character.  In addition,characters with an ASCII value greater than 128 are converted to octal beforebeing sent to the LaserWriter.  This version of the call is no longersupported.</p><p>If the bytes parameter is positive, the text passed to the call is sentdirectly to the LaserWriter without conversion and interpreted as PostScriptinstructions.  This version of the call is still supported, but there is onemore problem.  When an application first opens the low-level driver (via<code>_PrDrvrOpen</code>) with background printing enabled, no clip region isdefined.  If the application then begins sending PostScript to the driver viathe <code>stdBuf</code> call, all of the output is clipped, and only a blank pageis printed.</p><p>To prevent this problem, the application must force a clip region to be sent tothe LaserWriter.  The region is sent by the driver when it receives its firstdrawing command.  Unfortunately, the driver does not consider the<code>stdBuf</code> call to be a drawing command.  To force the clip region on theprinter, the application can use the <code>iPrBitsCtl</code> call to print a smallbitmap outside the printable area of the page.  This call does not have anyeffect on the document, but it fires the bottleneck routine and causes adefinition of the clip region.  Since the clip region is reinitialized at eachcall to <code>lPrPageOpen</code>, the application should send the bitmap once atthe start of each page.  If any other printer control calls precede the<code>stdBuf</code> call, the application does not need to send the bitmap.</p><a name="Section6"></a><P><A HREF="#top">Back to top</A></P><h2>Background Preparations</h2><p>The <code>'PREC' ID = 201</code> mechanism only works when background printing isdisabled.  This limitation is because of difficulties finding the resourceunder MultiFinder.  Since the option only works in the foreground, and sincethere is no way for an application to know if background printing is enabled,an application should avoid using this feature.</p><a name="Section7"></a><P><A HREF="#top">Back to top</A></P><h2>Fonts In An Application?</h2><p>There are two problems when printing application fonts with the LaserWriterdriver.  <i>Application fonts</i> are fonts that are stored in the resourcefork of the application's resource file rather than being stored in the Systemfile.  The first problem occurs when the application font has the same name asthe application's resource file.  If this is the true, the LaserWriter driverincorrectly assumes that the application's resource file is a font file, andcloses it after using the font.  To solve this problem, developers should makesure the name of the application font (i.e., the <code>'FOND'</code> resource) isdifferent from the name of the application's resource file.  Since theapplication can still be renamed by the user, developers should try to select aunique font name.  If the font name does not appear in a font menu, developerscan simply append the application's creator string onto the desired font name(i.e., '<code>MyApplicationFont ZZAP'</code>).</p><p>The second problem with application fonts only occurs when background printingis enabled.  When a print job is performed in the background, the LaserWriterdriver writes all of the data to be printed into a file (called a spool file)for printing at a later time by the PrintMonitor.  Since the LaserWriter driverhas no way of knowing when the file will actually be printed, it cannot assumethat the application will still be open when the job is printed.  This is aproblem if the application contains application fonts that Print Monitor needsat print time.  To solve this problem, the LaserWriter driver must determinewhether the fonts needed by the application are resident in the System file orin the application file.  If they are in the application file, the driver mustcopy them into the spool file so they are available to Print Monitor.  Thispractice can lead to very large spool files, as well as a significant loss ofperformance when background printing is enabled.  To solve these and other userinterface problems related to application fonts, Apple strongly recommends thatdevelopers ship custom application fonts as suitcase files for the user toinstall in the System file.</p><a name="Section8"></a><P><A HREF="#top">Back to top</A></P><h2>Headin' For Trouble</h2><p>There is a minor bug in version 5.0 of the LaserWriter driver that only affectsapplications that parse the PostScript header downloaded by the driver witheach document.  This header contains some PostScript comments that provideinformation about the current job.  One of these comments is<code>IncludeProcSet</code>.  This comment takes three arguments:  a PostScriptdictionary name, a major version number, and a minor version number.  </p><a name="Section9"></a><P><A HREF="#top">Back to top</A></P><h2>No Go With Zero</h2><p>Some applications want to force a font to be downloaded to the LaserWriterwithout actually printing characters with the font.  This can be done in threeeasy steps:</p><ol type="1">	<li>Save the current pen position.</li>	<li>Use any text drawing routine to draw a space character.</li>	<li>Move the pen back to the saved position.</li></ol><p>Some applications use <code>_DrawString</code> with a empty string (e.g.,<code>DrawString('')</code>) to force the font downloading. Although this worked inLaserWriter drivers up to 5.0, these calls are ignored by the 5.1 and laterdrivers.  The main reasons for this change were optimization of performance anda reduction in the size of spool files.</p><a name="References"></a><P><A HREF="#top">Back to top</A></P><h2>References</h2><P><i>Inside Macintosh</i>, Volumes II &amp; V, The Printing Manager</p><P><i>LaserWriter Reference Manual</i></p><P>PostScript is a registered trademark of Adobe Systems Incorporated.</p>         <P><A HREF="#top">Back to top</A></P>         <a name=Downloads></A>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (60K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/pr_20.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/pr/pr_20.html%3Fid%3DDTS10002641-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/pr/pr_20.html%3Fid%3DDTS10002641-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/pr/pr_20.html%3Fid%3DDTS10002641-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>