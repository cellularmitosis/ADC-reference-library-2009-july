<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Dispatching to Translation Extension-Defined Routines (IM: MTb)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING416></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="MoreToolbox-415.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="MoreToolbox-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="MoreToolbox-513.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="MoreToolbox-417.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="MoreToolbox-2.html"><B>More Macintosh Toolbox</B></A> / <BR><DD><A HREF="MoreToolbox-402.html"><B>Chapter 7 - Translation Manager</B></A> / <A HREF="MoreToolbox-414.html"><B>Writing a Translation Extension</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING416-0></A>
<H2><A NAME=MARKER-9-147></A>Dispatching to Translation Extension-Defined Routines</H2>
 As explained in the previous section, the code stored in the translation extension component should be contained in a resource of type <CODE>'xlat'</CODE>. The Component Manager expects that the entry point in this resource is a function having this format:<A NAME=MARKER-2-148></A><P>
<PRE>
FUNCTION TranslateEntry (VAR params: ComponentParameters;
                         storage: Handle): ComponentResult;
</PRE>
 The Component Manager calls your extension by passing <CODE>TranslateEntry</CODE> a request code in the <CODE>params.what</CODE> field of the components parameter record passed in the <CODE>params</CODE> parameter; <CODE>TranslateEntry</CODE> must interpret the request code and possibly dispatch to some other routine in the resource. Your extension must be able to handle the required request codes, defined by these constants:<P>
<PRE>
CONST
   kComponentOpenSelect                   = -1;
   kComponentCloseSelect                  = -2;
   kComponentCanDoSelect                  = -3;
   kComponentVersionSelect                = -4;
</PRE>
 For complete details on required request codes, see the chapter "Component Manager" in this book.<P>
 In addition, your extension must be able to respond to translation-specific request codes. Currently, Macintosh Easy Open defines these six request codes:<P>
<PRE>
CONST
   kTranslateGetFileTranslationList       = 0;
   kTranslateIdentifyFile                 = 1;
   kTranslateTranslateFile                = 2;
   kTranslateGetScrapTranslationList      = 10;
   kTranslateIdentifyScrap                = 11;
   kTranslateTranslateScrap               = 12;
</PRE>
 You can respond to these request codes by calling the Component Manager routine <CODE>CallComponentFunctionWithStorage</CODE>, passing it a pointer to a translation extension-defined routine. <A HREF=#MARKER-9-149>Listing 7-5</A> illustrates how to define a file translation extension entry point routine.<P>
<B>Listing 7-5  <A NAME=MARKER-9-149></A>Handling Component Manager request codes<A NAME=MARKER-2-374></A></B><P>
<PRE>
FUNCTION TranslateEntry (VAR params: ComponentParameters; 
                         storage: Handle): ComponentResult;
TYPE
   LongPtr     =  ^LongInt;
   LongHandle  =  ^LongPtr;
VAR
   mySelf:        ComponentInstance;
   myHandle:      Handle;
   selector:      Integer;
BEGIN
   CASE params.what OF
      kComponentOpenSelect:                  {component is opening}
         BEGIN
            mySelf := ComponentInstance(params.params[0]);
            myHandle := NewHandle(SizeOf(ComponentInstance));
            IF myHandle &lt;&gt; NIL THEN
            BEGIN
               LongHandle(myHandle)^^ := ORD4(mySelf);
               SetComponentInstanceStorage(mySelf, myHandle);
               TranslateEntry := noErr;
            END
            ELSE
               TranslateEntry := MemError;
         END;
      kComponentCloseSelect:                 {component is closing; clean up}
         BEGIN
            IF storage &lt;&gt; NIL THEN
               DisposeHandle(storage);
            TranslateEntry := noErr;
         END;
      kComponentCanDoSelect:                 {return known selectors}
         BEGIN
            selector := Integer((Ptr(params.params)^));
            IF (((kComponentVersionSelect &lt;= selector) 
                  AND (selector &lt;= kComponentOpenSelect))
               OR ((kTranslateGetFileTranslationList &lt;= selector) 
                  AND (selector &lt;= kTranslateTranslateFile))) THEN
               TranslateEntry := 1
            ELSE
               TranslateEntry := 0;
         END;
      kComponentVersionSelect:               {provide version number}
         TranslateEntry := kMyTranslateVersionNumber;
      kTranslateGetFileTranslationList:      {give file translation list}
         TranslateEntry := CallComponentFunctionWithStorage
                              (Handle(storage^^), params, 
                              ComponentFunction(@DoGetFileTranslationList));

      kTranslateIdentifyFile:                {identify a file}
         TranslateEntry := CallComponentFunctionWithStorage
                              (Handle(storage^^), params, 
                              ComponentFunction(@DoIdentifyFile));
      kTranslateTranslateFile:               {translate a file}
         TranslateEntry := CallComponentFunctionWithStorage
                              (Handle(storage^^), params, 
                              ComponentFunction(@DoTranslateFile));
      OTHERWISE                              {unrecognized selector}
         TranslateEntry := badComponentSelector;
   END; {CASE}
END;
</PRE>
 As you can see, the <CODE>TranslateEntry</CODE> function defined in <A HREF=#MARKER-9-149>Listing 7-5</A> simply <BR>inspects the <CODE>params.what</CODE> field to determine which request code to handle. For translation-specific request codes, it dispatches to the appropriate function in <BR>the translation extension. See the following three sections for more details on handling translation-specific request codes.<A NAME=MARKER-2-151></A><P>
 <A NAME=MARKER-2-152></A>Your extension can be dynamically loaded or unloaded at any time. When Macintosh Easy Open first discovers the extension, it loads it into memory and then asks it to return a list specifying which file or scrap types it can translate into which other types. Your extension is also called during a translation to identify files or scraps and, if necessary, to translate them.<P>
 Macintosh Easy Open loads your extension into a subheap of some existing heap. In all likelihood, your extension is loaded into either the system heap or temporary memory. In some cases, however, your extension might be loaded into an application's heap. Your extension is guaranteed 32 KB of available heap space. You should do all allocation in that heap using normal Memory Manager routines. Any memory leaks are reclaimed when your routine returns and the heap is destroyed.<P>
 There is no support for using global variables in the dispatcher defined in <A HREF=#MARKER-9-149>Listing 7-5</A>. In general, the routines you need to implement are separate and self-contained, and so you shouldn't need to use global variables. You can, however, have your dispatcher set up an A5 world that contains global variables.<P>
<DL>
<DT><B>WARNING</B>
<DD>If you use PC-relative global variables (that is, data addressed relative to the program counter), be warned that the Component Manager may purge and reload your code resource. Therefore, all PC-relative global variables must be preinitialized at compile time (not at load time).<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 If you need to access resources that are stored in your translation extension, you should use <CODE>OpenComponentResFile</CODE> and <CODE>CloseComponentResFile</CODE>. The open routine requires the <CODE>ComponentInstance</CODE> parameter supplied to your routine. See <A HREF=MoreToolbox-418.html#MARKER-9-169>Listing 7-7 on page 7-33</A> for an example. You should not call the Resource Manager routines such as <CODE>OpenResFile</CODE> or <CODE>CloseResFile</CODE>.<A NAME=MARKER-2-153></A><P>
<DL>
<DT><B>WARNING</B>
<DD>Do not leave any resource files open when your translation extension exits. Their maps will be left in the subheap when the subheap is freed, causing the Resource Manager to crash.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 The following sections show how to respond to the <CODE>kTranslateGetFileTranslationList</CODE>, <CODE>kTranslateIdentifyFile</CODE>, <BR>and <CODE>kTranslateTranslateFile</CODE> request codes by defining the three file translation extension functions <CODE>DoGetFileTranslationList</CODE>, <CODE>DoIdentifyFile</CODE>, and <CODE>DoTranslateFile</CODE>. You would handle scrap translation in a similar manner.<A NAME=MARKER-2-354></A><P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="MoreToolbox-415.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="MoreToolbox-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="MoreToolbox-513.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="MoreToolbox-417.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="MoreToolbox-3.html">&copy; Apple Computer, Inc.</A><br>6 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>   
