<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>FilterDemo - /Source/CocoaUI/AppleDemoFilter_UIView.m</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxMusicAudio-date.html">Audio</a> &gt; <A HREF="javascript:location.replace('index.html');">FilterDemo</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">FilterDemo</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/Source/CocoaUI/AppleDemoFilter_UIView.m</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/Source/AUSource/Filter.cpp</option>
<option value="listing2.html">/Source/AUSource/Filter.h</option>
<option value="listing3.html">/Source/AUSource/Filter.r</option>
<option value="listing4.html">/Source/AUSource/FilterVersion.h</option>
<option value="listing5.html">/Source/CocoaUI/AppleDemoFilter_GraphView.h</option>
<option value="listing6.html">/Source/CocoaUI/AppleDemoFilter_GraphView.m</option>
<option value="listing7.html">/Source/CocoaUI/AppleDemoFilter_UIView.h</option>
<option value="listing8.html">/Source/CocoaUI/AppleDemoFilter_UIView.m</option>
<option value="listing9.html">/Source/CocoaUI/AppleDemoFilter_ViewFactory.h</option>
<option value="listing10.html">/Source/CocoaUI/AppleDemoFilter_ViewFactory.m</option></select>
				</p>
				</form>
				<p><strong><a href="FilterDemo.zip">Download Sample</a></strong> (&#147;FilterDemo.zip&#148;, 147.8K)<BR>
<strong><a href="FilterDemo.dmg">Download Sample</a></strong> (&#147;FilterDemo.dmg&#148;, 204.4K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*
*  File:    AppleDemoFilter_UIView.m
*  
*  Version:  1.0
* 
*  Created:  April 6, 2005
*  
*  Copyright:  Copyright &copy; 2005 Apple Computer, Inc., All Rights Reserved
* 
*  Disclaimer:  IMPORTANT:  This Apple software is supplied to you by Apple Computer, Inc. (&quot;Apple&quot;) in 
*        consideration of your agreement to the following terms, and your use, installation, modification 
*        or redistribution of this Apple software constitutes acceptance of these terms.  If you do 
*        not agree with these terms, please do not use, install, modify or redistribute this Apple 
*        software.
*
*        In consideration of your agreement to abide by the following terms, and subject to these terms, 
*        Apple grants you a personal, non-exclusive license, under Apple's copyrights in this 
*        original Apple software (the &quot;Apple Software&quot;), to use, reproduce, modify and redistribute the 
*        Apple Software, with or without modifications, in source and/or binary forms; provided that if you 
*        redistribute the Apple Software in its entirety and without modifications, you must retain this 
*        notice and the following text and disclaimers in all such redistributions of the Apple Software. 
*        Neither the name, trademarks, service marks or logos of Apple Computer, Inc. may be used to 
*        endorse or promote products derived from the Apple Software without specific prior written 
*        permission from Apple.  Except as expressly stated in this notice, no other rights or 
*        licenses, express or implied, are granted by Apple herein, including but not limited to any 
*        patent rights that may be infringed by your derivative works or by other works in which the 
*        Apple Software may be incorporated.
*
*        The Apple Software is provided by Apple on an &quot;AS IS&quot; basis.  APPLE MAKES NO WARRANTIES, EXPRESS OR 
*        IMPLIED, INCLUDING WITHOUT LIMITATION THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY 
*        AND FITNESS FOR A PARTICULAR PURPOSE, REGARDING THE APPLE SOFTWARE OR ITS USE AND OPERATION ALONE 
*        OR IN COMBINATION WITH YOUR PRODUCTS.
*
*        IN NO EVENT SHALL APPLE BE LIABLE FOR ANY SPECIAL, INDIRECT, INCIDENTAL OR CONSEQUENTIAL 
*        DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS 
*        OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) ARISING IN ANY WAY OUT OF THE USE, 
*        REPRODUCTION, MODIFICATION AND/OR DISTRIBUTION OF THE APPLE SOFTWARE, HOWEVER CAUSED AND WHETHER 
*        UNDER THEORY OF CONTRACT, TORT (INCLUDING NEGLIGENCE), STRICT LIABILITY OR OTHERWISE, EVEN 
*        IF APPLE HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*
*/

#import &quot;AppleDemoFilter_UIView.h&quot;

enum
{
  kFilterParam_CutoffFrequency = 0,
  kFilterParam_Resonance = 1
};

extern NSString *kGraphViewDataChangedNotification;  // notification broadcast by the view when the user has changed the resonance 
                          // or cutoff values via directly mousing in the graph view

extern NSString *kGraphViewBeginGestureNotification;// notification broadcast by the view when the user has started a gesture
extern NSString *kGraphViewEndGestureNotification;  // notification broadcast by the view when the user has finished a gesture

#pragma mark ____ LISTENER CALLBACK DISPATCHER ____

// This listener responds to parameter changes, gestures, and property notifications
void EventListenerDispatcher (void *inRefCon, void *inObject, const AudioUnitEvent *inEvent, UInt64 inHostTime, Float32 inValue)
{
  AppleDemoFilter_UIView *SELF = (AppleDemoFilter_UIView *)inRefCon;
  [SELF priv_eventListener:inObject event: inEvent value: inValue];
}

@implementation AppleDemoFilter_UIView
#pragma mark ____ (INIT /) DEALLOC ____
- (void)dealloc {
    [self priv_removeListeners];
  [mBackgroundColor release];
    
  free (mData);
  
    [super dealloc];
}

#pragma mark ____ PUBLIC FUNCTIONS ____
- (void)setAU:(AudioUnit)inAU {
  // remove previous listeners
  if (mAU) 
    [self priv_removeListeners];
  
  if (!mData)                      // only allocate the data once
    mData = malloc(kNumberOfResponseFrequencies * sizeof(FrequencyResponse));
  
  mData = [graphView prepareDataForDrawing: mData];  // fill out the initial frequency values for the data displayed by the graph

  // register for resize notification and data changes for the graph view
  [[NSNotificationCenter defaultCenter] addObserver: self selector: @selector(handleGraphDataChanged:) name: kGraphViewDataChangedNotification object: graphView];
  [[NSNotificationCenter defaultCenter] addObserver: self selector: @selector(handleGraphSizeChanged:) name: NSViewFrameDidChangeNotification  object: graphView];

  [[NSNotificationCenter defaultCenter] addObserver: self selector: @selector(beginGesture:) name: kGraphViewBeginGestureNotification object: graphView];
  [[NSNotificationCenter defaultCenter] addObserver: self selector: @selector(endGesture:) name: kGraphViewEndGestureNotification object: graphView];

  mAU = inAU;
    
  // add new listeners
  [self priv_addListeners];
  
  // initial setup
  [self priv_synchronizeUIWithParameterValues];
}

- (void)drawRect:(NSRect)rect
{
  if (!mBackgroundColor)  // if the background color has not yet been allocated, allocate it
    mBackgroundColor = [[NSColor colorWithPatternImage: [NSImage imageNamed: @&quot;SectionPatternLight&quot;]] retain];
  
  [mBackgroundColor set];
  NSRectFill(rect);    // this call is much faster than using NSBezierPath, but it doesn't handle non-opaque colors
  
  [super drawRect: rect];  // we call super to draw all other controls after we have filled the background
}

#pragma mark ____ INTERFACE ACTIONS ____

- (IBAction) cutoffFrequencyChanged:(id)sender {
  float floatValue = [sender floatValue];
  AudioUnitParameter cutoffParameter = {mAU, kFilterParam_CutoffFrequency, kAudioUnitScope_Global, 0 };
  
  NSAssert(  AUParameterSet(mAUEventListener, sender, &amp;cutoffParameter, (Float32)floatValue, 0) == noErr,
                @&quot;[AppleDemoFilter_UIView cutoffFrequencyChanged:] AUParameterSet()&quot;);
}

- (IBAction) resonanceChanged:(id)sender {
  float floatValue = [sender floatValue];
  AudioUnitParameter resonanceParameter = {mAU, kFilterParam_Resonance, kAudioUnitScope_Global, 0 };

  NSAssert(  AUParameterSet(mAUEventListener, sender, &amp;resonanceParameter, (Float32)floatValue, 0) == noErr,
                @&quot;[AppleDemoFilter_UIView resonanceChanged:] AUParameterSet()&quot;);
}

- (void) handleGraphDataChanged:(NSNotification *) aNotification {
  float resonance = [graphView getRes];
  float cutoff  = [graphView getFreq];
  
  AudioUnitParameter cutoffParameter    = {mAU, kFilterParam_CutoffFrequency, kAudioUnitScope_Global, 0 };
  AudioUnitParameter resonanceParameter  = {mAU, kFilterParam_Resonance, kAudioUnitScope_Global, 0 };
  
  NSAssert(  AUParameterSet(mAUEventListener, cutoffFrequencyField, &amp;cutoffParameter, (Float32)cutoff, 0) == noErr,
                @&quot;[AppleDemoFilter_UIView cutoffFrequencyChanged:] AUParameterSet()&quot;);

  NSAssert(  AUParameterSet(mAUEventListener, resonanceField, &amp;resonanceParameter, (Float32)resonance, 0) == noErr,
                @&quot;[AppleDemoFilter_UIView resonanceChanged:] AUParameterSet()&quot;);
}

- (void) handleGraphSizeChanged:(NSNotification *) aNotification {
  mData = [graphView prepareDataForDrawing: mData];  // the size of the graph has changed so we need the graph to reconfigure the data frequencies that it needs to draw
  
  // get the curve data from the audio unit
  UInt32 dataSize = kNumberOfResponseFrequencies * sizeof(FrequencyResponse);
  ComponentResult result = AudioUnitGetProperty(  mAU,
                          kAudioUnitCustomProperty_FilterFrequencyResponse,
                          kAudioUnitScope_Global,
                          0,
                          mData,
                          &amp;dataSize);
  if (result == noErr)
    [graphView plotData: mData];  // ask the graph view to plot the new data
  else if (result == kAudioUnitErr_Uninitialized)
    [graphView disableGraphCurve];
}

- (void) beginGesture:(NSNotification *) aNotification {
  AudioUnitEvent event;
  AudioUnitParameter parameter = {mAU, kFilterParam_CutoffFrequency, kAudioUnitScope_Global, 0 };
  event.mArgument.mParameter = parameter;
  event.mEventType = kAudioUnitEvent_BeginParameterChangeGesture;
  
  AUEventListenerNotify (mAUEventListener, self, &amp;event);
    
  event.mArgument.mParameter.mParameterID = kFilterParam_Resonance;
  AUEventListenerNotify (mAUEventListener, self, &amp;event);
}

- (void) endGesture:(NSNotification *) aNotification {
  AudioUnitEvent event;
  AudioUnitParameter parameter = {mAU, kFilterParam_CutoffFrequency, kAudioUnitScope_Global, 0 };
  event.mArgument.mParameter = parameter;
  event.mEventType = kAudioUnitEvent_EndParameterChangeGesture;
  
  AUEventListenerNotify (mAUEventListener, self, &amp;event);
  
  event.mArgument.mParameter.mParameterID = kFilterParam_Resonance;
  AUEventListenerNotify (mAUEventListener, self, &amp;event);  
}

void addParamListener (AUEventListenerRef listener, void* refCon, AudioUnitEvent *inEvent)
{
  inEvent-&gt;mEventType = kAudioUnitEvent_BeginParameterChangeGesture;
  verify_noerr ( AUEventListenerAddEventType(  listener, refCon, inEvent));
  
  inEvent-&gt;mEventType = kAudioUnitEvent_EndParameterChangeGesture;
  verify_noerr ( AUEventListenerAddEventType(  listener, refCon, inEvent));
  
  inEvent-&gt;mEventType = kAudioUnitEvent_ParameterValueChange;
  verify_noerr ( AUEventListenerAddEventType(  listener, refCon, inEvent));  
}

#pragma mark ____ PRIVATE FUNCTIONS ____
- (void)priv_addListeners 
{
  if (mAU) {
    verify_noerr( AUEventListenerCreate(EventListenerDispatcher, self,
                      CFRunLoopGetCurrent(), kCFRunLoopDefaultMode, 0.05, 0.05, 
                      &amp;mAUEventListener));
    
    AudioUnitEvent auEvent;
    AudioUnitParameter parameter = {mAU, kFilterParam_CutoffFrequency, kAudioUnitScope_Global, 0 };
    auEvent.mArgument.mParameter = parameter;    
      
    addParamListener (mAUEventListener, self, &amp;auEvent);
    
    auEvent.mArgument.mParameter.mParameterID = kFilterParam_Resonance;
    addParamListener (mAUEventListener, self, &amp;auEvent);
    
    /* Add a listener for the changes in our custom property */
    /* The Audio unit will send a property change when the unit is intialized */    
    auEvent.mEventType = kAudioUnitEvent_PropertyChange;
    auEvent.mArgument.mProperty.mAudioUnit = mAU;
    auEvent.mArgument.mProperty.mPropertyID = kAudioUnitCustomProperty_FilterFrequencyResponse;
    auEvent.mArgument.mProperty.mScope = kAudioUnitScope_Global;
    auEvent.mArgument.mProperty.mElement = 0;    
    verify_noerr (AUEventListenerAddEventType (mAUEventListener, self, &amp;auEvent));
  }
}

- (void)priv_removeListeners 
{
  if (mAUEventListener) verify_noerr (AUListenerDispose(mAUEventListener));
  mAUEventListener = NULL;
  mAU = NULL;
}


- (void) updateCurve {
  UInt32 dataSize = kNumberOfResponseFrequencies * sizeof(FrequencyResponse);
  ComponentResult result = AudioUnitGetProperty(  mAU,
                          kAudioUnitCustomProperty_FilterFrequencyResponse,
                          kAudioUnitScope_Global,
                          0,
                          mData,
                          &amp;dataSize);
  if (result == noErr)
    [graphView plotData: mData];  // plot the new curve data and redraw the graph
  else if (result == kAudioUnitErr_Uninitialized)
    [graphView disableGraphCurve];
}

- (void)priv_synchronizeUIWithParameterValues {
  Float32 freqValue, resValue;
  AudioUnitParameter parameter = {mAU, kFilterParam_CutoffFrequency, kAudioUnitScope_Global, 0 };
  
  NSAssert (  AudioUnitGetParameter(mAU, kFilterParam_CutoffFrequency, kAudioUnitScope_Global, 0, &amp;freqValue) == noErr,
        @&quot;[AppleDemoFilter_UIView priv_synchronizeUIWithParameterValues] (x.1)&quot;);

  parameter.mParameterID = kFilterParam_Resonance;
  NSAssert (  AudioUnitGetParameter(mAU, kFilterParam_Resonance, kAudioUnitScope_Global, 0, &amp;resValue) == noErr,
        @&quot;[AppleDemoFilter_UIView priv_synchronizeUIWithParameterValues] (x.1)&quot;);
  
  [cutoffFrequencyField setFloatValue: freqValue];  // update the frequency text field
  [graphView setFreq: freqValue];          // update the graph's frequency visual state
  [resonanceField setFloatValue: resValue];    // update the resonance text field
  [graphView setRes: resValue];          // update the graph's gain visual state
  [self updateCurve];
}

#pragma mark ____ LISTENER CALLBACK DISPATCHEE ____
// Handle kAudioUnitProperty_PresentPreset event
- (void)priv_eventListener:(void *) inObject event:(const AudioUnitEvent *)inEvent value:(Float32)inValue {
  switch (inEvent-&gt;mEventType) {
    case kAudioUnitEvent_ParameterValueChange:          // Parameter Changes
      switch (inEvent-&gt;mArgument.mParameter.mParameterID) {
        case kFilterParam_CutoffFrequency:          // handle cutoff frequency parameter
          [cutoffFrequencyField setFloatValue: inValue];  // update the frequency text field
          [graphView setFreq: inValue];          // update the graph's frequency visual state
          break;
        case kFilterParam_Resonance:            // handle resonance parameter
          [resonanceField setFloatValue: inValue];    // update the resonance text field
          [graphView setRes: inValue];          // update the graph's gain visual state
          break;          
      }
      // get the curve data from the audio unit
      [self updateCurve];
      break;
    case kAudioUnitEvent_BeginParameterChangeGesture:      // Begin gesture
      [graphView handleBeginGesture];              // notify graph view to update visual state
      break;
    case kAudioUnitEvent_EndParameterChangeGesture:        // End gesture
      [graphView handleEndGesture];              // notify graph view to update visual state
      break;
    case kAudioUnitEvent_PropertyChange:            // custom property changed
      if (inEvent-&gt;mArgument.mProperty.mPropertyID == kAudioUnitCustomProperty_FilterFrequencyResponse)
        [self updateCurve];
      break;
  }
}

/* If we get a mouseDown, that means it was not in the graph view, or one of the text fields. 
   In this case, we should make the window the first responder. This will deselect our text fields if they are active. */
- (void) mouseDown: (NSEvent *) theEvent {
  [super mouseDown: theEvent];
  [[self window] makeFirstResponder: self];
}

- (BOOL) acceptsFirstResponder {
  return YES;
}

- (BOOL) becomeFirstResponder {  
  return YES;
}

- (BOOL) isOpaque {
  return YES;
}

@end
</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/FilterDemo/listing8.html%3Fid%3DDTS10003570-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/FilterDemo/listing8.html%3Fid%3DDTS10003570-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/FilterDemo/listing8.html%3Fid%3DDTS10003570-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>