<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TN1082: The Problem with &amp; (Simple) Fix to Purgeable WDEFs</title>    <meta name="keywords" content="Mac OS 8 purgeable WDEFs problems Window Manager resources">    <meta name="Description" content="Technical Note TN1082: This Technical Note describes a problemwith purgeable WDEFs and explains how to fix it simply bymarking WDEF resources as                                         non-purgeable."><meta name="categories" content="Human Interface Toolbox"><meta name="week-posted" content="Oct 28, 1996 - Nov 1, 1996"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002923" title="The Problem with & (Simple) Fix to Purgeable WDEFs"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Carbon/idxHumanInterfaceToolbox-date.html" target="_blank">Carbon > Human Interface Toolbox</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1082</div>
<div id="pageheadsub">The Problem with &amp; (Simple) Fix to Purgeable WDEFs</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"> <!-- begin_header_box --> <table width="600" cellpadding="0" cellspacing="0" border="0">	<tr>		<td width=300 valign="top" align=left scope="row">			<table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>				</tr>				<tr bgcolor="#e6e6e6">					<td background="images/tnmenubody.gif" width=300 align=left>						<span id="menutitle">							CONTENTS                             <br>                            <br>						</span>					</td>				</tr>				<tr bgcolor="#e6e6e6">					<td background="images/tnmenubody.gif" width=300 align=left><!-- begin_toc --><p id="menutext">    <A HREF = "#Section1">Defining the Problem</a><BR><BR>    <A HREF = "#Section2">The Problem Scenario</a><BR><BR>    <A HREF = "#Section3">Why This Hasn't Been a Problem Before</a><BR><BR>    <A HREF = "#Section4">The Simple Fix</a><BR><BR>    <A HREF = "#Section5">Additional Notes &amp; Comments</a><BR><BR>    <A HREF = "#Summary">Summary</a><BR><BR>    <A HREF = "#References">Refernces</a><BR><BR>    <A HREF="#Downloads">Downloadables</A></p>                  <!-- end_toc --> 								</td>				</tr>				<tr>					<td width=300 align=left scope="row">						<img src="images/tnmenubottom.gif" alt="" width=300 height=16>					</td>				</tr>			</table>		</td>		<td width=300 valign="top" align=left>			<!-- begin_intro_text -->		<P id = "introtext">This Technote describes a problem with purgeable WDEFs and explains how to fix it simply by marking WDEF resources as non-purgeable. This Note is directed at application developers who include WDEFresources in their applications as well as developers who create WDEF code resources.</p><!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Nov 06 1996]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_header_box --> <BR><BR><hr width=500 align=center>          <BR><BR> <!-- begin_content -->    <a name="Section1">  </a>    <H2>Defining the Problem</h2>          <P>Like other definition functions, WDEFs contain executable code thatneeds to be locked down in memory whenever it is executed. If your applicationis using a custom WDEF marked as purgeable, the Memory Manager may purgethe WDEF resource in order to allocate additional memory in your application heap.  The Window Manager will reload the WDEF resource if necessary before calling it.  If your application is the "current" application, i.e. the one that is executing but may not necessarily be frontmost, the Window Manager can reload the WDEF resource. Everything works fine.</P><P><A HREF="#top">Back to top</A></p>    <a name="Section2">    </A>    <H2>The Problem Scenario</h2>        <P>The following is a sequence of events that may cause the problem to occur: The Window Manager calls your WDEF when it needs to redraw your windowseven if your application is not current. It does this by calling yourWDEF directly whenever your windows get erased. If the WDEF has beenpurged, the Window Manager will try to reload the WDEF. Since your application is not the "current" application, yourapplication's context has not been restored and your resource chain isnot the current resource chain. As a consequence, the Window Managerattempts to load a WDEF from the wrong resource chain.Since it can't find the WDEF, it calls SysError(87).</P><P><A HREF="#top">Back to top</A></p>    <a name="Section3"> </a>    <H2>Why This Hasn't Been a Problem Before</h2>       <p>There are three reasons why this hasn't been a problem in the past. </p><OL TYPE="1" START="1"><LI>Most applications use WDEFs for floating windows. As defined byApple's Human Interface Guidelines (HIG), applications should hide theirfloating windows before being suspended. Since the windows areinvisible, the Window Manager under most circumstances won't try toreload your WDEF if it does get purged. <BR><BR></li><LI>This problem might not be triggered by the fact thatapplications in the background don't normally allocate a lot of memory.For example, even if the WDEF is marked as purgeable, the Memory Managermay not actually cause your WDEF to be purged. <BR><BR></li><LI>Most applications don't run with very tight memory partitions, soeven though a WDEF resource is marked purgeable, it doesn't need to be purged.<BR><BR></li>  </OL><P><A HREF="#top">Back to top</A></p>    <a name="Section4"></a>    <H2>The Simple Fix</h2>    <P>The simple fix to the problem of your WDEFs not being able to bereloaded is to mark your WDEFs as non-purgeable. This prevents theMemory Manager from purging the WDEF, so it is always available even ifyour application is not frontmost.</P><P><A HREF="#top">Back to top</A></p>    <a name="Section5"></a>    <H2>Additional Notes &amp; Comments</h2>        <p>The following are some important items that you may need to considerwhen working through the problem of purgeable WDEFs: </p><UL TYPE=DISC><LI>Other 'DEF types (CDEFs, MDEFs, etc.) won't exhibit this problembecause they don't get called when the application's process globals arenot current as in the case of WDEFs. These resources types can remain purgeable.<BR><BR></li><LI>WDEFs in the System file (or in an enabler file and probably inextensions such as Aaron) can safely be purged because theyare always in the resource chain - no matter which application's processis set up.<BR><BR></li><LI>An application with a purgeable WDEF may have code in it that makes itnon-purgeable after bringing it into memory - in which case, thisproblem won't occur.<BR><BR></li><LI>Third-party memory utilities may force purging to occur more often,thus exacerbating this problem. <BR><BR></li><LI>If there is data embedded in a WDEF and the WDEF gets purged andreloaded, the data will have reverted to its on-disk values. Manypopular development tools embed global variables in code resources. (Ifyour WDEF needs to call SetUpA4, you're using one of these developmentsystems.) A WDEF whose variables suddenly change to unexpected valuescan of course cause any of the crashes normally associated withunexpected values.<BR><BR></li><LI>In general, applications should not detach WDEF resources from theirresource map (see <a href="../tb/tb_575.html">Technical Q&amp;A TB575: Window Manager Q&amp;A's</A>). However, it's worth notingthat detached WDEF resources which are also purgeable can never bereloaded from disk.<BR><BR></li></UL><P><A HREF="#top">Back to top</A></p><a name="Summary"></a><H2>Summary</h2><P>The problem with purgeable WDEFs can be fixed by simply marking theirresources as non-purgeable.</P><BR><P><A HREF="#top">Back to top</A></p><a id="References"></a><h2>References</h2>    <p><a href="../tb/tb_575.html">    Technical Q&amp;A TB575: Window Manager Q&amp;A's</A>    </p><P><A HREF="#top">Back to top</A></p> <A NAME=Downloads></A>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="500">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (128K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tn1082.pdf">Download</A></P>               </TD>            </TR></TABLE><P><A HREF="#top">Back to top</A></P></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1082.html%3Fid%3DDTS10002923-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1082.html%3Fid%3DDTS10002923-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1082.html%3Fid%3DDTS10002923-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --><hr width=500 align=center></BODY></HTML>