<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TN1026: The Notification Manager: Problems &amp; Fixes</title>    <meta name="keywords" content="Mac OS 8 Notification Manager lost events activate UpdateRegionSaver SaveUpdateRegions">    <meta name="Description" content="Technical Note TN1026: This Technical Note describes twoserious problems in the Notification Manager (NM), one havingto do with activate events and the other with update events.These problems can cause windows in your application to bedrawn redundantly or not at all. This Technote provides aworkaround for the active event problem and some sample code,with explanations, for fixing the update event problem."><meta name="categories" content="Processes"><meta name="week-posted" content="Jan 29, 1996 - Feb 2, 1996"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002868" title="The Notification Manager: Problems & Fixes"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/Carbon/index.html">Carbon</a> &gt; <a href="../../technicalnotes/Carbon/idxProcessManagement-date.html">Process Management</a> &gt; </p><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1026</div>
<div id="pageheadsub">The Notification Manager: Problems &amp; Fixes</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"> <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr><td width=300 valign="top" align=left scope="row">    <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td></tr><tr bgcolor="#e6e6e6">    <td background="images/tnmenubody.gif" width=300 align=left><span id="menutitle">    CONTENTS     <BR>    <BR></span>    </td></tr><tr bgcolor="#e6e6e6">    <td background="images/tnmenubody.gif" width=300 align=left><!-- begin_toc --><p id = "menutext"><A HREF="#RTFToC1">Defining the   Problem</A><BR><BR><A HREF="#RTFToC2">Using the Sample CodeLibrary "UpdateRegionSaver" to Work Around theProblem</A><BR><BR><A HREF="#RTFToC3">UpdateRegionSaver Reference</A><BR><BR><A HREF = "#Summary">Summary</a><br><br><A HREF = "#Changes">Change History</a><br><br><A HREF="#Appendix">Appendix A</A><BR><BR><A HREF = "#References">References</a><br><br><A HREF="#Downloads">Downloadables</A></P>   <!-- end_toc -->  </td></tr><tr>    <td width=300 align=left scope="row"><img src="images/tnmenubottom.gif" alt="" width=300 height=16>    </td></tr>    </table></td><td width=300 valign="top" align=left><!-- begin_intro_text -->  <P id = "introtext">This Technote describes two serious problems in theNotification Manager <b><i>prior to Mac OS 9.0</i></b>, one having to do with activateevents and the other with update events. Theseproblems can cause windows in your application tobe drawn redundantly or not at all. This Technoteprovides a workaround for the active event problemand some sample code, with explanations, for fixingthe update event problem.</P><P id = "introtext">If you're an application or applicationframework developer and want to ensure the windowsin your application(s) are always updated andactivated properly, you should read this Note.</P><P id = "introtext">This Technote augments the information presentedin three chapters of <CITE>Inside Macintosh</CITE>: "Event Manager" (Chapter 2) and "Window Manager"(Chapter 4) of <CITE>Macintosh ToolboxEssentials</CITE> and "Notification Manager"(Chapter 5) of <CITE>Processes</CITE></p><!-- end_intro_text --><!-- begin_date --><h3 align=center>&nbsp;[Feb 1 1996]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR> <!-- begin_content --><A NAME=RTFToC1></A><H2>Defining Notification Manager Problems</H2><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>IMPORTANT: </B><BR>Mac OS 9 introduced a   <a href="tn1176.html#notificationmanager">non-modal   Notification   Manager</A>, which   does not suffer either of the problems described   in the technote. If your application requires   Mac OS 9 or later you can ignore this   technote.</P></TD></TR></TABLE></CENTER><BR>   <P>You can use the Notification Manager to presentthe user with a modal dialog (alert) that opens infront of the windows of all applications. Thisdialog actually appears in the window list of thefrontmost application during its call to<code>WaitNextEvent</code>.</P><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>IMPORTANT: </B><BR>Your application should not depend on the   details of the way Notification Manager presents   its dialog, including but not limited to the   fact that Notification Manager uses Dialog   Manager. The information is presented here only   in order to provide a full understanding of the   problem at hand.</P></TD></TR></TABLE></CENTER><BR><P>The first thing to know is that NotificationManager calls the Dialog Manager to manage thedialog. More specifically, Notification Managercalls ModalDialog with a dialog filter which inturn calls the standard dialog filter as obtainedby GetStdFilterProc.</P><P>The fact that Dialog Manager, and in particularModalDialog and the standard dialog filter, provideimperfect event handling means that somewindow-oriented events are "swallowed" (i.e., neverprovided to your application) while the dialog ispresent.</P><H3>Swallowed Deactivate Events (and RedundantActivate Events)</H3><P>Your application does not receive a deactivateevent for the (soon-to-be-former) front window whenthe Notification Manager's dialog appears. This isbecause ModalDialog has its own event loop(partially implemented by the standard dialogfilter) and has no way of passing the deactivateevent off to your application's event loop.</P><P>When the user dismisses Notification Manager'sdialog, your application receives a redundantactivate event for the (recently-reinstated) frontwindow. Your application <B>can</B> make sure itdoesn't logically activate a window (i.e., enabletext fields, etc.) redundantly by simply checkingto see if the window is already active beforelogically activating it.</P><H3>Swallowed Update Events</H3><P>In order to understand how update events getswallowed, you need to understand how they wouldhave been generated in the first place.</P><P>Each window has a region, expressed in globalcoordinates, which describes the portion of thewindow that needs redrawing. This is called thewindow's update region. During <code>WaitNextEvent</code>, theEvent Manager, Window Manager, and Process Managercollaborate in walking the current window list. Ifthe update region of a window is found to benon-empty, they generate an update event for thatwindow.</P><P>When your application receives the update event,it calls <code>BeginUpdate</code>, (re)draws the image for thewindow, and calls <code>EndUpdate</code>. The<code>BeginUpdate/EndUpdate</code> pair of calls empties theupdate region for the window so that subsequentsearches for windows which need updating do notfind that window.</P><P>These update regions are the key tounderstanding how the Notification Manager swallowsupdate events.</P><P>The standard dialog filter, to whichNotification Manager's dialog filter passescontrol, wants to ensure that background apps getprocessing time by "solving" the problem describedin DTS Technote TN1145<a href="tn1147.html">PendingUpdate Perils</A>. The standard filtersimply calls <code>BeginUpdate</code> and <code>EndUpdate</code> every timeit's given an update event, regardless of thewindow for which the event is bound.</P><P>This results in all windows in the currentwindow list having their update regions emptiedalmost immediately. As a consequence, no updateevents are generated for those windows, even thoughthey need to be (re)drawn. When the user dismissesNotification Manager's dialog, only the windowscovered by Notification Manager's dialog get updateevents, and then only for the region covered byNotification Manager's dialog.</P><P>There is nothing straightforward yourapplication can do to prevent swallowed updateevents. While your application innocently waits fora call to <code>WaitNextEvent</code> to return, NotificationManager suddenly puts up its dialog and seizescontrol of the event loop until the user dismissesthe dialog. Your application can't even predictwhen this will happen, much less prevent it oreasily work around it.</P><P><A HREF="#top">Back to top</A></P><A NAME=RTFToC2></A><H2>Using the Sample Code LibraryUpdateRegionSaver to Work Around the Problem</H2><P>Although Apple has fixedboth of these problems in Mac OS 9.0, you mightconsider using some of the sample code presentedhere as a workaround on earlier systems. The samplecode will continue to work, albeit redundantly,even on Mac OS 9.0 and above.</P><P>Most users of <code>UpdateRegionSaver</code> will only needto make three very simple calls, shown in thissample: <code>SaveUpdateRegions</code>, <code>RestoreUpdateRegions</code>,and <code>DeleteUpdateRegions</code>.</P><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>#ifndef __EVENTS__#    include &lt;Events.h&gt;#endif#include "UpdateRegionSaver.h"pascal Boolean WaitNextEventWithNMSafeUpdates    (EventMask eventMask, EventRecord *theEvent,        UInt32 sleep, RgnHandle mouseRgn){    UpdateRegionSaver *root = SaveUpdateRegions ( );    EventRecord event;    Boolean result = WaitNextEvent        (eventMask,theEvent,sleep,mouseRgn);    RestoreUpdateRegions (root);    DeleteSavedUpdateRegions (root);    root = nil;    return result;}</pre>	</TD></TR></TABLE></CENTER>                  <P>For a full listing of each of the three calls,refer to <A HREF="#Appendix">Appendix A</A> at theend of this Technote.</P><P><A HREF="#top">Back to top</A></P><P><A NAME=RTFToC3></A></P><H2>UpdateRegionSaver Reference</H2><P>This section describes the data structures androutines specific to the <code>UpdateRegionSaver</code>library.</P><H3>Data Structures</H3><P>The UpdateRegionSaver library manipulates a datastructure of type UpdateRegionSaver.</P>                  <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>typedef struct UpdateRegionSaver{    RgnHandle            fRgnH;    WindowRef            fRef;    struct UpdateRegionSaver    *fNext;}UpdateRegionSaver;</pre>	</TD></TR></TABLE></CENTER>                  <H4>Field Descriptions</H4>   <code>fRgnH</code>      <p>A region copied from the update region of a   window. It is in global coordinates (as is the   update region itself). Before being restored to   the window, it will be copied and converted to   the local coordinates of the window.</p>      <code>fRef</code>      <p>The address of the window from which the   copy of the update region came. Before restoring   the region, <code>UpdateRegionSaver</code> verifies that   there is still a window at this address in the   window list. (This is not a perfect test, but it   is the best test that can be made without   patching a trap or three.)</p>      <code>fNext</code>    <p>  The address of the next structure in the   linked list. The last node in the list has a 0   here.</p><H3>UpdateRegionSaver Routines</H3><P>To get a list of update regions associated withthe windows in the current window list, call<code>SaveUpdateRegions</code>. To restore the regions to theirowning windows, call <code>RestoreUpdateRegions</code>. Todestroy the list of regions, call<code>DeleteSavedUpdateRegions</code>.</P><H3>SaveUpdateRegions</H3><P>To save the update regions associated with thewindows in your application's window list, callSaveUpdateRegions.</P><P><code>SaveUpdateRegions</code> returns a pointer to the rootof simple singly-linked list which contains a nodefor each window. In each node your application willfind a window pointer, a copy of the window'supdate region, and a pointer to the next node.</P><H3>RestoreUpdateRegions</H3><P>To restore a list of saved update regions to thewindows from which they came, call<code>RestoreUpdateRegions</code>.</P><P><code>RestoreUpdateRegions</code> copies the regions in thelist and converts the copies to the localcoordinates of each window before calling InvalRgnto merge the region into any update region whichmay already be there.</P><H3>DeleteSavedUpdateRegions</H3><P>To delete a list of saved update regions, callDeleteSavedUpdateRegions.</P><P><A HREF="#top">Back to top</A></P><P><A NAME=Summary></A></P><H2>Summary</H2><P>The Notification Manager may present a DialogManager dialog whenever your application calls<code>WaitNextEvent</code>. This impedes the flow ofwindow-related events (such as update or activate)to your application's event loop. Make sure yourapplication doesn't logically activate a windowwhich is already active. Use the <code>UpdateRegionSaver</code>library (or something like it) to ensure yourapplication will always get the update events itrequires.</P><P><A HREF="#top">Back to top</A></P><A NAME="References"></a><H2>References</h2><P>DTS Technote TN1145   <a href="tn1147.html">Pending   Update Perils</A>,   has a discussion of the problem   Notification Manager "solves," as mentioned   previously.</p>      <p>Chapter 6, "Dialog Manager," <CITE>Inside   Macintosh: Macintosh Toolbox Essentials</CITE>   has a description of the operation of   ModalDialog and the standard dialog filter.</p><P><A HREF="#top">Back to top</A></P><a name="Changes"></a><H2>Change History</H2> <TABLE BORDER=0 CELLPADDING=3 WIDTH=544>            <TR>               <td width=100 align=left>                  <P ALIGN=center>01-February-1996</P>               </TD>               <td align="left">                  <P>First written.</P>               </TD>            </TR>            <TR>               <td width=100 align=left>                  <P ALIGN=center>01-November-2000</P>               </TD>               <td align="left">                  <P>Updated to mention that the non-modal Notification   Manager in Mac OS 9.0 fixes both of the problems   described in this technote.</P>               </TD>            </TR>         </TABLE><P><A HREF="#top">Back to top</A></P><P><A NAME=Appendix></A></P><H2>Appendix A</H2><H3>UpdateRegionSaver.h</H3><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>#pragma once#ifndef __WINDOWS__#    include &lt;Windows.h&gt;#endiftypedef struct UpdateRegionSaver{    // We don't care about alignment since this is an internal    // runtime-only structure.    RgnHandle            fRgnH;    WindowRef            fRef;    struct UpdateRegionSaver    *fNext;}UpdateRegionSaver;// I can't figure why this next #ifdef would be necessary for// pascal funcs,but CW7 for PPC says it is.#ifdef __cplusplusextern "C" {#endifpascal void RestoreUpdateRegions (UpdateRegionSaver *);pascal void DeleteSavedUpdateRegions (UpdateRegionSaver *);pascal UpdateRegionSaver * SaveUpdateRegions (void);#ifdef __cplusplus}#endif                  </pre>	</TD></TR></TABLE></CENTER>                                    <H3>UpdateRegionSaver.c</H3>                                    <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>#ifndef __LOWMEM__#    include &lt;LowMem.h&gt;#endif#include "UpdateRegionSaver.h"static pascal Boolean IsWindowStillAround (WindowRef ref){    WindowRef scan = LMGetWindowList ( );    while (scan)    {        if (scan == ref) break;        scan = GetNextWindow (scan);    }    return !!scan;}pascal void RestoreUpdateRegions (UpdateRegionSaver *ursp){    while (ursp)    {        if (!EmptyRgn (ursp-&gt;fRgnH) &amp;&amp; IsWindowStillAround (ursp-&gt;fRef))        {            RgnHandle localUpdateRgn = NewRgn ( );            if (localUpdateRgn)            {                Point zero;                GrafPtr keep = qd.thePort;                SetPort (ursp-&gt;fRef);                zero.h = qd.thePort-&gt;portRect.left;                zero.v = qd.thePort-&gt;portRect.top;                GlobalToLocal (&amp;zero);                CopyRgn (ursp-&gt;fRgnH,localUpdateRgn);                OffsetRgn (localUpdateRgn,zero.h,zero.v);                InvalRgn (localUpdateRgn);                SetPort (keep);                DisposeRgn (localUpdateRgn);            }        }        ursp = ursp-&gt;fNext;    }}pascal void DeleteSavedUpdateRegions (UpdateRegionSaver *ursp){    while (ursp)    {        UpdateRegionSaver *next = ursp-&gt;fNext;        DisposeRgn (ursp-&gt;fRgnH);        DisposePtr ((Ptr) ursp);        ursp = next;    }}pascal UpdateRegionSaver * SaveUpdateRegions (void){    //    //  This function saves as many update regions as it can.    //  If for some reason memory is so low that some regions    //  cannot be saved, this function makes a best effort.    //  (Its best effort is rather stupid, but it does try.)    //    UpdateRegionSaver *root = nil;    WindowRef scan = LMGetWindowList ( );    while (scan)    {        UpdateRegionSaver *newUpdateRegionSaver =            (UpdateRegionSaver *) NewPtr (sizeof (UpdateRegionSaver));        if (!MemError ( ))        {            RgnHandle rgnH = NewRgn ( );            if (!rgnH)            {                DisposePtr ((Ptr) newUpdateRegionSaver);                newUpdateRegionSaver = nil;            }            else            {                GetWindowUpdateRgn (scan,rgnH);                newUpdateRegionSaver-&gt;fRgnH     = rgnH;                newUpdateRegionSaver-&gt;fRef      = scan;                newUpdateRegionSaver-&gt;fNext     = root;                root = newUpdateRegionSaver;            }        }        scan = GetNextWindow (scan);    }    return root;}</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P>          <A NAME=Downloads></A>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (60K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tn1026.pdf">Download</A></P>               </TD>            </TR>         </TABLE>         <BR><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER>		<!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1026.html%3Fid%3DDTS10002868-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1026.html%3Fid%3DDTS10002868-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1026.html%3Fid%3DDTS10002868-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>