<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"        "http://www.w3.org/TR/1998/REC-html40-19980424/loose.dtd"><HTML><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note HW16: NuBus Interrupt Latency (I Was a Teenage DMA Junkie)</title><meta name="categories" content="Hardware"><meta name="week-posted" content="Nov 28, 1988 - Dec 2, 1988"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"><a name="//apple_ref/doc/uid/DTS10002485" title="NuBus Interrupt Latency (I Was a Teenage DMA Junkie)"></a><a name="top"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/index.html" target="_blank">Reference Library > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note HW16</div>
<div id="pageheadsub">NuBus Interrupt Latency (I Was a Teenage DMA Junkie)</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->                     <P id = "menutext">         <A HREF="#Introduction">Introduction</A><BR><BR>     <A HREF="#Summary">Summary</A><BR><BR>    <A HREF="#References">References</A><BR><BR>          <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --> <P id= "introtext">This Technical Note discusses NuBus(TM) interrupt latency, and why, contrary topopular belief, the Macintosh is <b>not</b> a real-time machine.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Dec 01 1988]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR><!-- begin_content --><a name="Introduction"></a><h2>Introduction</h2><P>The Macintosh is <b>not</b> a real-time machine.  The Macintosh does <b>not</b>support DMA.  There are many variables in the Macintosh that make it impossibleto deterministically figure out exactly when things are going to happen.Despite these facts, there are those who must push the envelope.  For thesecourageous adventurers, we provide the following information in the hope thatit speeds your journey.</p><p>According to empirical evidence gathered by Apple engineering, typical NuBus toMacintosh transaction times fall in the 800 nanosecond to 1 microsecond range.Although the NuBus specification points to faster accesses, you should considerthese times realistic since there is always some overhead.  Synchronizing theNuBus and Macintosh clocks, for example, can cost a NuBus cycle.</p><p>One technique that can help optimize NuBus transfers is implementing buslocking.  The bus can be locked for a small set of transactions (we recommend amaximum of four transfers), then unlocked for re-arbitration.  In order to allowfairness, it is important to lock the bus for as short a time as possible.</p><p>All processor interrupts and slot interrupts may be held off for variousamounts of time by different parts of the system, so you must never count oninstant interrupt response.  To help deal with these delays, you shouldconsider your data rate and include ample buffering on your card for your data.The following are just a few of the many system variables which affectinterrupt latency:</p><ul type="disc">	<li>Floppy disk accesses turn off interrupts for "significant" (read milliseconds) amounts of time.  For instance, some disk accesses (i.e., block reads) can disable interrupts for as much as 15 milliseconds.  Inserting a blank floppy disk turns off interrupts for up to 25 milliseconds.</li>	<li> Formatting a floppy disk turns off interrupts for up to 300 milliseconds.</li>	<li>LocalTalk accesses can disable interrupts for up to 22 milliseconds.</li>	<li>Assuming your interrupt handler is going to want to access your card immediately, there is also the arbitration for mastership of the bus, which could be in use at the time, and in the worst case, lock the bus, keeping you from accessing your card.</li>	<li>All slot interrupts, including slot VBL interrupts, hold off other slot interrupts.  This means another card's interrupt routine (installed via <code>_SIntInstall</code>) or a slot VBL interrupt routine (installed via <code>_SlotVInstall</code>) runs to completion with interrupts of the slot level and below disabled.  VBL tasks may be of varying length, since applications, as well as drivers, can and do, install VBL tasks.</li>	<li>Cursor updating (performed during slot VBL time) time ranges from around 700 uSec - 900 uSec for one-bit to eight-bit depth.  Since this is done at slot VBL time, it holds off all other slot interrupts until it is finished.</li></ul><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Warning:</B><BR>The performance figures cited in this Note are based on currentMacintosh models; they are not guaranteed to remain the same in future machines.</P></TD></TR></TABLE></CENTER><BR><P>The following code lets you defer the cursor updating routine by having it runas a deferred task.  This change means that the actual cursor rendering isperformed with interrupts enabled, which allows the occurrence of otherinterrupts.  It should be noted that there is a slightly visible flickering ofthe cursor as a result of using this technique.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>*****************************************************************************     Defer Cursor***     This program defers the cursor updating that normally happens***     during slot VBL time. Since the cursor updating can take as***     long as 900uSec, and holds off other slot interrupts, it is***     handy to be able to defer the updating to a more civilized time.***     This program replaces the normal jCrsrTask with a routine that***     installs the real jCrsrTask routine as a deferred task.******     Build commands:******     asm DeferCrsr.a -lo DeferCrsr.a.lst -l***     link DeferCrsr.a.o -o DeferCrsr**************************************************************************                    STRING    ASIS                    PRINT    OFF                    INCLUDE 'Traps.a'                    INCLUDE 'SysEqu.a'                    PRINT    ON******************************** Entry *******************************Entry    MAIN    bra.s        Entry2****************************** MyDefTask *****************************TaskBeginMyDefTask        DC.L    0    ;qLink (handled by OS)        DC.W    0    ;qType (equ 7, find this value in MPW AIncludes)        DC.W    0    ;dtFlags (reserved, don't mess with 'em)        DC.L    0    ;dtAddr (pointer to actual routine to be performed)        DC.L    0    ;dtParm (optional parameter, this example doesn't use it)        DC.L    0    ;dtReserved (should be zero, DC.L 0 takes care of that)SysCrsrTask        DC.L    0***************************** MyjCrsrTask ****************************MyjCrsrTask    movem.l    a0/d0,-(sp)    lea        MyDefTask,a0            ;point to our deferred task element    move.l        SysCrsrTask,dtAddr(a0)    ;set up pointer to routine    move.w        #dtQType,dtType(a0)        ;set queue type    _DTInstall                    ;install the task    movem.l    (sp)+,a0/d0    rtsTaskEnd******************************** Entry2 ******************************TaskSize    EQU        TaskEnd-TaskBeginEntry2    move.l        #TaskSize,d0        ;TaskSize = Deferred task element, room for                        ; a pointer (to original jCrsrTask), and                        ;our jCrsrTask    _NewPtr    ,SYS,CLEAR        ;make a block in the system heap    bne.s        Abort            ;no room at the Inn, head for the manger    move.l        a0,a2            ;got a good pointer, keep a copy    move.l        a0,a1            ;a0 = source, a1 = destination for                        ; BlockMove    lea        MyDEFTask,a0        ;copy the task, etc. into the system heap    move.w        #TaskSize,d0    _BlockMove    lea        dtQElSize(a2),a0    ;move original jCrsrTask pointer into our    move.l        jCrsrTask,(a0)    ; pointer holder    lea        dtQElSize+4(a2),a0    ;replace jCrsrTask pointer with a pointer    move.l        a0,jCrsrTask        ; to our jCrsrTaskabort    rts                    ;all's well that ends...    END</pre>	</TD></TR></TABLE></CENTER>        <p>*    Note, as an aside, that while using MacsBug, interrupts are disabled.</p><P><A HREF="#top">Back to top</A></P><a name="Summary"></a><h2>Summary</h2><p>You cannot depend on real-time performance when transferring databetween NuBus and the Macintosh.  It is important to provide sufficientbuffering on the card to allow for the variance in interrupt latency.  Drivercalls can be used to determine the amount of data available to be transferred,and transfers can be made on a periodic basis.</p><p>Remember too, since the entire system is so heavily interrupt-driven, it isvery unfriendly for anyone to disable interrupts and take over the machine forlong periods of time.  Doing so almost always results in a sluggish userinterface, something which is usually not well received by the user.</p><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><P><i>Inside Macintosh</i>, Volume V, The Device Manager</p><P><i>Inside Macintosh</i>, Volume V, The Vertical Retrace Manager</p><P><i>Macintosh Family Hardware Reference</i></p><P><i>Designing Cards and Drivers for the Macintosh II and MacintoshSE</i></p><p>NuBus is a trademark of Texas Instruments</p><P><A HREF="#top">Back to top</A></P><P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (60K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/hw_16.pdf">Download</A></P>               </TD>            </TR></table><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/hw/hw_16.html%3Fid%3DDTS10002485-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/hw/hw_16.html%3Fid%3DDTS10002485-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/hw/hw_16.html%3Fid%3DDTS10002485-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>