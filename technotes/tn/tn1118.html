<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-05-01 --><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1118: Unlocking GDHandles Considered Harmful</title>       <meta name="keywords" content="Mac OS 8 QuickDraw data structures gdhandles unlocking gdevice crash">    <meta name="Description" content="Technical Note TN1118: This Technical Note discusses problemsin Mac OS                                    and in third-partycode which can cause a crash. The problem occurs when a programinadvertently unlocks                                   one or more QuickDraw data structures. The crash                                   typically occurs elsewhere, whenthe system accesses one                                   of these data structures under the assumption that it is                                   locked."><meta name="categories" content="Memory and QuickDraw"><meta name="week-posted" content="Jun 1, 1998 - Jun 5, 1998"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002958" title="Unlocking GDHandles Considered Harmful"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxGraphicsImaging-date.html">Graphics & Imaging</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/GraphicsImaging/index.html" target="_blank">Reference Library > Graphics & Imaging</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1118</div>
<div id="pageheadsub">Unlocking GDHandles Considered Harmful</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><center><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left">          <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                        <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left><!-- begin_toc --><p id="menutext"><A HREF = "#Section1">The         Symptoms</A><BR>         <BR>         <A HREF = "#Section2">The         Problem</A><BR>         <BR>         <A HREF = "#Section3">The         Solutions</A><BR>         <BR>         <A HREF="#Summary">Summary</A><BR><BR><A HREF="#References">References</a><BR><BR><A HREF="#Changes">Change History</a><BR><BR><A HREF="#Downloads">Downloadables</A></p>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left>            			<!-- begin_intro_text --><p id="introtext">Recently, Apple         became aware of problems in Mac OS and in third-party code         which can cause a crash.</P>                  <p id="introtext">The problem occurs when a program inadvertently unlocks         one or more <a href="../../documentation/mac/QuickDraw/QuickDraw-284.html">QuickDraw</A>         data structures. The crash typically occurs elsewhere, when         the system accesses one of these data structures under the         assumption that it is locked.</P>                  <p id="introtext">This Technote is addressed to two audiences: developers         whose products make any use of the <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>         data structure, and users who seek more information on         certain intermittent crashes reported in other media.</P>               <!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Jun 15 1998]</h3><!-- end_date -->        </td>    </tr></table> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><H2><A NAME=Section1></A>TheSymptoms</H2><P>The problem manifests most often as a crash in <a href="../../documentation/mac/QuickDraw/QuickDraw-180.html#HEADING180-0"><CODE>StdText</CODE></A>(MacsBug reports the crash in <CODE>NQDStdText</CODE>, which is thePowerPC version of <a href="../../documentation/mac/QuickDraw/QuickDraw-180.html#HEADING180-0"><CODE>StdText</CODE></A>).The crash occurs when a half-dereferenced <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>is accessed after a call which can (and does) move memory.</P><P>It should be noted that a crash could theoretically appear in anumber of places as a result of the problem. The problem generallydoes not occur near the site of the crash. One of the more insidiouspotential examples of this is in the cursor drawing routines, whichare executed at interrupt time. An unlocked <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>could be accessed while it is being moved by the <a href="../../documentation/mac/Memory/Memory-56.html#HEADING56-0">MemoryManager</A>, although this is considered a rare, if at all extant,symptom.</P>     <BR><P><A HREF="#top">Back to top</A></P><H2><A NAME=Section2></A>TheProblem</H2><P><a href="../../documentation/mac/QuickDraw/QuickDraw-279.html#HEADING279-0"><CODE>NewGDevice</CODE></A>locks a <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>immediately after creating it, and the rest of <a href="../../documentation/mac/QuickDraw/QuickDraw-2.html">QuickDraw</A>assumes it will stay locked. The problem is that some programs,including numerous third-party applications and some versions ofApple's Monitors &amp; Sound control panel (including the version inMac OS 8) contain code like this:</P>     <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>   // begin problematic code   <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html">GDHandle</A> gdh = <a href="../../documentation/mac/QuickDraw/QuickDraw-287.html#HEADING287-0">GetMainDevice</A> ( );   <a href="../../documentation/mac/Memory/Memory-88.html#HEADING88-0">HLock</A> ((Handle)gdh);   // do something with or to gdh   // which moves memory (requires gdh to be locked)   <a href="../../documentation/mac/Memory/Memory-89.html#HEADING89-0">HUnlock</A> ((Handle)gdh);   // this is the problem line   // end problematic code</pre></TD></TR></TABLE></CENTER><BR><BR>   <P>The above code assumes that the <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>is unlocked before the code executes, and unlocks it as the code ends.(Ironically, there was never any need to lock this <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>.)</P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>         Versions of Monitors &amp; Sound which shipped in Mac OS         8.1 and later do not have this problem.</P>                  <P>There has always been a requirement that a <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>         in the <a href="../../documentation/mac/QuickDraw/QuickDraw-284.html">system's         graphic device list</A> remain locked. The requirement is         present in the first-released implementation of <a href="../../documentation/mac/QuickDraw/QuickDraw-197.html">Color         QuickDraw</A> (the Mac II ROMs) and the original source code         contains comments to the effect that a <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>         in the <a href="../../documentation/mac/QuickDraw/QuickDraw-284.html">system's         graphic device list</A> must never be unlocked.</P>                  <P>Thus, the potential for the problem has always been         present, though the symptoms have only recently been         isolated. Because of the complex way in which relocatable         <a href="../../documentation/mac/Memory/Memory-56.html#HEADING56-0">Memory         Manager</A> blocks move over time, programs which cause the         problem have not necessarily also caused the symptoms, and         when they have caused the symptoms, the symptoms have not         always been easily reproducible. (The offending programs         have been "getting away with it.")</P>                  <P>An exhaustive search of Apple's previous documentation         turned up no instances of explicit prohibitions against         unlocking a <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>         in the <a href="../../documentation/mac/QuickDraw/QuickDraw-284.html">system's         graphic device list</A>. Informally communicated Mac OS         programming lore has always held that you should be careful         when changing the state of a handle not created by your own         code. We are now making this rule formal and explicit. (See         the <A HREF = "#devsol">Developer Solution</A> section, below,         for details.)</P></TD></TR></TABLE></CENTER><BR><BR><BR><P><A HREF="#top">Back to top</A></P><H2><A NAME=Section3></A>TheSolutions</H2><P>The previous version of this Technote claimed there would be asolution which users could apply. In fact, there is only a developersolution.</P><H3><A NAME=devsol></A>DeveloperSolution</H3><P>You should make sure none of your code unlocks a <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>in the <a href="../../documentation/mac/QuickDraw/QuickDraw-284.html">system'sgraphic device list</A>. Use code like the following if you need tomake sure a <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>is locked while you access it:</P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre><a href="../../documentation/mac/QuickDraw/QuickDraw-275.html">GDHandle</A> gdh = <a href="../../documentation/mac/QuickDraw/QuickDraw-287.html#HEADING287-0">GetMainDevice</A> ( );SInt8 hState = <a href="../../documentation/mac/Memory/Memory-86.html#HEADING86-0">HGetState</A> ((Handle) gdh);   <a href="../../documentation/mac/Memory/Memory-88.html#HEADING88-0">HLock</A> ((Handle)gdh);    // do something with or to gdh    // which moves memory (requires gdh to be locked)   <a href="../../documentation/mac/Memory/Memory-87.html#HEADING87-0">HSetState</A> ((Handle)gdh,hState);</pre></TD></TR></TABLE></CENTER><BR><BR><P>This code saves the handle's state, locks the handle, and restoresthe handle's previous state. This means that if the handle is lockedbefore this code runs, it will stay locked afterward, and if thehandle is unlocked before this code runs, it will be unlockedafterward.</P><P>In a perfect world, you would not need to lock or unlock any<a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>,because it would always be locked before your program ever saw it.However, the possibility that other programs may erroneously unlock a<a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>in the <a href="../../documentation/mac/QuickDraw/QuickDraw-284.html">system'sgraphic device list</A> is real. The above code shows one proper wayto protect yourself from that possibility.</P><P>Another technique would be to avoid locking a <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>entirely and, instead, copy its fields into local variables asnecessary. Most fields of the <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>are small and should not be inconvenient to copy.</P><P>Apple has not found any cases in which you need to keep any<a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>which is <B>not</B> in the <a href="../../documentation/mac/QuickDraw/QuickDraw-284.html">system'sgraphic device list</A> locked. For example, a <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>created by <a href="../../documentation/mac/QuickDraw/QuickDraw-311.html#HEADING311-0"><CODE>NewGWorld</CODE></A>is unlocked.</P><P>If your program needs to lock any <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>,the easiest and safest thing to do is save and restore the state ofthe <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>in order to work properly, regardless of whether the <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>is in the <a href="../../documentation/mac/QuickDraw/QuickDraw-284.html">system'sgraphic device list</A>.</p><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>         This solution does not solve the problem completely with         respect to binaries that have already been deployed. If a         <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>         is ever unlocked by an existing binary program, the         potential for a crash begins immediately because system         code, such as <CODE>NQDStdText</CODE>, will not be altered         to lock a <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>         before accessing it. This solution only keeps new programs         from causing the problem and keeps them from crashing if         they ever encounter an unexpectedly unlocked <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>         in the <a href="../../documentation/mac/QuickDraw/QuickDraw-284.html">system's         graphic device list</A>. The system, however, may still         crash when it encounters such a <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>.</P>                  <P>An exhaustive search of Apple's previous documentation         produced no clear directions for when to use <a href="../../documentation/mac/Memory/Memory-89.html#HEADING89-0"><CODE>HUnlock</CODE></A>         and when to use <a href="../../documentation/mac/Memory/Memory-86.html#HEADING86-0"><CODE>HGetState</CODE></A>         and <a href="../../documentation/mac/Memory/Memory-87.html#HEADING87-0"><CODE>HSetState</CODE></A>.         As a result, DTS has produced a <A HREF = "tn1122.html">separate         Technote</A> treating this issue in detail.</P></TD></TR></TABLE></CENTER><BR><BR><H3>User Solution</H3><P>The previous version of this Technote claimed Apple would bereleasing a system extension that masks this problem.Since this Technote's publication, however, Apple has chosen not to release this extension.</P><BR><P><A HREF="#top">Back to top</A></P><A NAME="Summary"></A><H2><A NAME=Summary></A>Summary</H2><P>No <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>in the <a href="../../documentation/mac/QuickDraw/QuickDraw-284.html">system'sgraphic device list</A> should ever be unlocked. Some programs, bothfrom Apple and from third parties, unlock at least one <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>in the <a href="../../documentation/mac/QuickDraw/QuickDraw-284.html">system'sgraphic device list</A>. This can cause a crash. Developers shouldpreserve the state of any <a href="../../documentation/mac/QuickDraw/QuickDraw-275.html"><CODE>GDHandle</CODE></A>in the <a href="../../documentation/mac/QuickDraw/QuickDraw-284.html">system'sgraphic device list</A>, which needs to be locked by calling <a href="../../documentation/mac/Memory/Memory-86.html#HEADING86-0"><CODE>HGetState</CODE></A>and <a href="../../documentation/mac/Memory/Memory-87.html#HEADING87-0"><CODE>HSetState</CODE></A>.There is no solution users can apply.</P><BR><P><A HREF="#top">Back to top</A></P><A NAME="References"></A><H2>References</H2>   <p>The <a href="../../documentation/mac/Memory/Memory-56.html#HEADING56-0">Memory   Manager</A> chapter in <a href="../../documentation/mac/Memory/Memory-2.html"><I>Inside   Macintosh: Memory</I></A></p>      <p>The <a href="../../documentation/mac/QuickDraw/QuickDraw-270.html">Graphics   Devices</A> chapter in <a href="../../documentation/mac/QuickDraw/QuickDraw-2.html"><I>Inside   Macintosh: Imaging with QuickDraw</I></A></p>      <p><A HREF = "tn1122.html">Technote 1122: "Locking and   Unlocking Handles"</A></p>      <p><A HREF = "http://www.digitalalchemy.com/mercutio/GDeviceProblem.html">Understanding   the Mercutio-GDevice Problem</A></p><BR><P><A HREF="#top">Back to top</A></P><A NAME="Changes"></A><H2>Change History</H2><TABLE BORDER=0 CELLPADDING=3 WIDTH=544>            <TR>               <td width=100 align=left>                  <P ALIGN=center>06-February-1998</P>               </TD>               <td align="left">                  <P>First published.</P>               </TD>            </TR>               <TR>               <td width=100 align=left>                  <P ALIGN=center>01-June-1998</P>               </TD>               <td align="left">                  <P>Updated to remove the description of the user-level solution.</P>               </TD>            </TR></table><BR><BR><P><A HREF="#top">Back to top</A></P>        <A NAME="Downloads"></A>         <br><h2>Downloadables</h2>        <center><TABLE BORDER=0 CELLPADDING=3 WIDTH="600">          <TR>             <td width=50 align=left>               <P ALIGN=center><img src="images/acrobatsmall.gif" align=middle alt="Acrobat" width=22 height=23></P>            </TD>            <td align="left">               <p>Acrobat version of this Note (64K).</P>            </TD>            <td width=60 align=left>               <p><A HREF="pdf/tn1118.pdf">Download</A></P>            </TD>          </TR>        </TABLE></center><BR><BR>        </td></tr></table></center><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1118.html%3Fid%3DDTS10002958-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1118.html%3Fid%3DDTS10002958-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1118.html%3Fid%3DDTS10002958-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>