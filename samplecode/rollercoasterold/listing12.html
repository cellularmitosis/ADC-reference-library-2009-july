<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>rollercoasterold - /Sources/QD3DSupport.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxGraphicsImaging-date.html">Graphics & Imaging</a> &gt; <A HREF="javascript:location.replace('index.html');">rollercoasterold</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/GraphicsImaging/index.html" target="_blank">Reference Library > Graphics & Imaging</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">rollercoasterold</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/Sources/QD3DSupport.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/Interfaces/Document.h</option>
<option value="listing2.html">/Interfaces/MacApplication.h</option>
<option value="listing3.html">/Interfaces/QD3DSupport.h</option>
<option value="listing4.html">/Interfaces/TextureMap.h</option>
<option value="listing5.html">/Interfaces/Track.h</option>
<option value="listing6.html">/Interfaces/Utils.h</option>
<option value="listing7.html">/Interfaces/Win32Application.h</option>
<option value="listing8.html">/Interfaces/WinPrefix.h</option>
<option value="listing9.html">/READ ME.txt</option>
<option value="listing10.html">/resource.h</option>
<option value="listing11.html">/Sources/MacApplication.c</option>
<option value="listing12.html">/Sources/QD3DSupport.c</option>
<option value="listing13.html">/Sources/TextureMap.c</option>
<option value="listing14.html">/Sources/Track.c</option>
<option value="listing15.html">/Sources/Utils.c</option>
<option value="listing16.html">/Sources/Win32Application.c</option></select>
				</p>
				</form>
				<p><strong><a href="rollercoasterold.zip">Download Sample</a></strong> (&#147;rollercoasterold.zip&#148;, 102.0K)<BR>
<strong><a href="rollercoasterold.dmg">Download Sample</a></strong> (&#147;rollercoasterold.dmg&#148;, 165.7K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">

/*
  File:    QD3DSupport.c
  
  Contains:  QD3D support routines
  
  Written by:  Scott Kuechle, based on original Gerbils code by Brian Greenstone

  Copyright:  &copy; 1998 by Apple Computer, Inc. All rights reserved
  
  Change History (most recent first)
  
    &lt;2&gt;    9/28/98    rtm    made changes for Metrowerks compiler
    &lt;1&gt;    9/01/98    srk    first file


*/

/************************************************************
*                                                           *
*    INCLUDE FILES                                          *
*                                                           *
*************************************************************/

#include &quot;QD3DSupport.h&quot;
#include &quot;Utils.h&quot;


/************************************************************
*                                                           *
*    FUNCTION PROTOTYPES                                    *
*                                                           *
*************************************************************/

#if TARGET_OS_MAC
  static TQ3ViewObject       QD3DSupport_NewView(WindowPtr theWindow);
  static TQ3DrawContextObject   QD3DSupport_NewDrawContext(WindowPtr theWindow);
  static TQ3ShaderObject       QD3DSupport_CreateShaderFromTexture(short grndTextureResourceID);
#else if TARGET_OS_WIN32
  static TQ3ViewObject       QD3DSupport_NewView(HWND theWindow);
  static TQ3DrawContextObject   QD3DSupport_NewDrawContext(HWND theWindow);
  static TQ3ShaderObject       QD3DSupport_CreateShaderFromTexture(LPTSTR  grndTextureFilePath);
#endif

static TQ3GroupObject       QD3DSupport_GroundInit(TQ3ShaderObject  groundShaderObject);
static TQ3CameraObject       QD3DSupport_NewCamera(float docWidth, float docHeight);
static TQ3GroupObject      QD3DSupport_NewLights(void);
static OSErr           QD3DSupport_QuickTimeInit (void);
static TQ3GroupObject       QD3DSupport_NewTrackGroup(TQ3ShaderObject  theShader);



/************************************************************
*                                                           *
*    FUNCTION:  QD3DSupport_NewView                         *
*                                                           *
*    PURPOSE:   Creates a new QD3D view object, along with  *
*               the accompanying draw context, light and    *
*               camera objects                              *
*                                                           *
*************************************************************/

#if TARGET_OS_MAC
  static TQ3ViewObject QD3DSupport_NewView(WindowPtr theWindow)
#else if TARGET_OS_WIN32
  static TQ3ViewObject QD3DSupport_NewView(HWND theWindow)
#endif
{
  TQ3Status        myStatus;
  TQ3ViewObject      myView;
  TQ3DrawContextObject  myDrawContext;
  TQ3RendererObject    myRenderer;
  TQ3GroupObject      myLights;
  TQ3CameraObject      myCamera;
#if TARGET_OS_WIN32
  RECT          clientRect;
  BOOL          success;
#endif


    myView = Q3View_New();
    if (myView == nil)
    {
      goto bail;
    }

    //  Create and set draw context.
    if ((myDrawContext = QD3DSupport_NewDrawContext(theWindow)) == nil )
    {
      goto bail;
    }
      
    if ((myStatus = Q3View_SetDrawContext(myView, myDrawContext)) == kQ3Failure )
    {
      goto bail;
    }

    Q3Object_Dispose( myDrawContext ) ;
    
    //  Create and set renderer.
    
    // this would use the Z-Buffer renderer
  #if 0

    myRenderer = Q3Renderer_NewFromType(kQ3RendererTypeWireFrame);
    if ((myStatus = Q3View_SetRenderer(myView, myRenderer)) == kQ3Failure ) {
      goto bail;
    }
    
  #else

    // this would use the interactive software renderer

    if ((myRenderer = Q3Renderer_NewFromType(kQ3RendererTypeInteractive)) != nil )
    {
      if ((myStatus = Q3View_SetRenderer(myView, myRenderer)) == kQ3Failure )
      {
        goto bail;
      }
      // these two lines set us up to use the best possible renderer,
      // including  hardware if it is installed.
      Q3InteractiveRenderer_SetDoubleBufferBypass (myRenderer, kQ3True);            
      Q3InteractiveRenderer_SetPreferences(myRenderer, kQAVendor_BestChoice, 0);

    }
    else
    {
      goto bail;
    }
  #endif

    Q3Object_Dispose( myRenderer ) ;
    
    //  Create and set camera.
    #if TARGET_OS_MAC
      if ( (myCamera = QD3DSupport_NewCamera((float) (theWindow-&gt;portRect.right - theWindow-&gt;portRect.left),
                          (float) (theWindow-&gt;portRect.bottom - theWindow-&gt;portRect.top))) == nil )
      {
        goto bail;
      }
    #else if TARGET_OS_WIN32
      success = GetClientRect(theWindow, &amp;clientRect);
      if (success)
      {
        if ( (myCamera = QD3DSupport_NewCamera((float)RECT_WIDTH(clientRect), (float)RECT_HEIGHT(clientRect))) == nil )
        {
          goto bail;
        }
      }
      else
      {
        goto bail;
      }
    #endif
      
    if ((myStatus = Q3View_SetCamera(myView, myCamera)) == kQ3Failure )
    {
      goto bail;
    }
    Q3Object_Dispose( myCamera ) ;
    
    //  Create and set lights.
    if ((myLights = QD3DSupport_NewLights()) == nil )
    {
      goto bail;
    }
      
    if ((myStatus = Q3View_SetLightGroup(myView, myLights)) == kQ3Failure )
    {
      goto bail;
    }
      
    Q3Object_Dispose(myLights);

    //  Done!!!
    return ( myView );
    
  bail:
    //  If any of the above failed, then don't return a view.
    return ( nil );
}


/************************************************************
*                                                           *
*    FUNCTION:  QD3DSupport_NewDrawContext                  *
*                                                           *
*    PURPOSE:   Creates a new QD3D draw context object      *
*                                                           *
*                                                           *
*                                                           *
*                                                           *
*************************************************************/

#if TARGET_OS_MAC

static TQ3DrawContextObject QD3DSupport_NewDrawContext(WindowPtr theWindow)
{
  TQ3DrawContextData    myDrawContextData;
  TQ3MacDrawContextData  myMacDrawContextData;
  TQ3ColorARGB      ClearColor;
  TQ3DrawContextObject  myDrawContext ;
  
    /*  Set the background color. */
    ClearColor.a = 1.0F;
    ClearColor.r = 0.0F;
    ClearColor.g = 0.0F;
    ClearColor.b = 1.0F;
    
    /*  Fill in draw context data. */
    myDrawContextData.clearImageMethod  = kQ3ClearMethodWithColor;
    myDrawContextData.clearImageColor  = ClearColor;
    myDrawContextData.paneState      = kQ3False;
    myDrawContextData.maskState      = kQ3False;
    myDrawContextData.doubleBufferState = kQ3True;
   
    myMacDrawContextData.drawContextData = myDrawContextData;
    
    myMacDrawContextData.window = (CGrafPtr) theWindow;    // this is the window associated with the view
    myMacDrawContextData.library = kQ3Mac2DLibraryNone;
    myMacDrawContextData.viewPort = nil;
    myMacDrawContextData.grafPort = (CGrafPtr) theWindow;
    
    /*  Create draw context and return it, if it's nil the caller must handle */
    myDrawContext = Q3MacDrawContext_New(&amp;myMacDrawContextData) ;

    return myDrawContext ;
}


#else if TARGET_OS_WIN32

static TQ3DrawContextObject QD3DSupport_NewDrawContext(HWND theWindow)
{

  TQ3DrawContextData      myDrawContextData;
  TQ3Win32DCDrawContextData  myWin32DCDrawContextData;
  TQ3DrawContextObject    myDrawContext ;
  DWORD            wndClassStyle;
  TQ3ColorARGB        ClearColor;


    /*  Set the background color. */

    ClearColor.a = 1.0;
    ClearColor.r = 0.0;
    ClearColor.g = 0.0;
    ClearColor.b = 1.0;

    /*  Fill in draw context data. */

    myDrawContextData.clearImageMethod  = kQ3ClearMethodWithColor;
    myDrawContextData.clearImageColor  = ClearColor;
    myDrawContextData.paneState      = kQ3False;
    myDrawContextData.maskState      = kQ3False;
    myDrawContextData.doubleBufferState = kQ3True;

    myWin32DCDrawContextData.drawContextData = myDrawContextData;

    /* Assertion: window MUST be CS_OWNDC */

    wndClassStyle = GetClassLong( theWindow, GCL_STYLE );
    if( CS_OWNDC != ( wndClassStyle &amp; CS_OWNDC ) )
    {
      return NULL;
    }

    /* set up the win32DCDrawContext */
    myWin32DCDrawContextData.hdc = GetDC( theWindow );

    /*  Create draw context and return it, if it's NULL the caller must handle */
    myDrawContext = Q3Win32DCDrawContext_New(&amp;myWin32DCDrawContextData) ;

    ReleaseDC(theWindow, myWin32DCDrawContextData.hdc);

    return myDrawContext ;

}

#endif

/************************************************************
*                                                           *
*    FUNCTION:  QD3DSupport_NewCamera                       *
*                                                           *
*    PURPOSE:   Creates our camera                          *
*                                                           *
*                                                           *
*************************************************************/

static TQ3CameraObject QD3DSupport_NewCamera(float       docWidth,
                      float       docHeight)
{
  TQ3ViewAngleAspectCameraData  perspectiveData;
  TQ3CameraObject          camera;
  
  TQ3Point3D           from   = { 30.0F, 50.0F, -50.0F };
  TQ3Point3D           to     = { 30.0F, 0.0F, 0.0F };
  TQ3Vector3D         up     = { 0.0F, 1.0F, 0.0F };

  float             fieldOfView = 1.2F;
  float             hither     = 0.2F;
  float             yon     = 200.0F;
  

    perspectiveData.cameraData.placement.cameraLocation   = from;
    perspectiveData.cameraData.placement.pointOfInterest   = to;
    perspectiveData.cameraData.placement.upVector       = up;

    perspectiveData.cameraData.range.hither  = hither;
    perspectiveData.cameraData.range.yon   = yon;

    perspectiveData.cameraData.viewPort.origin.x   =   -1.0F;
    perspectiveData.cameraData.viewPort.origin.y   =   1.0F;
    perspectiveData.cameraData.viewPort.width    =   2.0F;
    perspectiveData.cameraData.viewPort.height     =   2.0F;
    
    perspectiveData.fov        = fieldOfView;
    perspectiveData.aspectRatioXToY  = docWidth / docHeight;

    camera = Q3ViewAngleAspectCamera_New(&amp;perspectiveData);

    return camera ;
}


/************************************************************
*                                                           *
*    FUNCTION:  QD3DSupport_NewLights                       *
*                                                           *
*    PURPOSE:   Create our lights                           *
*                                                           *
*                                                           *
*************************************************************/

static TQ3GroupObject QD3DSupport_NewLights()
{
  TQ3GroupPosition    myGroupPosition;
  TQ3GroupObject      myLightList;
  TQ3LightData      myLightData;
  TQ3LightObject      myAmbientLight = NULL;
  TQ3ColorRGB        WhiteLight = { 1.0F, 1.0F, 1.0F };
  
    /*  Set up light data for ambient light.  This light data will be used for point and fill
      light also. */

    myLightData.isOn = kQ3True;
    myLightData.color = WhiteLight;
    
    /*  Create ambient light. */
    myLightData.brightness = 0.8F;
    myAmbientLight = Q3AmbientLight_New(&amp;myLightData);
    if ( myAmbientLight == nil )
    {
      goto bail;
    }

    /*  Create light group and add each of the lights into the group. */
    myLightList = Q3LightGroup_New();
    if ( myLightList == nil )
    {
      goto bail;
    }
    myGroupPosition = Q3Group_AddObject(myLightList, myAmbientLight);
    if ( myGroupPosition == 0 )
    {
      goto bail;
    }

    Q3Object_Dispose( myAmbientLight ) ;

    /*  Done! */
    return ( myLightList );
    
  bail:
    /*  If any of the above failed, then return nothing! */
    if (myAmbientLight != NULL)
    {
      Q3Object_Dispose( myAmbientLight ) ;
    }
    return ( nil );
}


/************************************************************
*                                                           *
*    FUNCTION:  QD3DSupport_NewTrackGroup                   *
*                                                           *
*    PURPOSE:   Creates a new group for our track &amp; its     *
*               associated shader object                    *
*                                                           *
*                                                           *
*************************************************************/

static TQ3GroupObject QD3DSupport_NewTrackGroup(TQ3ShaderObject  theShader)
{
  TQ3GroupObject  myGroup = NULL;  
      
    if ((myGroup = Q3OrderedDisplayGroup_New()) != NULL )
    {
    TQ3GroupPosition myGroupPosition;
    
        /* ADD TEXTURE SHADER OBJECT TO GROUP */
      myGroupPosition = Q3Group_AddObject(myGroup, theShader);
      if ( myGroupPosition == nil )
      {
        Utils_DisplayErrorMsg(&quot;Group_AddObject failed!&quot;);
      }
    }
            
    /*  Done! */
    return ( myGroup );
}



/************************************************************
*                                                           *
*    FUNCTION:  QD3DSupport_GroundInit                      *
*                                                           *
*    PURPOSE:   Creates a new ground object and group       *
*                                                           *
*                                                           *
*************************************************************/

static TQ3GroupObject QD3DSupport_GroundInit(TQ3ShaderObject  groundShaderObject)
{
  long        i;
  TQ3GeometryObject  polygonObj = NULL;
  TQ3GroupPosition  myGroupPosition;
  TQ3GroupObject    groundGroup;
  TQ3PolygonData    polygonData;
  TQ3Vertex3D      vertices[kNumGrndTextureVertices] = {0,-3,GROUND_SIZE,nil,
                              GROUND_SIZE,-3,GROUND_SIZE,nil,
                              GROUND_SIZE,-3,-GROUND_SIZE,nil,
                              0,-3,-GROUND_SIZE,nil};
  TQ3AttributeSet    attribs[kNumGrndTextureVertices] = {NULL, NULL, NULL, NULL};
  float        ambient = 1.0F;
  TQ3Param2D      uv[kNumGrndTextureVertices] = {0,0,1,0,1,1,0,1};



    if (groundShaderObject == NULL)

    {

      return NULL;

    }


    groundGroup =  Q3OrderedDisplayGroup_New();
    if (groundGroup == NULL)
    {
      return NULL;
    }
      
        /* ADD TEXTURE SHADER OBJECT TO GROUP */
    myGroupPosition = Q3Group_AddObject(groundGroup, groundShaderObject);
    if ( myGroupPosition == nil )
    {
      Utils_DisplayErrorMsg(&quot;Q3Group_AddObject failed!&quot;);
      goto outOfMem;
    }
    Q3Object_Dispose(groundShaderObject);


        /* CREATE VERTICES */
      
    for (i=0; i &lt; kNumGrndTextureVertices; i++)
    {
      attribs[i] = Q3AttributeSet_New();  
      if( attribs[i] == NULL )
      {
        Utils_DisplayErrorMsg(&quot;Attribute set creation failed!&quot;);  
        goto outOfMem;
      }
      Q3AttributeSet_Add(attribs[i], kQ3AttributeTypeShadingUV, &amp;uv[i]);
      vertices[i].attributeSet = attribs[i];
    }

        /* CREATE NEW POLYGON OBJECT */

    polygonData.numVertices = kNumGrndTextureVertices;
    polygonData.vertices = vertices;
    polygonData.polygonAttributeSet = nil;
    polygonObj = Q3Polygon_New(&amp;polygonData);      
    
    if( polygonObj == NULL )
    {
      Utils_DisplayErrorMsg(&quot;Polygon_New failed!&quot;);  
      goto outOfMem;
    }
    
    for (i=0; i &lt; kNumGrndTextureVertices; i++)
    {      
      Q3Object_Dispose(attribs[i]);
      attribs[i] = NULL;
    }

    myGroupPosition = Q3Group_AddObject(groundGroup, polygonObj);
    Q3Object_Dispose(polygonObj);
    if ( myGroupPosition == nil )
    {
      Utils_DisplayErrorMsg(&quot;Q3Group_AddObject failed!&quot;);  
      goto outOfMem;
    }
    
      /* Success! */
      
    return groundGroup;
    
      /* Error handling */
  outOfMem:
    if (groundGroup)
    {
      Q3Object_Dispose(groundGroup);
    }

    for (i=0; i &lt; kNumGrndTextureVertices; i++)
    {      
      if( attribs[i] )
      {
        Q3Object_Dispose(attribs[i]);
      }
    }
    
    return NULL;
}


/************************************************************
*                                                           *
*    FUNCTION:  QD3DSupport_InitDoc3DData                   *
*                                                           *
*    PURPOSE:   General initialization routine which        *
*               creates our QD3D view and builds our track  *
*               and ground objects                          *
*                                                           *
*                                                           *
*************************************************************/

#if TARGET_OS_MAC
  void QD3DSupport_InitDoc3DData( WindowPtr   window,
                  DocumentPtr theDocument )
#else if TARGET_OS_WIN32
  void QD3DSupport_InitDoc3DData( HWND     window,
                  DocumentPtr theDocument )
#endif
{
  TQ3Status     status;
  TQ3ShaderObject  groundShaderObject;
  short      partCount;
  
  #if TARGET_OS_WIN32

    OSErr err;
    DWORD error;


  #endif


      /* Initialize QuickDraw 3D, open a connection to the QuickDraw 3D library */

    status = Q3Initialize();
    if ( status == kQ3Failure )
    {
      Utils_DisplayFatalErrorMsg(&quot;QD3D Initialization failure!&quot;);
    }
    
    #if TARGET_OS_WIN32

      err = QD3DSupport_QuickTimeInit ();

      if ( err != noErr )
      {
        Utils_DisplayFatalErrorMsg(&quot;QTML Initialization failure!&quot;);
      }
    #endif

    theDocument-&gt;fSplinePointsPtr   = NULL;
    theDocument-&gt;fNumSplineNubs   = 0;
    theDocument-&gt;fNumSplinePoints   = 0;
    theDocument-&gt;fTrackIndex     = 0;
    theDocument-&gt;fMainWindow     = window;

      /* sets up the 3d data for the scene */
      /* Create view for QuickDraw 3D. */
    theDocument-&gt;fView = QD3DSupport_NewView( theDocument-&gt;fMainWindow ) ;
    if (theDocument-&gt;fView == NULL)
    {
      Utils_DisplayFatalErrorMsg(&quot;Failure creating a new view!&quot;);
    }
    
      /* get the view's camera for use later */
    Q3View_GetCamera(theDocument-&gt;fView, &amp;theDocument-&gt;fCamera);
    
      /* the drawing styles: */
    theDocument-&gt;fInterpolation = Q3InterpolationStyle_New(kQ3InterpolationStyleVertex) ;
    theDocument-&gt;fBackFacing   = Q3BackfacingStyle_New(kQ3BackfacingStyleBoth ) ;
    theDocument-&gt;fFillStyle   = Q3FillStyle_New(kQ3FillStyleFilled ) ;


      /* get shaders for ground/track textures */
    #if TARGET_OS_MAC
    
      groundShaderObject = QD3DSupport_CreateShaderFromTexture(kGrndTextureResID);
      theDocument-&gt;fTrackShader = QD3DSupport_CreateShaderFromTexture(kTextureRezID);

    #else if TARGET_OS_WIN32
    
      error = Utils_Win32_BuildCurDirPath((Ptr)&amp;theDocument-&gt;fGroundTextureFilePath, kGroundTextureFileName);
      if (!Utils_Win32_DoesFileExist((char *)&amp;theDocument-&gt;fGroundTextureFilePath))

      {

        Utils_DisplayFatalErrorMsg(&quot;Failure loading ground texture file GroundTexture.pct!&quot;);

      }

      error = Utils_Win32_BuildCurDirPath((Ptr)&amp;theDocument-&gt;fTrackTextureFilePath, kTrackTextureFileName);
      if (!Utils_Win32_DoesFileExist((char *)&amp;theDocument-&gt;fGroundTextureFilePath))

      {

        Utils_DisplayFatalErrorMsg(&quot;Failure loading track texture file MetalTrack.pct!&quot;);

      }

      
      groundShaderObject = QD3DSupport_CreateShaderFromTexture((Ptr)&amp;theDocument-&gt;fGroundTextureFilePath);
      theDocument-&gt;fTrackShader = QD3DSupport_CreateShaderFromTexture((Ptr)&amp;theDocument-&gt;fTrackTextureFilePath);

    #endif
    
      /* create ground/track groups */
      
    theDocument-&gt;fGroundGroup = QD3DSupport_GroundInit(groundShaderObject);
    theDocument-&gt;fTrackGroup = QD3DSupport_NewTrackGroup (theDocument-&gt;fTrackShader);
    
      /* load track parts */

    #if TARGET_OS_WIN32

      Track_LoadPartsFromFile((PartType *)&amp;theDocument-&gt;fPartsList, &amp;partCount);

    #elif TARGET_OS_MAC

      Track_LoadPartsFromRez((PartType *)&amp;theDocument-&gt;fPartsList, &amp;partCount);

    #endif

      /* build track from track parts */
    if (partCount &gt; 0)
    {
      Track_MakeRandomTrack((TrackSectionType *)&amp;theDocument-&gt;fTrackSectionList, MAX_TRACK_SECTIONS);
      Track_CreateMasterNubList((TrackSectionType *)&amp;theDocument-&gt;fTrackSectionList,
                  partCount,
                  (PartType *)&amp;theDocument-&gt;fPartsList,
                  (NubEntryType *)&amp;theDocument-&gt;fNubArray,
                  &amp;theDocument-&gt;fNumSplineNubs);  /* on output, new spline count */

      Track_CalcSplineCurve(&amp;theDocument-&gt;fSplinePointsPtr,
                MAX_SPLINE_POINTS,
                (NubEntryType *)&amp;theDocument-&gt;fNubArray,
                theDocument-&gt;fNumSplineNubs,
                &amp;theDocument-&gt;fNumSplinePoints,
                kTrackSubDivFactor);

      Track_BuildCoasterGeometry_Mesh(kSkipValue,
                      theDocument-&gt;fTrackGroup,
                      theDocument-&gt;fNumSplinePoints,
                      theDocument-&gt;fSplinePointsPtr);
    }

}
/************************************************************
*                                                           *
*    FUNCTION:  QD3DSupport_DisposeDoc3DData                *
*                                                           *
*    PURPOSE:   Dispose of our QD3D objects                 *
*                                                           *
*                                                           *
*************************************************************/

void QD3DSupport_DisposeDoc3DData( DocumentPtr theDocument)
{
  TQ3Status status;

    Q3Object_Dispose(theDocument-&gt;fView) ;        /* the view for the scene */
    Q3Object_Dispose(theDocument-&gt;fCamera) ;      /* the camera for the scene */
    Q3Object_Dispose(theDocument-&gt;fTrackGroup) ;
    Q3Object_Dispose(theDocument-&gt;fGroundGroup) ;
    Q3Object_Dispose(theDocument-&gt;fInterpolation) ;    /* interpolation style used when rendering */
    Q3Object_Dispose(theDocument-&gt;fBackFacing) ;    /* whether to draw shapes that face away from the camera */
    Q3Object_Dispose(theDocument-&gt;fFillStyle) ;      /* whether drawn as solid filled object or decomposed to components */
    Q3Object_Dispose(theDocument-&gt;fTrackShader) ;      /* whether drawn as solid filled object or decomposed to components */

    status = Q3Exit();
    if ( status == kQ3Failure )
    {
      Utils_DisplayErrorMsg(&quot;QD3D Exit returned failure&quot;);
    }

}

/************************************************************
*                                                           *
*    FUNCTION:  QD3DSupport_DocDraw3DData                   *
*                                                           *
*    PURPOSE:   Draws our track and ground group objects    *
*                                                           *
*                                                           *
*************************************************************/

TQ3Status QD3DSupport_DocDraw3DData( DocumentPtr theDocument )
{

  Q3View_StartRendering(theDocument-&gt;fView );
  do
  {    
    Q3Style_Submit( theDocument-&gt;fInterpolation, theDocument-&gt;fView );
    Q3Style_Submit( theDocument-&gt;fBackFacing, theDocument-&gt;fView );
    Q3Style_Submit( theDocument-&gt;fFillStyle, theDocument-&gt;fView );
    Q3DisplayGroup_Submit( theDocument-&gt;fTrackGroup, theDocument-&gt;fView );
    Q3DisplayGroup_Submit( theDocument-&gt;fGroundGroup, theDocument-&gt;fView );

  } while (Q3View_EndRendering(theDocument-&gt;fView) == kQ3ViewStatusRetraverse );

  Track_MoveCamera(theDocument-&gt;fCamera,
          theDocument-&gt;fSplinePointsPtr,
          theDocument-&gt;fNumSplinePoints,
          &amp;theDocument-&gt;fTrackIndex);

  return kQ3Success ;
}


/************************************************************
*                                                           *
*    FUNCTION:  QD3DSupport_QuickTimeInit                   *
*                                                           *
*    PURPOSE:   Initalize QuickTime                         *
*                                                           *
*                                                           *
*************************************************************/

static OSErr QD3DSupport_QuickTimeInit (void)
{
  #if TARGET_OS_WIN32
    OSErr err;

      err = InitializeQTML(0L);
      if (err != noErr)
      {

        return err;

      }
  #endif

  return ( EnterMovies () );
}



/************************************************************
*                                                           *
*    FUNCTION:  QD3DSupport_CreateShaderFromTexture         *
*                                                           *
*    PURPOSE:   Create our shader object                    *
*                                                           *
*                                                           *
*************************************************************/

#if TARGET_OS_MAC

  static TQ3ShaderObject QD3DSupport_CreateShaderFromTexture(short grndTextureResourceID)
  {
    TQ3ShaderObject   shaderObject = NULL;
    PicHandle      picH;
    Rect        picRect;

      Utils_Mac_GetPictForTexture(grndTextureResourceID, &amp;picH, &amp;picRect);
      if (picH == NULL)
      {
        Utils_DisplayFatalErrorMsg(&quot;Failure retrieving ground textures!&quot;);
      }
      
      shaderObject = TextureMap_Get(picH, &amp;picRect);
      
      ReleaseResource((Handle)picH);
      
      return shaderObject;
  }
  
#else if TARGET_OS_WIN32

  static TQ3ShaderObject QD3DSupport_CreateShaderFromTexture(LPTSTR  grndTextureFilePath)
  {
    TQ3ShaderObject   shaderObject = NULL;
    PicHandle      picH;
    Rect        picRect;
    ComponentResult    result;

    
      result = Utils_Win32_GetPicFromFile(grndTextureFilePath, &amp;picH, &amp;picRect);
      if (picH == NULL)
      {
        Utils_DisplayFatalErrorMsg(&quot;Failure retrieving ground textures!&quot;);
      }
      
      shaderObject = TextureMap_Get(picH, &amp;picRect);
      
        /* release memory occupied by picture */
      KillPicture(picH);
      
      return shaderObject;
  }
  
#endif

</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/rollercoasterold/listing12.html%3Fid%3DDTS10000135-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/rollercoasterold/listing12.html%3Fid%3DDTS10000135-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/rollercoasterold/listing12.html%3Fid%3DDTS10000135-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>