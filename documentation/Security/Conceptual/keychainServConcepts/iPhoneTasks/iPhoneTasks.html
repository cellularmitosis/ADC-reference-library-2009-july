<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Keychain Services Programming Guide: Keychain Services Tasks for iPhone OS</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Keychain Services Tasks for iPhone OS"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30000897-CH208" title="Keychain Services Tasks for iPhone OS"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000434" target="_top">Security</a> &gt; <a href="../../../Authentication-date.html#//apple_ref/doc/uid/TP30000440-TP30000434-TP30000487" target="_top">Authentication</a> &gt; <a href="../01introduction/introduction.html#//apple_ref/doc/uid/TP30000897-CH203-TP1">Keychain Services Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../03tasks/tasks.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../glossary/glossary.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30000897-CH208-SW1" title="Keychain Services Tasks for iPhone OS"></a><h1>Keychain Services Tasks for iPhone OS </h1><p>This chapter describes and illustrates the use of basic Keychain Services functions in iPhone OS. For the use of Keychain Services in Mac OS X, see <span class="content_text"><a href="../03tasks/tasks.html#//apple_ref/doc/uid/TP30000897-CH205-TP9">“Mac OS X Keychain Services Tasks.”</a></span></p><p>The functions described in this chapter enable you to:</p><ul class="ul"><li class="li"><p>Add an item to a keychain</p></li><li class="li"><p>Find an item in a keychain</p></li><li class="li"><p>Get the attributes and data in a keychain item</p></li><li class="li"><p>Change the attributes and data in a keychain item</p></li></ul><p><span class="content_text"><a href="../02concepts/concepts.html#//apple_ref/doc/uid/TP30000897-CH204-TP9">“Keychain Services Concepts”</a></span> provides an introduction to the concepts and terminology of Keychain Services. For detailed information about all Keychain Services functions, see <em><a href="../../../Reference/keychainservices/index.html#//apple_ref/doc/uid/TP30000898" target="_top">Keychain Services Reference</a></em>.</p><a name="//apple_ref/doc/uid/TP30000897-CH208-SW3" title="Adding Keychain Services to Your Application"></a><h2>Adding Keychain Services to Your Application</h2><p>Most iPhone OS applications need to use Keychain Services only to add a new password to a keychain, modify an existing keychain item, or retrieve a password when needed. Keychain Services provides the following functions for accomplishing these tasks:</p><ul class="ul"><li class="li"><p><code><!--a-->SecItemAdd<!--/a--></code> to add an item to a keychain</p></li><li class="li"><p><code>SecItemUpdate</code> to modify an existing keychain item</p></li><li class="li"><p><code><!--a-->SecItemCopyMatching<!--/a--></code> to find a keychain item and extract information from it</p></li></ul><p>You use Internet passwords for accessing servers and websites over the Internet, and generic passwords for any other password-protected service (such as a database or scheduling application). In iPhone OS Keychain Services, certificates, keys, and identities are stored and retrieved in exactly the same way as passwords, except that they have different attributes.</p><p><span class="content_text">Figure 3-1</span> shows a flowchart of how an application might use these functions to gain access to an Internet FTP server.</p><br/><div><a name="//apple_ref/doc/uid/TP30000897-CH208-SW2" title="Figure 3-1Accessing an Internet server using iPhone Keychain Services"></a><p><strong>Figure 3-1&nbsp;&nbsp;</strong>Accessing an Internet server using iPhone Keychain Services</p><img src = "../art/iphone_keychain_flowchart.jpg" alt = "FLowchart showing use of iPhone Keychain Services to store an Internet password" ></div><br/><p>The user of the application starts by selecting a File Transfer Protocol (FTP) server. The application calls <code><!--a-->SecItemCopyMatching<!--/a--></code>, passing it a dictionary containing attributes that identify the keychain item. If the password is on the keychain, the function returns the password to the application, which sends it to the FTP server to authenticate the user. If the authentication succeeds, the routine is finished. If the authentication fails, the application displays a dialog to request the user name and password.</p><p>If the password is not on the keychain, then <code><!--a-->SecItemCopyMatching<!--/a--></code> returns the <code><a href="../../../Reference/CryptoMessageRef/Reference/reference.html#//apple_ref/doc/c_ref/errSecItemNotFound" target="_top">errSecItemNotFound</a></code> result code. In this case as well, the application displays a dialog to request the user name and password. (This dialog should also include a Cancel button, but that choice was omitted from the figure to keep the flowchart from becoming overly complex.)</p><p>Having obtained the password from the user, the application proceeds to authenticate the user to the FTP server. When the authentication has succeeded, the application can assume that the information entered by the user was valid. The application then displays another dialog asking the user whether to save the password on the keychain. If the user selects No, then the routine is finished. If the user selects Yes, then the application calls the <code><!--a-->SecItemAdd<!--/a--></code> function (if this is a new keychain item) or the <code><!--a-->SecItemUpdate<!--/a--></code> function (to update an existing keychain item) before ending the routine.</p><p><span class="content_text">Listing 3-1</span> shows how a typical application might use Keychain Services functions to get and set passwords for generic items. You can get and set keychain item attributes (such as user name or service name) using these same functions.</p><a name="//apple_ref/doc/uid/TP30000897-CH208-SW4" title="Listing 3-1Getting and setting passwords in iPhone OS Keychain Services"></a><p class="codesample"><strong>Listing 3-1&nbsp;&nbsp;</strong>Getting and setting passwords in iPhone OS Keychain Services</p><div class="codesample"><table><tr><td scope="row"><pre>#import &lt;UIKit/UIKit.h><span></span></pre></td></tr><tr><td scope="row"><pre>#import &lt;Security/Security.h><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>//Define an Objective-C wrapper class to hold Keychain Services code.<span></span></pre></td></tr><tr><td scope="row"><pre>@interface KeychainWrapper : NSObject {<span></span></pre></td></tr><tr><td scope="row"><pre>    NSMutableDictionary        *keychainData;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSMutableDictionary        *genericPasswordQuery;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@property (nonatomic, retain) NSMutableDictionary *keychainData;<span></span></pre></td></tr><tr><td scope="row"><pre>@property (nonatomic, retain) NSMutableDictionary *genericPasswordQuery;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)mySetObject:(id)inObject forKey:(id)key;<span></span></pre></td></tr><tr><td scope="row"><pre>- (id)myObjectForKey:(id)key;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@end<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/* ********************************************************************** */<span></span></pre></td></tr><tr><td scope="row"><pre>//Unique string used to identify the keychain item:<span></span></pre></td></tr><tr><td scope="row"><pre>static const UInt8 kKeychainItemIdentifier[]    = "com.apple.dts.KeychainUI\0";<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@interface KeychainWrapper (PrivateMethods)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>//The following two methods translate dictionaries between the format used by<span></span></pre></td></tr><tr><td scope="row"><pre>// the view controller (NSString *) and the Keychain Services API:<span></span></pre></td></tr><tr><td scope="row"><pre>- (NSMutableDictionary *)secItemFormatToDictionary:(NSDictionary *)dictionaryToConvert;<span></span></pre></td></tr><tr><td scope="row"><pre>- (NSMutableDictionary *)dictionaryToSecItemFormat:(NSDictionary *)dictionaryToConvert;<span></span></pre></td></tr><tr><td scope="row"><pre>// Method used to write data to the keychain:<span></span></pre></td></tr><tr><td scope="row"><pre>- (void)writeToKeychain;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@end<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@implementation KeychainWrapper<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>//Synthesize the getter and setter:<span></span></pre></td></tr><tr><td scope="row"><pre>@synthesize keychainData, genericPasswordQuery;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (id)init<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    (self = [super init])<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        OSStatus keychainErr = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>        // Set up the keychain search dictionary:<span></span></pre></td></tr><tr><td scope="row"><pre>        genericPasswordQuery = [[NSMutableDictionary alloc] init];<span></span></pre></td></tr><tr><td scope="row"><pre>        // This keychain item is a generic password.<span></span></pre></td></tr><tr><td scope="row"><pre>        [genericPasswordQuery setObject:(id)kSecClassGenericPassword<span></span></pre></td></tr><tr><td scope="row"><pre>                                 forKey:(id)kSecClass];<span></span></pre></td></tr><tr><td scope="row"><pre>        // The kSecAttrGeneric attribute is used to store a unique string that is used<span></span></pre></td></tr><tr><td scope="row"><pre>        // to easily identify and find this keychain item. The string is first<span></span></pre></td></tr><tr><td scope="row"><pre>        // converted to an NSData object:<span></span></pre></td></tr><tr><td scope="row"><pre>        NSData *keychainItemID = [NSData dataWithBytes:kKeychainItemIdentifier<span></span></pre></td></tr><tr><td scope="row"><pre>                                  length:strlen((const char *)kKeychainItemIdentifier)];<span></span></pre></td></tr><tr><td scope="row"><pre>        [genericPasswordQuery setObject:keychainItemID forKey:(id)kSecAttrGeneric];<span></span></pre></td></tr><tr><td scope="row"><pre>        // Return the attributes of the first match only:<span></span></pre></td></tr><tr><td scope="row"><pre>        [genericPasswordQuery setObject:(id)kSecMatchLimitOne forKey:(id)kSecMatchLimit];<span></span></pre></td></tr><tr><td scope="row"><pre>        // Return the attributes of the keychain item (the password is<span></span></pre></td></tr><tr><td scope="row"><pre>        //  acquired in the secItemFormatToDictionary: method):<span></span></pre></td></tr><tr><td scope="row"><pre>        [genericPasswordQuery setObject:(id)kCFBooleanTrue<span></span></pre></td></tr><tr><td scope="row"><pre>                                 forKey:(id)kSecReturnAttributes];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        //Initialize the dictionary used to hold return data from the keychain:<span></span></pre></td></tr><tr><td scope="row"><pre>        NSMutableDictionary *outDictionary = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>        // If the keychain item exists, return the attributes of the item: <span></span></pre></td></tr><tr><td scope="row"><pre>        keychainErr = SecItemCopyMatching((CFDictionaryRef)genericPasswordQuery,<span></span></pre></td></tr><tr><td scope="row"><pre>                                         (CFTypeRef *)&amp;outDictionary);<span></span></pre></td></tr><tr><td scope="row"><pre>        if keychainErr == errSecItemNotFound<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            // Put default values into the keychain if no matching<span></span></pre></td></tr><tr><td scope="row"><pre>            // keychain item is found:<span></span></pre></td></tr><tr><td scope="row"><pre>            [self resetKeychainItem];<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        else<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            // Any other error is unexpected.<span></span></pre></td></tr><tr><td scope="row"><pre>            if ! (keychainErr == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>            NSAssert(NO, @"Serious error.\n");<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        else<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            // Convert the data dictionary into the format used by the view controller:<span></span></pre></td></tr><tr><td scope="row"><pre>            self.keychainData = [self secItemFormatToDictionary:outDictionary];<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        [outDictionary release];<span></span></pre></td></tr><tr><td scope="row"><pre>    return self;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)dealloc<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [keychainData release];<span></span></pre></td></tr><tr><td scope="row"><pre>    [genericPasswordQuery release];<span></span></pre></td></tr><tr><td scope="row"><pre>    [super dealloc];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Implement the mySetObject:forKey method, which writes attributes to the keychain:<span></span></pre></td></tr><tr><td scope="row"><pre>- (void)mySetObject:(id)inObject forKey:(id)key<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    if (inObject == nil) return;<span></span></pre></td></tr><tr><td scope="row"><pre>    id currentObject = [keychainData objectForKey:key];<span></span></pre></td></tr><tr><td scope="row"><pre>    if (![currentObject isEqual:inObject])<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        [keychainData setObject:inObject forKey:key];<span></span></pre></td></tr><tr><td scope="row"><pre>        [self writeToKeychain];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Implement the myObjectForKey: method, which reads an attribute value from a dictionary:<span></span></pre></td></tr><tr><td scope="row"><pre>- (id)myObjectForKey:(id)key<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return [keychainData objectForKey:key];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Reset the values in the keychain item, or create a new item if it<span></span></pre></td></tr><tr><td scope="row"><pre>// doesn't already exist:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)resetKeychainItem<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    if (!keychainData) //Allocate the keychainData dictionary if it doesn't exist yet.<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        self.keychainData = [[NSMutableDictionary alloc] init];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else if (keychainData)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>    // Format the data in the keychainData dictionary into the format needed for a query<span></span></pre></td></tr><tr><td scope="row"><pre>    //  and put it into tmpDictionary:<span></span></pre></td></tr><tr><td scope="row"><pre>        NSMutableDictionary *tmpDictionary =<span></span></pre></td></tr><tr><td scope="row"><pre>                            [self dictionaryToSecItemFormat:keychainData];<span></span></pre></td></tr><tr><td scope="row"><pre>    // Delete the keychain item in preparation for resetting the values:<span></span></pre></td></tr><tr><td scope="row"><pre>        NSAssert(SecItemDelete((CFDictionaryRef)tmpDictionary) == noErr,<span></span></pre></td></tr><tr><td scope="row"><pre>                                             @"Problem deleting current keychain item." );<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Default generic data for Keychain Item:<span></span></pre></td></tr><tr><td scope="row"><pre>    [keychainData setObject:@"Item label" forKey:(id)kSecAttrLabel];<span></span></pre></td></tr><tr><td scope="row"><pre>    [keychainData setObject:@"Item description" forKey:(id)kSecAttrDescription];<span></span></pre></td></tr><tr><td scope="row"><pre>    [keychainData setObject:@"Account" forKey:(id)kSecAttrAccount];<span></span></pre></td></tr><tr><td scope="row"><pre>    [keychainData setObject:@"Service" forKey:(id)kSecAttrService];<span></span></pre></td></tr><tr><td scope="row"><pre>    [keychainData setObject:@"Your comment here." forKey:(id)kSecAttrComment];<span></span></pre></td></tr><tr><td scope="row"><pre>    [keychainData setObject:@"password" forKey:(id)kSecValueData];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Implement the dictionaryToSecItemFormat: method, which takes the attributes that<span></span></pre></td></tr><tr><td scope="row"><pre>//   you want to add to the keychain item and sets up a dictionary in the format<span></span></pre></td></tr><tr><td scope="row"><pre>//  needed by Keychain Services:<span></span></pre></td></tr><tr><td scope="row"><pre>- (NSMutableDictionary *)dictionaryToSecItemFormat:(NSDictionary *)dictionaryToConvert<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    // This method must be called with a properly populated dictionary<span></span></pre></td></tr><tr><td scope="row"><pre>    // containing all the right key/value pairs for a keychain item search.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Create the return dictionary:<span></span></pre></td></tr><tr><td scope="row"><pre>    NSMutableDictionary *returnDictionary =<span></span></pre></td></tr><tr><td scope="row"><pre>                   [NSMutableDictionary dictionaryWithDictionary:dictionaryToConvert];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Add the keychain item class and the generic attribute:<span></span></pre></td></tr><tr><td scope="row"><pre>    NSData *keychainItemID = [NSData dataWithBytes:kKeychainItemIdentifier<span></span></pre></td></tr><tr><td scope="row"><pre>                              length:strlen((const char *)kKeychainItemIdentifier)];<span></span></pre></td></tr><tr><td scope="row"><pre>    [returnDictionary setObject:keychainItemID forKey:(id)kSecAttrGeneric];<span></span></pre></td></tr><tr><td scope="row"><pre>    [returnDictionary setObject:(id)kSecClassGenericPassword forKey:(id)kSecClass];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Convert the password NSString to NSData to fit the API paradigm:<span></span></pre></td></tr><tr><td scope="row"><pre>    NSString *passwordString = [dictionaryToConvert objectForKey:(id)kSecValueData];<span></span></pre></td></tr><tr><td scope="row"><pre>    [returnDictionary setObject:[passwordString dataUsingEncoding:NSUTF8StringEncoding]<span></span></pre></td></tr><tr><td scope="row"><pre>                                                           forKey:(id)kSecValueData];<span></span></pre></td></tr><tr><td scope="row"><pre>    return returnDictionary;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Implement the secItemFormatToDictionary: method, which takes the attribute dictionary<span></span></pre></td></tr><tr><td scope="row"><pre>//  obtained from the keychain item, acquires the password from the keychain, and<span></span></pre></td></tr><tr><td scope="row"><pre>//  adds it to the attribute dictionary:<span></span></pre></td></tr><tr><td scope="row"><pre>- (NSMutableDictionary *)secItemFormatToDictionary:(NSDictionary *)dictionaryToConvert<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    // This method must be called with a properly populated dictionary<span></span></pre></td></tr><tr><td scope="row"><pre>    // containing all the right key/value pairs for the keychain item.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Create a return dictionary populated with the attributes:<span></span></pre></td></tr><tr><td scope="row"><pre>    NSMutableDictionary *returnDictionary = [NSMutableDictionary<span></span></pre></td></tr><tr><td scope="row"><pre>                                          dictionaryWithDictionary:dictionaryToConvert];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // To acquire the password data from the keychain item,<span></span></pre></td></tr><tr><td scope="row"><pre>    // first add the search key and class attribute required to obtain the password:<span></span></pre></td></tr><tr><td scope="row"><pre>    [returnDictionary setObject:(id)kCFBooleanTrue forKey:(id)kSecReturnData];<span></span></pre></td></tr><tr><td scope="row"><pre>    [returnDictionary setObject:(id)kSecClassGenericPassword forKey:(id)kSecClass];<span></span></pre></td></tr><tr><td scope="row"><pre>    // Then call Keychain Services to get the password:<span></span></pre></td></tr><tr><td scope="row"><pre>    NSData *passwordData = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSError keychainError = noErr; //<span></span></pre></td></tr><tr><td scope="row"><pre>    keychainError = SecItemCopyMatching((CFDictionaryRef)returnDictionary,<span></span></pre></td></tr><tr><td scope="row"><pre>                                       (CFTypeRef *)&amp;passwordData);<span></span></pre></td></tr><tr><td scope="row"><pre>    if keychainError == noErr<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        // Remove the kSecReturnData key; we don't need it anymore:<span></span></pre></td></tr><tr><td scope="row"><pre>        [returnDictionary removeObjectForKey:(id)kSecReturnData];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        // Convert the password to an NSString and add it to the return dictionary:<span></span></pre></td></tr><tr><td scope="row"><pre>        NSString *password = [[[NSString alloc] initWithBytes:[passwordData bytes]<span></span></pre></td></tr><tr><td scope="row"><pre>                 length:[passwordData length] encoding:NSUTF8StringEncoding] autorelease];<span></span></pre></td></tr><tr><td scope="row"><pre>        [returnDictionary setObject:password forKey:(id)kSecValueData];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    // Don't do anything if nothing is found.<span></span></pre></td></tr><tr><td scope="row"><pre>        else<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            if (keychainError == errSecItemNotFound)<span></span></pre></td></tr><tr><td scope="row"><pre>            NSAssert(NO, @"Nothing was found in the keychain.\n");<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    // Any other error is unexpected.<span></span></pre></td></tr><tr><td scope="row"><pre>    else<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        NSAssert(NO, @"Serious error.\n");<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    [passwordData release];<span></span></pre></td></tr><tr><td scope="row"><pre>    return returnDictionary;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Implement the writeToKeychain method, which is called by the mySetObject routine,<span></span></pre></td></tr><tr><td scope="row"><pre>//   which in turn is called by the UI when there is new data for the keychain. This<span></span></pre></td></tr><tr><td scope="row"><pre>//   method modifies an existing keychain item, or--if the item does not already<span></span></pre></td></tr><tr><td scope="row"><pre>//   exist--creates a new keychain item with the new attribute value plus<span></span></pre></td></tr><tr><td scope="row"><pre>//  default values for the other attributes.<span></span></pre></td></tr><tr><td scope="row"><pre>- (void)writeToKeychain<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    NSDictionary *attributes = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSMutableDictionary *updateItem = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // If the keychain item already exists, modify it:<span></span></pre></td></tr><tr><td scope="row"><pre>    if (SecItemCopyMatching((CFDictionaryRef)genericPasswordQuery,<span></span></pre></td></tr><tr><td scope="row"><pre>                           (CFTypeRef *)&amp;attributes) == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        // First, get the attributes returned from the keychain and add them to the<span></span></pre></td></tr><tr><td scope="row"><pre>        // dictionary that controls the update:<span></span></pre></td></tr><tr><td scope="row"><pre>        updateItem = [NSMutableDictionary dictionaryWithDictionary:attributes];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        // Second, get the class value from the generic password query dictionary and<span></span></pre></td></tr><tr><td scope="row"><pre>        // add it to the updateItem dictionary:<span></span></pre></td></tr><tr><td scope="row"><pre>        [updateItem setObject:[genericPasswordQuery objectForKey:(id)kSecClass]<span></span></pre></td></tr><tr><td scope="row"><pre>                                                          forKey:(id)kSecClass];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        // Finally, set up the dictionary that contains new values for the attributes:<span></span></pre></td></tr><tr><td scope="row"><pre>        NSMutableDictionary *tempCheck = [self dictionaryToSecItemFormat:keychainData];<span></span></pre></td></tr><tr><td scope="row"><pre>        //Remove the class--it's not a keychain attribute:<span></span></pre></td></tr><tr><td scope="row"><pre>        [tempCheck removeObjectForKey:(id)kSecClass];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>       // You can update only a single keychain item at a time.<span></span></pre></td></tr><tr><td scope="row"><pre>        NSAssert(SecItemUpdate((CFDictionaryRef)updateItem,<span></span></pre></td></tr><tr><td scope="row"><pre>                (CFDictionaryRef)tempCheck) == noErr,<span></span></pre></td></tr><tr><td scope="row"><pre>                @"Couldn't update the Keychain Item." );<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>// No previous item found; add the new item.<span></span></pre></td></tr><tr><td scope="row"><pre>// The new value was added to the keychainData dictionary in the mySetObject routine,<span></span></pre></td></tr><tr><td scope="row"><pre>//  and the other values were added to the keychainData dictionary previously.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>   // No pointer to the newly-added items is needed, so pass NULL for the second parameter:<span></span></pre></td></tr><tr><td scope="row"><pre>        NSAssert(SecItemAdd((CFDictionaryRef)[self dictionaryToSecItemFormat:keychainData],<span></span></pre></td></tr><tr><td scope="row"><pre>                 NULL) == noErr, @"Couldn't add the Keychain Item." );<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#endif<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@end<span></span></pre></td></tr></table></div>	<p>This example follows the same general sequence that was shown in <span class="content_text"><a href="iPhoneTasks.html#//apple_ref/doc/uid/TP30000897-CH208-SW2">Figure 3-1</a></span>. In this sample, the generic attribute is used to create a unique string that can be used to easily identify the keychain item. If you wish, you can use standard attributes such as the service name and user name for the same purpose.</p>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../03tasks/tasks.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../glossary/glossary.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2003, 2009 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2009-03-12<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Security/Conceptual/keychainServConcepts/iPhoneTasks/iPhoneTasks.html%3Fid%3DTP30000897-3.2&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Security/Conceptual/keychainServConcepts/iPhoneTasks/iPhoneTasks.html%3Fid%3DTP30000897-3.2&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Security/Conceptual/keychainServConcepts/iPhoneTasks/iPhoneTasks.html%3Fid%3DTP30000897-3.2&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>