<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note NW21: Data Servers on AppleTalk</title><meta name="keywords" content=""><meta name="Description" content="Technical Note NW21: ">    <meta name="categories" content="Networking"><meta name="week-posted" content="Apr 1, 1985 - Apr 5, 1985"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"><a name="//apple_ref/doc/uid/DTS10002563" title="Data Servers on AppleTalk"></a><a name="top"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxNetworking-date.html">Networking</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/Networking/index.html" target="_blank">Reference Library > Networking</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note NW21</div>
<div id="pageheadsub">Data Servers on AppleTalk</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->					<p id="menutext"><a href="#Introduction">Introduction</a><BR><BR><a href="#Section1">ATP: The AppleTalk Transaction Protocol</a><BR><BR><a href="#Section2">Establishing the Connection</a><BR><BR><a href="#Section3">Half-Open Connections</a><BR><BR><a href="#Section4">Using the Connection</a><BR><BR><a href="#Section5">Closing the Connection</a><BR><BR><a href="#References">References</a><BR><BR><a href="#Downloads">Downloadables</a></p>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">Many applications could benefit from the ability to share common data betweenseveral Macintoshes, without requiring a file server. This technical notediscusses one technique for managing this AppleTalk communication.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Nov 01 1990]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR><!-- begin_content --><a name="Introduction"></a><h2>Introduction</h2><P>There are four main classes of network "server" devices:</p><p><b>Device Servers</b>, such as the LaserWriter, allow several users to share asingle hardware device; other examples of this (currently under development bythird parties) are modem servers and serial servers (to take advantage ofnon-intelligent printers such as the ImageWriter).</p><p><b>File Servers</b>, such as AppleShare, which support file access operations overthe network. A user station sends high-level requests over the network (such as"Open this file," "Read 137 bytes starting at the current file position of thisfile," "Close this file," etc.).</p><p><b>Block Servers</b>, which answer to block requests over the network. Theserequests impart no file system knowledge about the blocks being passed, i.e.,the server doesn't know which files are open by which users, and thereforecannot protect one user's open file from other users. Examples of this type ofserver are available from third-party developers.</p><p><b>Data Servers</b>, which answer to requests at a higher level than file servers,such as "Give me the first four records from the database which match thefollowing search specification." This note directs its attention at this typeof server.</p><p>A data server is like a file server in that it responds to intelligentrequests, but the requests that it responds to can be more specialized, becausethe code in the server was written to handle that specific type of request.This has several added benefits: user station processing can be reduced, if thedata server is used for sorting or searching operations; and network traffic isreduced, because of the specificity of the requests passed over the network.The data server can even be designed to do printing (over the network to aLaserWriter, or on a local ImageWriter), given that it has the data and can bedirected as to the format in which it should be printed.</p><P><A HREF="#top">Back to top</A></P><a name="Section1"></a><h2>ATP: The AppleTalk Transaction Protocol</h2><p>ATP, the assured-delivery AppleTalk Transaction Protocol, can be used tosupport all types of server communications (the LaserWriter uses ATP for itscommunications!). Here is a possible scenario between two user stations ("Dave"and "Bill") and a data server station ("OneServer", a server of type"MyServer"). We've found that the "conversational" analogy is helpful whenplanning AppleTalk communications; this example is therefore presented as aconversation, along with appropriate AppleTalk Manager calls (Note that noerror handling is presented, however; your application should contain code forhandling errors, specifically the "half-open connection" problem describedbelow).</p><P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>Establishing the Connection</h2><p>Each station uses <code>ATPLoad</code> to make sure that AppleTalk is loaded. Theserver station, since it wants to accept requests, opens a socket and registersits name using <code>NBPRegister</code>. The user stations use <code>NBPLookUp</code> to find out the server's network address. This looks like this, conversationally:</p><p>Server: "I'm ready to acceptAppleTalk requests!"</p>         <P><code>ATPLoad</code> Opens</p>          <P><code>OpenSocket</code> Creates socket</p><P><code>NBPRegister</code> Assigns name to socket</p><P><code>ATPGetRequest</code> queue a few asynchronous</p><P><code>ATPGetRequest</code>  calls, to be able to handle several</p><P><code>ATPGetRequest</code> users</p><p>Dave: "Any 'MyServers' out there?"</p><p><code>ATPLoad</code> Opens AppleTalk</p><P><code>NBPLookup</code> look for servers, finds One Server</p><p>Dave: "Hey, MyServer! What socket should I talk to you on?"</p>     <P><code>ATPRequest</code> Ask the server which socket to use for further communications</p>    <p>Bill:    "Any 'MyServers' out there?"</p><p><code>ATPLoad</code> Opens AppleTalk</p><p><code>NBPLookup</code> look for servers, finds OneServer</p><p>Bill: "Hey, MyServer! What socket should I talk to you  on?"</p>   <P> <code>ATPRequest</code> Ask the server which socketto use for further communications</p>    <p>Server:    "Hi, Dave! Use Socket N."</p><p><code>ATPOpenSkt</code>  Get a new socket for talking to Dave</p><P><code>ATPResponse</code> Send Dave the socket number</p><P><code>ATPGetRequest</code> Replace the used <code>GetRequest</code></p><P>Server:    "Hi, Bill! Use socket M."</p><P><code>ATPOpenSkt</code> Get a new socket for talking to Bill</p><P><code>ATPGetRequest</code> Replace the used <code>GetRequest</code></p><p>From this point on, the server knows that any requests received on socket N arefrom Dave, and those received on socket M are from Bill. The conversationscontinue, after a brief discussion of error handling.</p><P><A HREF="#top">Back to top</A></P><a name="Section3"></a><h2>Half-Open Connections</h2><p>There is a possibility that one side of a connection could go down (be poweredoff, rebooted accidently, or simply crash) before the connection has beenofficially broken. If a user station goes down, the server must throw away anysaved state information and close that user's open socket. This can be done byrequiring that the user stations periodically "tickle" the server: every 30seconds (for example) the user station sends a dummy request to the server,which sends a dummy response. This lets each side of the connection know thatthe other side is still "alive."</p><p>When the server detects that two intervals have gone by without a ticklerequest, it can assume that the user station has crashed, and close that user'ssocket and throw away any accumulated state information.</p><p>The user station should use a vertical-blanking task to generate these ticklerequests asynchronously, rather than generating them within the<code>GetNextEvent</code> loop; this avoids problems with long periods away from<code>GetNextEvent </code>(such as when a modal dialog box is running). This taskcan look at the time that the last request was made of the server, and if it'sapproaching the interval time, queue an <b>asynchronous</b> request to ticklethe server (it's important that any AppleTalk calls made from interrupt orcompletion routines be asynchronous).</p><p>If a user station's request (including a tickle request) goes unanswered, theuser station should recover by looking for the server and reestablishingcommunications as shown above (beginning with the call to<code>NBPLookUp</code>).</p><p>More information about half-open connections can be found in the Printer AccessProtocol chapter of <i>Inside LaserWriter,</i> available from APDA.</p><P><A HREF="#top">Back to top</A></P><a name="Section4"></a><h2>Using the Connection</h2><p>The user stations Dave and Bill have established communications with theserver, each on its own socket (note that the user stations have not had toopen their own sockets, or register names of their own, to do this--the nameswe're using are merely for explanational convenience). They are alsoautomatically tickling the server as necessary.</p><p>Now the user stations make requests of the server as needed:</p><p>Bill:    "I'd like to use the sales figures for this year."</p> <P><code>ATPRequest</code> Bill opens a database.</p>    <p>Server:    "Ok, Bill."</p><P><code>ATPResponse</code> The server checks to make sure that no one else is using that database.</p><p>Dave: "Hey, Server - I'm still here!"</p><P><code>ATPRequest</code> Dave notices that the interval time is                 approaching, and makes a tickle request.</p><p>Server: "OK, Dave."</p><P><code>ATPResponse</code> The server resets its "last time Iheard from Dave."</p><p>Bill: "Please print the figures</p><P><code>ATPRequest</code> Bill asks for specific data for January thru June."</p><p>Server: "OK, Bill."</p><P><code>ATPResponse</code> The server does a database search, sorts the results, and prints them on a local Imagewriter.</p><p>Dave:    "I'd like to use the sales figures for this year."</p>       <P><code>ATPRequest</code> Dave opens a database.</p>    <p>Server:    "Sorry, Dave, I can't do that. Bill is using that database."   </p><P><code>ATPResponse</code> The server finds that Bill is using that data.</p><P><A HREF="#top">Back to top</A></P>      <a name="Section5"></a><h2>Closing the Connection</h2><p>The user stations continue making requests of the server, until each isfinished. The type of work being done by the server determines how long theconversation will last: since the number of sockets openable by the server islimited, it may be desirable to structure the requests in such a way that theaverage conversation is very short. It may also be necessary to have a (NBPnamed) socket open on the user station, if the server needs to communicate withthe user on other than a request-response basis. Here is how our exampleconnections ended:</p><p>Dave: "Thank you, server, I'm done</p><P><code>ATPRequest</code> Dave tells the server he's finished now. You've been a big help."</p><p>Server:    "OK, Dave. Bye now."</p><P><code>ATPResponse</code> The server kisses Dave goodbye.</p><P><code>ATPCloseSkt</code> After the Response operation                                     completes, the server closes the socket Dave was using. It also</p>                   <P><code>ATPCloseSkt</code> notices that Bill hasn't sent a request in more than two intervals, and closes Bill's socket, too.</p><p>The user station can forget about the socket it was using on the server; if itneeds to talk with the server again, it starts at the <code>NBPLookUp</code> (justin case the server has moved, gone down and come up, etc.).</p><a name="References"></a><h2>References</h2><P>The AppleTalk Manager <i>Inside LaserWriter</i></p>                                   <P><A HREF="#top">Back to top</A></P><P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (56K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/nw_21.pdf">Download</A></P>               </TD>            </TR>                     </TABLE>         <BR>         <P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/nw/nw_21.html%3Fid%3DDTS10002563-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/nw/nw_21.html%3Fid%3DDTS10002563-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/nw/nw_21.html%3Fid%3DDTS10002563-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>