<HTML><HEAD>   <title>Technical Q&amp;A QA1173: Text Encodings in VFS</title><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><meta name="keywords" content="Mac OS X, BSD, VFS, text encodings, UTF-8, Unicode, precompose,decomposed"><meta name="Description" content="Technical Q&amp;A QA1173: Describes how to handle text encodingscorrectly when writing a file system (VFS) plug-in for MacOS X."><meta name="categories" content="Files"><meta name="week-posted" content="Aug 12, 2002 - Aug 16, 2002"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10001705" title="Text Encodings in VFS"></a><P><!-- top_of_header_marker_comment --> <!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/Carbon/index.html">Carbon</a> &gt; <a href="../../technicalqas/Carbon/idxFileManagement-date.html">File Management</a> &gt; </p><!-- end_header_information --> <!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A QA1173</div>
<div id="pageheadsub">Text Encodings in VFS</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --></P><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600>   <TR>      <td align="left">         <P><!-- begin_content -->                  <hr width=500 align=center>                  </P>                  <P id=p2>Q: I'm writing a file system (VFS) plug-in for Mac         OS X. How do I handle text encodings correctly?</P>                  <P id=p4>A: In Mac OS X's VFS API file names are, by         definition, canonically decomposed Unicode, encoded using         UTF-8. This raises a number of interesting issues.</P>                  <H4 id=p4>Precomposed versus Decomposed</H4>						<P id=p4>This Q&amp;A assumes that you're familiar with the terms precomposed 						and decomposed Unicode. If that's not the case, there's a short explanation in 						DTS Q&amp;A 1235 <a href="qa1235.html">Converting to Precomposed Unicode</a>.</P>						<CENTER>							         </CENTER>						<CENTER>							<TABLE BORDER=0 CELLPADDING=3 WIDTH=550>            <TR>               <td bgcolor="#E6E6E6" align=left>                  <P><B>IMPORTANT:</B><BR>											The terms used in this Q&amp;A, decomposed and precomposed, 											roughly correspond to Unicode Normal Forms D and C, 											respectively. However, most volume formats do not follow the <EM>exact</EM>                  specification for these normal forms. For example,                  HFS Plus uses a variant of Normal Form D in which                  U+2000 through U+2FFF, U+F900 through U+FAFF, and                  U+2F800 through U+2FAFF are not decomposed (this                  avoids problems with round trip conversions from                  old Mac text encodings). It's likely that your                  volume format has similar oddities.</P>               </TD>            </TR>         </TABLE>          </CENTER>         <H4 id=p4>Volume Format</H4>                  <P id=p4>Your target volume format should define whether it         uses precomposed or decomposed Unicode. For example, HFS         Plus uses decomposed Unicode whereas UDF and SMB use         precomposed Unicode.</P>                  <P id=p4>Unfortunately, some volume formats (for example, NFS) have no accepted standard.          This presents  additional challenges, which I'll cover below.</P>                  <CENTER><TABLE BORDER=0 CELLPADDING=3 WIDTH=550>            <TR>               <td bgcolor="#E6E6E6" align=left>                  <P><B>Note:</B><BR>                  Throughout this Q&amp;A I use the term                  <B>volume format</B>                  to indicate either an on-disk volume format or a                  network protocol.</P>               </TD>            </TR>         </TABLE>         </CENTER>                  <H4 id=p4>Returning Names</H4>                  <P id=p4>When returning names to higher layers (for example,         from your <CODE>VOP_READDIR</CODE> entry point), you should         always return decomposed names. If your underlying volume         format uses precomposed names, you should convert any         precomposed characters to their decomposed equivalents         before returning them to the system.</P>                  <H4 id=p4>Accepting Names</H4>                  <P id=p4>In most cases, high-level software will pass         decomposed names to your file system. However, this is not         guaranteed. There are a variety of circumstances (some         discussed below) where your file system is passed         precomposed names. Regardless of their incoming state, you         should always convert names to the encoding scheme required         by your underlying volume format.         Thus, if your underlying volume         format requires precomposed names, you should convert names         to their precomposed variant before writing them to disk.         Similarly, if your volume format requires decomposed names,         you should decompose any precomposed characters.</P>                  <P id=p4>This raises the question of what to do if your         underlying volume format does not define a standard. There         is no good solution here. You can choose to pass through         names unchanged, which is what Apple's NFS implementation         does, or provide some user interface for the user to choose         (similar to the "Character Set" popup in the AppleShare         login dialog). Either way the user experience will not be         ideal.</P>                  <H4 id=p4>Implementation</H4>         <P id=p4>The <A HREF="http://developer.apple.com/documentation/Carbon/text/TextEncodConversionMgr/tecmgr.html">Unicode         Converter</A> provides a mechanism to convert between precomposed and decomposed Unicode. See           DTS Q&amp;A 1235 <a href="qa1235.html">Converting to Precomposed Unicode</a> for more details on doing this. However, the Unicode Converter is not callable from inside the kernel, where your VFS plug-in resides. Therefore, you will probably need to roll your own code to compose and decompose Unicode. The basics for doing this are covered in the <a href="../../technotes/tn/tn1150table.html">table</A>         contained in DTS Technote 1150 <a href="../../technotes/tn/tn1150.html">HFS         Plus Volume Format</A>.</P>         <P id=p4>If you agree to the <A HREF="http://www.opensource.apple.com/apsl/">Apple         Public Source License</A> you can also look at the code         Apple uses in our HFS Plus implementation.</P>         <UL id=p4>            <LI><A HREF="http://www.opensource.apple.com/cgi-bin/registered/cvs/src/notlive/xnu/bsd/sys/utfconv.h">utfconv.h</A>            <BR><BR></LI>                        <LI>            <A HREF="http://www.opensource.apple.com/cgi-bin/registered/cvs/src/notlive/xnu/bsd/vfs/vfs_utfconv.c">vfs_utfconv.c</A>             <BR><BR></LI>         </UL>                  <CENTER><TABLE BORDER=0 CELLPADDING=3 WIDTH=550>            <TR>               <td bgcolor="#E6E6E6" align=left>                  <P><B>IMPORTANT:</B><BR>                  The presence of the                  <CODE>__APPLE_API_UNSTABLE</CODE> guard at the top                  of "utfconv.h" indicates that, if your kernel code                  calls these APIs directly, it may suffer binary                  compatibility problems in the future.</P>               </TD>            </TR>         </TABLE>         </CENTER>                  <P id=p4>I strongly recommend that you look through this source, even if you don't choose to reuse it in your own file system. Converting between precomposed and decomposed Unicode text is a complicated process and our implementation will give you an understanding of the scope of the problem.</P>						<p id=p4>You can find more information about this issue on the <A HREF="http://www.unicode.org/">Unicode consortium web         site</A>. You may also want to look at the normalization functions provided in <a href="http://oss.software.ibm.com/icu/userguide/normalization.html">International Components for Unicode</a> (IBM's open source code for internationalization with Unicode).</p>         <H4 id=p4>Compatibility</H4>                  <P id=p4>In theory the techniques describes above can cause         compatibility problems for applications. For example, if an         application creates a file using a precomposed name and then         iterates through the directory looking for that file using a         simple binary string comparison, it won't find the file. In         practice this is rarely a problem. Don't forget that the         primary file system, HFS Plus, works this way, so any         program that's incompatible with your file system will also         be incompatible with HFS Plus.</P>                  <P id=p4>Most of Apple's built-in file systems use the techniques described above. Two notable exceptions are NFS and UFS. Of these, NFS is the most troublesome because NFS volumes can be shared with non-Mac clients that create files with precomposed characters in their names, and the Mac OS X NFS client does not decompose them before returning them to applications. If the user copies files from an NFS volume to your volume using a naive copy program (like the <code>cp</code> command line tool), the copy program will copy the files without decomposing the names. Thus your file system will by asked to create files with precomposed names. Your file system must be prepared to handle this, as described above.</P>                  <P>                  <hr width=500 align=center>                  </P>                  <!-- begin_date --><CENTER><H4>[Feb 10 2003]</H4></CENTER><!-- end_date -->      </TD>   </TR></TABLE></CENTER><P><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/qa2001/qa1173.html%3Fid%3DDTS10001705-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/qa2001/qa1173.html%3Fid%3DDTS10001705-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/qa2001/qa1173.html%3Fid%3DDTS10001705-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></P></BODY></HTML>