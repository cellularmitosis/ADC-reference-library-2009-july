<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-05-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1149: Smoothing Fonts</title>       <meta name="keywords" content="Mac OS 8 Fonts smoothing appearance anti-aliasing highlighting IsAntiAliasedTextEnabled SetAntiAliasedTextEnabled">    <meta name="Description" content="Technical Note TN1149: This Technical Note briefly explainsthe current implementation of (Smooth all fonts on screen)checkbox in the Appearance control panel, accompanied bya setting of the minimum text size required for turning onanti-aliasing. Note also discusses its limitations and thepossible compatibility problems with existing applications.New APIs that allow applications to take control over anti-aliasedtext rendering are documented and an explanation is givenas to why anti-aliased text looks so bad when highlighted(in particular with dark highlight colors), and what youcan do to solve the problem."><meta name="categories" content="Text"><meta name="week-posted" content="Dec 28, 1998 - Jan 1, 1999"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002988" title="Smoothing Fonts"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/index.html" target="_blank">Reference Library</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1149</div>
<div id="pageheadsub">Smoothing Fonts</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left">         <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">     <tr><td width=300 valign="top" align=left scope="row">    <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>        </tr>        <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left>       <span id="menutitle">CONTENTS   <br>  <br>       </span>   </td>        </tr>        <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left>       <!-- begin_toc -->         <P id ="menutext"><A HREF = "#Section1">Smooth Edges</A><BR><BR>         <A HREF = "#Section2">How to Turn Smoothing ON and OFF</A><BR><BR>         <A HREF = "#Section3">What Happened to Highlighting</A><BR><BR>         <A HREF = "#Summary">Summary</A><BR><BR><A HREF="#Downloads">Downloadables</A></p>  <!-- end_toc --></td>        </tr>        <tr>   <td width=300 align=left scope="row">       <img src="images/tnmenubottom.gif" alt="" width=300 height=16>   </td>        </tr>    </table></td>        <td width=300 valign="top" align=left>            <!-- begin_intro_text --><P id = "introtext">Mac OS 8.5 came with a "Smooth all fonts on screen" checkbox in the Appearance control panel, accompanied by a setting of the minimum text size required for turning on anti-aliasing. In this Technote, I briefly explain the current implementation of this feature, and discuss its limitations and the possible compatibility problems with existing applications. I then document the new APIs that allow applications to take control over anti-aliased text rendering. Finally, I explain why anti-aliased text looks so bad when highlighted (in particular with dark highlight colors), and what you can do to solve the problem.</P><!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Jan 18 1998]</h3><!-- end_date --></TD>             </TR>          </TABLE> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><A NAME="Section1"></A><H2>Smooth Edges</H2><h3>What Are They?</h3><P>Here are two samples of text with and without font smoothing turned on (sample text is in Textile font, size 24):</P><TABLE border=0>    <TR>    <TD ALIGN=center width=300 align="left"><img src="images/tn1149_001.gif" alt="Smoothing Off" width=165 height=42><BR>Font smoothing OFF</TD>    <TD ALIGN=center width=300 align="left"><img src="images/tn1149_002.gif" alt="Smoothing On" width=161 height=41><BR>    Font smoothing ON</TD>    </TR></TABLE><P>And here is the (visual) explanation of why the right hand side looks better:</P><TABLE width=550>    <TR><TD ALIGN=center align="left"><img src="images/tn1149_003.gif" alt="Font smoothness comparison" width=392 height=127></TD></TR></TABLE><BR><P>When the outline of a character is scan-converted to a bitmap, the limited resolution of the screen device causes "jaggies" to appear along non-vertical and non-horizontal portions of the contour. By adding levels of gray along oblique or round edges, your eyes get tricked into perceiving smoother contours. To produce the gray-level pixmaps for anti-aliased text, the new TrueType scaler in Mac OS 8.5 still uses the grid-fitted outline for the requested size. But, before passing the outline to the traditional black-white scan converter, it conceptually replaces each pixel by a square of 4x4 sub-pixels, and applies the scan conversion to four-times the original resolution. The count of black dots in the resulting bitmap squares for each pixel (a number between 0 and 16) is then mapped to a gray level encoded in four bits (a value from 0 to 15), which becomes the pixmap's pixel value. QuickDrawText's blitter then looks to it that these gray levels blend nicely from the text's foreground color into the existing background color.</p><h3>What are the issues?</h3><P>So far, so good. Unfortunately, this approach comes with some potentially annoying consequences (some of which are alluded to in the "Mac OS 8.5 Read Me" file):</p><h3>a) Font Smoothing ON implies <CODE>SetOutlinePreferred(TRUE)</CODE>. Because the metrics of outline fonts are in general different from the bitmap font metrics, text may reflow, or get mispositioned or clipped.</h3><P>This was a deliberate design decision. Take the example of the font Times normal. It comes as an outline font, accompanied by bitmap (<CODE>NFNT</CODE>) versions for the sizes 9, 10, 12, 14, 18, and 24. By default, the <CODE>outlinePreferred</CODE> flag is off; this has been done this way (back at the time when System 7 with TrueType was introduced), to avoid reflow of existing documents that used the bitmap fonts, given that the metrics of the outline font are different from those of the bitmap fonts.</p><P>It's bad enough that since then the appearance and metrics of text goes through qualitative jumps while scaling through different sizes. Without the above decision, we would see another qualitative jump when font smoothing is turned on: sizes 11, 13, 15, 16, 17, 19, etc. would appear anti-aliased, and the bitmap sizes would stay jaggily black-white!</p><P>Still, Mac OS 8.5 is not even consistent in this matter. If the bitmap versions are hidden inside the <CODE>sfnt</CODE> format (in 'bloc' and 'bdat' tables), the current version of the TrueType scaler doesn't quite know what to do with <CODE>outlinePreferred</CODE>. In an attempt to avoid some other compatibility problems with the metrics of existing 2-byte fonts, it ignores the request for smoothed text, and returns unsmoothed glyphs, in this case  -  with yet another exception, if the bitmaps contained in the '<CODE>bdat</CODE>' and '<CODE>bloc</CODE>' tables are themselves stored grayscaled. This will only be the case for certain Microsoft fonts converted for use on the Macintosh platform.</p><P>The only good solutions would be either to provide gray-level versions of all the bitmap fonts, or to develop a procedural antialiasing of the existing bitmap fonts. The first option clearly is not realistic; the second was victimized by the well-known time-resource constraints of any software engineering effort. Other solutions have been proposed; they are "not good". It is in general typographically plainly impossible, from an esthetic point of view, to use the metrics of bitmap fonts together with glyphs rendered from outlines, or vice-versa.</p><h3>b) Applications assume that text is always representable in a black-white bitmap.</h3><P>There are good reasons to draw text in an offscreen (flicker-free editing and scrolling, etc.), and there are good reasons to try to get away with a 1-bit deep offscreen (memory footprint). Obviously, anti-aliased text cannot be rendered under these circumstances, and if the application mixes calls to direct text drawing onto the screen with updates from the offscreen, anti-aliased and non-anti-aliased text can end up next to each other.</p><P>Even if the offscreen is deep enough, i.e., at least 8 bits/pixel, the assumption of monochrome text may still hurt. Some applications use QuickDraw's <CODE>CopyBits</CODE> to transfer the offscreen text on top of some textured background, for example. But there is no <CODE>CopyBits</CODE> transfer mode that knows how to blend the gray fringe pixels into the destination, while keeping the "black" source pixels intact. The result is in general quite unsatisfactory.</p><h3>c) Highlighting and unhighlighting assume monochrome text</h3><p>The consequences of this fact are bad enough that they deserve their own chapter, at the end of this note.</p><BR><P><A HREF="#top">Back to top</A></P><A NAME="Section2"></A><BR><H2>How to Turn Smoothing ON and OFF</H2><P>With all these possible consequences of turning font smoothing on, it is clear that applications need a programmatic way to interfere with a user's setting. More positively, they should also get the possibility to selectively turn anti-aliasing on, even on systems where the user chose not to enable font smoothing.</p><P>It is equally clear that applications need to restore the system's state as soon as they are done with their text-rendering job that required a different setting. Setting and restoring the flag of font smoothing carries no performance penalty at all (in contrast to what seasoned Mac OS programmers might assume, based on experience with pre-8.5 versions of the <CODE>FontManager</CODE>). However, it is a system-wide global setting (not a per-<CODE>GrafPort</CODE> or per-context one), and as such, it affects all text redrawing of background processes and system-owned text drawing as well. It would not make a good impression to have text rendering switch unpredictably between anti-aliasing and not.</p><P>Here are the API calls, as contained in the latest versions of the <a href="http://developer.apple.com/sdk/"><I>Fonts.h</I></A> include file:</p><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>     Boolean  IsAntiAliasedTextEnabled(SInt16* outMinFontSize);<BR>     OSStatus SetAntiAliasedTextEnabled(Boolean inEnable, SInt16 inMinFontSize);</pre></TD></TR></TABLE></CENTER><BR><BR><P>The first function returns a Boolean with the obvious interpretation. If you are interested in the minimum size for which anti-aliasing is enabled, *<CODE>outMinFontSize</code> returns this value as set by the user in the Appearance control panel, provided the function value is TRUE; if the function value is FALSE,  *<CODE>outMinFontSize</code> is undefined. If you do not care about this minimum font size, pass NULL as parameter. </p><P>The second function allows to set the state of anti-aliased text; if <CODE>inEnable</code> is TRUE, the <CODE>inMinFontSize</CODE> parameter is put in the place where a user-selected minimum font size value would go. Because the rendering quality of anti-aliased text for small point sizes is currently perceived as unsatisfactory, minimum sizes below 12 are not allowed, and are, in fact, replaced by 12. The function always returns <CODE>noErr</code>.</p><P>Here is an example of how to use these functions to turn anti-aliased text temporarily OFF (if it's enabled):</p><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>//-------------------------------------------------Boolean  userWantsSmoothText ;SInt16 previousMinSize;userWantsSmoothText = IsAntiAliasedTextEnabled(&amp;previousMinSize);if (userWantsSmoothText) (void)SetAntiAliasedTextEnabled(false, 0); // second parameter is ignored when first parameter is FALSE// draw text the "jaggy" way, here// and then set it back to what the user wants:if (userWantsSmoothText) (void)SetAntiAliasedTextEnabled(true, previousMinSize);//-------------------------------------------------</pre></TD></TR></TABLE></CENTER><BR><BR><P>One more thing: the symbols <CODE>IsAntiAliasedTextEnabled</code> and <CODE>SetAntiAliasedTextEnabled</code> are exported from the <CODE>FontManager</CODE> code fragment in the System, but the <CODE>InterfaceLib</CODE> you are using with your development tools may not yet include them. To make the Linker happy, you may need to create a little "<CODE>FontManager</CODE>" stub library that exports these symbols and contains empty implementations of the functions, until the next revision of the <CODE>InterfaceLib</CODE>.</p><BR><P><A HREF="#top">Back to top</A></P><BR><A NAME="Section3"></A><H2>What Happened to Highlighting?</H2>The "Imaging With QuickDraw" volume of <U>Inside Macintosh</U> explains on pages 4-41 through 4-44 how the highlighting concept has been designed in QuickDraw. Here are the two crucial features: <BR><h3>a) highlighting only affects pixels with either the background or the highlight color; <BR><BR> b) calling the highlighting function twice returns the original state.</h3><P>Clearly, there was no anticipation of anti-aliasing in the original design of QuickDraw. When a bitmap edge gets smoothed by using shades of colors that blend the foreground color into the background color, the fringe of intermediate shades does not participate in the highlighting algorithm. Assume  that the foreground color is black, the background white, and the highlight color pretty saturated (like a dark blue or red). With anti-aliased text, there will be a fringe of more or less light-gray pixels around the original black bitmap, to blend the contours into white. When highlighting is applied, the white background pixels are replaced by the relatively dark highlight color, whereas the "fringe" pixels keep their original values. The effect is an ugly sparkling around the contour, which can make the text nearly unreadable in small sizes and certain type faces.</p><P>Apple tried hard to find a solution to this problem, but the evidence of the facts won.  It is not possible in practice to maintain feature b) above (a requirement for compatibility with existing code), while modifying feature a) such that contours blend correctly into whatever the background pixels are (highlighted or not).</p><P>The solution has to come from a different approach to highlighting. Either the highlighted areas are first erased to the desired state (highlighted or not), before the text is drawn into the area, or we provide two different API calls for Highlighting and Unhighlighting and implement them in a way that takes anti-aliased text into account.  (See the functions <CODE>ATSUHighlightText</code> and <CODE>ATSUUnHighlightText</code> in ATSUnicode.h for an example.)</p><P>For the time being, we recommend you use a pastel-like highlight color which minimizes the ugliness, or to turn off anti-aliased text altogether if you are frequently editing text in sizes and type faces that make the defect particularly annoying.</p><BR><P><A HREF="#top">Back to top</A></P><A NAME="Summary"></A><H2>Summary</H2><P>Mac OS 8.5 introduced the feature of anti-aliased text, which provides a substantial esthetic improvement in many text drawing cases, in particular for slanted type faces. However, it became apparent that it may conflict with assumptions made in legacy code, and that it comes with other undesirable side effects. Expect that the future will bring certain improvements. </p><p>On the other hand, perhaps we should follow the recommendation "enjoy moderately and wisely" not only for some other good things in life, but also for font smoothing.</p><BR><P><A HREF="#top">Back to top</A></P><A NAME="Downloads"></A> <h2>Downloadables</h2>        <center><TABLE BORDER=0 CELLPADDING=3 WIDTH="600">         <TR>             <td width=50 align=left>               <P ALIGN=center><img src="images/acrobatsmall.gif" align=middle alt="Acrobat" width=22 height=23></P>            </TD>            <td align="left">               <p>Acrobat version of this Note (84K).</P>            </TD>            <td width=60 align=left>               <p><A HREF="pdf/tn1149.pdf">Download</A></P>            </TD>          </TR> </table></center><BR><BR><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1149.html%3Fid%3DDTS10002988-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1149.html%3Fid%3DDTS10002988-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1149.html%3Fid%3DDTS10002988-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>