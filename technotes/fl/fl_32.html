<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-August-01 --><!-- Includes revisions to graphics tags --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note FL32: Hey Buddy, Can You Spare A Block?</title><meta name="keywords" content="Mac OS 7 File Manager bad block sparing HFS"><meta name="Description" content="Technical Note FL32: This Technical Note discusses, includingdescribing the algorithm, a feature of the System Software7.0 Disk Initialization Package--bad block sparing. Thisfeature does not affect any applications which use the normalHFS file system; the only expected impact of this featureis for those applications which perform disk reads from orwrites to the disk directly, like scavenger, recovery, andfloppy disk utilities.">                                       <meta name="categories" content="Files"><meta name="week-posted" content="Jan 28, 1991 - Feb 1, 1991"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002458" title="Hey Buddy, Can You Spare A Block?"></a><A NAME="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxCarbon-date.html">Carbon</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Carbon/idxFileManagement-date.html" target="_blank">Carbon > File Management</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note FL32</div>
<div id="pageheadsub">Hey Buddy, Can You Spare A Block?</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext">					<A HREF="#Section1">Introduction</a><BR><BR> <A HREF="#algorithm">The Algorithm</a><BR><BR> 	<A HREF="#Summary">Summary</a><BR><BR> <A HREF="#References">References</A><BR><BR>   <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">This Technical Note discusses a new feature of the System Software 7.0 Disk Initialization Package--bad block sparing.</p><BR><CENTER><TABLE BORDER=0 WIDTH=275><TR><td bgcolor="#E6E6E6" align=left><P id = "introtext"><B>Warning:</B><BR>Software that accesses blocks directly from the disk or makes assumptions about the physical blocks of a device is, has always been, and will always be, a compatibilityrisk.  The format of the file directory is changing in System Software 7.0 and additional changes being made to the Disk Initialization Package will cause such software to fail.</P></TD></TR></TABLE></CENTER><BR><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Feb 01 1991]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR><!-- begin_content --><a name="Section1"></a><h2>Introduction</h2><p>The Disk Initialization Package that is being shipped with System Software 7.0contains a new feature, <b>bad block sparing</b>.  This new feature is done withoutmodification to any disk drivers and is independent of the device's geometry.  When the system finds bad blocks, it removes them from the free storage pool so that the file system does not use them.  This feature does not affect any applications which use the normal HFS file system; the only expected impact of this feature is for those applications which perform disk reads fromor writes to the disk directly, like scavenger, recovery, and floppy disk utilities.</p><p>The new feature of the new Disk Initialization Package maps any bad blocksfound on any HFS volume.  This feature is valuable considering the number ofblocks that are on a 800K or 1440K floppy disk.  If a single block is bad, theprevious Disk Initialization Package would return an error and the system wouldreject the entire disk.  The new Disk Initialization Package may attempt to mapany bad block found on a non-Sony drive, but the probability is low that anewly formatted SCSI drive has a bad block.  If it were to have bad blockremaining after its low-level format, then there's something wrong with thedisk and it's most likely a hardware problem.  It is possible for a volume tohave encountered a bad block during normal use.  These can be mapped out bygoing to the Finder and choosing Erase Disk... from the Special menu, calling<code>_DIBadMount</code>, or calling <code>_DIZero</code>.  Calling <code>_DIFormat</code>or <code>_DIVerify</code> does not call upon the sparing algorithm.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>When a user chooses Erase Disk... from the Special menu, theFinder calls <code>_DIBadMount</code> with the error code in the <code>evtMessage</code> set to <code>noErr</code>.  This causes the sequence of Disk Initialize dialogs to appear.  Applications can call <code>_DIBadMount</code> to reformat a disk and ensure that bad blocks are spared.  This is further documented in the Disk Initialization Package chapter of <i>Inside Macintosh</i>, Volume VI.</P></TD></TR></TABLE></CENTER><BR><p>The sequence of events after calling <code>_DIBadMount</code> is as follows.<code>_DIBadMount</code> issues a call to the disk driver to perform the low-levelformat of the disk.  This is a <code>_Control</code> call with <code>csCode =formatCC</code>.  Once the driver returns its result, <code>_DIBadMount</code>attempts to verify the blocks on the disk.  This becomes a <code>_Control</code>call to the driver with <code>csCode = verifyCC</code>.  If the driver returns anerror, then <code>_DIBadMount</code> begins scanning the disk for bad blocks andmapping them out.  Afterwards, <code>a</code> directory is created and the volumeinformation is written to the disk.  This completes the process of<code>_DIBadMount</code>.</p><p>The Disk Initialization Package does not perform the low-level formatting thatis required by a SCSI device or any other non-Sony drive.  Generally SCSI drivers ignore these <code>csCode</code> values mentioned above and return <code>noErr</code>.  In returning <code>noErr</code>, <code>_DIBadMount </code>performs no bad block sparing.  Thus, it isn't likely that sparing is used by <code>_DIBadMount</code> on a non-Sony disk.  Such sparing is performed by the utility software supplied with the disk.  Issuing the SCSI <code>Format</code> command causes the drive controller to perform the low-level format and sparing of any bad blocks in hardware.  This is handled by the SCSI formatter softwareincluded with the hard disk product.  If any bad blocks are suspected on a SCSI device, it is recommended that users format the disk with the supplied SCSI utility.  Finally, <b>good</b> SCSI drivers map bad blocks dynamically so that any bad block encountered during normal use is removed.</p><p>If an application calls <code>_DIFormat</code> directly, the Disk InitializationPackages performs no bad block sparing.  If the disk does contain bad blocks,the disk cannot be used.  <code>_DIVerify</code> is used to verify if the diskcontains any bad blocks.  This disk may be used if these bad blocks are mappedout.  To do this, the application has to use either <code>_DIBadMount</code> or<code>_DIZero.</code></p><P><A HREF="#top">Back to top</A></P><a name="algorithm"></a><h2>The Algorithm</h2><p>Disks that are error-free are initialized exactly as before.  Only when thedriver's verify routine fails during <code>_DIBadMount</code> or if <code>_DIZero</code>encounters bad blocks is the sparing algorithm invoked. Sparing proceeds by making a second pass over the disk, writing and then reading back a test pattern. Testing is done a single track at a time, as a compromise between speed and wasted space.  (Since it is impossible to determine the geometry of a SCSI drive, all disks larger than the Floppy Disk High Density (FDHD) are tested at an assumed track size equal to the FDHD.)  If there areany errors or retries during a test, the sectors are deemed bad.</p><p>If more than 25% of the disk is found to contain bad blocks, if the I/O errorsappear to be due to hardware failure rather than media failure, or if certaincritical sectors are bad (see below), then the initialization fails as it wouldhave without sparing.  Otherwise, the blank HFS volume structure is written tothe disk.  Because the sectors touched during this operation are included inthe "critical" list, no changes to the code which initializes the logicalvolume structure are required.  After the volume structure has been written,the Disk Initialization Package:</p><ol type="1">	<li>Removes the bad spots from the volume bitmap of available free storage.</li>	<li>Creates file extent descriptors for the bad spots and inserts them into the volume extent B*-tree so that the free-space scavenging that takes place at volume mount and by Disk First Aid do not attempt to reintroduce the bad spots into the free storage pool.  A reserved file ID (5) is used for these extents.</li>	<li>Sets a flag (hexadecimal 0200) in the HFS volume header attributes to provide a canonic and simple way for applications to determine whether or not the disk has been spared.  The bad extents are described in the B*-tree with reserved file ID=5.</li>	<li>For 800K floppies only, the number of allocation blocks is reduced by one (from 1594 to 1593).  This change is done to prevent previous Finders from doing disk-to-disk copies physically (sector-by-sector), which would fail trying to copy the bad blocks.  The Finder does physical copies only on 1594 block disks as an optimized method of disk copying.</li></ol><p>The critical sectors (those that must be good even on a spared disk) includethe boot blocks, the HFS master directory and spare master directory, thevolume bitmap, and the initial extents for the two HFS B*-trees.  In practice,this means that the first 50 sectors and the second to the last sector of a1440K FDHD disk must be good.</p><p>As described later in this Note, the most error-prone region of a floppy diskseems to be the inner tracks on side one (the bottom side), which,unfortunately, is where HFS keeps the alternate copy of the Master DirectoryBlock (MDB).  The normal sparing logic rejects an entire track if any sector onit is bad, but to improve the algorithm's effectiveness, the algorithm has aspecial case for the alternate MDB.  Even if there is an error somewhere in thealternate MDB's track, the algorithm does not reject the disk if the sector itis on is useable.  This means that with <i>n </i>sectors per track, only about1/<i>n</i> of the disks with damaged inner tracks are rejected by the sparingalgorithm.  On FDHD disks <i>n</i>=18, so about 95% of the damaged disks can beinitialized, assuming only one sector on the track is bad.</p><h3>Experience Has Shown</h3><p>In the few weeks after the new Disk Initialization Package was written, Applehad the opportunity to test it against roughly one hundred disks (both 800K and1440K) that could not be formatted with the standard Disk InitializationPackage, or that had developed errors since being formatted.  Most of thesewere successfully spared using the new Disk Initialization Package.</p><p>Engineers noticed a trend in the small sample tested:  errors on both 800K and1440K disks are not uniformly distributed across the media.  By far the mostcommon place for errors to occur is on side one tracks 75-79, with the secondmost common place being tracks 0-3.  Interior errors seem to be rare.  Oneexplanation for the high proportion of errors on side one tracks 75-79 might bethat Apple now parks the heads over that area before ejecting a disk, so when adisk is inserted the heads come down there, possibly touching and scraping themedia.  Side one is probably more vulnerable both because the diameter of agiven track is smaller on that side and because the head faces up and thereforeeasily collects dust.</p><h3>The Compatibility Risks</h3><p>Applications that manipulate disks through the HFS documented routines (by farthe vast majority of applications) see no difference using spared disks. The only user-visible difference is that the Disk Initialization dialog box shows an additionalmessage ("Re-Verifying disk...") while sparing an imperfect disk, and a spared disk hasslightly less free space than an error-free disk. The identified risks associated withsparing are due to the following:</p><ol type="1">	<li>Applications that directly manipulate the HFS volume structure (in particular the extent B*-tree, volume bitmap, or the volume attributes field) need to be changed to respect the bad spot extents.  In particular, this includes disk utilities such as Disk First Aid, that repair and reorganize HFS volumes.  Note that these same applications also need to be revised to correctly handle System Software 7.0 aliases.  Apple has a version of Disk First Aid that supports both sparing and aliases, and it ships as part of System Software 7.0.</li>	<li> Applications that physically access disks, sector by sector, do not work if the disk contains a sector that has been spared.  The best, and possibly only, examples of this class of application are the disk duplicating utilities.</li></ol><P><A HREF="#top">Back to top</A></P><a name="Summary"></a><h2>Summary</h2><p>Unfortunately, the first and last tracks (the ones most likely to be bad) arealso the very tracks that are critical to the HFS layout and which, therefore,must be error-free.  As a result, the sparing algorithm is not as effective asit might be.  To minimize this problem in the future, Apple intends to changethe parking space to which the Sony drivers move the heads before ejecting adisk, this time from cylinder 79 to cylinder 40.  Cylinder 40 is probably aslightly better choice, as the media is more flexible at this point since it isfarther from the rigid metal hub, yet it is far enough away from the outer edgeto avoid the problems experiences with cylinder 0.  More importantly, though,cylinder 40 does not cover any sectors that are critical to HFS.</p><p>The decision not to create a directory entry for the bad spot file has bothadvantages and disadvantages.  The major advantage is that logical operations suchas directory enumerations and file-by-file disk copies are completely unaware of the bad spots.  Since Finder disk copies are file-by-file, this is important.  The major disadvantage is that Disk First Aid and other third-party disk utilities do need to be upgraded to recognize and avoid the bad spots, even though they are not part of a file.  The required changes, which are verysimple, have been incorporated into the System Software 7.0 version of Disk First Aid.</p><p>Another, completely independent way to deal with imperfect media is at thedriver and controller level.  If the driver reserved a few cylinders forre-vectoring bad tracks, it could present the appearance of error-free media toits clients, including HFS and the Disk Initialization Package.  Most, if notall, hard disk drives already do this.  This is a very attractive solution,because no changes to higher-level software are required since the traditionalMacintosh model of error-free media is preserved.  However, it is a much moredifficult task to modify the several existing floppy disk drivers (such as the6502-based IIfx driver) than it was to enhance the Disk Initialization Package.Also, there are major compatibility problems involved with driver-levelsolutions since old drivers would not be able to correctly handle revectoredtracks.  Fortunately, this is not an mutually-exclusive decision:  the diskinitialization algorithm described here does not prevent later improvements tothe drivers.</p><p>It should be noted that sparing in Disk Initialization Package does not addressproblems that occur after a disk has been formatted.  This class of dynamic errors is much harder to deal with, since neither the Macintosh OS file system nor its clients are set up to handle such I/O errors gracefully, if at all.  On the otherhand, many operating systems apparently spare only during initial formatting.Media errors encountered during an I/O operation are handled by the driver code.</p><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><p><i>Inside Macintosh</i>, Volume II, Disk Initialization Package</p><p>MPW SonyEqu.a interface files</p><P><A HREF="#top">Back to top</A></P><P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (56K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/fl_32.pdf">Download</A></P>               </TD>            </TR></table><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/fl/fl_32.html%3Fid%3DDTS10002458-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/fl/fl_32.html%3Fid%3DDTS10002458-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/fl/fl_32.html%3Fid%3DDTS10002458-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --><hr width=500 align=center></BODY></HTML>