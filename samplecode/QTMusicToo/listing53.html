<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>QTMusicToo - /&bull;QTMusic Sample Sequencer/SequencerTest Realtime.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/QuickTime/index.html">QuickTime</a> &gt; <a href="../../samplecode/QuickTime/idxMusicAudio-date.html">Audio</a> &gt; <A HREF="javascript:location.replace('index.html');">QTMusicToo</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Not Recommended Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>The information in this document is <strong>Not Recommended</strong> and should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/QuickTime/idxMusicAudio-date.html" target="_blank">QuickTime > Audio</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">QTMusicToo</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/&bull;QTMusic Sample Sequencer/SequencerTest Realtime.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/BigEasy/BigEasy2.c</option>
<option value="listing2.html">/BigEasy/BigEasy2.h</option>
<option value="listing3.html">/BigEasy/BigEasyControls.c</option>
<option value="listing4.html">/BigEasy/BigEasyControls.h</option>
<option value="listing5.html">/BigEasy/BigEasyDialogs.c</option>
<option value="listing6.html">/BigEasy/BigEasyDialogs.h</option>
<option value="listing7.html">/BigEasy/BigEasyGestalt.c</option>
<option value="listing8.html">/BigEasy/BigEasyGestalt.h</option>
<option value="listing9.html">/BigEasy/BigEasyGrafish.c</option>
<option value="listing10.html">/BigEasy/BigEasyGrafish.h</option>
<option value="listing11.html">/BigEasy/BigEasyPPC.c</option>
<option value="listing12.html">/BigEasy/BigEasyPPC.h</option>
<option value="listing13.html">/BigEasy/BigEasyStandardControls.c</option>
<option value="listing14.html">/BigEasy/BigEasyStandardControls.h</option>
<option value="listing15.html">/BigEasy/BigEasyTextish.c</option>
<option value="listing16.html">/BigEasy/BigEasyTextish.h</option>
<option value="listing17.html">/BigEasy/BigEasyUtils.c</option>
<option value="listing18.html">/BigEasy/BigEasyUtils.h</option>
<option value="listing19.html">/BigEasy/IconUtilsPriv.h</option>
<option value="listing20.html">/BigEasy/NWindows.c</option>
<option value="listing21.html">/BigEasy/OneWindow.c</option>
<option value="listing22.html">/•Instrument Editor/All The MIDI Components.h</option>
<option value="listing23.html">/•Instrument Editor/IE KeyboardDiagram.c</option>
<option value="listing24.html">/•Instrument Editor/IE KeyboardDiagram.h</option>
<option value="listing25.html">/•Instrument Editor/IE PrintUtilities.c</option>
<option value="listing26.html">/•Instrument Editor/IE PrintUtilities.h</option>
<option value="listing27.html">/•Instrument Editor/Instrument Editor Controls.c</option>
<option value="listing28.html">/•Instrument Editor/Instrument Editor Controls.h</option>
<option value="listing29.html">/•Instrument Editor/Instrument Editor Draw.c</option>
<option value="listing30.html">/•Instrument Editor/Instrument Editor Filing.c</option>
<option value="listing31.html">/•Instrument Editor/Instrument Editor Filing.h</option>
<option value="listing32.html">/•Instrument Editor/Instrument Editor Menus.c</option>
<option value="listing33.html">/•Instrument Editor/Instrument Editor Menus.h</option>
<option value="listing34.html">/•Instrument Editor/Instrument Editor.c</option>
<option value="listing35.html">/•Instrument Editor/Instrument Editor.h</option>
<option value="listing36.html">/•Instrument Editor/Instrument Editor.r</option>
<option value="listing37.html">/•Instrument Editor/Instrument Tests.c</option>
<option value="listing38.html">/•Instrument Editor/More IE Routines.c</option>
<option value="listing39.html">/•Instrument Editor/More IE Routines.h</option>
<option value="listing40.html">/•Instrument Picker Test/InstrumentPickerTest.c</option>
<option value="listing41.html">/•QTMusic Sample Keyboards/EasyKeyboardDiagram.c</option>
<option value="listing42.html">/•QTMusic Sample Keyboards/EasyKeyboardDiagram.h</option>
<option value="listing43.html">/•QTMusic Sample Keyboards/EasyKeyboardDiagram.r</option>
<option value="listing44.html">/•QTMusic Sample Keyboards/QTMusic Sample Keyboards.c</option>
<option value="listing45.html">/•QTMusic Sample Keyboards/QTMusic Sample Keyboards.r</option>
<option value="listing46.html">/•QTMusic Sample Sequencer/Event Priority Queue.c</option>
<option value="listing47.html">/•QTMusic Sample Sequencer/Event Priority Queue.h</option>
<option value="listing48.html">/•QTMusic Sample Sequencer/Sequencer Test Movies.c</option>
<option value="listing49.html">/•QTMusic Sample Sequencer/Sequencer Test Movies.h</option>
<option value="listing50.html">/•QTMusic Sample Sequencer/SequencerTest Filing.c</option>
<option value="listing51.html">/•QTMusic Sample Sequencer/SequencerTest Filing.h</option>
<option value="listing52.html">/•QTMusic Sample Sequencer/SequencerTest Movies.h</option>
<option value="listing53.html">/•QTMusic Sample Sequencer/SequencerTest Realtime.c</option>
<option value="listing54.html">/•QTMusic Sample Sequencer/SequencerTest Realtime.h</option>
<option value="listing55.html">/•QTMusic Sample Sequencer/SequencerTest.c</option>
<option value="listing56.html">/•QTMusic Sample Sequencer/SequencerTest.h</option></select>
				</p>
				</form>
				<p><strong><a href="QTMusicToo.zip">Download Sample</a></strong> (&#147;QTMusicToo.zip&#148;, 115.5K)<BR>
<strong><a href="QTMusicToo.dmg">Download Sample</a></strong> (&#147;QTMusicToo.dmg&#148;, 173.6K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/* * file: SequencerTest Realtime.c * * */  /*--------------------------  Inclusions--------------------------*/#include &lt;QuickDraw.h&gt;#include &lt;Windows.h&gt;#include &lt;Memory.h&gt;#include &lt;Packages.h&gt;#include &quot;BigEasy2.h&quot;#include &quot;BigEasyTextish.h&quot;#include &quot;BigEasyGrafish.h&quot;#include &quot;BigEasyDialogs.h&quot;#include &quot;SequencerTest.h&quot;#include &quot;SequencerTest Realtime.h&quot;#include &quot;Event Priority Queue.h&quot;/*--------------------------  Local Prototypes--------------------------*/static void DelayXUnits(long x, long units);static short GetPipDuration(ScorePart *sp,short x,short y);static void PrerollDoc(TDoc *d);/*--------------------------  The Bronx Zoo--------------------------*/void PlayScorePartBeat(ScorePart *sp, NoteChannel nc, short beat)  {  unsigned long thisMask,lastMask;  short thisElementH,lastElementH;  short elementV;  Boolean thisPip,lastPip;  ComponentResult thisError;  thisMask = 1L &lt;&lt; (beat &amp; 31);  thisElementH = beat / 32;  lastMask = 1L &lt;&lt; (( (beat + kScoreLength - 1) % kScoreLength) &amp; 31);  lastElementH = ( (beat + kScoreLength - 1) % kScoreLength) / 32;  for(elementV = 0; elementV &lt; kScoreHeight; elementV++)    {    if(beat == kScoreLength)      thisPip = 0;    else      thisPip = 0 != (sp-&gt;score[elementV][thisElementH] &amp; thisMask);    if(beat == 0)      lastPip = 0;    else      lastPip = 0 != (sp-&gt;score[elementV][lastElementH] &amp; lastMask);    if(thisPip &amp;&amp; !lastPip)      {      thisError = NAPlayNote(g.na,nc,kNoteRangeHigh - elementV, 64);      ShowError(thisError);      }    else if(lastPip &amp;&amp; !thisPip)      {      thisError = NAPlayNote(g.na,nc,kNoteRangeHigh - elementV, 0);      ShowError(thisError);      }    }  }void PrerollDoc(TDoc *d)  {  short j;  ComponentResult thisError;#ifdef separateNoteChannel  for(j = 0; j&lt;kScoreParts; j++)    {    thisError = NAPrerollNoteChannel(g.na,d-&gt;noteChannel[j]);    ShowError(thisError);    }#endif  thisError = TunePreroll(d-&gt;tp);  ShowError(thisError);  }void PlayDocOnce(TDoc *d)  {  short beat,j;  long dummy;  Boolean oldEngage,newEngage;  ComponentResult thisError;  PrerollDoc(d);  oldEngage = true;  for(beat = 0; beat &lt; kScoreLength; beat ++)    {    newEngage = !Button();    if(newEngage != oldEngage)      {      if(newEngage)        for(j = 0; j &lt; kScoreParts; j++)          {          thisError = NAEngageNoteChannel(g.na,d-&gt;noteChannel[j]);          ShowError(thisError);          }      else        for(j = 0; j &lt; kScoreParts; j++)          {          thisError = NADisengageNoteChannel(g.na,d-&gt;noteChannel[j],true);          ShowError(thisError);          }      oldEngage = newEngage;      }    for(j = 0; j&lt;kScoreParts; j++)      PlayScorePartBeat(&amp;d-&gt;sr.score[j],d-&gt;noteChannel[j],beat);    Delay(6,&amp;dummy);    }  for(j = 0; j&lt;kScoreParts; j++)    PlayScorePartBeat(&amp;d-&gt;sr.score[j],d-&gt;noteChannel[j],kScoreLength);  for(j = 0; j &lt; kScoreParts; j++)    {    thisError = NAEngageNoteChannel(g.na,d-&gt;noteChannel[j]);    ShowError(thisError);    }  }short GetPipDuration(ScorePart *sp,short x,short y)  {  short d;  d = x;  while(x &lt; kScoreLength &amp;&amp; GetPipBit(sp,x,y))    x++;  d = x - d;  return d;  }void ScoreToQTScore(TDoc *d)  {  long i,x,y;  ScorePart *sp;  short lastGoodX;  long duration;  long time;  long deltaTime;  long *w;  long timeScalar;  timeScalar = 1;  if(d-&gt;qtScore)    DisposeHandle(d-&gt;qtScore);  d-&gt;qtScore = NewHandle(40000);  HLock(d-&gt;qtScore);  w = (void *)*d-&gt;qtScore;  lastGoodX = 0;  for(x = 0; x &lt; kScoreLength; x++)    {    for (i = 0; i &lt; kScoreParts; i++)      {      sp = &amp;d-&gt;sr.score[i];      for (y = 0; y &lt; kScoreHeight; y++)        {        if(GetPipBit(sp,x,y)            &amp;&amp; (x == 0 || !GetPipBit(sp,x-1,y)))          {          if(x &gt; lastGoodX)          /* emit rest if necessary */            {            duration = timeScalar * (x - lastGoodX);            *w++ = duration;            lastGoodX = x;            }          /*           * emit note event           */          duration = timeScalar * GetPipDuration(sp,x,y);          *w++ = 0x20000000 | (i &lt;&lt; 24)              | ((kNoteRangeHigh - y - 32) &lt;&lt; 18)              | (90L &lt;&lt; 11)              | duration;          }        }      }    }  duration = timeScalar * (kScoreLength - lastGoodX);  if(duration)    *w++ = duration;    *w++ = 0x60000000;  *w++ = -1;  SetHandleSize(d-&gt;qtScore,((char *)w) - ((char *)*d-&gt;qtScore));  d-&gt;validQTScore = true;  }void DelayXUnits(long x, long units)  {  long dummy;  if(x &lt; 0)    Debugger();  Delay(x * 60 / units, &amp; dummy);  }typedef enum  {  qNoteOff,  qSleep  } qCommand;  void PlayQTScore(TDoc *d)  {  Handle qtScore;  long *qtScorePtr;  long *w;  unsigned short command;  unsigned long op1,op2,op3,op4;  EPQ *q;  EPQEvent e;  long timeNow;  long nextDelay;  ComponentResult thisError;  unsigned short instrument,pitch,velocity;  long duration;  short controller,value;  PrerollDoc(d);  if(!d-&gt;validQTScore)    ScoreToQTScore(d);  qtScore = d-&gt;qtScore;  HLock(qtScore);  qtScorePtr = (void *)*qtScore;  q = NewEPQ(2000);  w = qtScorePtr;  timeNow = 0;  while(1)    {    op1 = *w++;    if(op1 == 0xFFFFffff)      goto done;    command = op1&gt;&gt;29;    if(command == 0)        /* rest */      {      e.time = timeNow + op1;      e.data1 = qSleep;      AddEventEPQ(q,&amp;e);      do        {        ExtractEventEPQ(q,&amp;e);        if(e.time != timeNow)          DelayXUnits(e.time - timeNow,600);        timeNow = e.time;        if(e.data1 == qNoteOff)          {          thisError = NAPlayNote(g.na,d-&gt;noteChannel[e.data2],e.data3,0);          ShowError(thisError);          }        } while(GetSizeEPQ(q) &amp;&amp; e.data1 != qSleep);      while(GetSizeEPQ(q) != 0 &amp;&amp; PeekTopEPQ(q) == timeNow)        {        ExtractEventEPQ(q,&amp;e);        if(e.data1 == qNoteOff)          {          thisError = NAPlayNote(g.na,d-&gt;noteChannel[e.data2],e.data3,0);          ShowError(thisError);          }        };      }    else if (command == 1)      {      instrument = (op1 &gt;&gt; 24) &amp; 31;      pitch = ((op1 &gt;&gt; 18) &amp; 63) + 32;      velocity = (op1&gt;&gt;11) &amp; 127;      duration = op1 &amp; 0x03FF;      thisError = NAPlayNote(g.na,d-&gt;noteChannel[instrument],pitch,velocity);      ShowError(thisError);      e.time = timeNow + duration;      e.data1 = qNoteOff;      e.data2 = instrument;      e.data3 = pitch;      AddEventEPQ(q,&amp;e);      }    }done:  DisposeEPQ(q);  }</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/QTMusicToo/listing53.html%3Fid%3DDTS10000915-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/QTMusicToo/listing53.html%3Fid%3DDTS10000915-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/QTMusicToo/listing53.html%3Fid%3DDTS10000915-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>