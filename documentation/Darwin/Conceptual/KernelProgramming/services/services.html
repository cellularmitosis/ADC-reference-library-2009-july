<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Kernel Programming Guide: Miscellaneous Kernel Services</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Miscellaneous Kernel Services"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30000905-CH219" title="Miscellaneous Kernel Services"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000422" target="_top">Darwin</a> &gt; <a href="../../../Kernel-date.html#//apple_ref/doc/uid/TP30000440-TP30000422-TP30000532" target="_top">Kernel</a> &gt; <a href="../About/About.html#//apple_ref/doc/uid/TP30000905-CH204-TPXREF101">Kernel Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../synchronization/synchronization.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../Extend/Extend.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30000905-CH219-BEHJDFCA" title="Miscellaneous Kernel Services"></a><h1>Miscellaneous Kernel Services</h1><p>This chapter contains information about miscellaneous services provided by the Mac OS X kernel. For most projects, you will probably never need to use most of these services, but if you do, you will find it hard to do without them.</p>
<p>This chapter contains these sections: <span class="content_text"><a href="services.html#//apple_ref/doc/uid/TP30000905-CH219-CHDJBFEF">“Using Kernel Time Abstractions ,”</a></span> <span class="content_text"><a href="services.html#//apple_ref/doc/uid/TP30000905-CH219-CHDCEBBJ">“Boot Option Handling,”</a></span> <span class="content_text"><a href="services.html#//apple_ref/doc/uid/TP30000905-CH219-CHDJHGEF">“Queues,”</a></span> and <span class="content_text"><a href="services.html#//apple_ref/doc/uid/TP30000905-CH219-CHDIDIDF">“Installing Shutdown Hooks.”</a></span></p>

<a name="//apple_ref/doc/uid/TP30000905-CH219-CHDJBFEF" title="Using Kernel Time Abstractions "></a><h2>Using Kernel Time Abstractions </h2><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_775"></a>
<p>There are two basic groups of time abstractions in the kernel. One group includes functions that provide delays and timed wake-ups. The other group includes functions and variables that provide the current wall clock time, the time used by a given process, and other similar information. This section describes both aspects of time from the perspective of the kernel.</p>
<a name="//apple_ref/doc/uid/TP30000905-CH219-TPXREF108" title="Obtaining Time Information"></a><h3>Obtaining Time Information</h3>
<p>There are a number of ways to get basic time information from within the kernel. The officially approved methods are those that Mach exports in <code><!--a-->kern/clock.h<!--/a--></code>. These include the following:<a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_776"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_777"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_778"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_779"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_780"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_781"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_782"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_783"></a></p>
<div class="codesample"><table><tr><td scope="row"><pre>void clock_get_uptime(uint64_t *result);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>void clock_get_system_microtime(            uint32_t *secs,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            uint32_t *microsecs);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>void clock_get_system_nanotime(             uint32_t *secs,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            uint32_t *nanosecs);<span></span></pre></td></tr><tr><td scope="row"><pre>void clock_get_calendar_microtime(          uint32_t *secs,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            uint32_t *microsecs);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>void clock_get_calendar_nanotime(           uint32_t *secs,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            uint32_t *nanosecs);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr></table></div>
<p>The function <a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_784"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_785"></a><code><!--a-->clock_get_uptime<!--/a--></code> returns a value in <code>AbsoluteTime</code> units. For more information on using <code>AbsoluteTime</code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_786"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_787"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_788"></a>, see <span class="content_text"><a href="services.html#//apple_ref/doc/uid/TP30000905-CH219-CHDGFEFE">“Using Mach Absolute Time Functions.”</a></span></p>
<p>The functions <code><!--a-->clock_get_system_microtime<!--/a--></code> and <code><!--a-->clock_get_system_nanotime<!--/a--></code> return 32-bit integers containing seconds and microseconds or nanoseconds, respectively, representing the system uptime.</p>
<p>The functions <code><!--a-->clock_get_calendar_microtime<!--/a--></code> and <code><!--a-->clock_get_calendar_nanotime<!--/a--></code> return 32-bit integers containing seconds and microseconds or nanoseconds, respectively, representing the current calendar date and time since the epoch (January 1, 1970).</p>
<p>In some parts of the kernel, you may find other functions that return type <code>mach_timespec_t</code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_789"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_790"></a>. This type is similar to the traditional BSD <code>struct timespec</code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_791"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_792"></a>, except that fractions of a second are measured in nanoseconds instead of microseconds:</p>
<div class="codesample"><table><tr><td scope="row"><pre>struct mach_timespec {<span></span></pre></td></tr><tr><td scope="row"><pre>    unsigned int tv_sec;<span></span></pre></td></tr><tr><td scope="row"><pre>    clock_res_t tv_nsec;<span></span></pre></td></tr><tr><td scope="row"><pre>};<span></span></pre></td></tr><tr><td scope="row"><pre>typedef struct mach_timespec *mach_timespec_t;<span></span></pre></td></tr></table></div>
<p></p>
<p>In addition to the traditional Mach functions, if you are writing code in BSD portions of the kernel you can also get the current calendar (wall clock) time as a BSD <code>timeval</code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_793"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_794"></a>, as well as find out the calendar time when the system was booted by doing the following:</p>
<div class="codesample"><table><tr><td scope="row"><pre>#include &lt;sys/kernel.h><span></span></pre></td></tr><tr><td scope="row"><pre>struct timeval tv=time; /* calendar time */<span></span></pre></td></tr><tr><td scope="row"><pre>struct timeval tv_boot=boottime; /* calendar time when booting occurred  */<span></span></pre></td></tr></table></div>
<p>For other information, you should use the Mach functions listed previously.</p>
<a name="//apple_ref/doc/uid/TP30000905-CH219-TPXREF109" title="Event and Timer Waits"></a><h3>Event and Timer Waits</h3>
<p>Each part of the Mac OS X kernel has a distinct API for waiting a certain period of time. In most cases, you can call these functions from other parts of the kernel. The I/O Kit provides <code><!--a-->IODelay<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_795"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_796"></a> and <code><!--a-->IOSleep<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_797"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_798"></a>. Mach provides functions based on <code><!--a-->AbsoluteTime<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_799"></a>, as well as a few based on microseconds. BSD provides <code><!--a-->msleep<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_800"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_801"></a>.</p>
<a name="//apple_ref/doc/uid/TP30000905-CH219-TPXREF110" title="Using IODelay and  IOSleep"></a><h4>Using <code>IODelay</code> and  <code>IOSleep</code></h4>
<p><code><!--a-->IODelay<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_802"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_803"></a>, provided by the I/O Kit, abstracts a timed spin. If you are delaying for a short period of time, and if you need to be guaranteed that your wait will not be stopped prematurely by delivery of asynchronous events, this is probably the best choice. If you need to delay for several seconds, however, this is a bad choice, because the CPU that executes the wait will spin until the time has elapsed, unable to handle any other processing.</p>
<p><code><!--a-->IOSleep<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_804"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_805"></a> puts the currently executing thread to sleep for a certain period of time. There is no guarantee that your thread will execute after that period of time, nor is there a guarantee that your thread will not be awakened by some other event before the time has expired. It is roughly equivalent to the <code><!--a-->sleep<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_806"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_807"></a> call from user space in this regard.</p>
<p>The use of <code><!--a-->IODelay<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_808"></a> and <code><!--a-->IOSleep<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_809"></a> are straightforward. Their prototypes are:</p>
<div class="codesample"><table><tr><td scope="row"><pre>IODelay(unsigned microseconds);<span></span></pre></td></tr><tr><td scope="row"><pre>IOSleep(unsigned milliseconds);<span></span></pre></td></tr></table></div>
<p>Note the differing units. It is not practical to put a thread to sleep for periods measured in microseconds, and spinning for several milliseconds is also inappropriate.</p>
<a name="//apple_ref/doc/uid/TP30000905-CH219-CHDGFEFE" title="Using Mach Absolute Time Functions"></a><h4>Using Mach Absolute Time Functions</h4>
<p>The following Mach time functions are commonly used. Several others are described in <code>osfmk/kern/clock.h</code>.<a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_810"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_811"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_812"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_813"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_814"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_815"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_816"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_817"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_818"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_819"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_820"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_821"></a></p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000905-CH219-SW1" title="Note"></a><p><strong>Note:</strong>&nbsp;These are <code>not</code> the same functions as those listed in <code>kern/clock.h</code> in the Kernel framework. These functions are not exposed to kernel extensions, and are only for use within the kernel itself.</p></div>
<div class="codesample"><table><tr><td scope="row"><pre>void delay(uint64_t microseconds);<span></span></pre></td></tr><tr><td scope="row"><pre>void clock_delay_until(uint64_t deadline);<span></span></pre></td></tr><tr><td scope="row"><pre>void clock_absolutetime_interval_to_deadline(uint64_t abstime,<span></span></pre></td></tr><tr><td scope="row"><pre>            uint64_t *result);<span></span></pre></td></tr><tr><td scope="row"><pre>void nanoseconds_to_absolutetime(uint64_t nanoseconds, uint64_t  *result);<span></span></pre></td></tr><tr><td scope="row"><pre>void absolutetime_to_nanoseconds(uint64_t abstime, uint64_t *result);<span></span></pre></td></tr></table></div>
<p>These functions are generally straightforward. However, a few points deserve explanation. Unless specifically stated, all times, deadlines, and so on, are measured in <code>abstime</code> units. The <code>abstime</code> unit is equal to the length of one bus cycle, so the duration is dependent on the bus speed of the computer. For this reason, Mach provides conversion routines between <code>abstime</code> units and nanoseconds.</p>
<p>Many time functions, however, provide time in seconds with nanosecond remainder. In this case, some conversion is necessary. For example, to obtain the current time as a mach abstime value, you might do the following:</p>
<div class="codesample"><table><tr><td scope="row"><pre>uint32_t secpart;<span></span></pre></td></tr><tr><td scope="row"><pre>uint32_t nsecpart;<span></span></pre></td></tr><tr><td scope="row"><pre>uint64_t nsec, abstime;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>clock_get_calendar_nanotime(&amp;secpart, &amp;nsecpart);<span></span></pre></td></tr><tr><td scope="row"><pre>nsec = nsecpart + (1000000000ULL * secpart); //convert seconds to  nanoseconds.<span></span></pre></td></tr><tr><td scope="row"><pre>nanoseconds_to_absolutetime(nsec, &amp;abstime);<span></span></pre></td></tr></table></div>
<p>The abstime value is now stored in the variable <code>abstime</code>.</p>
<a name="//apple_ref/doc/uid/TP30000905-CH219-CHDFIGGH" title="Using msleep"></a><h4>Using <code>msleep</code></h4>
<p>In addition to Mach and I/O Kit routines, BSD provides <code><!--a-->msleep<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_822"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_823"></a>, which is the recommended way to delay in the BSD portions of the kernel. In other parts of the kernel, you should either use <code><!--a-->wait_queue<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_824"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_825"></a> functions or use <code><!--a-->assert_wait<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_826"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_827"></a> and <code><!--a-->thread_wakeup<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_828"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_829"></a> functions, both of which are closely tied to the Mach scheduler, and are described in <span class="content_text"><a href="../scheduler/scheduler.html#//apple_ref/doc/uid/TP30000905-CH211-BABBEEBI">“Kernel Thread APIs.”</a></span></p>
<p>The <code><!--a-->msleep<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_830"></a> call is similar to a condition variable. It puts a thread to sleep until <code><!--a-->wakeup<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_831"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_832"></a> or <code><!--a-->wakeup_one<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_833"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_834"></a> is called on that channel. Unlike a condition variable, however, you can set a timeout measured in clock ticks. This means that it is both a synchronization call and a delay. The prototypes follow:<a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_835"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_836"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_837"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_838"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_839"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_840"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_841"></a></p>
<div class="codesample"><table><tr><td scope="row"><pre>msleep(void *channel, lck_mtx_t *mtx, int priority, const char *wmesg,  struct  timespec *timeout);<span></span></pre></td></tr><tr><td scope="row"><pre>msleep0(vvoid *channel, lck_mtx_t *mtx, int priority, const char  *wmesg, uint64_t  deadline);<span></span></pre></td></tr><tr><td scope="row"><pre>wakeup(void *channel);<span></span></pre></td></tr><tr><td scope="row"><pre>wakeup_one(void *channel);<span></span></pre></td></tr></table></div>
<p>The three sleep calls are similar except in the mechanism used for timeouts. The function <code>msleep0</code> is not recommended for general use.</p>
<p>In these functions, <code>channel</code> is a unique identifier representing a single condition upon which you are waiting. Normally, when <code><!--a-->msleep<!--/a--></code> is used, you are waiting for a change to occur in a data structure. In such cases, it is common to use the address of that data structure as the value for <code>channel</code>, as this ensures that no code elsewhere in the system will be using the same value.</p>
<p>The <code>priority</code> argument has two effects. First, when <code><!--a-->wakeup<!--/a--></code> is called, threads are inserted in the scheduling queue at this priority. Second, the value of <code>priority</code> modifies signal delivery behavior. If the value of <code>priority</code> is negative, signal delivery cannot wake the thread early. If the bit <code>(priority &amp; PCATCH<a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_842"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_843"></a>)</code> is set, <code><!--a-->msleep0<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_844"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_845"></a> does not call the continuation function upon waking up from sleep and returns a value of 1.</p>
<p>The <code>subsystem</code> argument is a short text string that represents the subsystem that is waiting on this channel. This is used solely for debugging purposes.</p>
<p>The <code>timeout</code> argument is used to set a maximum wait time. The thread may wake sooner, however, if <code>wakeup</code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_846"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_847"></a> or <code>wakeup_one</code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_848"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_849"></a> is called on the appropriate channel. It may also wake sooner if a signal is received, depending on the value of <code>priority</code>. In the case of <code><!--a-->msleep0<!--/a--></code>, this is given as a mach abstime deadline. In the case of <code><!--a-->msleep<!--/a--></code>, this is given in relative time (seconds and nanoseconds).</p><a name="//apple_ref/doc/uid/TP30000905-CH219-SW2" title="Handling Version Dependencies"></a><h3>Handling Version Dependencies</h3><p>Many time-related functions such as <code>clock_get_uptime</code> changed as a result of the transition to KPIs in Mac OS X v.10.4. While these changes result in a cleaner interface, this can prove challenging if you need to make a kernel extension that needs to obtain time information across multiple versions of Mac OS X in a kernel extension that would otherwise have no version dependencies (such as an I/O Kit KEXT).</p><p>Here is a list of time-related functions that are available in both pre-KPI and KPI versions of Mac OS X:</p><dl class="termdef">	<dt><code>uint64_t mach_absolute_time(void);</code></dt><dd><p><strong>Declared In: </strong> <code>&lt;mach/mach_time.h></code></p><p><strong>Dependency: </strong> <code>com.apple.kernel.mach</code></p><p>This function returns a Mach absolute time value for the current wall clock time in units of <code>uint64_t</code>.</p></dd><dt><code>void microtime(struct timeval *tv);</code></dt><dd><p><strong>Declared In: </strong> <code>&lt;sys/time.h></code></p><p><strong>Dependency: </strong> <code>com.apple.kernel.bsd</code></p><p>This function returns a timeval struct containing the current wall clock time.</p></dd><dt><code>void microuptime(struct timeval *tv);</code></dt><dd><p><strong>Declared In: </strong> <code>&lt;sys/time.h></code></p><p><strong>Dependency: </strong> <code>com.apple.kernel.bsd</code></p><p>This function returns a timeval struct containing the current uptime.</p></dd><dt><code>void nanotime(struct timespec *ts);</code></dt><dd><p><strong>Declared In: </strong> <code>&lt;sys/time.h></code></p><p><strong>Dependency: </strong> <code>com.apple.kernel.bsd</code></p><p>This function returns a timespec struct containing the current wall clock time.</p></dd><dt><code>void nanouptime(struct timespec *ts);</code></dt><dd><p><strong>Declared In: </strong>  <code>&lt;sys/time.h></code></p><p><strong>Dependency: </strong> <code>com.apple.kernel.bsd</code></p><p>This function returns a timespec struct containing the current uptime.</p></dd></dl><div class="notebox"><a name="//apple_ref/doc/uid/TP30000905-CH219-SW3" title="Note"></a><p><strong>Note:</strong>&nbsp;The structure declarations for <code>struct timeval</code> and <code>struct timespec</code> differ between 10.3 and 10.4 in their use of <code>int</code>, <code>int32_t</code>, and <code>long</code> data types. However, because the structure packing for the underlying data types is identical in the 32-bit world, these structures are assignment compatible.</p></div><p>In addition to these APIs, the functionality marked <code>__APPLE_API_UNSTABLE</code> in <code>&lt;mach/time_value.h></code> was adopted as-is in Mac OS X v.10.4 and is no longer marked unstable.</p>
<a name="//apple_ref/doc/uid/TP30000905-CH219-CHDCEBBJ" title="Boot Option Handling"></a><h2>Boot Option Handling</h2><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_850"></a>
<p>Mac OS X provides a simple parse routine, <code><!--a-->PE_parse_boot_arg<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_851"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_852"></a>, for basic boot argument passing. It supports both flags and numerical value assignment. For obtaining values, you write code similar to the following:</p>
<div class="codesample"><table><tr><td scope="row"><pre>unsigned int argval;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>if (PE_parse_boot_arg("argflag", &amp;argval)) {<span></span></pre></td></tr><tr><td scope="row"><pre>    /* check for reasonable value */<span></span></pre></td></tr><tr><td scope="row"><pre>    if (argval &lt; 10 || argval > 37)<span></span></pre></td></tr><tr><td scope="row"><pre>        argval = 37;<span></span></pre></td></tr><tr><td scope="row"><pre>} else {<span></span></pre></td></tr><tr><td scope="row"><pre>    /* use default value */<span></span></pre></td></tr><tr><td scope="row"><pre>    argval = 37;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>
<p>Since <code><!--a-->PE_parse_boot_arg<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_853"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_854"></a> returns a nonzero value if the flag exists, you can check for the presence of a flag by using a flag that starts with a dash (-) and ignoring the value stored in <code>argvalue</code>.</p>
<p>The <code><!--a-->PE_parse_boot_arg<!--/a--></code> function can also be used to get a string argument. To do this, you must pass in the address of an array of type <code>char</code> as the second argument. The behavior of <code><!--a-->PE_parse_boot_arg<!--/a--></code> is undefined if a string is passed in for a numeric variable or vice versa. Its behavior is also undefined if a string exceeds the storage space allocated. Be sure to allow enough space for the largest reasonable string including a null delimiter. No attempt is made at bounds checking, since an overflow is generally a fatal error and should reasonably prevent booting.</p>
<a name="//apple_ref/doc/uid/TP30000905-CH219-CHDJHGEF" title="Queues"></a><h2>Queues</h2><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_855"></a>
<p>As part of its BSD infrastructure, the Mac OS X kernel provides a number of basic support macros to simplify handling of linked lists and queues. These are implemented as C macros, and assume a standard C <code>struct</code>. As such, they are probably not suited for writing code in C++.</p>
<p>The basic types of lists and queues included are</p>
<ul class="ul"><li class="li"><p><code>SLIST</code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_856"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_857"></a>, a singly linked list</p></li>
<li class="li"><p><code>STAILQ</code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_858"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_859"></a>, a singly linked tail queue</p></li>
<li class="li"><p><code>LIST</code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_860"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_861"></a>, a doubly linked list</p></li>
<li class="li"><p><code>TAILQ</code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_862"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_863"></a>, a doubly linked tail queue</p></li></ul>
<p><code>SLIST</code> is ideal for creating stacks or for handling large sets of data with few or no removals. Arbitrary removal, however, requires an <code>O(n)</code> traversal of the list.</p>
<p><code>STAILQ</code> is similar to <code>SLIST</code> except that it maintains pointers to both ends of the queue. This makes it ideal for simple FIFO queues by adding entries at the tail and fetching entries from the head. Like <code>SLIST</code>, it is inefficient to remove arbitrary elements.</p>
<p><code>LIST</code> is a doubly linked version of <code>SLIST</code>. The extra pointers require additional space, but allow <code>O(1)</code> (constant time) removal of arbitrary elements and bidirectional traversal.</p>
<p><code>TAILQ</code> is a doubly linked version of <code>STAILQ</code>. Like <code>LIST</code>, the extra pointers require additional space, but allow <code>O(1)</code> (constant time) removal of arbitrary elements and bidirectional traversal.</p>
<p>Because their functionality is relatively simple, their use is equally straightforward. These macros can be found in <code>xnu/bsd/sys/queue.h</code>.</p>
<a name="//apple_ref/doc/uid/TP30000905-CH219-CHDIDIDF" title="Installing Shutdown Hooks"></a><h2>Installing Shutdown Hooks</h2><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_864"></a>
<p>Although Mac OS X does not have traditional BSD-style shutdown hooks, the I/O Kit provides equivalent functionality in recent versions. Since the I/O Kit provides this functionality, you must call it from C++ code.</p>
<p>To register for notification, you call <code><!--a-->registerSleepWakeInterest<!--/a--></code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_865"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_866"></a> (described in <code>IOKit/RootDomain.h</code>) and register for sleep notification. If the system is about to be shut down, your handler is called with the message type <code><!--a  -->kIOMessageSystemWillPowerOff<!--/a--></code>. If the system is about to reboot, your handler gets the message type <code><!--a  -->kIOMessageSystemWillRestart<!--/a--></code>. If the system is about to reboot, your handler gets the message type <code>kIOMessageSystemWillSleep</code>.</p>
<p>If you no longer need to receive notification (for example, if your KEXT gets unloaded), be certain to release the notifier with <code>IONofitier::release</code><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_867"></a><a name="//apple_ref/doc/uid/TP30000905-CH219-DontLinkElementID_868"></a> to avoid a kernel panic on shutdown.</p><p>For example, the following sample KEXT registers for sleep notifications, then logs a message with IOLog when a sleep notification occurs:</p><div class="codesample"><table><tr><td scope="row"><pre>#include &lt;IOKit/IOLib.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;IOKit/pwr_mgt/RootDomain.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;IOKit/pwr_mgt/IOPM.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;IOKit/IOService.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;IOKit/IONotifier.h><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#define ALLOW_SLEEP 1<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>IONotifier *notifier;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>extern "C" {<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>IOReturn mySleepHandler( void * target, void * refCon,<span></span></pre></td></tr><tr><td scope="row"><pre>    UInt32 messageType, IOService * provider,<span></span></pre></td></tr><tr><td scope="row"><pre>    void * messageArgument, vm_size_t argSize )<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    IOLog("Got sleep/wake notice.  Message type was %d\n", messageType);<span></span></pre></td></tr><tr><td scope="row"><pre>#if ALLOW_SLEEP<span></span></pre></td></tr><tr><td scope="row"><pre>    acknowledgeSleepWakeNotification(refCon);<span></span></pre></td></tr><tr><td scope="row"><pre>#else<span></span></pre></td></tr><tr><td scope="row"><pre>    vetoSleepWakeNotification(refCon);<span></span></pre></td></tr><tr><td scope="row"><pre>#endif<span></span></pre></td></tr><tr><td scope="row"><pre>    return 0;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>kern_return_t sleepkext_start (kmod_info_t * ki, void * d) {<span></span></pre></td></tr><tr><td scope="row"><pre>        void *myself = NULL; // Would pass the self pointer here if in a class instance<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        notifier = registerPrioritySleepWakeInterest(<span></span></pre></td></tr><tr><td scope="row"><pre>                &amp;mySleepHandler, myself, NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>    return KERN_SUCCESS;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>kern_return_t sleepkext_stop (kmod_info_t * ki, void * d) {<span></span></pre></td></tr><tr><td scope="row"><pre>    notifier->remove();<span></span></pre></td></tr><tr><td scope="row"><pre>    return KERN_SUCCESS;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>} // extern "C"<span></span></pre></td></tr></table></div>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../synchronization/synchronization.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../Extend/Extend.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2002, 2006 Apple Computer, Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2006-11-07<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Darwin/Conceptual/KernelProgramming/services/services.html%3Fid%3DTP30000905-5.7&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Darwin/Conceptual/KernelProgramming/services/services.html%3Fid%3DTP30000905-5.7&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Darwin/Conceptual/KernelProgramming/services/services.html%3Fid%3DTP30000905-5.7&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>