<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Installing a Custom Shutdown Procedure (IM: Pr)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING157></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Processes-156.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Processes-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Processes-171.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Processes-158.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html"><B>Inside Macintosh:</B></A> <A HREF="Processes-2.html"><B>Processes</B></A><BR><DD><A HREF="Processes-146.html"><B>Chapter 8 - Shutdown Manager</B></A> / <A HREF="Processes-155.html"><B>Using the Shutdown Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING157-0></A>
<H2><A NAME=MARKER-9-94></A>Installing a Custom Shutdown Procedure<A NAME=MARKER-2-95></A></H2>
 If you write a shutdown procedure, you can install a pointer to it in the Shutdown Manager's queue by calling the <CODE>ShutDwnInstall</CODE> procedure. You're most likely to need to use a custom shutdown procedure if you are writing a device driver or a system extension. For example, drivers for early hard disk drives that use stepper motors usually need to park the drive heads in a safe zone before the power is turned off. Similarly, drivers for floppy disks and CD-ROM discs use a shutdown procedure that ejects the disks so that they don't remain in the drives when the computer shuts down.<A NAME=MARKER-2-97></A><P>
 If you are developing an application, you can also make use of shutdown procedures. For example, a remote backup application might install a shutdown procedure that reminds a user about scheduled backups. If the user attempts to shut down the computer before the application has backed up the disk, the shutdown procedure could display an alert box asking whether the user wants to back up the disk before the computer shuts down.<A NAME=MARKER-2-99></A><P>
 Remember that the Process Manager frees all application heaps before the Finder calls <CODE>ShutDwnPower</CODE>. For this reason, you can't rely on your heap being intact. You should load your shutdown procedure into the system heap and specify the constants <CODE>sdOnDrivers</CODE> or <CODE>sdOnUnmount</CODE> to ensure that the procedure is executed while the system heap and any necessary system software components are still available.<A NAME=MARKER-2-100></A><P>
 The <CODE>ShutDwnInstall</CODE> procedure accepts a number of constants that specify when during the shutdown process <CODE>ShutDwnPower</CODE> or <CODE>ShutDwnStart</CODE> should execute your custom procedure. You can specify more than one constant to have your procedure executed at different phases of the process. The points indicated by these constants are: before the drivers receive good-bye messages, before volumes are unmounted, or before the computer is restarted or the power supply is switched off. However, Apple Computer, Inc., cannot guarantee the state of the computer after volumes are unmounted. Accordingly, if you plan to use the system heap or call Toolbox or Operating System routines to open a file, display a dialog box, play a sound, and so forth, be sure to specify the <CODE>sdOnDrivers</CODE> or <CODE>sdOnUnmount</CODE> constants. For more information about these constants, see the description of the <CODE>ShutDwnInstall</CODE> routine on <A HREF=Processes-164.html#MARKER-9-121>page 8-13</A>.<A NAME=MARKER-2-113></A><A NAME=MARKER-2-102></A><A NAME=MARKER-2-140></A><A NAME=MARKER-2-178></A><P>
 <A HREF=#MARKER-9-105>Listing 8-2</A> illustrates a sample custom shutdown procedure that ejects a CD-ROM disc just before the Macintosh computer shuts down or restarts.<P>
<B>Listing 8-2  <A NAME=MARKER-9-105></A>A sample custom shutdown procedure</B><P>
<PRE>
PROCEDURE MyShutDownProc;
CONST
   kMaxScsiID = 7;
VAR
   MyDCEHandle:      DCtlHandle;
   CDRefNum:         Integer;       {driver reference number}
   myID:             Integer;       {SCSI ID}
   MyDevStatHandle:  DevStatHandle; {handle to driver's array}
BEGIN
   {Read driver reference number from the unit table.}
   CDRefNum := GetMyRefNum;
   IF CDRefNum = 0 THEN 
      Exit(MyShutDownProc);

   {Get handle to driver's device control entry.}
   MyDCEHandle := GetDCtlEntry(CDRefNum);

   {If handle is NIL, couldn't get device control entry.}
   IF MyDCEHandle = NIL THEN 
      Exit(MyShutDownProc);

   {Eject all mounted CD-ROM discs.}
   MyDevStatHandle := DevStatHandle(MyDCEHandle^^.dCtlStorage);
   FOR myID := 0 to kMaxScsiID DO
   IF (MyDevStatHandle^^[myID].isMyCDDrive = TRUE) AND
      (MyDevStatHandle^^[myID].mounted = TRUE) THEN
      MyEjectCDProc(myID);          {your routine to eject CDs}
END;
</PRE>
 In <A HREF=#MARKER-9-105>Listing 8-2</A>, <CODE>GetMyRefNum</CODE> returns the reference number for a CD device driver from the Device Manager's unit table. A value of 0 indicates that <CODE>GetMyRefNum</CODE> did not find a CD device driver. Next, <CODE>MyShutDownProc</CODE> calls <CODE>GetDCtlEntry</CODE> to retrieve the handle to the CD driver's device control entry record. Both the handle (of type <CODE>DCtlHandle</CODE>) and the device control entry record (of type <CODE>DCE</CODE>) are described in the chapter "Device Manager" in Inside Macintosh: Devices. If the value returned is <CODE>NIL</CODE>, then <CODE>GetDCtlEntry</CODE> did not find the device control entry, and <CODE>MyShutDownProc</CODE> returns. The <CODE>MyShutDownProc</CODE> procedure next loops through the driver's device status array looking for and ejecting mounted compact discs. The <CODE>MyDevStatHandle</CODE> handle points to the driver's array. After checking all elements in the array, <CODE>MyShutDownProc</CODE> returns control to the Shutdown Manager.<P>
<DL>
<DT><B>Note</B>
<DD><A HREF=#MARKER-9-105>Listing 8-2</A> does not define the<DFN> device driver's </DFN>array or the <CODE>GetMyRefNum</CODE> and <CODE>MyEjectCDProc</CODE> routines. These items are internal to the CD-ROM driver.<B></B>  <B>&#183;</B>
</DL>
 Once you have finished writing your shutdown procedure, you can install it by calling <CODE>ShutDwnInstall</CODE>. Your call to <CODE>ShutDwnInstall</CODE> should specify a pointer to <CODE>MyShutDownProc</CODE>, as follows.<A NAME=MARKER-2-106></A><P>
<PRE>
ShutDwnInstall(@MyShutDwnProc, sdOnDrivers);
</PRE>
<DL>
<DT><B>Assembly-Language Note</B>
<DD>When the Shutdown Manager calls a shutdown procedure, it sets a bit in the D0 register indicating the current phase of the shutdown process. The values 0, 1, 2, and 3 represent the constants <CODE>sdOnPowerOff</CODE>, <CODE>sdOnRestart</CODE>, <CODE>sdOnUnmount</CODE>, and <CODE>sdOnDrivers</CODE>, respectively. You can have your shutdown procedure read D0 if it needs to keep track of the shutdown process.<B></B><A NAME=MARKER-2-102></A><A NAME=MARKER-2-99></A><A NAME=MARKER-2-238></A><A NAME=MARKER-2-52></A>  <B>&#183;</B>
</DL>
 The Shutdown Manager follows the standard conventions for saving registers.<!-- specified in <I><A HREF="../IMOverview/IMOverview-2.html">Inside Macintosh: Overview</A>.--><A NAME=MARKER-2-111></A></I><P>
 You can remove your shutdown procedure at any time by callin<DFN>g <CODE>ShutDwnRemove</CODE></DFN>.<A NAME=MARKER-2-112></A><A NAME=MARKER-2-113></A><A NAME=MARKER-2-114></A><P>
</BLOCKQUOTE><P>
<HR>
<center>
<A HREF="Processes-156.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Processes-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Processes-171.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Processes-158.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Processes-3.html">&copy; Apple Computer, Inc.</A><br>17 JUN 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
