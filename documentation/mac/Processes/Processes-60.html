<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Using Application Global Variables in Tasks (IM: Pr)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING60></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Processes-59.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Processes-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Processes-171.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Processes-61.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html"><B>Inside Macintosh:</B></A> <A HREF="Processes-2.html"><B>Processes</B></A><BR><DD><A HREF="Processes-53.html"><B>Chapter 3 - Time Manager</B></A> / <A HREF="Processes-58.html"><B>Using the Time Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING60-0></A>
<H2><A NAME=MARKER-9-76></A>Using Application Global Variables in Tasks</H2>
 <A NAME=MARKER-2-45></A><A NAME=MARKER-2-78></A><A NAME=MARKER-2-71></A><A NAME=MARKER-2-38></A>When a Time Manager task executes, the A5 world of the application that installed the corresponding task record into the Time Manager queue might not be valid (for example, the task might execute at interrupt time when that application is not the current application). If so, an attempt to read the application's global variables returns erroneous results because the A5 register points to the application global variables of some other application. When a Time Manager task uses an application's global variables, you must ensure that register A5 contains the address of the boundary between the application global variables and the application parameters of the application that launched it. You must also restore register A5 to its original value before the task exits.<P>
 It is relatively straightforward to read the current value of the A5 register when a Time Manager task begins to execute (using the <CODE>SetCurrentA5</CODE> function) and to restore it before exiting (using the <CODE>SetA5</CODE> function). It is more complicated, however, to pass to a Time Manager task the value to which it should set A5 before accessing its application's global variables. The problem is that neither the original nor the extended Time Manager task record contains an unused field in which your application could pass this information to the task. The situation here is unlike the situation with Notification Manager tasks or Sound Manager callback routines (both of which provide an easy way to pass the address of the application's A5 world to the task), but it is similar to the situation with vertical retrace tasks.<A NAME=MARKER-2-48></A><A NAME=MARKER-2-49></A><P>
<DL>
<DT><B>Note</B>
<DD>For a more detailed discussion of setting and restoring your application's A5 world, see the chapter "Memory Management Utilities" in <I><A HREF="../Memory/Memory-2.html">Inside Macintosh: Memory</A></I>.<B></B>  <B>&#183;</B>
</DL>
 One way to gain access to the global variables of the application that launched a Time Manager task is to pass to <CODE>InsTime</CODE> (or <CODE>InsXTime</CODE>) and <CODE>PrimeTime</CODE> the address of a structure, the first segment of which is simply the corresponding Time Manager task record and the remaining segment of which contains the address of the application's A5 world. For example, you can define a new data structure, a Time Manager information record, as follows:<P>
<PRE>
TYPE TMInfo =              {Time Manager information record}
   RECORD
      myTMTask:   TMTask;  {original and revised TM task record}
      tmRefCon:   LongInt; {space to pass address of A5 world}
   END;
TMInfoPtr = ^TMInfo;
</PRE>
<DL>
<DT><B>Note</B>
<DD>The <CODE>TMInfo</CODE> record defined above is intended for use with the extended Time Manager.<B></B>  <B>&#183;</B>
</DL>
 Then you can install and activate your Time Manager task as illustrated in <A HREF=#MARKER-9-83>Listing 3-2</A>. The global variable <CODE>gTMInfo</CODE> is an information record of type <CODE>TMInfo</CODE>.<P>
<B>Listing 3-2  <A NAME=MARKER-9-83></A><A NAME=MARKER-21-84></A>Passing the address of the application's A5 world to a Time Manager task</B><P>
<PRE>
PROCEDURE InstallTMTask;
CONST
   kDelay = 2000;                      {delay value}
BEGIN
   gTMInfo.myTMTask.tmAddr := @MyTask; {get address of task}
   gTMInfo.myTMTask.tmWakeUp := 0;     {initialize tmWakeUp}
   gTMInfo.myTMTask.tmReserved := 0;   {initialize tmReserved}
   gTMInfo.tmRefCon := SetCurrentA5;   {store address of A5 }
                                       { world}
   InsTime(@gTMInfo);                  {install the info record}
   PrimeTime(@gTMInfo, kDelay);        {activate the info record}
END;
</PRE>
 With the revised and extended Time Managers, the task is called with register A1 containing the address passed to <CODE>InsTime</CODE> (or <CODE>InsXTime</CODE>) and <CODE>PrimeTime</CODE>. Thus, the Time Manager task simply needs to retrieve the <CODE>TMInfo</CODE> record and extract the appropriate value of the application's A5 world. <A HREF=#MARKER-9-86>Listing 3-3</A> illustrates a task definition for this purpose.<A NAME=MARKER-2-47></A><P>
<B>Listing 3-3  <A NAME=MARKER-9-86></A><A NAME=MARKER-21-87></A>Defining a Time Manager task that can manipulate global variables</B><P>
<PRE>
FUNCTION GetTMInfo: TMInfoPtr;
   INLINE $2E89;                       {MOVE.L A1,(SP)}

PROCEDURE MyTask;
VAR
   oldA5:   LongInt;                   {A5 when task is called}
   recPtr:  TMInfoPtr;
BEGIN
   recPtr := GetTMInfo;                {first get your record}
   oldA5 := SetA5(recPtr^.tmRefCon);   {set A5 to app's A5 world}

   {Do something with the application's globals here.}

   oldA5 := SetA5(oldA5);              {restore original A5 }
                                       { and ignore result}
END;
</PRE>
 This technique works primarily because the revised and extended Time Managers do not care if the record whose address is passed to <CODE>InsTime</CODE> (or <CODE>InsXTime</CODE>) and <CODE>PrimeTime</CODE> is larger than expected. If you use this technique, however, be sure to retrieve the address of the task record from register A1 as soon as you enter the Time Manager task (because some compilers generate code that uses registers A0 and A1 to dereference structures).<P>
<DL>
<DT><B>IMPORTANT</B>
<DD>You cannot use the technique illustrated in <A HREF=#MARKER-9-86>Listing 3-3</A> with the original Time Manager because it does not pass the address of the task record in register A1. To gain access to your application's global variables when using the original Time Manager, you would need to store your application's A5 value in one of the application's code segments (in particular, in the code segment that contains the Time Manager task). This technique involves the use of self-modifying code segments and is not in general recommended. Applications that attempt to modify their own <CODE>'CODE'</CODE> resources may crash in operating environments (for example, A/UX) that restrict an application's access to its own code segments.<B></B><A NAME=MARKER-2-88></A><A NAME=MARKER-2-53></A><A NAME=MARKER-9-89></A><A NAME=MARKER-2-91></A><A NAME=MARKER-2-92></A><A NAME=MARKER-2-29></A><A NAME=MARKER-2-94></A><A NAME=MARKER-2-27></A><A NAME=MARKER-2-146></A><A NAME=MARKER-2-144></A><A NAME=MARKER-2-46></A><A NAME=MARKER-2-44></A>  <B>&#183;</B>
</DL>
</BLOCKQUOTE><P>
<HR>
<center>
<A HREF="Processes-59.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Processes-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Processes-171.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Processes-61.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Processes-3.html">&copy; Apple Computer, Inc.</A><br>17 JUN 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
