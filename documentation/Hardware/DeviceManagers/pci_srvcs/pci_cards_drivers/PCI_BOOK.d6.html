<HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><script language="JavaScript" src="frametest.js"></script><TITLE> Disk Partition Control and Status Requests and File Exchange</TITLE></HEAD><BODY BGCOLOR="#ffffff"><DIV><a name="top"></a><!-- start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!-- start of path --><font face="Geneva,Helvetica,Arial" size="1"><b><br>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Documentation</a> &gt; <!-- a href="" target="_top" -->Hardware<!-- /a -->  <b>&gt; </b><a href="../../devicemgrs.html" target="_top">Device Managers and Drivers</a> <b>&gt; </b><a href="../pci_srvcs.html" target="_top">PCI Card Services</a> <b>&gt; </b>Designing PCI Cards and Drivers for Power Macintosh Computers</font><br><br><!-- end of path --><A HREF="PCI_BOOK.d4.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.d5.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.d7.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><HR></DIV><H1 CLASS="H3.Heading3"><A NAME="pgfId=4611"> </A>Disk Partition Control and Status Requests and File Exchange</H1><P CLASS="T1.Text1"><A NAME="pgfId=4612"> </A>The control and status requests defined in this section are primarily used by drivers to support the Apple File Exchange application, previously known as PC Exchange. <A NAME="marker=4613"> </A></P><P CLASS="T1.Text1"><A NAME="pgfId=4614"> </A>The partition information record is a structure used to store information about a partition on a device. The fields of the structure are:</P><P CLASS="T1.Text1"><A NAME="pgfId=4615"> </A><TT CLASS="cv">SCSIID</TT></P><P CLASS="T1.Text1"><A NAME="pgfId=4616"> </A>If the device is connected via a SCSI interface, this field holds the SCSI Manager <TT CLASS="cv">DeviceIdent</TT> of the device. If the device is connected via an ATA interface, this field holds the ATA Manager <TT CLASS="cv">ataDeviceID</TT>. Devices connected via other interfaces can use whatever value makes sense to uniquely identify the device on that bus. If no value makes sense, a device must clear this field. </P><P CLASS="T1.Text1"><A NAME="pgfId=4617"> </A><TT CLASS="cv">physPartitionLoc</TT></P><P CLASS="T1.Text1"><A NAME="pgfId=4618"> </A>The block number of the first block in the partition. </P><P CLASS="T1.Text1"><A NAME="pgfId=4619"> </A><TT CLASS="cv">partitionNumber</TT> </P><P CLASS="T1.Text1"><A NAME="pgfId=4620"> </A>The size (in blocks) of the partition. </P><DIV><blockquote><p CLASS="NoteHead"><b><A NAME="pgfId=17390"> </A>Note</b></p><P CLASS="Note"><A NAME="pgfId=4621"> </A>You can determine the interface used by the device issuing the <TT CLASS="cv">kdgInterface</TT> Driver Gestalt query. Drivers that support File Exchange should also support this Driver Gestalt selector. For more information about the <TT CLASS="cv">ataDeviceID</TT> structure, consult the ATA Device 0/1 Software Developer Guide. </P></blockquote><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=4622"> </A>GetADrive Control Call</H2><P CLASS="T1.Text1"><A NAME="pgfId=4624"> </A>The <TT CLASS="cv">kGetADrive</TT><A NAME="marker=4623"> </A> control call (<TT CLASS="cv">csCode</TT> = 51) asks the driver to create a new drive queue element. This control call supports synchronous and asynchronous operation. </P><P CLASS="T1.Text1"><A NAME="pgfId=4625"> </A>On input, <TT CLASS="cv">DrvQElPtr</TT> contains the address of a drive queue element pointer. The call creates a new drive queue element based on the supplied drive queue element and places a pointer to the new drive queue element in the supplied address.</P><P CLASS="T1.Text1"><A NAME="pgfId=4667"> </A>The following describes how the fields of the new drive queue element must be filled out: </P><TABLE border=1 cellpadding=3><TR><TH ROWSPAN="1" COLSPAN="1"><P CLASS="TbH.TblHd"><A NAME="pgfId=4628"> </A>Field name</P></TH><TH ROWSPAN="1" COLSPAN="1"><P CLASS="TbH.TblHd"><A NAME="pgfId=4630"> </A>Description</P></TH></TR><TR><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4632"> </A>drive flags</FONT></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4634"> </A>(the 4 bytes prior to qLink) Inherited from the supplied drive queue element.</FONT></TD></TR><TR><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4636"> </A><TT CLASS="cv">qLink</TT></FONT></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4638"> </A>Set up when you add the drive to the drive queue using <TT CLASS="cv">AddDrive</TT>.</FONT></TD></TR><TR><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4640"> </A><TT CLASS="cv">qType</TT></FONT></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4642"> </A>Inherited from the supplied drive queue element. </FONT></TD></TR><TR><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4644"> </A><TT CLASS="cv">dQDrive</TT></FONT></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4646"> </A>Must be set to a new unique drive number.</FONT></TD></TR><TR><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4648"> </A><TT CLASS="cv">dQRefNum</TT></FONT></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4650"> </A>Must be set to your driver's reference number.</FONT></TD></TR><TR><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4652"> </A><TT CLASS="cv">dQFSID</TT></FONT></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4654"> </A>Inherited from the supplied drive queue element.</FONT></TD></TR><TR><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4656"> </A><TT CLASS="cv">dQDrvSz</TT></FONT></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4658"> </A>Inherited from the supplied drive queue element.</FONT></TD></TR><TR><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4660"> </A><TT CLASS="cv">dQDrvSz2</TT></FONT></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4662"> </A>Inherited from the supplied drive queue element.</FONT></TD></TR><TR><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4664"> </A>partition offset</FONT></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4666"> </A> (typically held in extra bytes beyond <TT CLASS="cv">dQDrvSz2</TT>)  Inherited from the supplied drive queue element.</FONT></TD></TR></TABLE><P CLASS="T1.Text1"><A NAME="pgfId=4668"> </A>Your driver must return the new drive queue element in the memory pointed by <TT CLASS="cv">csParam[0..1]</TT>. You must not post a disk inserted event for the new drive, or send the <TT CLASS="cv">fsmDrvQElChangedMessage</TT> message to the File System Manager.</P></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=4669"> </A>RegisterPartition Control Call</H2><P CLASS="T1.Text1"><A NAME="pgfId=4671"> </A>The <TT CLASS="cv">kRegisterPartition</TT><A NAME="marker=4670"> </A> control call (<TT CLASS="cv">csCode</TT> = 50) registers a non-Macintosh partition found on a disk. This control call supports synchronous and asynchrous operation. The driver should fill in <TT CLASS="cv">csParam</TT> as follows:</P><CODE CLASS="Cv.Code"><A NAME="pgfId=17394"> </A>csParam[0..1] DrvQElPtr &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* The drive queue element whose */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* partition is to be changed */<BR>(UInt32) csParam[2..3] &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* The block number of the first */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* block in the partition */<BR>(UInt32) csParam[4..5] &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* Size of partition in blocks */</CODE><P CLASS="T1.Text1"><A NAME="pgfId=4673"> </A>In response to this call, your disk driver must retarget the specified drive queue element to represent the given partition on the disk. After this call, the drive queue element must represent a partition that starts at the block specified by <TT CLASS="cv">csParam[2..3]</TT> and is of the size specified by <TT CLASS="cv">csParam[4..5]</TT>.</P><P CLASS="T1.Text1"><A NAME="pgfId=4674"> </A>You must not post a disk inserted event for the new drive, or send the <TT CLASS="cv">fsmDrvQElChangedMessage</TT> message to the File System Manager.</P><DIV><blockquote><p CLASS="ImportantHead"><b><A NAME="pgfId=17396"> </A>IMPORTANT</b></p><P CLASS="I.Important"><A NAME="pgfId=4675"> </A>The effects of this call are limited to the drive queue element in memory. This call must not change the partitioning scheme on disk.  </P></blockquote></DIV></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=4677"> </A><A NAME="17421"> </A>ProhibitMounting Control Call</H2><P CLASS="T1.Text1"><A NAME="pgfId=4679"> </A>The <TT CLASS="cv">kProhibitMounting</TT><A NAME="marker=4678"> </A> control call (<TT CLASS="cv">csCode</TT> = 52) prevents the mounting of a partition. This control call supports synchronous and asynchrous operation. </P><P CLASS="T1.Text1"><A NAME="pgfId=4680"> </A>In response to this call, your disk driver must mark the partition specified in <TT CLASS="cv">csParam[0..1]</TT> so that it isn't mounted at system startup. The <TT CLASS="cv">csParam[0..1]</TT> field contains a valid <TT CLASS="cv">partInfoRecPtr</TT>, a pointer to a <TT CLASS="cv">partInfoRec</TT> structure that contains information about a partition:</P><CODE CLASS="Cv.Code"><A NAME="pgfId=17400"> </A>typedef struct partInfoRec<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;DeviceIdent SCSIID;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// DeviceIdent for the device<BR>&nbsp;&nbsp;&nbsp;&nbsp;unsigned long physPartitionLoc;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// physical block number of<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;beginning of partition<BR>&nbsp;&nbsp;&nbsp;&nbsp;unsigned long partitionNumber;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// partition number of this<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;partition<BR>} partInfoRec, *partInfoRecPtr;</CODE><P CLASS="T1.Text1"><A NAME="pgfId=4683"> </A><A NAME="27510"> </A>Modern versions of File Exchange do not require your driver to support this call. If you decide not to support it, make sure to return <TT CLASS="cv">controlErr</TT>. </P><P CLASS="T1.Text1"><A NAME="pgfId=4684"> </A>The partition is completely determined by the fields of the partition information record, not by the <TT CLASS="cv">ioVRefNum</TT> field of the parameter block.</P><DIV><blockquote><p CLASS="ImportantHead"><b><A NAME="pgfId=17404"> </A>IMPORTANT</b></p><P CLASS="I.Important"><A NAME="pgfId=4685"> </A>The effects of this call are permanently applied to the partition map on disk. </P></blockquote></DIV></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=4686"> </A>GetPartInfo Status Call</H2><P CLASS="T1.Text1"><A NAME="pgfId=4688"> </A>The <TT CLASS="cv">kGetPartInfo</TT><A NAME="marker=4687"> </A> status call (<TT CLASS="cv">csCode</TT> = 51) returns information about a partition in the <TT CLASS="cv">partInfoRec</TT> structure described earlier in <A HREF="PCI_BOOK.d6.html#17421" CLASS="XRef">ProhibitMounting Control Call</A> This status call supports synchronous and asynchronous operation. </P><P CLASS="T1.Text1"><A NAME="pgfId=4692"> </A>In response to this call, your disk driver must place partition information about the specified drive in the partition information record pointed to by <TT CLASS="cv">csParam[0..1]</TT>.</P><P CLASS="T1.Text1"><A NAME="pgfId=4693"> </A>The driver fills in the <TT CLASS="cv">partInfoRec</TT> structure as follows:</P><CODE CLASS="Cv.Code"><A NAME="pgfId=17408"> </A>*(partInfoRecPtr)csParam.SCSIID &lt;- &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* DeviceIdent for */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* the device */<BR>*(partInfoRecPtr)csParam.physPartitionLoc &lt;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* physical block */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* number of partition start */<BR>*(partInfoRecPtr)csParam.partitionNumber <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* partition number of this partition */</CODE></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=4695"> </A>GetPartitionStatus Status Call</H2><P CLASS="T1.Text1"><A NAME="pgfId=4697"> </A>The <TT CLASS="cv">kGetPartitionStatus</TT><A NAME="marker=4696"> </A> status call (<TT CLASS="cv">csCode</TT> = 50) retrieves the status of a partition. This status call supports synchronous and asynchronous operation. </P><CODE CLASS="Cv.Code"><A NAME="pgfId=17412"> </A>(long *)csParam[0..1]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* partInfoRecPtr for partition */<BR>(SInt16 *)csParam[2..3]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* address of a short for response */</CODE><P CLASS="T1.Text1"><A NAME="pgfId=4699"> </A>In response to this call, the disk driver must determine whether the partition described by the partition information record pointed to by <TT CLASS="cv">csParam[0..1]</TT> is mounted and return the volume reference number, <TT CLASS="cv">VRefNum</TT>, of the volume in the <TT CLASS="cv">SInt16</TT> pointed to by <TT CLASS="cv">csParam[2..3]</TT>, or 0 if the partition is not mounted.</P><P CLASS="T1.Text1"><A NAME="pgfId=4700"> </A>For SCSI and ATA devices, you can create a <TT CLASS="cv">partInfoRec</TT> from scratch, for other types of devices, you have to get one back from the driver using <TT CLASS="cv">kGetPartInfo</TT> and then use the returned <TT CLASS="cv">SCSIID</TT> field to fill in the <TT CLASS="cv">SCSIID</TT> field of your <TT CLASS="cv">partInfoRec</TT></P><P CLASS="T1.Text1"><A NAME="pgfId=4701"> </A><TT CLASS="cv">SCSIID</TT> field is only valid if the driver returns <TT CLASS="cv">kdgScsiIntf</TT> in response to a <TT CLASS="cv">kdgInterface</TT> Driver Gestalt query.</P></DIV></DIV><HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 26 March 99)<P><A HREF="PCI_BOOK.d4.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.d5.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.d7.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>