<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML EXPERIMENTAL 970324//EN">
<HTML>
<HEAD>
<META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter">
<script language="JavaScript" src="frametest.js"></script>
<TITLE> ConvertFromUnicodeToTextRun</TITLE><LINK REL="stylesheet" TYPE="text/css" HREF="../../../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../../../Resources/JavaScript/page.js"></script>
</head>
<body bgcolor="#ffffff">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>

<DIV>
<a name="top"></a>
<!-- start of header -->
<!--#include virtual="/includes/framesetheader" -->
<!-- end of header --><A HREF="TEC.88.html"><img src="images/up.gif" border="0" alt="Up"></A><nobr>&nbsp;</nobr><A HREF="TEC.8b.html"><img src="images/previous.gif" border="0" alt="Previous"></A><nobr>&nbsp;</nobr><A HREF="TEC.8d.html"><img src="images/next.gif" border="0" alt="Next"></A><nobr>&nbsp;</nobr>
<!-- insert Show/Hide frames -->
<a href="javascript:testFrame()">
<script>
<!--
document.write(frameLink);
//	-->
</script><!-- end Show/Hide frames --></A><br>
<font face="Geneva,Helvetica,Arial" size="1"><b><br>
		PATH<spacer type="horizontal" size="5">&nbsp;</b></font><a href="../../../mac8.html"><font face="Geneva,Helvetica,Arial" size="1">Mac OS 8 and 9 Developer Documentation</a>  <b>&gt;</b> Text Encoding Conversion Manager<br>
		<img src="images/im_smblue.gif" width="116" height="8"><img src="images/space.gif" width="6" height="11">Programming With the Text Encoding Conversion Manager</font><br>
		<br>
		<hr>

</DIV>
<H1>
<A NAME="pgfId=3745">
 </A>
<A NAME="17840">
 </A>
ConvertFromUnicodeToTextRun</H1>
<P>
<A NAME="pgfId=3746">
 </A>
Converts a string from Unicode to one or more encodings. </P>
<TT>
<A NAME="pgfId=26378">
 </A>
pascal OSStatus ConvertFromUnicodeToTextRun (<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UnicodeToTextRunInfo iUnicodeToTextInfo,<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ByteCount iUnicodeLen, <BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ConstUniCharArrayPtr iUnicodeStr,<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OptionBits iControlFlags, <BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ItemCount iOffsetCount, <BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ByteOffset iOffsetArray[], <BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ItemCount *oOffsetCount, <BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ByteOffset oOffsetArray[], <BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ByteCount iOutputBufLen, <BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ByteCount *oInputRead, <BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ByteCount *oOutputLen, <BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LogicalAddress oOutputStr, <BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ItemCount iEncodingRunBufLen, <BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ItemCount *oEncodingRunOutLen, <BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TextEncodingRun oEncodingRuns[]);</TT>
<DL COMPACT>
<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=26382">
 </A>
<TT>iUnicodeToTextInfo</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=3749">
 </A>
 	You use the function <A HREF="TEC.89.html" CLASS="XRef"><TT>CreateUnicodeToTextRunInfo</TT></A>, <A HREF="TEC.8a.html" CLASS="XRef"><TT>CreateUnicodeToTextRunInfoByEncoding</TT></A>, or <A HREF="TEC.8b.html" CLASS="XRef"><TT>CreateUnicodeToTextRunInfoByScriptCode</TT></A> to obtain a Unicode converter object to specify for this parameter. </DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=26395">
 </A>
<TT>iUnicodeLen</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=3753">
 </A>
The length in bytes of the Unicode string to be converted. </DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=26404">
 </A>
<TT>iUnicodeStr</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=3754">
 </A>
A pointer to the Unicode string to be converted.</DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=26413">
 </A>
<TT>iControlFlags</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=12921">
 </A>
Conversion control flags. The following constants define the masks for control flags valid for this parameter. You can use these masks to set the <TT>iControlFlags</TT> parameter: <TT> kUnicodeUseFallbacksMask kUnicodeKeepInfoMask kUnicodeVerticalFormMask kUnicodeLooseMappingsMask kUnicodeStringUnterminatedMask kUnicodeTextRunMask kUnicodeKeepSameEncodingMask kUnicodeForceASCIIRangeMask kUnicodeNoHalfwidthCharsMask kUnicodeTextRunHeuristicsMask</TT></DD><P>

<DD CLASS="DD.DefinitionDefCont">
<A NAME="pgfId=14504">
 </A>
You can also set one of the following directionality masks: <TT> kUnicodeDefaultDirectionMask kUnicodeLeftToRightMask kUnicodeRightToLeftMask</TT></DD><P>

<DD CLASS="DD.DefinitionDefCont">
<A NAME="pgfId=14509">
 </A>
For a description of these control flags, see <A HREF="TEC.6d.html" CLASS="XRef">
Conversion Control Flags</A>
. </DD><P>

<DD CLASS="DD.DefinitionDefCont">
<A NAME="pgfId=3761">
 </A>
If the text-run control flag is clear, <TT>ConvertFromUnicodeToTextRun</TT> attempts to convert the Unicode text to the single encoding it chooses from the list of encodings in the Unicode mapping structures array that you provide when you create the Unicode converter object. This is the encoding that produces the best result, that is, that provides for the greatest amount of source text conversion. If the complete source text can be converted into more than one of the encodings specified in the Unicode mapping structures array, then the converter chooses among them based on their order in the array. If this flag is clear, the <TT>oEncodingRuns</TT> parameter always points to a value equal to 1. </DD><P>

<DD CLASS="DD.DefinitionDefCont">
<A NAME="pgfId=12932">
 </A>
If you set the use-fallbacks control flag, the converter uses the default fallback characters for the current encoding. If the converter cannot handle a character using the current encoding, even using fallbacks, the converter attempts to convert the character using the other encodings, beginning with the first encoding specified in the list and skipping the encoding where it failed. </DD><P>

<DD CLASS="DD.DefinitionDefCont">
<A NAME="pgfId=3763">
 </A>
If you set the <TT>kUnicodeTextRunBit</TT> control flag, the converter attempts to convert the complete Unicode text string into the first encoding specified in the Unicode mapping structures array you passed to <TT>CreateUnicodeToTextRunInfo</TT>, <TT>CreateUnicodeToTextRunInfoByEncoding</TT>, or <TT>CreateUnicodeToTextRunInfoByScriptCod</TT>e when you created the Unicode converter object for this conversion. If it cannot do this, the converter then attempts to convert the first text element that failed to the remaining encodings, in their specified order in the array. What the converter does with the next text element depends on the setting of the keep-same-encoding control flag.</DD><P>

<DD CLASS="DD.DefinitionDefCont">
<A NAME="pgfId=19686">
 </A>
If the keep-same-encoding control flag is clear and the text-run heuristics control flags is clear, the converter returns to the original encoding and attempts to continue conversion with that encoding; this is equivalent to converting each text element to the first encoding that works, in the order specified. If the text-run heuristics control flags is set, the converter does not return to the original encoding for common characters such as space and punctuation that are present in most encodings and shared by many writing systems.</DD><P>

<DD CLASS="DD.DefinitionDefCont">
<A NAME="pgfId=3768">
 </A>
If the keep-same-encoding control flag is set, the converter continues with the new destination encoding until it encounters a text element that cannot be converted using the new encoding. This attempts to minimize the number of encoding changes in the output text. When the converter cannot convert a text element using any of the encodings in the list and the Unicode-keep-same-encoding control flag is set, the converter uses the fallbacks default characters for the current encoding.</DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=26475">
 </A>
<TT>iOffsetCount</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=3776">
 </A>
The number of offsets in the array pointed to by the <TT>iOffsetArray</TT> parameter. Your application supplies this value. If you don't want offsets returned to you, specify <TT>0</TT> (zero) for this parameter.</DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=26484">
 </A>
<TT>iOffsetArray</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=3777">
 </A>
An array of type <TT>ByteOffset</TT>. On input, you specify the array that contains an ordered list of significant byte offsets pertaining to the source Unicode string. These offsets may identify font or style changes, for example, in the Unicode string. If you don't want offsets returned to your application, specify <TT>NULL</TT> for this parameter and <TT>0</TT> (zero) for <TT>iOffsetCount</TT>. All offsets must be less than <TT>iUnicodeLen</TT>.</DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=26493">
 </A>
<TT>oOffsetCount</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=3778">
 </A>
A pointer to a value of type <TT>ItemCount</TT>. On output, this value contains the number of offsets that were mapped in the output stream. </DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=26502">
 </A>
<TT>oOffsetArray</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=3779">
 </A>
An array of type <TT>ByteOffset</TT>. On output, this array contains the corresponding new offsets for the resulting converted string.</DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=26511">
 </A>
<TT>iOutputBufLen</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=3780">
 </A>
The length in bytes of the output buffer pointed to by the <TT>oOutputStr</TT> parameter. Your application supplies this buffer to hold the returned converted string. The <TT>oOutputLen</TT> parameter may return a byte count that is less than this value if the converted byte string is smaller than the buffer size you allocated. </DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=26520">
 </A>
<TT>oInputRead</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=3781">
 </A>
A pointer to a value of type <TT>ByteCount</TT>. On output, this value contains the number of bytes of the Unicode source string that were converted. If the function returns a result code other than <TT>noErr</TT>, then this parameter returns the number of bytes that were converted before the error occurred. </DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=26529">
 </A>
<TT>oOutputLen</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=3782">
 </A>
A pointer to a value of type <TT>ByteCount</TT>. On output, this value contains the length in bytes of the converted string. </DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=26538">
 </A>
<TT>oOutputStr</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=3783">
 </A>
A value of type <TT>LogicalAddress</TT>. On input, this value points to the start of the buffer for the converted string. On output, this buffer contains the converted string in one or more encodings. When an error occurs, the <TT>ConvertFromUnicodeToTextRun</TT> function returns the converted string up to the character that caused the error. (For guidelines on estimating the size of the buffer needed, see the discussion following the parameter descriptions.) </DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=26547">
 </A>
<TT>iEncodingRunBufLen</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=3784">
 </A>
 The number of text encoding run elements you allocated for the encoding run array pointed to by the <TT>oEncodingRuns</TT> parameter. The converter returns the number of valid encoding runs in the location pointed to by <TT>oEncodingRunOutLen</TT>. Each entry in the encoding runs array specifies the beginning offset in the converted text and its associated text encoding.</DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=26557">
 </A>
<TT>oEncodingRunOutLen</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=10999">
 </A>
 A pointer to a value of type <TT>ItemCount</TT>. On output, this value contains the number of valid encoding runs returned in the <TT>oEncodingRuns</TT> parameter. </DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=26567">
 </A>
<TT>oEncodingRuns</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=11001">
 </A>
On input, an array of structures of type <A HREF="TEC.23.html" CLASS="XRef"><TT>TextEncodingRun</TT></A>
. Your application should allocate an array with the number of elements you specify in the <TT>iEncodingRunBufLen</TT> parameter. On output, this array contains the encoding runs for the converted text string. Each entry in the encoding run array specifies the beginning offset in the converted text string and the associated encoding specification.</DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=26576">
 </A>
<I CLASS="italics">
function result</I>
</DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=16411">
 </A>
A result code. The result codes are the same as those for the function<TT> </TT><A HREF="TEC.86.html" CLASS="XRef"><TT>ConvertFromUnicodeToText</TT></A>, with the following additional possibility: If the function returns <TT>kTECArrayFullErr</TT>, then the <TT>oEncodingRuns</TT> array was too small for all of the encodings runs in the output text, and the input was not completely converted. As you would if <TT>kTECOutputBufferFullErr</TT> was returned, you can call the function again with another output buffer--or with the same output buffer after copying its contents--to convert the remainder of the Unicode string.</DD><P>

</DL COMPACT>
<DIV>
<H5 CLASS="RSb.RoutineSbhd">
<A NAME="pgfId=3788">
 </A>
	DISCUSSION</H5>
<P>
<A NAME="pgfId=3789">
 </A>
To use the<TT> ConvertFromUnicodeToTextRun</TT> function, you must first set up an array of structures of type <A HREF="TEC.72.html" CLASS="XRef"><TT>UnicodeMapping</TT></A> containing, in order of precedence, the mapping information for the conversion. To create a Unicode converter object, you call the <TT>CreateUnicodeToTextRunInfo</TT> function passing it the Unicode mapping array, or you can the <TT>CreateUnicodeToTextRunInfoByEncoding</TT> or <TT>CreateUnicodeToTextRunInfoByScriptCode</TT> functions, which take arrays of text encodings or script codes instead of an array of Unicode mappings. You pass the returned Unicode converter object as the <TT>iUnicodeToTextInfo</TT> parameter when you call the <TT>ConvertFromUnicodeToTextRun</TT> function.<P>


<A NAME="pgfId=3793">
 </A>
Two of the control flags that you can set for the <TT>iControlFlags</TT> parameter allow you to control how the Unicode Converter uses the multiple encodings in converting the text string. These flags are explained in the description of the <TT>iControlFlags</TT> parameter. Here is a summary of how to use these two control flags:</P>
<UL>

<LI>
<A NAME="pgfId=3794">
 </A>
To keep the converted text in a single encoding, clear the text-run control flag.<P>

<LI>
<A NAME="pgfId=19693">
 </A>
To keep as much contiguous converted text as possible in one encoding, set the text-run control flag and clear the keep-same-encoding control flag. You can reduce gratuitous encoding changes in this mode by setting the text-run heuristics control flag. <P>

<LI>
<A NAME="pgfId=3796">
 </A>
To minimize the number of resulting encoding runs and the changes of destination encoding, set both the text-run and keep-same-encoding control flags. <P>
</UL>
<P>
<A NAME="pgfId=3797">
 </A>
The <TT>ConvertFromUnicodeToTextRun</TT> function returns the converted string in the array pointed to by the <TT>oOutputStr</TT> parameter. Beginning with the first text element in the <TT>oOutputStr</TT> array, the elements of the array pointed to by the <TT>oEncodingRuns</TT> parameter identify the encodings of the converted string. The number of elements in the <TT>oEncodingRuns</TT> array may not correspond to the number of elements in the <TT>oOutputStr</TT> array. This is because the <TT>oEncodingRuns</TT> array includes only elements for the beginning of each new encoding run in the converted string. </P>
</DIV>
<DIV>
<H5 CLASS="RSb.RoutineSbhd">
<A NAME="pgfId=14583">
 </A>
SEE ALSO</H5>
<P>
<A NAME="pgfId=14584">
 </A>
The function <A HREF="TEC.8d.html" CLASS="XRef"><TT>ConvertFromUnicodeToScriptCodeRun</TT></A></P>
</DIV>
<HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 13 Dec 99)<P><A HREF="TEC.88.html"><img src="images/up.gif" border="0" alt="Up"></A><nobr>&nbsp;</nobr><A HREF="TEC.8b.html"><img src="images/previous.gif" border="0" alt="Previous"></A><nobr>&nbsp;</nobr><A HREF="TEC.8d.html"><img src="images/next.gif" border="0" alt="Next"></A><nobr>&nbsp;</nobr>
<!-- insert Show/Hide frames -->
<a href="javascript:testFrame()">
<script>
<!--
document.write(frameLink);
//	-->
</script><!-- end Show/Hide frames --></A>

<!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></BODY>
</HTML>
