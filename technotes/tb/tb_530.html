<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TB530: Event Manager Q&amp;As</title>                                       <meta name="categories" content="Human Interface Toolbox"><meta name="week-posted" content="Oct 1, 1990 - Oct 5, 1990"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002799" title="Event Manager Q&As"></a><a name="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/Carbon/idxHumanInterfaceToolbox-date.html" target="_blank">Carbon > Human Interface Toolbox</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TB530</div>
<div id="pageheadsub">Event Manager Q&amp;As</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">This Technical Note contains a collection of archived Q&amp;As relating to a specifictopic--questions sent the Developer Support Center (DSC) along withanswers from the DSC engineers. Current Q&amp;A's can be found on the <A HREF = "../../qa/index.html">Macintosh Technical Q&amp;A's web site</a>.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Sep 01 1993]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content --><a name=Section1></A><h2>Kanji 7.1 and keydown events generating character codes $81 and $40</h2><p>While updating our application to run correctly under the Kanji version ofSystem 7.1, we've noticed that the space bar sends two key-down events (values$81 and $40) as opposed to one ($20). To determine whether the space bar washit, should we use the key code from the event record instead of the charactercode?</p><p>This is new with Kanji 7.1 and is still a controversial issue. Codes $81and $40correspond to the two-byte space character, which is different from thestandard ASCII space character (different width).</p><p>You can't use the key code from the event record, as it has been lost duringKanjiTalk's event processing. Moreover, even if it were there (or if you got itthrough a <code>GetKeys</code> call) you shouldn't use it; the space bar has different keycodes on different keyboards!</p><p>So, the only reasonable workaround in your case seems to be to expand yourspace bar key-down check to compare with $81 (the first byte of a two-bytecharacter) followed by $40, in addition to comparing with the standard ASCII$20.</p><P><A HREF="#top">Back to top</A></p><h2>Getting OSEvents from a jGNEFilter</h2><P>Date Written:  1/19/93</p><P>Last reviewed:  5/14/93</p><p>I've written a jGNEFilter to do something whenever an application comes to theforeground. Unfortunately it seems that <code>OSEvents</code> aren't sent through thisfilter, so I never see the <code>resumeEvent</code>. Is this correct or am I doing somethingwrong? Is there a better way to get something done on a <code>resumeEvent</code>?</p><p>You're correct in that a <code>jGNEFilter</code> won't see <code>OSEvents</code>. Because it sits belowthe Process Manager, it will see only those events that are generated by theToolbox itself, rather than the Process Manager. The best way to ensure gettingthese events is probably to tail-patch <code>GetNextEvent</code> and <code>WaitNextEvent</code>;depending on how you want to deal with the events, patching <code>EventAvail</code> may alsobe necessary. There isn't a hook between the Process Manager and the actualresults of these traps, so there's no more general place to do this.</p><P><A HREF="#top">Back to top</A></p><h2>Consistent application scrolling speed for all Macintosh systems</h2><P>Date Written:  5/3/89</p><P>Last reviewed:  6/14/93</p><p>How can I keep the speed of my application's scrolling consistent on allMacintosh systems, including faster ones?</p><p>One method is to use <code>TickCount</code>. If a certain number of ticks has passed sincethe last increment of the scroll bar, then go on. If not, then loop until thedesired number of ticks has passed before scrolling. It's easy to include thistest, but you'll have to play with itawhile to find the right number of ticksfor the desired delay. Also, consider that some Macintosh systems are fasterthan a Mac II, such as the SE/30 and Macintosh systems with third-partyaccelerator boards. It might be nice to let users set their preference for thescrolling speed.</p><p>X-Ref:</p>"The Toolbox Event Manager," <i>Inside Macintosh</i> Volume I<p><A HREF="#top">Back to top</A></p><h2>'SIZE' resource is32BitCompatible flag</h2><P>Date Written:  3/14/91</p><P>Last reviewed:  6/7/91</p><p>Does setting the is32BitCompatible bit in the 'SIZE' resource have any effectin System 7.0?</p><p>The alert box that was to be shown for applications with the <code>'SIZE'</code> resource's<code>is32BitCompatible</code> flag disabled was found to be too confusing for an end user,so the <code>is32BitCompatible</code> flag is not used and the alert box is not displayed inthe final System 7.0. (It is, however, displayed in A/UX 2.0 and 2.0.1.) Thiscould change in the future.</p><P><A HREF="#top">Back to top</A></p><h2>'SIZE' resource bit and resume events in window title bar</h2><P>Date Written:  9/3/91</p><P>Last reviewed:  9/16/91</p><p>We set our <code>'SIZE'</code> resource to say we don't want mouse events for the click thatgenerates a resume event, but when the user clicks in the title bar of our(inactive) window we get the event anyway.</p><p>You are quite right, you do get the mousedown if it occurs in the windows titlebar. This choice was made so that when you click in the drag region of a windowin the background you don't have to click twice to get the window to drag. Thissomewhat negates the effect that some developers are trying to get by settingthe bit in the <code>'SIZE'</code> resource, but it really could not be avoided. Your bestbet is to simply ignore the first mousedown after a resume if it is in the dragregion of the window. This way, you will not loose any events in the unlikelyevent that the user can get a keystroke or something in the queue before youget your resume.</p><P><A HREF="#top">Back to top</A></p><h2>Using GetKeys to check Macintosh key status</h2><P>Date Written:  7/26/90</p><P>Last reviewed:  10/1/91</p><p>Is there a way to test whether a particular key is down independently of theevent record? My application needs to check the Option key status beforeentering the main event loop.</p><p>The call <code>GetKeys(VAR theKeys:KeyMap)</code> returns a <code>keyMap</code> of the current state ofall the keys on the keyboard. The call is documented in <i>Inside Macintosh</i>Volume I on page 259. The Option key will appear as the 58th bit (counting from0) in the map. In MacsBug you can see this with a DM <code>KeyMap</code>, which returns thefollowing:</p><p>It's important to understand that the <code>keyMap</code> is an array of packed bits. Youneed to test whether the Option key bit is 1 or 0. The key code 58 = $3A is the58th bit of the <code>keyMap</code>. This number can be determined from the keyboard figureon page 251 of <i>Inside Macintosh</i> Volume I and pages 191-192 of Volume V.(If in counting the above bits you get 61 instead of 58, remember that the bitswithin each byte are counted right to left.)</p><p>With the above information you should be able to determine the status of anykey on the keyboard within your program without waiting for an event. <code>GetKeys</code>,however, should be called only for special situations. Normal keyboardprocessing should be done through events; otherwise, your application risksincompatibilities with nonstandard input devices.</p><P><A HREF="#top">Back to top</A></p><h2>System 7 applications need to be background-capable</h2><P>Date Written:  8/1/91</p><P>Last reviewed:  6/14/93</p><p>Do all System 7-savvy programs need to run with background processingenabled?</p><p>Yes, System 7-savvy applications should have the <code>SIZE</code> resource's backgroundprocessing bit set. (It's not documented explicitly that you need to have thisbit set.)</p><p>All System 7 Apple event-aware applications need to be background-capable,since there are many instances where Apple events will come in to you whileyou're in the background, and there will be many times (as new applications aredeveloped) when you will not come to the front to process a series of events;you'll work in the background as a client for another application.</p><p>You don't want to hog a lot of system time when you have nothing to do in thebackground, but with the Edition Manager you do need to be able to receiveevents while you're in the background. However, you can still besystem-friendly when you do this. Here's one way: When you're switched into thebackground, set your sleep time to <code>MAXLONGINT</code> and make sure you have an emptymouse region. This way, you'll be getting null events very rarely, and youwon't be taking much time away from other applications, but you can still reactto events sent to you by other parts of the system. Then when you come forward,you can reset your sleep time to your normal, low, frontmost sleep.</p><p>Note that <code>WaitNextEvent</code> is implemented when running System 6 withoutMultiFinder, but there's no DA Handler ensuring that DAs receive time. In thiscase, large sleep values prevent DAs from receiving timely <code>accRun</code> calls--theAlarm Clock DA stops ticking, for example. A compromise that doesn't hog toomuch processing time is to use sleep values only as large as 30-60 ticks forSystem 6.</p><p><A HREF="#top">Back to top</A></p><h2>Help balloons &amp; OSEventAvail between BeginUpdate &amp; EndUpdate</h2><P>Date Written:  8/2/91</p><P>Last reviewed:  6/14/93</p><p>Random garbage is occasionally displayed on the screen if a Macintosh helpballoon goes away due to an <code>OSEventAvail</code> call when a screen refresh is takingplace. Is it possible that the Help Manager code isn't entirely cool if ithides a balloon between a <code>BeginUpdate</code> and <code>EndUpdate</code>?</p><p>Yes, this is particularly nasty. Here's the deal:</p><p><code>OSEventAvail</code> does do balloon maintenance. This is a problem, because<code>OSEventAvail</code> is documented as to NOT move memory, but when balloons are active,it does sometimes. Beyond this, which is really a bad thing, it is still aproblem for updates that allow interrupting, such as yours.</p><p>Your problem isn't that it moves memory. What it does do is recalculate<code>visRgns</code>, due to the balloon moving. The balloons are actually windows, and theHelp Manager has its own WDEF that does the funny balloon shapes. When aballoon/window is moved, the <code>visRgns</code> have to be recalculated to reflect whathas been covered or exposed. This is normally fine, but it is a really badthing between <code>BeginUpdate</code> and <code>EndUpdate</code>.</p><p><code>BeginUpdate</code> first caches the <code>visRgn</code>. It then localizes the <code>updateRgn</code>. It thenintersects the <code>visRgn</code> and <code>updateRgn</code> and places the result in the <code>visRgn</code>. Itthen clears the <code>updateRgn</code>. You are now ready to update just the portion ofthe window that needs updating.</p><p>The problem is that you are making a call to <code>OSEventAvail</code> between <code>BeginUpdate</code>and <code>EndUpdate</code> with balloons active, and somebody moves the mouse. The balloontherefore moves, the <code>visRgns</code> are recalculated, and the window being updated nowhas a new <code>visRgn</code>.</p><p>This would not be bad, except that the <code>visRgn</code> that was cached when<code>BeginUpdatewas</code> called reflects the balloon's old position. When <code>EndUpdate</code> iscalled, the <code>visRgn</code> for the window just updated will be restored to what it wasbefore the balloon moved.</p><p>This now means that there is possibly an area on the screen that is sharedbetween the updated window and the balloon window, plus a possible area thatshould be in a window, and is no longer. Obviously, this is really bad.</p><p>The only thing that I can think of to do is the following:</p><ol type="1" start="1">	<li>Call <code>BeginUpdate</code>, as usual.</li>	<li>Copy the resultant <code>visRgn</code> into the <code>clipRgn</code>.</li>	<li>Call <code>EndUpdate</code></li>	<li>Draw to the window as you would for a normal update. (Your normal update also calls <code>OSEventAvail</code> every so often to see if it should interrupt.)</li></ol><p>What this accomplishes is that the clipping for the area that doesn't needupdating is no longer done with the <code>visRgn</code>. It is done with the <code>clipRgn</code>instead. This will not be affected by any balloons moving. Also, after the<code>EndUpdate</code>, there is no longer a cached copy of the window's <code>visRgn</code>, andtherefore the balloon window can move and not mess up <code>visRgns</code>.</p><p>The above general technique should take care of the problem for you. At thispoint, there isn't a resolution to this problem -- only a workaround. It is badthat <code>OSEventAvail</code> can move memory, as it was documented not to. The problem isthat the Help Manager needs to do stuff at this time, and this may involvemoving the balloon window.</p><p>DTS recommends making your code safe from this problem with the aboveworkaround, and to also see if you can be hurt by memory moving when<code>OSEventAvail</code> is called in general.</p><P><A HREF="#top">Back to top</A></p><h2>Macintosh Finder and DoubleTime global</h2><P>Date Written:  8/23/91</p><P>Last reviewed:  10/8/91</p><p>How does the Macintosh Finder interpret the <code>DoubleTime</code> global? It seems theFinder doesn't use <code>DoubleTime</code> the way it's documented in <i>InsideMacintosh.</i></p><p>The ratio of ticks to value of <code>DoubleTime</code> is 1:1--that is, the number in the<code>DoubleTime</code> variable <i>(Inside Macintosh</i> Volume I, page 260) is, in fact,the number of ticks between a mouse up and a mouse down. Of course, this is nothow the Finder works. The Finder multiplies the <code>DoubleTime</code> variable by 2 todetermine double click time. It does this to account for user problems thatoccur while the user is arranging icons. Thus, the hard-and-fast answer is theFinder uses <code>DoubleTime</code>*2, and the rest of the system just uses DoubleTime.</p><p>By the way, the Finder does not limit the double-time variable to 64 ticks. Ittreats it like a byte in most places, although in some places it is treatedlike a longword. However, clipping it at 64 ticks would be the best methodsince that would provide a 1 second double click (two second in the Finder),which is long enough for anyone.</p><p>Applications should use <code>DoubleTime</code> as documented in the manual, not as it'sused by the Finder.</p><P><A HREF="#top">Back to top</A></p><h2>Events and switching between Macintosh applications</h2><P>Date Written:  830/91</p><P>Last reviewed:  6/14/93</p><p>After an application in the System 7 Application or Apple menu is selected,sometimes control doesn't switch from our application to the selectedapplication. What could be wrong and how can I zero in on the problem?</p><p>The symptoms you've described--the process menu not switching layers--isexactly what happens if you have an activate or update event pending thatyou're not acting on. Here are ways that pending activate or update events canbe handled incorrectly:</p><ul type="disc">	<li>You're not calling <code>BeginUpdate</code> and <code>EndUpdate</code> (the most likely problem).</li>	<li>Your application isn't asking for all events.</li>	<li>Your application has dueling event loops.</li>	<li>The word in your code that contains the everyEvent constant is trashed (unlikely).</li></ul><P><A HREF="#top">Back to top</A></p><h2>PostHighLevelEvent and sending low-level messages</h2><P>Date Written:  8/23/91</p><P>Last reviewed:  6/14/93</p><p>It looks as though the Event Manager routine <code>PostHighLevelEvent</code> could be(ab)used to send low-level messages, like phony mouse clicks and keystrokes.Would this work?</p><p>No; unfortunately, this won't work. A few reasons why:</p><ul type="disc">	<li>The only applications that will receive high-level events (and their descendants, like Apple events) are applications that have their HLE bit set in their <code>SIZE</code> resource. If you try to send (or post) an HLE to an older application you'll get an error from the PPC Toolbox telling you that there's no port available.</li>	<li>There's no system-level translator to convert these things. There are currently translators to change some Apple events. Specifically, the Finder will translate any "puppet string" event into puppet strings for non-System 7 applications (<code>odoc</code>, <code>pdoc</code>, and <code>quit</code>), but these are very special.</li>	<li>The only way to send user-level events such as mouse clicks through HLEs is to use the Apple events in the MiscStndSuite shown in the Apple Event Registry. And all those events assume that the receiving application will do the actual translations to user actions themselves.</li>	<li>HLEs come in through the event loop. So even if it were possible (through some very nasty patching to <code>WaitNextEvent</code>) to force an HLE into a non-HLE-aware application, the event would come in with an event code of 23 (kHighLevel) and the targeted application would just throw it away.</li></ul><p>So the answer is that you can't send user-level events to an HLE-awareapplication. If you want to drive the interface of an old application in System7, you have to use the same hacky method you used under all previous systems.This, by the way, is one of the main reasons why MacroMaker wasn't revised forSystem 7. Apple decided that it wasn't supportable and that we would wait forapplications to update to System 7 and take advantage of third-party Appleevent scripting systems.</p>         <a name="Downloads"></a>       <P><A HREF="#top">Back to top</A></p><h2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (60K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tb_530.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tb/tb_530.html%3Fid%3DDTS10002799-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tb/tb_530.html%3Fid%3DDTS10002799-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tb/tb_530.html%3Fid%3DDTS10002799-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>