<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>NSPersistentDocument Core Data Tutorial: A Sheet for Creating a New Employee</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="A Sheet for Creating a New Employee"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP40001799-CH284" title="A Sheet for Creating a New Employee"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000416" target="_top">Cocoa</a> &gt; <a href="../../../DataManagement-date.html#//apple_ref/doc/uid/TP30000440-TP30000416-TP30000445" target="_top">Data Management</a> &gt; <a href="../00_Introduction/introduction.html#//apple_ref/doc/uid/TP40002828-SW1">NSPersistentDocument Core Data Tutorial</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../07_Metadata/metadata.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../RevisionHistory/revisionHistory.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP40001799-CH284-SW2" title="A Sheet for Creating a New Employee"></a><h1>A Sheet for Creating a New Employee</h1><p>It is possible to use the existing application to create new employees. The Add button that is part of the automatically-created user interface is connected to the <code>add:</code> method of the Employee array controller. If you click on the button, a new instance of the array controller's entity is added to its content array. Sometimes, though, you might want a more sophisticated user interface. Specifically, some applications use a sheet to allow the user to fill in details about a new entry, and optionally discard the new entry before it is committed. An example of how this could be implemented in the current project is illustrated in <span class="content_text"><a href="creationSheet.html#//apple_ref/doc/uid/TP40001799-CH284-SW1">Figure 8-1</a></span>.</p><br/><div><a name="//apple_ref/doc/uid/TP40001799-CH284-SW1" title="Figure 8-1Creating a new employee using a sheet"></a><p><strong>Figure 8-1&nbsp;&nbsp;</strong>Creating a new employee using a sheet</p><img src = "../Art/newemployeesheet_grab.jpg" alt = "" ></div><br/><p>In following this section, recall that you are expected to have mastered fundamental Cocoa tools and techniques (see <span class="content_text"><a href="../00_Introduction/introduction.html#//apple_ref/doc/uid/TP40002828-SW1">“Introduction to NSPersistentDocument Core Data Tutorial”</a></span>)—basic tasks such as connecting outlets and establishing bindings in Interface Builder are not described in detail.</p>
<!-- This template is being used for both PDF and HTML. -->

    
    <h4>In this section:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="creationSheet.html#//apple_ref/doc/uid/TP40001799-CH284-SW4">Design Considerations</a>
				
			<br/>
			
        
			
			
				<a href="creationSheet.html#//apple_ref/doc/uid/TP40001799-CH284-SW5">Implementation Overview</a>
				
			<br/>
			
        
			
			
				<a href="creationSheet.html#//apple_ref/doc/uid/TP40001799-CH284-SW6">Declaring and Setting up NewObjectSheetController</a>
				
			<br/>
			
        
			
			
				<a href="creationSheet.html#//apple_ref/doc/uid/TP40001799-CH284-SW10">Implement the NewObjectSheetController Class</a>
				
			<br/>
			
        
			
			
				<a href="creationSheet.html#//apple_ref/doc/uid/TP40001799-CH284-SW17">Supporting Undo</a>
				
			<br/>
			
        
			
			
				<a href="creationSheet.html#//apple_ref/doc/uid/TP40001799-CH284-SW20">What Happened?</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP40001799-CH284-SW4" title="Design Considerations"></a><h2>Design Considerations</h2><p>There are a number of issues to consider in implementing the sheet. To create a new employee instance, you need a managed object context. A more subtle—but profound—aspect is that you should isolate any changes from the document, so that adding the new employee is a single action that can be undone in a single action. Moreover, it should be possible (if the user clicks Cancel) to discard the new instance without affecting the undo stack in the document.</p><p>Together, these constraints suggest a new pattern, where the sheet uses a separate managed object context. The new employee is inserted into this context when the sheet is created. If the user clicks the Add button, the employee is added to the document's main context. If the user clicks the Cancel button, the new employee is deleted and the sheet's context reset—the document's context remains unchanged.</p><p>The implementation shown here is but one of several possibilities. Management of the sheet and the managed object context are factored into a separate controller, distinct from the document object. This largely follows the coordinator design pattern (discussed in <span class="content_text"><a href="../../CocoaFundamentals/CocoaDesignPatterns/CocoaDesignPatterns.html#//apple_ref/doc/uid/TP40002974-CH6-SW77" target="_top">“Model-View-Controller in Cocoa (Mac OS X)”</a></span> in <em><a href="../../CocoaFundamentals/index.html#//apple_ref/doc/uid/TP40002974" target="_top">Cocoa Fundamentals Guide</a></em>). The goal here, though, is primarily to illustrate the use of Core Data, with comparatively few distractions; it also aims to be fairly reusable. You can adapt what you learn in the tutorial to your own needs. Which approach you take for your own project will depend on the constraints that are specific to your application.</p><a name="//apple_ref/doc/uid/TP40001799-CH284-SW5" title="Implementation Overview"></a><h2>Implementation Overview</h2><p>There are several separate steps to the implementation. You need to define the functionality of a new class—the new employee sheet controller—and create a new nib file that contains the sheet.</p><ol class="ol"><li class="li"><p>The new employee controller needs to be able to do several things. It must coordinate its own managed object context—which must be configured using the managed object model from the document. The controller must also be able to add the new employee to the document's Department object's employees relationship. To do this, it needs access to that relationship, and again to the document's managed object model.</p><p>The simplest way to satisfy all these needs is to give the new employee controller an outlet to the employees array controller. The array controller gives access to the document's managed object context (to which it is bound), gives the new employee controller an easy way to create a new Employee instance, and (since it manages it) a means to insert the new Employee into the Department's employees relationship. </p></li><li class="li"><p>One issue with creating the new top-level object in the nib file is that when you use bindings an object retains other objects to which it is bound. This means that bindings must be broken to ensure there are no retain cycles when a document is closed. Moreover, since the nib file the new controller owns contains top level objects and the controller’s class does not inherit from <code>NSWindowController</code>, you need to release the top level objects when the window is closed.</p></li><li class="li"><p>You need to support undo in the sheet.</p></li></ol><a name="//apple_ref/doc/uid/TP40001799-CH284-SW6" title="Declaring and Setting up NewObjectSheetController"></a><h2>Declaring and Setting up NewObjectSheetController</h2><p>Create in the project the files for a new class called <code>NewObjectSheetController</code>. An instance of this class is responsible for creating and managing the sheet for the new Employee object and for coordinating data between the sheet and the document. </p><a name="//apple_ref/doc/uid/TP40001799-CH284-SW7" title="The header file"></a><h3>The header file</h3><p>The sheet controller uses a private managed object context. It also needs to be able to access the document window, the employees array controller, an object controller in its own nib file, and the sheet. Add to the interface suitable instance variables for all these.</p><div class="codesample"><table><tr><td scope="row"><pre>@interface NewObjectSheetController : NSObject<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    NSWindow *documentWindow;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSArrayController *sourceArrayController;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSObjectController *newObjectController;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSPanel *newObjectSheet;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    NSManagedObjectContext *managedObjectContext;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>To complete the interface, add the property and method declarations. The controller needs to provide accessor methods for accessing the managed object contexts, and action methods to launch the sheet, dismiss the sheet, and support undo and redo. </p><div class="codesample"><table><tr><td scope="row"><pre>@property (nonatomic, retain) IBOutlet NSWindow *documentWindow;<span></span></pre></td></tr><tr><td scope="row"><pre>@property (nonatomic, retain) IBOutlet NSArrayController *sourceArrayController;<span></span></pre></td></tr><tr><td scope="row"><pre>@property (nonatomic, retain) IBOutlet NSObjectController *newObjectController;<span></span></pre></td></tr><tr><td scope="row"><pre>@property (nonatomic, retain) IBOutlet NSPanel *newObjectSheet;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@property (nonatomic, retain, readonly) NSManagedObjectContext *managedObjectContext;<span></span></pre></td></tr><tr><td scope="row"><pre>@property (nonatomic, retain, readonly) NSManagedObjectContext *documentManagedObjectContext;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (IBAction)add:(id)sender;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (IBAction)complete:sender;<span></span></pre></td></tr><tr><td scope="row"><pre>- (IBAction)cancelOperation:sender;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (IBAction)undo:sender;<span></span></pre></td></tr><tr><td scope="row"><pre>- (IBAction)redo:sender;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@end<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001799-CH284-SW8" title="Update the Document nib File"></a><h3>Update the Document nib File</h3><p>You need to add an instance of the sheet controller in the document nib file and configure it appropriately.</p><ul class="spaceabove"><li class="li"><p>Import the <code>NewObjectSheetController</code> header file into MyDocument.nib, then instantiate an instance.</p></li><li class="li"><p>Connect the outlets as follows:</p><p>Connect <code>documentWindow</code> to the document window.</p><p>Connect <code>sourceArrayController</code> to the Employees array controller.</p></li><li class="li"><p>Now disconnect the Add button from the array controller, and set its target to be the sheet controller and the action to be <code>add:</code>.</p></li></ul><br/><div><img src = "../Art/ibNewSheetController.jpg" alt = "image: ../Art/ibNewSheetController.jpg" ></div><br/><a name="//apple_ref/doc/uid/TP40001799-CH284-SW9" title="Create and Configure the Sheet Controller nib File"></a><h3>Create and Configure the Sheet Controller nib File</h3><p>The next stage is to create and configure the user interface for the sheet. </p><ul class="spaceabove"><li class="li"><p>Create a new nib file named “NewEmployeeSheet” and add it to the project.</p></li><li class="li"><p>Import the header file for the <code>NewObjectSheetController</code> class into the nib file. Set the File’s Owner to be an instance of <code>NewObjectSheetController</code>. </p></li><li class="li"><p>Add an <code>NSObjectController</code> instance to the nib file. Set its entity to be Employee.</p><p>Bind the <code>managedObjectContext</code> binding of the <code>NSObjectController</code> instance to the <code>managedObjectContext</code> key of File’s Owner. </p></li><li class="li"><p>Connect the File’s Owner’s <code>newObjectController</code> outlet to the object controller.</p></li><li class="li"><p>Add an <code>NSPanel</code> instance to the nib file.</p><p>Switch off its Visible at Launch flag.</p></li><li class="li"><p>Add user interface elements to the panel so that it looks like the image below.</p><div class="item_figure"><img src = "../Art/ibNewEmployeeSheet.jpg" alt = "image: ../Art/ibNewEmployeeSheet.jpg" ></div></li><li class="li"><p>Connect the File’s Owner’s <code>newObjectSheet</code> outlet to the panel.</p></li><li class="li"><p>Connect the panel’s <code>delegate</code> outlet to the File’s Owner.</p></li><li class="li"><p>Bind the values of the text fields to the appropriate attribute in the object controller. For example, bind the value of the First Name text field to the object controller’s <code>selection.firstName</code> key path. Ensure that the “Validates Immediately” option is selected.</p></li><li class="li"><p>Set number formatters for the Salary and Employee ID text fields.</p></li><li class="li"><p>Set up the target and action for the Add and Cancel buttons. The target is File’s Owner, the actions are <code>complete:</code> and  <code>cancelOperation:</code> respectively.</p></li></ul><a name="//apple_ref/doc/uid/TP40001799-CH284-SW10" title="Implement the NewObjectSheetController Class"></a><h2>Implement the NewObjectSheetController Class</h2><a name="//apple_ref/doc/uid/TP40001799-CH284-SW11" title="Managed Object Contexts"></a><h3>Managed Object Contexts</h3><p>You need access to two different managed object contexts—one from the source array controller (the document's context), and one for the sheet controller itself. You can implement a simple accessor for the source array controller, whereas the sheet controller's accessor lazily creates the context on demand. You set the persistent store coordinator for the controller’s context to be the same as that of the document context. </p><p>Implement the <code>managedObjectContext</code> and <code>documentManagedObjectContext</code> methods as follows:</p><a name="//apple_ref/doc/uid/TP40001799-CH284-SW12" title="Listing 8-1Managed object context accessor methods"></a><p class="codesample"><strong>Listing 8-1&nbsp;&nbsp;</strong>Managed object context accessor methods</p><div class="codesample"><table><tr><td scope="row"><pre>- (NSManagedObjectContext *)documentManagedObjectContext {<span></span></pre></td></tr><tr><td scope="row"><pre>    return [sourceArrayController managedObjectContext];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (NSManagedObjectContext *)managedObjectContext {<span></span></pre></td></tr><tr><td scope="row"><pre>    if (managedObjectContext == nil) {<span></span></pre></td></tr><tr><td scope="row"><pre>        managedObjectContext = [[NSManagedObjectContext alloc] init];<span></span></pre></td></tr><tr><td scope="row"><pre>        [managedObjectContext setPersistentStoreCoordinator:<span></span></pre></td></tr><tr><td scope="row"><pre>            [[self documentManagedObjectContext] persistentStoreCoordinator]];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    return managedObjectContext;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001799-CH284-SW3" title="Setting up the Sheet"></a><h3>Setting up the Sheet</h3><p>You configure the sheet in the <code>add:</code> method. The first step is to load the nib file, if necessary. </p><div class="codesample"><table><tr><td scope="row"><pre>- (IBAction)add:sender {<span></span></pre></td></tr><tr><td scope="row"><pre>    if (newObjectSheet == nil) {<span></span></pre></td></tr><tr><td scope="row"><pre>        NSBundle *myBundle = [NSBundle bundleForClass:[self class]];<span></span></pre></td></tr><tr><td scope="row"><pre>        NSNib *nib = [[NSNib alloc] initWithNibNamed:@"NewEmployeeSheet" bundle:myBundle];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        BOOL success = [nib instantiateNibWithOwner:self topLevelObjects:nil];<span></span></pre></td></tr><tr><td scope="row"><pre>        if (success != YES) {<span></span></pre></td></tr><tr><td scope="row"><pre>            // should present error<span></span></pre></td></tr><tr><td scope="row"><pre>            return;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    // implementation continues...<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>You next need to create a new Employee instance. The easiest way is to use the object controller’s <code>newObject</code> method. It is also useful to disable undo registration to ensure that the user cannot undo the creation of the new object. This is similar to the initialization of the Department object for a new document.</p><div class="codesample"><table><tr><td scope="row"><pre>    NSUndoManager *undoManager = [[self managedObjectContext] undoManager];<span></span></pre></td></tr><tr><td scope="row"><pre>    [undoManager disableUndoRegistration];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    id newObject = [newObjectController newObject];<span></span></pre></td></tr><tr><td scope="row"><pre>    [newObjectController addObject:newObject];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    [[self managedObjectContext] processPendingChanges];<span></span></pre></td></tr><tr><td scope="row"><pre>    [undoManager enableUndoRegistration];<span></span></pre></td></tr></table></div><p>Finally, you need to display the sheet. Use the <code>NSApplication</code> method, <code><a href="../../../Reference/ApplicationKit/Classes/NSApplication_Class/Reference/Reference.html#//apple_ref/occ/instm/NSApplication/beginSheet:modalForWindow:modalDelegate:didEndSelector:contextInfo:" target="_top">beginSheet:modalForWindow:modalDelegate:didEndSelector:contextInfo:</a></code>, and pass <code>newObjectSheetDidEnd:returnCode:contextInfo:</code> as the selector.</p><div class="codesample"><table><tr><td scope="row"><pre>    [NSApp beginSheet:newObjectSheet<span></span></pre></td></tr><tr><td scope="row"><pre>            modalForWindow:documentWindow<span></span></pre></td></tr><tr><td scope="row"><pre>            modalDelegate:self<span></span></pre></td></tr><tr><td scope="row"><pre>            didEndSelector:@selector(newObjectSheetDidEnd:returnCode:contextInfo:)<span></span></pre></td></tr><tr><td scope="row"><pre>            contextInfo:NULL];<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001799-CH284-SW13" title="Responding to Sheet Dismissal"></a><h3>Responding to Sheet Dismissal</h3><p>Implement the action methods for the Add and Cancel buttons (see also <code><a href="../../../Reference/ApplicationKit/Classes/NSResponder_Class/Reference/Reference.html#//apple_ref/occ/instm/NSResponder/complete:" target="_top">complete:</a></code> and <code><a href="../../../Reference/ApplicationKit/Classes/NSResponder_Class/Reference/Reference.html#//apple_ref/occ/instm/NSResponder/cancelOperation:" target="_top">cancelOperation:</a></code>). Both end the sheet, but with different return codes. Note that the add method also invokes <code><a href="../../../Reference/ApplicationKit/Classes/NSController_Class/Reference/Reference.html#//apple_ref/occ/instm/NSController/commitEditing" target="_top">commitEditing</a></code> on the object controller—this ensures that if the user has started editing a field, the pending changes are committed.</p><a name="//apple_ref/doc/uid/TP40001799-CH284-SW14" title="Listing 8-2Action methods for the Add and Cancel buttons."></a><p class="codesample"><strong>Listing 8-2&nbsp;&nbsp;</strong>Action methods for the Add and Cancel buttons.</p><div class="codesample"><table><tr><td scope="row"><pre>- (IBAction)complete:sender {<span></span></pre></td></tr><tr><td scope="row"><pre>    [newObjectController commitEditing];<span></span></pre></td></tr><tr><td scope="row"><pre>    [NSApp endSheet:newObjectSheet returnCode:NSOKButton];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (IBAction)cancelOperation:sender {<span></span></pre></td></tr><tr><td scope="row"><pre>    [NSApp endSheet:newObjectSheet returnCode:NSCancelButton];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>When the sheet actually ends, you must respond accordingly in the implementation of <code>newObjectSheetDidEnd:returnCode:contextInfo:</code> (the method you defined in <span class="content_text"><a href="creationSheet.html#//apple_ref/doc/uid/TP40001799-CH284-SW3">“Setting up the Sheet”</a></span> as the callback for the sheet). If the user pressed Add button, you make a new instance of a managed object using the source array controller, and copy the copy attributes from the sheet's managed object.</p><p>Whichever button was pressed, you set the content of the sheet's object controller to <code>nil</code>, and reset the context (this disposes of all changes). Finally, you order out the sheet. </p><div class="codesample"><table><tr><td scope="row"><pre>- (void)newObjectSheetDidEnd:(NSWindow *)sheet<span></span></pre></td></tr><tr><td scope="row"><pre>    returnCode:(int)returnCode<span></span></pre></td></tr><tr><td scope="row"><pre>    contextInfo:(void  *)contextInfo {<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    NSManagedObject *sheetObject = [newObjectController content];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (returnCode == NSOKButton) {<span></span></pre></td></tr><tr><td scope="row"><pre>        NSManagedObject *newObject = [sourceArrayController newObject];<span></span></pre></td></tr><tr><td scope="row"><pre>        [newObject setValuesForKeysWithDictionary:<span></span></pre></td></tr><tr><td scope="row"><pre>            [sheetObject dictionaryWithValuesForKeys:[[newObject class] keysToBeCopied]]];<span></span></pre></td></tr><tr><td scope="row"><pre>        [sourceArrayController addObject:newObject];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    [newObjectController setContent:nil];<span></span></pre></td></tr><tr><td scope="row"><pre>    [[self managedObjectContext] reset];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    [newObjectSheet orderOut:self];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>To suppress compiler warnings for the use of the custom method (<code>keysToBeCopied</code>) in the Employee class, you must import the Employee header file. At the top of the implementation file, add:</p><div class="codesample"><table><tr><td scope="row"><pre>#import "Employee.h"<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001799-CH284-SW15" title="Tidying Up"></a><h3>Tidying Up</h3><p>To take care of memory management details, the sheet controller must dispose of the sheet and the object controller when the document closes. It must also dispose of the managed object context on <code>dealloc</code>. Implement an <code>awakeFromNib</code> method to register for window closing notification from the document's window, and implement the corresponding method (<code>documentWindowWillClose:</code>) to autorelease <code>newObjectSheet</code> and <code>newObjectController</code>.</p><a name="//apple_ref/doc/uid/TP40001799-CH284-SW16" title="Listing 8-3Tidying up methods"></a><p class="codesample"><strong>Listing 8-3&nbsp;&nbsp;</strong>Tidying up methods</p><div class="codesample"><table><tr><td scope="row"><pre>- (void)awakeFromNib {<span></span></pre></td></tr><tr><td scope="row"><pre>    [[NSNotificationCenter defaultCenter] addObserver:self<span></span></pre></td></tr><tr><td scope="row"><pre>            selector:@selector(documentWindowWillClose:)<span></span></pre></td></tr><tr><td scope="row"><pre>            name:NSWindowWillCloseNotification<span></span></pre></td></tr><tr><td scope="row"><pre>            object:documentWindow];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)documentWindowWillClose:(NSNotification *)note {<span></span></pre></td></tr><tr><td scope="row"><pre>    [[NSNotificationCenter defaultCenter]<span></span></pre></td></tr><tr><td scope="row"><pre>        removeObserver:self name:nil object:nil];<span></span></pre></td></tr><tr><td scope="row"><pre>    [newObjectSheet autorelease];<span></span></pre></td></tr><tr><td scope="row"><pre>    [newObjectController autorelease];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001799-CH284-SW17" title="Supporting Undo"></a><h2>Supporting Undo</h2><p>Although there are only four fields in the sheet, it is still useful to properly support undo—especially if you adapt the techniques described here to a larger task. There are two main steps to this. First, you have to ensure that the sheet uses the sheet controller’s managed object context’s undo manager and direct undo and redo actions to the undo manager. Second, to ensure the user interface is consistent, you should implement the <code>validateUserInterfaceItem:</code> method.</p><a name="//apple_ref/doc/uid/TP40001799-CH284-SW18" title="Accessing the undo manager"></a><h3>Accessing the undo manager</h3><p>First, implement <code><a href="../../../Reference/ApplicationKit/Classes/NSWindow_Class/Reference/Reference.html#//apple_ref/occ/instm/NSObject/windowWillReturnUndoManager:" target="_top">windowWillReturnUndoManager:</a></code> to return the private managed object context’s undo manager:</p><div class="codesample"><table><tr><td scope="row"><pre>- (NSUndoManager *)windowWillReturnUndoManager:(NSWindow *)sender {<span></span></pre></td></tr><tr><td scope="row"><pre>    return [[self managedObjectContext] undoManager];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Next, implement <code>undo:</code> and <code>redo:</code> methods to direct the actions to the context’s undo manager.</p><div class="codesample"><table><tr><td scope="row"><pre>- (IBAction)undo:sender {<span></span></pre></td></tr><tr><td scope="row"><pre>    [[[self managedObjectContext] undoManager] undo];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (IBAction)redo:sender {<span></span></pre></td></tr><tr><td scope="row"><pre>    [[[self managedObjectContext] undoManager] redo];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001799-CH284-SW19" title="Validating user interface items"></a><h3>Validating user interface items</h3><p>To validate menu items correctly, you implement the <code><a href="../../../Reference/ApplicationKit/Protocols/NSUserInterfaceValidations_Protocol/Reference/Reference.html#//apple_ref/occ/intfm/NSUserInterfaceValidations/validateUserInterfaceItem:" target="_top">validateUserInterfaceItem:</a></code> method to return the appropriate value. For more details, see <em><a href="../../UIValidation/index.html#//apple_ref/doc/uid/10000040i" target="_top">User Interface Validation</a></em>.</p><div class="codesample"><table><tr><td scope="row"><pre>- (BOOL)validateUserInterfaceItem:(id &lt;NSValidatedUserInterfaceItem>)anItem {<span></span></pre></td></tr><tr><td scope="row"><pre>    if ([anItem action] == @selector(undo:)) {<span></span></pre></td></tr><tr><td scope="row"><pre>        return [[[self managedObjectContext] undoManager] canUndo];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    if ([anItem action] == @selector(redo:)) {<span></span></pre></td></tr><tr><td scope="row"><pre>        return [[[self managedObjectContext] undoManager] canRedo];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    return YES;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001799-CH284-SW20" title="What Happened?"></a><h2>What Happened?</h2><p>In this section, you followed the coordinator design pattern to create a new controller object that is responsible for managing a sheet used to create a new object. The controller uses a separate managed object context to keep the new managed object, and edits to the new managed object, discrete from the document..</p>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../07_Metadata/metadata.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../RevisionHistory/revisionHistory.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2005, 2009 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2009-02-04<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Cocoa/Conceptual/NSPersistentDocumentTutorial/08_CreationSheet/creationSheet.html%3Fid%3DTP40001799-3.3&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Cocoa/Conceptual/NSPersistentDocumentTutorial/08_CreationSheet/creationSheet.html%3Fid%3DTP40001799-3.3&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Cocoa/Conceptual/NSPersistentDocumentTutorial/08_CreationSheet/creationSheet.html%3Fid%3DTP40001799-3.3&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>