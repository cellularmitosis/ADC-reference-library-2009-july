<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN""http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><HEAD><title>Technical Note TN2090: Driver Tuning on Panther or G5</title><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"><meta name="keywords" content="Panther Driver G5"><meta name="Description" content="This technical note explains issues that some developers may see when using their drivers in Panther (the next major version of Mac OS X) or later, along with issues specific to the Power Macintosh G5."><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR=WHITE><a name="//apple_ref/doc/uid/DTS10003107" title="Driver Tuning on Panther or G5"></a><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/Darwin/index.html">Darwin</a> &gt; <a href="../../technicalnotes/Darwin/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><!-- end_header_information --><!-- begin_titles_information --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN2090</div>
<div id="pageheadsub">Driver Tuning on Panther or G5</div>
</h1>
</td></tr></table></CENTER><!-- end_titles_information --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600> <TR> <TD align="left"><!-- begin_document_contents --><TABLE border=0><TR><TD><table border="0" width="300" cellpadding="0" cellspacing="0"><tr><td width=300 align=left scope="row"><img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td></tr><tr bgcolor="#e6e6e6"><td background="images/tnmenubody.gif" width=300 align=left><span id="menutitle">CONTENTS<br><br></span></td></tr><tr bgcolor="#e6e6e6"><td background="images/tnmenubody.gif" width=300 align=left valign=top><!-- begin_toc --><A NAME="TOCTOP"></A><p id="menutext"></p><p id="menutext"><A HREF="#TAN4">Introduction</A><BR><BR><A HREF="#TAN6">Background Info on PCI Address Translation</A><BR><BR><A HREF="#TAN8"><code>IOMemoryDescriptor</code> changes</A><BR><BR><A HREF="#TAN10">VM System and pmap Changes</A><BR><BR><A HREF="#TAN12">Kernel Dependency Changes</A><BR><BR><A HREF="#TAN14">Summary</A><BR><BR></p><!-- end_toc --></td></tr><tr><td width=300 align=left scope="row"><img src="images/tnmenubottom.gif" alt="" width=300 height=16></td></tr></table></TD><TD ALIGN="LEFT" VALIGN="TOP"><P id="introtext">									<P>This technical note explains issues that some developers may see when using their drivers in Panther (the next major version of Mac OS X) or later, along with issues specific to the Power Macintosh G5.</P><!-- begin_date --><H4 ALIGN=center>[Jun 24, 2003]</H4><!-- end_date --></TD></TR></TABLE><BR><BR><A NAME="TAN4"></A><H2>Introduction:</H2><P>This technical note explains issues that some developers may see when using their drivers in Panther or later. These changes were necessitated by a combination of hardware and underlying OS changes; however, you may see problems resulting from the changes even on existing hardware.</P><P>There are three basic areas of change in Panther. These are:</P><OL><LI><code>IOMemoryDescriptor</code> changes<LI>VM system (pmap) changes<LI>Kernel dependency changes</OL><P>These are described in detail in the sections that follow.</P></P><P><A HREF="#TOCTOP">Back to top</A></P><BR><BR><A NAME="TAN6"></A><H2>Background Info on PCI Address Translation:</H2><P>To allow existing device drivers to work with upcoming 64-bit system architectures, a number of changes were required.  To explain these, a brief introduction to PCI bus bridges is needed.</P><P>When a PCI device needs to perform a data transaction to or from main memory, the device driver calls a series of functions intended to prepare this memory for I/O.  In an architecture where both the device drivers and the memory subsystem use 32-bit addressing, everything just works, so long as the memory doesn't get paged out during the I/O operation.  As kernel memory is generally not pageable, the preparation is largely superfluous.</P><P>On a system whose memory subsystem uses 64-bit addressing, however, this becomes a bit of a problem.  Because the hardware devices on the PCI bus can only handle 32-bit addresses, the device can only "see" a 4 gigabyte aperture into the (potentially much larger) main memory at any given time.</P><P>There are two possible solutions for this problem.  The easy (but slow) solution would be to use "bounce buffers".  In such a design, device drivers would copy data into memory specifically allocated within the bottom 4 gigs of memory.  However, this incurs a performance penalty and also puts additional constraints on the lower 4 gigs of memory, causing numerous problems for the VM system.</P><P>The other solution, the one chosen in Apple's 64-bit implementation, is to use address translation to "map" blocks of memory into the 32-bit address space of the PCI devices.  While the PCI device can still only see a 4 gig aperture, that aperture can then be non-contiguous, and thus bounce buffers and other restrictions are unnecessary.  This address translation is done using a part of the memory controller known as DART, which stands for Device Address Resolution Table.</P><P>This introduces a number of potential problems, however.  First, physical addresses as seen by the processor no longer map 1:1 onto the addresses as seen by PCI devices.  Thus, a new term, I/O addresses, is introduced to describe this new view.  Because I/O addresses and physical addresses are no longer the same, the DART must keep a table of translations to use when mapping between them. Fortunately, if your driver is written according to Apple guidelines (using only documented APIs), this process is handled transparently.</P></P><P><A HREF="#TOCTOP">Back to top</A></P><BR><BR><A NAME="TAN8"></A><H2><code>IOMemoryDescriptor</code> changes:</H2><P>When your driver calls <code>IOMemoryDescriptor::prepare</code>, a mapping is automatically injected into the DART.  When it calls <code>IOMemoryDescriptor::release</code>, the mapping is removed.  If you fail to do this, your driver could experience random data corruption or panics.</P><P>Because the DART requires different caching for reads and writes, the DMA direction is important on hardware that includes a DART. While you may receive random failures if the direction is wrong in general (on any system), if you attempt to call <code>WriteBytes</code> on a memory region whose DMA direction is set up for reading, you will cause a kernel panic on 64-bit hardware.</P><P>If you attempt to perform a DMA transaction to unwired (user) memory, on previous systems, you would only get random crashes, panics, and data corruption.  On machines with a DART, you will likely get no data whatsoever.</P><P>As a side-effect of changes in the memory subsystem, Mac OS X is much more likely to return physically contiguous page ranges in memory regions.  Historically, Mac OS X returned multi-page memory regions in reverse order, starting with the last page and moving towards the first page.  The result of this was that multi-page memory regions essentially never had a contiguous range of physical pages.</P><P>Because of the increased probability of seeing physically contiguous blocks of memory in a memory region, this change may expose latent bugs in some drivers that only show up when handling contiguous ranges of physical pages, which could result in incorrect behavior or panics.</P><P>Note that the problems mentioned above are caused by bugs in the drivers, and could result in problems on older hardware prior to Panther. These issues are more likely to occur in Panther and later versions of Mac OS X, however, because of the new hardware designs and the OS changes that were made to support those designs.</P></P><P><A HREF="#TOCTOP">Back to top</A></P><BR><BR><A NAME="TAN10"></A><H2>VM System and pmap Changes:</H2><P>In Panther, as a result of the changes described in detail in the section on PCI address translation, physical addresses obtained directly from the pmap layer have no useful purpose outside the VM system itself. To prevent their inadvertent use in device drivers, the pmap calls are no longer available from kernel extensions.</P><P>A few drivers written prior to the addition of the <code>IOMemoryDescriptor</code> class still use pmap calls to get the physical pages associated with a virtual address.  Also, a few developers have looked at the <code>IOMemoryDescriptor</code> implementation and chosen to obtain addresses directly from the pmap layer to remove what was perceived as an unnecessary abstraction layer.</P><P>Even without removing access to the pmap calls, these drivers would not function on systems with a DART (see the PCI section above for info on DARTs). To better emphasize this upcoming failure, Panther will cause these drivers to fail to load with an undefined symbol error (generally for <code>pmap_extract</code>) even on systems without a DART.</P></P><P><A HREF="#TOCTOP">Back to top</A></P><BR><BR><A NAME="TAN12"></A><H2>Kernel Dependency Changes:</H2><P>Beginning in Panther, device drivers that declare a dependency on version 7 (the Panther version) of the I/O Kit will no longer automatically get symbols from Mach and BSD. This change was made to discourage I/O Kit developers from relying on symbols that are not explicitly approved for use in the I/O Kit.</P><P>Existing drivers are unaffected by this change.  This change only affects you if you explicitly modify your device driver to declare a dependency on version 7 of the I/O Kit to take advantage of new I/O Kit features.</P></P><P><A HREF="#TOCTOP">Back to top</A></P><BR><BR><A NAME="TAN14"></A><H2>Summary:</H2><P>As described above, some device drivers may require minor modifications to support Panther and higher. Apple has made every effort to ensure compatibility with existing device drivers to the greatest extent possible, but a few drivers may break. If your driver breaks, you should first check to see if your driver includes any of the bugs described in the previous sections. If it does not, contact <a href="http://developer.apple.com/products/techsupport/">Apple Developer Technical Support</a> for additional debugging suggestions.</P><!-- end_document_contents --></TD></TR></TABLE></CENTER><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn2090.html%3Fid%3DDTS10003107-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn2090.html%3Fid%3DDTS10003107-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn2090.html%3Fid%3DDTS10003107-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>