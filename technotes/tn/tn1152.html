<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
			"http://www.w3.org/TR/REC-html40/loose.dtd">

<HTML>
<!-- Template 01-05-01 -->
<HEAD>

<LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css">
<LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">


    <title>Technical Note TN1152: JIS Keyboard Support in Mac OS 8</title>
    
    <meta name="keywords" content="Mac OS 8 keyboard JIS  support KMAP key-map resources KBGetLayoutType">
    <meta name="Description" content="Technical Note TN1152: This Technical Note describes the
mechanism introduced in Mac OS 8 to support JIS (Japanese
Industrial Standards) keyboards. This Note discusses keymap
resources, KBGetLayoutType, the keyboard control panel, Kotoeri
2.0 and compatibility guidelines for the JIS Keyboard.">


<meta name="categories" content="System Releases and Text">


<meta name="week-posted" content="Feb 1, 1999 - Feb 5, 1999">

<LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD>

<BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002991" title="JIS Keyboard Support in Mac OS 8"></a>
<A NAME="top"></A>
<!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/index.html" target="_blank">Reference Library</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information -->
<!-- bottom_of_header_marker_comment -->
<!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1152</div>
<div id="pageheadsub">JIS Keyboard Support in Mac OS 8</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment -->


<CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left">
   
<!-- begin_header_box -->
<table width="600" cellpadding="0" cellspacing="0" border="0">
     <tr>
<td width=300 valign="top" align=left scope="row">
    <table border="0" width="300" cellpadding="0" cellspacing="0">
			<tr>            
<td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>
  </tr>
  <tr bgcolor="#e6e6e6">
   <td background="images/tnmenubody.gif" width=300 align=left>
 <span id="menutitle">
CONTENTS 
  <br>
  <br>
 </span>
   </td>
  </tr>
  <tr bgcolor="#e6e6e6">
   <td background="images/tnmenubody.gif" width=300 align=left>
 <!-- begin_toc -->
<P id = "menutext">
        <A HREF = "#JISKeyboards">JIS Keyboards</A><BR><BR>
        <A HREF = "#TheWorldBeforeMacOS8">The World Before Mac OS 8</A><BR><BR>
        <A HREF = "#TheWorldAfterMacOS8">The World After Mac OS 8</A><BR><BR>
        <A HREF = "#Kotoeri2.0">Kotoeri 2.0</A><BR><BR>
        <A HREF = "#Summary">Summary</A><BR><BR>
        <A HREF = "#References">References</A><BR><BR>
        <A HREF = "#Changes">Change History</A><BR><BR>
         <A HREF="#Downloads">Downloadables</A></p>
       <!-- end_toc -->
</td>
  </tr>

  <tr>
   <td width=300 align=left scope="row">
 <img src="images/tnmenubottom.gif" alt="" width=300 height=16>
   </td>
  </tr>
    </table>
</td>
  <td width=300 valign="top" align=left>
            
<!-- begin_intro_text -->
<P id = "introtext">This technote describes the mechanism introduced in Mac OS 8 to support JIS (Japanese Industrial Standards) keyboards. Developers designing input methods or applications that rely on keyboard layout information should read this technote.</P>
     <!-- end_intro_text -->
<!-- begin_date -->
<h3>&nbsp;Updated: [Feb 22 1999]</h3>
<!-- end_date -->
</TD>
 </TR>
    </TABLE>
 <!-- end_header_box -->
<BR><BR>
<hr width=500 align=center>
<BR><BR>      
<!-- begin_content -->      

        <A NAME="JISKeyboards"></A>
        <H2>JIS Keyboards</H2>
        <P>Macintosh keyboards sold in Japan come in two flavors: US and JIS. As the name suggests, US keyboards are identical in layout to keyboards sold in the United States. JIS keyboards are unique to Japan and feature additional key caps designed for input method functions. For example, the iMac keyboard has the following JIS layout in Japan.</P>

<CENTER><img src="images/tn1152_001.gif" width=550 height=183 alt=""><BR>
        <BR>
        <b>Figure 1</b> - The iMac keyboard in Japan</CENTER>
        
        <BR>


<BR><BR><CENTER><TABLE BORDER=0 WIDTH=550>
<TR><td bgcolor="#E6E6E6" align=left>
<P><B>Note:</B><BR>
                JIS (Japanese Industrial Standards) are developed by the Japan Industrial Standards Committee. JIS is a voluntary national standard, similar to ANSI in the United States.</p>
</TD></TR></TABLE></CENTER><BR><BR>

        <A NAME="TheWorldBeforeMacOS8"></A>
        <H2>The World Before Mac OS 8</H2>
        <P>Japanese versions of the Mac OS contain additional resources to accommodate US and JIS keyboard layouts. Prior to Mac OS 8, this took the form of six extra keyboard-layout resources.</P>

        <CENTER><TABLE BORDER=1>
            <TR>
                <td valign="TOP" align=left><B>Name</B></TD>
                <td valign="TOP" align=left><B>Script</B></TD>
                <td valign="TOP" align=left><B>How Japanese characters<BR>are typed</B></TD>
                <td valign="TOP" align=left><B>Keyboard layout</B></TD>
            </TR>
            <TR>
                <td align="left">Kana</TD><td align="left">Japanese</TD><td align="left">Kana</TD><td align="left">US</TD>
            </TR>
            <TR>
                <td align="left">Kana - JIS</TD><td align="left">Japanese</TD><td align="left">Kana</TD><td align="left">JIS</TD>
            </TR>
            <TR>
                <td align="left">Romaji</TD><td align="left">Japanese</TD><td align="left">Romaji</TD><td align="left">US</TD>
            </TR>
            <TR>
                <td align="left">Romaji - JIS</TD><td align="left">Japanese</TD><td align="left">Romaji</TD><td align="left">JIS</TD>
            </TR>
            <TR>
                <td align="left">U.S.</TD><td align="left">Roman</TD><td align="left">N/A</TD><td align="left">US</TD>
            </TR>
            <TR>
                <td align="left">Roman - JIS</TD><td align="left">Roman</TD><td align="left">N/A</TD><td align="left">JIS</TD>
            </TR>
        </TABLE>
        <BR>
        Table 1: Keyboard-layout resources (resource type <CODE>'KCHR'</CODE>) in Mac OS 7.x</CENTER>
        <BR>
        <P>Users were required to configure the correct keyboard-layout resource for each installed script by selecting it in the Keyboard control panel. Since only keyboard-layout resources that belong to the current script are displayed in the control panel, and a Japanese system typically contains two scripts (Japanese and Roman), at least two operations were necessary to specify the type of keyboard attached to the computer.</P>
        <P>For example, in the case of a JIS keyboard, the user would first select "Roman - JIS" in the Keyboard control panel.</P>
        <CENTER><img src="images/tn1152_002.gif" width=235 height=208 alt=""><BR>
        <BR>
        <b>Figure 2</b> - Selecting "Roman - JIS" in the Keyboard control panel</CENTER>
        <BR>
        <P>Next, the user would switch the active script to Japanese (from the script menu), and select "Kana - JIS" or "Romaji -JIS" from the Keyboard control panel, depending on their preferred method of typing.</P>
        <BR>
        <CENTER><img src="images/tn1152_003.gif" width=209 height=106 alt=""><BR>
        <BR>
        <b>Figure 3</b> - Switching the active script to Japanese</CENTER>
        <BR>
        <CENTER><img src="images/tn1152_004.gif" width=235 height=208 alt=""><BR>
        <BR>
        <b>Figure 4</b> - Selecting "Kana - JIS" in the Keyboard control panel</CENTER>
        <BR>


<BR><BR><CENTER><TABLE BORDER=0 WIDTH=550>
<TR><td bgcolor="#E6E6E6" align=left>
<P><B>Note:</B><BR>
                While keyboard selections are persistent across restarts in all versions of the Mac OS, the active script is reset when the computer starts up.</p>
</TD></TR></TABLE></CENTER><BR><BR>
        <P>Selecting an incorrect keyboard type for either Japanese or Roman scripts would cause strange behavior. For example, selecting a non-JIS layout from the Keyboard control panel when a JIS keyboard was in fact connected would result in certain keys not generating <CODE>keyDown</CODE> events. This is because JIS keyboards feature additional keys that are not present on standard US keyboards; in the standard US keyboard-layout resource, non-existent keys are mapped onto nil character codes which do not generate <CODE>keyDown</CODE> events. To make matters worse, some keys actually map onto different characters altogether.</P>
        <P>Another problem prior to Mac OS 8 was the lack of a reliable method to determine whether a keyboard's layout was JIS or not. Input methods circumvented this by maintaining static tables of keyboard IDs that were known to be JIS. By comparing the <CODE>KbdType</CODE> low- memory global variable (<CODE>LMGetKbdType</CODE>) to keyboard IDs in their internal tables, input methods could determine if an arbitrary keyboard was JIS or not. Needless to say, every time Apple shipped a JIS keyboard with a new ID, these hard-coded input methods would break and require updating.</P>
        <P>As if this weren't confusing enough, most input methods bypassed the Keyboard control panel altogether and implemented their own Kana and Romaji settings. So, in fact, it didn't make a difference whether "Romaji / Romaji-JIS" or "Kana / Kana-JIS" was selected in the Keyboard control panel.</P>
   
   
<P><A HREF = "#top">Back to top</a></p>

        <A NAME="TheWorldAfterMacOS8"></A>
        <H2>The World After Mac OS 8</H2>
         
        <P>To remedy the above problems, Apple made the following improvements in Mac OS 8:</P>
         
        <UL>
        <LI><B>New Key-Remap Resources</B>
        
        <P>Instead of requiring users to adjust settings in the Keyboard control panel according to the type of keyboard attached, key-remap resources (resource type <CODE>'itlk'</CODE>) were added to support JIS keyboards in Mac OS 8.0. Since the keyboard type is handled at the key-remap resource level, keyboard layout settings no longer need to be visible to the user. As a result, JIS-specific keyboard layout resources became redundant and were removed.</P>

        <CENTER><TABLE BORDER=1>
            <TR>
                <td valign="TOP" align=left><B>Name</B></TD>
                <td valign="TOP" align=left><B>Script</B></TD>
                <td valign="TOP" align=left><B>How Japanese characters<BR>are typed</B></TD>
                <td valign="TOP" align=left><B>Keyboard layout</B></TD>
            </TR>
            <TR>
                <td align="left">Kana</TD><td align="left">Japanese</TD><td align="left">Kana</TD><td align="left">Any</TD>
            </TR>
            <TR>
                <td align="left">Romaji</TD><td align="left">Japanese</TD><td align="left">Romaji</TD><td align="left">Any</TD>
            </TR>
            <TR>
                <td align="left">U.S.</TD><td align="left">Roman</TD><td align="left">N/A</TD><td align="left">Any</TD>
            </TR>
        </TABLE>
        <BR>
        Table 2: Keyboard-layout resources (resource type <CODE>'KCHR'</CODE>) in Mac OS 8</CENTER>

        <P>By keeping keyboard-layout resources independent of the keyboard type, just three resources are required to support both JIS and non-JIS keyboards.</P></li>
            
        <LI><B>KBGetLayoutType</B>

        <P>A new API, <CODE>KBGetLayoutType</CODE>, was introduced in Mac OS 8.0 to return the layout type (ANSI, JIS, or ISO) of the current keyboard. By using this API, input methods no longer need to hard-code a list of JIS keyboard IDs, and they will remain compatible when Apple introduces new keyboards.

Note: The KeyboardsLib library is required to use this API.</P></li>
            
        <LI><B>A new Keyboard control panel</B>

        <P>With Mac OS 8.0, Apple introduced a new Keyboard control panel. In addition to user interface consolidation and refinements, the new control panel hides keyboard-layout resources for two-byte scripts from the user. This is possible because keyboard layouts are now handled by key-remap resources and responsibility for specifying how Japanese characters are typed (Kana or Romaji) now lies with the input method.</P></li>
        </UL>
        
        <P>The rest of this technote describes each of these improvements in detail.</P>

        <H3>New Key-Remap Resources</H3>

        <P>When a key is pressed, the keyboard generates a raw key code which is mapped onto a virtual key code using a key-map resource (resource type <CODE>'KMAP'</CODE>). The Event Manager uses the appropriate keyboard-layout resource to map this virtual key code onto a more useful character code, which is later passed on to the application in a <CODE>keyDown</CODE> event.

The key-remap resource (resource type <CODE>'itlk'</CODE>) adds an extra conversion layer, mapping the virtual key code generated by the key-map resource onto another virtual key code when it is handled inside <CODE>KeyTranslate</CODE>. For details, see <a href="../../documentation/mac/Text/Text-2.html"><I>Inside Macintosh: Text</I>, Appendix C, C-16</A></P>
        <BR>
        <CENTER><img src="images/tn1152_005.gif" width=400 height=250 alt=""><BR>
        <BR>
        <b>Figure 5</b> - The general flow of a key event with intervention by a key-remap resource.</CENTER>
        <BR>
        <P><B>What happens without the key-remap resource?</B></P>

        <P>When a key is pressed, the key-map resource (resource type <CODE>'KMAP'</CODE>) whose ID matches the keyboard's device ID is used to convert the raw key code into a virtual key code. For example, pressing the "@" key on an JIS Apple Keyboard II (ID = 22) will generate a virtual key code of <CODE>0x21</CODE>. If the currently selected keyboard-layout resource is "Roman - JIS", <CODE>KeyTranslate</CODE> will map <CODE>0x21</CODE> onto <CODE>0x40</CODE>, which is the correct character code for the "@" symbol.</P>
        <BR>
        <CENTER><img src="images/tn1152_006.gif" width=407 height=250 alt=""><BR>
        <BR>
        <b>Figure 6</b> - Pressing "@" on a JIS keyboard with "Roman - JIS" selected.</CENTER>
        <BR>
        <P>However, if the selected keyboard-layout resource is "U.S.", <CODE>KeyTranslate</CODE> will map <CODE>0x21</CODE> onto <CODE>0x5B</CODE>, which is the character code for the open bracket "[".</P>
        <BR>
        <CENTER><img src="images/tn1152_007.gif" width=407 height=250 alt=""><BR>
        <BR>
        <b>Figure 7</b> - Pressing "@" on a JIS keyboard with "U.S." selected.</CENTER>
        <BR>
        <P>In order to generate the correct character code for "@" (<CODE>0x40</CODE>) on a US keyboard with the "U.S." <CODE>'KCHR'</CODE> selected, a virtual key code of <CODE>0x13</CODE> needs to be generated with the Shift Key modifier flag set.</P>
        <BR>
        <CENTER><img src="images/tn1152_008.gif" width=407 height=250 alt=""><BR>
        <BR>
        <b>Figure 8</b> - Generating "@" on a US keyboard with "U.S." selected.</CENTER>
        <BR>
        <P>In order to generate the correct character code for "@" (<CODE>0x40</CODE>) on a JIS keyboard with the "U.S." <CODE>'KCHR'</CODE> selected, a key-remap resource is needed to map the virtual key code onto <CODE>0x13</CODE> and set the Shift Key modifier flag.</P>
        <BR>
        <CENTER><img src="images/tn1152_009.gif" width=407 height=250 alt=""><BR>
        <BR>
        <b>Figure 9</b> - Generating "@" on a JIS keyboard with "U.S." selected.</CENTER>
        <BR>
        <P>In other words, it is possible to generate the correct character on a JIS keyboard with the standard "U.S." <CODE>'KCHR'</CODE>, as long a key-remap resource substitutes the appropriate virtual key code and modifier flags.</P>

        <P><B>JIS keyboards supported in Mac OS 8.5.1</B></P>

        <P>As of Mac OS 8.5.1, support for the following JIS keyboards is integrated into the System file. As new keyboard IDs are issued, they will continue to be incorporated into later versions of the operating system.</P>

        <CENTER><TABLE BORDER=1>
            <TR><td valign="TOP" align=left><B>Keyboard ID</B></TD>
                <td valign="TOP" align=left><B>JIS Keyboard</B></TD>
            </TR>
            <TR>
                <td align="left">18</TD><td align="left">Apple Adjustable Keyboard</TD>
            </TR>
            <TR>
                <td align="left">21</TD><td align="left">PowerBook 500 Series<BR>
                PowerBook 1400 Series<BR>
                PowerBook 3400 Series<BR>
                PowerBook G3 (Original)<BR></TD>
            </TR>
            <TR>
                <td align="left">22</TD><td align="left">Apple Keyboard II</TD>
            </TR>
            <TR>
                <td align="left">23</TD><td align="left">Reserved</TD>
            </TR>
            <TR>
                <td align="left">26</TD><td align="left">Reserved</TD>
            </TR>
            <TR>
                <td align="left">30</TD><td align="left">PowerBook 2400 Series</TD>
            </TR>
            <TR>
                <td align="left">194</TD><td align="left">Reserved</TD>
            </TR>
            <TR>
                <td align="left">197</TD><td align="left">PowerBook G3 Series</TD>
            </TR>
            <TR>
                <td align="left">200</TD><td align="left">iMac<BR>
                Power Macintosh G3 (Blue)</TD>
            </TR>
            <TR>
                <td align="left">201</TD><td align="left">Reserved</TD>
            </TR>
        </TABLE></CENTER>

        <P><B>Key codes affected by key-remap resources</B></P>

        <P>The following key codes may be altered by the key-remap resources in Mac OS 8.</P>

        <CENTER><TABLE BORDER=1>
            <TR>
                <td colspan=3 align=left>
                <B>Keys that are remapped before being passed<BR>
                to the following keyboard-layout resources</B>
                </TD>
            </TR>
            <TR>
                <TD ALIGN="CENTER" align="left"><B>Kana</B></TD>
                <TD ALIGN="CENTER" align="left"><B>Romaji</B></TD>
                <TD ALIGN="CENTER" align="left"><B>U.S.</B></TD>
            </TR>
            <TR>
                <TD ALIGN="CENTER" valign=top align="left"> 0x18<BR>0x5D<BR>0x21<BR>0x1E<BR>0x27<BR>0x2A<BR>0x5E<BR>0x5F<BR>0x66<BR>0x68</TD>
                <TD ALIGN="CENTER" align="left"> 0x13<BR>0x16<BR>0x1A<BR>0x1C<BR>0x19<BR>
                0x1D<BR>0x1B<BR>0x18<BR>0x5D<BR>0x21<BR>
                0x1E<BR>0x29<BR>0x27<BR>0x2A<BR>0x5E<BR>
                0x5F<BR>0x66<BR>0x68</TD>
                <TD ALIGN="CENTER" align="left"> 0x13<BR>0x16<BR>0x1A<BR>0x1C<BR>0x19<BR>
                0x1D<BR>0x1B<BR>0x18<BR>0x5D<BR>0x21<BR>
                0x1E<BR>0x29<BR>0x27<BR>0x2A<BR>0x5E<BR>
                0x5F<BR>0x66<BR>0x68</TD>
            </TR>
        </TABLE></CENTER>

        <H3>KBGetLayoutType</H3>

        <P>Input methods or applications that need to know the type of keyboard attached to the computer (JIS or non-JIS) should use the new <CODE>KBGetLayoutType</CODE> API.</P>

        <P>Since the keyboard library is only present in Japanese versions of Mac OS 8.0 and above, and because of a bug in Mac OS 8.5 (see warning), it is essential to check for availability of the API first (see the following sample code):</P>

        <P>Be sure to <A HREF = "#Downloads">download and link with the keyboard library</A>.</P>


<BR><BR><CENTER><TABLE BORDER=0 WIDTH=550>
<TR><td bgcolor="#E6E6E6" align=left>
<P><B>Warning:</B><BR>
A bug in KeyboardsLib 1.1 that shipped with Mac OS 8.5 causes <CODE>KBGetLayoutType</CODE> to crash under certain circumstances.<BR><BR>
In a twist of fate, the previously undocumented <CODE>'kbds'</CODE> Gestalt selector was removed from KeyboardsLib 1.1 in the transition to a PowerPC-only shared library. The <CODE>'kbds'</CODE> Gestalt selector has been reinstated in KeyboardsLib 1.1.1 (it is now installed and removed in the library's initialization and termination routines), providing a clean way to identify good versions of the library.<BR><BR>
                To run safely on all versions of the Mac OS, Apple recommends that you check for known devices first. Then call <CODE>KBGetLayoutType</CODE>, but only if the <CODE>Gestalt</CODE> selector is present.</p>
</TD></TR></TABLE></CENTER><BR><BR>
            
                  
<BR><BR><CENTER><TABLE BORDER=0 WIDTH=550>
<TR><td bgcolor="#E6E6E6" align=left>
<pre>/*  KBLayout.h  */

#ifndef __MACTYPES__
#include &lt;MacTypes.h&gt;
#endif

#ifdef __cplusplus
extern "C" {
#endif

#if ! defined (__KEYBOARDS__)

enum {
    gestaltKeyboardsLib = FOUR_CHAR_CODE('kbds')     /* Keyboards library */
};

enum
{
    kKeyboardJIS     = 'JIS ',
    kKeyboardANSI    = 'ANSI',
    kKeyboardISO     = 'ISO ',
    kKeyboardUnknown = '????'
};

enum
{
    _KeyboardDispatch = 0xAA7A
};

#pragma import on
extern pascal OSType KBGetLayoutType (short deviceID)
 THREEWORDINLINE(0x303C, 0x0007, _KeyboardDispatch);
#pragma import off

#endif

OSType GetKeyboardLayoutType (short deviceID);

#ifdef __cplusplus
}
#endif

/*  KBLayout.c  */

#include &lt;Gestalt.h&gt;
#include &lt;OSUtils.h&gt;
#include &lt;Traps.h&gt;
#include "KBLayout.h"

Boolean IsKBGetLayoutTypeAvailable (void);

/*  Returns the keyboard layout type.  */

OSType GetKeyboardLayoutType (short deviceID)
{
    OSType keyboardLayoutType;

    switch (deviceID) {
        case 0x01:
        case 0x02:
        case 0x03:
        case 0x06:
        case 0x08:
        case 0x0C:
        case 0x10:
        case 0x18:
        case 0x1B:
        case 0x1C:
        case 0xC0:
        case 0xC3:
        case 0xC6:
            keyboardLayoutType = kKeyboardANSI;
            break;
        case 0x12:
        case 0x15:
        case 0x16:
        case 0x17:
        case 0x1A:
        case 0x1E:
        case 0xC2:
        case 0xC5:
        case 0xC8:
        case 0xC9:
            keyboardLayoutType = kKeyboardJIS;
            break;
        case 0x04:
        case 0x05:
        case 0x07:
        case 0x09:
        case 0x0D:
        case 0x11:
        case 0x14:
        case 0x19:
        case 0x1D:
        case 0xC1:
        case 0xC4:
        case 0xC7:
            keyboardLayoutType = kKeyboardISO;
            break;
        default:
            if (IsKBGetLayoutTypeAvailable ())
                keyboardLayoutType = KBGetLayoutType (deviceID);
            else
                keyboardLayoutType = kKeyboardUnknown;
            break;
    }
    return keyboardLayoutType;
}

/*  Returns true if KBGetLayoutType is available.  */

Boolean IsKBGetLayoutTypeAvailable (void)
{
    long response;

    if (Gestalt (gestaltKeyboardsLib, &amp;response) == noErr)
        return true;
    else
        return false;
}</pre>
</TD></TR></TABLE></CENTER><BR><BR>
                  

        <H3>A new Keyboard control panel</H3>

        <P>The new Keyboard control panel in Mac OS 8 does not list two-byte scripts such as Japanese in the "Script" pop-up menu. Functionality that was previously part of the Keyboard control panel has either been made obsolete or has been incorporated into input methods.</P>
        <CENTER><img src="images/tn1152_010.gif" width=274 height=331 alt=""><BR>
        <BR>
        <b>Figure 10</b> - The Keyboard control panel in Mac OS 8.5</CENTER>

        <H3>Compatibility Gotchas</H3>

        <P>Most existing input methods contain keyboard-layout resources (resource type <CODE>'KCHR'</CODE>) that are switched in or out according to the type of keyboard attached to the computer. These input methods will still work with Mac OS 8, however, there are some compatibility issues to consider:</P>

        <OL>
            <LI><P>With the new key-remap resources, the following keyboard-layout resources became redundant and were removed from the system file. Applications or input methods that depend on these resources need to be updated.</P>
                <CENTER><TABLE BORDER=1>
                    <TR>
                        <td valign="TOP" align=left><B>Name</B></TD>
                        <td valign="TOP" align=left><B>Script</B></TD>
                        <td valign="TOP" align=left><B>How Japanese characters<BR>are typed</B></TD>
                        <td valign="TOP" align=left><B>Keyboard layout</B></TD>
                    </TR>
                    <TR>
                        <td align="left">Kana - JIS</TD><td align="left">Japanese</TD><td align="left">Kana</TD><td align="left">JIS</TD>
                    </TR>
                    <TR>
                        <td align="left">Romaji - JIS</TD><td align="left">Japanese</TD><td align="left">Romaji</TD><td align="left">JIS</TD>
                    </TR>
                    <TR>
                        <td align="left">Roman</TD><td align="left">Roman</TD><td align="left">N/A</TD><td align="left">JIS</TD>
                    </TR>
                </TABLE>
                <BR>
                Table 3: Keyboard-layout (resource type <CODE>'KCHR'</CODE>) resources removed in Mac OS 8</CENTER><BR>
                <BR></li>
            <LI><P>Due to limitations in the structure of key-remap resources, some key combinations do not generate correct character codes. Developers should not use the following key combinations for keyboard shortcuts:</P>

            <UL>
                <LI>Backslash + specific modifier keys<BR>
                <BR>
                Option + [\],<BR>
                Option + Shift + [\],<BR>
                Option + Shift + Command + [\],<BR>
                Option + Shift + Caps lock + [\] and<BR>
                Option + Shift + Command + Caps lock + [\]<BR>
                do not generate a vertical bar (<CODE>0x7C</CODE>) character.<BR><BR></li>

                <LI>The "@" symbol + specific modifier keys<BR>
                <BR>
                Cmd + [@] ,<BR>
                Cmd + Shift + [@],<BR>
                Cmd + Caps + [@] ,<BR>
                Cmd + Shift + Caps + [@],<BR>
                Option + [@],<BR>
                Option + Cmd + [@] ,<BR>
                Option + Cmd + Caps Lock + [@] and<BR>
                Control + any combination of modifier keys + [@]<BR>
                do not generate an "@" (<CODE>0x40</CODE>) character.<BR><BR></li>

                <LI>Colon + specific modifier keys<BR>
                <BR>
                Cmd + [:] <BR>
                Cmd + Shift + [:] ,<BR>
                Cmd + Caps + [:] ,<BR>
                Cmd + Shift + Caps + [:],<BR>
                Option + Shift + [:] ,<BR>
                Option + Shift + Cmd + [:] ,<BR>
                Option + Shift + Caps + [:] ,<BR>
                Option + Shift + Cmd + Caps + [:],<BR>
                Option + [:] and<BR>
                Ctrl + any combination of modifier keys + [:]<BR>
                do not generate a colon (<CODE>0x3A</CODE>) character.<BR><BR></li>

                <LI>Underscore + specific modifier keys<BR>
                <BR>
                Cmd + [_] ,<BR>
                Cmd + Caps + [_],<BR>
                Cmd + Shift + [_] ,<BR>
                Cmd + Shift + Caps Lock + [_],<BR>
                Option + [_],<BR>
                Option + Cmd + [_] ,<BR>
                Option + Cmd + Caps lock + [_],<BR>
                Option + Shift + [_] ,<BR>
                Option + Shift + Cmd + [_] ,<BR>
                Option + Shift + Caps + [_]  and<BR>
                Option + Shift + Cmd + Caps + [_]<BR>
                do not generate an underscore (<CODE>0x5F</CODE>) character.<BR><BR></li>
            </UL></li>
        </OL>


<P><A HREF = "#top">Back to top</a></p>


        <P><A NAME="Kotoeri2.0"></A></P>
         
        <H2>Kotoeri 2.0</H2>
         
        <P>The Japanese version of Mac OS 8.0 includes version 2.0 of Kotoeri (the standard input method that ships with Mac OS). Kotoeri 2.0 uses <CODE>KBGetKeyLayout</CODE> to support JIS keyboards, as illustrated in the sample code above. The following describes how Kotoeri 2.0 uses these mechanisms.</p>

        <P>In principle, Kotoeri uses the character codes provided by the Text Services Manager. To change the typing method (Kana or Romaji), Kotoeri sets the active keyboard-layout resource by specifying its resource ID (<CODE>16384</CODE> for Kana or <CODE>16385</CODE> for Romaji). Likewise, when switching from kana entry mode to Roman entry mode, Kotoeri sets the active keyboard-layout resource to <CODE>16385</CODE>. The following code sample demonstrates how to change the active keyboard-layout resource. Unlike earlier versions of Kotoeri, Kotoeri 2.0 does not contain its own keyboard-layout resources. For details, see <a href="../../documentation/macos8/TextIntlSvcs/KeyboardIntlResources/keyboardintlresources.html"><I>Inside Macintosh: Text</I>, Appendix C, C-22</A>.</P>


<BR><BR><CENTER><TABLE BORDER=0 WIDTH=550>
<TR><td bgcolor="#E6E6E6" align=left>
<pre>OSErr SetSystemKCHR (short resourceID)
{
    OSErr error;

    error = SetScriptVariable (smJapanese, smScriptKeys, resourceID);
    if (error == noErr) {
        error = SetScriptVariable (smJapanese, smScriptIcon, resourceID);
        if (error == noErr)
            KeyScript (smJapanese);
    }
    return error;
}
</pre>
</TD></TR></TABLE></CENTER>


<BR><BR><CENTER><TABLE BORDER=0 WIDTH=550>
<TR><td bgcolor="#E6E6E6" align=left>
<P><B>Note:</B><BR>
By definition, Japanese input methods are only active within the Japanese script, so it may seem unnecessary to call <CODE>KeyScript</CODE>. However, <CODE>KeyScript</CODE> is required to  complete the SetScriptVariable call correctly.</p>
</TD></TR></TABLE></CENTER>


<BR><BR><CENTER><TABLE BORDER=0 WIDTH=550>
<TR><td bgcolor="#E6E6E6" align=left>
<P><B>Warning:</B><BR>
Always use the above method to set the active keyboard-layout resource. If you simply load the keyboard-layout resource using <CODE>GetResource</CODE> and pass its pointer to <CODE>KeyTranslate</CODE>, the correct key-remap resource may not be used.</p>
 </TD></TR></TABLE></CENTER><BR><BR>
 
        <P>Kotoeri also supports the Caps Lock key as a means of switching the input mode. To support this feature, Kotoeri clears the Caps Lock bit in the modifier flags. It then passes the updated modifier flags and the pointer obtained from <CODE>GetScriptManagerVariable</CODE> (<CODE>smKCHRCache</CODE>) to <CODE>KeyTranslate</CODE> to determine the character code without the effects of the Caps Lock key.</P>


<P><A HREF = "#top">Back to top</a></p>


        <A NAME="Summary"></A>
        <H2>Summary</H2>

        <P>Applications and input methods that require keyboard layout information and will be used in Japan need to be aware of JIS keyboards. <CODE>KBGetLayoutType</CODE> should be used to determine the type of keyboard attached to the computer (JIS or non-JIS) as demonstrated in the sample code above.</P>


<a name="References"></a>
<H2>References</H2>


            <p><a href="../../documentation/macos8/OSSvcs/EventManager/eventmanager.html">
            Event Manager</A><BR>
            Information on the <CODE>KeyTranslate</CODE> function and keyboard event handling in general.</P>

            <p><a href="../../documentation/macos8/TextIntlSvcs/KeyboardIntlResources/keyboardintlresources.html">
            Keyboard and International Resources</A><BR>
            Describes the various key-map, key-remap, and keyboard-layout resources (<CODE>'KMAP'</CODE>, <CODE>'itlk'</CODE>, <CODE>'KCHR'</CODE>) described in this technote.</P>

            <p><a href="../../documentation/macos8/TextIntlSvcs/ScriptManager/scriptmanager.html">
            Script Manager</A><BR>
            Information on the Script Manager, including SetScriptVariable and GetScriptVariable.</P>
        

<P><A HREF = "#top">Back to top</a></p>
  


<a name="Changes"></a>
<H2>Change History</H2>

 <TABLE BORDER=0 CELLPADDING=3 WIDTH=544>
            <TR>
               <td width=100 align=left>
                  <P ALIGN=center>01-March-1997</P>
               </TD>
               <td align="left">
                  <P>Originally written as DTS-Japan Technote 10009.</P>
               </TD>
            </TR>
            <TR>
               <td width=100 align=left>
                  <P ALIGN=center>01-July-1997</P>
               </TD>
               <td align="left">
                  <P>Revised.</P>
               </TD>
            </TR>
             <TR>
               <td width=100 align=left>
                  <P ALIGN=center>01-October-1998</P>
               </TD>
               <td align="left">
                  <P>Sample code revised to work around a bug in Mac OS 8.5.</P>
               </TD>
            </TR>
            <TR>
               <td width=100 align=left>
                  <P ALIGN=center>22-February-1999</P>
               </TD>
               <td align="left">
                  <P>Rewritten in English and updated to reflect changes in Mac OS 8.5.1.</P>
               </TD>
            </TR>
         </TABLE>





<BR><p><A HREF = "#top">Back to top</a></p>

<A NAME="Downloads"></A> 
<h2>Downloadables</h2>

<center><TABLE BORDER=0 CELLPADDING=3 WIDTH="600">
 <TR> 
<td width=50 align=left> 
  <P ALIGN=center><img src="images/acrobatsmall.gif" align=middle alt="Acrobat" width=22 height=23></P>
</TD>
<td align="left"> 
  <p>Acrobat version of this Note (512K).</P>
</TD>
<td width=60 align=left> 
  <p><A HREF="pdf/tn1152.pdf">Download</A></P>
</TD>
  </TR> 
  <TR>
               <td width=50 align=left>
                  <P ALIGN=center><img src="images/bluebook.gif" width=22 height=23 align=bottom alt="Bluebook gif"></P>
               </TD>
               <td align="left">
                  <P>Binhexed KeyboardsLib (2K)</P>
               </TD>
               <td width=60 align=left>
                  <P><A HREF="downloads/tn1152.1.hqx">Download</A></P>
               </TD>
            </TR>
</table></center>


<BR><p><a href="#top">Back to top</a></p>


</TD></TR></TABLE></CENTER>

<!-- end_content -->

<!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1152.html%3Fid%3DDTS10002991-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1152.html%3Fid%3DDTS10002991-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1152.html%3Fid%3DDTS10002991-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information -->


</BODY>
</HTML>

