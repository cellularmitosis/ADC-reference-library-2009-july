<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>System Startup Programming Topics: Creating launchd Daemons and Agents</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Creating launchd Daemons and Agents"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP40001762" title="Creating launchd Daemons and Agents"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index-date.html#//apple_ref/doc/uid/TP30000440-TP30000471" target="_top">Mac OS X</a> &gt; <a href="../index.html" target="_top">System Startup Programming Topics</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="DesigningDaemons.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="StartupItems.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>
        
        
        <a name="//apple_ref/doc/uid/TP40001762-BCIEDDBJ" title="Creating launchd Daemons and Agents"></a><hr /><H1>Creating launchd Daemons and Agents</H1><p>If you are developing daemons to run on Mac OS X version 10.4 and later, it is highly recommended that you design your daemons to be <code>launchd</code>-compliant. Using <code>launchd</code> provides better performance and flexibility for daemons. It also improves the ability of administrators to manage the daemons running on a given system.</p><p>If you are running per-user background processes for Mac OS X v10.4 and later, <code><a href="../../../../Darwin/Reference/ManPages/man8/launchd.8.html#//apple_ref/doc/man/8/launchd" target="_top">launchd</a></code> is also the preferred way to start these processes. These per-user processes are referred to as user agents. A user agent is essentially identical to a daemon, but is specific to a given logged-in user and executes only while that user is logged in.</p><p>Unless otherwise noted, for the purposes of this chapter, the terms “daemon” and “agent” can be used interchangeably. Thus, the term “daemon” is used generically in this section to encompass both system-level daemons and user agents except where otherwise noted.</p><p>There are four ways to launch daemons using <code>launchd</code>. The preferred method is on-demand launching, but <code>launchd</code> can launch daemons that run continuously, and can replace <code><!--a target="_top" -->inetd<!--/a--></code> for launching <code>inetd</code>-style daemons. This chapter describes these three methods.</p><p>In addition, <code>launchd</code> can start jobs at timed intervals much like <code><a href="../../../../Darwin/Reference/ManPages/man8/cron.8.html#//apple_ref/doc/man/8/cron" target="_top">cron</a></code> jobs. This is described in <span class="content_text"><a href="Daemons.html#//apple_ref/doc/uid/TP40001761-SW1">“Timed Jobs Using launchd.”</a></span> </p>
<!-- This template is being used for both PDF and HTML. -->

    
    <!-- TopicBook.pm uses this template for its miniTOCs, but needs a different title. -->
    <h4>Contents:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="LaunchOnDemandDaemons.html#//apple_ref/doc/uid/TP40001762-108425">The launchd Startup Process</a>
				
			<br/>
			
        
			
			
				<a href="LaunchOnDemandDaemons.html#//apple_ref/doc/uid/TP40001762-104738">Daemon Requirements</a>
				
			<br/>
			
        
			
			
				<a href="LaunchOnDemandDaemons.html#//apple_ref/doc/uid/TP40001762-104142-BCICCCFI">Creating a Launchd Property List File</a>
				
			<br/>
			
        
			
			
				<a href="LaunchOnDemandDaemons.html#//apple_ref/doc/uid/TP40001762-107182">Deciding When to Shut Down</a>
				
			<br/>
			
        
			
			
				<a href="LaunchOnDemandDaemons.html#//apple_ref/doc/uid/TP40001762-SW2">Special Dependencies</a>
				
			<br/>
			
        
			
			
				<a href="LaunchOnDemandDaemons.html#//apple_ref/doc/uid/TP40001762-SW5">Non-Launch-on-Demand Daemons</a>
				
			<br/>
			
        
			
			
				<a href="LaunchOnDemandDaemons.html#//apple_ref/doc/uid/TP40001762-SW6">For More Information</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP40001762-108425" title="The launchd Startup Process"></a><h2>The launchd Startup Process</h2><p>After the system is booted and the kernel is running, <code><a href="../../../../Darwin/Reference/ManPages/man8/launchd.8.html#//apple_ref/doc/man/8/launchd" target="_top">launchd</a></code><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_80"></a> is run to finish the system initialization. As part of that initialization, it goes through the following steps: </p><ol class="ol"><li class="li"><p>It loads the parameters for each launch-on-demand system-level daemon from the property list files found in <code>/System/Library/LaunchDaemons/</code> and <code>/Library/LaunchDaemons/</code>.</p></li><li class="li"><p>It registers the sockets and file descriptors requested by those daemons. </p></li><li class="li"><p>It launches any daemons that requested to be running all the time. </p></li><li class="li"><p>As requests for a particular service arrive, it launches the corresponding daemon and passes the request to it. </p></li><li class="li"><p>When the system shuts down, it sends a <code>SIGTERM</code> signal to all of the daemons that it started.</p></li></ol><p>The process for per-user agents is similar. When a user logs in, a per-user <code>launchd</code> is started. It does the following:</p><ol class="ol"><li class="li"><p>It loads the parameters for each launch-on-demand user agent from the property list files found in <code>/System/Library/LaunchAgents</code>, <code>/Library/LaunchAgents</code>, and the user’s individual <code>Library/LaunchAgents</code> directory.</p></li><li class="li"><p>It registers the sockets and file descriptors requested by those daemons. </p></li><li class="li"><p>It launches any daemons that requested to be running all the time. </p></li><li class="li"><p>As requests for a particular service arrive, it launches the corresponding daemon and passes the request to it. </p></li><li class="li"><p>When the user logs out, it sends a <code>SIGTERM</code> signal to all of the user agents that it started.</p></li></ol><p>Because <code>launchd</code> registers the sockets and file descriptors used by all daemons before it launches any of them, daemons can be launched in any order. If a request comes in for a daemon that is not yet running, the requesting process is suspended until the target daemon finishes launching and responds.</p><p>If a daemon does not receive any requests over a specific period of time, it can choose to shut itself down and release the resources it holds. When this happens, <code>launchd</code> monitors the shutdown and makes a note to launch the daemon again when future requests arrive. </p><div class="importantbox"><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_9" title="Important:"></a><p><strong>Important:</strong>&nbsp;If your daemon shuts down too quickly after being launched, <code>launchd</code> may think it has crashed. Daemons that continue this behavior may be suspended and not launched again when future requests arrive. To avoid this behavior, do not shut down for at least 10 seconds after launch. </p><p></p></div><a name="//apple_ref/doc/uid/TP40001762-104738" title="Daemon Requirements"></a><h2>Daemon Requirements</h2><p>If you are looking to implement a daemon that supports <code>launchd</code>, there are some behaviors with which you should be familiar. Creating daemons to run under <code>launchd</code> is actually simpler than in previous versions of Mac OS X. The reason is that many tasks normally implemented in your daemon code are now handled automatically by <code><a href="../../../../Darwin/Reference/ManPages/man8/launchd.8.html#//apple_ref/doc/man/8/launchd" target="_top">launchd</a></code>. </p><div class="notebox"><a name="//apple_ref/doc/uid/TP40001762-SW1" title="Note"></a><p><strong>Note:</strong>&nbsp;The following sections describe only the changes you must make to your daemons to support <code>launchd</code>. The overall process for creating daemons is not covered. </p></div><a name="//apple_ref/doc/uid/TP40001762-104302" title="Required Behaviors"></a><h3>Required Behaviors</h3><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_81"></a><p>To support <code><a href="../../../../Darwin/Reference/ManPages/man8/launchd.8.html#//apple_ref/doc/man/8/launchd" target="_top">launchd</a></code>, you must obey the following guidelines when writing your daemon code:</p><ul class="spaceabove"><li class="li"><p>You must provide a property list with some basic launch-on-demand criteria for your daemon. See <span class="content_text"><a href="LaunchOnDemandDaemons.html#//apple_ref/doc/uid/TP40001762-104142">“Creating a Launchd Property List File.”</a></span> </p></li><li class="li"><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_82"></a><p>You must not fork your process and have the parent process exit. </p></li><li class="li"><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_83"></a><p>You must not daemonize your process. This includes calling the <code><a href="../../../../Darwin/Reference/ManPages/man3/daemon.3.html#//apple_ref/doc/man/3/daemon" target="_top">daemon</a></code> function, calling <code><a href="../../../../Darwin/Reference/ManPages/man2/fork.2.html#//apple_ref/doc/man/2/fork" target="_top">fork</a></code> followed by <code><a href="../../../../Darwin/Reference/ManPages/man3/exec.3.html#//apple_ref/doc/man/3/exec" target="_top">exec</a></code>, or calling <code><a href="../../../../Darwin/Reference/ManPages/man2/fork.2.html#//apple_ref/doc/man/2/fork" target="_top">fork</a></code> followed by <code><a href="../../../../Darwin/Reference/ManPages/man3/exit.3.html#//apple_ref/doc/man/3/exit" target="_top">exit</a></code>. If you do, <code>launchd</code> thinks your process has died. Depending on your property list key settings, <code>launchd</code> will either keep trying to relaunch your process until it gives up (with a “respawning too fast” error message) or will be unable to restart it if it really does die.</p></li><li class="li"><p>Your daemon and its property list file must be owned by the root user (except for agents, which may be owned by the logged-in user), and must not be group writable or other writable.</p></li></ul><p>Although they are normally part of the daemon creation process, it is worth emphasizing that forking and exiting the parent process and calling the <code>daemon</code> function must be avoided if you want to support <code>launchd</code>. The <code>launchd</code> program configures your daemon to run as a daemon before your code is ever called, so these steps are unnecessary. In addition, calling them interferes with the ability of <code>launchd</code> to launch your daemon on demand. </p><a name="//apple_ref/doc/uid/TP40001762-104489" title="Recommended Behaviors"></a><h3>Recommended Behaviors</h3><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_84"></a><p>To support <code><a href="../../../../Darwin/Reference/ManPages/man8/launchd.8.html#//apple_ref/doc/man/8/launchd" target="_top">launchd</a></code>, it is recommended that you obey the following guidelines when writing your daemon code:</p><ul class="spaceabove"><li class="li"><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_85"></a><p>Wait until your daemon is fully initialized before attempting to process requests. Your daemon should always provide a reasonable response (as opposed to an error) when processing requests.</p></li><li class="li"><p>Register the sockets and file descriptors used by your daemon in your <code>launchd</code> configuration property list file.</p></li><li class="li"><p>Check in with <code>launchd</code> as part of your daemon initialization using the routines in <code><!--a target="_top" -->launch.h<!--/a--></code>.</p></li><li class="li"><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_86"></a><p>During checkin, get the launch dictionary from <code>launchd</code>, extract its contents, store those contents locally, and get rid of the dictionary. Caching the dictionary locally and accessing it frequently could hurt performance.</p></li><li class="li"><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_87"></a><p>Provide a handler to catch the <code>SIGTERM</code> signal. </p></li></ul><p>In addition to the preceding list, the following is a list of things it is recommended you do <em>not</em> do in your code: </p><ul class="spaceabove"><li class="li"><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_88"></a><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_89"></a><p>Do not set the user or group ID for your daemon. Include the <code>UserName</code>, <code>UID</code>, <code>GroupName</code>, or <code>GID</code> keys in your daemon’s configuration property list instead. </p></li><li class="li"><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_90"></a><p>Do not set the working directory. Include the <code>WorkingDirectory</code> key in your daemon’s configuration property list instead. </p></li><li class="li"><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_91"></a><p>Do not call <code>chroot</code> to change the root directory. Include the <code>RootDirectory</code> key in your daemon’s configuration property list instead. </p></li><li class="li"><p>Do not call <code>setsid</code> to create a new session. </p></li><li class="li"><p>Do not close any stray file descriptors. </p></li><li class="li"><p>Do not change <code>stdio</code> to point to <code>/dev/null</code>. Include the <code>StandardOutPath</code> or <code>StandardErrorPath</code> keys in your daemon’s configuration property list file instead.</p></li><li class="li"><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_92"></a><p>Do not set up resource limits with <code>setrusage</code>.</p></li><li class="li"><p>Do not set the daemon priority with <code>setpriority</code></p></li></ul><p>Although many of the preceding behaviors may be standard tasks for daemons to perform, they are not recommended when running under <code>launchd</code>. The reason is that <code>launchd</code> configures the operating environment for the daemons that it manages. Changing this environment could interfere with the normal operation of your daemon. </p><a name="//apple_ref/doc/uid/TP40001762-104142" title="Creating a Launchd Property List File"></a><a name="//apple_ref/doc/uid/TP40001762-104142-BCICCCFI" title="Creating a Launchd Property List File"></a><h2>Creating a Launchd Property List File</h2><p><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_93"></a>To run under <code><a href="../../../../Darwin/Reference/ManPages/man8/launchd.8.html#//apple_ref/doc/man/8/launchd" target="_top">launchd</a></code>, you must provide a configuration property list file for your daemon. This file contains information about your daemon, including the list of sockets or file descriptors it uses to process requests. Specifying this information in a property list file lets <code>launchd</code> register the corresponding file descriptors and launch your daemon only after a request arrives for your daemon’s services. <span class="content_text">Table 1</span> lists the required and recommended keys for all daemons. </p><a name="//apple_ref/doc/uid/TP40001762-105851-BCIEDHIA" title="Table 1Required and recommended property list keys"></a><div class="tableholder"><table class="graybox" border = "0" cellspacing="0" cellpadding="5"><caption class="tablecaption"><a name="//apple_ref/doc/uid/TP40001762-105851" title="Table 1Required and recommended property list keys"></a><strong>Table 1&nbsp;&nbsp;</strong>Required and recommended property list keys</caption><tr><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Key</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Description</p></th></tr><tr><td  scope="row"><p><code>Label</code></p></td><td ><p>Contains a unique string that identifies your daemon to <code>launchd</code>. This key is required.</p></td></tr><tr><td  scope="row"><p><code>ProgramArguments</code></p></td><td ><p>Contains the arguments used to launch your daemon. This key is required. </p></td></tr><tr><td  scope="row"><p><code>inetdCompatibility</code></p></td><td ><p>Indicates that your daemon requires a separate instance per incoming connection. This causes <code>launchd</code> to behave like <code><!--a target="_top" -->inetd<!--/a--></code>, passing each daemon a single socket that is already connected to the incoming client. This key is required if your daemon was designed to be launched by <code>inetd</code>; otherwise, it must not be included.</p></td></tr><tr><td  scope="row"><p><code>OnDemand</code></p></td><td ><p>This key specifies whether your daemon launches on-demand or must always be running. This key is recommended. </p></td></tr></table></div><p>Depending on the needs of your daemon, you would also include other keys in your configuration property list file. For example, if your daemon monitors a well-known port (those listed in <code>/etc/services</code>), you would add a <code>Sockets</code> entry that looks like this:</p><div class="codesample"><table><tr><td scope="row"><pre>&lt;key>Sockets&lt;/key>
&lt;dict>
    &lt;key>Listeners&lt;/key>
    &lt;dict>
        &lt;key>SockServiceName&lt;/key>
        &lt;string>bootps&lt;/string>
        &lt;key>SockType&lt;/key>
        &lt;string>dgram&lt;/string>
        &lt;key>SockFamily&lt;/key>
        &lt;string>IPv4&lt;/string>
    &lt;/dict>
&lt;/dict><span></span></pre></td></tr></table></div><p>Note that the string for <code>SockServiceName</code> typically comes from the leftmost column in <code>/etc/services</code>. The <code>SockType</code> is one of <code>dgram</code> (UDP) or <code>stream</code> (TCP/IP).</p><p>If you need to pass a port number that is not listed in the well-known ports list, the format is basically the same, except the string contains a number instead of a name. For example:</p><div class="codesample"><table><tr><td scope="row"><pre>&lt;key>SockServiceName&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;string>23&lt;/string><span></span></pre></td></tr></table></div><p>You can also pass additional keys to further configure your daemon. For a list of sample configuration property lists, look at the files in <code>/System/Library/LaunchDaemons/</code>. These files are used to configure many daemons that run on Mac OS X.</p><p>For additional information about the keys you can specify in your configuration property list file, see the <code><a href="../../../../Darwin/Reference/ManPages/man1/man.1.html#//apple_ref/doc/man/1/man" target="_top">man</a></code> page for <code><a href="../../../../Darwin/Reference/ManPages/man5/launchd.plist.5.html#//apple_ref/doc/man/5/launchd.plist" target="_top">launchd.plist</a></code>. <a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_94"></a></p><a name="//apple_ref/doc/uid/TP40001762-107182" title="Deciding When to Shut Down"></a><h2>Deciding When to Shut Down</h2><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_95"></a><p>If you do not expect your daemon to handle many requests, you might want to shut it down after a predetermined amount of idle time, rather than continue running. Although a well-written daemon does not consume any CPU resources, it still consumes memory and could be paged out during periods of intense memory use. </p><p>The timing of when to shut down is different for each daemon and depends on several factors, including:</p><ul class="ul"><li class="li"><p>The number and frequency of requests it receives</p></li><li class="li"><p>The time it takes to launch the daemon</p></li><li class="li"><p>The time it takes to shut down the daemon</p></li><li class="li"><p>The need to retain state information</p></li></ul><p>If your daemon does not receive frequent requests and can be launched and shut down quickly, you might prefer to shut it down rather than wait for it to be paged out to disk. Paging memory to disk, and subsequently reading it back, incurs two disk operations. If you do not need the data stored in memory, your daemon can shut down and avoid the step of writing memory to disk. </p><a name="//apple_ref/doc/uid/TP40001762-SW2" title="Special Dependencies"></a><h2>Special Dependencies</h2><p>While <code><a href="../../../../Darwin/Reference/ManPages/man8/launchd.8.html#//apple_ref/doc/man/8/launchd" target="_top">launchd</a></code> takes care of dependencies between daemons, in some cases, your daemon may depend on other system functionality that cannot be addressed in this manner. This section describes many of these special cases and how to handle them.</p><dl class="termdef">	<dl class="content_text"><b>Disk or server availability:</b><dd><p>If your daemon depends on the availability of a mounted volume (whether local or remote), you can determine the status of that volume using the disk arbitration framework. This is documented in <em><a href="../../../../Darwin/Reference/DiscArbitrationFramework/index.html#//apple_ref/doc/uid/TP40002482" target="_top">Disk Arbitration Framework Reference</a></em>.</p></dd></dl><dl class="content_text"><b>Kernel Extensions</b><dd><p>If your daemon requires that a certain kernel extension be loaded prior to executing, you have two options: load it yourself, or wait for it to be loaded.</p><dl class="termdef">	<dl class="content_text"><b>Load it yourself:</b><dd><p>The daemon may manually request that an extension be loaded. To do this, run <code><a href="../../../../Darwin/Reference/ManPages/man8/kextload.8.html#//apple_ref/doc/man/8/kextload" target="_top">kextload</a></code> with the appropriate arguments using <code><a href="../../../../Darwin/Reference/ManPages/man3/exec.3.html#//apple_ref/doc/man/3/exec" target="_top">exec</a></code> or variants thereof.</p><div class="noteboxdef"><a name="//apple_ref/doc/uid/TP40001762-SW3" title="Note"></a><p><strong>Note:</strong>&nbsp;The <code>kextload</code> executable must be run as root in order to load extensions into the kernel. For security reasons, it is not a setuid executable. This means that your daemon must either be running as the root user or must include a helper binary that is setuid root in order to use <code>kextload</code> to load a kernel extension.</p></p></div></dd></dl><dl class="content_text"><b>Wait for a matching service:</b><dd><p>Your daemon may wait for a kernel service to be available. To do this, you should first register for service change notification using the functions described in <code><a href="../../../../Darwin/Reference/IOKit/IOKitLib_h/index.html#//apple_ref/doc/header/IOKitLib.h" target="_top">IOKitLib</a></code>. This header is part of the I/O Kit Framework, which is further documented in <em><a href="../../../../Darwin/Reference/IOKit/index.html#//apple_ref/doc/uid/TP30000815" target="_top">I/O Kit Framework Reference</a></em>.</p><p>After registering for these notifications, you should check to see if the service is already available. By doing this after registering for notifications, you avoid waiting forever if the service becomes available between checking for availability and registering for the notification.</p><div class="noteboxdef"><a name="//apple_ref/doc/uid/TP40001762-SW4" title="Note"></a><p><strong>Note:</strong>&nbsp;In order for your kernel extension to be detected in a useful way, it must publish a node in the I/O registry to advertise the availability of its service. For I/O Kit drivers, this is usually handled by the I/O Kit family.</p>For other kernel extensions, you must explicitly register the service by publishing a nub, which must be an instance of <code><a href="../../../../Darwin/Reference/KernelIOKitFramework/IOService_h/Classes/IOService/index.html#//apple_ref/cpp/cl/IOService" target="_top">IOService</a></code>.</p></p></div><p>For more information about I/O Kit services and matching, see <em><a href="../../../../DeviceDrivers/Conceptual/IOKitFundamentals/index.html#//apple_ref/doc/uid/TP0000011" target="_top">I/O Kit Fundamentals</a></em>, <em><a href="../../../../Darwin/Reference/IOKit/index.html#//apple_ref/doc/uid/TP30000815" target="_top">I/O Kit Framework Reference</a></em> (user space reference), and <em><a href="../../../../Darwin/Reference/KernelIOKitFramework/index.html#//apple_ref/doc/uid/TP30000816" target="_top">Kernel Framework Reference</a></em> (kernel space reference).</p></dd></dl></dl></dd></dl><dl class="content_text"><b>Network availability:</b><dd><p>If your daemon depends on the network being available with a valid outgoing route, this cannot be handled with dependencies because network interfaces can come and go at any time in Mac OS X. To solve this problem, you should use the network reachability functionality in the system configuration framework. This is documented in <em><a href="../../../../Networking/Conceptual/SystemConfigFrameworks/index.html#//apple_ref/doc/uid/TP40001065" target="_top">System Configuration Programming Guidelines</a></em> and <em><a href="../../../../Networking/Reference/SysConfig/index.html#//apple_ref/doc/uid/TP40001027" target="_top">System Configuration Framework Reference</a></em>.</p></dd></dl><dl class="content_text"><b>Non-launchd daemons:</b><dd><p>If your daemon has a dependency on a non-launchd daemon, you must take additional care to ensure that your daemon works correctly if that non-launchd daemon has not started when your daemon is started. The best way to do this is to include a loop at start time that checks to see if the non-launchd daemon is running, and if not, sleeps for several seconds before checking again.</p><p>Be sure to set up handlers for <code>SIGTERM</code> prior to this loop to ensure that you are able to properly shut down if the daemon you rely on never becomes available.</p></dd></dl><dl class="content_text"><b>User login:</b><dd><p>In general, a daemon should not care whether a user is logged in, and user agents should be used to provide per-user functionality. However, in some cases, this may be useful.</p><p>To determine what user is logged in at the console, you can use the system configuration framework to register for login and logout notifications, as described in <span class="content_text"><a href="../../../../../qa/qa2001/qa1133.html" target="_top">Technical Q&amp;A QA1133</a></span>.</p></dd></dl></dl><a name="//apple_ref/doc/uid/TP40001762-SW5" title="Non-Launch-on-Demand Daemons"></a><h2>Non-Launch-on-Demand Daemons</h2><p>While most daemons should generally be run on demand, it can sometimes be useful to run a daemon continuously.</p><p>In Mac OS X v10.3 and earlier, the preferred facility for launching a daemon was a startup item. If you need to support versions of Mac OS X prior to v10.4, you should use a startup item. This is described in <span class="content_text"><a href="StartupItems.html#//apple_ref/doc/uid/20002132-CJBBHDII">“Creating a Startup Item.”</a></span></p><p>In Mac OS X v10.4 and later, the preferred facility for launching daemons is <code><a href="../../../../Darwin/Reference/ManPages/man8/launchd.8.html#//apple_ref/doc/man/8/launchd" target="_top">launchd</a></code>. To create a non-on-demand <code>launchd</code> daemon, you need to add some additional keys to your daemon’s launchd property list file:</p><ul class="ul"><li class="li"><p><strong>OnDemand</strong>—set this to <code>false</code>. This will tell <code>launchd</code> that your daemon is not designed for on-demand launching.</p></li><li class="li"><p><strong>RunAtLoad</strong>—set this to <code>true</code>. This will cause your daemon to be launched as soon as launchd starts. Because of the nature of on-demand facilities for things like networking, any dependencies will automatically be launched as needed to support your daemon.</p></li></ul><div class="importantbox"><a name="//apple_ref/doc/uid/TP40001762-DontLinkElementID_10" title="Important:"></a><p><strong>Important:</strong>&nbsp;Before using <code>launchd</code> to launch any daemon (on-demand or otherwise), you should read about the requirements for a <code>launchd</code> daemon in <span class="content_text"><a href="LaunchOnDemandDaemons.html#//apple_ref/doc/uid/TP40001762-104738">“Daemon Requirements.”</a></span></p><p>In particular, your daemon must <em>not</em> daemonize itself (<code>fork</code> and exit). If it does, <code>launchd</code> will interpret this as a failed launch and will repeatedly try to respawn it before eventually giving up.</p><p></p></div><a name="//apple_ref/doc/uid/TP40001762-SW6" title="For More Information"></a><h2>For More Information</h2><p>The manual pages for <code><a href="../../../../Darwin/Reference/ManPages/man8/launchd.8.html#//apple_ref/doc/man/8/launchd" target="_top">launchd</a></code> and <code><a href="../../../../Darwin/Reference/ManPages/man5/launchd.plist.5.html#//apple_ref/doc/man/5/launchd.plist" target="_top">launchd.plist</a></code> are the two best sources for information about <code>launchd</code>.</p><p>In addition, you can find a source daemon accompanying the <code>launchd</code> source code (available from <span class="content_text"><a href="http://www.macosforge.org/" target="_blank">http://www.macosforge.org/</a></span>). This daemon is also provided from the ADC reference library as the <span class="content_text"><a href="../../../../../samplecode/SampleD/index.html" target="_top">SampleD</a></span> sample code project.</p><p>Finally, many Apple-provided daemons support <code>launchd</code>. Their property list files can be found in <code>/System/Library/LaunchDaemons</code>. Some of these daemons are also available as open source from <span class="content_text"><a href="http://www.opensource.apple.com/" target="_blank">http://www.opensource.apple.com/</a></span> or <span class="content_text"><a href="http://www.macosforge.org/" target="_blank">http://www.macosforge.org/</a></span>.</p>

        <br/><br/> 

        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="DesigningDaemons.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="StartupItems.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2003, 2008 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2008-11-19<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/MacOSX/Conceptual/BPSystemStartup/Articles/LaunchOnDemandDaemons.html%3Fid%3D10000172i-3.3&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/MacOSX/Conceptual/BPSystemStartup/Articles/LaunchOnDemandDaemons.html%3Fid%3D10000172i-3.3&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/MacOSX/Conceptual/BPSystemStartup/Articles/LaunchOnDemandDaemons.html%3Fid%3D10000172i-3.3&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>
