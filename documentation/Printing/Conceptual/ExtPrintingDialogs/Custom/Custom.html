<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Extending Printing Dialogs: Custom Tasks</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Custom Tasks"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30000979-CH207" title="Custom Tasks"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000432" target="_top">Printing</a> &gt; <a href="../../../Carbon-date.html#//apple_ref/doc/uid/TP30000440-TP30000432-TP30000494" target="_top">Carbon</a> &gt; <a href="../Introduction/Introduction.html#//apple_ref/doc/uid/TP30000979-CH201-TP9">Extending Printing Dialogs</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../Core/Core.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../Integration/Integration.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30000979-CH207-TP9" title="Custom Tasks"></a><h1>Custom Tasks</h1><p>This chapter shows you how to implement a set of custom data types and functions that add unique behavior to your printing dialog extension. You can use the source code in this chapter in a real-world project, but you will need to adapt and extend the code to fit your specific requirements.</p><p>All the code examples in this chapter are adapted from a complete sample project for writing a printing dialog extension. To view or download the current version of the sample project, see <em><a href="../../../../../samplecode/PDEProject/index.html#//apple_ref/doc/uid/DTS10000745" target="_top">PDEProject</a></em> in the ADC Reference Library.</p>
<!-- This template is being used for both PDF and HTML. -->

    
    <h4>In this section:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="Custom.html#//apple_ref/doc/uid/TP30000979-CH207-CJBCAFCC">Designing the Interface for a Custom Pane</a>
				
			<br/>
			
        
			
			
				<a href="Custom.html#//apple_ref/doc/uid/TP30000979-CH207-TPXREF166">Defining Identifiers and Constants</a>
				
			<br/>
			
        
			
			
				<a href="Custom.html#//apple_ref/doc/uid/TP30000979-CH207-CIHHEAGC">Defining a Custom Context</a>
				
			<br/>
			
        
			
			
				<a href="Custom.html#//apple_ref/doc/uid/TP30000979-CH207-BBCGCECE">Implementing Your Custom Functions</a>
				
			<br/>
			
        
			
			
				<a href="Custom.html#//apple_ref/doc/uid/TP30000979-CH207-CACBHDBD">Handling PostScript Features</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP30000979-CH207-CJBCAFCC" title="Designing the Interface for a Custom Pane"></a><h2>Designing the Interface for a Custom Pane</h2><p>A graphical editor like Apple’s Interface Builder is an important tool for designing and constructing a user interface. As a visual designer, you can use an editor to create a prototype of the interface. As a developer, you can use the same editor to fill in the details and construct an archive that can be instantiated at runtime. Tools of this type are especially important when you need to manage many localized versions of a single interface.</p><p>This section shows how to use Interface Builder to design a custom pane for your printing dialog extension. Interface Builder saves your design as an XML archive using the <code>.nib</code> filename extension. The archive is a static representation of the interface that can be efficiently loaded into memory when needed.</p><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF202" title="Designing the Interface"></a><h3>Designing the Interface</h3><p>Designing an interface with Interface Builder is straightforward and intuitive. You drag Carbon controls from a palette into a Carbon window, position and group the controls as needed, and use an Info window to adjust their attributes. You save the Carbon window as an archive, and install the archive in an appropriate location inside the plug-in bundle.</p><p>The following procedure shows how to design the interface for a printing dialog extension using Interface Builder.</p><ol class="ol"><li class="li"><p>Decide on a 4-byte signature (or creator code) that identifies your interface.</p></li><li class="li"><p>Open Interface Builder and create a new Carbon window.</p></li><li class="li"><p>Open the Info window (Tools > Show Info or Commmand-Shift-I). </p></li><li class="li"><p>Set the width and height of the Carbon window in pixels. These values might change as you refine your design.</p></li><li class="li"><p>For each control in your interface:</p><ol class="ol"><li class="ol ol"><p>Drag a control from the Controls palette into position inside your Carbon window.</p></li><li class="ol ol"><p>Set the control signature to your 4-byte interface signature.</p></li><li class="ol ol"><p>Set the control ID to a unique positive integer.</p></li><li class="ol ol"><p>Enter the title string.</p></li><li class="ol ol"><p>Enter text for a help tag, and specify where the help tag should appear.</p></li></ol></li><li class="li"><p>Save your layout in a project subdirectory for localized resources—for example, <code>Resources/English.lproj/</code>.</p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF203" title="Localizing the Interface"></a><h3>Localizing the Interface</h3><p>This brief procedure shows how to localize your interface for additional languages or dialects.</p><p>For each new locale:</p><ol class="ol"><li class="li"><p>Duplicate your original localized resources folder, and rename the new folder appropriately. The name of the nib file inside the new folder should remain the same.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000979-CH207-DontLinkElementID_4" title="Note"></a><p><strong>Note:</strong>&nbsp; For information on folder-naming conventions for localized resources, read the section “Localized Resources” in<em> Inside Mac OS X: System Overview</em> .</p></div></li><li class="li"><p>Open the new nib file using Interface Builder, and for each control in the interface:</p><ol class="ol"><li class="ol ol"><p>Enter the localized title string.</p></li><li class="ol ol"><p>Resize the control as needed to accomodate the new title.</p></li><li class="ol ol"><p>Enter the localized help tag.</p></li></ol></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF177" title="Instantiating the Interface"></a><h3>Instantiating the Interface</h3><p>At runtime, you construct the interface as follows:</p><ol class="ol"><li class="li"><p>Call <code>CreateWindowFromNib</code> to instantiate a localized version of the interface in a Carbon window.</p></li><li class="li"><p>Find the individual controls in the window, and embed them inside the dialog pane, adjusting their coordinates as needed.</p></li></ol><p>These tasks are described in detail in <span class="content_text"><a href="../Core/Core.html#//apple_ref/doc/uid/TP30000979-CH206-BBCCGGBH">“Open”</a></span> and <span class="content_text"><a href="Custom.html#//apple_ref/doc/uid/TP30000979-CH207-CACCEIEC">“Embedding Your Controls in a Dialog Pane.”</a></span></p><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF205" title="See Also"></a><h3>See Also</h3><p>Interface Builder is available on the latest Mac OS X Developer Tools CD, or from the Apple Development Tools site at <span class="content_text"><a href="http://developer.apple.com/tools/" target="_top">http://developer.apple.com/tools/</a></span>.</p><p>For general information about localizing human interfaces, see <em><a href="../../../../../referencelibrary/GettingStarted/GS_Internationalization/index.html#//apple_ref/doc/uid/TP30001113" target="_top">Getting Started with Internationalization</a></em>.</p><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF166" title="Defining Identifiers and Constants"></a><h2>Defining Identifiers and Constants</h2><p>You need to define several unique identifiers used to locate external resources such as nib files and tickets, and integer constants that are passed to the printing system to specify the dimensions of your pane.</p><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF169" title="Defining Bundle, Pane, and Nib Identifiers"></a><h3>Defining Bundle, Pane, and Nib Identifiers</h3><p><span class="content_text">Listing 6-1</span> shows how to define several identifiers associated with your bundle property list and your nib file.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000979-CH207-DontLinkElementID_5" title="Important"></a><p><strong>Important:</strong>&nbsp; If you use the definitions in <span class="content_text">Listing 6-1</span> in a real-world project, you should always define these symbols using your own custom identifiers and names.</p></div><a name="//apple_ref/doc/uid/TP30000979-CH207-BBCCEACF" title="Listing 6-1Custom identifiers"></a><p class="codesample"><strong>Listing 6-1&nbsp;&nbsp;</strong>Custom identifiers</p><div class="codesample"><table><tr><td scope="row"><pre>#define  kMyBundleSignature     "PRDX"<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>#define  kMyBundleCreatorCode   'PRDX'<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>#define  kMyBundleIdentifier \<span></span></pre></td></tr><tr><td scope="row"><pre>            CFSTR("com.appvendor.pde." kMyBundleSignature)<span>// 3</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#define  kMyPaneKindID  kMyBundleIdentifier<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>#define  kMyNibFile     CFSTR("PDEPrint")<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>#define  kMyNibWindow   CFSTR("PDEPrint")<span>// 6</span></pre></td></tr></table></div><p>Here’s what the definitions in <span class="content_text">Listing 6-1</span> represent:</p><ol class="ol"><li class="li"><p>A string representation of the unique 4-byte signature of an application-hosted printing dialog extension. This signature is used as a suffix when defining keys for extended data in a print settings or page format ticket, as described in <span class="content_text"><a href="Custom.html#//apple_ref/doc/uid/TP30000979-CH207-TPXREF170">“Defining Custom Ticket Keys.”</a></span></p></li><li class="li"><p>An OSType representation of the same 4-byte signature. An application uses this code to retrieve its extended data, as described in <span class="content_text"><a href="../Integration/Integration.html#//apple_ref/doc/uid/TP30000979-CH208-TPXREF173">“Data Retrieval.”</a></span> Printer module–hosted printing dialog extensions do not need to define this constant.</p></li><li class="li"><p>A Core Foundation string used by your printing dialog extension to specify its bundle when calling the function <code>CFBundleGetBundleWithIdentifier</code>. This string must be the same unique identifier used in the <code>CFBundleIdentifier</code> property.</p></li><li class="li"><p>A Core Foundation string that represents your custom pane. This string should be a unique identifier in the form of a Java-style package name. In <span class="content_text"><a href="../Core/Core.html#//apple_ref/doc/uid/TP30000979-CH206-TPXREF128">“Prologue,”</a></span> this string is passed back to the printing system.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000979-CH207-DontLinkElementID_6" title="Note"></a><p><strong>Note:</strong>&nbsp;If your custom pane implements one of the standard feature sets listed in <span class="content_text"><a href="../PaneConcepts/PaneConcepts.html#//apple_ref/doc/uid/TP30000979-CH202-BBCBHBDD">Table 1-1</a></span>, you must define <code>kMyPaneKindID</code> using the appropriate Apple-defined kind ID in <code>PMPrintingDialogExtensions.h</code>.</p></div></li><li class="li"><p>A Core Foundation string that represents the name of your nib file (without the <code>.nib</code> extension.) In <span class="content_text"><a href="../Core/Core.html#//apple_ref/doc/uid/TP30000979-CH206-BBCCGGBH">“Open,”</a></span> this string is passed to the function <code>CreateNibReferenceWithCFBundle</code>.</p></li><li class="li"><p>A Core Foundation string that represents the name of your nib-based Carbon window. In <span class="content_text"><a href="../Core/Core.html#//apple_ref/doc/uid/TP30000979-CH206-BBCCGGBH">“Open,”</a></span> this string is passed to the function <code>CreateWindowFromNib</code>.</p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF170" title="Defining Custom Ticket Keys"></a><h3>Defining Custom Ticket Keys</h3><p>A ticket key is a unique string identifier that’s used to access a data item in a print job ticket.</p><a name="//apple_ref/doc/uid/TP30000979-CH207-BBCEFJDE" title="Applications"></a><h4>Applications</h4><p>An application using a printing dialog extension must observe some restrictions when defining ticket keys for either the print settings or page format ticket.</p><p>A key must</p><ul class="spaceabove"><li class="li"><p>start with the appropriate prelude string defined below in <span class="content_text">Table 6-1</span></p></li><li class="li"><p>end with a custom 4-byte code that represents the data item</p></li></ul><div class="notebox"><a name="//apple_ref/doc/uid/TP30000979-CH207-DontLinkElementID_7" title="Note"></a><p><strong>Note:</strong>&nbsp; The code bytes must be ASCII characters in the range 0x20-0x7F.</p></div><a name="//apple_ref/doc/uid/TP30000979-CH207-BBCDGGGG" title="Table 6-1Prelude strings for ticket keys defined by applications"></a><div class="tableholder"><table class="graybox" border = "0" cellspacing="0" cellpadding="5"><caption class="tablecaption"><strong>Table 6-1&nbsp;&nbsp;</strong>Prelude strings for ticket keys defined by applications</caption><tr><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Printing dialog</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Associated ticket</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Prelude string for ticket key</p></th></tr><tr><td  scope="row"><p>Page Setup</p></td><td ><p>Page format</p></td><td ><p><code>com.apple.print.PageFormatTicket</code>.</p></td></tr><tr><td  scope="row"><p>Print</p></td><td ><p>Print settings</p></td><td ><p><code>com.apple.print.PrintSettingsTicket</code>.</p></td></tr></table></div><p><span class="content_text">Listing 6-2</span> shows how you can define custom keys for the print settings or page format tickets, assuming that you are storing a single data item in each ticket.</p><a name="//apple_ref/doc/uid/TP30000979-CH207-BBCDAGBC" title="Listing 6-2Examples of two custom ticket keys"></a><p class="codesample"><strong>Listing 6-2&nbsp;&nbsp;</strong>Examples of two custom ticket keys</p><div class="codesample"><table><tr><td scope="row"><pre>#define kMyAppPageFormatKey \<span></span></pre></td></tr><tr><td scope="row"><pre>        CFSTR("com.apple.print.PageFormatTicket." kMyBundleSignature)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#define kMyAppPrintSettingsKey \<span></span></pre></td></tr><tr><td scope="row"><pre>        CFSTR("com.apple.print.PrintSettingsTicket." kMyBundleSignature)<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF173" title="Printer Modules"></a><h4>Printer Modules</h4><p>If your printer module uses a printing dialog extension to implement one of the standard sets of printing features listed in <span class="content_text"><a href="../PaneConcepts/PaneConcepts.html#//apple_ref/doc/uid/TP30000979-CH202-BBCBHBDD">Table 1-1</a></span>, you should use the Apple-defined ticket keys for those features.</p><p>If you are implementing a custom printing feature, you need to define a custom ticket key for the feature. By convention, a custom key should be an identifier in the form of a Java-style package name. For example, if you are writing a printer module for a printer that has a custom toner-saving option, you might define the ticket key as follows:</p><div class="codesample"><table><tr><td scope="row"><pre>#define kMySaveTonerKey CFSTR("com.mycompany.pm.savetoner")<span></span></pre></td></tr></table></div><div class="notebox"><a name="//apple_ref/doc/uid/TP30000979-CH207-DontLinkElementID_8" title="Note"></a><p><strong>Note:</strong>&nbsp; The restrictions on ticket keys described in <span class="content_text"><a href="Custom.html#//apple_ref/doc/uid/TP30000979-CH207-BBCEFJDE">“Applications”</a></span> do not apply to ticket keys defined for printer modules.</p></div><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF171" title="Providing the Dimensions of Your Custom Pane"></a><h3>Providing the Dimensions of Your Custom Pane</h3><p>The printing system needs to know the vertical and horizontal extent (in pixel units) of your custom pane. A printing dialog extension passes these values back to the printing system when its prologue function is called.</p><p>The values you provide can be arbitrarily large. The printing system takes the values into account—along with a number of other constraints—when it determines the actual size of your pane.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000979-CH207-DontLinkElementID_9" title="Note"></a><p><strong>Note:</strong>&nbsp; The printing system adjusts the height of the dialog to accomodate your custom pane, but not the width. This behavior might change in a future version of Mac OS X, so you should always supply the actual width of your pane.</p></div><p><span class="content_text">Listing 6-3</span> illustrates how to define the two constant values passed to the printing system in <span class="content_text"><a href="../Core/Core.html#//apple_ref/doc/uid/TP30000979-CH206-TPXREF128">“Prologue.”</a></span></p><a name="//apple_ref/doc/uid/TP30000979-CH207-BBCFAGHC" title="Listing 6-3Vertical and horizontal extent of your custom pane in pixels"></a><p class="codesample"><strong>Listing 6-3&nbsp;&nbsp;</strong>Vertical and horizontal extent of your custom pane in pixels</p><div class="codesample"><table><tr><td scope="row"><pre>enum {<span></span></pre></td></tr><tr><td scope="row"><pre>    kMyMaxV = 80,<span></span></pre></td></tr><tr><td scope="row"><pre>    kMyMaxH = 478<span></span></pre></td></tr><tr><td scope="row"><pre>};<span></span></pre></td></tr></table></div><p>In Mac OS X version 10.2 and later, you can adjust the dimensions of your pane when the initialize function is called. If you do so, and the user displays your pane, the dialog will reflect the adjusted height. For example, you might decide to increase the height of your pane and display additional controls whenever the destination printer is a PostScript printer. For information about using this feature, see <span class="content_text"><a href="../Core/Core.html#//apple_ref/doc/uid/TP30000979-CH206-TPXREF129">“Initialize.”</a></span></p><a name="//apple_ref/doc/uid/TP30000979-CH207-CIHHEAGC" title="Defining a Custom Context"></a><h2>Defining a Custom Context</h2><p>The use of contexts in a printing dialog extension is discussed in <span class="content_text"><a href="../Core/Core.html#//apple_ref/doc/uid/TP30000979-CH206-CIHHEAGC">“Defining a Context”</a></span> and in <span class="content_text"><a href="../Core/Core.html#//apple_ref/doc/uid/TP30000979-CH206-TPXREF128">“Prologue.”</a></span> The sample project factors its context data into two parts:</p><ul class="ul"><li class="li"><p>A generic context contains state information used in the generic code that’s supplied for you in finished form.</p></li><li class="li"><p>A custom context contains state information used in the custom code that you need to adapt for your custom pane.</p></li></ul><p><span class="content_text">Listing 6-4</span> shows how you could define your custom context for a pane that contains one or more controls—for example, a checkbox. The data type <code>MyCustomContextBlock</code> represents the state of this checkbox in a single instance of your pane.</p><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF141" title="Listing 6-4Data types for a custom context"></a><p class="codesample"><strong>Listing 6-4&nbsp;&nbsp;</strong>Data types for a custom context</p><div class="codesample"><table><tr><td scope="row"><pre>typedef struct {<span></span></pre></td></tr><tr><td scope="row"><pre>    ControlRef checkbox;<span></span></pre></td></tr><tr><td scope="row"><pre>} MyControls;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>typedef struct {<span></span></pre></td></tr><tr><td scope="row"><pre>    Boolean selected;<span></span></pre></td></tr><tr><td scope="row"><pre>} MySettings;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>typedef struct {<span></span></pre></td></tr><tr><td scope="row"><pre>    MyControls controls;<span></span></pre></td></tr><tr><td scope="row"><pre>    MySettings settings;<span></span></pre></td></tr><tr><td scope="row"><pre>} MyCustomContextBlock;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>typedef MyCustomContextBlock *MyCustomContext;<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000979-CH207-BBCGCECE" title="Implementing Your Custom Functions"></a><h2>Implementing Your Custom Functions</h2><p>The following sections describe the custom functions in the sample project. If you’re using the sample project as the basis for a real-world project, then you need to implement all the functions presented here. These functions are called from the code described in <span class="content_text"><a href="../Core/Core.html#//apple_ref/doc/uid/TP30000979-CH206-TPXREF127">“Implementing the Required Callbacks.”</a></span></p><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF174" title="Managing a Custom Context"></a><h3>Managing a Custom Context</h3><p>You don’t have to use a custom context. If you do, you need to allocate memory for a new custom context each time a new dialog is created.</p><p><span class="content_text">Listing 6-5</span> shows how your printing dialog extension can create and release an instance of its custom context. The generic code described in <span class="content_text"><a href="../Core/Core.html#//apple_ref/doc/uid/TP30000979-CH206-TPXREF128">“Prologue”</a></span> and <span class="content_text"><a href="../Core/Core.html#//apple_ref/doc/uid/TP30000979-CH206-TPXREF134">“Terminate”</a></span> can’t perform these tasks, because the implementation details of your custom context are private.</p><a name="//apple_ref/doc/uid/TP30000979-CH207-BBCJBFCB" title="Listing 6-5Managing an instance of your custom context"></a><p class="codesample"><strong>Listing 6-5&nbsp;&nbsp;</strong>Managing an instance of your custom context</p><div class="codesample"><table><tr><td scope="row"><pre>extern MyCustomContext MyCreateCustomContext()<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    MyCustomContext context = calloc (1, sizeof (MyCustomContextBlock));<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    return context;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>extern void MyReleaseCustomContext (MyCustomContext context)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    free (context);<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 6-5</span> does:</p><ol class="ol"><li class="li"><p>Allocates zeroed storage for a new custom context. The initialization of your context data is handled in other custom functions.</p></li><li class="li"><p>Frees the storage for the custom context.</p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF128" title="Providing the Title of your Custom Pane"></a><h3>Providing the Title of your Custom Pane</h3><p><span class="content_text">Listing 6-6</span> implements a custom function that provides the title of your custom pane. The printing system displays this title in two places in the dialog—the pane pop-up menu and the Summary pane.</p><p>This implementation gets a localized copy of the title string using the Core Foundation Bundle Services macro <code>CFCopyLocalizedStringFromTableInBundle</code>. The string is retained for re-use, and can be released by passing in <code>FALSE</code>.</p><a name="//apple_ref/doc/uid/TP30000979-CH207-BBCDAJCA" title="Listing 6-6Providing your custom pane title"></a><p class="codesample"><strong>Listing 6-6&nbsp;&nbsp;</strong>Providing your custom pane title</p><div class="codesample"><table><tr><td scope="row"><pre>extern CFStringRef MyGetCustomTitle (Boolean stillNeeded)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    static CFStringRef sTitle = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (stillNeeded)<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        if (sTitle == NULL)<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            sTitle = CFCopyLocalizedStringFromTableInBundle (<span></span></pre></td></tr><tr><td scope="row"><pre>                CFSTR("Custom Feature"),<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>                CFSTR("Localizable"),<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>                MyGetBundle(),<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>                CFSTR("the custom pane title"));<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        if (sTitle != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            CFRelease (sTitle);<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>            sTitle = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return sTitle;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 6-6</span> does:</p><ol class="ol"><li class="li"><p>Checks <code>stillNeeded</code> to see if the caller wants to get or release the string.</p></li><li class="li"><p>Checks to see if a copy of the title string already exists.</p></li><li class="li"><p>Supplies the lookup key for the title string.</p></li><li class="li"><p>Supplies the name of the localized strings file (without the <code>.strings</code> extension) to be searched.</p></li><li class="li"><p>Supplies a reference to your plug-in bundle.</p></li><li class="li"><p>Supplies a comment to assist translators.</p></li><li class="li"><p>Releases the string because the caller passed in <code>FALSE</code>.</p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH207-CACCEIEC" title="Embedding Your Controls in a Dialog Pane"></a><h3>Embedding Your Controls in a Dialog Pane</h3><p><span class="content_text">Listing 6-7</span> implements a custom function that embeds your nib-based controls—in this case, a checkbox—inside the dialog pane provided by the printing system. </p><p>The utility function <code>MyEmbedControl</code><code></code>described in <span class="content_text"><a href="../Utilities/Utilities.html#//apple_ref/doc/uid/TP30000979-CH209-CJADIDJC">“Embedding a Nib-Based Control”</a></span> is used to position and embed each control.</p><a name="//apple_ref/doc/uid/TP30000979-CH207-BBCGCJED" title="Listing 6-7Embedding nib-based controls in a dialog pane"></a><p class="codesample"><strong>Listing 6-7&nbsp;&nbsp;</strong>Embedding nib-based controls in a dialog pane</p><div class="codesample"><table><tr><td scope="row"><pre>extern OSStatus MyEmbedCustomControls (<span></span></pre></td></tr><tr><td scope="row"><pre>    MyCustomContext context,<span></span></pre></td></tr><tr><td scope="row"><pre>    WindowRef nibWindow,<span></span></pre></td></tr><tr><td scope="row"><pre>    ControlRef userPane<span></span></pre></td></tr><tr><td scope="row"><pre>)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    static const ControlID controlID = { kMyBundleCreatorCode, 4001 };<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    OSStatus result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (context != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        result = MyEmbedControl (<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>            nibWindow,<span></span></pre></td></tr><tr><td scope="row"><pre>            userPane,<span></span></pre></td></tr><tr><td scope="row"><pre>            controlID,<span></span></pre></td></tr><tr><td scope="row"><pre>            &amp;(context->controls.checkbox)<span></span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if (context->controls.checkbox != NULL) {<span></span></pre></td></tr><tr><td scope="row"><pre>            SetControlValue (<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>                context->controls.checkbox,<span></span></pre></td></tr><tr><td scope="row"><pre>                context->settings.checkbox<span></span></pre></td></tr><tr><td scope="row"><pre>            );<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 6-7</span> does:</p><ol class="ol"><li class="li"><p>Defines the signature and ID for the control. These values should match the signature and ID assigned to this control in the nib file.</p></li><li class="li"><p>Embeds the control inside your dialog pane. <code>MyEmbedControl</code> passes back a reference to the control, which is saved in the custom context. For an implementation of <code>MyEmbedControl</code>, see <span class="content_text"><a href="../Utilities/Utilities.html#//apple_ref/doc/uid/TP30000979-CH209-CJADIDJC">“Embedding a Nib-Based Control.”</a></span></p></li><li class="li"><p> Initializes the value of the control.</p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF130" title="Synchronizing User Settings With a Ticket"></a><h3>Synchronizing User Settings With a Ticket</h3><p>The purpose of sychronization is explained in <span class="content_text"><a href="../Core/Core.html#//apple_ref/doc/uid/TP30000979-CH206-TPXREF130">“Sync.”</a></span> In the sample project, the actual work of synchronization is done in two custom functions described in <span class="content_text"><a href="Custom.html#//apple_ref/doc/uid/TP30000979-CH207-TPXREF164">“Updating Your Pane”</a></span> and <span class="content_text"><a href="Custom.html#//apple_ref/doc/uid/TP30000979-CH207-TPXREF165">“Updating a Ticket.”</a></span> </p><p>Your custom sync functions need to agree on the data types used to represent your pane settings, both in memory and in the ticket. The sample project uses the data structure <code>MySettings</code> in memory, and <code>CFData</code> in the ticket.</p><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF164" title="Updating Your Pane"></a><h4>Updating Your Pane</h4><p><span class="content_text">Listing 6-8</span> implements a custom function that reads your data from the print settings ticket, and uses it to update the controls in your pane.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000979-CH207-DontLinkElementID_10" title="Note"></a><p><strong>Note:</strong>&nbsp; If your custom printing dialog extension extends the Page Setup dialog, then this function should update the page format ticket.</p></div><a name="//apple_ref/doc/uid/TP30000979-CH207-BBCECACC" title="Listing 6-8A custom function to update your pane"></a><p class="codesample"><strong>Listing 6-8&nbsp;&nbsp;</strong>A custom function to update your pane</p><div class="codesample"><table><tr><td scope="row"><pre>extern OSStatus MySyncPaneFromTicket (<span></span></pre></td></tr><tr><td scope="row"><pre>    MyCustomContext context,<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPrintSession session<span></span></pre></td></tr><tr><td scope="row"><pre>)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CFDataRef data = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFIndex length = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>    PMTicketRef ticket = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    result = MyGetTicket (session, kPDE_PMPrintSettingsRef, &amp;ticket);<span>// 1</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (result == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        result = PMTicketGetCFData (<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>            ticket,<span></span></pre></td></tr><tr><td scope="row"><pre>            kPMTopLevel,<span></span></pre></td></tr><tr><td scope="row"><pre>            kPMTopLevel,<span></span></pre></td></tr><tr><td scope="row"><pre>            kMyAppPrintSettingsKey,<span></span></pre></td></tr><tr><td scope="row"><pre>            &amp;data<span></span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if (result == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            length = CFDataGetLength (data);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            if (length == sizeof(MySettings))<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                CFDataGetBytes (<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>                    data,<span></span></pre></td></tr><tr><td scope="row"><pre>                    CFRangeMake(0,length),<span></span></pre></td></tr><tr><td scope="row"><pre>                    (UInt8*) &amp;(context->settings)<span></span></pre></td></tr><tr><td scope="row"><pre>                );<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>            else<span></span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                result = kPMKeyNotFound;<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if (result == kPMKeyNotFound)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            context->settings.checkbox = FALSE;<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>            result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if ((result == noErr) &amp;&amp; (context->controls.checkbox != NULL))<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        SetControlValue (<span></span></pre></td></tr><tr><td scope="row"><pre>            context->controls.checkbox,<span></span></pre></td></tr><tr><td scope="row"><pre>            context->settings.checkbox<span></span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 6-8</span> does:</p><ol class="ol"><li class="li"><p>Gets a reference to the print settings ticket using the utility function described in <span class="content_text"><a href="../Utilities/Utilities.html#//apple_ref/doc/uid/TP30000979-CH209-CJABDCCF">“Getting a Ticket Reference.”</a></span></p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000979-CH207-DontLinkElementID_11" title="Warning"></a><p><strong>Warning:</strong>&nbsp; The printing system retains ownership of the ticket reference you obtain, and it could become invalid later. For this reason, you should use the reference for the task at hand and then discard it. Do not save this reference in your context.</p></div></li><li class="li"><p>Checks the ticket for your custom data item. If the item exists, a reference to the data is passed back. Otherwise the result code <code>kPMKeyNotFound</code> is returned. For more information about retrieving data from tickets, see <span class="content_text"><a href="../Integration/Integration.html#//apple_ref/doc/uid/TP30000979-CH208-TPXREF174">“Accessing Ticket Data.”</a></span></p></li><li class="li"><p>Checks to make sure the ticket data has the expected length.</p></li><li class="li"><p>Copies the bytes into your custom context.</p></li><li class="li"><p>Initializes the setting to its default value. This code executes when the ticket has no data item for this setting, or the data item found is not the correct size.</p></li><li class="li"><p>Uses your context to update the control. The Control Manager takes care of redrawing the control.</p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF165" title="Updating a Ticket"></a><h4>Updating a Ticket</h4><p><span class="content_text">Listing 6-9</span> implements a custom function that reads the current values of the controls in your pane, and updates your data in the print settings ticket.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000979-CH207-DontLinkElementID_12" title="Note"></a><p><strong>Note:</strong>&nbsp; If your custom printing dialog extension extends the Page Setup dialog, then this function should update the page format ticket.</p></div><a name="//apple_ref/doc/uid/TP30000979-CH207-BBCEJCDI" title="Listing 6-9A custom function that updates the print settings ticket"></a><p class="codesample"><strong>Listing 6-9&nbsp;&nbsp;</strong>A custom function that updates the print settings ticket</p><div class="codesample"><table><tr><td scope="row"><pre>extern OSStatus MySyncTicketFromPane<span></span></pre></td></tr><tr><td scope="row"><pre>(<span></span></pre></td></tr><tr><td scope="row"><pre>    MyCustomContext context,<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPrintSession session<span></span></pre></td></tr><tr><td scope="row"><pre>)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CFDataRef data = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>    PMTicketRef ticket = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    result = MyGetTicket (session, kPDE_PMPrintSettingsRef, &amp;ticket);<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    if (result == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        if (context->controls.checkbox != NULL) {<span></span></pre></td></tr><tr><td scope="row"><pre>            context->settings.checkbox =<span></span></pre></td></tr><tr><td scope="row"><pre>                GetControlValue (context->controls.checkbox);<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        data = CFDataCreate (<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>            kCFAllocatorDefault,<span></span></pre></td></tr><tr><td scope="row"><pre>            (UInt8*) &amp;context->settings,<span></span></pre></td></tr><tr><td scope="row"><pre>            sizeof(MySettings)<span></span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if (data != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            result = PMTicketSetCFData (<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>                ticket,<span></span></pre></td></tr><tr><td scope="row"><pre>                kMyBundleIdentifier,<span></span></pre></td></tr><tr><td scope="row"><pre>                kMyAppPrintSettingsKey,<span></span></pre></td></tr><tr><td scope="row"><pre>                data,<span></span></pre></td></tr><tr><td scope="row"><pre>                kPMUnlocked<span></span></pre></td></tr><tr><td scope="row"><pre>            );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            CFRelease (data);<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 6-9</span> does:</p><ol class="ol"><li class="li"><p>Gets a reference to the print settings ticket, using the utility function described in <span class="content_text"><a href="../Utilities/Utilities.html#//apple_ref/doc/uid/TP30000979-CH209-CJABDCCF">“Getting a Ticket Reference.”</a></span></p></li><li class="li"><p>Reads the current value of the control.</p><p>You might choose to validate the control settings at this point. If you find an error, you should provide feedback and return the result code <code>kPMDontSwitchPDEError</code> to prevent the user from switching to another pane.</p></li><li class="li"><p>Creates a <code>CFData</code> representation of your settings data.</p></li><li class="li"><p>Adds a new ticket entry—or updates an existing ticket entry—with the current settings data. For more detailed information about storing data in tickets, see <span class="content_text"><a href="../Integration/Integration.html#//apple_ref/doc/uid/TP30000979-CH208-TPXREF174">“Accessing Ticket Data.”</a></span></p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF131" title="Supplying Summary Text"></a><h3>Supplying Summary Text</h3><p>When a user selects the Summary pane in a printing dialog, each active printing dialog extension is polled for its summary text.</p><p>In <span class="content_text">Figure 6-1</span>, the Summary pane tells the user that the checkbox in the Custom Feature pane is now selected.</p><br/><div><a name="//apple_ref/doc/uid/TP30000979-CH207-BBCGIJGC" title="Figure 6-1The Summary pane in the Print dialog"></a><p><strong>Figure 6-1&nbsp;&nbsp;</strong>The Summary pane in the Print dialog</p><img src = "../Art/summary_pane.gif" alt = "The Summary pane in the Print dialog" width="365" height="290"></div><br/><p><span class="content_text">Listing 6-10</span> implements a custom function that supplies the summary text for the Custom Feature setting in <span class="content_text">Figure 6-1</span>. This function copies localized descriptions of the title and current value of the setting into two summary arrays.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000979-CH207-DontLinkElementID_13" title="Note"></a><p><strong>Note:</strong>&nbsp; If your custom pane has more than one setting, you could write a summary function for each setting.</p></div><a name="//apple_ref/doc/uid/TP30000979-CH207-CIHHHAAJ" title="Listing 6-10Custom function to supply summary text for a setting"></a><p class="codesample"><strong>Listing 6-10&nbsp;&nbsp;</strong>Custom function to supply summary text for a setting</p><div class="codesample"><table><tr><td scope="row"><pre>extern OSStatus MyGetSummaryText (<span></span></pre></td></tr><tr><td scope="row"><pre>    MyContext context,<span></span></pre></td></tr><tr><td scope="row"><pre>    CFMutableArrayRef titleArray,<span></span></pre></td></tr><tr><td scope="row"><pre>    CFMutableArrayRef valueArray<span></span></pre></td></tr><tr><td scope="row"><pre>)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CFStringRef title = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFStringRef value = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus result = kPMInvalidPDEContext;<span>// 1</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    title = CFCopyLocalizedStringFromTableInBundle (<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>        CFSTR("Setting #1"),<span></span></pre></td></tr><tr><td scope="row"><pre>        CFSTR("Localizable"),<span></span></pre></td></tr><tr><td scope="row"><pre>        MyGetBundle(),<span></span></pre></td></tr><tr><td scope="row"><pre>        CFSTR("the title of our first setting"));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (title != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        SInt16 controlValue = GetControlValue (context->controls.item1);<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>        if (controlValue == 0)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            value = CFCopyLocalizedStringFromTableInBundle (<span></span></pre></td></tr><tr><td scope="row"><pre>                CFSTR("Off"),<span></span></pre></td></tr><tr><td scope="row"><pre>                CFSTR("Localizable"),<span></span></pre></td></tr><tr><td scope="row"><pre>                MyGetBundle(),<span></span></pre></td></tr><tr><td scope="row"><pre>                CFSTR("the value of setting #1 when not selected"));<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        else<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            value = CFCopyLocalizedStringFromTableInBundle (<span></span></pre></td></tr><tr><td scope="row"><pre>                CFSTR("On"),<span></span></pre></td></tr><tr><td scope="row"><pre>                CFSTR("Localizable"),<span></span></pre></td></tr><tr><td scope="row"><pre>                MyGetBundle(),<span></span></pre></td></tr><tr><td scope="row"><pre>                CFSTR("the value of setting #1 when selected"));<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if (value != NULL)<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            CFArrayAppendValue (titleArray, title);<span></span></pre></td></tr><tr><td scope="row"><pre>            CFArrayAppendValue (valueArray, value);<span></span></pre></td></tr><tr><td scope="row"><pre>            CFRelease (value);<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>            result = noErr;<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease (title);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 6-10</span> does:</p><ol class="ol"><li class="li"><p>Sets the default result code to a non-zero value.</p></li><li class="li"><p>Gets the appropriate localized string from the <code>Localizable.strings </code> file in the plug-in bundle.</p></li><li class="li"><p>Gets the current integer value of the checkbox, assumed to be zero or one.</p></li><li class="li"><p>Appends each string to the end of the corresponding array. This transaction is done only if both strings are defined.</p></li><li class="li"><p>Releases the value string. Releasing the string is safe to do because <code>CFArrayAppendValue</code> retained it.</p></li><li class="li"><p>Sets the result code to <code>noErr</code>. This is done only after both arrays have been successfully updated.</p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH207-CACBHDBD" title="Handling PostScript Features"></a><h2>Handling PostScript Features</h2><div class="notebox"><a name="//apple_ref/doc/uid/TP30000979-CH207-DontLinkElementID_14" title="Note"></a><p><strong>Note:</strong>&nbsp;This section applies to PostScript printer vendors only. If you are an application developer, you do not need to read this section.</p></div><p>A PostScript printer module can use a printing dialog extension to present features described in a PostScript printer description (PPD) file. At runtime, the printing dialog extension must tell the printing system what PostScript code needs to be emitted for these features.</p><p>The printing dialog extension does this by adding entries to a special dictionary called PPDDict. The Ticket Services function <code>PMTicketGetPPDDict</code> obtains PPDDict from the print settings ticket.</p><p>For each PPD feature it presents, the printing dialog extension adds a key-value pair to PPDDict. The key is the PPD Main keyword for that feature, and the value is the PPD Option keyword that corresponds to the feature’s setting. Adding this key-value pair to PPDDict causes the printing system to insert the PostScript code corresponding to that Main-Option keyword pair when it generates the PostScript code for the print job.</p><p>For example, consider a PostScript feature that allows the user to route printed pages to an upper or lower output bin. <span class="content_text">Listing 6-11</span> shows the PPD entry for this feature.</p><a name="//apple_ref/doc/uid/TP30000979-CH207-CACCBJJJ" title="Listing 6-11PPD entry for the output bin feature"></a><p class="codesample"><strong>Listing 6-11&nbsp;&nbsp;</strong>PPD entry for the output bin feature</p><div class="codesample"><table><tr><td scope="row"><pre>*OpenUI *OutputBin/Output Bin: PickOne<span></span></pre></td></tr><tr><td scope="row"><pre>*OrderDependency: 50 AnySetup *OutputBin<span></span></pre></td></tr><tr><td scope="row"><pre>*DefaultOutputBin: Upper<span></span></pre></td></tr><tr><td scope="row"><pre>*OutputBin Upper/Upper: "1 dict dup /OutputFaceUp false put setpagedevice"<span></span></pre></td></tr><tr><td scope="row"><pre>*OutputBin Lower/Lower: "1 dict dup /OutputFaceUp true put setpagedevice"<span></span></pre></td></tr><tr><td scope="row"><pre>*CloseUI: *OutputBin<span></span></pre></td></tr></table></div><p>If you use a printing dialog extension to present this feature and allow users to modify its setting, you need to do the following:</p><ol class="ol"><li class="li"><p>Add an output bin control to your custom pane.</p></li><li class="li"><p>Use the mechanism described in <span class="content_text"><a href="../Project/Project.html#//apple_ref/doc/uid/TP30000979-CH205-CJBBDDGH">“Registering PPD Main Keywords”</a></span> to ensure that output bin appears only in your pane, and not in the Printer Features pane.</p></li><li class="li"><p>In your custom <code>MySyncPaneFromTicket</code> function, get the current bin setting from the print settings ticket. In your custom <code>MySyncTicketFromPane</code> function, update the ticket with the current bin setting.</p></li></ol><p>The following sections show how to implement the synchronization tasks described in step 3.</p><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF175" title="Getting a PostScript Setting from a Print Settings Ticket"></a><h3>Getting a PostScript Setting from a Print Settings Ticket</h3><p><span class="content_text">Listing 6-12</span> implements a function that gets PPDDict in a print settings ticket and uses PPDDict to get the current bin selection.</p><a name="//apple_ref/doc/uid/TP30000979-CH207-CACEAHFG" title="Listing 6-12Getting a PostScript setting"></a><p class="codesample"><strong>Listing 6-12&nbsp;&nbsp;</strong>Getting a PostScript setting</p><div class="codesample"><table><tr><td scope="row"><pre>typedef enum {LOWER, UPPER} MyBinType;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>OSStatus MyGetOutputBin (CFTicketRef printSettings, MyBinType *bin)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CFMutableDictionaryRef ppdDict = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    result = PMTicketGetPPDDict (<span></span></pre></td></tr><tr><td scope="row"><pre>        printSettings, kPMTopLevel, kPMTopLevel, &amp;ppdDict);<span>// 1</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (result == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        CFStringRef str = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if (CFDictionaryGetValueIfPresent (<span></span></pre></td></tr><tr><td scope="row"><pre>            ppdDict, CFSTR("OutputBin"), &amp;str)<span></span></pre></td></tr><tr><td scope="row"><pre>                &amp;&amp; CFGetTypeID (str) == CFStringGetTypeID())<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            if (CFStringCompare (<span></span></pre></td></tr><tr><td scope="row"><pre>                str, CFSTR("Upper"), 0) == kCFCompareEqualTo)<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>                { *bin = UPPER; }<span></span></pre></td></tr><tr><td scope="row"><pre>            else<span></span></pre></td></tr><tr><td scope="row"><pre>                { *bin = LOWER; }<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        *bin = UPPER;<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 6-12</span> does:</p><ol class="ol"><li class="li"><p>Gets a reference to PPDDict in the print settings ticket.</p></li><li class="li"><p>Finds the desired key-value pair and verifes that its value is a CFString.</p></li><li class="li"><p>Finds out which bin is selected, and passes back the appropriate value.</p></li><li class="li"><p>Initializes the setting to a hard-coded default value because there is no valid entry already in PPDDict. A more appropriate implementation would obtain the default setting for this feature from the current PPD file.</p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH207-TPXREF176" title="Updating a PostScript Setting in a Print Settings Ticket"></a><h3>Updating a PostScript Setting in a Print Settings Ticket</h3><p><span class="content_text">Listing 6-13</span> implements a function that gets PPDDict from a print settings ticket, and uses the current bin selection to update the output bin setting in PPDDict.</p><a name="//apple_ref/doc/uid/TP30000979-CH207-CACICBAB" title="Listing 6-13Updating a PostScript setting"></a><p class="codesample"><strong>Listing 6-13&nbsp;&nbsp;</strong>Updating a PostScript setting</p><div class="codesample"><table><tr><td scope="row"><pre>OSStatus MySetOutputBin (CFTicketRef printSettings, MyBinType bin)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CFMutableDictionaryRef ppdDict = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    result = PMTicketGetPPDDict (<span></span></pre></td></tr><tr><td scope="row"><pre>        printSettings, kPMTopLevel, kPMTopLevel, &amp;ppdDict);<span>// 1</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (result == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        switch (bin)<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>        case LOWER:<span></span></pre></td></tr><tr><td scope="row"><pre>        CFDictionarySetValue (<span></span></pre></td></tr><tr><td scope="row"><pre>            ppdDict, CFSTR("OutputBin"), CFSTR("Lower"));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        case UPPER:<span></span></pre></td></tr><tr><td scope="row"><pre>        default:<span></span></pre></td></tr><tr><td scope="row"><pre>        CFDictionarySetValue (<span></span></pre></td></tr><tr><td scope="row"><pre>            ppdDict, CFSTR("OutputBin"), CFSTR("Upper"));<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 6-13</span> does:</p><ol class="ol"><li class="li"><p>Gets a reference to PPDDict from the print settings ticket.</p></li><li class="li"><p>Updates the bin setting in PPDDict.</p></li></ol>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../Core/Core.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../Integration/Integration.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2002, 2006 Apple Computer, Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2006-10-03<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Printing/Conceptual/ExtPrintingDialogs/Custom/Custom.html%3Fid%3DTP30000979-2.2&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Printing/Conceptual/ExtPrintingDialogs/Custom/Custom.html%3Fid%3DTP30000979-2.2&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Printing/Conceptual/ExtPrintingDialogs/Custom/Custom.html%3Fid%3DTP30000979-2.2&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>