<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Building Darwin HOWTO</title><meta name="generator" content="DocBook XSL Stylesheets V1.42"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><a name="//apple_ref/doc/uid/TP40000987"></a><div class="article"><div class="titlepage"><div><h1 class="title"><a name="building-darwin-howto"></a>Building Darwin HOWTO</h1></div><div><h3 class="author">Rob Braun</h3><div class="affiliation"><span class="jobtitle">Darwin Committer<br></span><div class="address"><tt>&lt;<a href="mailto:bbraun@synack.net">bbraun@synack.net</a>&gt;</tt><br>
&nbsp;&nbsp;&nbsp;&nbsp;</div></div></div><div><div class="revhistory"><table border="1" width="100%" summary="Revision history"><tr><th align="left" valign="top" colspan="3"><b>Revision History</b></th></tr><tr><td align="left" scope="row">Revision 2</td><td align="left">8 October 2001</td><td align="left">rjh - rhayden@apple.com</td></tr><tr><td align="left" colspan="3" scope="row">Changed title to "Darwin Committer".</td></tr><tr><td align="left" scope="row">Revision 1</td><td align="left">1 May 2001</td><td align="left">rb - bbraun@synack.net</td></tr><tr><td align="left" colspan="3" scope="row">Created.</td></tr></table></div></div><div><div class="abstract"><p><a name="d0e51"></a><b>Abstract</b></p><p>Darwin's build system builds new packages within a chroot'ed environment consisting entirely of previously built packages. For example, building a new version of xnu installs all the components needed for building xnu, into a chrooted environment, and then starts building xnu in that chrooted environment. Obviously, this leads to a paradox, since you'll need existing packages before you can build anything with this system. Luckily, I have prepared packages for the entire Darwin 1.2 distribution and have made them available at <a href="http://www.darwinfo.org/pub/darwin/built/" target="_top">http://www.darwinfo.org/pub/darwin/built/</a>. <span class="emphasis"><i>You do not need to install these packages</i></span>. They are used by the build process in their packaged form.</p></div></div><hr></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><a href="#tools">Tools</a></dt><dt><a href="#building-individual-packages">Building Individual Packages</a></dt><dd><dl><dt><a href="#building-local-directory-package">Building a Package from a local directory</a></dt><dt><a href="#building-cvs-package">Building a Package from cvs</a></dt></dl></dd><dt><a href="#building-everything">Building Everything</a></dt><dd><dl><dt><a href="#darwin-buildall">The darwin-buildall script</a></dt><dt><a href="#manifest-file">The Manifest File</a></dt></dl></dd><dt><a href="#installing-packages">Installing Packages</a></dt><dt><a href="#adding-package">Adding a package to the Build System</a></dt><dd><dl><dt><a href="#adding-gnu-package">Adding a GNU Autoconf package</a></dt><dt><a href="#adding-3rd-party">Adding a 3rd Party Package</a></dt></dl></dd><dt><a href="#d0e512">Copyright</a></dt></dl></div><div class="sect1"><a name="tools"></a><div class="titlepage"><div><h2 class="title" style="clear: both"><a name="tools"></a>Tools</h2></div></div><p>When building packages, the Darwin build system uses the 
<tt>Tools/buildtools</tt> from the Darwin cvs repository. You should check out the latest version and install it before attempting to use the build system. The current system uses a series of perl scripts around the dpkg format, that is why all the packages are <tt>.deb</tt>. The scripts used are <tt>darwin-buildpackage</tt> and <tt>darwin-buildall</tt>. These scripts use the perl modules <tt>Dpkg/Package/Builder.pm</tt> and <tt>Dpkg/Package/Manifest.pm</tt>. All these files are included in the buildtools that you should have checked out and installed already.</p></div><div class="sect1"><a name="building-individual-packages"></a><div class="titlepage"><div><h2 class="title" style="clear: both"><a name="building-individual-packages"></a>Building Individual Packages</h2></div></div><p>To build an individual package, you will need buildtools from the cvs repository, and the latest packages needed for building the package you wish to build. That's a bit confusing, so just get the entire directory of packages.</p><p>There are two ways to build packages, you can build one from an existing source directory on your local disk, or you can build straight from the cvs repository. I'll cover both of these methods, starting with building from an existing source directory. For these examples it will be assumed that your existing packages are in <tt>/src/in</tt> and the directory where you wish the new packages to be deposited is <tt>/src/out</tt>. One important thing to note is that if a required package for building exists in the out directory, it will be used instead of the package in the in directory. This way, you can leave your in directory intact, and use your most recent packages for building.</p><p>When building the package, the default build location is <tt>/tmp/roots/packagename-version</tt>. This is where the required packages will be installed, and the new package will be built. If you wish to change the build location, set the <tt>BUILDIT_DIR</tt> environment variable to your desired build location. For (t)csh:</p><p><b>setenv BUILDIT_DIR /src/buildit</b></p><p>For Bourne shell:</p><p><b>export BUILDIT_DIR=/src/buildit</b></p><div class="sect2"><a name="building-local-directory-package"></a><div class="titlepage"><div><h3 class="title"><a name="building-local-directory-package"></a>Building a Package from a local directory</h3></div></div><p>For this example, it will be assumed that the source directory you're trying to build is <tt>/src/package</tt>. To build the package, execute the following as root:</p><p><b>darwin-buildpackage --dir /src/package /src/in /src/out</b></p><p>You have to execute the command as root, since the script will be creating a chrooted environment, installing the necessary tools, building the package, installing it into the chrooted environment, and then packaging it all up.</p></div><div class="sect2"><a name="building-cvs-package"></a><div class="titlepage"><div><h3 class="title"><a name="building-cvs-package"></a>Building a Package from cvs</h3></div></div><p>The first thing you'll have to do for this is to setup your anonymous cvs environment. You'll have to get your anonymous cvs login from Apple, set your <tt>CVSROOT</tt> environment variable, and login to the cvs server. There are instructions to do that on the Apple anoncvs site, <a href="http://www.opensource.apple.com/tools/cvs" target="_top">http://www.opensource.apple.com/tools/cvs</a>.</p><p>Once you've got your anonymous cvs account and environment setup, you can start building by running the following command as root:</p><p><b>darwin-buildpackage --cvs package-tag /src/in /src/out</b></p><p>The <i><tt>package-tag</tt></i> is the cvs tag for the project you want to build. For example, <b><tt>xnu-3.1</tt></b>.</p></div></div><div class="sect1"><a name="building-everything"></a><div class="titlepage"><div><h2 class="title" style="clear: both"><a name="building-everything"></a>Building Everything</h2></div></div><p>You can build an entire distribution, or just a subset of it, all at once. This uses the <b>darwin-buildall</b> script, and uses a <tt>Manifest</tt> file to describe which packages to build. The <b>buildall</b> script only builds from the cvs repository with the cvs tagged versions specified in the <tt>Manifest</tt> file. The <tt>Manifest</tt> file can be checked out from the cvs tree, and is located in <tt>Darwin/Manifest</tt>. This section will first describe the use of the <b>buildall</b> script, and then discuss the format of the <tt>Manifest</tt> file.</p><div class="sect2"><a name="darwin-buildall"></a><div class="titlepage"><div><h3 class="title"><a name="darwin-buildall"></a>The darwin-buildall script</h3></div></div><p>Before running the <b>buildall</b> script, you should setup your anoncvs environment, as discussed <a href="#building-cvs-package" title="Building a Package from cvs">earlier</a>. Also, your build location (specified in the <tt>BUILDIT_DIR</tt> environment variable, defaulting to <tt>/tmp/roots</tt>) should be a UFS filesystem, otherwise some packages will not build correctly (because of HFS+'s case insensitivity). To run the buildall script execute the following as root:</p><p><b>darwin-buildall Manifest /src/in /src/out</b></p><p>This will check out source from the cvs tree, with the cvs tag specified in the <tt>Manifest</tt> file, and build it in your build location. The <b>buildall</b> script will progress through the <tt>Manifest</tt> file starting at the top, and continuing to the next item only after successfully checking out and building the current item.</p></div><div class="sect2"><a name="manifest-file"></a><div class="titlepage"><div><h3 class="title"><a name="manifest-file"></a>The Manifest File</h3></div></div><p>The Manifest file consistes of one package per line, in the format of:</p><div class="literallayout">src&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;project-version&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target</div><p><i><tt>src</tt></i> is where to get the package from. For the Darwin Manifest in the cvs tree, this is always <b><tt>cvs</tt></b>. The only other valid option is <b><tt>dir</tt></b>, and it will use the next item on the line as the directory to use as the source directory.</p><p><i><tt>project-version</tt></i> is the project to build. If the <i><tt>src</tt></i> is <b><tt>cvs</tt></b>, then this is the cvs tag to check out. If the <i><tt>src</tt></i> is <b><tt>dir</tt></b>, then this is the directory to use for the package source.</p><p><i><tt>target</tt></i> is almost always set to <b><tt>all</tt></b>.</p><p>The # character is a comment, so you can comment out different projects that won't build with your current packages.</p></div></div><div class="sect1"><a name="installing-packages"></a><div class="titlepage"><div><h2 class="title" style="clear: both"><a name="installing-packages"></a>Installing Packages</h2></div></div><p>Although Darwin comes with the dpkg utilities, it has no dpkg database, so it is very difficult to use with Darwin. The easiest way to install <tt>.deb</tt>'s under darwin is to do it by hand. Remember that a <tt>.deb</tt> is just a bunch of <tt>.tar.gz</tt> files <b>ar</b>'d together. So to extract the data from a <tt>.deb</tt> file you can do the following:</p><p><b>ar x file.deb</b></p><p>This will give you several files, but the important one is <tt>data.tar.gz</tt>. This is the actual data files from the <tt>.deb</tt>. Then you can <b>cd /</b> and extract the <b>data.tar.gz</b> file. You should use <b>gnutar</b> to extract the file, because of minor behavioral differences between the BSD tar and GNU tar.</p></div><div class="sect1"><a name="adding-package"></a><div class="titlepage"><div><h2 class="title" style="clear: both"><a name="adding-package"></a>Adding a package to the Build System</h2></div></div><p>If you want to add a package to the build system, there are a couple of things needed. If the package is designed to be built with GNU make (most of them), the process is fairly straight forward. For this example, I'll take the example of <b>xinetd</b>. <b>xinetd</b> is setup to use the GNU autoconf <b>configure</b> script. Here's the series of steps I went through to get <b>xinetd</b> building under the Darwin Build System.</p><div class="sect2"><a name="adding-gnu-package"></a><div class="titlepage"><div><h3 class="title"><a name="adding-gnu-package"></a>Adding a GNU Autoconf package</h3></div></div><div class="itemizedlist"><ul><li><p><a name="d0e341"></a>Download the package. The version I'm using is <tt>2.1.8.9pre14</tt>, so the package is <tt>xinetd-2.1.8.9pre14.tar.gz</tt>.</p></li><li><p><a name="d0e350"></a>Unpack the package. After untarring the package, I have the directory <tt>xinetd-2.1.8.9pre14</tt></p></li><li><p><a name="d0e355"></a>Create a directory above the package's directory. Create a directory <tt>xinetd</tt> and move <tt>xinetd-2.1.8.9pre14</tt> into the newly created <tt>xinetd</tt> directory and rename it <tt>xinetd</tt> as well:</p><p><b>mkdir xinetd</b></p><p><b>mv xinetd-2.1.8.9pre14 xinetd/xinetd</b></p></li><li><p><a name="d0e376"></a>Create a dpkg control file. Create the dpkg directory <tt>xinetd/dpkg</tt>, and create a <tt>control</tt> file. The <tt>control</tt> file should be similar to the following:</p><div class="literallayout"><br>
Package:&nbsp;xinetd<br>
Maintainer:&nbsp;Synack&nbsp;Communications&nbsp;<br>
Vendor:&nbsp;Synack&nbsp;Communications<br>
Version:&nbsp;2.1.8.9pre14<br>
Build-Depends:&nbsp;build-base<br>
Description:&nbsp;xinetd&nbsp;is&nbsp;a&nbsp;replacement&nbsp;for&nbsp;inetd.<br>
</div><p>The <i><tt>Build-Depends</tt></i> tag is a space separated list of packages required to build the package. <i><tt>build-base</tt></i> is a predefined tag that consists of the compiler and most libraries and utilities needed to build most packages.</p></li><li><p><a name="d0e404"></a>Create a high level package <tt>Makefile</tt>. Create a <tt>Makefile</tt>, <tt>xinetd/Makefile</tt>, that looks like:</p><div class="literallayout"><br>
Project&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;xinetd<br>
UserType&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Administrator<br>
ToolType&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Commands<br>
Extra_Configure_Flags&nbsp;=&nbsp;--with-libwrap<br>
<br>
#&nbsp;It's&nbsp;a&nbsp;GNU&nbsp;Source&nbsp;project<br>
include&nbsp;$(MAKEFILEPATH)/CoreOS/ReleaseControl/GNUSource.make<br>
<br>
Install_Target&nbsp;=&nbsp;install<br>
</div><p>The <tt>Extra_Configure_Flags</tt> is a list of flags to pass to <b>configure</b>.</p></li><li><p><a name="d0e426"></a>Build the package. Run the command to build the system:</p><p><b>sudo darwin-buildpackage --dir xinetd in out</b></p><p>Now, assuming the package properly supports the use of the <i><tt>--srcdir</tt></i> flag to <b>configure</b>, the package will build correctly. Very odd errors can happen when trying to build a package under the Darwin Build System, because it does not build the package in the source directory. Instead it has a separate temporary directory for the intermediate object files.</p></li></ul></div></div><div class="sect2"><a name="adding-3rd-party"></a><div class="titlepage"><div><h3 class="title"><a name="adding-3rd-party"></a>Adding a 3rd Party Package</h3></div></div><p>This section describes how to add a package to the Darwin build system that does not use the GNU Autoconf system to build the project. This section will be rather generic, since a "3rd Party Package" can do just about anything to build its self.</p><div class="itemizedlist"><ul><li><p><a name="d0e449"></a>Get the package. For this example, I'll use <tt>mkisofs</tt>.</p></li><li><p><a name="d0e455"></a>Put the package in a nested directory in <tt>mkisofs/mkisofs</tt>. This will let the wrapper <tt>Makefile</tt> and control files go in the top directory, and the actual unmodified source go in the lower directory.</p></li><li><p><a name="d0e464"></a>Create a <tt>mkisofs/dpkg</tt> directory, and a control file within it. The control file should be similar to the one mentioned in the previous GNU Autoconf example.</p></li><li><p><a name="d0e470"></a>Create the wrapper <tt>Makefile</tt>. The <tt>Makefile</tt> will look similar to this:</p><div class="literallayout"><br>
#&nbsp;Project&nbsp;info<br>
<br>
#&nbsp;Project&nbsp;should&nbsp;be&nbsp;the&nbsp;project&nbsp;name,&nbsp;but&nbsp;also&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;subdirectory<br>
#&nbsp;where&nbsp;the&nbsp;project&nbsp;actually&nbsp;lives.<br>
Project&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;mkisofs<br>
UserType&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Administration<br>
ToolType&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Commands<br>
#&nbsp;Extra_Environment&nbsp;is&nbsp;a&nbsp;variable&nbsp;you&nbsp;can&nbsp;set&nbsp;with&nbsp;extra&nbsp;environment&nbsp;variables<br>
#&nbsp;while&nbsp;building&nbsp;the&nbsp;project<br>
Extra_Environment&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=<br>
<br>
#&nbsp;It's&nbsp;a&nbsp;3rd&nbsp;Party&nbsp;Source&nbsp;project,&nbsp;meaning&nbsp;it&nbsp;doesn't&nbsp;use&nbsp;autoconf&nbsp;or&nbsp;the<br>
#&nbsp;BSD&nbsp;style&nbsp;project&nbsp;building...<br>
include&nbsp;$(MAKEFILEPATH)/CoreOS/ReleaseControl/Common.make<br>
<br>
#&nbsp;Dunno,&nbsp;just&nbsp;copied&nbsp;over&nbsp;and&nbsp;it&nbsp;makes&nbsp;things&nbsp;happy.<br>
lazy_install_source::&nbsp;shadow_source<br>
<br>
#&nbsp;Every&nbsp;project&nbsp;should&nbsp;have&nbsp;a&nbsp;'build'&nbsp;target.&nbsp;&nbsp;This&nbsp;is&nbsp;the&nbsp;target&nbsp;that<br>
#&nbsp;the&nbsp;build&nbsp;scripts&nbsp;use&nbsp;to&nbsp;compile&nbsp;the&nbsp;whole&nbsp;thing.<br>
build::&nbsp;lazy_install_source<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@echo&nbsp;"Building&nbsp;$(Project)..."<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Fill&nbsp;in&nbsp;necessary&nbsp;commands&nbsp;to&nbsp;build&nbsp;the&nbsp;project<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Example&nbsp;make&nbsp;command:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#$(_v)&nbsp;$(MAKE)&nbsp;-C&nbsp;$(BuildDirectory)/$(Project)&nbsp;$(Environment)<br>
<br>
#&nbsp;Every&nbsp;project&nbsp;should&nbsp;also&nbsp;have&nbsp;an&nbsp;'install'&nbsp;target.&nbsp;&nbsp;This&nbsp;is&nbsp;the&nbsp;target<br>
#&nbsp;the&nbsp;build&nbsp;scripts&nbsp;use&nbsp;to&nbsp;install&nbsp;the&nbsp;package,&nbsp;and&nbsp;wrap&nbsp;it&nbsp;up.<br>
install::&nbsp;build<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@echo&nbsp;"Installing&nbsp;$(Project)..."<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Fill&nbsp;in&nbsp;the&nbsp;necissary&nbsp;commands&nbsp;to&nbsp;install&nbsp;the&nbsp;project<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Example&nbsp;make&nbsp;install&nbsp;command:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#$(_v)&nbsp;$(MAKE)&nbsp;-C&nbsp;$(BuildDirectory)/$(Project)&nbsp;$(Environment)&nbsp;install<br>
</div><p>This <tt>Makefile</tt> includes the "<tt>Common.make</tt>" file, which sets up a bunch of the make rules you'll need, but it does not setup the <i><tt>build</tt></i> or <i><tt>install</tt></i> targets. These are the two targets you'll need to implement in your <tt>Makefile</tt> for the build system to work correctly.</p></li></ul></div><p>You <span class="emphasis"><i>will</i></span> run into problems when trying to get the build system to work. There are a couple of things you'll need to remember. First, you cannot modify the source. Second, you're building in a directory separate from where the source lives. The latter will often cause problems because Makefile variables are setup expecting to be built in the source directory. If it is a simple matter of <tt>Makefile</tt> variables, you can override them with the <tt>Extra_Environment</tt> variable in the wrapper <tt>Makefile</tt>.</p></div></div><div class="sect1"><a name="d0e512"></a><div class="titlepage"><div><h2 class="title" style="clear: both"><a name="d0e512"></a>Copyright</h2></div></div><p>Copyright &copy; 2001 by Rob Braun.</p><p>This material has been released under and is subject to the terms of the Common Documentation License, v.1.0, the terms of which are hereby incorporated by reference. Please obtain a copy of the License at <a href="http://www.opensource.apple.com/cdl/" target="_top">http://www.opensource.apple.com/cdl/</a> and read it before using this material. Your use of this material signifies your agreement to the terms of the License.</p></div></div></body></html>