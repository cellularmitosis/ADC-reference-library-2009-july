<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Writing and Installing Coercion Handlers(IM:IC)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING125></A>


<!-- Top of Header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- Bottom of Header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="IAC-124.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="IAC-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="IAC-529.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="IAC-126.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="IAC-2.html"><B>Interapplication Communication</B></A> / <BR><DD><A HREF="IAC-115.html"><B>Chapter 4 - Responding to Apple Events</B></A> / <A HREF="IAC-116.html"><B>Handling Apple Events</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING125-0></A>
<H2><A NAME=MARKER-9-401></A><A NAME=MARKER-21-402></A>Writing and Installing Coercion Handlers</H2>
 <A NAME=MARKER-2-403></A><A NAME=MARKER-9-38></A><A NAME=MARKER-2-27></A>When your application extracts data from a parameter, it can request that the Apple Event Manager return the data using a descriptor type that is different from the original descriptor type. For example, when extracting data from the direct parameter of the Open Documents event, you can request that the alias records be returned as file system specification records. The Apple Event Manager can automatically coerce many different types of data from one to another. <A HREF=#MARKER-9-5>Table 4-1 on page 4-45</A> shows descriptor types and the kinds of coercion that the Apple Event Manager can perform.<P>
 You can also provide your own routines, referred to as <B>coercion handlers,</B> to coerce data into any other descriptor type. To install your own coercion handlers, use the <CODE>AEInstallCoercionHandler</CODE> function. You specify as parameters to this function<P>
<UL>
<LI>the descriptor type of the data coerced by the handler
<LI>the descriptor type of the resulting data
<LI>the address of the coercion handler for this descriptor type
<LI>a reference constant
<LI>a Boolean value that indicates whether your coercion handler expects the data to be specified as a descriptor record or as a pointer to the actual data
<LI>a Boolean value that indicates whether your coercion handler should be added to your application's coercion dispatch table or the system coercion dispatch table<P>
</UL>
 The <B>system coercion dispatch table</B> is a table in the system heap that contains coercion handlers available to all applications and processes running on the same computer. The coercion handlers in your application's coercion dispatch table are available only to your application. When attempting to coerce data, the Apple Event Manager first looks for a coercion handler in your application's coercion dispatch table. If it cannot find a handler for the descriptor type, it looks in the system coercion dispatch table for a handler. If it doesn't find a handler there, it attempts to use the default coercion handling described by <A HREF=#MARKER-9-5>Table 4-1 on page 4-45</A>. If it can't find an appropriate default coercion handler, it returns the <CODE>errAECoercionFail</CODE> result code. <A NAME=MARKER-9-159></A><P>
 Any handler that you add to the system coercion dispatch table should reside in the system heap. If there was already an entry in the system coercion dispatch table for the same descriptor type, it is replaced. Therefore, if there is an entry in the system coercion dispatch table for the same descriptor type, you should chain it to your system coercion handler as explained in <A HREF=IAC-180.html#MARKER-9-593>"Creating and Managing the Coercion Handler Dispatch Tables,"</A> which begins on <A HREF=IAC-180.html#MARKER-9-593>page 4-96</A>.<P>
<DL>
<DT><B>WARNING</B>
<DD>Before an application calls a system coercion handler, system software has set up the A5 register for the calling application. For this reason, if you provide a system coercion handler, it should never use A5 global variables or anything that depends on a particular context; otherwise, the application that calls the system coercion handler may crash.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 You can provide a coercion handler that expects to receive the data in a descriptor record or a buffer referred to by a pointer. When you install your coercion handler, you specify how your handler wishes to receive the data. Whenever possible, you should write your coercion handler so that it can accept a pointer to the data, because it's more efficient for the Apple Event Manager to provide your coercion handler with a pointer to the data.<P>
 A coercion handler that accepts a pointer to data must be a function with the following syntax:<P>
<PRE>
FUNCTION MyCoercePtr (typeCode: DescType; dataPtr: Ptr; 
                      dataSize: Size; toType: DescType; 
                      handlerRefcon: LongInt;
                      VAR result: AEDesc): OSErr; 
</PRE>
 The <CODE>typeCode</CODE> parameter is the descriptor type of the original data. The <CODE>dataPtr</CODE> parameter is a pointer to the data to coerce; the <CODE>dataSize</CODE> parameter is the length, in bytes, of the data. The <CODE>toType</CODE> parameter is the desired descriptor type of the resulting data. The <CODE>handlerRefcon</CODE> parameter is a reference constant stored in the coercion table entry for the handler and passed to the handler by the Apple Event Manager whenever the handler is called. The <CODE>result</CODE> parameter is the descriptor record returned by your coercion handler.<A NAME=MARKER-2-116></A><P>
 Your coercion handler should coerce the data to the desired descriptor type and return the data in the descriptor record specified by the <CODE>result</CODE> parameter. If your handler successfully performs the coercion, it should return the <CODE>noErr</CODE> result code; otherwise, it should return a nonzero result code.<P>
 A coercion handler that accepts a descriptor record must be a function with the following syntax:<P>
<PRE>
FUNCTION MyCoerceDesc (theAEDesc: AEDesc; toType: DescType;
                       handlerRefcon: LongInt;
                       VAR result: AEDesc): OSErr;
</PRE>
 The parameter <CODE>theAEDesc</CODE> is the descriptor record that contains the data to be coerced. The <CODE>toType</CODE> parameter is the descriptor type of the resulting data. The <CODE>handlerRefcon</CODE> parameter is a reference constant stored in the coercion table entry for the handler and passed to the handler by the Apple Event Manager whenever the handler is called. The <CODE>result</CODE> parameter is the resulting descriptor record.<P>
 Your coercion handler should coerce the data in the descriptor record to the desired descriptor type and return the data in the descriptor record specified by the <CODE>result</CODE> parameter. Your handler should return an appropriate result code.<P>
<DL>
<DT><B>Note</B>
<DD>To ensure that no coercion is performed and that the descriptor type of the result is of the same descriptor type as the original, specify <CODE>typeWildCard</CODE> for the desired type.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
 <A HREF=#MARKER-9-5>Table 4-1</A> lists the descriptor types for which the Apple Event Manager provides coercion. 
<TABLE BORDER="0" CELLPADDING=3>
<CAPTION><A NAME=MARKER-9-5></A><A NAME=MARKER-21-6></A><B>Table 4-1 Coercion handling provided by the Apple Event Manager</B> </CAPTION>
<TH>Original descriptor type of data to be coerced<TH>Desired descriptor type<TH>Description<TR>
<TD rowspan=7>typeChar<TD rowspan=7>typeInteger<P>typeLongInteger<P>typeSMInt<P>typeSMFloat<P>typeShortInteger<P>typeFloat<P>typeLongFloat<P>typeShortFloat<P>typeExtended<P>typeComp<P>typeMagnitude<TD rowspan=7>Any string that is a valid representation of a number can be coerced into an equivalent numeric value.<TR>
<TR>
<TR>
<TR>
<TR>
<TR>
<TR>
<TD rowspan=7>typeInteger<P>typeLongInteger <P>typeSMInt<P>typeSMFloat<P>typeShortInteger<P>typeFloat<P>typeLongFloat<P>typeShortFloat<P>typeExtended<P>typeComp<P>typeMagnitude<TD rowspan=7>typeChar<TD rowspan=7>Any numeric descriptor type can be coerced into the equivalent text string.<TR>
<TR>
<TR>
<TR>
<TR>
<TR>
<TR>
<TD rowspan=7>typeInteger<P>typeLongInteger <P>typeSMInt<P>typeSMFloat<P>typeShortInteger <P>typeFloat<P>typeLongFloat<P>typeShortFloat<P>typeExtended<P>typeComp<P>typeMagnitude<TD rowspan=7>typeInteger<P>typeLongInteger<P>typeSMInt<P>typeSMFloat<P>typeShortInteger<P>typeFloat<P>typeLongFloat<P>typeShortFloat<P>typeExtended<P>typeComp<P>typeMagnitude<TD rowspan=7>Any numeric descriptor type can be coerced into any other numeric descriptor type.<TR>
<TR>
<TR>
<TR>
<TR>
<TR>
<TR>
<TD rowspan=4>typeChar<TD rowspan=4>typeType<P>typeEnumerated<P>typeKeyword<BR>typeProperty<TD rowspan=4>Any four-character string can be coerced to one of these descriptor types.<TR>
<TR>
<TR>
<TR>
<TD>typeEnumerated<P>typeKeyword<P>typeProperty<P>typeType<TD>typeChar<TD>Any of these descriptor types can be coerced to the equivalent text string.<TR>
<TD>&nbsp;<TD>&nbsp;<TD>&nbsp;<TR>
<TD>typeIntlText<TD>typeChar<TD>The result contains text only, without the script code or language code from the original descriptor record.<TR>
<TD>typeTrue<TD>typeBoolean<TD>The result is the Boolean value <CODE>TRUE</CODE>.<TR>
<TD>typeFalse<TD>typeBoolean<TD>The result is the Boolean value <CODE>FALSE</CODE>.<TR>
<TD>typeEnumerated<TD>typeBoolean<TD>The enumerated value <CODE>'true'</CODE> becomes the Boolean value <CODE>TRUE</CODE>. The enumerated value <CODE>'fals'</CODE> becomes the Boolean value <CODE>FALSE</CODE>.<TR>
<TD>typeBoolean<TD>typeEnumerated<TD>The Boolean value <CODE>FALSE</CODE> becomes the enumerated value <CODE>'fals'</CODE>. The Boolean value <CODE>TRUE</CODE> becomes the enumerated value <CODE>'true'</CODE>.<TR>
<TD>typeShortInteger<BR>typeSMInt<TD>typeBoolean<TD>A value of 1 becomes the Boolean value <CODE>TRUE</CODE>. A value of 0 becomes the Boolean value <CODE>FALSE</CODE>.<TR>
<TD>typeBoolean<TD>typeShortInteger typeSMInt<TD>A value of <CODE>FALSE</CODE> becomes 0. A value of <CODE>TRUE</CODE> becomes 1.<TR>
<TD>typeAlias<TD>typeFSS<TD>An alias record is coerced into a file system specification record.<TR>
<TD>typeAppleEvent<TD>typeAppParameters<TD>An Apple event is coerced into a list of application parameters for the <CODE>LaunchParamBlockRec</CODE> parameter block.<TR>
<TD><I>any descriptor type</I><TD>typeAEList<TD>A descriptor record is coerced into a descriptor list containing a single item.<TR>
<TD>typeAEList<TD><I>type of list item</I><TD>A descriptor list containing a single descriptor record is coerced into a descriptor record.<A NAME=MARKER-2-127></A><A NAME=MARKER-2-195></A> <A NAME=MARKER-2-16></A></TABLE>
<P>
<DL>
<DT><B>Note</B>
<DD>Some of the descriptor types listed in this table are synonyms; for example, the constants <CODE>typeSMInt</CODE> and <CODE>typeShortInteger</CODE> have the same four-character code, <CODE>'shor'</CODE>.  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="IAC-124.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="IAC-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="IAC-529.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="IAC-126.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="IAC-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
