<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Sync Services Programming Guide: Managing Your Sync Session</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Managing Your Sync Session"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP40001162" title="Managing Your Sync Session"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000416" target="_top">Cocoa</a> &gt; <a href="../../../Syncing-date.html#//apple_ref/doc/uid/TP30000440-TP30000416-TP40001899" target="_top">Syncing</a> &gt; <a href="../index.html" target="_top">Sync Services Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="SyncOverview.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="SchemaDesign.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>
        
        
        <a name="//apple_ref/doc/uid/TP40001162-CJBEHAAG" title="Managing Your Sync Session"></a><hr /><H1>Managing Your Sync Session</H1><p>In the simplest form of syncing, the client pushes changes to the sync engine, the sync engine applies those changes to the truth database, and the client pulls changes from the sync engine that were made by other clients since the last sync. In reality, syncing is not that simple, because events can take place, on either the client or server, that change the sync mode. Understanding how to manage different sync modes is fundamental to using the Sync Services framework.</p><p>An ISyncSession object encapsulates the process of a single sync operation. Sync Services uses a client-server model analogous to a database model. The client sends read and write instructions within a transaction to the sync engine using an ISyncSession object. The ISyncSession object behaves as finite state machine. For example, pushing and pulling changes are different states, and you always push before you pull. There are implicit transactions within each state, too, and sometimes multiple transactions within a state. Invoking some ISyncSession methods may begin a transaction, end a transaction, or transition to another state. It’s important to understand these states and transactions when managing a sync session.</p><p>This chapter describes how to use the core ISyncSession methods to manage your sync session. Refer to <span class="content_text"><a href="SyncOverview.html#//apple_ref/doc/uid/TP40001151-CJBEHAAG">“Sync Services Overview”</a></span> if you are unfamiliar with the sync architecture and terminology.</p>
<!-- This template is being used for both PDF and HTML. -->

    
    <!-- TopicBook.pm uses this template for its miniTOCs, but needs a different title. -->
    <h4>Contents:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="SessionManagement.html#//apple_ref/doc/uid/TP40001162-139677">Finite State Machine</a>
				
			<br/>
			
        
			
			
				<a href="SessionManagement.html#//apple_ref/doc/uid/TP40001162-142488">Implementing Your Sync Method</a>
				
			<br/>
			
        
			
			
				<a href="SessionManagement.html#//apple_ref/doc/uid/TP40001162-139757-BBCFEFGA">Starting a Sync Session</a>
				
			<br/>
			
        
			
			
				<a href="SessionManagement.html#//apple_ref/doc/uid/TP40001162-129380">Negotiating</a>
				
			<br/>
			
        
			
			
				<a href="SessionManagement.html#//apple_ref/doc/uid/TP40001162-129483">Pushing</a>
				
			<br/>
			
        
			
			
				<a href="SessionManagement.html#//apple_ref/doc/uid/TP40001162-143239-BBCFCBCI">Mingling</a>
				
			<br/>
			
        
			
			
				<a href="SessionManagement.html#//apple_ref/doc/uid/TP40001162-129595-BBCDDHII">Pulling</a>
				
			<br/>
			
        
			
			
				<a href="SessionManagement.html#//apple_ref/doc/uid/TP40001162-129654">Finishing</a>
				
			<br/>
			
        
			
			
				<a href="SessionManagement.html#//apple_ref/doc/uid/TP40001162-129663">Canceling</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP40001162-139677" title="Finite State Machine"></a><h2>Finite State Machine</h2><p>In a sync session, you essentially create an ISyncSession object, use it to sync your records, and then throw it away. A session object behaves as a finite state machine illustrated in <span class="content_text"><a href="SessionManagement.html#//apple_ref/doc/uid/TP40001162-141674-BBCICIBD">Figure 1</a></span>. The states always change in the direction depicted by the arrows in this figure.</p><br/><div><a name="//apple_ref/doc/uid/TP40001162-141674-BBCICIBD" title="Figure 1ISyncSession finite state machine"></a><p><a name="//apple_ref/doc/uid/TP40001162-141674" title="Figure 1ISyncSession finite state machine"></a><strong>Figure 1&nbsp;&nbsp;</strong>ISyncSession finite state machine</p><img src = "../art/session_state_digram.gif" alt = "ISyncSession finite state machine" width="505" height="266"></div><br/><p>Only certain ISyncSession methods may be used within a state; invoking other methods in a state may raise an exception. You also transition from one state to another explicitly or implicitly depending on the methods you invoke. Negotiation and mingling are mandatory states, but pushing and pulling are optional as long as you push records before you pull records. Finishing or canceling terminates a session.</p><p>The exact sequence of messages sent to an ISyncSession object depends on your application and the way you store your records. This article outlines the typical sequence of messages for syncing your data and contains sample code to help you write your own custom sync methods to meet the needs of your application or device.</p><a name="//apple_ref/doc/uid/TP40001162-142488" title="Implementing Your Sync Method"></a><h2>Implementing Your Sync Method</h2><p><span class="content_text"><a href="SessionManagement.html#//apple_ref/doc/uid/TP40001162-145257-BBCDEAGB">Figure 2</a></span> shows the logic of a typical sync method implementation. After creating a sync session and negotiating a sync mode, you ask the sync engine if you should push changes for an entity. If the answer is yes, you push the changes; otherwise, you skip to the pulling state. Similarly, when pulling changes, you ask the sync engine if you should pull changes. If the answer is yes, you prepare to pull changes which runs the mingler. The <strong>mingler</strong> is a process in the sync engine that computes the changes to be pulled by each client that participates in a sync session. When the mingler completes this process, you pull the changes; otherwise, you can abort the sync session. The methods you use to implement your sync methods are described next.</p><br/><div><a name="//apple_ref/doc/uid/TP40001162-145257-BBCDEAGB" title="Figure 2Typical sync logic"></a><p><a name="//apple_ref/doc/uid/TP40001162-145257" title="Figure 2Typical sync logic"></a><strong>Figure 2&nbsp;&nbsp;</strong>Typical sync logic</p><img src = "../art/flowchart_syncing.gif" alt = "Typical sync logic" width="275" height="628"></div><br/><a name="//apple_ref/doc/uid/TP40001162-139757" title="Starting a Sync Session"></a><a name="//apple_ref/doc/uid/TP40001162-139757-BBCFEFGA" title="Starting a Sync Session"></a><h2>Starting a Sync Session</h2><p>The sync engine won’t let your application sync when syncing is disabled by the user or some other event, and when the sync engine is waiting for other clients to join a sync session.</p><a name="//apple_ref/doc/uid/TP40001162-160798" title="Is the Sync Engine Enabled?"></a><h3>Is the Sync Engine Enabled?</h3><p>Before beginning any sync operation, you first determine whether the sync engine is disabled as follows:</p><div class="codesample"><table><tr><td scope="row"><pre>    if ([[ISyncManager sharedManager] isEnabled] == YES) {<span></span></pre></td></tr><tr><td scope="row"><pre>        // begin syncing<span></span></pre></td></tr><tr><td scope="row"><pre>        ...<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr></table></div><p>If the sync engine is disabled, you can optionally register for the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncManager_Class/Reference/Reference.html#//apple_ref/c/data/ISyncAvailabilityChangedNotification" target="_top">ISyncAvailabilityChangedNotification</a></code> notification to sync later. <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncManager_Class/Reference/Reference.html#//apple_ref/c/data/ISyncAvailabilityChangedNotification" target="_top">ISyncAvailabilityChangedNotification</a></code> is a distributed notification, so the notification object is a string, either <code>"YES"</code> or <code>"NO"</code>. For example, if you only want to be notified when the sync engine is enabled pass <code>"YES"</code> as the object argument when registering for this distributed notification as follows:</p><div class="codesample"><table><tr><td scope="row"><pre>[[NSDistributedNotificationCenter defaultCenter] addObserver:self selector:@selector(syncWasEnabled:) name:ISyncAvailabilityChangedNotification object:@"YES"];<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001162-161134" title="Beginning a Sync Session"></a><h3>Beginning a Sync Session</h3><p>Typically, a client syncs its records independent of other clients. Sync Services also supports multiple clients syncing simultaneously. A client registers itself as an observer of another client and is alerted when that client syncs. For example, a device client for a phone might want to sync whenever Address Book syncs to update its contacts. Therefore, when you begin a sync session, the sync engine needs to alert all dependent clients and wait until those clients either join the sync session or don’t. Because this process may block your client momentarily, you have the option of specifying how long you are willing to wait for other clients to join the session.</p><p>There are two ways to create a sync session. You begin a ISyncSession object using one of two ISyncSession class methods:</p><ul class="simple"><li><p><code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/clm/ISyncSession/beginSessionWithClient:entityNames:beforeDate:" target="_top">beginSessionWithClient:entityNames:beforeDate:</a></code></p></li><li><p><code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/clm/ISyncSession/beginSessionInBackgroundWithClient:entityNames:target:selector:" target="_top">beginSessionInBackgroundWithClient:entityNames:target:selector:</a></code></p></li></ul><p>The <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/clm/ISyncSession/beginSessionWithClient:entityNames:beforeDate:" target="_top">beginSessionWithClient:entityNames:beforeDate:</a></code> method is a blocking method that returns when all dependent clients have had the opportunity to join the sync session, as follows:</p><div class="codesample"><table><tr><td scope="row"><pre>ISyncSession *session =<span></span></pre></td></tr><tr><td scope="row"><pre>        [ISyncSession beginSessionWithClient:client<span></span></pre></td></tr><tr><td scope="row"><pre>                entityNames:entityNames<span></span></pre></td></tr><tr><td scope="row"><pre>                beforeDate:[NSDate dateWithTimeIntervalSinceNow:5]];<span></span></pre></td></tr></table></div><p>If you change the <em>beforeDate</em> argument to the current date or a past date, this method returns immediately with or without creating a sync session.</p><p>The <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/clm/ISyncSession/beginSessionInBackgroundWithClient:entityNames:target:selector:" target="_top">beginSessionInBackgroundWithClient:entityNames:target:selector:</a></code> method allows you to specify a target and selector to be invoked when all clients have joined the session. Use this method if you do not want to block the client while waiting for other clients.</p><a name="//apple_ref/doc/uid/TP40001162-129380" title="Negotiating"></a><h2>Negotiating</h2><p>All clients need to negotiate a sync mode before pushing and pulling records. The sync modes are slow sync, fast sync, refresh sync, pull the truth, and push the truth.</p><p>The first time a client syncs, it slow syncs—that is, it pushes all its records. Otherwise, the default mode (fast syncing) is used to push and pull changes only. However, certain events can prevent a fast sync. When this happens, the client might request a different sync mode, or the sync engine might force a mode. If multiple clients sync simultaneously, then all the client requests need to be considered. For example, if one client wants to push the truth, all other clients need to pull the truth.</p><a name="//apple_ref/doc/uid/TP40001162-140406" title="Slow Syncing"></a><h3>Slow Syncing</h3><p>Use the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/clientWantsToPushAllRecordsForEntityNames:" target="_top">clientWantsToPushAllRecordsForEntityNames:</a></code> method to request a slow sync. For example, if your client doesn’t know what records changed since the last sync, it should slow sync. This method informs the sync engine that the client will push all its records:</p><div class="codesample"><table><tr><td scope="row"><pre>// Request a slow sync<span></span></pre></td></tr><tr><td scope="row"><pre>[session clientWantsToPushAllRecordsForEntityNames:entityNames];<span></span></pre></td></tr></table></div><p>If a client is slow syncing, the client may pull deletes for records that the engine knew were on the client during the last sync. </p><a name="//apple_ref/doc/uid/TP40001162-140466" title="Refresh Syncing"></a><h3>Refresh Syncing</h3><p>The <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/clientDidResetEntityNames:" target="_top">clientDidResetEntityNames:</a></code> method informs the sync engine that the client was reset and wants to refresh sync. However, if a client is refresh syncing, the engine doesn’t use the client snapshot to compare pushed records. Consequently, no delete changes are pulled.</p><a name="//apple_ref/doc/uid/TP40001162-160474" title="Pull the Truth"></a><h3>Pull the Truth</h3><p>If you want all client records replaced by the truth database records, send <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncClient_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncClient/setShouldReplaceClientRecords:forEntityNames:" target="_top">setShouldReplaceClientRecords:forEntityNames:</a></code> to your ISyncClient object. This is how you request a pull the truth sync mode:</p><div class="codesample"><table><tr><td scope="row"><pre>// Requests that client records be replaced by truth<span></span></pre></td></tr><tr><td scope="row"><pre>[client setShouldReplaceClientRecords:YES<span></span></pre></td></tr><tr><td scope="row"><pre>                       forEntityNames:entityNames];<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001162-DontLinkElementID_18" title="Mixing Sync Modes"></a><h3>Mixing Sync Modes</h3><p>Typically, the sync modes for all the entities synced by a client are the same. However, in some cases the sync modes may be different. The most common case is when a client doesn't sync the same entities in every sync session or explicitly requests a different sync mode for one entity and not another. Because of such differences, the sync engine might allow a fast sync of one entity and force a slow sync of another entity. This is permissible except when relationships exist between these entities. </p><p>To avoid relationship inconsistencies, clients should always request the same sync mode for entities that have relationships between them. In other words, clients should use the same sync mode for records belonging to the same object graph; otherwise, inconsistencies between the records may result—especially if inverse relationships are changed.</p><div class="warningbox"><img src="../../../../Resources/Images/icon_warning.gif" alt="!" width="20" height="20" border="0" class="warningicon" /><a name="//apple_ref/doc/uid/TP40001162-DontLinkElementID_31" title="Warning:"></a><p><strong>Warning:</strong>&nbsp;If the sync modes of entities that have relationships between them are different, then the client must request a refresh sync for those entities using the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/clientDidResetEntityNames:" target="_top">clientDidResetEntityNames:</a></code> method. Otherwise, data may be corrupted.</p><p></p><div class="clear"></div></div><a name="//apple_ref/doc/uid/TP40001162-129483" title="Pushing"></a><h2>Pushing</h2><p>Assuming you negotiated a sync mode, you can now push your changes to the sync engine. Pushing changes is an optional step—it can be skipped if the client has no changes or is not ready to push them. However, if you decide to push changes, you must do so before pulling changes.</p><p><span class="content_text"><a href="SessionManagement.html#//apple_ref/doc/uid/TP40001162-145281-BBCBBEBB">Figure 3</a></span> shows the flow of a typical pushing method. You first ask the sync engine if you should push any changes for the specified entities. Then you ask if you should push all the records or just the changes. You do this because the sync engine might select a mode other than the one you requested.</p><br/><div><a name="//apple_ref/doc/uid/TP40001162-145281-BBCBBEBB" title="Figure 3Typical pushing logic"></a><p><a name="//apple_ref/doc/uid/TP40001162-145281" title="Figure 3Typical pushing logic"></a><strong>Figure 3&nbsp;&nbsp;</strong>Typical pushing logic</p><img src = "../art/flowchart_pushing.gif" alt = "Typical pushing logic" width="296" height="266"></div><br/><p>When slow syncing, a client pushes all its records to the sync engine and lets it determine which properties of those records changed. The sync engine does this by comparing each pushed record to a snapshot of the record taken at the end of the previous sync. </p><p>When fast syncing, a client may push only the records that changed. Similarly, the sync engine determines what individual properties of those records changed by comparing them to the snapshot. </p><p>Alternatively, a client can save time and effort by pushing just the changes to individual properties of records (assuming that the client keeps track of every property change to every record).</p><p>The sync session transitions to the pushing state the first time any of the methods discussed below are invoked. All the methods can be used only during this state, except <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/clientLostRecordWithIdentifier:shouldReplaceOnNextSync:" target="_top">clientLostRecordWithIdentifier:shouldReplaceOnNextSync:</a></code>, which can also be invoked during the pulling state. An implicit transaction begins when entering the pushing state and ends when leaving this state.</p><p>Although the methods for requesting a sync mode and pushing and pulling records are entity-based, entities in the same data class usually have the same sync mode. Entities can have relationships to other entities in the same data class, but not relationships to entities in other data classes. Therefore, you should not request different sync modes for entities in the same data class, and enable or disable entities in the same data class after the application first syncs.</p><a name="//apple_ref/doc/uid/TP40001162-143320" title="Push Changes?"></a><h3>Push Changes?</h3><p>To determine whether any records belonging to an entity should be pushed, use the <code>shouldPushChangesForEntityName:</code> method, as follows:</p><div class="codesample"><table><tr><td scope="row"><pre>        if ([session shouldPushChangesForEntityName:entityName]){<span></span></pre></td></tr><tr><td scope="row"><pre>            // Push records for entityName<span></span></pre></td></tr><tr><td scope="row"><pre>            ...<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001162-141115" title="Push All Records?"></a><h3>Push All Records?</h3><p>To determine whether you should slow or fast sync, use the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/shouldPushAllRecordsForEntityName:" target="_top">shouldPushAllRecordsForEntityName:</a></code> method. If this method returns <code>YES</code>, you should push all records. If you do not push all the records, the sync engine assumes you deleted the records you did not push and deletes them from the truth database. If the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/shouldPushAllRecordsForEntityName:" target="_top">shouldPushAllRecordsForEntityName:</a></code> method returns <code>NO</code>, push just the changes since the last sync.</p><div class="codesample"><table><tr><td scope="row"><pre>        if ([session shouldPushAllRecordsForEntityName:entityName]) {<span></span></pre></td></tr><tr><td scope="row"><pre>            // Slow sync entityName<span></span></pre></td></tr><tr><td scope="row"><pre>            ...<span></span></pre></td></tr><tr><td scope="row"><pre>        } else {<span></span></pre></td></tr><tr><td scope="row"><pre>            // Fast sync entityName<span></span></pre></td></tr><tr><td scope="row"><pre>            ...<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001162-160583" title="Pushing Records"></a><h3>Pushing Records</h3><p>You can push all records or just the changed records by using the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/pushChangesFromRecord:withIdentifier:" target="_top">pushChangesFromRecord:withIdentifier:</a></code> method, as follows:</p><div class="codesample"><table><tr><td scope="row"><pre>    [session pushChangesFromRecord:record withIdentifier:id];<span></span></pre></td></tr></table></div><p>Typically, you transform your entity objects into a dictionary representation before pushing them. The <code>record</code> argument above is a dictionary that contains only the supported properties you want to sync. It should not contain any local properties used exclusively by your client. </p><p>For example, the dictionary representation of a Media object pushed by the MediaAssets sample application might look like this:</p><div class="codesample"><table><tr><td scope="row"><pre>MediaAssets[789] pushing sync record={<span></span></pre></td></tr><tr><td scope="row"><pre>    "com.mycompany.syncservices.RecordEntityName" = "com.mycompany.syncexamples.Media";<span></span></pre></td></tr><tr><td scope="row"><pre>    date = 2004-05-22 00:00:00 -0700;<span></span></pre></td></tr><tr><td scope="row"><pre>    event = ("3571D5D0-C0A5-11D8-A57D-000A95BF2062");<span></span></pre></td></tr><tr><td scope="row"><pre>    imageURL = "file://2004/05/22/IMG_1106.JPG";<span></span></pre></td></tr><tr><td scope="row"><pre>    title = "IMG_1106.JPG";<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>The sync engine uses record identifiers to locate records. Record identifiers are unique across all sync records, not just within the scope of an entity. Therefore, the <code>record</code> dictionary also needs to contain a value for the <code><!--a target="_top" -->ISyncRecordEntityNameKey<!--/a--></code> key that identifies the record’s entity name.</p><p>The client is expected to create the unique record identifiers, typically a UUID, when pushing new records. Conversely, clients can either accept the record identifiers assigned by the sync engine when pulling new records or reset it to something else (see <span class="content_text"><a href="SessionManagement.html#//apple_ref/doc/uid/TP40001162-129595">“Pulling”</a></span>). For these reasons, your client needs to maintain the association between a record identifier and your entity object in order to communicate future changes to the sync engine.</p><a name="//apple_ref/doc/uid/TP40001162-142798" title="Pushing Changes to Properties"></a><h3>Pushing Changes to Properties</h3><p>If you know what properties of a record changed, you can just push the properties that changed by creating an ISyncChange object and using the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/pushChange:" target="_top">pushChange:</a></code> method. You can improve efficiency by pushing just the changes.</p><a name="//apple_ref/doc/uid/TP40001162-160662" title="Pushing Delete Changes"></a><h3>Pushing Delete Changes</h3><p>When fast syncing, you don’t have to create an ISyncChange object for deleted records. You can use the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/deleteRecordWithIdentifier:" target="_top">deleteRecordWithIdentifier:</a></code> method to push deleted record changes as follows:</p><div class="codesample"><table><tr><td scope="row"><pre>[session deleteRecordWithIdentifier:recordID];<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001162-141501" title="Handling Lost Records"></a><h3>Handling Lost Records</h3><p>If you lost a record and want to replace it or ignore it in a future sync, use the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/clientLostRecordWithIdentifier:shouldReplaceOnNextSync:" target="_top">clientLostRecordWithIdentifier:shouldReplaceOnNextSync:</a></code> method.</p><a name="//apple_ref/doc/uid/TP40001162-143239" title="Mingling"></a><a name="//apple_ref/doc/uid/TP40001162-143239-BBCFCBCI" title="Mingling"></a><h2>Mingling</h2><p>The sync session enters the mingling state after all clients participating in the sync have pushed their changes. During mingling, the engine takes all the changes from all the participating clients, checks them for conflicts, and applies them to the truth database. At the end of the mingling state, all changes have been incorporated from multiple clients.</p><p>If there is a conflict, the engine first tries to resolve it using a set of rules specific to the entity in question—for example, the engine uses the identity properties of an entity to determine if two records are the same record.</p><p>The client informs the sync engine that it is ready to begin pulling changes by invoking one of the <code>prepareToPullChanges...</code> methods. Invoking them at any other time will raise an exception. </p><p>Using the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/prepareToPullChangesForEntityNames:beforeDate:" target="_top">prepareToPullChangesForEntityNames:beforeDate:</a></code> method, you specify how long the client is willing to wait for the mingling state to complete as in:</p><div class="codesample"><table><tr><td scope="row"><pre>if ([session prepareToPullChangesForEntityNames:entityNames beforeDate:[NSDate distantFuture]]) {<span></span></pre></td></tr><tr><td scope="row"><pre>    // Pull changes for each entity<span></span></pre></td></tr><tr><td scope="row"><pre>    ...<span></span></pre></td></tr></table></div><p>The mingling state ends when this method returns. If this method returns <code>NO</code>, you should skip pulling changes.</p><p>Using the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/prepareToPullChangesInBackgroundForEntityNames:target:selector:" target="_top">prepareToPullChangesInBackgroundForEntityNames:target:selector:</a></code> method, you specify a target and action to be invoked when the mingling state is complete. This method is nonblocking. The mingling state ends when this method invokes the action.</p><p>Note that the mingler considers the changes made between syncs to be transitive. The mingler optimizes a set of consecutive changes to a record by discarding all changes to a property except the last. Consequently, clients should not assume that changes are pulled in the same sequence in which they are pushed—only the final value in a sequence of changes is relevant.</p><a name="//apple_ref/doc/uid/TP40001162-129595" title="Pulling"></a><a name="//apple_ref/doc/uid/TP40001162-129595-BBCDDHII" title="Pulling"></a><h2>Pulling</h2><p>Pulling changes from the sync engine is the final state in the sync session. The sync session transitions to this state at the end of the mingling state. Typically, you iterate through the entity names passed to one of the <code>prepareToPullChanges...</code> methods, and for each entity, you pull and apply the changes. But first you need to see whether you should try to pull changes. <span class="content_text">Figure 4</span> shows the logic of a typical pulling implementation. Details of pulling changes are covered in <span class="content_text"><a href="SessionManagement.html#//apple_ref/doc/uid/TP40001162-144265">“Pull Changes.”</a></span></p><br/><div><a name="//apple_ref/doc/uid/TP40001162-145352-BBCEIJEE" title="Figure 4Typical pulling logic"></a><p><a name="//apple_ref/doc/uid/TP40001162-145352" title="Figure 4Typical pulling logic"></a><strong>Figure 4&nbsp;&nbsp;</strong>Typical pulling logic</p><img src = "../art/flowchart_pulling.gif" alt = "Typical pulling logic" width="296" height="266"></div><br/><a name="//apple_ref/doc/uid/TP40001162-143413" title="Pull Changes?"></a><a name="//apple_ref/doc/uid/TP40001162-143413-BBCEJFFB" title="Pull Changes?"></a><h3>Pull Changes?</h3><p>You should first check with the sync engine, using the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/shouldPullChangesForEntityName:" target="_top">shouldPullChangesForEntityName:</a></code> method, to determine whether you should try to pull changes for an entity before pulling changes. It is useful to create a filtered list of entities from the supported entities, as follows:</p><div class="codesample"><table><tr><td scope="row"><pre>NSEnumerator *entityEnumerator = [entityNames objectEnumerator];<span></span></pre></td></tr><tr><td scope="row"><pre>NSMutableArray *filteredEntityNames = [NSMutableArray array];<span></span></pre></td></tr><tr><td scope="row"><pre>while (entityName = [entityEnumerator nextObject]){<span></span></pre></td></tr><tr><td scope="row"><pre>    if ([session shouldPullChangesForEntityName:entityName])<span></span></pre></td></tr><tr><td scope="row"><pre>        [filteredEntityNames addObject:entityName];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001162-144173" title="Replace All Records?"></a><h3>Replace All Records?</h3><p>For each entity, you need to check with the sync engine, using the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/shouldReplaceAllRecordsOnClientForEntityName:" target="_top">shouldReplaceAllRecordsOnClientForEntityName:</a></code> method, to determine whether you should replace all its records. For example, you need to replace all the records if the sync mode is pull the truth. If this method returns <code>YES</code>, delete your copies of the records before pulling changes, as in this example:</p><div class="codesample"><table><tr><td scope="row"><pre>if ([session shouldReplaceAllRecordsOnClientForEntityName:entityName]) {<span></span></pre></td></tr><tr><td scope="row"><pre>    // Remove the records for this entity from the client data source<span></span></pre></td></tr><tr><td scope="row"><pre>    ...<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001162-144265" title="Pull Changes"></a><a name="//apple_ref/doc/uid/TP40001162-144265-BBCIGHBA" title="Pull Changes"></a><h3>Pull Changes</h3><p>Now that you have a collection of entity names to pull changes for, you are ready to pull and apply the changes. <span class="content_text">Figure 5</span> shows the flow of a typical pulling implementation. </p><br/><div><a name="//apple_ref/doc/uid/TP40001162-145392-BBCIBGCF" title="Figure 5Typical pulling-changes logic"></a><p><a name="//apple_ref/doc/uid/TP40001162-145392" title="Figure 5Typical pulling-changes logic"></a><strong>Figure 5&nbsp;&nbsp;</strong>Typical pulling-changes logic</p><img src = "../art/flowchart_pull_changes.gif" alt = "Typical pulling-changes logic" width="392" height="432"></div><br/><a name="//apple_ref/doc/uid/TP40001162-144903" title="Getting the Changes"></a><h4>Getting the Changes</h4><p>You use the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/changeEnumeratorForEntityNames:" target="_top">changeEnumeratorForEntityNames:</a></code> method to get the changes from the sync engine for the specified entity names. Because this method returns an object enumerator, you need to iterate through the changes and apply them one by one. <span class="content_text"><a href="SessionManagement.html#//apple_ref/doc/uid/TP40001162-145392-BBCIBGCF">Figure 5</a></span> shows how you might process each change.</p><a name="//apple_ref/doc/uid/TP40001162-144943" title="Accepting and Refusing Changes"></a><h4>Accepting and Refusing Changes</h4><p>For each change, you need to decide whether you are going to apply it to your local data source. If you apply it, you need to invoke <code><!--a target="_top" -->clientAcceptedChangesForRecordWithIdentifier:formattedRecord:newRecordId:<!--/a--></code> to inform the sync engine. </p><p>Otherwise, you invoke <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/clientRefusedChangesForRecordWithIdentifier:" target="_top">clientRefusedChangesForRecordWithIdentifier:</a></code> to reject a change. This method applies only to add and modify changes, not deletes. On subsequent fast syncs, the rejected changes do not appear in the change enumerator returned by the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/changeEnumeratorForEntityNames:" target="_top">changeEnumeratorForEntityNames:</a></code> method. However, they do appear in the change enumerator during the next slow sync. </p><p>When you invoke the <code><!--a target="_top" -->clientAcceptedChangesForRecordWithIdentifier:formattedRecord:newRecordId:<!--/a--></code> method, you have the opportunity to change the record identifier supplied by the sync engine to a record identifier supplied by the client. The identifiers for new records are chosen by the sync engine. (When refresh syncing, every record not pushed by the client is considered new.) Optionally, you can change all the record identifiers for new records at the end of applying changes using the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/clientChangedRecordIdentifiers:" target="_top">clientChangedRecordIdentifiers:</a></code> method. (How you generate record identifiers is dependent on the application).</p><a name="//apple_ref/doc/uid/TP40001162-145034" title="Handling Lost Records"></a><h4>Handling Lost Records</h4><p>Lost records are handled in a way that is similar to the pushing state. To inform the sync engine about a record that the client lost and may want to replace, use the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/clientLostRecordWithIdentifier:shouldReplaceOnNextSync:" target="_top">clientLostRecordWithIdentifier:shouldReplaceOnNextSync:</a></code> method.</p><a name="//apple_ref/doc/uid/TP40001162-144983" title="Committing Changes"></a><h4>Committing Changes</h4><p>When you are done processing all the changes, you invoke <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/clientCommittedAcceptedChanges" target="_top">clientCommittedAcceptedChanges</a></code> to commit the accepted changes to the sync engine. This method closes the transaction that was opened by the first invocation of one of the following methods:</p><ul class="simple"><li><p><code><!--a target="_top" -->clientAcceptedChangesForRecordWithIdentifier:formattedRecord:newRecordId:<!--/a--></code></p></li><li><p><code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/clientRefusedChangesForRecordWithIdentifier:" target="_top">clientRefusedChangesForRecordWithIdentifier:</a></code></p></li><li><p><code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/clientChangedRecordIdentifiers:" target="_top">clientChangedRecordIdentifiers:</a></code></p></li><li><p><code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/clientLostRecordWithIdentifier:shouldReplaceOnNextSync:" target="_top">clientLostRecordWithIdentifier:shouldReplaceOnNextSync:</a></code></p></li></ul><p>The pulling state supports multiple transactions so that clients can batch changes and apply them more efficiently. A new transaction begins by invoking one of the above methods.</p><a name="//apple_ref/doc/uid/TP40001162-129654" title="Finishing"></a><h2>Finishing</h2><p>Sending <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/finishSyncing" target="_top">finishSyncing</a></code> to an ISyncSession object closes the last open transaction and terminates the session. The ISyncSession object cannot be reused after entering this state. This method can be invoked at any time during an active sync session. </p><p>If you invoke <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/finishSyncing" target="_top">finishSyncing</a></code> during the negotiating state, the sync engine assumes that the client has no records to push.</p><p>If you invoke <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/finishSyncing" target="_top">finishSyncing</a></code> during either the pushing or pulling states, the last transaction is closed and any changes in that transaction are applied by the sync engine. For example, if you are in the pulling state, then any changes you accepted using the <code>clientAcceptedChanges...</code> method are applied even if you did not invoke <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/clientCommittedAcceptedChanges" target="_top">clientCommittedAcceptedChanges</a></code> before finishing the session.</p><p>If you invoke <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/finishSyncing" target="_top">finishSyncing</a></code> during the mingling state (for example, while waiting for the target method specified in <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/prepareToPullChangesInBackgroundForEntityNames:target:selector:" target="_top">prepareToPullChangesInBackgroundForEntityNames:target:selector:</a></code> to be invoked), the session is terminated and all changes made during the previous pushing state are applied.</p><p>An ISyncSession object cannot be reused, so release it after invoking <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/finishSyncing" target="_top">finishSyncing</a></code>.</p><a name="//apple_ref/doc/uid/TP40001162-129663" title="Canceling"></a><h2>Canceling</h2><p>You can invoke the <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/cancelSyncing" target="_top">cancelSyncing</a></code> method at any time to terminate a sync session. However, when canceling a sync session, the sync engine rolls back to the state of the last closed transaction. It does not roll back all the transactions made within the session. For this reason, you need to know when transactions begin and end in the various states.</p><p>If you invoke <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/cancelSyncing" target="_top">cancelSyncing</a></code> during the negotiating state, then any negotiation methods invoked during this state are ignored. For example, if you request a refresh sync, then you will have to request it again the next time you sync.</p><p>If you invoke <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/cancelSyncing" target="_top">cancelSyncing</a></code> during the pushing state, all pushed changes, deletions, and lost records are discarded, and the state is rolled back to the end of the negotiation state. If a client is fast syncing, it must remember which records changed so that it can push those changes again during the next sync. If the client cannot do so, it should slow sync the next time.</p><p>If you invoke <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/cancelSyncing" target="_top">cancelSyncing</a></code> during the mingling state, the session is terminated and all changes made during the previous pushing state are applied.</p><p>If you invoke <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/cancelSyncing" target="_top">cancelSyncing</a></code> during the pulling state, all changes that were not committed using <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/clientCommittedAcceptedChanges" target="_top">clientCommittedAcceptedChanges</a></code> are pulled again during the next sync.</p><p>An ISyncSession object cannot be reused, so release it after invoking <code><a href="../../../Reference/SyncServicesFramework/Classes/ISyncSession_Class/Reference/Reference.html#//apple_ref/occ/instm/ISyncSession/cancelSyncing" target="_top">cancelSyncing</a></code>.</p>

        <br/><br/> 

        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="SyncOverview.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="SchemaDesign.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2004, 2007 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2007-10-31<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Cocoa/Conceptual/SyncServices/Articles/SessionManagement.html%3Fid%3DTP40001178-5.1&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Cocoa/Conceptual/SyncServices/Articles/SessionManagement.html%3Fid%3DTP40001178-5.1&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Cocoa/Conceptual/SyncServices/Articles/SessionManagement.html%3Fid%3DTP40001178-5.1&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>
