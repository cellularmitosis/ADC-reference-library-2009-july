<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>B*-Trees (IM: F)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING104></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Files-103.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Files-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Files-390.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Files-105.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Files-2.html"><B>Files</B></A> / <BR><DD><A HREF="Files-72.html"><B>Chapter 2 - File Manager</B></A> / <A HREF="Files-99.html"><B>Data Organization on Volumes</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING104-0></A>
<H2><A NAME=MARKER-9-501></A>B*-Trees</H2>
 <A NAME=MARKER-2-502></A>The File Manager maintains information about a volume's directory hierarchy and file block mapping in two files that are organized as B*-trees to allow quick and efficient retrieval of that information. In a <B>B*-tree,</B> all the information that needs to be stored is intelligently classified and sorted into objects called nodes. <A HREF=#MARKER-9-504>Figure 2-6</A> illustrates the general structure of a B*-tree file.<A NAME=MARKER-2-503></A><P>
<B>Figure 2-6  <A NAME=MARKER-9-504></A>The structure of a B*-tree file</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/FM_L-07.jpg"> <p>
 Note that each B*-tree file used by the File Manager makes use of the data fork only; the resource fork of a B*-tree file is unused. The length of a B*-tree file varies according to the number of nodes it contains.<P>
 A node in turn contains records, which can be used for a variety of purposes. Some records contain the actual data that is to be retrieved and possibly updated; these records occupy nodes called leaf nodes. Other records contain information about the structure of the B*-tree. The File Manager uses these records to find the information it needs quickly. There are three types of these "bookkeeping" nodes: header nodes, index nodes, and map nodes.<P>
<A NAME=HEADING104-6></A>
<H3>Nodes</H3>
 <A NAME=MARKER-2-505></A>A B*-tree file consists entirely of objects called <B>nodes,</B> each of which is 512 bytes long. <A HREF=#MARKER-9-508>Figure 2-7</A> illustrates the structure of a node.<A NAME=MARKER-2-506></A><P>
 Each node has the same general structure and consists of three main parts: a node descriptor that starts at the beginning of the node, a group of record offsets that starts <BR>at the end of the node, and a group of records.<P>
 The <B>node descriptor</B> contains information about the node, as well as forward and backward links to other nodes. You can use the <CODE>NodeDescriptor</CODE> data type to display the structure of a node descriptor.<A NAME=MARKER-2-507></A><P>
<PRE>
TYPE NodeDescriptor  =           {node descriptor}
RECORD
   ndFLink:       LongInt;       {forward link}
   ndBLink:       LongInt;       {backward link}
   ndType:        SignedByte;    {node type}
   ndNHeight:     SignedByte;    {node level}
   ndNRecs:       Integer;       {number of records in node}
   ndResv2:       Integer;       {reserved}
END;
</PRE>
<B>Figure 2-7  <A NAME=MARKER-9-508></A>The structure of a node</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/FM_L-08.jpg"> <p>
<DL>
<H5>Field Description</H5>
<DT><A NAME=MARKER-2-509></A><CODE>ndFLink</CODE>
<DD> A link to the next node of this type. If this node is the last node, this field contains <CODE>NIL</CODE>.
<DT><CODE><A NAME=MARKER-2-510></A>ndBLink</CODE>
<DD> A link to the previous node of this type. If this node is the first node, this field contains <CODE>NIL</CODE>.
<DT><CODE><A NAME=MARKER-2-511></A>ndType</CODE>
<DD> The type of this node. Currently four types of nodes are recognized, defined by the constants listed in this section.
<DT><CODE><A NAME=MARKER-2-512></A>ndNHeight</CODE>
<DD> The level or "depth" of this node in the B*-tree hierarchy. The top-level node (a header node, described in <A HREF=#MARKER-9-522>"Header Nodes" on page 2-67</A>) always has a level of 0; all other nodes have a level that is one greater than their parent node. Currently, the maximum depth of a node is 8.
<DT><CODE><A NAME=MARKER-2-513></A>ndNRecs</CODE>
<DD> The number of records contained in this node.
<DT><CODE><A NAME=MARKER-2-514></A>ndResv2</CODE>
<DD> Reserved. This field should always be 0.
</DL>
 A node descriptor is always $0E bytes in length, and so the records contained in the node always begin at offset $0E from the beginning of the node. The size of a record can vary, depending on its type and on the amount of information it contains; as a result, the File Manager accesses a record by storing the offset from the beginning of the node to that record in the list of offsets found at the end of the node. Each offset occupies a word, and (as you might have guessed) the last word in a node always contains the value $0E, pointing to the first record in the node. The offsets to subsequent records are stored in order starting from the end of the node, as illustrated in <A HREF=#MARKER-9-508>Figure 2-7</A>.<P>
 Note that there is always one more offset than the number of records contained in a node; this is an offset to the beginning of any unused space in the node. If there is no free space in the node, then that offset contains its own byte offset within the node.<P>
 The <CODE>ndType</CODE> field of the node descriptor indicates the type of a node. In essence, the type of a node indicates what kinds of records it contains and hence what its function in the B*-tree hierarchy is. The File Manager maintains four kinds of nodes in a B*-tree, indicated by constants:<P>
<PRE>
CONST                         {node types}
   ndIndxNode     =  $00;     {index node}
   ndHdrNode      =  $01;     {header node}
   ndMapNode      =  $02;     {map node}
   ndLeafNode     =  $FF;     {leaf node}
</PRE>
 These node types are described in the four sections immediately after the next one.<A NAME=MARKER-2-515></A><A NAME=MARKER-2-516></A><P>
<A NAME=HEADING104-24></A>
<H3>Node Records</H3>
 A record in a B*-tree node contains either data or a pointer to some other node in the tree. <A HREF=#MARKER-9-518>Figure 2-8</A> shows the general structure of a record in a leaf or index node.<A NAME=MARKER-2-517></A><P>
<B>Figure 2-8  <A NAME=MARKER-9-518></A>Structure of a B*-tree node record</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/FM_L-09.jpg"> <p>
<DL>
<DT><B>Note</B>
<DD>The three records in a B*-tree header node do not have the structure depicted in <A HREF=#MARKER-9-518>Figure 2-8</A>. They consist solely of data, as described in the next section, <A HREF=#MARKER-9-522>"Header Nodes."</A> Similarly, the single record in a map node consists solely of data; see <A HREF=#MARKER-9-539>"Map Nodes" on page 2-69</A> for details.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
 Each record contains a <B>search key,</B> which the File Manager uses to search through the B*-tree to locate the information it needs. The key can contain any information at all that is deemed useful in finding the data contained in the leaf nodes. In a catalog file, which maintains information about the hierarchy of files and directories on a volume, the search key is a combination of the file or directory name and the parent directory ID of that file or directory. In an extents overflow file, which maintains information about the extra extents belonging to a file, the search key is a combination of that file's type, its file ID, and the index of the first allocation block in the extent.<A NAME=MARKER-2-519></A><A NAME=MARKER-2-520></A><P>
 In a B*-tree, the records in each node are always grouped so that their keys are in ascending order. Moreover, the nodes on any given level are linked (through the <CODE>ndFLink</CODE> and <CODE>ndBLink</CODE> fields of their node descriptors) in such a way as to preserve the ascending order of record keys throughout that level. This is the essential ordering principle that allows the File Manager to search quickly through a tree. To illustrate this ordering scheme, <A HREF=#MARKER-9-521>Figure 2-9</A> shows a sample B*-tree containing hypothetical search keys (in this case, the keys are simply integers).<P>
 When the File Manager needs to find a data record, it begins searching at the root node (which is an index node, unless the tree has only one level), moving from one record to the next until it finds the record with the highest key that is less than or equal to the search key. The pointer of that record leads to another node, one level down in the tree. This process continues until the File Manager reaches a leaf node; then the records of that leaf node are examined until the desired key is found. At that point, the desired data has also been found.<P>
<B>Figure 2-9  <A NAME=MARKER-9-521></A>A sample B*-tree</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/FM_L-10.jpg"> <p>
 There is of course no guarantee that a record having the desired key will always be found in a search through a B*-tree. In this case, the search stops when a key larger <BR>than the search key is reached. (This is most likely to happen in a search through the catalog file.)<P>
<A NAME=HEADING104-35></A>
<H3><A NAME=MARKER-9-522></A>Header Nodes</H3>
 The first node (that is, node 0) in every B*-tree file is a <B>header node,</B> which contains essential information about the entire B*-tree file. The File Manager stores the location of the header node of the catalog file in the first 2 bytes of the drCTExtRec field of the MDB; the value in those 2 bytes indicates the allocation block number on which the catalog file (and hence the header node) begins. Similarly, the File Manager stores the location of the header node of the extents overflow file in the first 2 bytes of the drXTExtRec field of the MDB.<A NAME=MARKER-2-523></A><P>
<DL>
<DT><B>Note</B>
<DD>When a volume is mounted, the File Manager reads the header node and copies some of the information it contains into a B*-tree control block in memory. See <A HREF=Files-111.html#MARKER-9-697>"B*-Tree Control Blocks" on page 2-83</A> for a description of this control block.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
 A header node contains three records, the second of which occupies 128 bytes and is reserved for use by the File Manager. The other two records are called the B*-tree header record and the B*-tree map record; they occupy the first and third record positions, respectively. Hence, a header node has the structure illustrated in <A HREF=#MARKER-9-524>Figure 2-10</A>.<P>
<B>Figure 2-10  <A NAME=MARKER-9-524></A>Header node structure</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/FM_L-11.jpg"> <p>
<DL>
<DT><B>Note</B>
<DD>The three records contained in the header node do not contain keys.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
 The <B>map record</B> is a bitmap that indicates which nodes in the B*-tree file are used and which are not. The bits are interpreted in exactly the same way as the bits in the volume bitmap: if a bit in the map record is set, then the corresponding node in the B*-tree file is being used. This bitmap occupies 256 bytes and can therefore encode information about 2048 nodes at most. If more nodes are needed to contain all the data that is to be stored in the B*-tree, the File Manager uses a map node to store additional mapping information. See the next section, <A HREF=#MARKER-9-539>"Map Nodes,"</A> for a description of the structure of a map node.<A NAME=MARKER-2-526></A><P>
 The <B>B*-tree header record,</B> a data structure of type <CODE>BTHdrRec</CODE>, contains information about the beginning of the tree, as well as the size of the tree.<P>
<PRE>
TYPE BTHdrRec     =           {B*-tree header}
RECORD
   bthDepth:      Integer;    {current depth of tree}
   bthRoot:       LongInt;    {number of root node}
   bthNRecs:      LongInt;    {number of leaf records in tree}
   bthFNode:      LongInt;    {number of first leaf node}
   bthLNode:      LongInt;    {number of last leaf node}
   bthNodeSize:   Integer;    {size of a node}
   bthKeyLen:     Integer;    {maximum length of a key}
   bthNNodes:     LongInt;    {total number of nodes in tree}
   bthFree:       LongInt;    {number of free nodes}
   bthResv:       ARRAY[1..76] OF SignedByte;   {reserved}
END;
</PRE>
<DL>
<H5>Field Description</H5>
<DT><CODE>bthDepth</CODE>
<DD> The current depth of the B*-tree.
<DT><CODE><A NAME=MARKER-2-528></A>bthRoot</CODE>
<DD> The node number of the root node. The root node is the start of the B*-tree structure; usually the root node is first index node, but it might be a leaf node if there are no index nodes.
<DT><CODE><A NAME=MARKER-2-529></A>bthNRecs</CODE>
<DD> The number of data records (records contained in leaf nodes).
<DT><CODE><A NAME=MARKER-2-530></A>bthFNode</CODE>
<DD> The node number of the first leaf node.
<DT><CODE><A NAME=MARKER-2-531></A>bthLNode</CODE>
<DD> The node number of the last leaf node.
<DT><CODE><A NAME=MARKER-2-532></A>bthNodeSize</CODE>
<DD> The size (in bytes) of a node. Currently, this is always 512.
<DT><CODE><A NAME=MARKER-2-533></A>bthKeyLen</CODE>
<DD> The maximum length of the key records in each node.
<DT><CODE><A NAME=MARKER-2-534></A>bthNNodes</CODE>
<DD> The total number of nodes in the B*-tree.
<DT><CODE><A NAME=MARKER-2-535></A>bthFree</CODE>
<DD> The total number of free nodes in the B*-tree.
<DT><CODE><A NAME=MARKER-2-536></A>bthResv</CODE>
<DD> Reserved.<A NAME=MARKER-2-537></A><A NAME=MARKER-9-538></A>
</DL>
<A NAME=HEADING104-55></A>
<H3><A NAME=MARKER-9-539></A>Map Nodes</H3>
 As indicated in the previous section, the File Manager maintains a bitmap of the tree nodes in the map record of the B*-tree header node. If a B*-tree file contains more than 2048 nodes (enough for about 8000 files), the File Manager uses a<B> map node</B> to store additional node-mapping information. It stores the node number of the new map node in the <CODE>ndFLink</CODE> field of the node descriptor of the header node.<A NAME=MARKER-2-540></A><A NAME=MARKER-2-541></A><P>
 A map node consists of a node descriptor and a single map record. The map record is a continuation of the map record contained in the header node and occupies 494 bytes <BR>(512 bytes in the node, less 14 bytes for the node descriptor and 2 bytes for each of the two record offsets at the end of the node). A map node can therefore contain mapping information for an additional 3952 nodes.<A NAME=MARKER-2-542></A><P>
 If a B*-tree contains more than 6000 nodes (that is, 2048 + 3952, enough for about 25,000 files), the File Manager uses a second map node, the node number of which is stored in the <CODE>ndFLink</CODE> field of the node descriptor of the first map node. If more map nodes are required, each additional map node is similarly linked to the previous one.<P>
<A NAME=HEADING104-59></A>
<H3>Index Nodes</H3>
 An <B>index node</B> contains records that point to other nodes in the B*-tree hierarchy. The File Manager uses index nodes to navigate the tree structure quickly when it wants to find some data (which is always stored in leaf nodes). Index nodes speed a tree search by dividing the tree into smaller pieces, as illustrated in <A HREF=#MARKER-9-521>Figure 2-9</A> (<A HREF=#MARKER-9-521>page 2-67</A>).<A NAME=MARKER-2-543></A><A NAME=MARKER-2-544></A><P>
 The records stored in an index node are called <B>pointer records.</B> A pointer record consists of a key followed by the node number of the corresponding node. The structure of the key varies according to the type of B*-tree file that contains the index node. For a catalog file, the search key is a combination of the file or directory name and the parent directory ID of that file or directory. In an extents overflow file, the search key is a combination of that file's type, its file ID, and the index of the first allocation block in the extent. See the sections <A HREF=Files-105.html#MARKER-9-555>"Catalog File Keys" on page 2-71</A> and <A HREF=Files-106.html#MARKER-9-602>"Extents Overflow Files" on page 2-74</A> for more details on the structure of index node search keys.<A NAME=MARKER-2-545></A><P>
 The immediate descendants of an index node are called the children of the index node. An index node can have from 1 to 15 children, depending on the size of the pointer records that the index node contains. Typically the File Manager selects one of the node's children and continues the search at that node; the File Manager may stop the search, however, if the index node does not contain a pointer record with the appropriate key.<P>
 The first index node in a B*-tree is called the <B>root node.</B> Recall that the B*-tree <BR>header node contains the node number of the root node in the <CODE>bthRoot</CODE> field of <BR>the header record.<A NAME=MARKER-2-546></A><A NAME=MARKER-2-547></A><P>
<A NAME=HEADING104-64></A>
<H3>Leaf Nodes</H3>
 The bottom level of a B*-tree structure is occupied exclusively by <B>leaf nodes,</B> which contain data records (not pointer records). The structure of the leaf node data records varies according to the type of B*-tree under consideration. In an extents overflow file, the leaf node data records consist of a key and an extent record. In a catalog file (described in the next section), the leaf node data records can be any one of four kinds <BR>of records.<A NAME=MARKER-2-548></A><A NAME=MARKER-2-549></A><P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Files-103.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Files-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Files-390.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Files-105.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Files-3.html">&copy; Apple Computer, Inc.</A><br>2 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
