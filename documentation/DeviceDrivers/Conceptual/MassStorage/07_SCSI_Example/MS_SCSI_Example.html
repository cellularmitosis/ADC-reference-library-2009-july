<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Mass Storage Device Driver Programming Guide: Subclassing Protocol Services Drivers</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Subclassing Protocol Services Drivers"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30000738" title="Subclassing Protocol Services Drivers"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../../HardwareDrivers/index.html#//apple_ref/doc/uid/TP30000440-TP40003576" target="_top">Hardware &amp; Drivers</a> &gt; <a href="../../../../HardwareDrivers/MassStorageDevices-date.html#//apple_ref/doc/uid/TP30000440-TP40003576-TP30001039" target="_top">Storage</a> &gt; <a href="../01_Introduction/Introduction.html#//apple_ref/doc/uid/TP30000733-TPXREF101">Mass Storage Device Driver Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../06_LUD_Example/MS_LUD_Example.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../08_Media_Example/MS_Media_Example.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30000738-SW1" title="Subclassing Protocol Services Drivers"></a><h1><a name="//apple_ref/doc/uid/TP30000738-TPXREF101" title="Subclassing Protocol Services Drivers"></a>Subclassing Protocol Services Drivers</h1><p><a name="//apple_ref/doc/uid/TP30000738-DontLinkElementID_281"></a><a name="//apple_ref/doc/uid/TP30000738-DontLinkElementID_282"></a>The protocol services driver in the transport driver layer of the mass storage driver stack is responsible for preparing the commands it receives from the logical unit driver for transmission across a particular bus. Each supported bus defines a bus transport protocol that specifies how commands and data are sent across the bus. If your device does not comply with the bus transport protocol of the bus it’s connected to, you need to subclass the appropriate Apple protocol services driver to provide the support your device requires.</p><p>Apple provides protocol services drivers for devices that comply with the following bus transport protocols:</p><ul class="ul"><li class="li"><p>FireWire Serial Bus Protocol 2 specifications (see <span class="content_text"><a href="http://t10.org" target="_blank">http://t10.org</a></span>)</p></li><li class="li"><p>USB mass storage class specifications (see <span class="content_text"><a href="http://www.usb.org" target="_blank">http://www.usb.org</a></span>)</p></li><li class="li"><p>ATA/ATAPI-5 specifications (see <span class="content_text"><a href="http://t13.org" target="_blank">http://t13.org</a></span>)</p></li></ul><p>This chapter describes how to subclass an Apple-provided protocol services driver to address bus-specific issues. The sample code in this chapter is generic and emphasizes the form your driver should take, rather than the code required to implement a specific method. Because the sample driver is generic, it will not attach to a particular device. To test it with your device, you can replace the generic values for parameters such as vendor or product identification with values that identify your device.</p><p>The sample code in this chapter is from a Xcode project that builds an I/O Kit driver. For more information on how to develop kernel extensions in general and I/O Kit drivers in particular, see <em><a href="../../../../Darwin/Conceptual/KEXTConcept/index.html#//apple_ref/doc/uid/TP40001063" target="_top">Kernel Extension Programming Topics</a></em> and <em><a href="../../WritingDeviceDriver/index.html#//apple_ref/doc/uid/TP30000694" target="_top">I/O Kit Device Driver Design Guidelines</a></em>.</p><div class="importantbox"><a name="//apple_ref/doc/uid/TP30000738-DontLinkElementID_12" title="Important:"></a><p><strong>Important:</strong>&nbsp;The sample code in this chapter is designed to work with Mac OS X version 10.1 and later. It will not work with earlier versions.</p><p></p></div>
<!-- This template is being used for both PDF and HTML. -->

    
    <h4>In this section:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="MS_SCSI_Example.html#//apple_ref/doc/uid/TP30000738-TPXREF102">Setting Up Your Project</a>
				
			<br/>
			
        
			
			
				<a href="MS_SCSI_Example.html#//apple_ref/doc/uid/TP30000738-TPXREF105">Creating Your Driver</a>
				
			<br/>
			
        
			
			
				<a href="MS_SCSI_Example.html#//apple_ref/doc/uid/TP30000738-TPXREF108">Testing Your Driver</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP30000738-TPXREF102" title="Setting Up Your Project"></a><h2>Setting Up Your Project</h2><p>This section describes how to create your driver project and edit your driver’s information property list. The sample driver in this chapter is a protocol services driver for a generic FireWire SBP-2 CD-ROM device so it is a subclass of the Apple-provided <code>IOFireWireSerialBusProtocolTransport</code> driver.</p><p>The sample project uses <code>MyFWProtocolServicesDriver</code> for the name of the driver and generic values such as <code>MySoftwareCompany</code> for the developer name. You should replace these names and values with your own information in order to test this code with your device.</p><a name="//apple_ref/doc/uid/TP30000738-TPXREF103" title="Create a New Project"></a><h3>Create a New Project</h3><p>Open the Xcode application and create a new I/O Kit driver project named <code>MyFWProtocolServicesDriver</code>. Specify a directory for the new project or accept the default.</p><p>When you create a new I/O Kit driver project, Xcode supplies several files, including two empty source files—<code>MyFWProtocolServicesDriver.h</code> and <code>MyFWProtocolServicesDriver.cpp</code>. Before you add any code to these files, however, you should edit your driver’s information property list.</p><a name="//apple_ref/doc/uid/TP30000738-TPXREF104" title="Edit Your Driver&acirc;&#128;&#153;s Property List"></a><h3>Edit Your Driver’s Property List</h3><p><a name="//apple_ref/doc/uid/TP30000738-DontLinkElementID_283"></a><a name="//apple_ref/doc/uid/TP30000738-DontLinkElementID_284"></a><a name="//apple_ref/doc/uid/TP30000738-DontLinkElementID_285"></a>Every driver has an information property list (<code>Info.plist</code> file) that contains information about the driver and what it needs, including its personalities. As described in <span class="content_text"><a href="../04_Matching/MS_Matching.html#//apple_ref/doc/uid/TP30000736-BBIDJJGD">“Driver Personalities and the Matching Process,”</a></span> a driver’s personality contains the matching information the I/O Kit uses to determine the appropriate driver for a device. To make sure your driver loads for your device, you add several properties to its personality dictionary that identify the device or type of device it supports.</p><p>In Xcode, a driver’s <code>Info.plist</code> file is listed in the Groups &amp; Files view in the project. You can edit the property list file as plain XML text in the Xcode editor window or you can choose a different application (such as Property List Editor) to use. For more information on how to select another editor, see <span class="content_text"><a href="../../../../Darwin/Conceptual/KEXTConcept/KEXTConceptIOKit/hello_iokit.html#//apple_ref/doc/uid/20002366" target="_top">Hello I/O Kit: Creating a Driver With Xcode</a></span>.</p><p><a name="//apple_ref/doc/uid/TP30000738-DontLinkElementID_286"></a>The <code>IOKitPersonalities</code> dictionary in the driver’s <code>Info.plist</code> file can contain multiple personality dictionaries, one for each device or type of device your driver supports. The sample driver in this chapter implements only one personality dictionary but you can create additional dictionaries if your driver can support more than one device or device type.</p><p>The sample code uses the following ten property keys:</p><ul class="spaceabove"><li class="li"><p><code>CFBundleIdentifier</code></p></li><li class="li"><p><code>Command_Set</code></p></li><li class="li"><p><code>Command_Spec_ID</code></p></li><li class="li"><p><code>Device_Type</code></p></li><li class="li"><p><code>IOClass</code></p></li><li class="li"><p><code>IOProbeScore</code></p></li><li class="li"><p><code>IOProviderClass</code></p></li><li class="li"><p><code>Physical Interconnect</code></p></li><li class="li"><p><code>Physical Interconnect Location</code></p></li><li class="li"><p><code>Vendor_ID</code></p></li></ul><p>Using your chosen editing environment, create a new child of the <code>IOKitPersonalities</code> dictionary. Make the name of this new child <code>MyFWProtocolServicesDriver</code> and set its class to Dictionary.</p><p>Create ten new children of the <code>MyFWProtocolServicesDriver</code> dictionary, one for each of the ten properties you’ll be adding. <span class="content_text"><a href="MS_SCSI_Example.html#//apple_ref/doc/uid/TP30000738-CAHFJDDE">Table 6-1</a></span> shows the properties, along with their classes and values. To test the sample code with your device, replace values such as <code>MyCommandSetNumber</code> with actual values for your device.</p><a name="//apple_ref/doc/uid/TP30000738-CAHFJDDE" title="Table 6-1Personality properties for MyFWProtocolServicesDriver"></a><div class="tableholder"><table class="graybox" border = "0" cellspacing="0" cellpadding="5"><caption class="tablecaption"><strong>Table 6-1&nbsp;&nbsp;</strong>Personality properties for MyFWProtocolServicesDriver</caption><tr><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Property</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Class</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Value</p></th></tr><tr><td  scope="row"><p><code>CFBundleIdentifier</code></p></td><td ><p>String</p></td><td ><p><code>com.MySoftwareCompany.driver.MyFWProtocolServicesDriver</code></p></td></tr><tr><td  scope="row"><p><code>Command_Set</code></p></td><td ><p>Number</p></td><td ><p><code>MyCommandSetNumber</code></p></td></tr><tr><td  scope="row"><p><code>Command_Spec_ID</code></p></td><td ><p>Number</p></td><td ><p><code>MyCommandSpecIDNumber</code></p></td></tr><tr><td  scope="row"><p><code>Device_Type</code></p></td><td ><p>Number</p></td><td ><p><code>MyDeviceTypeNumber</code></p></td></tr><tr><td  scope="row"><p><code>IOClass</code></p></td><td ><p>String</p></td><td ><p><code>com_MySoftwareCompany_driver_MyFWProtocolServicesDriver</code></p></td></tr><tr><td  scope="row"><p><code>IOProbeScore</code></p></td><td ><p>Number</p></td><td ><p><code>MyProbeScore</code></p></td></tr><tr><td  scope="row"><p><code>IOProviderClass</code></p></td><td ><p>String</p></td><td ><p><code>IOFireWireSBP2LUN</code></p></td></tr><tr><td  scope="row"><p><code>Physical Interconnect</code></p></td><td ><p>String</p></td><td ><p><code>FireWire</code></p></td></tr><tr><td  scope="row"><p><code>Physical Interconnect Location</code></p></td><td ><p>String</p></td><td ><p><code>External</code></p></td></tr><tr><td  scope="row"><p><code>Vendor_ID</code></p></td><td ><p>Number</p></td><td ><p><code>MyVendorID</code></p></td></tr></table></div><p>A driver declares its dependencies on other loadable kernel extensions and in-kernel components in the <code>OSBundleLibraries</code> dictionary. Each dependency has a string value that declares the earliest version of the dependency the driver is compatible with<a name="//apple_ref/doc/uid/TP30000738-DontLinkElementID_287"></a>.<a name="//apple_ref/doc/uid/TP30000738-DontLinkElementID_288"></a></p><p>The sample driver depends on loadable extensions from the <code>IOSCSIArchitectureModel</code> family and the <code>IOFireWire</code> family. To add these dependencies to the <code>OSBundleLibraries</code> dictionary, you create a new child for each dependency. <span class="content_text"><a href="MS_SCSI_Example.html#//apple_ref/doc/uid/TP30000738-CAHIDEDD">Table 6-2</a></span> shows the dependencies you add for the sample driver.</p><a name="//apple_ref/doc/uid/TP30000738-CAHIDEDD" title="Table 6-2Dependencies for MyFWProtocolServicesDriver"></a><div class="tableholder"><table class="graybox" border = "0" cellspacing="0" cellpadding="5"><caption class="tablecaption"><strong>Table 6-2&nbsp;&nbsp;</strong>Dependencies for MyFWProtocolServicesDriver</caption><tr><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Property</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Class</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Value</p></th></tr><tr><td  scope="row"><p><code>com.apple.iokit.IOSCSIArchitectureModelFamily</code></p></td><td ><p>String</p></td><td ><p><code>1.0.0</code></p></td></tr><tr><td  scope="row"><p><code>com.apple.iokit.IOFireWireFamily</code></p></td><td ><p>String</p></td><td ><p><code>1.0.0</code></p></td></tr><tr><td  scope="row"><p><code>com.apple.iokit.IOFireWireSBP2</code></p></td><td ><p>String</p></td><td ><p><code>1.0.0</code></p></td></tr><tr><td  scope="row"><p><code>com.apple.iokit.IOFireWireSerialBusProtocolTransport</code></p></td><td ><p>String</p></td><td ><p><code>1.0.0</code></p></td></tr></table></div><p>Because the driver of a CD-ROM drive must be able to mount root on a local volume, you add the <code>OSBundleRequired</code> property to the top level of its <code>Info.plist</code> file. In other words, the new <code>OSBundleRequired</code> property is a sibling of the <code>IOKitPersonalities</code> and <code>OSBundleLibraries</code> dictionaries, not a child. Edit the new element to match the following: <a name="//apple_ref/doc/uid/TP30000738-DontLinkElementID_289"></a><a name="//apple_ref/doc/uid/TP30000738-DontLinkElementID_290"></a></p><div class="codesample"><table><tr><td scope="row"><pre>OSBundleRequired    String      Local-Root<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000738-TPXREF105" title="Creating Your Driver"></a><h2>Creating Your Driver</h2><p>This section describes some of the elements that must be included in your driver’s source files. To demonstrate the process of subclassing, the sample driver simply overrides the <code>init</code>, <code>start</code>, and <code>stop</code> methods and prints messages. You should replace these trivial functions with your own code that supports your device’s particular physical interconnect transport protocol requirements.</p><p>In Xcode, the driver’s source files are listed in the Groups &amp; Files pane, revealed by the discosure triangle next to the <code>MyFWProtocolServicesDriver</code> project and the disclosure triangle next to the Source folder.</p><a name="//apple_ref/doc/uid/TP30000738-TPXREF106" title="Edit the Header File"></a><h3>Edit the Header File</h3><p>The header file provides access to external declarations and supporting type definitions needed by the functions and objects in the C++ file. The header for the sample driver is simple because it includes only method declarations and no constant or variable declarations. Edit the <code>MyFWProtocolServicesDriver.h</code> file to match the code in <span class="content_text"><a href="MS_SCSI_Example.html#//apple_ref/doc/uid/TP30000738-CJDJIGJB">Listing 6-1</a></span>.</p><a name="//apple_ref/doc/uid/TP30000738-CJDJIGJB" title="Listing 6-1The MyFWProtocolServicesDriver header file"></a><p class="codesample"><strong>Listing 6-1&nbsp;&nbsp;</strong>The MyFWProtocolServicesDriver header file</p><div class="codesample"><table><tr><td scope="row"><pre>#ifndef _MyFWProtocolServicesDriver_H_<span></span></pre></td></tr><tr><td scope="row"><pre>#define _MyFWProtocolServicesDriver_H_<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Because the sample driver is a subclass of the Apple-provided<span></span></pre></td></tr><tr><td scope="row"><pre>// FireWire Serial Bus Protocol driver, it must include that driver's<span></span></pre></td></tr><tr><td scope="row"><pre>// header file.<span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;IOKit/sbp2/IOFireWireSerialBusProtocolTransport.h><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Here, the sample driver declares its inheritance and the method<span></span></pre></td></tr><tr><td scope="row"><pre>// it overrides.<span></span></pre></td></tr><tr><td scope="row"><pre>class com_MySoftwareCompany_driver_MyFWProtocolServicesDriver : public<span></span></pre></td></tr><tr><td scope="row"><pre>                            IOFireWireSerialBusProtocolTransport<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSDeclareDefaultStructors (<span></span></pre></td></tr><tr><td scope="row"><pre>            com_MySoftwareCompany_driver_MyFWProtocolServicesDriver )<span></span></pre></td></tr><tr><td scope="row"><pre>public:<span></span></pre></td></tr><tr><td scope="row"><pre>    virtual bool init ( OSDictionary * propTable );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    virtual bool start ( IOService * provider );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    virtual void stop ( IOService * provider );<span></span></pre></td></tr><tr><td scope="row"><pre>};<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#endif /* _MyFWProtocolServicesDriver_H_ */<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000738-TPXREF107" title="Edit the C++ File"></a><h3>Edit the C++ File</h3><p>The C++ file provides the code to override the chosen methods. The sample driver’s C++ file contains all the elements required for a subclassed driver even though it accomplishes nothing more substantial than messages sent to the system log file, <code>/var/log/system.log</code>.</p><p>Edit the <code>MyFWProtocolServicesDriver.cpp</code> file to match the code in <span class="content_text"><a href="MS_SCSI_Example.html#//apple_ref/doc/uid/TP30000738-CJDJJBDG">Listing 6-2</a></span>.</p><a name="//apple_ref/doc/uid/TP30000738-CJDJJBDG" title="Listing 6-2The MyFWProtocolServicesDriver C++ file"></a><p class="codesample"><strong>Listing 6-2&nbsp;&nbsp;</strong>The MyFWProtocolServicesDriver C++ file</p><div class="codesample"><table><tr><td scope="row"><pre>// Include the header file you created.<span></span></pre></td></tr><tr><td scope="row"><pre>#include "MyFWProtocolServicesDriver.h"<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// This definition allows you to use the more convenient "super" in<span></span></pre></td></tr><tr><td scope="row"><pre>// place of "IOFireWireSerialBusProtocolTransport", where appropriate.<span></span></pre></td></tr><tr><td scope="row"><pre>#define super IOFireWireSerialBusProtocolTransport<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// This macro must appear before you define any of your class's methods.<span></span></pre></td></tr><tr><td scope="row"><pre>// Note that you must use the literal name of the superclass here, not<span></span></pre></td></tr><tr><td scope="row"><pre>// "super" as defined above.<span></span></pre></td></tr><tr><td scope="row"><pre>OSDefineMetaClassAndStructors (<span></span></pre></td></tr><tr><td scope="row"><pre>            com_MySoftwareCompany_driver_MyFWProtocolServicesDriver,<span></span></pre></td></tr><tr><td scope="row"><pre>            IOFireWireSerialBusProtocolTransport );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Define the methods to override.<span></span></pre></td></tr><tr><td scope="row"><pre>bool<span></span></pre></td></tr><tr><td scope="row"><pre>com_MySoftwareCompany_driver_MyFWProtocolServicesDriver::init (<span></span></pre></td></tr><tr><td scope="row"><pre>                                            OSDictionary * propTable )<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    bool returnValue;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    IOLog ( "MyFWProtocolServicesDriver overriding init\n" );<span></span></pre></td></tr><tr><td scope="row"><pre>// You can add code that initializes your device here.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Call super's init method to make sure all other initialization is done.<span></span></pre></td></tr><tr><td scope="row"><pre>    returnValue = super::init ( propTable );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return returnValue;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>bool com_MySoftwareCompany_iokit_MyFWProtocolServicesDriver:: start (<span></span></pre></td></tr><tr><td scope="row"><pre>                                            IOService * provider )<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    bool returnValue = false;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    IOLog ( "MyFWProtocolServicesDriver overriding start\n" );<span></span></pre></td></tr><tr><td scope="row"><pre>// You can add code for your driver's start functions here.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Call super's start method to make sure all other start functions are<span></span></pre></td></tr><tr><td scope="row"><pre>// fulfilled.<span></span></pre></td></tr><tr><td scope="row"><pre>    returnValue = super::start ( provider );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return returnValue;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>void com_MySoftwareCompany_iokit_MyFWProtocolServicesDriver::stop (<span></span></pre></td></tr><tr><td scope="row"><pre>                                            IOService * provider )<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    IOLog ( "MyFWProcolLayerDriver overriding stop\n" );<span></span></pre></td></tr><tr><td scope="row"><pre>// You can add code for your driver's stop functions here.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Call super's stop method to ensure all other necessary clean-up is done.<span></span></pre></td></tr><tr><td scope="row"><pre>    super::stop ( provider );<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000738-TPXREF108" title="Testing Your Driver"></a><h2>Testing Your Driver</h2><p>This section presents some advice on testing<a name="//apple_ref/doc/uid/TP30000738-DontLinkElementID_291"></a> your driver. You cannot use <code>kextload</code> to load and test your driver “by hand” because there are generic drivers that will always load in its place at boot time. Therefore, you need to make sure you have multiple bootable disks or partitions so you can remove your driver if it behaves badly and reboot the disk or partition.</p><p>Because the <code>OSBundleRequired</code> property in the sample driver’s <code>Info.plist</code> file is set to <code>Local-Root</code>, the BootX booter will automatically load it when the system is restarted (for more information on this process, see <span class="content_text"><a href="../../../../Darwin/Conceptual/KEXTConcept/KEXTConceptLoading/loading_kexts.html#//apple_ref/doc/uid/20002369" target="_top">Loading Kernel Extensions at Boot Time</a></span>).</p><p>For help with debugging, you can open a window in the Terminal application (located at <code>/Applications/Utilities/Terminal</code>) and type the following line to view the system log:<a name="//apple_ref/doc/uid/TP30000738-DontLinkElementID_292"></a><a name="//apple_ref/doc/uid/TP30000738-DontLinkElementID_293"></a></p><div class="codesample"><table><tr><td scope="row"><pre>tail -f /var/log/system.log<span></span></pre></td></tr></table></div>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../06_LUD_Example/MS_LUD_Example.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../08_Media_Example/MS_Media_Example.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2002, 2007 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2007-04-03<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/DeviceDrivers/Conceptual/MassStorage/07_SCSI_Example/MS_SCSI_Example.html%3Fid%3DTP40000974-4.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/DeviceDrivers/Conceptual/MassStorage/07_SCSI_Example/MS_SCSI_Example.html%3Fid%3DTP40000974-4.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/DeviceDrivers/Conceptual/MassStorage/07_SCSI_Example/MS_SCSI_Example.html%3Fid%3DTP40000974-4.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>