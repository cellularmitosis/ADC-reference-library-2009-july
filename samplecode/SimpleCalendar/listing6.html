<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>SimpleCalendar - /CalendarController.m</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/AppleApplications/index.html">Apple Applications</a> &gt; <a href="../../samplecode/AppleApplications/idxiCal-date.html">iCal</a> &gt; <A HREF="javascript:location.replace('index.html');">SimpleCalendar</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->


	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">SimpleCalendar</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/CalendarController.m</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/AppDelegate.h</option>
<option value="listing2.html">/AppDelegate.m</option>
<option value="listing3.html">/Calendar.h</option>
<option value="listing4.html">/Calendar.m</option>
<option value="listing5.html">/CalendarController.h</option>
<option value="listing6.html">/CalendarController.m</option>
<option value="listing7.html">/DayController.h</option>
<option value="listing8.html">/DayController.m</option>
<option value="listing9.html">/main.m</option>
<option value="listing10.html">/ReadMe.txt</option></select>
				</p>
				</form>
				<p><strong><a href="SimpleCalendar.zip">Download Sample</a></strong> (&#147;SimpleCalendar.zip&#148;, 117.7K)<BR>
<strong><a href="SimpleCalendar.dmg">Download Sample</a></strong> (&#147;SimpleCalendar.dmg&#148;, 169.4K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*

File: CalendarController.h

Abstract: Controls a calendar model object.

Disclaimer: IMPORTANT:  This Apple software is supplied to you by Apple
Computer, Inc. (&quot;Apple&quot;) in consideration of your agreement to the
following terms, and your use, installation, modification or
redistribution of this Apple software constitutes acceptance of these
terms.  If you do not agree with these terms, please do not use,
install, modify or redistribute this Apple software.

In consideration of your agreement to abide by the following terms, and
subject to these terms, Apple grants you a personal, non-exclusive
license, under Apple's copyrights in this original Apple software (the
&quot;Apple Software&quot;), to use, reproduce, modify and redistribute the Apple
Software, with or without modifications, in source and/or binary forms;
provided that if you redistribute the Apple Software in its entirety and
without modifications, you must retain this notice and the following
text and disclaimers in all such redistributions of the Apple Software. 
Neither the name, trademarks, service marks or logos of Apple Computer,
Inc. may be used to endorse or promote products derived from the Apple
Software without specific prior written permission from Apple.  Except
as expressly stated in this notice, no other rights or licenses, express
or implied, are granted by Apple herein, including but not limited to
any patent rights that may be infringed by your derivative works or by
other works in which the Apple Software may be incorporated.

The Apple Software is provided by Apple on an &quot;AS IS&quot; basis.  APPLE
MAKES NO WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION
THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY AND FITNESS
FOR A PARTICULAR PURPOSE, REGARDING THE APPLE SOFTWARE OR ITS USE AND
OPERATION ALONE OR IN COMBINATION WITH YOUR PRODUCTS.

IN NO EVENT SHALL APPLE BE LIABLE FOR ANY SPECIAL, INDIRECT, INCIDENTAL
OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
INTERRUPTION) ARISING IN ANY WAY OUT OF THE USE, REPRODUCTION,
MODIFICATION AND/OR DISTRIBUTION OF THE APPLE SOFTWARE, HOWEVER CAUSED
AND WHETHER UNDER THEORY OF CONTRACT, TORT (INCLUDING NEGLIGENCE),
STRICT LIABILITY OR OTHERWISE, EVEN IF APPLE HAS BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.

Copyright &copy; 2006 Apple Computer, Inc., All Rights Reserved

*/ 

#import &quot;CalendarController.h&quot;
#import &quot;Calendar.h&quot;
#import &quot;DayController.h&quot;
#import &lt;CalendarStore/CalendarStore.h&gt;

static int DaysPerWeek = 7; // just in case you want to display a different number of days per week, ha-ha

// CalendarController is a traditional Cocoa controller that encapsulates a Calendar view of events. 
// Calendar is the owner of the Calendar.nib file and has a view and window. The model is a collection of calendar years. 
// Each calendar has an array of months, and each month has an array of weeks. The Calendar view is a box containing tiled subviews.
// Each subview represents a day in the current month. The day view consists of a composite view and controller.
// The content of each controller is set to one of the models of a day.

// Instances of Calendar observe changes to the iCal events. When events are added or removed from iCal, 
// the CalendarController adds and removes those objects from the day models, consequently updating the 
// view of the current month.

// This class also provides methods for moving one year forward and backward, and moving one month forward and backward.

@implementation CalendarController

- (id)init
{
    self = [super init];
    if (self) {
    _calendarYears = [[NSMutableArray array] retain];

    // Initially create the current year, and add years later as needed--as events are added the dates are checked.
    NSCalendarDate *today = [NSCalendarDate calendarDate];
    NSCalendarDate *year = [NSCalendarDate dateWithYear:[today yearOfCommonEra]
                            month:1 day:1 hour:0 minute:0 second:0
                           timeZone:[today timeZone]];
    [_calendarYears addObject:[self _createCalendarYear:year]];
    //NSLog(@&quot;calendarYears=%@&quot;, [_calendarYears description]);
    
    // Load my window and view
    if (![NSBundle loadNibNamed:@&quot;Calendar.nib&quot; owner:self]) {
      NSLog(@&quot;failed to load Calendar.nib&quot;);
    }
    [window setBackgroundColor:[NSColor whiteColor]];
    
    NSRect superFrame = [view frame];
    _dayControllers = [[NSMutableArray array] retain];
    int i;
    float x = 0.0, y = superFrame.size.height;
    float w = superFrame.size.width/7;
    float h = superFrame.size.height/5;
    for (i = 0; i &lt; 5; i++){
      int j;
      for (j= 0; j &lt; 7; j++){
        DayController *dayCtlr = [[DayController alloc] init];
        [_dayControllers addObject:dayCtlr];
        [[dayCtlr view] setFrame:NSMakeRect(x, y - h, w, h)];
        [view addSubview:[dayCtlr view]]; // will retain view
        x += w-1;
      }
      y -= h-1; // the last frame height
      x = 0.0;
    }
    [self setYearObject:[self firstYear]];
    }
    return self;
}

- (void)dealloc {
    [_calendarYears release];
  [_dayControllers release];
  [model release];

    [super dealloc];
}

// Returns the data source used by this Calendar.
- (id)model
{
  return model;
}

// Sets the receiver's data source to dataSource.
- (void)setModel:(id)anObject
{
  // Observe changes to Event records maintained by the model.
  
  // Remove the receiver as an observer of the old data source
  [model removeObserver:self forKeyPath:@&quot;events&quot;];
  
  // Remove all events belonging to the existing model from the calendar controller and views
  [self removeEvents:[model events]];
  
  [model release];
  model = [anObject retain];
  
  // Add events from the new model to the calendar controller and views
  [self addEvents:[model events]];
  
  // Add the receiver as an observer of the events array using a key path
  [model addObserver:self forKeyPath:@&quot;events&quot;
             options:(NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld) context:NULL];
}

- (id)firstYear
{
  return [_calendarYears objectAtIndex:0];
}

// Convenience methods for testing

- (id)firstMonth
{
  if ([_calendarYears count] &gt; 0){
    NSArray *months = [[_calendarYears objectAtIndex:0] valueForKey:@&quot;months&quot;];
    return [months objectAtIndex:0];
  }

  return nil;
}

// Accessor Methods

- (id)window
{
  return window;
}

- (id)year
{
  return _year;
}

- (void)displayToday
{
  NSCalendarDate *today = [NSCalendarDate calendarDate];
  [self setYearObject:[self yearWithDate:today]];
  [self setMonth:[[_year valueForKey:@&quot;months&quot;] objectAtIndex:([today monthOfYear]-1)]];
}

- (void)setYearObject:(id)anObject
{
  // No need to retain it, it is an object in the calendar year array
  _year = anObject;
  [self setMonth:[[_year valueForKey:@&quot;months&quot;] objectAtIndex:0]]; // defaults to the first month of the year
}

- (id)nextYear
{
  int nextIndex;
  if (_year == nil)
    nextIndex = 0;
  else
    nextIndex = [_calendarYears indexOfObject:_year] + 1;
  if (nextIndex &gt;= [_calendarYears count])
    nextIndex = 0; // wrap around
  
  [self setYearObject:[_calendarYears objectAtIndex:nextIndex]];
  return _year;
}

- (id)previousYear
{
  int nextIndex;
  if (_year == nil)
    nextIndex = 0;
  else
    nextIndex = [_calendarYears indexOfObject:_year] - 1;
  if (nextIndex &lt; 0)
    nextIndex = [_calendarYears count]-1; // wrap around
  
  [self setYearObject:[_calendarYears objectAtIndex:nextIndex]];
  return _year;
}

- (id)month
{
  return _month;
}

- (void)setMonth:(id)anObject
{
  //NSLog(@&quot;setMonth: anObject=%@&quot;, [anObject valueForKey:@&quot;date&quot;]);
  // No need to retain it, it is an object in the current year
  _month = anObject;
  
  // Set the controller models so that the first month of the year is displayed
  NSEnumerator *weekEnumerator = [[_month valueForKey:@&quot;weeks&quot;] objectEnumerator];
  NSDictionary *week;
  NSEnumerator *controllerEnumerator = [_dayControllers objectEnumerator];
  while (week = [weekEnumerator nextObject]){
    [[controllerEnumerator nextObject] setModel:[week valueForKey:@&quot;Sun&quot;]];
    [[controllerEnumerator nextObject] setModel:[week valueForKey:@&quot;Mon&quot;]];
    [[controllerEnumerator nextObject] setModel:[week valueForKey:@&quot;Tue&quot;]];
    [[controllerEnumerator nextObject] setModel:[week valueForKey:@&quot;Wed&quot;]];
    [[controllerEnumerator nextObject] setModel:[week valueForKey:@&quot;Thu&quot;]];
    [[controllerEnumerator nextObject] setModel:[week valueForKey:@&quot;Fri&quot;]];
    [[controllerEnumerator nextObject] setModel:[week valueForKey:@&quot;Sat&quot;]];
  }
  
  id controller;
  while (controller = [controllerEnumerator nextObject]){
    [controller setModel:nil]; // unused controller-view pairs
  }
}

// Returns the next month object. May wrap to the first month of the first year if there is no next year.
- (id)nextMonth
{
  //NSLog(@&quot;nextMonth _year=%@ _month=%@&quot;, [_year valueForKey:@&quot;date&quot;], [_month valueForKey:@&quot;date&quot;]);
  int nextIndex;
  if (_month == nil)
    nextIndex = 0;
  else
    nextIndex = [[_year valueForKey:@&quot;months&quot;] indexOfObject:_month] + 1;
  if (nextIndex &gt;= [[_year valueForKey:@&quot;months&quot;] count]){
    // Go to the last month of the previous year
    (void)[self nextYear];
    nextIndex = 0; // wrap around
  }
  
  [self setMonth:[[_year valueForKey:@&quot;months&quot;] objectAtIndex:nextIndex]];
  //NSLog(@&quot;nextMonth index=%d&quot;, nextIndex);
  return _month;
}

// Returns the previous month object. May wrap to the last month of the last year if there is no previous year.
- (id)previousMonth
{
  int nextIndex;
  if (_month == nil)
    nextIndex = 0;
  else
    nextIndex = [[_year valueForKey:@&quot;months&quot;] indexOfObject:_month] - 1;
  if (nextIndex &lt; 0){
    // Go to the last month of the previous year
    (void)[self previousYear];
    nextIndex = [[_year valueForKey:@&quot;months&quot;] count] - 1; 
  }
  
  [self setMonth:[[_year valueForKey:@&quot;months&quot;] objectAtIndex:nextIndex]];
  //NSLog(@&quot;previousMonth index=%d&quot;, nextIndex);
  return _month;
}

// Returns the array of calendar years.
- (id)calendarYears
{
  return _calendarYears;
}

// Returns the day model for the specified date.
- (id)dayWithDate:(NSCalendarDate *)date
{
  id year = [self yearWithDate:date];
  if (year == nil) return nil;

  // find the day
  id month = [[year valueForKey:@&quot;months&quot;] objectAtIndex:[date monthOfYear]-1];
  int weekOfMonth; // value of 0 through 4 or 5
  {
    int dayOfMonth = [date dayOfMonth];
    NSCalendarDate *m = [NSCalendarDate dateWithYear:[date yearOfCommonEra] 
                             month:[date monthOfYear] day:1 hour:0 minute:0 second:0
                          timeZone:[date timeZone]];
    int firstDayOfWeek = [m dayOfWeek];
    weekOfMonth = (dayOfMonth + firstDayOfWeek - 1)/DaysPerWeek;
  }
  id week = [[month valueForKey:@&quot;weeks&quot;] objectAtIndex:weekOfMonth];
  id day = [week valueForKey:[date descriptionWithCalendarFormat:@&quot;%a&quot;]];
  
  return day;
}

// Return the days in the specified date range. Used to get the days for a multi-day event.
- (NSMutableArray *)daysFromDate:(NSCalendarDate *)startDate toDate:(NSCalendarDate *)endDate
{
  NSMutableArray *days = [NSMutableArray array];
  int ii, dd, mm;

  // Nothing to compute if there's no start date
  if ((startDate == nil) || [startDate isEqual:[NSNull null]])
    return nil;
  
  // Always add the first day of the event
  [days addObject:[self dayWithDate:startDate]];
  
  // Check for multi-day event
  //NSLog(@&quot;endDate=%@ startDate=%@&quot;, [endDate description], [startDate description]);
  if ((endDate != nil) &amp;&amp; ![endDate isEqual:[NSNull null]] &amp;&amp; ([startDate dayOfCommonEra] &lt; [endDate dayOfCommonEra])){
    [endDate years:NULL months:NULL days:NULL hours:NULL minutes:&amp;mm seconds:NULL sinceDate:startDate];
    dd = (mm-1)/1440; // adjust by one minute for all day events
    NSCalendarDate *nextDate = startDate;
    for (ii = 0; ii &lt; dd; ii++){
      nextDate =[nextDate dateByAddingYears:0 months:0 days:1 hours:0 minutes:0 seconds:0];
      [days addObject:[self dayWithDate:nextDate]];
    }
  }
  return days;
}

// Returns the year model for the specified date
- (id)yearWithDate:(NSCalendarDate *)date
{
  if ((date == nil) || [date isEqual:[NSNull null]]) return nil;
  NSEnumerator *yearEnumerator = [_calendarYears objectEnumerator];
  id year;
  
  // find the matching year
  for (year = [yearEnumerator nextObject]; 
     (year != nil) &amp;&amp; ([date yearOfCommonEra] != [[year valueForKey:@&quot;date&quot;] yearOfCommonEra]);
     year = [yearEnumerator nextObject]){
  }

  return year;
}

// Adding and Removing Events

// Adds an array of events to the calendar.
- (void)addEvents:(NSArray *)events
{
  NSEnumerator *eventEnumerator = [events objectEnumerator];
  id event;
  
  while (event = [eventEnumerator nextObject]){
    [self addEvent:event];
  }
}

// Adds a single event to the calendar.
- (void)addEvent:(id)event
{
    // Convert dates to calendar date values
  NSCalendarDate *startDate = [[event valueForKey:@&quot;startDate&quot;] dateWithCalendarFormat:nil timeZone:nil];
  NSCalendarDate *endDate = [[event valueForKey:@&quot;endDate&quot;] dateWithCalendarFormat:nil timeZone:nil];
  
  // Check to see if you need to add the year for this event
  if ([self yearWithDate:startDate] == nil){
    NSCalendarDate *year = [NSCalendarDate dateWithYear:[startDate yearOfCommonEra] 
                            month:1 day:1 hour:0 minute:0 second:0
                           timeZone:[startDate timeZone]];
    // Add the new year and then sort the years by date
    [_calendarYears addObject:[self _createCalendarYear:year]];
    id dateDescriptor = [[[NSSortDescriptor alloc] initWithKey:@&quot;date&quot; ascending:YES] autorelease];
    [_calendarYears sortUsingDescriptors:[NSArray arrayWithObject:dateDescriptor]];
    /*
    {
      NSEnumerator *yearEnumerator = [_calendarYears objectEnumerator];
      id aYear;
      while (aYear = [yearEnumerator nextObject]){
        NSLog(@&quot;year=%d&quot;, [[aYear valueForKey:@&quot;date&quot;] yearOfCommonEra]);
      }
    }
     */
  }
  NSMutableArray *days = [self daysFromDate:startDate toDate:endDate];
  [self addEvent:event toDays:days];
  
  return;
}

// Adds a multi-day event to the specified days on the calendar.
- (void)addEvent:(id)event toDays:(NSArray *)days
{
  NSEnumerator *dayEnumerator = [days objectEnumerator];
  id day;
  while (day = [dayEnumerator nextObject]){
    id events = [day mutableArrayValueForKey:@&quot;events&quot;];
    if (events == nil){
      [day setValue:[NSMutableArray array] forKey:@&quot;events&quot;];
      events = [day mutableArrayValueForKey:@&quot;events&quot;]; 
    }
    [events addObject:event];
    [day setValue:event forKey:@&quot;currentEvent&quot;]; // select the last added event
  }
  // Observe changes to the start and end dates
  [event addObserver:self forKeyPath:@&quot;startDate&quot;
         options:(NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld) 
         context:NULL];
  [event addObserver:self forKeyPath:@&quot;endDate&quot;
         options:(NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld) 
         context:NULL];
  return;
}

// Removes the array of events from the calendar.
- (void)removeEvents:(NSArray *)events
{
  NSEnumerator *eventEnumerator = [events objectEnumerator];
  id event;
  
  while (event = [eventEnumerator nextObject]){
    [self removeEvent:event];
  }
}

// Removes a single event from the calendar.
- (void)removeEvent:(id)event
{
  NSCalendarDate *startDate = [[event valueForKey:@&quot;startDate&quot;] dateWithCalendarFormat:nil timeZone:nil];
  NSCalendarDate *endDate = [[event valueForKey:@&quot;endDate&quot;] dateWithCalendarFormat:nil timeZone:nil];
  NSMutableArray *days = [self daysFromDate:startDate toDate:endDate];
  [self removeEvent:event fromDays:days];
}

// Removes a multi-day event from the specified days of the calendar.
- (void)removeEvent:(id)event fromDays:(NSArray *)days
{
  NSEnumerator *dayEnumerator = [days objectEnumerator];
  id day;
  while (day = [dayEnumerator nextObject]){
    id events = [day mutableArrayValueForKey:@&quot;events&quot;];
    [events removeObject:event];
  }
  
  // Remove the calendar as an observer of the start and end date
  [event removeObserver:self forKeyPath:@&quot;startDate&quot;];
  [event removeObserver:self forKeyPath:@&quot;endDate&quot;];
  return;
}


// KVO Methods

// Observers changes to the data source. When records are added and removed they are added and removed from the calendar
// model and calendar views are updated via Cocoa Bindings.
- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary *)change context:(void *)context
{  
    // #warning Workaround for observer method change dictionary ValueChangeKind
  // NOTE: This method is currently being invoked without the change dictionary set as expected. The method is invoked
  // repeatedly with the NSKeyValueChangeKindKey equal to NSKeyValueChangeSetting, none of the other types of changes are
  // sent. The NSKeyValueChangeNewKey contains ALL the records, not just the added ones. Hence there is a workaround below
  // that can be removed if this issue is fixed.
  // 04-06-13 Still appears to be a bug in the Tiger seed release.
  
  NSLog(@&quot;observeValueForKeyPath:... keyPath=%@ object=%@&quot;, keyPath, (object == model) ? @&quot;model&quot; : [object description]);
  
  // The model's events array changed
  if ([object isKindOfClass:[Calendar class]] &amp;&amp; [keyPath isEqual:keyPath]){
    NSLog(@&quot;newRecords=%@&quot;, [[[change valueForKey:NSKeyValueChangeNewKey] valueForKey:@&quot;title&quot;] description]);
    NSLog(@&quot;oldRecords=%@&quot;, [[[change valueForKey:NSKeyValueChangeOldKey] valueForKey:@&quot;title&quot;] description]);
    NSLog(@&quot;change=%d&quot;, [[change valueForKey:NSKeyValueChangeKindKey] intValue]);
    
    // Work around is to compare the two arrays and figure out if this is a change, remove, or add operation
    int changeKind = [[change valueForKey:NSKeyValueChangeKindKey] intValue];
    id newRecords = [change valueForKey:NSKeyValueChangeNewKey];
    id oldRecords = [change valueForKey:NSKeyValueChangeOldKey];
    NSMutableArray *delta = nil;
    if ([newRecords count] &gt; [oldRecords count]){
      // guess that a record was added
      delta = [NSMutableArray arrayWithArray:newRecords];
      [delta removeObjectsInArray:oldRecords];
      changeKind = NSKeyValueChangeInsertion;
    }
    else if ([newRecords count] &lt; [oldRecords count]){
      // guess that a record was removed
      delta = [NSMutableArray arrayWithArray:oldRecords];
      [delta removeObjectsInArray:newRecords];
      changeKind = NSKeyValueChangeRemoval;
    }    
    else{
      // This is probably a wrong conclusion because a record could have been replaced. In which case,
      // invoking _didAddRecords:forEntityName: on all the old and new records is harmless because it will
      // just mark records that don't have primaryKeys yet (won't harm exisitng records).
      changeKind = NSKeyValueChangeSetting;
    }
    
    if (changeKind ==  NSKeyValueChangeSetting){
      //NSLog(@&quot;change=NSKeyValueChangeSetting&quot;);
      [self addEvents:[change valueForKey:NSKeyValueChangeNewKey]];
    }    
    if (changeKind == NSKeyValueChangeInsertion){
      //NSLog(@&quot;change=NSKeyValueChangeInsertion&quot;);
      [self addEvents:delta];  
    }
    if (changeKind  == NSKeyValueChangeRemoval){
      //NSLog(@&quot;change=NSKeyValueChangeRemoval&quot;);
      [self removeEvents:delta];
    }
    if (changeKind == NSKeyValueChangeReplacement){
      //NSLog(@&quot;change=NSKeyValueChangeReplacement&quot;);
      [self removeEvents:[change valueForKey:NSKeyValueChangeOldKey]];
      [self addEvents:[change valueForKey:NSKeyValueChangeNewKey]];          
    }
  }
  
  // A property of a record changed
  else if ([object isKindOfClass:[CalEvent class]] &amp;&amp; ([[change valueForKey:NSKeyValueChangeKindKey] intValue] == NSKeyValueChangeSetting)){
    NSLog(@&quot;The UI or the calendar model (originated by iCal) changed a CalEvent property...&quot;);
    // Assumes the start or end date of an event changed
    if ([keyPath isEqual:@&quot;startDate&quot;] || [keyPath isEqual:@&quot;endDate&quot;]){
      NSCalendarDate *oldDate = [change valueForKey:NSKeyValueChangeOldKey];
      NSLog(@&quot;oldDate=%@&quot;, [oldDate description]);
      NSMutableArray *days;
      if ([keyPath isEqual:@&quot;startDate&quot;])
        days = [self daysFromDate:oldDate toDate:[object valueForKey:@&quot;endDate&quot;]];
      else
        days = [self daysFromDate:[object valueForKey:@&quot;startDate&quot;] toDate:oldDate];
      [self removeEvent:object fromDays:days];
      [self addEvent:object];
    }
    // Any other types of changes are handled by Cocoa Bindings
  }  
  
  return;
}


// Action Methods

// Action method to display the previous month. May wrap to the last month of the last year if there is no previous year.
- (IBAction)previousMonth:(id)sender
{
  [self previousMonth];
  return;
}

// Action method to display the next month. May wrap to the first month of the first year if there is no next year.
- (IBAction)nextMonth:(id)sender
{
  [self nextMonth];
  return;
}


// Model Creation Methods--these methods are used to create the calendar, year, month, and day model objects.

// Returns an array of years that we are modeling
- (id)_createCalendarYear:(NSCalendarDate *)year {
  id dict = [self _createYearWithDate:year];
  [dict setValue:[self _createMonthsOfYear:year] forKey:@&quot;months&quot;];
  return dict;
}

// Returns an array of months for the given year where each month has keys: date, name, weeks
- (id)_createMonthsOfYear:(NSCalendarDate *)year
{
  NSMutableArray *slots = [NSMutableArray array];
  NSCalendarDate *month = [[year copy] autorelease];
  int j, y = [month yearOfCommonEra];
  
  for (j = y; j == y;){
    // Create a dictionary representing this month
    id dict = [self _createMonthWithDate:month];
    [dict setValue:[self _createWeeksOfMonth:month] forKey:@&quot;weeks&quot;];
    [slots addObject:dict];
    month = [month dateByAddingYears:0 months:1 days:0 hours:0 minutes:0 seconds:0];
    j = [month yearOfCommonEra];
  }
  
  return slots;
}

// Returns an NSArray containing weeks of a month where each week is a dictionary (see daysOfWeek:)
- (id)_createWeeksOfMonth:(NSCalendarDate *)month
{
  NSMutableArray *slots = [NSMutableArray array];
  NSCalendarDate *week = [[month copy] autorelease];
  int j, m = [week monthOfYear];
  
  for (j = m; j == m;){
    [slots addObject:[self _createDaysOfWeek:week]];
    week = [week dateByAddingYears:0 months:0 days:(DaysPerWeek - [week dayOfWeek]) hours:0 minutes:0 seconds:0];
    j = [week monthOfYear];
  }
  
  return slots;
}

// Returns a dictionary representation of a week in a month withkeys: Sun, Mon, Tues, Wed, Thurs, Fri, Sat
- (id)_createDaysOfWeek:(NSCalendarDate *)week
{
  NSMutableArray *slots =[NSMutableArray array];
  NSCalendarDate *day;
  int m = [week monthOfYear];
  int i, j;
  
  // Create preceeding month's days to fill out the week
  int firstDayOfWeek = [week dayOfWeek];
  for (i=0; i &lt; firstDayOfWeek; i++){
    day = [week dateByAddingYears:0 months:0 days:(i-firstDayOfWeek) hours:0 minutes:0 seconds:0];
    [slots addObject:day];
  }
  
  // Create remaining days
  day = [[week copy] autorelease];
  for (i = firstDayOfWeek, j = m; (i &lt; DaysPerWeek) &amp;&amp; (j == m); i++){
    [slots addObject:day];
    day = [day dateByAddingYears:0 months:0 days:1 hours:0 minutes:0 seconds:0];
    j = [day monthOfYear];
  }
  
  // Now you have an array containing the dates in this week to use to create a dictionary representation of the week
  NSMutableDictionary *dict = [NSMutableDictionary dictionary];
  
  for (i = 0; i &lt; [slots count]; i++) {
    id value = [self _createDayWithDate:[slots objectAtIndex:i]];
    id key = [[slots objectAtIndex:i] descriptionWithCalendarFormat:@&quot;%a&quot;];
    //NSLog(@&quot;day key=%@&quot;, key);
    [dict setValue:value forKey:key];
  }
  
  // NOTE: You probably want to share the day objects from the previous or preceeding months with the previous
  // or preceeding weeks. Should enhance this later to do so if this causes problems (multiple reps of the same day).
  
  return dict;
  
}

// Returns a dictionary representation of a year where the year keys are: date, months
- (id)_createYearWithDate:(NSCalendarDate *)date
{
  //NSLog(@&quot;yearWithDate: %@&quot;, [date description]);
  NSMutableDictionary *year = [NSMutableDictionary dictionary];
  [year setValue:date forKey:@&quot;date&quot;];
  // more keys will be added later
  return year;
}

// Returns a dictionary representation of a month where the month keys are: date, name, weeks
- (id)_createMonthWithDate:(NSCalendarDate *)date
{
  //NSLog(@&quot;monthWithDate: %@&quot;, [date description]);
  NSMutableDictionary *month = [NSMutableDictionary dictionary];
  [month setValue:date forKey:@&quot;date&quot;];
  [month setValue:[date descriptionWithCalendarFormat:@&quot;%B&quot;] forKey:@&quot;name&quot;]; // not necessary, is derived
  // more keys will be added later
  return month;
}

// Returns a dictionary representation of a day where day keys are: date, events. Events are added to the day later.
- (id)_createDayWithDate:(NSCalendarDate *)date
{
  //NSLog(@&quot;dayWithDate: %@&quot;, [date description]);
  NSMutableDictionary *day = [NSMutableDictionary dictionary];
  [day setValue:date forKey:@&quot;date&quot;];
  //[day setValue:[NSMutableArray array] forKey:@&quot;events&quot;];
  // more keys will be added later
  return day;
}


@end
</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/SimpleCalendar/listing6.html%3Fid%3DDTS10003991-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/SimpleCalendar/listing6.html%3Fid%3DDTS10003991-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/SimpleCalendar/listing6.html%3Fid%3DDTS10003991-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>