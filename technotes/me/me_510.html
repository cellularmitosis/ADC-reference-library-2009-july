<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"            "http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note ME510: Memory Management Overview Q&amp;As</title><meta name="keywords" content="Mac OS 8 Memory Management Overview GrowZone SetCurrentA5 heap space"><meta name="Description" content="Technical Note ME510: This Technical Note contains a collectionof archived Q&amp;As relating to Memory Management Overview--questionssent the Developer Support Center (DSC) along with answersfrom the DSC engineers. Archived Q&amp;As include: Setting theCurrent Zone for Macintosh System Extensions; How to ensureenough system memory for a driver at boot time; When to useSetCurrentA5; Is Macintosh GrowZone reentrant? How to increaseHeap Space for a DA; Preloading and locking Macintosh codesegments.">                                       <meta name="categories" content="Memory"><meta name="week-posted" content="Oct 1, 1990 - Oct 5, 1990"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"><a name="//apple_ref/doc/uid/DTS10002541" title="Memory Management Overview Q&As"></a><a name="top"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/idxAppleHardware-date.html" target="_blank">Hardware & Drivers > Apple Hardware</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note ME510</div>
<div id="pageheadsub">Memory Management Overview Q&amp;As</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"> <A HREF="#Section1">Setting the Current Zone for Macintosh System Extensions</A><BR><BR><A HREF="#Section2">Macintosh disk drivers and memory allocation</A><BR><BR> <A HREF="#Section3">When to use SetCurrentA5</A><BR><BR> <A HREF="#Section4">Macintosh GrowZone routine is not reentrant</A><BR><BR> <A HREF="#Section5">Increasing heap space for Macintosh DAs</A><BR><BR> <A HREF="#Section6">Sharing data between Macintosh applications</A><BR><BR> <A HREF="#Section7">Preloading and locking Macintosh code segments</A><BR><BR> <A HREF="#Section8">Macintosh system heap limitations</A><BR><BR> <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">This Technical Note contains a collection of archived Q&amp;As relating to a specific topic--questions sent the Developer Support Center (DSC) along withanswers from the DSC engineers. Current Q&amp;As can be found on the <a href="../../qa/index.html">Macintosh Technical Q&amp;As web site</a>.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Oct 01 1990]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><a name="Section1"></a><h2>Setting the Current Zone for Macintosh System Extensions</h2><p>Date written:  1/15/92</p><p>Last reviewed:  6/14/93</p><p>Sometimes when my system extension (INIT) starts executing, the current zone is the system zone rather than the application zone. Should I call SetZone(ApplicZone) before allocating memory in the system extension?</p><p>___</p><p>The system does not set the zone to the application zone before loading eachsystem extension, so if a previous extension left the zone set to the systemzone, it's possible that an extension could unintentionally be loaded into thesystem heap and have the current zone be the system zone.</p><p>To ensure that nonpermanent memory requested by a system extension is allocatedin the application heap, do a <code>SetZone(ApplicZone)</code> before calling <code>NewHandle</code> or<code>NewPtr</code>. Any system extension that calls <code>SetZone</code> should restore the current zoneto what it was upon entry.</p><p>Any permanent memory allocation by a system extension should be made in thesystem heap with <code>NewPtrSys</code> or <code>NewHandleSys</code>. Use a <code>'sysz'</code> resource if the systemheap allocations will exceed 16K.</p><P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>Macintosh disk drivers and memory allocation</h2><p>Date written:  9/11/92</p><p>Last reviewed: 6/14/93</p><p>Our disk driver needs to allocate a large amount of space, and on some machinesthe amount of system heap space at boot is limited. What can we do to ensureenough system memory for our driver?</p><p>___</p><p>Drivers that require more than the default amount of heap space need to adjustthe size of the system heap directly. The following code is used by Apple'scurrent SCSI disk driver to increase the system heap at boot time. Thisadjustment should be as minimal in size as necessary. It works with 8K, butthere are upper limits. This code should be used in the driver's installroutine. It's important that the driver does this as the very first step, afterperforming the checksum on the driver code if you use one. This code will failafter boot time.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>; ---ONLY PERFORM THIS CODE AT BOOT TIME.---;; Bit 31 of d5 is 0 if we were booted by the ROM (in; which case we want to bump up the system heap size),; else it's set by the Installer (leave heap alone).;      tst.l    d5                   ; if Installer called us...      bmi.s    InstallDCE           ;   don't do anything else      move.l    SysZone,a0          ; get start of system heap      move.l    (a0),a0             ; get bkLim    add.w    #8000,a0 ; add about 8K      move.l    TheZone,-(sp)    ; save so it doesn't get trashed      _SetAppBase                ; (boot blocks can make a larger                                    ; system heap if they want to)      move.l    (sp)+,TheZone    ; fixes startup screen bug</pre>	</TD></TR></TABLE></CENTER><p>A SCSI driver being loaded will be passed D5 with the high byte clear, and thelow byte containing the SCSI ID. If the high byte is clear, it's a good betthat it's boot time. If your application is installing the driver, such as theformatter/installer utility, it should set the high bit of D5. When thedriver's loader code gets called, it will test D5 for this bit being set. Whenthis bit is set, you'll know not to perform the adjustment to the system heap.Or you can use the following method from the original sample SCSI driver:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>;Are we running at boot time? (we can tell this by looking to see if;SysEvtMask has been initted yet!)      TST.W    SysEvtMask ;are we running at boot time?      BNE.S    InitExit ;no, we're done.</pre>	</TD></TR></TABLE></CENTER><p>Additionally, if more memory is necessary the driver can set the <code>dNeedTime</code> bitin the <code>drvrFlags</code> field and wait for an <code>accRun</code> call at <code>SystemTask</code> time. Thiswould happen after the boot process was completed. At this time there may beenough system heap space to accommodate the driver's needs. MultiFinder andSystem 7.0 will increase the system heap if possible. Using this method, youshould be able to get the room you need in the system heap; you may simply needto do it in stages.</p><p>If an INIT is to install the driver, use the <code>'sysz'</code> resource to have the systemadjust the heap size for you. If an application is to install the driver, askfor the system space. MultiFinder will attempt to create space for it if therequested memory is not available. In any case, if the memory is not available,tell the user about the problem.</p><P><A HREF="#top">Back to top</A></P><a name="Section3"></a><h2>When to use SetCurrentA5</h2><p>Date written:  11/11/90</p><p>Last reviewed:  5/21/91</p><p>During a Macintosh application's life, does the value of A5 change? Why does<code>SetCurrentA5</code> have to set A5 to <code>CurrentA5</code>? Aren't A5 and CurrentA5 the samewhile an application is executing non-interrupt-time code?</p><p>___</p><p>A5 is not necessarily always equal to <code>CurrentA5</code>. Because the Macintoshoperating system and Toolbox don't need to access your application's jump tableor global variables (which A5 points to), they often use A5 for other purposes,except for the parts of the Toolbox that need to perform graphics operationsand use the QuickDraw globals defined by your application.</p><p>Because the operating system or Toolbox can change A5, you must make sure it'sset correctly if the operating system or Toolbox ever calls your code in theform of a callback. For example, if you make an asynchronous File Manager call,your I/O completion routine must call <code>SetCurrentA5</code> for your I/O completion routine. Other places where you may want to call <code>SetCurrentA5</code> are in trap patches, your <code>GrowZoneProc</code>, custom MDEFs, WDEFs, or CDEFs, or control action procedures.</p><p>Please note that even <code>SetCurrentA5</code> is not sufficient when writing code that'sexecuted at interrupt time, such as VBL and Time Manager tasks. When aninterrupt occurs that your application wants to handle, there is no guaranteethat the low-memory global <code>CurrentA5</code> belongs to your application. The interruptcould occur while some other application is running under <code>MultiFinderreg</code>. Inthis case, you should use other approaches to setting A5. Please see TechnicalNote #180, <u><A HREF = "../tb/tb_35.html">MultiFinder Miscellanea</a></u>, for further information.</p><P><A HREF="#top">Back to top</A></P><a name="Section4"></a><h2>Macintosh GrowZone routine is not reentrant</h2><p>Date written:  12/10/90</p><p>Last reviewed:  6/14/93</p><p>My Macintosh application receives information from the serial port, keeping asmuch information in memory as possible. However, if I do run out of memory, my<code>GrowZone</code> routine is allowed to delete older information. Does the operatingsystem allow the <code>GrowZone</code> routine to be called recursively? That is, if inhandling a <code>GrowZone</code> call, my code does something that requires memory, such asbringing in a font that isn't there, can I call the <code>GrowZone</code> routine again orwould doing so cause an error? Am I allowed to update things on the screen,such as windows and text in windows, while in my <code>GrowZone</code> routine?</p><p>___</p><p>Neither the <code>GrowZone</code> routine nor the Macintosh system is reentrant. There isvery little that you can safely do in a <code>GrowZone</code> routine. The system expectsthat the typical extent of a <code>GrowZone</code> routine is to check a table or some otherpredesignated criteria and then to release or not to release any memory blocksit can. Any sort of user interface is well beyond the reasonable scope of thislevel of routine, despite the information in <i>Inside Macintosh</i> VolumeII.</p><p>Keep a list of handles to blocks of text that you're willing to purge, so thatyour <code>GrowZone</code> routine can look through them when called and then release one ormore blocks. Any more than that is really stretching <code>GrowZone</code> too far.</p><p>By the way, <code>SetGrowZone</code> should not be assumed to return a result. <i>InsideMacintosh</i> is incorrect in saying that D0 contains a result code on exit.</p><P><A HREF="#top">Back to top</A></P><a name="Section5"></a><h2>Increasing heap space for Macintosh DAs</h2><p>Date Written:  3/12/91</p><p>Last reviewed:  6/14/93</p><p>I am writing a Macintosh desk accessory (DA) that opens large PICT files andmakes off-screen pixel maps for them. Is there a way for a DA to ask for morespace when it opens up, or should we be modern about this and make it anapplication instead of a DA?</p><p>___</p><p>A DA, like any application, can ask for available MultiFinder temporarymemory, as documented in Programmer's Guide to MultiFinder for running under System 6.0.x and in Inside Macintosh Volume VI for running under 7.0. You can also set the current heap to the system heap so that memory allocation will take place there until you set it back to the current heap. If you do this, you open up the can of worms of "how much space is left in the system heap?" Under Finder there's a fixed amount of space, set by the boot blocks. Under MultiFinder (and System 7.0) the system heap adjusts itself tokeep about 16K free, but if you allocate all 16K you will not know when it will resize larger or when the system might crash because all of its heap space hasbeen used up.</p><p>DAs, however, were never intended to use large amounts of memory. For all butthe most trivial (and small) functionality, it is better to implement as anapplication than as a DA, especially under System 7.0 where an application hasall the advantages of a DA with none of the restrictions.</p><P><A HREF="#top">Back to top</A></P><a name="Section6"></a><h2>Sharing data between Macintosh applications</h2><p>Date Written:  8/23/91</p><p>Last reviewed:  6/14/93</p><p>What are the preferred methods for sharing data between applications? I want touse the Program-to-Program Communications (PPC) stuff or Apple events to dynamically link libraries, but the size of the data blocks to be passed between the applications makes copying them around unacceptable. The best method would be to somehow share the data andremain compatible with future systems (presumably with memory protection). How is the system heap on handling large chunks of memory?</p><p>___</p><p>As you point out, there could be some memory protection someday, but at thistime there's no indication of how shared memory will be allowed under thesetighter rules.For the time being, if you are willing to pay the consequenceslater, then the following might help:</p><p>The 4 bytes of an address for a location in memory could be passed as data in aPPC data transfer, or Apple events could carry the information. Secondly, theGestalt mechanism could be used to pass an address between processes or tasks.For your problem this probably is better then the other forms of IPC.</p><p>The best thing to do is allocate a shared handle in the system heap. HLock theblock only when necessary. Remember, the system heap grows dynamically under System 7.0.</p><P><A HREF="#top">Back to top</A></P><a name="Section7"></a><h2>Preloading and locking Macintosh code segments</h2><p>Date Written:  6/8/92</p><p>Last reviewed:  9/15/92</p><p>What is the correct way to preload and lock all of a Macintosh program's segments?</p><p>___</p><p>The best way to preload and lock segments is to use the Resource Manager. Justset the Preload and Locked bits on the segment resources. This will cause allthese segments to be loaded contiguously, low in the heap. To avoidfragmentation, you should leave these segments loaded all the time; never call<code>UnloadSeg</code> for any of them. The resources get loaded in early, and their jumptable entries get converted the first time they are used. This is probablypreferable to just calling functions from all the segments to get them loadedin. If you are concerned about <code>LoadSeg</code> being called at run time, either forspeed reasons or because you want to avoid calling it at interrupt time, thenyou can mark them locked and preloaded (for heap management reasons), and callroutines in each of the segments to convert their jump table entries to the"loaded" state. You can mark the segments by adding the options "<code>-ra=resPreload,resLocked</code>" to your link command. If you only wanted to preload afew segments, you should generate multiple <code>-ra</code> commands, each for a differentsegments, such as "<code>-ra STDIO=resPreload,resLocked</code>."</p><p>An alternative is to put everything into one big segment using <code>-model</code> far. Inthis way you'll get good heap management and the jump table will all beinitialized at once. However, it's somewhat less flexible and you will incur asmall speed penalty if you use <code>-model</code> far; the choice is up to you.</p><P><A HREF="#top">Back to top</A></P><a name="Section8"></a><h2>Macintosh system heap limitations</h2><p>Date Written:  7/13/92</p><p>Last reviewed:  6/14/93</p><p>In System 7, the memory allocated for INITs by the <code>'sysz'</code> resource mechanismseems to be limited to about 16 MB on our 32 MB Macintosh IIfx. For 'sysz'values up to 15 MB it works great, but it seems the system heap can't growbeyond 16 MB. Is there some reason for this?</p><p>___</p><p>The system heap size at startup is limited to approximately half the size oftotal RAM. This is because the early startup code places the stack and someglobals in the middle of RAM so that the system heap can grow up from belowwhile <code>BufPtr</code> is lowered from above. This is basically the situation until anapplication is launched. Things are eventually rearranged so that the systemheap will have more room to grow, but this doesn't happen until the ProcessManager is launched, after INIT time. This limitation would mean that you couldsize your heap until it reached nearly (but not quite) half the size of RAM. Wesuggest that you attempt to allocate some of your RAM later, after the ProcessManager starts up; at that point, the system heap should be somewhat lesslimited.</p><P><A HREF="#top">Back to top</A></P>                           <P><A NAME=Downloads></A></P>                  <h2>Downloadables</h2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/me_510.pdf">Download</A></P>               </TD>            </TR>                     </TABLE>         <BR>                  <P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/me/me_510.html%3Fid%3DDTS10002541-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/me/me_510.html%3Fid%3DDTS10002541-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/me/me_510.html%3Fid%3DDTS10002541-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>