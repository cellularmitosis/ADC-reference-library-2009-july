<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"        "http://www.w3.org/TR/1998/REC-html40-19980424/loose.dtd"><HTML><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note HW22: Cooperating with the Coprocessor</title>                                       <meta name="categories" content="Hardware"><meta name="week-posted" content="May 29, 1989 - Jun 2, 1989"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"><a name="//apple_ref/doc/uid/DTS10002491" title="Cooperating with the Coprocessor"></a><a name="top"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/index.html" target="_blank">Reference Library > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note HW22</div>
<div id="pageheadsub">Cooperating with the Coprocessor</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->            <P id = "menutext"><A HREF="#Section1">Witnessing the Problem</A><BR><BR><A HREF="#Section2">Interrupting the Coprocessor</A><BR><BR><A HREF="#Section3">Handling Floating Point Exceptions</A><BR><BR><A HREF="#Section4">Other Issues</A><BR><BR><A HREF="#References">References</A><BR><BR><A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">The use of the 68881 or 68882 coprocessor is usually handled by the SANEpackage or by a development system's libraries.  Some developers may wish touse the coprocessor during special circumstances, such as at interrupt level orinstalling their own hardware floating point exception handlers.  In these twosituations, there are special requirements that must be met.  Theserequirements will require floating-point assembly code and are discussed inthis Technical Note.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Jun 01 1989]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR><!-- begin_content --><a name="Section1"></a><h2>Witnessing the Problem</h2><p>If you see the message "Spurious Interrupt of the Uninitialized Interruptvector" in MacsBug or the message "Unassigned Interrupt #$00D (format 9)" fromTMON, you should suspect a floating point protocolviolation.  This can be caused by improper usage of floating point instructionsat interrupt level or by attempting to handle hardware floating pointexceptions incorrectly.</p><P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>Interrupting the Coprocessor</h2><p>If you attempt to use the coprocessor at interrupt level, you may beinterrupting a floating point processor.  You must save the coprocessor's statebefore executing any floating point instructions, and, of course, restore itlater during the interrupt routine.  This requires assembly code since there isno convenient way to do it in a high-level language.</p><p>There is a protocol that must be followed.  The first floating pointinstruction must be an <code>FSAVE</code>.  This instruction suspends the executionof any operation in progress and saves the internal state.  The number of bytesrequired in this operation depends on the state it is in, and it can be up to216 bytes.  If any floating point registers are to be used, they also must besaved with the <code>FMOVE</code> instruction.  After performing the interruptroutine, the <code>FRESTORE</code> instruction is used to restore the floatingpoint state.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>VBLProc    FSAVE       -(SP)           ; save the FP state           FMOVEM.X    FPRegs,-(SP)    ; save the FP regs we use           ...           ...                           ; your interrupt code           ...VBLExit    FMOVEM.X    (SP)+,FPRegs    ; replace the FP regs we used           FRESTORE    (SP)+           ; restore the FP state           RTS</pre>	</TD></TR></TABLE></CENTER><p>Note that the coprocessor may not be in a condition to be interrupted, and the<code>FSAVE</code> instruction will halt the main processor until such a conditioncan be met.  To give an idea on the time required for saving the coprocessor'sstate, the <code>FSAVE</code> or <code>FRESTORE</code> instructions can takeapproximately 900 cycles to execute.  This is about 50 times slower than a<code>MOVE</code> instruction.  Considering the length of time it takes to performthis necessary protocol, it may not be desirable to use floating-point math atinterrupt level.  As an alternative, investigate the possibility of using theToolbox routines for <code>Fixed</code> and <code>Frac</code> numbers.</p><P><A HREF="#top">Back to top</A></P><a name="Section3"></a><h2>Handling Floating Point Exceptions</h2><p>It is possible, and sometimes desirable, for applications to install their ownhardware floating-point exception handlers.  The MPW '881 SANE librariesprovide routines for applications to do so.  If an application is going to usethis mechanism to catch exceptions such as underflow, overflow, or divide byzero, then it must follow the minimal protocol as shown in the followingexample.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>Handler    FSAVE       -(SP)           ; save the FP state           MOVE.B      (SP),D0         ; first byte of the state frame           BEQ         NULL            ; branch if NULL state           CLR.L       D0              ; clear data register           MOVE.B      1(SP),D0        ; load state frame size           BSET        #3,(SP,D0)      ; set bit 27 or BIU           ...           ...                           ; your exception code           ...Null       FRESTORE    (SP)+           ; restore the FP state           RTE                         ; return from exception</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="Section4"></a><h2>Other Issues</h2><p>Debugging floating-point routines with MacsBug, SADE, and TMON may cause aprotocol violation.  MacsBug 6.1, and earlier, do not perform the<code>FSAVE</code> and <code>FRESTORE</code> surrounding floating-point instructions atinterrupt level.  As of TMON 2.8.4, it has not handled floating-pointinstructions.  Hardware floating-point exception handlers and interruptroutines using floating-point instructions require assembly coding.</p><p>You can witness a protocol violation in another situation.  This is when usingthe Sound Manager in System Software 6.0.5 and earlier.  This Sound Managercalls SANE at interrupt time.  If an application is using the coprocessor<b>and</b> this Sound Manager is running, it is very likely to interrupt thecoprocessor.  This problem has been resolved in the new Sound Manager, whichwas originally released in System Software 6.0.6.  The new Sound Manager nolonger uses floating-point numbers at interrupt level; it replaces them with<code>Fixed</code> and <code>Fract</code> types.</p><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><P>Apple Numerics Manual, Second Edition</p><P>Motorola MC68881/MC68882 User's Manual</p><P>MPW reference manuals</p><P>Technical Note M.PT.MPWmc68881, <A HREF = "../pt/pt_25.html">Notes on MPW's -mc68881 Option</a></p><P>Technical Note M.HW.SpeedyMathCoProc, <A HREF = "hw_32.html">Speedy the Math Coprocessor</a></p><P>TMON is a trademark of ICOM Simulations, Inc.</p><P><A HREF="#top">Back to top</A></P><P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (52K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/hw_22.pdf">Download</A></P>               </TD>            </TR></table><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/hw/hw_22.html%3Fid%3DDTS10002491-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/hw/hw_22.html%3Fid%3DDTS10002491-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/hw/hw_22.html%3Fid%3DDTS10002491-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>