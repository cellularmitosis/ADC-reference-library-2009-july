<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Using SoundSprocket (GameSprockets)</TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000" ="A" NAME="HEADING12"></A>



<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="GameSprockets-11.html"><IMG ALIGN="BOTTOM" SRC="prev.gif" BORDER="none" HSPACE="20" ALT="Previous"></A> <A HREF="GameSprockets-2.html"><IMG ALIGN="BOTTOM" SRC="content.gif" BORDER="none" HSPACE="20" ALT="Book Contents"></A> <A HREF="GameSprockets-318.html"><IMG ALIGN="BOTTOM" SRC="index.gif" BORDER="none" HSPACE="20" ALT="Book Index"></A> <A HREF="GameSprockets-13.html"><IMG ALIGN="BOTTOM" SRC="next.gif" BORDER="none" HSPACE="20" ALT="Next"></A> </CENTER><P>
<FONT SIZE="-1"><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="GameSprockets-2.html"><B>Apple Game Sprockets Guide</B></A> / <BR><DD><A HREF="GameSprockets-10.html"><B>Chapter 1 - SoundSprocket</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME="HEADING12-0"></A>
<H1><A NAME="MARKER-9-35"></A>Using SoundSprocket</H1>
 To use SoundSprocket in a game, you need to create a listener and one or more sound sources. Localized sounds are played through normal sound channels, into which the localization component has been installed, as illustrated in <A HREF="GameSprockets-11.html#MARKER-9-6">Figure 1-1 (page 1-6)</A>. Then, while the game is under way, you should play the appropriate sounds, change the positions, orientations, and velocities of the sources and the listener as appropriate, and then call <CODE>SndSetInfo</CODE> to update the 3D sound filtering characteristics. To achieve a sense of continuous motion, you should update the filter characteristics at least several times per second. This section shows how to accomplish these tasks.<P>
<DL>
<DT><B>Note</B>
<DD>The code examples shown in this section provide only rudimentary error handling. <EM></EM>  <IMG ALIGN="BOTTOM" SRC="graphics/triangle.gif">
</DL>
 You need to explicitly create listeners and sound sources only when you use the high-level interfaces provided by SoundSprocket. You can, if you prefer, maintain the data for a sound source yourself and then use the low-level interfaces to send messages to the localization component. See <A HREF="#MARKER-9-58">"Using the Low-Level Interfaces" (page 1-20)</A> for further information.<P>
<A NAME="HEADING12-4"></A>
<H2>Configuring Sound Output Devices<A NAME="MARKER-2-36"></A></H2>
 Your game should provide a 3D sound configuration dialog box that allows the user to select from stereo or monophonic speakers, or headphones. If the user is using stereo speakers, you should provide a method to set the angle between the speakers. The game may provide this functionality directly, using the <CODE>siSSpSetup</CODE> constant, or you can use the <CODE>SSpConfigureSetup</CODE> function to display a modal dialog that allows the user to control the features. Using <CODE>SSpConfigureSetup</CODE> is recommended, because this allows Apple to change the contents of the dialog as the setup information evolves.<P>
<DL>
<DT><B>Note</B>
<DD>These controls may be incorporated into a control panel in a future system software release. <EM></EM>  <IMG ALIGN="BOTTOM" SRC="graphics/triangle.gif">
</DL>
 <CODE>SSpConfigureSetup</CODE> displays the modal dialog shown below that allows the user to view and alter the speaker configuration settings. It creates a sound channel, installs the filter, and alters the setup for all filters when the user adjusts the controls.<P>
 A sound effect is played while the user is adjusting the speaker angle slider. The slider in the 3D sound configuration dialog box should be adjusted so that the alternating sound effects appear to be as far to left and right of the user as possible. The game should not be playing any sounds when this function is called because it will interfere with the user's ability to adjust the slider for optimal sound enjoyment.<P>
<B>Figure 1-6  Controlling sound output devices</B><P>
<IMG ALIGN="BOTTOM" SRC="graphics/SS-06.jpg">
<A NAME="HEADING12-11"></A>
<H2>Installing the Localization Component</H2>
 <A NAME="MARKER-11-138"></A>A localization component is a sound output component that provides 3D filtering for the sounds passed to it. You need to install an instance of the localization component into each sound channel for which you want SoundSprocket to produce 3D filtering. <A HREF="#MARKER-9-39">Listing 1-1</A> illustrates how to create a sound channel and install an instance of the localization component in it.<P>
<B>Listing 1-1  <A NAME="MARKER-9-39"></A>Creating a localized sound channel</B><P>
<PRE>
SndChannelPtr MyCreateLocalizedChannel (void)
{
   SndChannelPtr  mySndChannel = nil;
   OSStatus       myErr;
   SoundComponentLinkmyLink;

   /* create a new sound channel */
   myErr = SndNewChannel(mySndChannel, sampledSynth, initMono, nil);
   if (myErr != noErr) {
      return(nil);
   }

   /* define the type of the localization component */
   myLink.description.componentType = kSoundEffectsType;
   myLink.description.componentSubType = kSSpLocalizationSubType;
   myLink.description.componentManufacturer = 0;
   myLink.description.componentFlags = 0;
   myLink.description.componentFlagsMask = 0;
   myLink.mixerID = nil;
   myLink.linkID = nil;

   /* install the localization component BEFORE the Apple Mixer */
   myErr = SndSetInfo(mySndChannel, siPreMixerSoundComponent, &amp;myLink);
   if (myErr != noErr) {
      return(nil);
   } else {
      return(mySndChannel);
   }
}
</PRE>
 As you can see, the <CODE>MyCreateLocalizedChannel</CODE> function defined in <A HREF="#MARKER-9-39">Listing 1-1</A> calls <CODE>SndNewChannel</CODE> to create a new sound channel. If successful, it fills in the fields of a sound component link structure to specify the type of component to be installed. The localization component is of type <CODE>kSoundEffectsType</CODE> and subtype <CODE>kSSpLocalizationSubType</CODE>. Finally, <CODE>MyCreateLocalizedChannel</CODE> calls the <CODE>SndSetInfo</CODE> function to install the specified component before the Apple Mixer in the sound channel's component chain. If <CODE>SndSetInfo</CODE> completes successfully, <CODE>MyCreateLocalizedChannel</CODE> returns the sound channel pointer to the caller.<A NAME="MARKER-2-40"></A><A NAME="MARKER-2-42"></A><P>
<A NAME="HEADING12-16"></A>
<H2>Controlling Filters<A NAME="MARKER-2-43"></A></H2>
 <A NAME="MARKER-2-44"></A>SoundSprocket filters are controlled by the <CODE>SndSetInfo</CODE> function. The selectors you use to control them are <CODE>siSSpFilterVersion</CODE>, <CODE>siSSpCPULoadLimit</CODE>, <CODE>siSSpSetup</CODE> and <CODE>siSSpLocalization</CODE>. <P>
<A NAME="HEADING12-18"></A>
<H3>Accessing Version Information</H3>
 To retrieve the version of the sound localization filter that is currently installed, call <CODE>SndGetInfo</CODE>, as in this example:<P>
<PRE>
SSpFilterVersionData filterVersion;
err = SndGetInfo(sndChannel, siSSpFilterVersion, &amp;filterVersion);
if (err != noErr) ...
</PRE>
 You can use the filterVersion parameter to insure that the installed version of the sound filter is compatible with your game.<P>
<A NAME="HEADING12-22"></A>
<H3>Changing Localization Parameters</H3>
 To change the characteristics of the 3D filtering on a given sound channel, call <CODE>SndSetInfo</CODE> with the <CODE>siSSpLocalization</CODE> selector and the address of an <CODE>SSpLocalizationData</CODE> data structure. The changes will take effect almost immediately.<P>
<PRE>
SSpLocalizationData localization;
err = SndGetInfo(sndChannel, siSSpLocalization, &amp;localization);
if (err != noErr) ...

localization.currentLocation.distance = 5;
err = SndSetInfo(sndChannel, siSSpLocalization, &amp;localization);
if (err != noErr) ...
</PRE>
<DL>
<DT><B>Note</B>
<DD>In future versions of SoundSprocket, the values of some fields may affect all localized sound channels. These fields may include <CODE>medium</CODE>, <CODE>humidity</CODE>, <CODE>roomSize</CODE>, <CODE>roomReflectivity</CODE> and <CODE>reverbAttenuation</CODE>. This would occur if the implementation used a post-mix filter to implement these features. In this case, the most recent values sent to any sound channel will affect all sound channels. As a precaution, the application should not vary these values between sound channels. <EM></EM>  <IMG ALIGN="BOTTOM" SRC="graphics/triangle.gif">
</DL>
 Calling <CODE>SndGetInfo</CODE> for <CODE>siSSpLocalization</CODE> returns the filter parameters that are currently in effect. For most fields, this is what was most recently set for this channel. For fields that are shared between sound channels, the most recent value that was set for any channel is returned.<P>
<A NAME="HEADING12-27"></A>
<H3>Determining CPU Load Steps</H3>
 To determine the number of CPU load steps that the localization algorithms support, you can call <CODE>SndGetInfo</CODE> this way:<P>
<PRE>
UInt32 cpuLoadLimit;
err = SndGetInfo(sndChannel, siSSpCPULoadLimit, &amp;cpuLoadLimit);
if (err != noErr) ...
</PRE>
 This is the maximum value that is defined for the <CODE>cpuLoad</CODE> field of <CODE>SSpLocalizationData</CODE>.<P>
<A NAME="HEADING12-31"></A>
<H3>Changing Speaker Configurations</H3>
 <A NAME="MARKER-2-45"></A>To change the speaker configuration, call <CODE>SndSetInfo</CODE> with the selector <CODE>siSSpSetup</CODE> and the <CODE>SSpSetupData</CODE> data structure on a sound channel that has the 3D sound filters installed. <P>
<PRE>
SSpSetupData setup;
setup.speakerKind = kSSpSpeakerKind_Headphones;
setup.speakerAngle = 0;
setup.reserved0 = 0;
setup.reserved1 = 0;
err = SndSetInfo(sndChannel, siSSpSetup, &amp;setup);
if (err != noErr) ...
</PRE>
 Calling <CODE>SndGetInfo</CODE> for <CODE>siSSpSetup</CODE> returns the current speaker configuration. The speaker configuration of all sound channels is affected by sending this message to any channel that has the component installed. The information is retained even when the system is restarted.<A NAME="MARKER-2-46"></A><P>
<A NAME="HEADING12-35"></A>
<H2>Creating Listeners and Sound Sources<A NAME="MARKER-2-47"></A></H2>
 <A NAME="MARKER-2-48"></A>The virtual audio environment managed by SoundSprocket includes a single listener and one or more sound sources. You create a listener by calling the <CODE>SSpListener_New</CODE> function. <A HREF="#MARKER-9-49">Listing 1-2</A> shows how to create a listener and set the listener unit of measurement to feet.<P>
<B>Listing 1-2  <A NAME="MARKER-9-49"></A>Creating a listener</B><P>
<PRE>
static SSpListenerReferencegListener = nil;

void My3DSoundInit (void)
{
   OSStatus    myStatus;

   myStatus = SSpListener_New(&amp;gListener);
   if (myStatus == noErr) {
      SSpListener_SetMetersPerUnit(gListener, 0.3048);
   }
}
</PRE>
 <A NAME="MARKER-2-50"></A>To create a sound source, you can call the <CODE>SSpSource_New</CODE> function, as shown in <A HREF="#MARKER-9-51">Listing 1-3</A>. <P>
<B>Listing 1-3  <A NAME="MARKER-9-51"></A>Creating a sound source</B><P>
<PRE>
SSpSourceReference MyCreateSource (void)
{
   SSpSourceReferencemySource = nil;
   OSStatus    myStatus;

   myStatus = SSpSource_New(&amp;mySource);
   return(mySource);
}
</PRE>
 It's your responsibility to keep track of which sound sources are associated with which sound channels. A game that allows two sound sources might keep track of them in a pair of arrays accessed using global variables, as illustrated in <A HREF="#MARKER-9-52">Listing 1-4</A>.<P>
<B>Listing 1-4  <A NAME="MARKER-9-52"></A>Setting up a two-source audio environment</B><P>
<PRE>
SSpSourceReferencegSources[2];
SndChannelPtr     gChannels[2];

void MyInitSources (void)
{
   gSources[0] = MyCreateSource();     /* see Listing 1-3 */
   gSources[1] = MyCreateSource();

   gChannels[0] = MyCreateLocalizedChannel();/* see Listing 1-1 */
   gChannels[1] = MyCreateLocalizedChannel();
}
</PRE>
<A NAME="HEADING12-45"></A>
<H2>Updating the Virtual Audio Environment<A NAME="MARKER-2-53"></A></H2>
 <A NAME="MARKER-2-54"></A>Once you've created a listener and one or more localized sound sources, you're ready to play localized sounds. To do this, you need to specify the characteristics of each sound source (position, orientation, velocity, and so forth), call <CODE>SndSetInfo</CODE> to pass that information to the localization component, and start a sound playing in the associated sound channel. Thereafter, you can change the 3D characteristics as desired and call <CODE>SndSetInfo</CODE> to achieve a sense of motion. <A HREF="#MARKER-9-55">Listing 1-5</A> illustrates a simple way to move a sound source from right to left.<P>
<B>Listing 1-5  <A NAME="MARKER-9-55"></A>Panning a sound source from right to left</B><P>
<PRE>
OSStatus MyPanSoundFromRightToLeft (Handle mySndResource)
{
   OSStatus    myStatus;
   TQ3Point3D  myPoint;
   SSpLocalizationDatamyLocalization;
   float       myZPos;        /* z coord. of sound source */
   long        myTicks;       /* for Delay */

   /* start playing a sound */
   myStatus = SndPlay(gChannels[0], mySndResource, true);
   if (myStatus != noErr)
      return(myStatus);

   /* slowly move source from listener's right to left */
   for (myZPos = 1.0; myZPos &gt;= -1.0; myZPos -= 0.1) {

      /* set position of source */
      Q3Point3D_Set(myPoint, 1, 0, myZPos);
      SSpSource_SetPosition(gSources[0], myPoint);

      / *retrieve updated info - send it to localization component */
      SSpSource_CalcLocalization(gSources[0], gListener,
         &amp;myLocalization);
      SndSetInfo(gChannels[0], siSSpLocalization, &amp;mymyLocalization);
      Delay(2, &amp;myTicks);
   }
}
</PRE>
 This sample code produces a sound that moves from left to right, on a line perpendicular to the front of the user. This has the effect of modulating the volume as well as a Doppler effect, increasing the volume as the sound approaches the center and decreasing the volume as the sound moves away to the right.<P>
 The <CODE>MyPanSoundFromRightToLeft</CODE> function defined in <A HREF="#MARKER-9-55">Listing 1-5</A> takes as a parameter a handle to a sound resource. It starts playing the resource using the <CODE>SndPlay</CODE> function. Then <CODE>MyPanSoundFromRightToLeft</CODE> sets the initial position of the sound source and updates the virtual audio environment by calling <CODE>SSpSource_CalcLocalization</CODE> and <CODE>SndSetInfo</CODE>. By default, the listener is at the origin looking straight down the positive <I>x</I> axis. Accordingly, placing the sound source at the point (1, 0, 1) makes it appear ahead and to the right of the listener. Finally, <CODE>MyPanSoundFromRightToLeft</CODE> gradually moves the sound source along the line <I>x</I> = 1 until it reaches the point (1, 0, -1), updating the audio environment after each position change.<A NAME="MARKER-2-56"></A><A NAME="MARKER-2-57"></A><P>
<A NAME="HEADING12-51"></A>
<H2><A NAME="MARKER-9-58"></A>Using the Low-Level Interfaces<A NAME="MARKER-2-59"></A></H2>
 As you've seen in the preceding two sections, you use the high-level functions provided by SoundSprocket to create listeners and sound sources and to manipulate the data associated with those objects. However, you can (if you prefer) maintain the listener and source data yourself and send commands directly to the localization component using the Sound Manager's <CODE>SndSetInfo</CODE> function. To specify the data, you need to use the <CODE>SSpLocalizationData</CODE> data structure <A HREF="GameSprockets-26.html#MARKER-9-119">(page 1-30)</A>.<P>
<DL>
<DT><B>Note</B>
<DD>The distinction between using SoundSprocket's high-level interfaces and its low-level interfaces is similar to the distinction between using QuickDraw 3D's retained rendering mode and its immediate rendering mode.<EM></EM>  <IMG ALIGN="BOTTOM" SRC="graphics/triangle.gif">
</DL>
 <A HREF="#MARKER-9-61">Listing 1-6</A> shows how to pan a sound from right to left using the low-level SoundSprocket interfaces.<A NAME="MARKER-2-60"></A><P>
<B>Listing 1-6  <A NAME="MARKER-9-61"></A>Panning a sound source from right to left</B><P>
<PRE>
OSStatus MyLowLevelPanSoundFromRightToLeft (Handle mySndResource)
{
   OSStatus    myStatus;
   SSpLocalizationData
               myLocalization;
   float       myAngle;
   long        myTicks;       /* for Delay */

   /* start playing a sound */
   myStatus = SndPlay(gChannels[0], mySndResource, true);
   if (myStatus != noErr)
      return(myStatus);

   myLocalization.medium = kSSpMedium_Air;
   myLocalization.humidity = 0;
   myLocalization.roomSize = 0;
   myLocalization.roomReflectivity = -1;
   myLocalization.reverbAttenuation = 0;
   myLocalization.sourceMode = kSSpSourceMode_Localized;
   myLocalization.referenceDistance = 1;
   myLocalization.coneAngleCos = 0;
   myLocalization.coneAttenuation = 0;
   myLocalization.currentLocation.elevation = 0;
   myLocalization.currentLocation.azimuth = 0;
   myLocalization.currentLocation.distance = 1;
   myLocalization.currentLocation.projectionAngle = 1;
   myLocalization.currentLocation.sourceVelocity = 0;
   myLocalization.currentLocation.listenerVelocity = 0;
   myLocalization.reserved0 = 0;
   myLocalization.reserved1 = 0;
   myLocalization.reserved2 = 0;
   myLocalization.reserved3 = 0;
   myLocalization.virtualSourceCount = 0;

   /* slowly move source from listener's right to left */
   for (myAngle = 3.14; myAngle &gt;= -3.14; myAngle -= 0.1) {
      myLocalization.currentLocation.azimuth = myAngle;
      SndSetInfo(gChannels[0], siSSpLocalization, &amp;myLocalization);
      Delay(2, &amp;myTicks);
   }
}
</PRE>
 Unlike the high-level code sample in <A HREF="#MARKER-9-55">Listing 1-5</A>, this code sample causes the sound to move from right to left in a semi-circle about the listener. Because the distance is constant, there is no amplitude change or Doppler effect in this sample.<A NAME="MARKER-2-62"></A><P>

</BLOCKQUOTE>
<HR>
<CENTER>
<A HREF="GameSprockets-11.html"><IMG ALIGN="BOTTOM" SRC="prev.gif" BORDER="none" HSPACE="20" ALT="Previous"></A> <A HREF="GameSprockets-2.html"><IMG ALIGN="BOTTOM" SRC="content.gif" BORDER="none" HSPACE="20" ALT="Book Contents"></A> <A HREF="GameSprockets-318.html"><IMG ALIGN="BOTTOM" SRC="index.gif" BORDER="none" HSPACE="20" ALT="Book Index"></A> <A HREF="GameSprockets-13.html"><IMG ALIGN="BOTTOM" SRC="next.gif" BORDER="none" HSPACE="20" ALT="Next"></A> </CENTER><P>
<CENTER><FONT SIZE="-1"><A HREF="GameSprockets-3.html">&copy; Apple Computer, Inc.</A><BR>2 JUL 1996</CENTER></FONT><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML> 
