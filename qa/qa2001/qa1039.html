<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"            "http://www.w3.org/TR/REC-html40/loose.dtd"><html>    <head>        <meta http-equiv="content-type" content="text/html;charset=iso-8859-1">        <meta name="generator" content="Adobe GoLive 4">        <title>Technical Q&amp;A QA1039: Fixing NSDocumentController to understand HFS file types</title>        <meta name="keywords" content="NSDocument Cocoa nsdocument NSDocumentController nsdocumentcontroller HFS">        <meta name="Description" content="Technical Q&amp;A QA1039: NSDocumentController in Mac OS X 10.0is supposed to properly handle HFS file types, per the AppKitRelease Notes. This support is broken, however, in Mac OSX 10.0, and this Q&amp;A provides source code to fix it.">        <link rel="stylesheet" href="../../adcstyle.css" type="text/css">        <link rel="stylesheet" href="../../style.css" type="text/css">    <meta name="categories" content="Cocoa"><meta name="week-posted" content="Jun 18, 2001 - Jun 22, 2001"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></head>    <body bgcolor="white"><a name="//apple_ref/doc/uid/DTS10001591" title="Fixing NSDocumentController to understand HFS file types"></a>        <!-- top_of_header_marker_comment -->        <!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalqas/LegacyTechnologies/idxCocoa-date.html">Cocoa</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/Cocoa/idxFileManagement-date.html" target="_blank">Cocoa > File Management</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information -->        <!-- bottom_of_header_marker_comment -->        <!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A QA1039</div>
<div id="pageheadsub">Fixing NSDocumentController to understand HFS file types</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment -->        <center>            <p>            <table border="0" cellspacing="1" width="600">                <tr>                    <td align="left" scope="row"><!-- begin_content -->                        <hr width=500 align=center><p id="p2">Q: The AppKit release notes for Mac&nbsp;OS&nbsp;X&nbsp;10.0 say that <CODE>NSDocumentController</CODE> methods like <BR> <CODE>-fileExtensionsFromType:</CODE> now support HFS file types. But my <CODE>NSDocument</CODE>-based application doesn't seem to provide this functionality - is this functionality broken in AppKit?</p><p id="p4">A: Yes, it is broken in Mac&nbsp;OS&nbsp;X 10.0. At the time of the release of Mac&nbsp;OS&nbsp;X, version 10.0, the Mac&nbsp;OS&nbsp;X Cocoa AppKit Release Notes claimed that:</p><BLOCKQUOTE><CODE>NSDocumentController</CODE>'s <CODE>-fileExtensionsFromType:</CODE> now returns an array of file type strings that may contain encoded HFS file types as well as file name extensions. <CODE>-runModalOpenPanel:forTypes:</CODE> and<BR> <CODE>-typeFromFileExtension:</CODE> behave as they always have, but will now accept file type strings that contain encoded HFS file types as well as file name extensions. <CODE>-openDocumentWithContentsOfFile:display:</CODE> and <BR><CODE>-openDocumentWithContentsOfURL:display:</CODE> now take the HFS file type of files into consideration when deciding what subclass of <CODE>NSDocument</CODE> should be instantiated.</BLOCKQUOTE>                        <p id="p4">This was not true. None of the NSDocumentController methods named in the release note, except for <BR> <CODE>-runModalOpenPanel:forTypes:</CODE>, handle HFS file types correctly (the rest of the release notes dealing with HFS file types are accurate). </p>                        <p id="p4">This discrepancy between Cocoa's implementation and the current documentation has been recorded as bug in Apple's bug tracking database (r. 2571388) and will be provided in afuture release of Mac OS.</p>                        <p id="p4">To fix this problem, on a per-application basis, add this source code to your application's project, and arrange for <CODE>NSDocumentControllerPatchFor2571388InstallIfNecessary</CODE> to be called during your application's startup. Adding a call to your application's <CODE>main</CODE> function, before the standard call to <CODE>NSApplicationMain</CODE>, should work fine.  When running in a version of Mac OS where the fix is not available, this routine will automatically install the substitution for <CODE>NSDocumentController</CODE> defined in this file.<br>                        </p>                        <center>                            <p>                            <table border="0" cellpadding="4" width="550">                                <tr>                                    <td bgcolor="#e6e6e6" align=left>                                        <pre>/* NSDocumentControllerPatchFor2571388.mCopyright (c) 2001, Apple Computer, Inc.  All rights reserved.At the time of the release of Mac OS X, version 10.0, the Mac OS XCocoa AppKit Release Notes at&lt;http://developer.apple.com/documentation/ReleaseNotes/AppKit.html&gt;claimed that:&quot;NSDocumentController's -fileExtensionsFromType: now returns anarray of file type strings that may contain encoded HFS file types aswell as file name extensions.-runModalOpenPanel:forTypes: and -typeFromFileExtension: behave as theyalways have, but will now accept file type strings that contain encodedHFS file types as well as file name extensions.-openDocumentWithContentsOfFile:display: and-openDocumentWithContentsOfURL:display: now take the HFS file type offiles into consideration when deciding what subclass of NSDocumentshould be instantiated.&quot;This was not true.  None of the NSDocumentController methods named inthe release note, except for -runModalOpenPanel:forTypes:, handle HFSfile types correctly.  (The rest of the release notes dealing with HFSfile types are accurate.)This descrepancy between Cocoa's implementation and the currentdocumentation has been recorded as bug in Apple's bug trackingdatabase (r. 2571388) and will be provided in a future release ofMac OS.To fix this problem, on a per-application basis, add this sourcecode to your application's project, and arrange forNSDocumentControllerPatchFor2571388InstallIfNecessary to be calledduring your application's startup. Adding a call to yourapplication's main function, before the standard call toNSApplicationMain, should work fine.  When running in aversion of Mac OS where the fix is not available, thisroutine will automatically install the substitution forNSDocumentController defined in this file.IMPORTANT:  This Apple software is supplied to you by Apple Computer,Inc. (&quot;Apple&quot;) in consideration of your agreement to thefollowing terms, and your use, installation, modification or redistributionof this Apple software constitutes acceptance of these terms.  If you donot agree with these terms, please do not use, install, modify orredistribute this Apple software.  In consideration of your agreement toabide by the following terms, and subject to these terms, Apple grants youa personal, non-exclusive license, under Apple&#130;s copyrights inthis original Apple software (the &quot;Apple Software&quot;), to use,reproduce, modify and redistribute the Apple Software, with or withoutmodifications, in source and/or binary forms; provided that if youredistribute the Apple Software in its entirety and without modifications,you must retain this notice and the following text and disclaimers in allsuch redistributions of the Apple Software.  Neither the name,trademarks, service marks or logos of Apple Computer, Inc. may be usedto endorse or promote products derived from the Apple Software withoutspecific prior written permission from Apple.  Except as expresslystated in this notice, no other rights or licenses, express or implied,are granted by Apple herein, including but not limited to any patentrights that may be infringed by your derivative works or by other worksin which the Apple Software may be incorporated.The Apple Software is provided by Apple on an &quot;AS IS&quot; basis.APPLE MAKES NO WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WITHOUTLIMITATION THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITYAND FITNESS FOR A PARTICULAR PURPOSE, REGARDING THE APPLESOFTWARE OR ITS USE AND OPERATION ALONE OR IN COMBINATION WITH YOURPRODUCTS.  IN NO EVENT SHALL APPLE BE LIABLE FOR ANY SPECIAL, INDIRECT,INCIDENTAL OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;OR BUSINESS INTERRUPTION) ARISING IN ANY WAY OUT OF THE USE, REPRODUCTION,MODIFICATION AND/OR DISTRIBUTION OF THE APPLE SOFTWARE, HOWEVER CAUSED ANDWHETHER UNDER THEORY OF CONTRACT, TORT (INCLUDING NEGLIGENCE), STRICTLIABILITY OR OTHERWISE, EVEN IF APPLE HAS BEEN ADVISED OF THE POSSIBILITYOF SUCH DAMAGE.*/#import &lt;Cocoa/Cocoa.h&gt;extern double NSAppKitVersionNumber;@interface NSDocumentControllerPatchedFor2571388 : NSDocumentController@end@implementation NSDocumentControllerPatchedFor2571388// Reimplement a method that is invoked by both -fileExtensionsFromType:// and -typeFromFileExtension:, effectively fixing them both.// Warning: Even though this method appears in this patch file, don't// consider it public.  Do not make assumptions about when this method// will be invoked.  It may not be invoked at all in versions of AppKit in// which 2571388 is fixed.- (NSArray *)extensionsFromTypeDict:(NSDictionary *)inDocumentTypeInfo {    NSArray *extensions;    NSArray *osTypes;    NSArray *extensionsAndHFSTypes;    // Get the array that contains the file name extensions that are    // allowable for the document type.    extensions = [inDocumentTypeInfo                  objectForKey:@&quot;CFBundleTypeExtensions&quot;];    // Add entries for HFS file types if the passed-in dictionary has a    // CFBundleTypeOSTypes entry.    osTypes = [inDocumentTypeInfo               objectForKey:@&quot;CFBundleTypeOSTypes&quot;];    if (osTypes) {        // For each entry in the CFBundleTypeOSTypes array, wrap what        // should be a four-character string with apostrophes.        int osTypeIndex;        int osTypeCount = [osTypes count];        NSMutableArray *hfsTypes = [NSMutableArray                                    arrayWithCapacity:osTypeCount];        for (osTypeIndex = 0; osTypeIndex&lt;osTypeCount; osTypeIndex++) {            NSString *osTypeAsFourCharString = [osTypes                                                objectAtIndex:osTypeIndex];            NSString *hfsType = [NSString                                 stringWithFormat:@&quot;\'%@\'&quot;,                                 osTypeAsFourCharString];            [hfsTypes addObject:hfsType];        }        // Add the array of HFS file types to the array being returned.        extensionsAndHFSTypes = extensions ?             [extensions arrayByAddingObjectsFromArray:hfsTypes] : hfsTypes;    } else {        // There are no HFS file types associated with this document file        // type.  Just return the file name extensions, if there are any.        extensionsAndHFSTypes = extensions;    }    // Done.    return extensionsAndHFSTypes;}// Reimplement -openDocumentWithContentsOfFile:display: so that it no// longer suffers from 2571388.- (id)openDocumentWithContentsOfFile:(NSString *)inDocumentFilePath                                            display:(BOOL)inDisplayDocument {    // Try to open the document, using the already-existing Cocoa code,    // which determines document type from file name extension.    NSDocument *document = [super                            openDocumentWithContentsOfFile:inDocumentFilePath                            display:inDisplayDocument];    // If that didn't work, try another way.    if (!document &amp;&amp; [[NSFileManager defaultManager]                              fileExistsAtPath:inDocumentFilePath]) {        // Try to figure out what kind of document we're opening, based on        // the HFS file type.    NSString *hfsFileType = NSHFSTypeOfFile(inDocumentFilePath);    NSString *documentTypeName = [self typeFromFileExtension:hfsFileType];        // If we were successful in determining the document type, try to        // open the document.        if (documentTypeName) {            document = [self                        makeDocumentWithContentsOfFile:inDocumentFilePath                        ofType:documentTypeName];            if (document) {                [self addDocument:document];                if ([self shouldCreateUI]) {                    [document makeWindowControllers];                    if (inDisplayDocument) {                        [document showWindows];                    }                }            }        }    }    // Successful or not, done.    return document;}// Reimplement -openDocumentWithContentsOfURL:display: so that it no// longer suffers from 2571388.- (id)openDocumentWithContentsOfURL:(NSURL *)inDocumentURL                                     display:(BOOL)inDisplayDocument {    NSDocument *document = nil;    if ([inDocumentURL isFileURL]) {        NSString *documentPath = [inDocumentURL path];        document = [self openDocumentWithContentsOfFile:documentPath                    display:inDisplayDocument];    }    return document;}@endvoid NSDocumentControllerPatchFor2571388InstallIfNecessary(void) {    // If the current version of AppKit is earlier than the first one in    // which 2571388 is known to be fixed, replace the    // NSDocumentController class with    // NSDocumentControllerPatchedFor2571388.    // Warning: The AppKit version for Mac OS 10.0, 10.0.1, 10.0.2, and    // 10.0.3 is 577.0.  It's not safe however to test    // NSAppKitVersionNumber&gt;577.0, because Apple may or may not    // release a product in which AppKit's version number is greater than    // 577, but in which 2571388 is nonetheless not fixed.    if (NSAppKitVersionNumber&lt;588.0) {        [NSDocumentControllerPatchedFor2571388         poseAsClass:[NSDocumentController class]];    }}</pre>                                    </td>                                </tr>                                <tr>                                    <td align="left" scope="row"><b>Listing 1</b>. Source code to fix NSDocumentController - add it to your project</td>                                </tr>                            </table>                        </center>                        <p><br>                        <br>                        <p>                        <hr width=500 align=center>                        <!-- begin_date --><center>                            <h4>[Jun 19 2001]</h4>                        </center><!-- end_date -->                    </td>                </tr>            </table>        </center>        <p><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/qa2001/qa1039.html%3Fid%3DDTS10001591-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/qa2001/qa1039.html%3Fid%3DDTS10001591-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/qa2001/qa1039.html%3Fid%3DDTS10001591-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information -->    </body></html>