<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-05-01 --><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1124: New Sound Input Driver Features</title><meta name="keywords" content="Mac OS 8 Sound Input Driver features latency reduction source"><meta name="Description" content="Technical Note TN1124: This Technical Note describes thevisible features and changes of the new PCI sound input driversintroduced with Mac OS 8.1. Each input driver change is documentedand advice on how to cope with these changes is provided.Included is sample code that demonstrates utilizing  thechanges in sound input drivers."><meta name="categories" content="Sound"><meta name="week-posted" content="Mar 30, 1998 - Apr 3, 1998"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002964" title="New Sound Input Driver Features"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/HardwareDrivers/index.html">Hardware & Drivers</a> &gt; <a href="../../technicalnotes/HardwareDrivers/idxMusicAudio-date.html">Audio</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Not Recommended Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>The information in this document is <strong>Not Recommended</strong> and should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/idxMusicAudio-date.html" target="_blank">Hardware & Drivers > Audio</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1124</div>
<div id="pageheadsub">New Sound Input Driver Features</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><center><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left">          <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                        <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left><!-- begin_toc --><P id = "menutext"><A HREF = "#Section1">Background of the         Changes</A><BR>         <BR>         <A HREF = "#Section2">The         Changes</A><BR>         <BR>         <A HREF = "#Section3">How to Cope With These Changes Gracefully</A><BR>         <BR>         <A HREF = "#Section4">Sample         Code</A><BR>         <BR>         <A HREF = "#Section5">Additional Notes         &amp; Comments</A><BR>         <BR>         <A HREF = "#Summary">Summary</A><BR><BR>         <A HREF="#Downloads">Downloadables</A></p>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left>            			<!-- begin_intro_text -->         <P id = "introtext">This Technote         describes the visible features and changes of the new PCI         sound input drivers introduced with Mac OS 8.1.</P>                  <P id = "introtext">This Note is directed at developers whose applications         use sound input, and to a lesser extent sound output         (playback). Developers who are creating sound input drivers         should also scan through this Technote to see if these         changes should be mirrored in their drivers.</P><!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Apr 23 1998]</h3><!-- end_date -->        </td>    </tr></table> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><A NAME=Section1></A>                  <H2>Background of the         Changes</H2>                  <P>Developers have asked for faster, more flexible sound         input drivers with more useful features. The new PCI sound         input drivers are the first step towards addressing these         requests.</P>                  <P>One request was for reduced latency between when the         recording starts and when the application gets the first bit         of recorded data.</P>                  <P>Another request was for an interrupt buffer that was an         integer power of 2 so that algorithms such as fast Fourier         transforms could work more efficiently.</P>                  <P>Users requested a simpler sound input model; existing         drivers made it too hard to configure the Mac for simple         audio tasks, such as listening to a CD or adjusting the         computer's volume. Apple's support representatives         frequently answered calls from users who were unable to         listen to an audio CD. This problem is addressed by the new         sound input drivers as well.</P>                  <P>The final change, the removal of the sound input driver's         interface (the <CODE>siOptionsDialog</CODE>), was requested         by engineering so that sound input drivers could more         closely conform to standard driver restrictions (like not         calling <CODE>ModalDialog</CODE>).</P>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>                  Do not rely on checking the Mac OS version to                  determine which Sound Manager features are                  available. Update your code as if these changes                  were universal. While the sound input drivers                  changed for Mac OS 8.1, these changes could be                  applied to older versions of the Mac OS through an                  update to the Sound Manager system extension.</P></TD></TR></TABLE></CENTER><BR><BR><BR><P><A HREF="#top">Back to top</A></P>         <P><A NAME=Section2></A></P>                  <H2>The Changes</H2>                  <H3>Latency Reduction</H3>                  <P>One of the most common requests was for reduced interrupt         latency in sound input and output (playback). This has been         addressed by reducing the size of the hardware interrupt         buffer from 1056 samples to 512 samples when virtual memory         is off. When VM is on, the buffer size is 4096 samples,         which is a reduction from its previous value of 4224         samples.</P>                  <P>The number 512 was chosen for two reasons. By reducing         the size of the buffer by approximately 50%, interrupt         latency was reduced by 50% as well. Now sound interrupts         happen approximately every 11 milliseconds instead of every         22 milliseconds (for 44.1KHz sound). This allows recorded         data to be given to the application with less latency and         allows for sounds being played to start sooner.</P>                  <P>The second reason the buffer size was reduced to 512         samples is that 512 is a integer power of 2, which is         important to developers trying to do real time analysis of         the sound being recorded. The algorithms that are used to do         this type of analysis (i.e., fast Fourier transforms)         frequently require buffers that are an integer power of two.         By adjusting the sound driver's buffer size, the developer         no longer has to do any complicated buffering of data in         their interrupt callback routine. Use the         <CODE>siHardwareFormat</CODE> selector to check the playback         hardware buffer size and <CODE>siDeviceBufferInfo</CODE> to         check the input hardware buffer size.</P>                  <H3>Options Dialog Removed</H3>                  <P>The <CODE>siOptionsDialog</CODE> selector has been         removed from the PCI sound input driver. It was removed for         two reasons:</P>                  <OL type=1 start=0>            <LI>Drivers should not have a user interface (in fact,            native device drivers ('ndrv') are not permitted to call            <CODE>ModalDialog</CODE>).<BR>            <BR>            </LI>                        <LI>Dialogs were not consistent between different            Macintosh computer models.</LI>         </OL>                  <P>It was felt that developers could provide a better         interface than the <CODE>siOptionsDialog</CODE> interface,         either through their own creation or the use of QuickTime's         SequenceGrabber dialog.</P>                  <H3>New Ways to Select an Input Source</H3>                  <P>Developers asked for a uniform way to select sound input         sources. This has been accomplished with the         <CODE>siOSTypeInputSource</CODE> and         <CODE>siOSTypeInputAvailable</CODE> selectors. Developers         can now choose an input source by a standard         <CODE>OSType</CODE> rather than by its name (which often         changes across systems and gets localized).</P>                  <H3>Simpler Sound Model</H3>                  <P>Another change which helps to simplify the sound model on         the Macintosh is that separate volume controls for the         headphones and internal speaker have been merged into one         control. There is no longer support for setting the         headphone volume independently of the internal speaker's         volume (because users were often confused by which volume         slider they needed to adjust to get the proper volume         level), or for controlling the mute state of the internal         speaker when headphones are plugged in.</P><P><A href="#top">Back to top</A></P>         <P><A NAME=Section3></A></P>                  <H2>How to Cope With These         Changes Gracefully</H2>                  <H3>Latency Reduction</H3>                  <P>Dealing with the driver's input buffer change should not         present any problems. For the most part, applications won't         notice that anything has changed. The few applications that         do care about the interrupt buffer size should already be         calling <CODE>SPBGetDeviceInfo</CODE> with the         <CODE>siDeviceBufferInfo</CODE> selector to get the size of         the interrupt buffer. Correct code will adjust to the new         buffer size without any modifications.</P>                  <H3>Options Dialog Removed</H3>                  <P>The removal of the <CODE>siOptionsDialog</CODE> selector         requires the application developer to create an interface to         properly configure the sound input driver for recording. The         developer can no longer call <CODE>siOptionsDialog</CODE> or         rely on some other software to configure the sound input         driver.</P>                  <P>There seems to be a lot of confusion on the point of how         to properly configure the sound input driver. Keep these         simple rules in mind when designing your application:</P>                  <OL>            <LI>Never assume that the sound input driver retains its            settings after being closed.</LI>                        <LI>Never rely on some other program to set the sound            input source for you.</LI>                        <LI>Never rely on some other program to set the            playthrough state for you.</LI>                        <LI>Never assume the state of the sound input            driver.</LI>         </OL>                  <P>Under these simple rules, it is clear that relying on the         user to set the sound input source through Monitors &amp;         Sound or the Sound control panel is the wrong thing to do:         it breaks the first three rules.</P>                  <P>The correct way to configure the sound input driver is to         present an interface of your own creation, or QuickTime's         SequenceGrabber interface, to the user. The minimum required         interface must allow the user to select the desired input         source and playthrough state. Once the input source and         playthrough state (sample rate, sample size, number of         channels, etc.) is set, do not close the input driver, as         there is no guarantee that when the driver is reopened that         the driver will default to the settings the user instructed         your program to make. If you must close the input driver,         reset it to the chosen configuration when you reopen it.</P>                  <H3>New Ways to Select an Input Source</H3>                  <P>To make it easier for application writers to choose the         correct input source the new PCI sound input drivers         implement two new selectors that work with OSTypes for         selecting the input source. These new selectors are:</P>                  <UL>            <LI><CODE>siOSTypeInputSource =            FOUR_CHAR_CODE('inpt')</CODE></LI>                        <LI><CODE>siOSTypeInputAvailable =            FOUR_CHAR_CODE('inav')</CODE></LI>         </UL>                  <P>The <CODE>siOSTypeInputSource</CODE> selector allows you         set the input source by passing an <CODE>OSType</CODE>         rather than an input source number. This is very useful         considering the fact that same input source, such as the         external microphone, could have radically different source         numbers depending on what Mac you are running on. The         <CODE>siOSTypeInputSource</CODE> selector currently uses         these constants to specify an input source (from Universal         Headers 3.1):</P>                  <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>enum {    kNoSource               = FOUR_CHAR_CODE('none'),    kCDSource               = FOUR_CHAR_CODE('cd  '),    kExtMicSource           = FOUR_CHAR_CODE('emic'),    kRCAInSource            = FOUR_CHAR_CODE('irca'),    kTVFMTunerSource        = FOUR_CHAR_CODE('tvfm'),    kDAVInSource            = FOUR_CHAR_CODE('idav'),    kIntMicSource           = FOUR_CHAR_CODE('imic'),    kMediaBaySource         = FOUR_CHAR_CODE('mbay'),    kModemSource            = FOUR_CHAR_CODE('modm'),    kZoomVideoSource        = FOUR_CHAR_CODE('zvpc')};</pre></TD></TR></TABLE></CENTER><BR><BR>                  <P>The <CODE>siOSTypeInputSource</CODE> selector can be used         with both <CODE>SPBSetDeviceInfo</CODE> and         <CODE>SPBGetDeviceInfo</CODE>, while         <CODE>siOSTypeInputAvailable</CODE> can only be used with         the <CODE>SPBGetDeviceInfo</CODE> call as it returns the         list of OSType selectors that can be used on the current         Mac.</P>                  <P>For more information about how to use the         <CODE>siOSTypeInputSource</CODE> and         <CODE>siOSTypeInputAvailable</CODE> selectors see the         <A HREF = "#Section4">Sample Code</A> section and <A HREF = "../../qa/snd/snd12.html">Q&amp;A         SND12</A>.</P>                  <P>You can always attempt to use these selectors without         doing any Sound Manager/Sound Input Manager version checking         beforehand. If an error is returned when you attempt to use         these selectors, the sound input driver doesn't support         these new selectors and you will have to have a fallback         plan (like putting up a dialog for the user to select an         input source) for setting the sound input source.</P>                  <H3>Simpler Sound Model</H3>                  <P>The removal of independent volume controls for the         headphones and internal speaker was done to give users an         interface more consistent with other audio hardware, such as         home stereos. In this audio model, when headphones are         plugged in, the main unit's speakers are disabled and the         volume control now controls the headphone volume. It's a         simple concept, like the one button mouse: with only one         volume control you always know which one to use. Any API         calls which affect the volume of the internal speaker also         set the volume of the headphones and vice versa. There is no         way to adjust the volumes independently; that feature has         been removed.</P>                  <P>This also allows the sound model to remain consistent         with Macintoshes that physically don't allow for independent         volume control of the headphones and internal speakers or         which physically disconnect the internal speaker when         headphones are plugged in.</P><BR><P><A HREF="#top">Back to top</A></P>         <P><A NAME=Section4></A></P>                  <H2>Sample Code</H2>                  <P>Here is some sample code showing how to access the         <CODE>OSType</CODE> array that is returned from         <CODE>siOSTypeInputAvailable</CODE>.</P>                  <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>static OSErr GetSoundInputSourceNames (long siRefNum, Handle *sourceNames){    OSErr                   err;// siInputSourceNames will return a structure that looks like://  struct {//      short   numNames;//      PString names[numNames];    // &lt;&lt;== these are packed pascal strings//  };    if (sourceNames != nil) {        err = SPBGetDeviceInfo (siRefNum, siInputSourceNames, sourceNames);    }#if DEBUG    if (err == noErr)    {        char                    sourceName[255];        long                    offset;        short                   numNames;        int                     i;        printf ("\nThe sound input source names are:\n");        numNames = (**(short***)sourceNames)[0];        offset = 2;        for (i = 0; i &lt; numNames; i++)        {            SInt32 strLen = ((char*)(**sourceNames))[offset++];            BlockMoveData (&amp;((char*)(**sourceNames))[offset],                           sourceName, strLen);            sourceName[strLen] = 0;            printf ("  %s\n", sourceName);            offset += strLen;        }    }#endif    return err;}</pre></TD></TR></TABLE></CENTER><BR><BR>                                 <P>Here is a sample illustrating a basic technique to create         your own sound input options dialog. First, get the list of         sound input source names and turn that list into a menu (in         this case a pop-up menu), insert that menu into a dialog and         then display the dialog. Once the dialog has been dismissed,         if the user did not cancel it, you use         <CODE>GetControlValue</CODE> to know which menu item they         selected and then pass this value with the         <CODE>siInputSource</CODE> selector to have the sound input         driver use that input source. No re-mapping of the value         from the menu is necessary because the sound input driver         returns the list of names in the same order as         <CODE>siInputSource</CODE> selects input sources.</P>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>#define kSourceNamesMenu        3#define kPlayThruCheckBox       4OSErr    DoSoundInputConfig (long soundInputDevice) {    OSErr                   err                 = noErr;    Rect                    box;    Handle                  sourceNames;    MenuHandle              namesMenu;    ControlHandle           control;    DialogPtr               optionsDialog;    long                    offset,                            i;    short                   type,                            inputSource,                            itemHit,                            playThruState;    Boolean                 done                = false;    err = GetSoundInputSourceNames (soundInputDevice, &amp;sourceNames);    namesMenu = NewMenu (kNamesMenu, nil);    if (namesMenu != nil) {        offset = sizeof (short);    // skip over count field        for (i = 0; i &lt; (*(short**)sourceNames)[0]; i++) {            AppendMenu (namesMenu, &amp;((unsigned char*)(*sourceNames))[offset]);            offset += (*(char**)sourceNames)[offset] + 1;        }        InsertMenu (namesMenu, hierMenu);        optionsDialog = GetNewDialog (kOptionsDialog, nil, (WindowPtr)-1L);        GetDialogItem (optionsDialog, kSourceNamesMenu, &amp;type, &amp;                      (Handle)control, &amp;box);        err = SPBGetDeviceInfo (soundInputDevice, siInputSource, &amp;inputSource);        SetControlValue (control, inputSource);        GetDialogItem (optionsDialog, kPlayThruCheckBox, &amp;type, &amp;                      (Handle)control, &amp;box);        err = SPBGetDeviceInfo (soundInputDevice, siPlayThruOnOff, &amp;playThruState);        if (playThruState &gt; 1)            playThruState = 1;        SetControlValue (control, playThruState);        SetDialogDefaultItem (optionsDialog, ok);        ShowWindow (optionsDialog);        while (done == false) {            ModalDialog (nil, &amp;itemHit);            switch (itemHit) {                case ok:                    err = noErr;                    done = true;                    break;                case cancel:                    err = userCanceledErr;                    done = true;                    break;                case kPlayThruCheckBox:                    type = chkCtrl;                    GetDialogItem (optionsDialog, kPlayThruCheckBox, &amp;                                   type, &amp;(Handle)control, &amp;box);                    SetControlValue (control, !GetControlValue (control));                    break;            }        }        if (err == noErr) {            GetDialogItem (optionsDialog, kSourceNamesMenu, &amp;                           type, &amp;(Handle)control, &amp;box);            inputSource = GetControlValue (control);            err = SPBSetDeviceInfo (soundInputDevice, siInputSource, &amp;inputSource);            if (err == noErr) {                GetDialogItem (optionsDialog, kPlayThruCheckBox, &amp;                               type, &amp;(Handle)control, &amp;box);                playThruState = GetControlValue (control);                if (playThruState == 1)                    playThruState = 7;                err = SPBSetDeviceInfo (soundInputDevice, siPlayThruOnOff,                                        &amp;playThruState);            }        }        DisposeDialog (optionsDialog);        DisposeMenu (namesMenu);    }    return (err);}</pre></TD></TR></TABLE></CENTER><BR><BR><BR><P><A HREF="#top">Back to top</A></P>         <P><A NAME=Section5></A></P>                  <H2>Additional Notes &amp;         Comments</H2>                  <P>As always, QuickTime exists to make dealing with audio         (either playing or recording) easier. If your application         only requires simple recording, you may wish to use         QuickTime to do that recording. QuickTime supplies a         standard user interface that can be accessed via one simple         call, <CODE>SGSettingsDialog</CODE>, and QuickTime allows         applications a simple way to record sound without having to         know anything about the hardware the application is running         on.</P>      <BR><P><A HREF="#top">Back to top</A></P>         <P><A NAME=Summary></A></P>                  <H2>Summary</H2>                  <P>The changes to the PCI sound input drivers do not have to         mean pain and suffering for you and your users if your         application allows the user to configure the sound input         driver from your application. However, if your application         relies on other software to configure the sound input driver         for you, now is the time to update your application to         correctly handle all sound configuration itself.</P>         <BR><P><A HREF="#top">Back to top</A></P><A NAME="References"></A><H2>References</H2>            <p><A HREF = "tn1108.html">Technote 1108: Unknown Sound            Features </A></p>                        <p><A HREF = "tn1048.html">Technote 1048: Some Sound            Advice: Getting the Most Out of the Sound            Manager</A></p>                        <p><a href="../../documentation/mac/Sound/Sound-2.html">Inside            Macintosh: Sound</A></p>                        <p><a href="../../documentation/quicktime/qtdevdocs/RM/frameset.htm">Inside            Macintosh:QuickTime</A></p><BR><P><A HREF="#top">Back to top</A></P>        <A NAME="Downloads"></A>         <br><h2>Downloadables</h2>        <center><TABLE BORDER=0 CELLPADDING=3 WIDTH="600">          <TR>             <td width=50 align=left>               <P ALIGN=center><img src="images/acrobatsmall.gif" align=middle alt="Acrobat" width=22 height=23></P>            </TD>            <td align="left">               <p>Acrobat version of this Note (60K).</P>            </TD>            <td width=60 align=left>               <p><A HREF="pdf/tn1124.pdf">Download</A></P>            </TD>          </TR>        </TABLE></center><BR><BR>                  <BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1124.html%3Fid%3DDTS10002964-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1124.html%3Fid%3DDTS10002964-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1124.html%3Fid%3DDTS10002964-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>