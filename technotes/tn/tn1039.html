<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1039: Access &amp; the Power Manager:Headaches &amp; Cures</title>  <META NAME="Keywords"    CONTENT="[Keywords]"><meta name="Description" content="Technical Note TN1039:      [Textual description of documentas you want it to appear in the text     sections of searchengines supporting this field]    "><META NAME="Identifier-URL"Content="http://www.apple.com/metadata/sample.html">       <meta name="keywords" content="Mac OS 8 Power Manager problems storage devices access file">    <meta name="Description" content="Technical Note TN1039: This Technical Note provides techniquesfor avoiding Power Manager Interaction problems when buildingan application that communicates with storage devices bybypassing the Macintosh file system. "><meta name="categories" content="Files and Devices"><meta name="week-posted" content="Apr 1, 1996 - Apr 5, 1996"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002881" title="Access & the Power Manager:Headaches & Cures"></a><A NAME="top"></A> <!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/index.html" target="_blank">Reference Library</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1039</div>
<div id="pageheadsub">Access &amp; the Power Manager:Headaches &amp; Cures</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"> <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr><td width=300 valign="top" align=left scope="row">    <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td></tr><tr bgcolor="#e6e6e6">    <td background="images/tnmenubody.gif" width=300 align=left><span id="menutitle">    CONTENTS     <BR>    <BR></span>    </td></tr><tr bgcolor="#e6e6e6">    <td background="images/tnmenubody.gif" width=300 align=left><!-- begin_toc --><P id = "menutext"><A HREF = "#RTFToC1">Meet the Power Manager on the Desktop</A><BR><BR><A HREF = "#RTFToC2">Problems with Apps That Bypass the File   Manager</A><BR><BR><A HREF = "#RTFToC3">Mr. Disk Doctor, "It Hurts When I Do   This... What's the Cure?"</A><BR><BR><A HREF = "#RTFToC4">Summary</A><BR><BR><A HREF = "#References">References</a><br><br><A HREF="#Downloads">Downloadables</A></P>   <!-- end_toc -->  </td></tr><tr>    <td width=300 align=left scope="row"><img src="images/tnmenubottom.gif" alt="" width=300 height=16>    </td></tr>    </table></td><td width=300 valign="top" align=left><!-- begin_intro_text -->  <P id = "introtext">If you are building an application that communicates with storagedevices by bypassing the Macintosh file system, you may encountersome unexpected problems related to interaction with the PowerManager. This Note discusses some elementary but often overlookedways to prevent these problems from occurring.</P><P id = "introtext">This Note is important for developers who write disk formatters,diagnostics or applications that access disks directly.</p><!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Mar 1 1996]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR> <!-- begin_content --><A NAME="RTFToC1"></A><H2>Meet the Power Manager on the Desktop</H2><P>Traditionally, only portable Macintosh computers contained thecombination of software and hardware components that allowed thesystem to conserve battery power by shutting down various subsystems.Developers who wrote specifically for these machines understood theneed to interact with the Power Manager.</P><P>In an attempt to set ceilings on computer energy use, theEnvironmental Protection Agency created a set of specifications knownas the Energy Star Program. In order to meet these specifications,the Power Manager was also introduced on Macintosh desktop computers.</P><P>One of the ways that the Power Manager functions is to conservepower by spinning down any attached disk drives after a specifiedperiod of file system inactivity.</P><P>Assuming your application uses standard file system calls, thisinteraction will be transparent. At worst, your app will onlyexperience a few seconds delay on power up.</P><P><A HREF="#top">Back to top</A></P><P><A NAME="RTFToC2"></A></P><H2>Problems with Apps That Bypass the File Manager</H2><P>Some applications can't use the File Manager for disk I/O. Forinstance, drive diagnostics, formatters, or even certainperformance-sensitive applications may have occasion to communicatedirectly with the SCSI or ATA manager to access the disk directly.</P><P>If your application bypasses the File Manager and doesn'tperiodically update the Power Manager's idle timer (e.g., by spinningthe cursor), it is possible to trick the Mac OS into "thinking" thatthe computer is idle. If this inactivity persists for a long enoughperiod of time and the disk spindown feature is enabled, the PowerManager will issue a command to shut down the disk subsystem.</P><P>If your app is not prepared for this, you may experience someunexpected behavior -- for example, read/write errors, or uncompletedoperations from your disk.</P><P>These problems can also plague users who install an older diskdriver that doesn't properly handle power down. Some older driverswere simply never designed to interact with the Power Manager ondesktop computers.</P><P><A HREF="#top">Back to top</A></P><P><A NAME="RTFToC3"></A></P><H2>Mr. Disk Doctor, "It Hurts When I Do This... What's the Cure?"</H2><P>The first thing your application should do if it intends toperform a long series of disk operations without any File Managerinvolvement is to determine if it is running on a Macintosh thatsupports the Power Manager. You can do this by gestalting forgestaltPowerMgrAttr and checking if the gestaltPMgrExists flag istrue.</P><P>On standard configurations with one internal ATA or SCSI drive,the disk spindown is typically controlled by the Power Manager'sHardDiskQueue activity timer. In the past, periodically callingidleUpdate() was sufficient to prevent disk spindown.</P><P>Yet on newer systems that include multiple internal and externaldrives, such as PCMCIA, expansion bay or even external SCSI, accessto a single drive can prevent all other drives from being spun down.This is because the access will reset the one Power Manager spindowntimer used by all the drives. What can also happen is that if you'reusing one timer, then all your drives will spin up at the same time.This strategy is very costly in terms of power consumption and doesnot promote the efficient battery use on PowerBooks.</P><P>On these systems the driver writer is compelled to employ aninternal spindown timer instead of the Power Manger's timer, thusavoiding spindown synchronization.</P><P>The side effect of a driver using its own spindown timer is thatIdleUpdate(), EnableIdle(), and DisableIdle() do not have an effecton the driver's timer as it does with the Power Manager's timer. Theonly way to reset or disable the driver's timer to prevent spindownis either to access the drive (via read or write) or disable spindownvia SetSpindownDisable().</P><P>Even with this precaution, your application still needs to beprepared to handle any errors that might be caused by a disk drivespinning down. It's possible that some errant drivers won't evenhonor SetSpindownDisable().</P><H3>How Does Apple Do It?</H3><P>The Apple ATA driver manages its own spindown timer in such a wayas to not cause a major disruption to your app. Its spins down thedrive with the ATA&nbsp;Standby command instead of the ATA Sleepcommand. The ATA Standby does not deactivate the drive interface,allowing the drive to spin back up on the next access. On the otherhand, the ATA Sleep does deactivate it and requires a soft resetbefore the drive can be used again. Consequently, your app is onlyinconvenienced by a spin up delay.</P><H3>A Caveat</H3><P>Unfortunately, this method was only recently incorporated into theApple ATA driver. There is no guarantee that an earlier Apple orthird-party disk driver will behave this way.</P><P><A HREF="#top">Back to top</A></P><P><A NAME="RTFToC4"></A></P><H2>Summary</H2><P>Power management functions are no longer limited to the realm ofportables but are appearing now on desktop Macintosh computers. Thiscan cause more than a few headaches if you plan to access the diskbehind the File Manager's back.</P><P>If your application routinely bypasses the File System andaccesses the drive through the ATA or SCSI Manager, it shouldtemporarily disable the drive spindown. Even then, you should stillanticipate and handle any errors caused by drive spindown.</p><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><P><I>Inside Macintosh: Devices, Chapter 6, Power ManagerReference</I></P><P><A HREF="#top">Back to top</A></P>          <A NAME=Downloads></A>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (48K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tn1039.pdf">Download</A></P>               </TD>            </TR>         </TABLE>         <BR><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1039.html%3Fid%3DDTS10002881-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1039.html%3Fid%3DDTS10002881-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1039.html%3Fid%3DDTS10002881-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>