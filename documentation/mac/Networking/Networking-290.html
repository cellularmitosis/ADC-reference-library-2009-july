<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Sending Packets Using a Multinode(IM:N)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING290></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Networking-289.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-291.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Networking-2.html"><B>Networking</B></A> / <BR><DD><A HREF="Networking-284.html"><B>Chapter 12 - Multinode Architecture</B></A> / <A HREF="Networking-286.html"><B>Using Multinode Architecture</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING290-0></A>
<H2>Sending Packets Using a Multinode</H2>
 You can use a multinode to send packets that contain data that you have already received; <A NAME=MARKER-2-41></A>in this case you forward the data from the multinode using the <A NAME=MARKER-2-42></A><CODE>NetWrite</CODE> call. You can also use the multinode to send original data using the <CODE>NetWrite</CODE> call. In both cases, you must use a structure called the <B>write-data structure</B> to indicate to the .MPP driver where the DDP packet header portion and the data portion to be sent are stored. Why you send data is particular to your application. For example, if your application implements AEP, it would send an Echo Reply packet in response to the Echo Request packet that the application receives. For a brief description of using multinode, see the discussion on <A HREF=Networking-285.html#MARKER-9-15>page 12-5</A>.<P>
 To send data from the multinode, you perform the following steps:<P>
<OL>
<LI>Create a write-data structure, as described in the next section, "Preparing a Write-<BR>Data Structure."
<LI>Allocate nonrelocatable memory for a multinode parameter block that includes the fields required for the <CODE>NetWrite</CODE> routine. See <A HREF=Networking-295.html#MARKER-9-63>"The Multinode Parameter Block" beginning on page 12-18</A>. The multinode parameter block belongs to the .MPP driver for the life of the <CODE>NetWrite</CODE> call. 
<LI>Call the <CODE>NetWrite</CODE> routine to send the data. You issue the <CODE>NetWrite</CODE> routine as a Device Manager's <CODE>PBControl</CODE> call. See <A HREF=Networking-301.html#MARKER-9-94>"NetWrite" beginning on page 12-24</A> for details on this routine and the parameters it requires. <P>
<UL>
<LI>Set the parameter block field values belonging to the <CODE>NetWrite</CODE> call, including <BR>the checksum flag (<CODE>checkSumFlag</CODE>) parameter. See <A HREF=#MARKER-9-47>"Using a Checksum" on page 12-15</A>.
<LI>You must set the <CODE>csCode</CODE> parameter block field to the numeric value of 261 for the <CODE>NetWrite</CODE> routine.<P>
</UL>
</OL>
<A NAME=HEADING290-8></A>
<H3><A NAME=MARKER-9-43></A>Preparing a Write-Data Structure</H3>
 The .MPP driver uses a <A NAME=MARKER-2-44></A>write-data structure that you create to locate the header and data portions of the packet to be transmitted. When you call the <CODE>NetWrite</CODE> routine to send data from a multinode, you pass it a pointer to the write-data structure that you have already prepared. A write-data structure contains a series of pairs of length words and pointers, and each pair indicates the length and location of a portion of the data. The first pair must indicate the DDP header of the packet to be transmitted. It ends with a 0 word.<P>
 The .MPP driver constructs the packet to be transmitted, building the packet contents from the header and data information that you provide. <P>
 The write-data structure that you use for a multinode is similar to the write-data structure that you use to send a packet from a DDP socket except that for a multinode write-data structure, you must also include the source network number and the source multinode ID. This is because the source user node ID of the physical node, which is carried in the frame header, is different from the source multinode ID, which is carried in the DDP packet header. The source address information that you provide identifies the multinode from which you are sending the data. The multinode write-data structure also contains a checksum field that you can set to 0 if you do not want a checksum calculated for this packet. <A HREF=#MARKER-9-46>Figure 12-3</A> shows the write-data structure; it also shows how you must define the header information in the storage that you allocate for it.<P>
 You create a write-data structure in one of three different forms:<P>
<UL>
<LI>You can provide a single length-pointer pair that identifies one storage block that contains both the header and data information. In this case, the header information must come first, and it must begin at an odd address.
<LI>You can use two length-pointer pairs, one for the header portion and one for the <BR>data portion. 
<LI>You could also use more than two length-pointer pairs, one for the header, and one for each separate block of data.<P>
</UL>
 In many cases, the header and data components of a packet are not stored contiguously, which requires that the write-data structure contain at least two length-pointer pairs. Typically, the data portion is stored as a single block. However, some implementations send blocks of data that are stored separately as parts of the same datagram; if the complete data portion is stored as several separate blocks, then the write-data structure needs to contain a length-pointer pair for each block of data. <A NAME=MARKER-2-45></A><P>
<B>Figure 12-3  <A NAME=MARKER-9-46></A>The write-data structure for a multinode</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/MN-L-03.jpg"><P>
<DL>
<DT><B>Note</B>
<DD>The header block that the write-data structure points to consists of <BR>16 bytes. The first pointer in the write-data structure must point to an odd address, so if you create the write-data structure in Pascal, the <BR>first byte is not used.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
 For the header, you must fill in the following:<P>
<UL>
<LI>the destination network number
<LI>the source network number of the multinode 
<LI>the destination node ID
<LI>the source multinode ID
<LI>the destination socket number
<LI>the source socket number (if you are forwarding from the multinode a DDP packet that contains an existing value for the source socket number, you can pass that value on in this field)
<LI>DDP protocol type (DDP protocol types 1 through 15 are reserved for use by Apple)<P>
</UL>
<DL>
<DT><B>Note</B>
<DD>A multinode is not associated with a DDP socket. If the source socket field contains a value, it must adhere to the conventions that the AppleTalk DDP protocol specification describes for the use of sockets. For example, this field must not specify socket number 0 ($00); rather the value should be constrained to socket number values belonging to the user-defined range stated in the DDP protocol specification; see <I>Inside AppleTalk,</I> second edition, for this information.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
<A NAME=HEADING290-29></A>
<H3><A NAME=MARKER-9-47></A>Using a Checksum</H3>
 <A NAME=MARKER-2-48></A>The long DDP packet header that you create for a multinode can include a checksum value that is used to verify that the packet data has not been corrupted by memory or data bus errors within routers on the internet. When you call the <CODE>NetWrite</CODE> routine to send data from a multinode, you specify a value for the <CODE>checkSumFlag</CODE> parameter of the multinode parameter block. You use the <CODE>checkSumFlag</CODE> parameter differently to send data from a multinode than how you would use it to send data from a DDP socket, even though in both cases the flag's value controls the use of the long DDP packet header's <CODE>checksum</CODE> field. <P>
 Any application that uses a multinode can receive packets through that multinode. The application can then repackage and forward the packet through the serial port and modem to its multinode-application counterpart on a remote system. The multinode application at the remote end can then decode the package and send the packet on through a <CODE>NetWrite</CODE> call to a node on the network or a user-node process on the same machine. An existing packet that is to be forwarded could already contain a checksum value. When you issue the <CODE>NetWrite</CODE> call, you can preserve that checksum value and pass it on as part of the header in the packet. You use the <CODE>checkSumFlag</CODE> parameter of the <CODE>NetWrite</CODE> routine for this purpose. <P>
<UL>
<LI>If you do not want the <A NAME=MARKER-2-49></A>current value in the packet header's checksum field to be altered, you set <CODE>checkSumFlag</CODE> to 0, and the existing checksum value in the DDP header will not be changed. (If a checksum has already been calculated, it will be passed along unmodified.)
<LI><CODE>If you want the checksum for the datagram to be calculated and placed in the DDP packet header's </CODE>checksum<CODE> field before the .MPP driver transmits the packet, set checkSumFlag</CODE> to a nonzero number. <P>
</UL>
 Note that if you want to send a packet that does not include a checksum, you must hardcode the value by setting to 0 the checksum field of the data structure that contains the packet header that you point to from the write-data structure.<P>
<DL>
<DT><B>How the Apple Remote Access program uses the checksum flag</B>
<DD>The <A NAME=MARKER-2-50></A>Apple Remote Access (ARA) program is an example of an applica-<BR>tion that sets the <CODE>checkSumFlag</CODE> flag to 0 in order to preserve a packet's original checksum value. <B>The ARA client multinode can receive a DDP packet addressed to that multinode or a broadcast packet, such as an NBP lookup packet. In either case, the packet is a standard DDP packet that could contain a checksum value. The client ARA software passes the packet on to the ARA software on the server through the serial port and modem. </B>The ARA software on the server node sets <CODE>checkSumFlag</CODE> to 0 when it calls the <CODE>NetWrite</CODE> routine to send the packet down from the multinode through the AppleTalk stack and out to a node on the network.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Networking-289.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-291.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Networking-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
