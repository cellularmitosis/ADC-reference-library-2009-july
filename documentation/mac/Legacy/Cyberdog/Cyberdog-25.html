<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Manipulating a Cyberdog Item(Cyberdog)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING25></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->




<!-- Main Body -->

<CENTER>
<P>
<A HREF="Cyberdog-24.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Cyberdog-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Cyberdog-319.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Cyberdog-26.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Cyberdog-2.html"><B>Cyberdog Programmer's Kit</B></A> / <A HREF="Cyberdog-20.html"><B>Part 2 - Programming in Cyberdog</B></A><BR><DD><A HREF="Cyberdog-21.html"><B>Chapter 3 - Adding Cyberdog Features to an OpenDoc Part</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING25-0></A>
<H1>Manipulating a Cyberdog Item</H1>
 To use a Cyberdog item, your part must be able to create and open one. If you want a Cyberdog item to persist between sessions, you must support reading and writing Cyberdog items. To support data interchange of Cyberdog items, your part should support drag and drop.<P>
 The button part manipulates Cyberdog items in the following ways, as described in the following sections:<P>
<UL>
<LI>It creates a Cyberdog item from a URL.
<LI>It reads a Cyberdog item from a storage unit and writes an item to the unit.
<LI>It opens a Cyberdog item.
<LI>It handles drag and drop of a Cyberdog item.<P>
</UL>
<A NAME=HEADING25-7></A>
<H2><A NAME=MARKER-9-30></A>Creating a Cyberdog Item From a URL</H2>
 <A NAME=MARKER-2-31></A>To create a Cyberdog item from a URL, you must first obtain a reference to the Cyberdog session by calling the GetCyberSession function. You then can create a Cyberdog item from the URL text by calling the Cyberdog session's CreateCyberItemFromURL method. Optionally, you can set the default name of the Cyberdog item. <P>
 <A HREF=#MARKER-9-34>Listing 3-5</A> shows how the button part creates a Cyberdog item when the part is first opened. The default URL text, which is stored in the part's resource fork, is used to create the item and to set the item's display name.<P>
<B>Listing 3-5  <A NAME=MARKER-9-34></A>The button part's <CODE>InitPart</CODE> method</B><P>
<PRE>
void CybTxtBtn::InitPart( Environment* ev,
                     ODStorageUnit* storageUnit,
                     ODPart* partWrapper )
{
   TRY
      fSelf = partWrapper;
      fReadOnlyStorage = kODFalse;
         
      // Call the common initialization code to initialize Cyberdog.
      this-&gt;Initialize(ev, storageUnit);
      
      // Use CUsingLibraryResources to access part's resource fork.
      {
         CUsingLibraryResources fil;
         Str255defaultURL;
         
         // Get the default string from the resource fork.
         ::GetIndString( defaultURL, kMenuStringResID,
                              kDefaultContent1ID);
         
         if (defaultURL[0] == 0)
            DebugStr(&quot;\p InitPart -- couldn't get string.&quot;);
         else
         {  
            // Make a C string out of the default URL pascal string.
            char cStr[255];
            ODBlockMove(&amp;defaultURL[1], cStr, defaultURL[0]);
            cStr[ defaultURL[0] ] = 0;
         
            // Create a Cyberdog item from the URL.
            fCyberItem = GetCyberSession(ev)-&gt;CreateCyberItemFromURL
                                       (ev, (char*)cStr);
            
            // Make the default name equivalent to the URL.
            // Assume all URLs are smRoman font.
            if (fCyberItem)
               fCyberItem-&gt;SetDefaultName(ev, defaultURL, smRoman);
         }
      }
      // Allow the state and content info to be written to storage.
      this-&gt;SetDirty(ev);

   CATCH_ALL
      RERAISE;
   ENDTRY
}
</PRE>
<DL>
<DT><B>Note</B>
<DD>The default font for displaying URL's is <CODE>smRoman</CODE>. <EM>u</EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
<A NAME=HEADING25-13></A>
<H2><A NAME=MARKER-9-35></A>Reading and Writing Cyberdog Items</H2>
 <A NAME=MARKER-2-36></A>To read a Cyberdog item from a storage unit, you must obtain a reference to the Cyberdog session by calling the <A NAME=MARKER-2-37></A>GetCyberSession function. You then can call the session's CreateCyberItemFromSU method. Optionally, you can call the Cyberdog item's <A NAME=MARKER-2-39></A>GetStringProperty method to retrieve the string associated with the item's display name, as indicated by the <A NAME=MARKER-2-40></A>kCDDefaultName constant.<P>
 <A HREF=#MARKER-9-41>Listing 3-6</A> shows the button part's <CODE>InternalizeContent</CODE> method, which replaces the current Cyberdog item, if one exists, with one that has just been created from the storage unit. (The <CODE>InternalizeContent</CODE> method is called by the <CODE>InitPartFromStorage</CODE> method.)<P>
<B>Listing 3-6  <A NAME=MARKER-9-41></A>The button part's <CODE>InternalizeContent</CODE> method</B><P>
<PRE>
void CybTxtBtn::InternalizeContent (Environment* ev, 
                           ODStorageUnit* storageUnit)
{
   if (ODSUExistsThenFocus(ev, storageUnit, kODPropContents,
                                          kCybTxtBtnKind))
   {              
      CyberItem* ci = kODNULL;
      
      // Retrieve the Cyberdog item from the storage unit.
      ci = GetCyberSession(ev)-&gt;CreateCyberItemFromSU(ev, storageUnit);
         
      // Replace the current Cyberdog item with the one in the 
      // storage unit.
      if (ci != kODNULL)
      {
         if (fCyberItem != kODNULL)
            fCyberItem-&gt;Release(ev);
         fCyberItem = ci;
      }
   }
}
</PRE>
 To write a Cyberdog item to a storage unit, you can call the item's StreamToStorageUnit method. <A HREF=#MARKER-9-42>Listing 3-7</A> shows the button part's <CODE>ExternalizeContent</CODE> method, which takes this action. (The <CODE>InternalizeContent</CODE> method is called by the <CODE>Externalize</CODE> method and other methods that write to storage units.)<P>
<B>Listing 3-7  <A NAME=MARKER-9-42></A>The button part's <CODE>ExternalizeContent</CODE> method</B><P>
<PRE>
void CybTxtBtn::ExternalizeContent( Environment* ev,
                            ODStorageUnit* storageUnit,
                            ODDraftKey /*key*/,
                            ODFrame* /*scopeFrame*/ )
{
   // Focus on content property and get the current size of the data.
   ODSUForceFocus(ev, storageUnit, kODPropContents, kCybTxtBtnKind);
   ODULong oldSize = storageUnit-&gt;GetSize(ev);
   
   // Flatten an item to a buffer and then write the
   // buffer out to the specified ODStorageUnit. 
   fCyberItem-&gt;StreamToStorageUnit(ev, storageUnit);

   ODULong newSize = storageUnit-&gt;GetOffset(ev);
   if (newSize &lt; oldSize)
      storageUnit-&gt;DeleteValue(ev, oldSize - newSize);
}
</PRE>
 Once you write the Cyberdog item to storage in this fashion, you must call the Cyberdog session's CreateCyberItemFromSU method to recreate the item in the storage unit (see <A HREF=#MARKER-9-41>Listing 3-6</A>).<P>
<DL>
<DT><B>Note</B>
<DD>Whenever you store data in an OpenDoc storage unit, you must modify all methods that work with storage and change them to support your kind of data. In this example, the <CODE>kCybTxtBtnKind</CODE> constant specifies the kind of data associated with the Cyberdog item. It is defined as follows:  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
<PRE>
#define kCybTxtBtnKind kODISOPrefix &quot;Apple:Kind:CybTxtBtn&quot; u
</PRE>
<A NAME=HEADING25-24></A>
<H2><A NAME=MARKER-9-43></A>Opening a Cyberdog Item</H2>
 <A NAME=MARKER-2-44></A>You call the Cyberdog item's <A NAME=MARKER-2-45></A><CODE>Open</CODE> method to open a Cyberdog item. What it means to open a Cyberdog item depends on the kind of data at the location referenced by the Cyberdog item. For example, if the Cyberdog item represents a URL for HTML-formatted data, calling the item's <CODE>Open</CODE> method causes the data to be downloaded and displayed in a Cyberdog display part. If the Cyberdog item represents an e-mail address, calling the item's <CODE>Open</CODE> method results in actions to send mail.<P>
 The <CODE>Open</CODE> method takes, as a parameter, a <A NAME=MARKER-2-46></A>ParameterSet object that specifies various options for opening the Cyberdog item. The value can be <CODE>nil</CODE>, meaning that no additional options are used. For information about the ParameterSet class, see <A HREF=Cyberdog-306.html#MARKER-9-459>"ParameterSet" (page 391)</A>.<P>
 <A HREF=#MARKER-9-47>Listing 3-8</A> shows a portion of the button part's HandleMouseEvent method from which the Cyberdog item's <CODE>Open</CODE> method is called. The HandleMouseEvent method is called when the user clicks in the button part. (The HandleMouseEvent method is called from the <CODE>HandleEvent</CODE> method.)<P>
<B>Listing 3-8  <A NAME=MARKER-9-47></A>Opening the Cyberdog item</B><P>
<PRE>
ODBoolean CybTxtBtn::HandleMouseEvent( Environment* ev,
                              ODEventData* event,
                              ODFacet* facet,
                              ODEventInfo* eventInfo )
{
   if ( facet != kODNULL )
   {
      if ( event-&gt;what == kODEvtMouseUp )
      {
         ...
      }
      else if ( event-&gt;what == kODEvtMouseDown )
      {
         if (fCyberItem == kODNULL)
            SysBeep(1);
         else
            fCyberItem-&gt;Open(ev, nil);
      }
   }
   else
   {
      SysBeep(1);
   }
   return kODTrue;
}
</PRE>
<A NAME=HEADING25-30></A>
<H2><A NAME=MARKER-9-48></A>Supporting Drag and Drop of Cyberdog Items</H2>
 <A NAME=MARKER-2-49></A>To support drag and drop, you must implement the OpenDoc drag-and-drop protocol, which is explained in <I><A HREF="../../ODProgGuide/ODProgGuide-2.html">OpenDoc Programmer's Guide</A></I>. It involves overriding the DragEnter, DragWithin, DragLeave, and Drop methods. To support drag and drop of Cyberdog items, you must modify two methods:<P>
<UL>
<LI>Modify the <CODE>DragEnter</CODE> method so that a Cyberdog item can be dragged onto the part. 
<LI>Modify the <CODE>Drop</CODE> method so that the part accepts the dropped item. <P>
</UL>
 In this example, the button part accepts drags of Cyberdog items and of text. Text is used to create a Cyberdog item representing a URL. <P>
 <A HREF=#MARKER-9-51>Listing 3-9</A> shows the <CODE>DragEnter</CODE> method that checks for Cyberdog items and for text. The <A NAME=MARKER-2-50></A>kCyberItemKind constant, which is passed to the storage unit's <CODE>Exists</CODE> method, identifies a Cyberdog item.<P>
<B>Listing 3-9  <A NAME=MARKER-9-51></A>The button part's <CODE>DragEnter</CODE> method</B><P>
<PRE>
ODDragResult CybTxtBtn::DragEnter(Environment* ev, 
                         ODDragItemIterator* dragInfo, 
                         ODFacet* facet, ODPoint* where)
{
   ODUnused(facet);
   ODUnused(where);

   ODStorageUnit dragSU;
   ODValueType textType = ODGetSession(ev,fSelf)-&gt;GetTranslation(ev)-&gt;
                     GetISOTypeFromPlatformType(ev, 'TEXT',
                                       kODPlatformDataType);

   fAcceptThisDrag = kODFalse;
   fActiveFrameHilitedForDrop = kODFalse;

   // Accept the drag if it is a Cyberdog item or text
   for (dragSU = dragInfo-&gt;First(ev); 
       dragSU != kODNULL; 
       dragSU = dragInfo-&gt;Next(ev))
   {
      if (dragSU-&gt;Exists(ev, kODPropContents, kCyberItemKind, 0))
         fAcceptThisDrag = kODTrue;
      else if (dragSU-&gt;Exists(ev, kODPropContents, textType, 0))
         fAcceptThisDrag = kODTrue;
   }
   return fAcceptThisDrag;
}
</PRE>
 The <CODE>Drop</CODE> method handles dropping of data allowed by the <CODE>DragEnter</CODE> method. Specifically, the method should create a Cyberdog item from the specified kind of data. You create a Cyberdog item from an item dropped into your part's storage unit by calling the Cyberdog session's <A NAME=MARKER-2-52></A>CreateCyberItemFromSU method. In the call to CreateCyberItemFromSU, you specify the drag storage unit as a parameter. If your part supports drag and drop of text, you can create a Cyberdog item by calling the Cyberdog session's <A NAME=MARKER-2-53></A>CreateCyberItemFromURL method. <P>
 <A HREF=#MARKER-9-54>Listing 3-10</A> shows how the button part creates a Cyberdog item when Cyberdog item data or text is dropped on the part. If a Cyberdog item already exists, it is released and a reference to the newly created Cyberdog item is saved in the <CODE>fCyberItem</CODE> field. The draft is marked as dirty so that its state will be saved, and the facet is invalidated so that it will be redrawn. <P>
<B>Listing 3-10  <A NAME=MARKER-9-54></A>The button part's <CODE>Drop</CODE> method</B><P>
<PRE>
ODDropResult CybTxtBtn::Drop(Environment* ev, 
                      ODDragItemIterator* dragInfo, 
                      ODFacet* facet, ODPoint* where)
{
   ODStorageUnit*dragSU;
   CyberItem*  ci = kODNULL;
   CyberSession*cyberSession = GetCyberSession(ev);
   ScriptCode  script= smRoman;
   ODValueType textType = ODGetSession(ev,fSelf)-&gt;
               GetTranslation(ev)-&gt;GetISOTypeFromPlatformType(ev, 
                                 'TEXT', kODPlatformDataType);
   
   for (dragSU = dragInfo-&gt;First(ev); 
       dragSU != kODNULL; 
       dragSU = dragInfo-&gt;Next(ev))
   {
      // A Cyberdog item is dropped.
      if (dragSU-&gt;Exists(ev, kODPropContents, kCyberItemKind, 0))
      {
         // Focus on the Cyberdog item data in the drag storage unit
         dragSU-&gt;Focus(ev, kODPropContents, kODPosUndefined,
                           kCyberItemKind, 0, kODPosUndefined);

         // Retrieve the Cyberdog item from the drag storage unit.
         ci = cyberSession-&gt;CreateCyberItemFromSU(ev, dragSU);
      }
      
      // The drop is not a Cyberdog item; deal with it as text.
      else if (dragSU-&gt;Exists(ev, kODPropContents, textType, 0))
      {
         Size textSize = 0;
         ODPtr theText = kODNULL;
         
         // Get the text from the drag storage unit.
         dragSU-&gt;Focus(ev, kODPropContents, kODPosUndefined,
                              textType, 0, kODPosUndefined);
         
         // Get the text length and enough memory for the text.
         textSize = (long) dragSU-&gt;GetSize(ev);
         theText = ODNewPtrClear(textSize + 1);
         if (theText)
         {
            // Read the text.
            StorageUnitGetValue(dragSU, ev, textSize,
                                       (ODValue)theText);
            
            // Create a Cyberdog item for the text.
            ci = cyberSession-&gt;CreateCyberItemFromURL(ev,
                                          (char*)theText);
            if (ci != kODNULL)
            {
               // Convert the text to a pascal string.
               Str255 pStr;
               Size maxSize = 255;
               textSize = (textSize &gt; maxSize) ? maxSize : textSize;
               ODBlockMove(theText, &amp;pStr[1], textSize);
               pStr[0] = textSize;
               
               // Set the Cyberdog item's default name.
               ci-&gt;SetDefaultName(ev, pStr, script);
            }
            ODDisposePtr(theText);
         }
      }
      // Replace the current Cyberdog item with the one from the drop.
      if (ci != kODNULL)
      {
         if (fCyberItem != kODNULL)
            fCyberItem-&gt;Release(ev);
         fCyberItem = ci;

         // Successful; save the state and invalidate the display.
         this-&gt;SetDirty(ev);
         facet-&gt;Invalidate(ev, kODNULL, kODNULL);
         return kODDropCopy;
      }
   }
   // Not successful
   return kODDropFail;
}
</PRE>

</BLOCKQUOTE>
<HR>
<center>
<A HREF="Cyberdog-24.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Cyberdog-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Cyberdog-319.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Cyberdog-26.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Cyberdog-3.html">&copy; Apple Computer, Inc.</A><br>13 JUL 1996</center></font><P>
<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->
</BODY>
</HTML>   
