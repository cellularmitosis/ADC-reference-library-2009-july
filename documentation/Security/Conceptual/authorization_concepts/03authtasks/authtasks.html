<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Authorization Services Programming Guide: Authorization Services Tasks</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Authorization Services Tasks"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30000995-CH206" title="Authorization Services Tasks"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000434" target="_top">Security</a> &gt; <a href="../../../Authorization-date.html#//apple_ref/doc/uid/TP30000440-TP30000434-TP30001024" target="_top">Authorization</a> &gt; <a href="../01introduction/introduction.html#//apple_ref/doc/uid/TP30000995-CH204-TP1">Authorization Services Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../02authconcepts/authconcepts.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../appendixa/appendixa.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30000995-CH206-TP9" title="Authorization Services Tasks"></a><h1>Authorization Services Tasks</h1><p>This chapter provides instructions and code samples for tasks you can accomplish with Authorization Services. You can adapt these samples in your own application to</p><ul class="ul"><li class="li"><p>Restrict access to parts of your own application</p></li><li class="li"><p>Call system utilities</p></li><li class="li"><p>Edit privileged files</p></li><li class="li"><p>Install your privileged tools</p></li></ul><p>A simple, self-restricting application needs to restrict a user from the application’s own operations with minimal security concerns—for example, a grades-and-transcripts application might only allow the registrar to create transcripts. Read <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BCIGEHDI">“Authorizing in a Simple, Self-Restricted Application”</a></span> if you have a self-restricting application.</p><p>If you have a factored application—for example, an application that must perform an operation as root, such as restarting a daemon—you should read both <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BCIGEHDI">“Authorizing in a Simple, Self-Restricted Application”</a></span> and <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BCIGAIAG">“Authorizing in a Factored Application.”</a></span></p><p>If your installer must perform a privileged operation, read <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF33">“Calling a Privileged Installer”</a></span> to see an example of an installer using Authorization Services.</p><p>See <span class="content_text"><a href="http://developer.apple.com/samplecode/Sample_Code/Security.htm" target="_top">http://developer.apple.com/samplecode/Sample_Code/Security.htm</a></span> for sample applications that perform system-restricted privileged operations.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-BCIGEHDI" title="Authorizing in a Simple, Self-Restricted Application"></a><h2>Authorizing in a Simple, Self-Restricted Application</h2><p>A simple, self-restricted application uses Authorization Services to perform the tasks described in the following sections:</p><ul class="ul"><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCHCEEG">“Creating an Authorization Reference Without Rights”</a></span></p></li><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCBDFBB">“Requesting Authorization”</a></span></p></li><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCFHGBH">“Releasing an Authorization Reference”</a></span></p></li></ul><a name="//apple_ref/doc/uid/TP30000995-CH206-BBCHCEEG" title="Creating an Authorization Reference Without Rights"></a><h3>Creating an Authorization Reference Without Rights</h3><p>The Security Server uses the authorization reference to access the state of the authorization session, which includes any stored credentials. Your application needs only one authorization reference.</p><p>You use the <code>AuthorizationCreate</code> function to allocate memory for the authorization reference. The code fragment in <span class="content_text">Listing 2-1</span> shows a call to the <code>AuthorizationCreate</code> function that creates an authorization reference without rights. An authorization reference without rights is useful if the rights are not needed immediately, but the authorization reference is required so it can be used in different parts of the application. For example, in the grades-and-transcripts application, the authorization reference might be created when the application starts, but rights aren’t requested until the user attempts to create transcripts.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000995-CH206-DontLinkElementID_6" title="Note"></a><p><strong>Note:</strong>&nbsp; Although you can create an authorization reference and assign rights in one call, keep in mind that if authorization is denied, the reference is not created and subsequent attempts to use it will fail. Therefore, it is often preferable to create the authorization reference without rights, as shown in <span class="content_text">Listing 2-1</span>, and then call the <code><a href="../../../Reference/authorization_ref/Reference/reference.html#//apple_ref/doc/c_ref/AuthorizationCopyRights" target="_top">AuthorizationCopyRights</a></code> function later to determine or change the rights, as shown in <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCBDFBB">“Requesting Authorization.”</a></span></p></div><a name="//apple_ref/doc/uid/TP30000995-CH206-BBCHHCDB" title="Listing 2-1Creating an authorization reference without rights"></a><p class="codesample"><strong>Listing 2-1&nbsp;&nbsp;</strong>Creating an authorization reference without rights</p><div class="codesample"><table><tr><td scope="row"><pre>AuthorizationRef myAuthorizationRef;<span></span></pre></td></tr><tr><td scope="row"><pre>OSStatus myStatus;<span></span></pre></td></tr><tr><td scope="row"><pre>myStatus = AuthorizationCreate (NULL, kAuthorizationEmptyEnvironment,<span></span></pre></td></tr><tr><td scope="row"><pre>            kAuthorizationFlagDefaults, &amp;myAuthorizationRef);<span></span></pre></td></tr></table></div><p>The <code>AuthorizationCreate</code> function takes four parameters. The first is an authorization rights set. Since <code>NULL</code> is passed, no rights are authorized at this time. The second parameter is the authorization environment, which is not currently implemented; pass <code>kAuthorizationEmptyEnvironment</code>. The third parameter is the authorization options. The constant <code>kAuthorizationFlagDefaults</code> is passed because the application is not requesting any rights. The fourth parameter is the address of the authorization reference you declared. On return, the authorization reference refers to the current authorization session. If the authorization reference is created successfully, the function returns <code>errAuthorizationSuccess</code>.</p><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCBDFBB">“Requesting Authorization”</a></span> describes how to use the <code>AuthorizationCopyRights</code> and <code>AuthorizationCreate</code> functions to request authorization. When your application is done with the authorization reference, use the <code>AuthorizationFree</code> function as described in <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCFHGBH">“Releasing an Authorization Reference.”</a></span></p><a name="//apple_ref/doc/uid/TP30000995-CH206-BBCBDFBB" title="Requesting Authorization"></a><h3>Requesting Authorization</h3><p>After you create an authorization reference, you can then request authorization. Your application should perform authorization immediately before every privileged operation. In the case of the grades-and-transcripts example, the application requests authorization immediately before creating a transcript.</p><p>When your application requests authorization, the Security Server may request the user to authenticate. Authorization Services allows you to take full advantage of the Security Server’s authentication plug-in architecture to deal with authentication for you. Instead of a user name and password, the authentication may use fingerprints or smart cards, but your application code stays the same.</p><p><span class="content_text"><a href="../02authconcepts/authconcepts.html#//apple_ref/doc/uid/TP30000995-CH205-BAJHACIF">Figure 1-3</a></span> shows the authentication dialog that the Security Server provides. The user enters an administrator user name and password and clicks OK. The Security Server then uses the user name and password to authenticate and authorize the user.</p><p>Authorization requires the creation of an authorization rights set and authorization options to use in a call to the functions <code>AuthorizationCopyRights</code> or <code>AuthorizationCreate</code>. In your application, request authorization by performing the tasks described in the following sections:</p><ul class="spaceabove"><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF11">“Creating an Authorization Rights Set”</a></span></p></li><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCEICAI">“Specifying Authorization Options ”</a></span></p></li><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF12">“Authorizing”</a></span></p></li><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF13">“Releasing an Authorization Item Array”</a></span></p></li></ul><a name="//apple_ref/doc/uid/TP30000995-CH206-TPXREF11" title="Creating an Authorization Rights Set"></a><h4>Creating an Authorization Rights Set</h4><p>To authorize a user for specific rights, you must create an authorization rights set to pass to the Security Server through the <code>AuthorizationCopyRights</code> or <code>AuthorizationCreate</code> functions. The authorization rights set consists of an authorization item array and the number of items in the authorization item array. The authorization item array contains information about the rights that your application is requesting. </p><p>Each item in the authorization item array consists of four pieces of information: </p><ul class="spaceabove"><li class="li"><p>The name of the right</p></li><li class="li"><p>A value that contains optional data pertaining to the right</p></li><li class="li"><p>The byte length of the <code>value</code> field</p></li><li class="li"><p>Optional flags</p></li></ul><p><span class="content_text">Listing 2-2</span> shows an example of an authorization item array. In most cases, when creating an item for a right, you set the <code>value</code> field to <code>NULL</code>, and the <code>valuelength</code> and <code>flags</code> fields to <code>0</code>. You should set the <code>name</code> field to the name of the right you are requesting. For information on naming your own rights, see <span class="content_text"><a href="../02authconcepts/authconcepts.html#//apple_ref/doc/uid/TP30000995-CH205-TPXREF16">“Rights.”</a></span></p><a name="//apple_ref/doc/uid/TP30000995-CH206-BCIHHFEA" title="Listing 2-2Creating an authorization item array"></a><p class="codesample"><strong>Listing 2-2&nbsp;&nbsp;</strong>Creating an authorization item array</p><div class="codesample"><table><tr><td scope="row"><pre>AuthorizationItem myItems[2];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>myItems[0].name = "com.myOrganization.myProduct.myRight1";<span></span></pre></td></tr><tr><td scope="row"><pre>myItems[0].valueLength = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>myItems[0].value = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>myItems[0].flags = 0;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>myItems[1].name = "com.myOrganization.myProduct.myRight2";<span></span></pre></td></tr><tr><td scope="row"><pre>myItems[1].valueLength = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>myItems[1].value = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>myItems[1].flags = 0;<span></span></pre></td></tr></table></div><p>For example, a grades-and-transcripts application might request the right <code>com.myOrganization.myProduct.transcripts.create</code>. The <code>valueLength</code>, <code>value</code>, and <code>flags</code> fields would be unused and set to <code>0</code>, <code>NULL</code>, and 0, respectively.</p><p><span class="content_text">Listing 2-3</span> shows an example of an authorization rights set. In the authorization rights set, the <code>count</code> field contains the number of rights in the authorization item array, while the <code>items</code> field points to the authorization item array you created.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-BCIDBFGD" title="Listing 2-3Creating a set of authorization rights"></a><p class="codesample"><strong>Listing 2-3&nbsp;&nbsp;</strong>Creating a set of authorization rights</p><div class="codesample"><table><tr><td scope="row"><pre>AuthorizationRights myRights;<span></span></pre></td></tr><tr><td scope="row"><pre>myRights.count = sizeof (myItems) / sizeof (myItems[0]);<span></span></pre></td></tr><tr><td scope="row"><pre>myRights.items = myItems;<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000995-CH206-BBCEICAI" title="Specifying Authorization Options "></a><h4>Specifying Authorization Options </h4><p>You use the authorization options to instruct the Security Server how to proceed with the <code>AuthorizationCopyRights</code> and <code>AuthorizationCreate</code> functions. By setting the authorization options, you can use these functions to</p><ul class="spaceabove"><li class="li"><p>Authorize partial rights</p></li><li class="li"><p>Authorize all rights</p></li><li class="li"><p>Preauthorize rights</p></li></ul><p>You can include with these options the option to interact with the user. The Security Server requires user interaction to perform authentication. The most common combination authorizes all rights and allows user interaction. <span class="content_text">Listing 2-4</span> shows an example of the authorization options for authorization.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-BBCEGHAJ" title="Listing 2-4Specifying authorization options for authorization"></a><p class="codesample"><strong>Listing 2-4&nbsp;&nbsp;</strong>Specifying authorization options for authorization</p><div class="codesample"><table><tr><td scope="row"><pre>AuthorizationFlags myFlags;<span></span></pre></td></tr><tr><td scope="row"><pre>myFlags = kAuthorizationFlagDefaults |<span></span></pre></td></tr><tr><td scope="row"><pre>            kAuthorizationFlagInteractionAllowed |<span></span></pre></td></tr><tr><td scope="row"><pre>            kAuthorizationFlagExtendRights;<span></span></pre></td></tr></table></div><p>The <code>kAuthorizationFlagDefaults</code> constant zeros the bit mask. The <code>kAuthorizationFlagExtendRights</code> constant instructs the Security Server to grant the rights. Without this flag, the <code>AuthorizationCopyRights</code> and <code>AuthorizationCreate</code> functions would return the appropriate error code, but no rights would be extended to the user.</p><p>If your application does not require all of the rights to be authorized, you can include the <code>kAuthorizationFlagPartialRights</code> constant to request partial authorization. You can then determine what to allow the user to do based on which rights the Security Server grants. <span class="content_text">Listing 2-5</span> shows an example of setting the authorization options for partial authorization.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-BCIGDDIH" title="Listing 2-5Specifying authorization options for partial authorization"></a><p class="codesample"><strong>Listing 2-5&nbsp;&nbsp;</strong>Specifying authorization options for partial authorization</p><div class="codesample"><table><tr><td scope="row"><pre>myFlags = kAuthorizationFlagDefaults |<span></span></pre></td></tr><tr><td scope="row"><pre>            kAuthorizationFlagInteractionAllowed |<span></span></pre></td></tr><tr><td scope="row"><pre>            kAuthorizationFlagExtendRights |<span></span></pre></td></tr><tr><td scope="row"><pre>            kAuthorizationFlagPartialRights;<span></span></pre></td></tr></table></div><p>See <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BCIEGFID">“Requesting Preauthorization”</a></span> to learn what authorization options to set for preauthorization.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-TPXREF12" title="Authorizing"></a><h4>Authorizing</h4><p>The code fragment in <span class="content_text">Listing 2-6</span> shows a call to the <code>AuthorizationCopyRights</code> function based on the authorization reference and authorization rights set you created and the authorization options you specified. In the grades-and-transcripts example, the <code>AuthorizationCopyRights</code> function is used to authorize the right to create a transcript.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-TPXREF37" title="Listing 2-6Authorizing rights"></a><p class="codesample"><strong>Listing 2-6&nbsp;&nbsp;</strong>Authorizing rights</p><div class="codesample"><table><tr><td scope="row"><pre>myStatus = AuthorizationCopyRights (myAuthorizationRef, &amp;myRights,<span></span></pre></td></tr><tr><td scope="row"><pre>        kAuthorizationEmptyEnvironment, myFlags, NULL);<span></span></pre></td></tr></table></div><p>The first parameter is the authorization reference created in <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCHCEEG">“Creating an Authorization Reference Without Rights.”</a></span> The second parameter is the authorization rights set created in <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF11">“Creating an Authorization Rights Set.”</a></span> The third parameter is the authorization environment. The authorization environment is not currently implemented, so pass <code>kAuthorizationEmptyEnvironment</code>. The fourth parameter is the authorization options set in <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCEICAI">“Specifying Authorization Options .”</a></span></p><p>The fifth parameter is useful when authorizing partial rights as shown in <span class="content_text">Listing 2-7</span>. This parameter points to an empty authorized rights set you declare. On return, this consists of the rights that the Security Server actually authorizes. If you create a pointer to an authorized rights set, then you should release it as described in <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF13">“Releasing an Authorization Item Array.”</a></span></p><a name="//apple_ref/doc/uid/TP30000995-CH206-BCIGCGCD" title="Listing 2-7Authorizing partial rights"></a><p class="codesample"><strong>Listing 2-7&nbsp;&nbsp;</strong>Authorizing partial rights</p><div class="codesample"><table><tr><td scope="row"><pre>AuthorizationRights *myAuthorizedRights;<span></span></pre></td></tr><tr><td scope="row"><pre>myStatus = AuthorizationCopyRights (myAuthorizationRef, &amp;myRights,<span></span></pre></td></tr><tr><td scope="row"><pre>            kAuthorizationEmptyEnvironment, myFlags,<span></span></pre></td></tr><tr><td scope="row"><pre>            &amp;myAuthorizedRights);<span></span></pre></td></tr></table></div><p>The <code>AuthorizationCopyRights</code> function returns <code>errAuthorizationSuccess</code> if the Security Server grants all the rights. You can use the return status to determine whether the user may perform the privileged operation.</p><p>You can use an authorization rights set and authorization options to request authorization when you create an authorization reference. </p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000995-CH206-DontLinkElementID_7" title="Note"></a><p><strong>Note:</strong>&nbsp; Although you can create an authorization reference and assign rights in one call, as shown in <span class="content_text">Listing 2-8</span>, keep in mind that if authorization is denied, the reference is not created and subsequent attempts to use it will fail. Therefore, it is often preferable to create the authorization reference without rights, as shown in <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCHHCDB">Listing 2-1</a></span>, and then call the <code><a href="../../../Reference/authorization_ref/Reference/reference.html#//apple_ref/doc/c_ref/AuthorizationCopyRights" target="_top">AuthorizationCopyRights</a></code> function later to determine or change the rights, as shown in the preceding code samples in this section.</p></div><p><span class="content_text">Listing 2-8</span> shows an example combining authorization with the <code>AuthorizationCreate</code> function.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-BCIFFDGB" title="Listing 2-8Creating an authorization reference with rights"></a><p class="codesample"><strong>Listing 2-8&nbsp;&nbsp;</strong>Creating an authorization reference with rights</p><div class="codesample"><table><tr><td scope="row"><pre>myStatus = AuthorizationCreate (&amp;myRights, kAuthorizationEmptyEnvironment,<span></span></pre></td></tr><tr><td scope="row"><pre>            myFlags, &amp;myAuthorizationRef);<span></span></pre></td></tr></table></div><p>You can also use the <code>AuthorizationCreate</code> function to authorize a user for a one-time privileged operation. One-time authorization is useful if your application needs to authorize only once when it is run. <span class="content_text">Listing 2-9</span> shows an example of how to use an authorization rights set and authorization options with the <code>AuthorizationCreate</code> function without producing an authorization reference. Pass <code>NULL</code> instead of an authorization reference.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-BCIGIDID" title="Listing 2-9A one-time authorization call"></a><p class="codesample"><strong>Listing 2-9&nbsp;&nbsp;</strong>A one-time authorization call</p><div class="codesample"><table><tr><td scope="row"><pre>myStatus = AuthorizationCreate (&amp;myRights, kAuthorizationEmptyEnvironment,<span></span></pre></td></tr><tr><td scope="row"><pre>            myFlags, NULL);<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000995-CH206-TPXREF13" title="Releasing an Authorization Item Array"></a><h4>Releasing an Authorization Item Array</h4><p>When you finish with the authorization item set in <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BCIGCGCD">Listing 2-7</a></span>, call the <code>AuthorizationFreeItemSet</code> function, as shown in <span class="content_text">Listing 2-10</span>, to release the memory it uses. Use this function only on authorization item arrays that the Security Server allocates, such as those used in the <code>AuthorizationCopyRights</code> and <code>AuthorizationCopyInfo</code> functions.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-TPXREF24" title="Listing 2-10Releasing an authorization item array"></a><p class="codesample"><strong>Listing 2-10&nbsp;&nbsp;</strong>Releasing an authorization item array</p><div class="codesample"><table><tr><td scope="row"><pre>myStatus = AuthorizationFreeItemSet (myAuthorizedRights);<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000995-CH206-BBCFHGBH" title="Releasing an Authorization Reference"></a><h3>Releasing an Authorization Reference</h3><p>Before exiting your application, or at any time you want to end the current authorization session, call the <code>AuthorizationFree</code> function to release the authorization reference. For example, the grades-and-transcripts application would wait until the user quits the application before releasing the authorization reference. Using the same authorization reference every time the user creates a transcript allows the Security Server to reuse any shared credentials that haven’t expired. In contrast, an action such as the user clicking the open-lock button in the Network preferences pane can trigger the release of the authorization reference, requiring the user to reauthorize when she clicks the closed-lock button.</p><p>The code segment in <span class="content_text">Listing 2-11</span> shows an example of using the <code>AuthorizationFree</code> function. You must pass the authorization reference and authorization options. For authorization options, pass the constant <code>kAuthorizationFlagDefaults</code> if you want to revoke the credentials associated with the current process, or pass the constant <code>kAuthorizationFlagDestroyRights</code> to release all shared credentials from all processes that use them.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-BBCEGAFD" title="Listing 2-11Releasing an authorization reference"></a><p class="codesample"><strong>Listing 2-11&nbsp;&nbsp;</strong>Releasing an authorization reference</p><div class="codesample"><table><tr><td scope="row"><pre>myStatus = AuthorizationFree (myAuthorizationRef,<span></span></pre></td></tr><tr><td scope="row"><pre>            kAuthorizationFlagDestroyRights);<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000995-CH206-BCIGAIAG" title="Authorizing in a Factored Application"></a><h2>Authorizing in a Factored Application</h2><p>Factored applications, whether system-restricted or self-restricted, use an application to control the graphical user interface and nonprivileged operations and use a separate helper tool to perform the privileged operations.</p><p>Read <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF35">“Using Authorization Services in a Factored Application”</a></span> for a description of using Authorization Services in a factored application and <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF36">“Using Authorization Services in a Helper Tool”</a></span> for a description of using Authorization Services in a helper tool.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-TPXREF35" title="Using Authorization Services in a Factored Application"></a><h3>Using Authorization Services in a Factored Application</h3><p>You can use Authorization Services in your factored application to perform the tasks described in the following sections:</p><ul class="spaceabove"><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BCIGJBII">“Creating an Authorization Reference”</a></span></p></li><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BCIEGFID">“Requesting Preauthorization”</a></span></p></li><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF14">“Creating an External Authorization Reference”</a></span></p></li><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF28">“Calling a Helper Tool”</a></span></p></li><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BCIJGBHF">“Releasing an Authorization Reference”</a></span></p></li></ul><p>An example of a factored application is one that restarts the Internet daemon. The application performs all the nonprivileged operations while the helper tool restarts the daemon. The application creates an authorization reference and preauthorizes the right to restart the Internet daemon. The application uses the result to determine whether to start the helper tool. The application creates an external version of the authorization reference and passes it to the helper tool. When the authorization reference is no longer needed, the application releases it.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-BCIGJBII" title="Creating an Authorization Reference"></a><h4>Creating an Authorization Reference</h4><p>Creating an authorization reference in a factored application is the same as in a simple, self-restricting application. See <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCHCEEG">“Creating an Authorization Reference Without Rights”</a></span> to learn how to create an authorization reference.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-BCIEGFID" title="Requesting Preauthorization"></a><h4>Requesting Preauthorization</h4><p>You should preauthorize rights before calling a helper tool. Using the results of preauthorization, you can prevent an unauthorized user from invoking the helper tool. Doing so saves the time of starting a new process and using resources as well as saving the user from preparing to perform an operation he doesn’t have privileges to perform.</p><p>Preauthorization requires the creation of an authorization rights set and authorization options to use in a call to the functions <code>AuthorizationCopyRights</code> or <code>AuthorizationCreate</code>. In your application, you preauthorize a user by performing the steps described in the following sections:</p><ul class="spaceabove"><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCHFEFD">“Creating a Preauthorization Rights Set”</a></span></p></li><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF9">“Specifying Authorization Options for Preauthorization”</a></span></p></li><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BCIGGGEG">“Preauthorizing”</a></span></p></li></ul><a name="//apple_ref/doc/uid/TP30000995-CH206-BBCHFEFD" title="Creating a Preauthorization Rights Set"></a><h5>Creating a Preauthorization Rights Set</h5><p>A preauthorization rights set is the same as an authorization rights set as described in <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF11">“Creating an Authorization Rights Set.”</a></span></p><a name="//apple_ref/doc/uid/TP30000995-CH206-TPXREF9" title="Specifying Authorization Options for Preauthorization"></a><h5>Specifying Authorization Options for Preauthorization</h5><p>Authorization options for preauthorization are similar to the authorization options for authorization and partial authorization described in <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCEICAI">“Specifying Authorization Options .”</a></span> The only difference between preauthorization and authorization is that you are not using the result to determine if a user can perform a privileged operation. Instead, you should use the result to determine if the user can be authorized at a later time.</p><p><span class="content_text">Listing 2-12</span> shows an example of setting the authorization options for preauthorization. The <code>kAuthorizationFlagDefaults</code> constant zeros out the bit mask. The <code>kAuthorizationFlagExtendRights</code> constant tells the Security Server to extend any rights granted to the user. The <code>kAuthorizationFlagInteractionAllowed</code> constant tells the Security Server that it may interact with the user for authentication purposes. The <code>kAuthorizationFlagPreAuthorize</code> constant tells the Security Server to preauthorize the rights requested.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-BBCFDIED" title="Listing 2-12Specifying authorization options for preauthorization"></a><p class="codesample"><strong>Listing 2-12&nbsp;&nbsp;</strong>Specifying authorization options for preauthorization</p><div class="codesample"><table><tr><td scope="row"><pre>AuthorizationFlags myFlags;<span></span></pre></td></tr><tr><td scope="row"><pre>myFlags = kAuthorizationFlagDefaults |<span></span></pre></td></tr><tr><td scope="row"><pre>            kAuthorizationFlagExtendRights |<span></span></pre></td></tr><tr><td scope="row"><pre>            kAuthorizationFlagInteractionAllowed |<span></span></pre></td></tr><tr><td scope="row"><pre>            kAuthorizationFlagPreAuthorize;<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000995-CH206-BCIGGGEG" title="Preauthorizing"></a><h5>Preauthorizing</h5><p>Calling the <code>AuthorizationCopyRights</code> or <code>AuthorizationCreate</code> function is the same for preauthorization as it is for authorization. See <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF37">Listing 2-6</a></span> in the section <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF12">“Authorizing”</a></span> for examples.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-TPXREF14" title="Creating an External Authorization Reference"></a><h4>Creating an External Authorization Reference</h4><p>After creating the authorization reference and preauthorizing rights, you need to pass the authorization reference to your helper tool. Sharing the authorization reference allows the helper tool to use any credentials that are part of the factored application’s authorization session. When you pass the authorization reference to your helper tool, the authorization dialog can show your application’s path rather than the path to the helper tool. It also enables the system to determine whether the authorization dialog should have keyboard focus.</p><p>One problem with the authorization reference is that it is not in a form that can be transferred from one process to another. To solve this problem, Authorization Services provides a function to translate the authorization reference into an external authorization reference that you can pass to your helper tool.</p><p>To create an external authorization reference, declare a variable of type <code>AuthorizationExternalForm</code> and pass it to the <code>AuthorizationMakeExternalForm</code> function along with the existing authorization reference. On return, <code>AuthorizationExternalForm</code> is a transferable form of the authorization reference. <span class="content_text">Listing 2-13</span> shows an example of creating an external authorization reference.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-BBCEBFGG" title="Listing 2-13Creating an external authorization reference"></a><p class="codesample"><strong>Listing 2-13&nbsp;&nbsp;</strong>Creating an external authorization reference</p><div class="codesample"><table><tr><td scope="row"><pre>AuthorizationExternalForm myExternalAuthorizationRef;<span></span></pre></td></tr><tr><td scope="row"><pre>myStatus = AuthorizationMakeExternalForm (myAuthorizationRef,<span></span></pre></td></tr><tr><td scope="row"><pre>            &amp;myExternalAuthorizationRef);<span></span></pre></td></tr></table></div><p>Read <code><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF16">“Retrieving an Authorization Reference”</a></code> to learn how to retrieve the authorization reference from the external authorization reference in your helper tool.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-TPXREF28" title="Calling a Helper Tool"></a><h4>Calling a Helper Tool</h4><p>When you are ready to call your helper tool, pass the external authorization reference to the tool using some form of interprocess communication, such as a communications pipe. For a sample application and self-repairing helper tool, see <span class="content_text"><a href="http://developer.apple.com/samplecode/Sample_Code/Security.htm" target="_top">http://developer.apple.com/samplecode/Sample_Code/Security.htm</a></span>. For more information on interprocess communications, see <em>Inside Mac OS X: System Overview</em>.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-BCIJGBHF" title="Releasing an Authorization Reference"></a><h4>Releasing an Authorization Reference</h4><p>Releasing the authorization reference in a factored application is the same as described in <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCFHGBH">“Releasing an Authorization Reference.”</a></span></p><a name="//apple_ref/doc/uid/TP30000995-CH206-TPXREF36" title="Using Authorization Services in a Helper Tool"></a><h3>Using Authorization Services in a Helper Tool</h3><p>You can use Authorization Services in your helper tool to perform the tasks described in the following sections:</p><ul class="spaceabove"><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF16">“Retrieving an Authorization Reference”</a></span></p></li><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BCIDACGI">“Performing Authorization”</a></span></p></li><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BCICEJFB">“Executing the Privileged Operation”</a></span></p></li></ul><p>For example, a helper tool that restarts the Internet daemon retrieves the authorization reference from the external authorization reference passed by the application. Then the helper tool requests authorization immediately before restarting the Internet daemon.</p><p>If your helper tool is actually a self-repairing helper tool, you should also read <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF29">“Repairing a Helper Tool.”</a></span></p><a name="//apple_ref/doc/uid/TP30000995-CH206-TPXREF16" title="Retrieving an Authorization Reference"></a><h4>Retrieving an Authorization Reference</h4><p>To share the authorization session, the factored application passes an external authorization reference to the helper tool (see <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF14">“Creating an External Authorization Reference”</a></span>). In the helper tool, you use the <code>AuthorizationCreateFromExternalForm</code> function to retrieve an authorization reference from the external authorization reference.</p><p><span class="content_text">Listing 2-14</span> shows an example using the <code>AuthorizationCreateFromExternalForm</code> function. In this example, the external authorization reference is read in from a communications pipe between the helper tool process and the parent process. You then pass the external authorization reference to the function <code>AuthorizationCreateFromExternalForm</code>. On return, <code>myAuthorizationRef</code> is the authorization reference.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-TPXREF25" title="Listing 2-14Retrieving an authorization reference"></a><p class="codesample"><strong>Listing 2-14&nbsp;&nbsp;</strong>Retrieving an authorization reference</p><div class="codesample"><table><tr><td scope="row"><pre>AuthorizationRef myAuthorizationRef;<span></span></pre></td></tr><tr><td scope="row"><pre>AuthorizationExternalForm myExternalAuthorizationRef;<span></span></pre></td></tr><tr><td scope="row"><pre>OSStatus myStatus;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/* *** You should read in the external authorization reference into<span></span></pre></td></tr><tr><td scope="row"><pre>        myExternalAuthorizationRef here. *** */<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>myStatus = AuthorizationCreateFromExternalForm (&amp;myExternalAuthorizationRef,<span></span></pre></td></tr><tr><td scope="row"><pre>            &amp;myAuthorizationRef);<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000995-CH206-BCIDACGI" title="Performing Authorization"></a><h4>Performing Authorization</h4><p>Performing authorization in your helper tool is the same as it is for simple, self-restricted applications. See <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCBDFBB">“Requesting Authorization”</a></span> for more information.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-BCICEJFB" title="Executing the Privileged Operation"></a><h4>Executing the Privileged Operation</h4><p>You should use the result of the authorization to determine whether the user is allowed to perform the privileged operation. There are no Authorization Services functions required for actually executing the privileged operation.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-TPXREF29" title="Repairing a Helper Tool"></a><h4>Repairing a Helper Tool</h4><div class="importantbox"><a name="//apple_ref/doc/uid/TP30000995-CH206-DontLinkElementID_8" title="Important:"></a><p><strong>Important:</strong>&nbsp;For a newer and more secure alternative to the approach documented here, see the sample code in Better Authorization Sample (<em><a href="../../../../../samplecode/BetterAuthorizationSample/index.html#//apple_ref/doc/uid/DTS10004207" target="_top">BetterAuthorizationSample</a></em>), which uses the launchd daemon to launch the helper tool rather than setting the setuid bit.</p><p></p></div><p>If your helper tool needs to run as root to perform privileged operations, such as restarting the Internet daemon, then it should have its setuid bit set. Tools that have the setuid bit set (sometimes referred to as <em>setuid tools</em>) must be Mach-O binaries because CFM binaries don’t support the setuid or setgid (set group identifier) bit. When you install your program, your installer should set the helper tool’s setuid bit, and set its owner to root.</p><p>In Mac OS X v10.1 and earlier, when a user moves a setuid tool to another volume, or copies it from one place to another, the setuid bit is reset by the file system and the group and owner change to match the user moving the setuid tool. This is done purposely to reduce the security risk that a setuid tool poses by allowing any user to run the setuid tool as root. On the other hand, most users expect that when they copy an application or tool from one folder to another, it will still work. Thus, the setuid bit, group, and owner need to be reset without editing the permissions in the terminal window. This section provides code to allow your setuid tool to repair its own setuid bit when this problem occurs.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000995-CH206-DontLinkElementID_9" title="Note"></a><p><strong>Note:</strong>&nbsp;In Mac OS X v10.1, setuid tools that are copied or moved lose their setuid bit. and the owner and group are changed to match the permissions of the user performing the action. In later releases, users can move setuid tools and preserve the permission set.</p></div><p>All setuid tools are potential security problems. This case poses a particular problem because the tool self-repairs its setuid bit even if a user tampers with the setuid tool’s code. As added security, you might want to display a warning to users whenever performing this action so they can decide to continue or cancel the self-repair operation, or possibly force the user to reinstall the application from the installer.</p><p>You can repair the setuid bit on your helper tool by performing the tasks described in the following sections:</p><ul class="spaceabove"><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF18">“Calling a Helper Tool as Root”</a></span></p></li><li class="li"><p><span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BCIIEHJB">“Setting the Setuid Bit”</a></span></p></li></ul><a name="//apple_ref/doc/uid/TP30000995-CH206-TPXREF18" title="Calling a Helper Tool as Root"></a><h5>Calling a Helper Tool as Root</h5><p>For your helper tool to set its own setuid bit, the tool must have root privileges. This is a circular problem, since you can’t change permissions on your helper tool unless your helper tool is already running as root. This is where the function <code>AuthorizationExecuteWithPrivileges</code> comes into play.</p><p>The <code>AuthorizationExecuteWithPrivileges</code> function executes any application as root through a special security process. The code sample in <span class="content_text">Listing 2-15</span> demonstrates how a helper tool can recursively call itself with root privileges so it can repair its own setuid bit.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000995-CH206-DontLinkElementID_10" title="Note"></a><p><strong>Note:</strong>&nbsp;The <code>AuthorizationExecuteWithPrivileges</code> function sets only the effective user ID (EUID) of the tool to root. The real user ID (RUID) of the tool is that of the caller.</p></div><div class="importantbox"><a name="//apple_ref/doc/uid/TP30000995-CH206-DontLinkElementID_11" title="Important:"></a><p><strong>Important:</strong>&nbsp;Because of the security risk, calling the <code>AuthorizationExecuteWithPrivileges</code> function is recommended only for special and infrequent use such as repairing setuid bits and installing your application. In the most secure computer systems, the right this function requests times out immediately so every time you call it, the user must authenticate.</p><p></p></div><a name="//apple_ref/doc/uid/TP30000995-CH206-TPXREF26" title="Listing 2-15Executing a helper tool with root privileges"></a><p class="codesample"><strong>Listing 2-15&nbsp;&nbsp;</strong>Executing a helper tool with root privileges</p><div class="codesample"><table><tr><td scope="row"><pre>FILE *myCommunicationsPipe = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>char *myArguments[] = {"--self-repair", NULL};<span></span></pre></td></tr><tr><td scope="row"><pre>char myPath[MAXPATHLEN];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/* *** You should determine the path of your tool here and put the result in<span></span></pre></td></tr><tr><td scope="row"><pre>        myPath. *** */<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>myStatus = AuthorizationExecuteWithPrivileges (myAuthorizationRef,<span></span></pre></td></tr><tr><td scope="row"><pre>            myPath, kAuthorizationFlagDefaults, myArguments,<span></span></pre></td></tr><tr><td scope="row"><pre>            &amp;myCommunicationsPipe);<span></span></pre></td></tr></table></div><p>The <code>AuthorizationExecuteWithPrivileges</code> function expects you to pass five parameters. The first parameter is the authorization reference you retrieved as shown in <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF16">“Retrieving an Authorization Reference.”</a></span> The authorization reference allows the helper tool to use any credentials that are part of the factored application’s authorization session. The second parameter is the full POSIX pathname of the helper tool—in this case, the setuid tool—that is being called. The third parameter is the authorization options. In this function, this parameter is not implemented, so for now, set it to <code>kAuthorizationFlagDefaults</code>. The fourth parameter is a null-terminated array of arguments for the tool being called. You can use this parameter to pass any information you need from the parent process to the child process. In this case, the string <code>"--self-repair"</code> is passed to indicate to the helper tool that it should execute the code in <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BCIEJHHE">Listing 2-16</a></span>. The fifth parameter is a communications pipe so the helper tool can pass the data it received from the factored application to itself.</p><div class="importantbox"><a name="//apple_ref/doc/uid/TP30000995-CH206-DontLinkElementID_12" title="Important:"></a><p><strong>Important:</strong>&nbsp;You may be tempted to use the function <code>AuthorizationExecuteWithPrivileges</code> to perform privileged operations rather than creating and calling your own setuid tool. Although this might seem like an easy solution, using the <code>AuthorizationExecuteWithPrivileges</code> function without the rest of the Authorization Services functions produces a severe security hole because the function indiscriminately runs any tool as the root user. Setuid tools also have security risks, but they are far less severe than using the function <code>AuthorizationExecuteWithPrivileges</code> for purposes other than those described in this document. Read <span class="content_text"><a href="../02authconcepts/authconcepts.html#//apple_ref/doc/uid/TP30000995-CH205-TPXREF22">“Factored Applications”</a></span> for instructions on creating your own helper tool.</p><p></p></div><a name="//apple_ref/doc/uid/TP30000995-CH206-BCIIEHJB" title="Setting the Setuid Bit"></a><h5>Setting the Setuid Bit</h5><p>In <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF26">Listing 2-15</a></span>, the helper tool recursively calls itself, passing the self-repair argument, <code>--self-repair</code>. Therefore, in the same helper tool, you need to check for the self-repair argument and, if it is found, fix the setuid bit. See the More Is Better sample code (<em><a href="../../../../../samplecode/MoreIsBetter/index.html#//apple_ref/doc/uid/DTS10000732" target="_top">MoreIsBetter</a></em>) for a sample self-repairing setuid tool.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000995-CH206-DontLinkElementID_13" title="Note"></a><p><strong>Note:</strong>&nbsp; The purpose of the self-repair code in the helper tool discussed here is to allow the tool to execute as root after the user has moved or copied the tool, even if the file system has reset the setuid bit and changed the owner and group to match the permissions of the user performing the action. This self-repair code (that is, the call to the <code>AuthorizationExecuteWithPrivileges</code> function) works if the setuid bit has been cleared, whether the tool is owned by root or by the user. If the tool has the setuid bit set and is owned by root, the self-repair code is not called. However, if the setuid bit is set and the tool is owned by the user, the call to the <code>AuthorizationExecuteWithPrivileges</code> function fails because the setuid bit is respected in this case and the tool executes with the user’s privileges rather than root privileges. If you want your self-repairing helper tool to handle this unlikely circumstance, you need to add code to clear the setuid bit before you call the self-repair code.</p></div><p>When you call the <code>AuthorizationExecuteWithPrivileges</code> function, you need a way to retrieve the authorization reference that is passed in the call. <span class="content_text">Listing 2-16</span> shows code using the <code>AuthorizationCopyPrivilegedReference</code> function to retrieve the authorization reference. The only time you use this function is to retrieve an authorization reference passed by a call to <code>AuthorizationExecuteWithPrivileges</code>.</p><p>The first parameter of the call to the <code>AuthorizationCopyPrivilegedReference</code> function is an empty authorization reference you declare. You should not call the <code>AuthorizationCreate</code> function. On return, the authorization reference points to a copy of the original authorization reference. The second parameter is not implemented, so set it to <code>kAuthorizationFlagDefaults</code>.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-BCIEJHHE" title="Listing 2-16Setting the setuid bit"></a><p class="codesample"><strong>Listing 2-16&nbsp;&nbsp;</strong>Setting the setuid bit</p><div class="codesample"><table><tr><td scope="row"><pre>myStatus = AuthorizationCopyPrivilegedReference (&amp;myAuthorizationRef,<span></span></pre></td></tr><tr><td scope="row"><pre>            kAuthorizationFlagDefaults)<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000995-CH206-TPXREF33" title="Calling a Privileged Installer"></a><h2>Calling a Privileged Installer</h2><p>Occasionally, an installer must install files in directories that are not owned by the user running the installer. This should be a rare case and you should avoid it if at all possible. In the event that it can’t be avoided, the code in <span class="content_text">Listing 2-17</span> shows a tool that runs the <code>/usr/bin/id</code> utility with optional flag <code>-un</code>. By replacing the utility path and including your own flags, you can use this sample code to call your installer with root privileges. Your installer will then be able to perform any privileged operations it requires.</p><a name="//apple_ref/doc/uid/TP30000995-CH206-BCIIFGID" title="Listing 2-17Calling a privileged installer"></a><p class="codesample"><strong>Listing 2-17&nbsp;&nbsp;</strong>Calling a privileged installer</p><div class="codesample"><table><tr><td scope="row"><pre>#include &lt;Security/Authorization.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;Security/AuthorizationTags.h><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>int read (long,StringPtr,int);<span></span></pre></td></tr><tr><td scope="row"><pre>int write (long,StringPtr,int);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>int main() {<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus myStatus;<span></span></pre></td></tr><tr><td scope="row"><pre>    AuthorizationFlags myFlags = kAuthorizationFlagDefaults;              <span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    AuthorizationRef myAuthorizationRef;                                  <span>// 2</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    myStatus = AuthorizationCreate(NULL, kAuthorizationEmptyEnvironment,  <span>// 3</span></pre></td></tr><tr><td scope="row"><pre>                myFlags, &amp;myAuthorizationRef);<span></span></pre></td></tr><tr><td scope="row"><pre>    if (myStatus != errAuthorizationSuccess)<span></span></pre></td></tr><tr><td scope="row"><pre>        return myStatus;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    do<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            AuthorizationItem myItems = {kAuthorizationRightExecute, 0,    <span>// 4</span></pre></td></tr><tr><td scope="row"><pre>                    NULL, 0};<span></span></pre></td></tr><tr><td scope="row"><pre>            AuthorizationRights myRights = {1, &amp;myItems};                  <span>// 5</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            myFlags = kAuthorizationFlagDefaults |                         <span>// 6</span></pre></td></tr><tr><td scope="row"><pre>                    kAuthorizationFlagInteractionAllowed |<span></span></pre></td></tr><tr><td scope="row"><pre>                    kAuthorizationFlagPreAuthorize |<span></span></pre></td></tr><tr><td scope="row"><pre>                    kAuthorizationFlagExtendRights;<span></span></pre></td></tr><tr><td scope="row"><pre>            myStatus = AuthorizationCopyRights (myAuthorizationRef,       <span>// 7</span></pre></td></tr><tr><td scope="row"><pre>                                         &amp;myRights, NULL, myFlags, NULL );<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if (myStatus != errAuthorizationSuccess) break;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            char myToolPath[] = "/usr/bin/id";<span></span></pre></td></tr><tr><td scope="row"><pre>            char *myArguments[] = { "-un", NULL };<span></span></pre></td></tr><tr><td scope="row"><pre>            FILE *myCommunicationsPipe = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>            char myReadBuffer[128];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            myFlags = kAuthorizationFlagDefaults;                          <span>// 8</span></pre></td></tr><tr><td scope="row"><pre>            myStatus = AuthorizationExecuteWithPrivileges                  <span>// 9</span></pre></td></tr><tr><td scope="row"><pre>                    (myAuthorizationRef, myToolPath, myFlags, myArguments,<span></span></pre></td></tr><tr><td scope="row"><pre>                    &amp;myCommunicationsPipe);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            if (myStatus == errAuthorizationSuccess)<span></span></pre></td></tr><tr><td scope="row"><pre>                for(;;)<span></span></pre></td></tr><tr><td scope="row"><pre>                {<span></span></pre></td></tr><tr><td scope="row"><pre>                    int bytesRead = read (fileno (myCommunicationsPipe),<span></span></pre></td></tr><tr><td scope="row"><pre>                            myReadBuffer, sizeof (myReadBuffer));<span></span></pre></td></tr><tr><td scope="row"><pre>                    if (bytesRead &lt; 1) break;<span></span></pre></td></tr><tr><td scope="row"><pre>                write (fileno (stdout), myReadBuffer, bytesRead);<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    } while (0);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    AuthorizationFree (myAuthorizationRef, kAuthorizationFlagDefaults);    <span>// 10</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (myStatus) printf("Status: %ld\n", myStatus);<span></span></pre></td></tr><tr><td scope="row"><pre>    return myStatus;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here are explanations of the numbered lines of code in <span class="content_text">Listing 2-17</span>:</p><ol class="ol"><li class="li"><p>Declare a variable to store authorization options.</p></li><li class="li"><p>Declare an authorization reference.</p></li><li class="li"><p>Use the <code>AuthorizationCreate</code> function to initialize the authorization reference. See <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCHCEEG">“Creating an Authorization Reference Without Rights”</a></span> for more information.</p></li><li class="li"><p>Create an authorization item array. The user must have the right to execute to use the <code>AuthorizationExecuteWithPrivileges</code> function. To create a right to execute authorization item, set the <code>name</code> field to <code>kAuthorizationRightExecute</code>, the <code>value</code> fields to <code>NULL</code>, the <code>valueLength</code> and <code>flags</code> fields to <code>0</code>. See <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF11">“Creating an Authorization Rights Set”</a></span> for more information.</p></li><li class="li"><p>Create an authorization rights set. Set the <code>count</code> field to the number of items in the authorization item array, and set the <code>items</code> field to point to the authorization item array. See <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF11">“Creating an Authorization Rights Set”</a></span> for more information.</p></li><li class="li"><p>Set the authorization options to preauthorize the rights. See <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF9">“Specifying Authorization Options for Preauthorization”</a></span> for more information.</p></li><li class="li"><p>Use the <code>AuthorizationCopyRights</code> function to preauthorize the right to execute your installer as root. In this case, there is no reason to continue if the user can’t preauthorize. See <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF12">“Authorizing”</a></span> for more information.</p></li><li class="li"><p>Set the authorization options for the <code>AuthorizationExecuteWithPrivileges</code> function to <code>kAuthorizationFlagDefaults</code>. Other authorization options, such as that specified by the <code>kAuthorizationFlagInteractionAllowed</code> constant, are not necessary because the <code>AuthorizationExecuteWithPrivileges</code> function interacts with the user whether you specify the option or not.</p></li><li class="li"><p>Use the <code>AuthorizationExecuteWithPrivileges</code> function to invoke your installer. Pass the authorization reference in the first parameter. Pass the installer’s full POSIX pathname in the second parameter. Pass the authorization options default in the third parameter. Pass any arguments for the installer in the fourth parameter. A communications pipe to the tool may be set up through the fifth parameter. See <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-TPXREF18">“Calling a Helper Tool as Root”</a></span> for more information about the <code>AuthorizationExecuteWithPrivileges</code> function.</p></li><li class="li"><p>Release the authorization reference using the <code>AuthorizationFree</code> function. See <span class="content_text"><a href="authtasks.html#//apple_ref/doc/uid/TP30000995-CH206-BBCFHGBH">“Releasing an Authorization Reference”</a></span> for more details.</p></li></ol>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../02authconcepts/authconcepts.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../appendixa/appendixa.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2002, 2009 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2009-01-06<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Security/Conceptual/authorization_concepts/03authtasks/authtasks.html%3Fid%3DTP30000995-3.1&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Security/Conceptual/authorization_concepts/03authtasks/authtasks.html%3Fid%3DTP30000995-3.1&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Security/Conceptual/authorization_concepts/03authtasks/authtasks.html%3Fid%3DTP30000995-3.1&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>