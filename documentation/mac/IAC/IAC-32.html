<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Creating a Publisher(IM:IC)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING32></A>



<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="IAC-31.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="IAC-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="IAC-529.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="IAC-33.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="IAC-2.html"><B>Interapplication Communication</B></A> / <BR><DD><A HREF="IAC-23.html"><B>Chapter 2 - Edition Manager</B></A> / <A HREF="IAC-26.html"><B>Using the Edition Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING32-0></A>
<H2><A NAME=MARKER-9-163></A><A NAME=MARKER-21-164></A>Creating a Publisher</H2>
 You need to support a Create Publisher menu command in the Edit menu. When a user selects a portion of a document and chooses Create Publisher from this menu, you should display the publisher dialog box on the user's screen. The Create Publisher menu command should remain dimmed until the user selects a portion of a document.<A NAME=MARKER-2-368></A><P>
 Use the <CODE>NewPublisherDialog</CODE> function to display the publisher dialog box on the user's screen. This function is similar to the <CODE>CustomPutFile</CODE> procedure described in the chapter "Standard File Package" in <I><A HREF="../Files/Files-2.html">Inside Macintosh: Files</A></I>.<A NAME=MARKER-2-351></A><P>
<PRE>
err := NewPublisherDialog(reply);
</PRE>
 The dialog box contains space for a preview (a thumbnail sketch) of the edition and a space for the user to type the name of the edition in which to write the publisher data. <A HREF=#MARKER-9-168>Figure 2-11</A> illustrates a sample publisher dialog box.<A NAME=MARKER-2-295></A><P>
<B>Figure 2-11  <A NAME=MARKER-9-168></A><A NAME=MARKER-21-169></A>A sample publisher dialog box</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/ED-S-11.gif"><P>
 The <CODE>NewPublisherDialog</CODE> function displays the preview (provided by your application), displays a text box with the default name of the edition (provided by your application), and handles all user input until the user clicks <BR>Publish or Cancel.<P>
 You pass a new publisher reply record as a parameter to the <CODE>NewPublisherDialog</CODE> function.<A NAME=MARKER-2-102></A><A NAME=MARKER-9-31></A><P>
<PRE>
TYPE NewPublisherReply = 
   RECORD
      canceled:   Boolean;          {user clicked Cancel}
      replacing:  Boolean;          {user chose existing }
                                    { filename for an edition}
      usePart:    Boolean;          {always FALSE in version 7.0}
      preview:    Handle;           {handle to 'prvw', 'PICT', }
                                    { 'TEXT', or 'snd ' data}
      previewFormat:                {type of preview}
                  FormatType;    
      container:  EditionContainerSpec;{initially, default name }
                                    { and location of edition; }
                                    { on return, edition name &amp; }
                                    { location chosen by the } 
                                    { user to publish data to}
   END;
</PRE>
 You fill in the <CODE>usePart</CODE>, <CODE>preview</CODE>, <CODE>previewFormat</CODE>, and <CODE>container</CODE> fields of the new publisher reply record.<P>
 Always set the <CODE>usePart</CODE> field to <CODE>FALSE</CODE>. The <CODE>preview</CODE> field should contain either <CODE>NIL</CODE> or the data to display in the preview. The <CODE>previewFormat</CODE> field should contain <CODE>'PICT'</CODE>, <CODE>'TEXT'</CODE>, <CODE>'snd '</CODE>, or <CODE>'prvw'</CODE>.<P>
 Set the <CODE>container</CODE> field to be the default name and folder for the edition. The default name should reflect the data contained in the publisher. For example, if a user publishes a bar chart of sales information entitled "sales data," then the default name for the edition could also be "sales data." Otherwise, you should use the document name followed by a hyphen (-) and a number to establish uniqueness. For example, your default name could be "January Totals - 3."<P>
 If the document has not been saved, the default name should be "untitled edition &lt;<I>n</I>&gt;" where <I>n</I> is a number to establish uniqueness. The default folder should be the same as the edition for the last publisher created in the same document. If this is the first publisher in the document, the default folder should be the same folder that the document is in.<P>
 The <CODE>canceled</CODE> field of the new publisher reply record indicates whether the user clicked Cancel. The <CODE>replacing</CODE> field indicates whether the user chose to replace an existing edition file. If <CODE>replacing</CODE> returns <CODE>FALSE</CODE>, call the <CODE>CreateEditionContainerFile</CODE> function to create an edition file.<P>
 The <CODE>container</CODE> field is of data type <CODE>EditionContainerSpec</CODE>.<A NAME=MARKER-2-375></A><P>
<PRE>
TYPE EditionContainerSpec = 
   RECORD
      theFile:       FSSpec;     {record that identifies the }
                                 { file to contain edition data}
      theFileScript: ScriptCode; {script code of filename}
      thePart:       LongInt;    {which part of file, }
                                 { always kPartsNotUsed}
      thePartName:   Str31;      {not used in version 7.0}
      thePartScript: ScriptCode; {not used in version 7.0}
   END;
</PRE>
 The field <CODE>theFile</CODE> is a file system specification record, a data structure of type <CODE>FSSpec</CODE>. You identify the edition using a volume reference number, directory ID, and filename. When specifying an edition, follow the standard conventions described in <I><A HREF="../Files/Files-2.html">Inside Macintosh: Files</A></I>.<P>
 After filling in the fields of the new publisher reply record, pass it as a parameter to the <CODE>NewPublisherDialog</CODE> function, which displays the publisher dialog box.<A NAME=MARKER-2-376></A><A NAME=MARKER-2-113></A><P>
<PRE>
err := NewPublisherDialog(reply);
</PRE>
 After displaying the publisher dialog box, use the <CODE>CreateEditionContainerFile</CODE> function to create the edition container, and then use the <CODE>NewSection</CODE> function to create the section record and the alias record. See the next section, <A HREF=#MARKER-9-175>"Creating the Edition Container,"</A> and <A HREF=IAC-28.html#MARKER-9-87>"Creating the Section Record and Alias Record" on page 2-15</A> for detailed information.<P>
 The following code segment illustrates how your application might respond to the user choosing the Create Publisher menu item. In this case, the code sets up the preview for the edition, sets the default name for the edition container, and calls an application-defined function (<CODE>DoNewPublisher</CODE>, shown in <A HREF=#MARKER-9-182>Listing 2-4 on page 2-33</A>) to display the publisher dialog box on the user's screen. An application might call the <CODE>DoNewPublisher</CODE> function in response to the user's choosing Create Publisher from the Edit menu or in response to handling the Create Publisher event. The chapter "Responding to Apple Events" in this book gives an example of a handler for the Create Publisher event.<P>
<PRE>
VAR
   thisDocument:        MyDocumentInfoPtr; 
   promptForDialog:     Boolean;
   preview:             Handle; 
   previewFormat:       FormatType; 
   defaultLocation:     EditionContainerSpec;
   myErr:               OSErr;


BEGIN
   {Get a preview to show the user. The MyGetPreviewForSelection }
   { function returns a handle to the preview.}
   preview := MyGetPreviewForSelection(thisDocument);
   previewFormat := 'TEXT';
   defaultLocation := MyGetDefaultEditionSpec(thisDocument);
   promptForDialog := TRUE;
   myErr := DoNewPublisher(thisDocument, promptForDialog, preview, 
                           previewFormat, defaultLocation);
END;
</PRE>
<A NAME=HEADING32-23></A>
<H3><A NAME=MARKER-9-175></A><A NAME=MARKER-21-176></A>Creating the Edition Container</H3>
 Use the <CODE>CreateEditionContainerFile</CODE> function to create an edition container to hold the publisher data.<A NAME=MARKER-2-377></A><A NAME=MARKER-9-59></A><P>
<PRE>
err := CreateEditionContainerFile(editionFile, fdCreator,
                                  editionFileNameScript);
</PRE>
 This function creates an edition container. The edition container is empty (that is, it does not contain any formats) at this time.<P>
 To associate an icon with the edition container, create the appropriate entries for the icon in your application's bundle. See the chapter "Finder Interface" in <I><A HREF="../Toolbox/Toolbox-2.html">Inside Macintosh: Macintosh Toolbox Essentials</A></I> for additional information. Depending on the contents of the edition, the file type will be <CODE>'edtp'</CODE> (for graphics), <CODE>'edtt'</CODE> (for text), or <CODE>'edts'</CODE> (for sound).<A NAME=MARKER-2-91></A><A NAME=MARKER-2-361></A><A NAME=MARKER-2-153></A><P>
 After creating the edition container, use the <CODE>NewSection</CODE> function to create the section record and alias record for the section.<P>
 <A HREF=#MARKER-9-182>Listing 2-4</A> illustrates how to create a publisher. The <CODE>DoNewPublisher</CODE> function shown in the listing is a function provided by an application. Note that an application might call the <CODE>DoNewPublisher</CODE> function in response to the user's choosing the Create Publisher command or in response to the Create Publisher event. The chapter "Responding to Apple Events" in this book gives an example of a handler for the Create Publisher event.<P>
 The parameters to the <CODE>DoNewPublisher</CODE> function include a pointer to information about the document, a Boolean value that indicates if the function should display the new publisher dialog box, the preview for the edition, the preview format, and an edition container.<P>
 The function displays the publisher dialog box if requested, letting the user accept or change the name of the edition and the location where the edition should reside. Use the <CODE>CreateEditionContainerFile</CODE> function to create the edition with the given name and location. Use the <CODE>NewSection</CODE> function to create a new section for the publisher.<P>
 After the section is created, you must write out the edition data. Be sure to add the newly created section to your list of sections for this document. There are several different techniques for creating publishers and unique IDs; this listing displays one technique.<P>
 After creating the edition container and creating a new section record, the <CODE>DoNewPublisher</CODE> function calls another application-defined routine, <CODE>DoWriteEdition</CODE>, to open the edition and write data to it.<P>
<B>Listing 2-4  <A NAME=MARKER-9-182></A><A NAME=MARKER-21-183></A>Creating a publisher</B><P>
<PRE>
FUNCTION DoNewPublisher(thisDocument: MyDocumentInfoPtr;
                        promptForDialog: Boolean; 
                        preview: Handle;
                        previewFormat: FormatType;
                        editionSpec: EditionContainerSpec)
                        : OSErr;
VAR
   getLastErr, dialogErr:  OSErr;
   createErr, sectionErr:  OSErr;
   resID:                  Integer;
   thisSectionH:           SectionHandle;
   reply:                  NewPublisherReply;
BEGIN
   {set up info for new publisher reply record}
   reply.replacing := FALSE;
   reply.usePart := FALSE;
   reply.preview := preview;
   reply.previewFormat := previewFormat;
   reply.container := editionSpec;
   IF promptForDialog THEN 
   BEGIN {user interaction is allowed}
      {display dialog box and let user select}
      dialogErr := NewPublisherDialog(reply);
      {dispose of preview data handle}
      DisposeHandle(reply.preview);
      IF dialogErr &lt;&gt; noErr THEN MyErrHandler(dialogErr);
      IF reply.canceled THEN
      BEGIN    {do nothing if user canceled}
         DoNewPublisher := userCanceledErr;
         EXIT(DoNewPublisher);
      END;
   END;  {of promptForDialog}


   IF NOT reply.replacing THEN
   BEGIN 
      {if user isn't replacing an existing file, create a new one}
      createErr := 
         CreateEditionContainerFile(reply.container.theFile,
                                   kAppSignature,
                                   reply.container.theFileScript);
      IF createErr &lt;&gt; noErr THEN
      BEGIN
         DoNewPublisher := errAEPermissionDenied;
         EXIT(DoNewPublisher);
      END;
   END; {of not replacing}
   {Advance counter to make a new unique sectionID for this }
   { document. It is not required that you equate section IDs }
   { with resources.}
   thisDocument^.nextSectionID := thisDocument^.nextSectionID + 1;
   {create a publisher section}
   sectionErr := NewSection(reply.container,
                            thisDocument^.fileSpecPtr,
                            stPublisher,
                            thisDocument^.nextSectionID,
                            pumOnSave, thisSectionH);
   IF (sectionErr &lt;&gt; noErr) &amp; (sectionErr &lt;&gt; multiplePublisherWrn) 
         &amp; (sectionErr &lt;&gt; notThePublisherWrn) THEN
      MyErrHandler(sectionErr);
   resID := thisDocument^.nextSectionID;
   {add this section/alias pair to app's internal bookkeeping}
   MyAddSectionAliasPair(thisDocument, thisSectionH, resID);
   {write out first edition}
   DoWriteEdition(thisSectionH);
   {Remember that the section and alias records need to be }
   { saved as resources when the user saves the document.}
   {set the function result appropriately}
   DoNewPublisher := MyGetLastError;
END; 
</PRE>
<A NAME=HEADING32-36></A>
<H3>Opening an Edition Container to Write Data</H3>
 Several routines are required to write (publish) data from a publisher to an edition container. (For information on creating an edition container, see the previous section.) Before writing data to an edition, you must use the <CODE>OpenNewEdition</CODE> function. This function should be used only for a publisher within a document. Use this function to initiate the writing of data to an edition.<A NAME=MARKER-2-383></A><A NAME=MARKER-9-73></A><P>
<PRE>
err := OpenNewEdition(publisherSectionH, fdCreator,
                      publisherSectionDocument, refNum);
</PRE>
 A user may try to save a document containing a publisher that is unable to write its data to an edition--because another publisher (that shares the same edition) is writing, another subscriber (that shares the same edition) is reading, or a publisher located on another computer is registered to the section. In such a case, you may decide to refrain from writing to the edition so that the user does not have to wait. You should also refrain from displaying an error to the user. The contents of the publisher are saved to disk with the document. The next time that the user saves the document, you can write the publisher data to the edition. You should display an alert box to discourage users from making multiple copies of the same publisher and pasting them in the same or other documents (see <A HREF=IAC-525.html#MARKER-9-421>"Duplicating Publishers and Subscribers" on page 2-58</A>).<P>
 If a user clicks Send Edition Now within the publisher options dialog box (to write publisher data to an edition manually), and the publisher is unable to write its data to its edition (for any of the reasons outlined above), you should display an error message.<P>
 After you are finished writing data to an edition, use the <CODE>CloseEdition</CODE> function to close the edition.<P>
 <A HREF=#MARKER-9-186>Listing 2-5</A> illustrates how to write data to an edition. For an existing edition container, you must open the edition, write each format using the <CODE>WriteEdition</CODE> function, and close the edition using the <CODE>CloseEdition</CODE> function. This listing shows how to write text only. If the edition is written successfully, subscribers receive Section Read events.<P>
<B>Listing 2-5  <A NAME=MARKER-9-186></A><A NAME=MARKER-21-187></A>Writing data to an edition</B><P>
<PRE>
PROCEDURE DoWriteEdition(thePublisher: SectionHandle);
VAR
   eRefNum:       EditionRefNum;
   openErr:       OSErr;
   writeErr:      OSErr;
   closeErr:      OSErr;
   thisDocument:  MyDocumentInfoPtr;
   textHandle:    Handle;
BEGIN
   {find out which document this section belongs to}
   thisDocument := MyFindDocument(thePublisher);
   {open edition for writing}
   openErr := OpenNewEdition(thePublisher, kAppSignature,
                             thisDocument^.fileSpecPtr, eRefNum);
   IF openErr &lt;&gt; noErr THEN
      MyErrHandler(openErr);{handle error and exit}
   {get the text data to write}
   textHandle := MyGetTextInSection(thePublisher, thisDocument);
   {write out text data}
   HLock(textHandle);
   writeErr := WriteEdition(eRefNum, 'TEXT', textHandle^,
                            GetHandleSize(textHandle));
   HUnLock(textHandle);
   IF writeErr &lt;&gt; noErr THEN
   BEGIN
      {There were problems writing; simply close the edition. }
      { When successful = FALSE, the edition data &lt;&gt; section }
      { data. Note: this isn't fatal or bad; it just means }
      { that the data wasn't written and no Section Read events }
      { will be generated.}
      closeErr := CloseEdition(eRefNum, FALSE);
   END 
   ELSE
   BEGIN
      {The write was successful; now close the edition. }
      { When successful = TRUE, the edition data = section data.}
      { This edition is now available to any subscribers. }
      { Section Read events will be sent to current subscribers.}
      closeErr := CloseEdition(eRefNum, TRUE);
   END;
END; 
</PRE>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="IAC-31.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="IAC-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="IAC-529.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="IAC-33.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="IAC-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
