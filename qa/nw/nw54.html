<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!--Template 06-20-02--> <HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Q&amp;A NW54: Open Transport Errors -3151/-3160 and Option Management</title><meta name="keywords" content="Mac OS 8 Open Transport Errors -3151 -3160 OptionManagement call"><meta name="Description" content="Technical Q&amp;A NW54: Q&amp;A gives the possible causes of eitheran Error -3151 or an Error -3160 when making an OptionManagementcall to set an endpoint."><meta name="categories" content="Networking"><meta name="week-posted" content="Apr 6, 1998 - Apr 17, 1998"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10001466" title="Open Transport Errors -3151/-3160 and Option Management"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalqas/LegacyTechnologies/idxNetworking-date.html">Networking</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Networking/idxCarbon-date.html" target="_blank">Networking > Carbon</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A NW54</div>
<div id="pageheadsub">Open Transport Errors -3151/-3160 and Option Management</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment -->						<!-- begin_content --> <CENTER><TABLE BORDER=0 CELLPADDING=0 WIDTH=600><TR> <td align="left"><hr width=500 align=center><p id = p2>Q:When I make an <CODE>OptionManagement</CODE> call to set an endpoint option, I receive one of two error messages, <B>Error -3155</B> (bad option) or <B>Error -3160</B> (buffer overflow). What should I be looking at to resolve these errors?</p><p id=p4>A:  <b>Error -3151</b> indicates that a bad option or option value was passed to an Open Transport endpoint. The following answers assume an understanding of making calls to <CODE>OTOptionManagement</CODE>. For more information on call to <CODE>OTOptionManagement</CODE>, please refer to <a href="http://developer.apple.com/documentation/mac/NetworkingOT/NetworkingWOT-37.html" target="_blank">"Inside Macintosh: Networking With Open Transport"</A>, chapter 7, Option Management. You can download an electronic copy of this documentation from the <A HREF="http://www.apple.com/macos/opentransport/" target="_blank">Open Transport Web Page.</A></p><p id=p4>The common reasons for <B>Error -3151</B> are:</P><ol type="1" start="1">	<li><p id=p4><B>The option length for the option is incorrect.</B>  Most Open Transport  Option Management option values are 4 bytes long. Some options take  string and structure values. You must set both the <CODE>TOptMgmt opt.len</CODE>  field, and the <CODE>TOptionHeader len</CODE> field to the exact length of the option  buffer request. You can also use the same buffer and <CODE>TOptMgmt</CODE> structure  for the Option Management response, which is discussed in the next  section regarding <B>Error -3160</B>.</p><P id =p4><B>Error -3151</B> occurs most often when the option value is 1 byte  long, but a 4-byte length is specified. Again, there are two places  where the length argument is set - in the <CODE>TOptMgmt</CODE> structure and in the  <CODE>TOptionHeader</CODE> structure.</p></li><LI><p id = p4><B>A return <CODE>TOptMgmt</CODE> pointer was passed in the call to <CODE>OTOptionManagement</CODE> and the <CODE>maxlen</CODE> field is not set correctly.</B>  Not setting this parameter can also result in <B>Error -3160</B>, depending on its input value. The <CODE>OTMultiCastPitch</CODE> code sample in the OpenTransport SDK demonstrates this problem when trying to set the <CODE>IP_ADD_MEMBERSHIP</CODE> option. The corrected call is shown as follows:</P><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>        optReq.flags = T_NEGOTIATE;        optReq.opt.len = sizeof(optBuffer);      // specify the size of the buffer        optReq.opt.maxlen = sizeof(optBuffer);   // &lt;--- add this line of code        optReq.opt.buf = (UInt8*) optBuffer;        OTMemzero(optBuffer, sizeof(optBuffer));        opt-&gt;level = INET_IP;        opt-&gt;name = IP_ADD_MEMBERSHIP;        opt-&gt;len = sizeof(optBuffer);           // specify the size of the option</pre>	</TD></TR></TABLE></CENTER>        <P id=p4>A similar correction is required in the same code sample when trying to set the <CODE>IP_MULTICAST_TTL</CODE> option. The modified code sample is shown below.</p><p id=p4>The previous corrections applies to the Open Transport SDK v1.3 and earlier.</p></li><LI><P id =p4><B>There is a known problem when using Open Transport v1.3 and earlier.</B>  You will encounter this error when using the <CODE>OTOptionManagement</CODE> T_ALLOPT value to obtain all of the current IP option settings in one call. This problem is demonstrated with the <CODE>OTMulticastPitchSample</CODE> code running under Open Transport v 1.3 and earlier. The workaround is to ask individually for the status of each option where the current setting is desired.</p></li></ol><p id=p4>The common reasons for <b>Error -3160</b> are:</P><ol type="1" start="1">	<li><B>The <CODE>TOptMgmt opt.maxlen</CODE> field was not initialized, or incorrectly set.</B>   This error can be returned even if the option was successfully  negotiated. The solution is to set the <CODE>maxlen</CODE> field correctly.</li>	<li><B>There is a known problem when using Open Transport v1.3 and earlier.</B>   If you try to negotiate a TCP/IP option whose length is 1 or 2 bytes,  Open Transport will return this error if the return buffer is set for a  buffer for less than a 4-byte response. Interestingly, the option may be  successfully negotiated. The workaround for this problem is to define  the size of the buffer as <CODE>kOTFourByteOptionSize</CODE> and to continue to set  the two <CODE>len</CODE> fields as <CODE>kOTOneByteOptionSize</CODE> or <CODE>kOTTwoByteOptionSize</CODE> (as of  this writing, there are no 2-byte option settings).</li></ol><P id =p4><B>Error -3160</B> will not be returned if there is no return parameter specified. On the other hand, without checking the return value, you cannot know whether the return status of the option call was <code>T_SUCCESS</code> or not. This problem applies when trying to set the following options:</p><center><TABLE border=1><TR>	<td align="left"><B>Option Level</B></TD>        <td align="left"><B>Option Name</B> </TD></TR><TR>	<td align="left">INET_UDP</TD>             <td align="left">UDP_RX_ICMP</TD></TR><TR>	<td align="left">INET_IP </TD>              <td align="left">IP_RECVOPTS</TD></TR><TR>	<td align="left">INET_IP</TD>               <td align="left">IP_TOS</TD></TR><TR>	<td align="left">INET_IP</TD>               <td align="left">IP_TTL</TD></TR><TR>	<td align="left">INET_IP</TD>               <td align="left">IP_MULTICAST_LOOP</TD></TR><TR>	<td align="left">INET_IP</TD>               <td align="left">IP_MULTICAST_TTL</TD></TR><TR>	<td align="left">INET_IP</TD>               <td align="left">IP_RECVDSTADDR</TD></TR><TR>	<td align="left">INET_IP </TD>              <td align="left">IP_RECVIFADDR</TD></TR></TABLE></center><p id=p4> The following modifications and corrections apply to the <CODE>OTMultiCastPitchSample.cp</CODE> file.</P><p id=p4><B>Correction 1:</B></P><p id=p4>Change to the sample code for setting the <code>IP_MULTICAST_TTL</code> option.</P><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>        //        //  Setup time-to-live for multicast sends (defaults to 1)        //  Can reuse the TOptMgmt, but not Option itself is different.        //  While we could reuse the buffer above, I'll do it right to        //  demonstrate correctness.        //        UInt8 ttlOptBuffer[ kOTFourByteOptionSize ]; // &lt;-- 4 byte option length buffer        TOption*        ttlOpt = (TOption*)ttlOptBuffer;        optReq.flags = T_NEGOTIATE;        optReq.opt.len = kOTOneByteOptionSize; // &lt;-- leave as 1 byte option size        optReq.opt.maxlen = sizeof(ttlOptBuffer); // &lt;-- set return buffer maxlen        optReq.opt.buf = (UInt8*) ttlOptBuffer;        OTMemzero(optBuffer, sizeof(ttlOptBuffer));        ttlOpt-&gt;level = INET_IP;        ttlOpt-&gt;name = IP_MULTICAST_TTL;        ttlOpt-&gt;len = kOTOneByteOptionSize; // &lt;-- leave as 1 byte option size        *(char*)(ttlOpt-&gt;value) = kDefaultTTL;        err = gEndpt-&gt;OptionManagement(&amp;optReq, &amp;optReq);</pre></td></tr></table></center><p id=p4><B>Correction 2:</B>Change to the sample code for setting the <CODE>IP_MULTICAST_LOOP</CODE> option.</P><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    //    //  Turn off loopback - unless you want to receive your own packets back.    //    TOptMgmt optReq;    UInt8 optBuffer[ kOTFourByteOptionSize ]; // &lt;-- 4 byte option length buffer    TOption* opt = (TOption*)optBuffer;    OTMemzero(optBuffer, sizeof(optBuffer));    optReq.flags    = T_NEGOTIATE;    optReq.opt.len  = kOTOneByteOptionSize; // &lt;-- leave as 1 byte option size    optReq.opt.maxlen   = sizeof(optBuffer); // &lt;-- set return buffer maxlen    optReq.opt.buf  = (UInt8*) optBuffer;    opt-&gt;level = INET_IP;    opt-&gt;name = IP_MULTICAST_LOOP;    opt-&gt;len = kOTOneByteOptionSize; // &lt;-- leave as 1 byte option size    *(char *)(opt-&gt;value) = gLoopbackState;    err = gEndpt-&gt;OptionManagement(&amp;optReq, &amp;optReq);</pre>		</TD></TR></TABLE></CENTER></td></tr></table></center><!-- end_content --><!-- begin_date --><H4 ALIGN=center>[Apr 07 1997]</H4><!-- end_date --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/nw/nw54.html%3Fid%3DDTS10001466-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/nw/nw54.html%3Fid%3DDTS10001466-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/nw/nw54.html%3Fid%3DDTS10001466-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --><hr width=500 align=center> </BODY></HTML>