<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html><head>
<!-- BEGIN META TAG INFO -->
<link rel="home" href="http://developer.apple.com/">
<link rel="find" href="http://developer.apple.com/search/">
<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
<script language="JavaScript" type="text/javascript" src="../../documentation/js/busnav.js"></script>
<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<!-- END META TAG INFO -->
<!-- BEGIN TITLE -->
<title>Technical Q&amp;A QA1370: Common QA and Roadmap for USB Software Development on Mac OS X</title>
<!-- END TITLE -->
</head>
<!-- BEGIN BODY OPEN -->
<body bgcolor="#ffffff"><a name="//apple_ref/doc/uid/DTS10003388" title="Common QA and Roadmap for USB Software Development on Mac OS X"></a>
<!--END BODY OPEN -->
<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->
<a name="top"></a>
<!-- BEGIN LOGO AND SEARCH -->
<!--#include virtual="/includes/adcnavbar"-->
<!-- END LOGO AND SEARCH -->
<!-- START BREADCRUMB -->
<div id="breadcrumb"><table width="680" border="0" cellpadding="0" cellspacing="0"><tr>
<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
<td><img width="340" height="10" src="images/1dot.gif" alt=""></td></tr><tr valign="middle"><td align="left" colspan="2">
<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/HardwareDrivers/index.html">Hardware & Drivers</a> &gt; <a href="../../technicalqas/HardwareDrivers/idxUSB-date.html">USB</a> &gt; 
</td></tr><tr><td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td></tr></table></div>
<!-- END BREADCRUMB -->

<!-- START MAIN CONTENT -->
<!-- START TITLE GRAPHIC AND INTRO-->
<table width="680" border="0" cellpadding="0" cellspacing="0"><tr align="left" valign="top">
<td><h1>
<div id="pagehead">Technical Q&amp;A QA1370</div>
<div id="pageheadsub">Common QA and Roadmap for USB Software Development on Mac OS X</div>
</h1></td></tr></table>
<!-- END TITLE GRAPHIC AND INTRO -->
<!-- BEGIN WIDE COLUMN -->
<table width="680" border="0" cellpadding="0" cellspacing="0"><tr align="left" valign="top"><td align="left" width="680">
<!-- BEGIN CONTENTS -->
<h2>Q: Can you provide a roadmap for developing software to work with USB devices under Mac OS X?</h2><p>A: The following is a roadmap for the development of USB Device Driver and User Client software and is presented as a Question and Answer session.</p><h2>Q: Which USB Host Controller Interfaces does Mac OS support?</h2><p>A: Mac OS X supports Open Host Controller Interface (OHCI) and Enhanced Host Controller Interface (EHCI) devices. With the release of Mac OS X 10.4.x, there is built-in support for Universal Host Controller Interface (UHCI) USB Controllers. For example, on Power PC Based Macintosh systems, one could install a PCI UHCI USB Controller card, or a CardBus UHCI USB Controller card, as applicable, and find that Mac OS X 10.4.x will support USB devices attached to the card.</p><p>For the Intel based Macintosh systems, the UHCI USB Controller is built-in along with the EHCI USB Controller interface.</p><h2>Q: What Development Tools should I use and Where can I get them?</h2><p>A: The typical development platform is a Power Macintosh system with at least 256M RAM, with Mac OS X 10.3.x or greater, installed. For development, use <A HREF="../../referencelibrary/GettingStarted/GS_Tools/index.html">Xcode</A>. The latest version of <A HREF="../../tools/download/">Xcode</A> provides support for writing USB Device Drivers, for both Application and in-kernel levels, which are compatible to Mac OS X 10.1.x.</p><div class="notebox"><p><strong>Note:</strong> You can develop a USB Device Driver on a Power Macintosh system with Mac OS X 10.2.x or earlier installed, however, there are complexities with using the Project Builder application and your target system is an earlier release of Mac OS X. Xcode (which only runs under Mac OS X 10.3.x and greater) provides cross-development runtime libraries for compatibility with earlier releases of Mac OS X. To use the cross-development runtime libraries, you may have to install them from the Tools SDK, if you did not install them originally (the cross-development runtime-libraries are not installed as part of the &quot;Easy Install&quot;).</p></div><div class="notebox"><p><strong>IMPORTANT:</strong> If you have Mac OS X 10.2.x or earlier, you are urged to upgrade to the latest version of Mac OS X and use the latest version of <A HREF="../../tools/download/">Xcode</A> for your development work on USB Device Driver software.</p></div><p>Two other important USB tools are USB Prober and the logging versions of the IOUSBFamily kext. USB Prober displays USB specific information from the system and from IORegistry. It also displays status messages generated by the USBLog function call. The logging version of the IOUSBFamily kext complements USB Prober as it is a version of the USB Driver designed to provide status information which the shipping release does not. The logging version of IOUSBFamily, provides detailed information as to USB device attachment, driver matching and probe score results, and requests made to USB devices.</p><p>USB Prober is installed as part of the Developer SDK installation. If the Developer SDK has been installed, then locate USB Prober at /Developer/Applications/Utilities/USB Prober.</p><p>The <A HREF="../../devicedrivers/download/usbdebug.html">Logging Version of the IOUSBFamily Kext</A> is available from Apple Developer Connection (ADC).</p><div class="notebox"><p><strong>IMPORTANT:</strong> You must the version of the IOUSBFamily kext which is appropriate for the version of Mac OS which you are testing with. Using a mismatched version of the logging version of the IOUSBFamily kext can result in a kernel panic at system start.</p></div><div class="notebox"><p><strong>Note:</strong> A USB Analyzer is also recommended for the development of a USB Device Driver. A USB analyzer is not a required tool, however, it will save time and energy in diagnosing problems with the driver. The analyzer shows the USB transactions taking place on the bus. A USB packet trace will help you to understand error returns, why no data is being returned, why unexpected results are returned, as well as why other problems are happening. The following are a list of USB Analyzer Vendors which have been referenced by developers on the USB Mail List. Note:The list below is for your information only, and is not an endorsement of the products by these vendors.</p><ul><li><p><A HREF="http://www.ellisys.com/">Ellisys</A></p></li><li><p><A HREF="http://www.lecroy.com/"> LeCroy</A></p></li><li><p><A HREF="http://www.getcatalyst.com">Catalyst Enterprises, Inc.</A></p></li><li><p><A HREF="http://www.data-transit.com">Finisar</A></p></li></ul><p>The logging version of the IOUSBFamily Kernel Extension does not provide packet data information that is available under Windows. Even under Windows, a USB Analyzer is required to analyze problems resulting from STALL, DATA TOGGLE, and other protocol error conditions.</p></div><h2>Q: Which USB Device Driver type should I implement: Application level USB Driver or In-Kernel level USB Driver?</h2><p>A: The answer to this question can be determined by perusing <A HREF="../../referencelibrary/GettingStarted/GS_DeviceDrivers/index.html">Getting Started with Device Drivers</A>. Software development is far easier in Application space. You can use the built in Xcode source level debugger with an Application-level driver. For in-Kernel drivers, you will need to use the GDB debugger to <A HREF="../../documentation/Darwin/Conceptual/KernelProgramming/build/chapter_18_section_5.html">debug your in-kernel device driver</A>. Your development efforts are much more complex when you are <A HREF="../../documentation/Darwin/Conceptual/ShouldYou.html">Coding in the Kernel</A>. If at all possible, do not program in the kernel.</p><p>Whether you program at the Application level or in the kernel, you will use IOKit in programming a USB device driver. <A HREF="../../documentation/DeviceDrivers/Conceptual/IOKitFundamentals/Features/chapter_2_section_1.html#//apple_ref/doc/uid/TP0000012">Understanding IOKit</A> will help you to implement your USB Device driver.</p><h2>Q: What are the common criteria for writing Application-level USB Software and where can I access sample code?</h2><p>A: The following are some criteria and examples of cases where you will want to implement an Application-level USB driver/application. Links are provided to direct you to more information.</p><ul><li><p>Only your application will be communicating with the device.</p></li><li><p>The software will not be used by a kernel process</p></li><li><p><A HREF="../../samplecode/AppleApplications/idxImageCapture-date.html">TWAIN plugin for a scanner</A></p></li><li><p><A HREF="../../samplecode/AppleApplications/idxImageCapture-date.html">Plugin for a Digital Camera using Image Capture</A></p></li><li><p><A HREF="../../documentation/DeviceDrivers/Reference/ForceFeedback/ForceFeedback/">Plugin for a USB HID ForceFeedback device</A></p></li><li><p><A HREF="../../printing/">Plugin for a USB printer</A></p></li><li><p><A HREF="../../samplecode/USBUPSMonitor/USBUPSMonitor.html">USB Uninterruptible Power Supply (UPS) Monitor</A></p></li><li><p>Deva Example - included as part of the Developer SDK - /Developer/Examples/IOKit/usb/Deva  Example. This example demonstrates how to communicate with a USB device from the application level. The sample is targeted for the <A HREF="http://www.devasys.com/">DevaSys</A> USB I2C/IO,&nbsp; Interface Board.</p></li><li><p>Ezloader Example - included as part of the Developer SDK - /Developer/Examples/IOKit/usb/Ezloader Example. This sample is designed for Cypress/Anchor EZ-USB chip based devices. The Application level Device Driver demonstrates detection of the device, upgrade of the firmware, and issues the call to force the device to re-enumerate using the new firmware. You will also find the USBNotification Example which is a similar example.</p></li><li><p>NotifyExample- included as part of the Developer SDK - /Developer/Examples/IOKit/usb/NotifyExample. This sample demonstrates the detection of a USB device being attached and detached, and the storage of global data associated with each attached USB device.</p></li><li><p><A HREF="../../samplecode/USBPrivateDataSample/USBPrivateDataSample.html">USB Private Data Sample</A>. This sample demonstrates how to use IOKitLib and IOUSBLib to set up asynchronous callbacks when a USB device is attached to or removed from the system. It also shows how to associate arbitrary data with each device instance.</p></li><li><p><A HREF="../../samplecode/HID_Explorer/HID_Explorer.html">HID Explorer</A>. This complete program sample while not USB specific, demonstrates the use of the Human Interface Device (HID) Utilities to access and parse USB HID device report descriptors. This sample utility program works with most USB HID devices, such as mice, keyboards, keypads, joysticks, and gamepads. To compile the complete application make sure to also download the <A HREF="../../samplecode/HID_Utilities_Source/HID_Utilities_Source.html">HID Utility Sources</A> in order to make the required libHIDUtilities bundle.</p></li><li><p><A HREF="../../samplecode/VendorSpecificType00/VendorSpecificType00.html">VendorSpecificType00</A>. This is a Small Computer System Interface (SCSI) program sample which works with USB Mass Storage Class devices and demonstrates how to subclass the IOSCSIPeripheralType00 driver to add custom vendor specific functionality. It also shows how to set up a simple interface to user space code using I/O Registry properties. If you need to send SCSI commands to your USB Mass Storage Class device, you should review Technical Q&amp;A1179 <A HREF="../qa2001/qa1179.html">Sending SCSI Commands to Storage Devices</A>.</p></li></ul><p>To write an application level driver, you need to be familiar with device detection and opening the device interface. Information is provided on <A HREF="../../documentation/DeviceDrivers/Conceptual/USBBook/index.html">Working with USB Device Interfaces</A>. Sample code for detecting a USB device/interface from application space can be found in Developer Examples folder which is installed as part of the standard Developer Tools Installation package. The location is /Developer/Examples/IOKit/usb/.</p><h2>Q: When should I write a Kernel-level USB Device Driver?</h2><p>A: You will implement a Kernel-level driver, when Apple provides no class driver which matches to your device and the device will be used by a kernel process - for example USB networking, serial, and mass storage device drivers must be implemented as Kernel Extensions. HID Device Drivers may be in-kernel, when the device services will be available to all applications, but should be implemented as an application level driver if the device is to be used by specific applications.</p><p>As with application level USB drivers, you need to understand <A HREF="../../documentation/DeviceDrivers/Conceptual/IOKitFundamentals/Features/chapter_2_section_1.html#//apple_ref/doc/uid/TP0000012">IOKit</A> programming.</p><div class="notebox"><p><strong>Note:</strong> For building Universal Binary Kernel Extensions, refer to <A HREF="../../technotes/tn2006/tn2163.html">Tech Note 2163 Building Universal I/O Kit Drivers</A> for information on configuring an Xcode project to produce a universal driver.</p></div><h2>Q: What programming samples exist for Kernel-level USB drivers?</h2><p>A: There are three programming examples, as well as the source code for the Apple Kernel-level driver for USB devices. The programming examples are not complete drivers and are designed to demonstrate specific driver programming techniques. The following are a list of examples to refer to</p><ul><li><p>AnchorUSB Driver - included as part of the Developer SDK - /Developer/Examples/Kernel/IOKit/usb/AnchorUSB Sample. This driver sample is designed for Cypress/Anchor EZ-USB chip based devices. It demonstrates a firmware upgrade for the EZ-USB chipset, and issues the call to force the device to re-enumerate using the new firmware.</p></li><li><p>VendorSpecific Driver - included as part of the Developer SDK - /Developer/Examples/Kernel/IOKit/usb/VendorSpecific Driver. This driver sample is a simple project to demonstrate the basics of a USB Kernel-level driver project.</p></li></ul><p>The following is a list of Apple USB Class drivers, for which source code is available from the <A HREF="http://www.opensource.apple.com/darwinsource/index.html">Darwin web site</A>. To access these source code files, you must have an Apple Developer Connection (ADC) Member ID, as well as agree to the <A HREF="http://www.opensource.apple.com/apsl/">Apple Public Source License Agreement</A>.</p><ul><li><p>USB OHCI Controller in the IOUSBFamily project</p></li><li><p>USB EHCI Controller in the IOUSBFamily project</p></li><li><p>USB Composite Class driver in the IOUSBFamily project</p></li><li><p>USB HID driver in the IOUSBFamily project - which supports both keyboards and pointing devices</p></li><li><p>USB CDC Ethernet Device in the IOUSBFamily project</p></li><li><p>USB CDC (Serial) Device in the IOUSBFamily project</p></li><li><p>USB Mass Storage Bulk Only Device in the IOUSBMassStorageClass project</p></li><li><p>USB Mass Storage Control/Bulk/Interrupt (CBI) Device in the IOUSBMassStorageClass project</p></li><li><p>USB Mass Storage Uniform Floppy Interface(UFI) Device in the IOUSBMassStorageClass project</p></li><li><p>USB Audio Class Driver in the AppleUSBAudio project</p></li></ul><p>The Apple USB Class Drivers are based on the Device Class Specifications which are available from the <A HREF="http://www.usb.org/developers/devclass/">USB-IF Device Class Documents web page</A>.</p><h2>Q: Who can I contact for more assistance?</h2><p>A: The <A HREF="http://lists.apple.com/mailman/listinfo/usb">USB Mailing list</A> is the best starting point for getting additional assistance. You must subscribe to the list to submit a question. Members of the USB Engineering team are members of the list, and they along with numerous developers on the list may respond to your question. If you have an introductory type question, peruse the <A HREF="http://lists.apple.com/mailman/listinfo/usb">USB Mail archives</A> as the question may have been previously asked and answered.</p><p>If you find a bug with Mac OS X USB Class drivers, or with the use or implementation of the Apple supplied API's, submit a <A HREF="../../bugreporter/index.html">Bug Report</A>, so that you can track the matter. Use a <A HREF="../../bugreporter/index.html">Bug Report</A> to submit enhancement requests to Mac OS X and to the Apple supplied API's.</p><p>For additional help, when there is no satisfactory response from the USB Mail List, you can submit a <A HREF="../../technicalsupport/gettingsupport.html">Technical Support Incident</A> request.</p><h2>Q: Can I license Apple Software or its logo?</h2><p>A: If you will need to license Apple software, contact <A HREF="../../softwarelicensing/">Apple Software Licensing</A> for a listing of licensable software and for the procedure to obtain the license. The Mac logo is also licensable from <A HREF="../../softwarelicensing/">Apple Software Licensing</A>.</p><h2>Q: Can I have Apple help with compatibility testing of my device and software?</h2><p>A: If you would like Apple to provide a quick look compatibility test of your product with the Apple Products  that include USB support built-in, send 5 of your products to:</p><pre class="sourcecodebox">Craig Keithley
I/O Technology Evangelist
Apple
1 Infinite Loop, MS-303-2TE
Cupertino, CA 95014</pre><A NAME="TNTAG2"></A><H2>Common Questions and Answers</H2><p>The following are some common questions which developers new to developing USB Device Drivers for Mac OS X encounter and are frequently asked on the USB Mail List.</p><p>To understand the rules of device matching, refer to Technical Q&amp;A QA1076 <A HREF="../qa2001/qa1076.html">Tips on USB driver matching for Mac OS X</A>.</p><h2>Q: How can I determine what the non-zero results from USB calls mean?</h2><p>A: The common error codes returned by USB functions are defined in the IOReturn.h and USB.h header files. Error results of the form 0xE0000XXX are general IOKit errors. Error results of the form 0xE00040XX are USB specific errors.</p><p>The complete path to the IOReturn.h header file is</p><p>/System/Library/Frameworks/IOKit.Framework/Headers/IOReturn.h.</p><p>The complete path to the USB.h header file is</p><p>/System/Library/Frameworks/IOKit.Framework/Headers/usb/USB.h.</p><p>You want to display the error result in hexadecimal to match against the error definitions listed in IOReturn.h or USB.h. For example, the <code>USBInterfaceOpen</code> call might fail with a result of -536870203. Convert this value to hexadecimal - 0xE00002C5. From the listing in IOReturn.h, this error equates to <code>kIOReturnExclusiveAccess</code>.</p><p class="smalltext"><strong>Listing 1:</strong> Excerpt from IOReturn.h</p><pre class="sourcecodebox">
...
#ifndef sys_iokit
#define sys_iokit                    err_system(0x38)
#endif /* sys_iokit */
#define sub_iokit_common             err_sub(0)
#define sub_iokit_usb                err_sub(1)
...
#define  iokit_common_err(return)     (sys_iokit|sub_iokit_common|return)
#define  iokit_family_err(sub,return) (sys_iokit|sub|return)

#define kIOReturnSuccess         KERN_SUCCESS            // OK
..
#define kIOReturnNoResources     iokit_common_err(0x2be) // resource shortage
#define kIOReturnIPCError        iokit_common_err(0x2bf) // error during IPC
#define kIOReturnNoDevice        iokit_common_err(0x2c0) // no such device
#define kIOReturnNotPrivileged   iokit_common_err(0x2c1) // privilege violation
#define kIOReturnBadArgument     iokit_common_err(0x2c2) // invalid argument
#define kIOReturnLockedRead      iokit_common_err(0x2c3) // device read locked
#define kIOReturnLockedWrite     iokit_common_err(0x2c4) // device write locked
#define kIOReturnExclusiveAccess iokit_common_err(0x2c5) // exclusive access and
                                                         //   device already open
</pre><p>To better understand the error declarations, refer to Technical Q&amp;A QA1075 <A HREF="../qa2001/qa1075.html">Making Sense of I/O Kit Error Codes</A> for an explanation of I/O Kit error codes.</p><h2>Q: When I load my in-kernel KEXT Device Driver, a window as shown in Figure 1, is displayed stating that the machine must be restarted. Where can I get more information on how to figure out what is happening and what to do for this situation?</h2><p>A: <img src="images/qa1370_1.jpg" width="468" height="256" alt=""></p><p>When you see this window, a kernel panic has occurred. Refer to Tech Note 2063 <A HREF="../../technotes/tn2002/tn2063.html">Understanding and Debugging Kernel Panics</A> for information on how to proceed.</p><h2>Q: How can I send custom SCSI commands to my USB Mass Storage Class Device?</h2><p>A: This question is addressed in Technical Q&amp;A QA1179 <A HREF="../qa2001/qa1179.html">Sending SCSI Commands to Storage Devices</A>.</p><p><a href="#top">Back to Top</a>&nbsp;<a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p><A NAME="TNT_HISTORY_TAG"></A><H2>Document Revision History</H2><table cellspacing="0" class="graybox" width="680"><tr><th width="100">Date</th><th width="580">Notes</th></tr><tr><td scope="row">2006-02-28</td><td>Updated to reflect UHCI support. Fixed typos. Added reference to Tech Note 2163 &quot;Building Universal I/O Kit Drivers.&quot;</td></tr><tr><td scope="row">2004-09-22</td><td>Roadmap for development of USB Software on Mac OS X and some Common Questions and Answers</td></tr></table><p><b>Posted:</b> 2006-02-28</p>
<!-- END CONTENTS -->
</td></tr></table>
<!-- END WIDE COLUMN -->
<!-- END MAIN CONTENT -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/qa2004/qa1370.html%3Fid%3DDTS10003388-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/qa2004/qa1370.html%3Fid%3DDTS10003388-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/qa2004/qa1370.html%3Fid%3DDTS10003388-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

<!-- START BOTTOM APPLE NAVIGATION -->
<!--#include virtual="/includes/footer"-->
<!-- END BOTTOM APPLE NAVIGATION -->
<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->
</body></html>