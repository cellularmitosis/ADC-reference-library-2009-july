<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1199: USB Printer Sharing Compatibility</title>       <meta name="keywords" content="USB,Printer,Sharing,csCode,driver,name registry,chooser,printer name,csParam">    <meta name="Description" content="Technical Note TN1199: This Technote describes how USB printerdriver developers can make their drivers compatible withUSB Printer Sharing while retaining the ability to use customcsCodes, pass pointers to private data, and display the correctprinter name in the Chooser."><meta name="categories" content="Devices and Printing"><meta name="week-posted" content="May 29, 2000 - Jun 2, 2000"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10003038" title="USB Printer Sharing Compatibility"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxPrinting-date.html">Printing</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/Printing/idxHardwareDrivers-date.html" target="_blank">Printing > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1199</div>
<div id="pageheadsub">USB Printer Sharing Compatibility</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"> <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">     <tr><td width=300 valign="top" align=left scope="row">    <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td></tr><tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left>       <span id="menutitle">CONTENTS   <br>  <br>       </span>   </td></tr><tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left>       <!-- begin_toc --><P id="menutext"><A HREF = "#Section1">Introduction</A><BR><BR><A HREF = "#Section2">Printer Name in the Chooser</A><BR><BR><A HREF = "#Section3">Name Registry Properties</A><BR><BR><A HREF = "#Section4">Handling Errors</A><BR><BR><A HREF = "#Section5">Control and Status Calls</A><BR><BR><A HREF = "#Section6">Gestalt Information</A><BR><BR><A HREF = "#Summary">Summary</A><BR><BR><A HREF = "#References">References</A><BR><BR><A HREF = "#Downloads">Downloadables</a></p>   </td></tr><tr>   <td width=300 align=left scope="row">       <img src="images/tnmenubottom.gif" alt="" width=300 height=16>   </td></tr>    </table></td><td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">This Technotedescribes how USB printer driver developers can make theirdrivers compatible with USB Printer Sharing.</p><P id = "introtext">For printer drivers that support it, USB Printer Sharingprovides transparent sharing of printers across a TCP/IP network (including AirPort) andis a significant added benefit for users.  By paying attentionto a few simple guidelines, printer driver developers canensure that their drivers work seamlessly with USB PrinterSharing while retaining the ability to use custom <CODE>csCodes</CODE>,pass pointers to private data, and display the correctprinter name in the Chooser.</P>      <P id = "introtext">This Note is directed at USB printer driver developers who want their drivers to be compatible with USB Printer Sharing.</P><!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Jun 19 2000]</h3><!-- end_date --></TD>     </TR>  </TABLE> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><A NAME="Section1"></A><H2>Introduction</H2><P>USB Printer Sharing operates by breaking the local link between a printer driver and its USB printer class driver. The link between these two drivers is traditionally made using a pair of device drivers having entries in both the unit table and    the name registry. USB Printer Sharing creates a pair of device drivers on the client. The client printer driver sends commands to these device drivers as it normally would, but instead of passing the commands to a local printer class driver, the USB Printer Sharing device drivers send the commands over the network using TCP/IP to a server Macintosh. The serving Macintosh takes the commands off the wire and invokes the device drivers on the server.</P><TABLE BORDER=0 CELLPADDING=1 WIDTH=500><TR>    <TD ALIGN="CENTER" align="left"><img src="images/tn1199_001.jpg" alt="Nonshared printer" width=149 height=192 align=bottom><P ALIGN="center">A Typical USB Printer Driver</P><BR><BR>    </TD></TR><TR>    <TD ALIGN="CENTER" align="left"><img src="images/tn1199_002.jpg" alt="shared printer" width=382 height=283 align=bottom><P ALIGN="center">A USB Printer Driver Running with USB Printer Sharing</P>    </TD></TR></TABLE><BR><BR><BR><P>In order for USB Printer Sharing to work correctly on the client Macintosh,it must export a name registry entry from the serving Macintosh into thename registry on the client Macintosh. When the name registry is transferred,USB Printer Sharing tries to maintain the properties from the servingMacintosh. For compatibility reasons, however, there are certain propertiesthat are not transferred. These properties are:</P><UL><LI><CODE>name</CODE></LI><LI><CODE>privateData</CODE></LI><LI><CODE>read</CODE></LI><LI><CODE>write</CODE></LI></UL><P>The most basic compatibility problem occurs when the name registrycontains properties whose data contains pointers into the serving Macintosh'smemory. When this data is transferred to the client Macintosh, these pointersare no longer valid and when software on the client tries to dereferencethe pointers, the Macintosh will either crash or the printer driver will getincorrect data. See <A HREF = "#Section5">Control and Status Calls</A> for a wayaround this problem.  In addition to the properties listed above, the USBPrinter Sharing software will not transfer a property whose name endswith '<CODE>.private</CODE>'. For example, the property '<CODE>mydata.private</CODE>' will notbe sent from the server to the client's name registry. Printer softwarecan use the '<CODE>.private</CODE>' suffix naming convention in order to preventproperties with pointers from being sent across the wire.</P><BR><P><A HREF = "#top">Back to top</a></p><BR><A NAME="Section2"></A><H2>Printer Name in the Chooser</H2><P>If a printer driver follows the USB DDK printer driver example, the printer names shown in the Chooser will be taken from the name registry. This is the recommended method for determining the name of a particular printer. There is a maximum length of 31 characters for name registry names, however, and the names created by USB Printer Sharing (a concatenation of the printer name, " on ", and the Computer name as set in the File Sharing control panel) can easily exceed this length. In order to make this full printer name available to printer drivers, the USB Printer Sharing software adds a property, <CODE>usbps.name</CODE>, that contains the entire printer name and can be up to 66 characters in length.</P><BR><P><A HREF = "#top">Back to top</a></p><BR><A NAME="Section3"></A><H2>Name Registry Properties</H2><P>Any unique name registry properties created by the USB Printer Sharing software, as opposed to those simply transferred from machine to machine by the Printer Sharing software, will be prefixed by '<CODE>usbps.</CODE>'. Currently there are two such properties:</P><UL><LI><CODE>usbps.name</CODE> - The full name of the printer</LI><LI><CODE>usbps.url</CODE> - The url for the remote printer</LI></UL><BR><P><A HREF = "#top">Back to top</a></p><BR><P><A NAME="Section4"></A></P><H2>Handling Errors</H2><P>It is important that printer drivers check the errors returned from device driver calls, both those immediately returned and those in the <CODE>ioResult</CODE> field of the <CODE>IOParam</CODE> block for asynchronous calls. Because of the network nature of USB Printer Sharing, errors (such as host unreachable) are much more common than local USB errors. Printer drivers should be prepared for these errors. In particular, a printer driver should be prepared for an open error as a result of their first read or write transaction. When the device driver is opened, USB Printer Sharing begins to connect with the remote printer, but it returns from open before this potentially long operation is completed. When the printer driver calls read or write, USB Printer Sharing may take that opportunity to return an error indicating that the open failed.</P><BR><P><A HREF = "#top">Back to top</a></p><BR><P><A NAME="Section5"></A></P><H2>Control and Status Calls</H2><P>In order for USB Printer Sharing to work, it needs to translate a device driver call made on a local Macintosh into a set of network packets that can be decoded and sent to a device driver on the server side. Using pointers in calls to the local device driver can cause problems as they reference memory on the local machine and these pointers are not valid on the server. USB Printer Sharing knows how to handle the buffer pointers that are part of the device driver read and write calls, but control and status can be problematic.  USB Printer Sharing special cases the following status call <CODE>csCodes</CODE> and knows how to dereference the pointers inherent in these calls:</P><UL><LI><CODE>kDrvrCentronicsStatus</CODE></LI><LI><CODE>kDrvr1284IdString</CODE></LI><LI><CODE>kDrvrSoftReset</CODE></LI><LI><CODE>kDrvrNumDevices</CODE></LI></UL><P>    In order for USB Printer Sharing to support your custom <CODE>csCodes</CODE>, you candefine any number of <CODE>csCodes</CODE> for USB Printer Sharing to handle using oneof two methods:  Direct or Indirect.</P><H3>Direct:</H3>   <P>In the Direct method, USB Printer Sharing looks for <CODE>drvrOut.csCodes2</CODE>   and <CODE>drvrIn.csCodes2</CODE> entries in the Name Registry. If either is   found, its data is taken as an array of shorts representing the extended   <CODE>csCodes</CODE> that are Direct <CODE>csCodes</CODE>.  The Printer Class driver supports these with the following   protocol: the   <CODE>csParam[ ]</CODE> array contains 11 shorts that are treated as 22 bytes of raw data,   starting at address <CODE>&amp;csParam[0]</CODE>.  Please note that USB Printer Sharing does   not handle pointers in the Direct case.  Do not include pointers in the 22 bytes of raw data.   If you need to pass pointer-based data, use the Indirect method described below.</P><H3>Indirect:</H3><P>In the Indirect method, USB Printer Sharing looks for <CODE>drvrOut.csCodes1</CODE> and <CODE>drvrIn.csCodes1</CODE> entries in the Name Registry. If either is found, its data is taken as an array of shorts representing the extended <CODE>csCodes</CODE> that are Indirect <CODE>csCodes</CODE>.  The Printer Class driver supports these with the following protocol:</P><TABLE BORDER=1 CELLPADDING=10 WIDTH=475>  <TR>  <td valign=top align=left>  <P><B>Data Address</B></P>  </TD>  <td valign=top align=left>  <P><B>Data Size</B></P>  </TD>  <td valign=top align=left>  <P><B>Data Type</B></P>  </TD>  <td valign=top align=left>  <P><B>Description</B></P>  </TD>  </TR>  <TR>  <td valign=top align=left>  <P>&amp;<CODE>csParam[0]</CODE></P>  </TD>  <td valign=top align=left>  <P>4 bytes</P>  </TD>  <td valign=top align=left>  <P>pointer</P>  </TD>  <td valign=top align=left>  <P>A pointer to a buffer that is passed from a device manager client to a device driver (i.e., the printer class driver).</P>  </TD>  </TR>  <TR>  <td valign=top align=left>  <P>&amp;<CODE>csParam[2]</CODE></P>  </TD>  <td valign=top align=left>  <P>4 bytes</P>  </TD>  <td valign=top align=left>  <P>unsigned long</P>  </TD>  <td valign=top align=left>  <P>The actual size of the data buffer pointed to by <CODE>csParam[0]</CODE>.  This value      is passed over to the Server in the case of <CODE>drvrOut.csCodes1</CODE> and back to the      Client in the case of <CODE>drvrIn.csCodes1</CODE>.</P>  </TD>  </TR>  <TR>  <td valign=top align=left>  <P>&amp;<CODE>csParam[4]</CODE></P>  </TD>  <td valign=top align=left>  <P>4 bytes</P>  </TD>  <td valign=top align=left>  <P>pointer</P>  </TD>  <td valign=top align=left>  <P>A pointer to a buffer that is to receive data returned from the printer class driver.</P>  </TD>  </TR>  <TR>  <td valign=top align=left>  <P>&amp;<CODE>csParam[6]</CODE></P>  </TD>  <td valign=top align=left>  <P>4 bytes</P>  </TD>  <td valign=top align=left>  <P>unsigned long</P>  </TD>  <td valign=top align=left><P>The maximum size of the data that can be returned in the buffer pointed to by<CODE>csParam[4]</CODE>. Upon return, this value is updated to indicate theactual number of bytes that were copied into the buffer.</P>  </TD>  </TR></TABLE><H4>Notes:</H4><UL><LI>The four bytes beginning at <CODE>csParam[0]</CODE> point to a buffer that is    passed from a device manager client to a device driver (i.e., the    printer class driver).</LI><LI>The four bytes beginning at <CODE>csParam[2]</CODE> are the actual size of the data    pointed to by <CODE>csParam[0]</CODE>.</LI><LI>If <CODE>csParam[0]</CODE> is <CODE>NULL</CODE> or <CODE>csParam[2]</CODE> is <CODE>0</CODE>, then no data is passed from    the client to the server.</LI><LI>The four bytes beginning at <CODE>csParam[4]</CODE> point to a buffer that is to    receive data returned from the printer class driver.</LI><LI>The four bytes beginning at <CODE>csParam[6]</CODE> are the maximum size of the data    that can be returned in <CODE>csParam[4]</CODE>.</LI><LI>If <CODE>csParam[4]</CODE> is <CODE>NULL</CODE> or <CODE>csParam[6]</CODE> is <CODE>0</CODE>, then no data will be copied    back from the server to the client.</LI><LI>The pointers to the buffers in <CODE>csParam[0]</CODE> and <CODE>csParam[4]</CODE> may overlap.</LI></UL><P>To add this capability to the sample PrinterClassDriver, insert thefollowing pieces of code.</P><P>In PrinterClassDriver.c's <CODE>RegisterDevice()</CODE> add:</P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>static short    ourCSCodes[] = { 200, 201, 202 };RegEntryID    self;OSErrerr = noErr;...if ( err == noErr )err = RegistryPropertyCreate( &amp;self, &quot;drvrOut.csCodes1&quot;,&amp;ourCSCodes, sizeof (ourCSCodes) );if ( err == noErr &amp;&amp; pPrinterPB-&gt;printerProtocol    != kUSBPrinterUnidirectionalProtocol )err = RegistryPropertyCreate( &amp;self, &quot;drvrIn.csCodes1&quot;,&amp;ourCSCodes, sizeof (ourCSCodes) );...</pre></TD></TR></TABLE></CENTER><BR><BR><P>In usbprint.c's <CODE>DRVRStatus()</CODE> add:</P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>switch ( pb-&gt;csCode ){case kDrvrCentronicsStatus:...case 200:case 201:case 202:    // do something useful here...}</pre></TD></TR></TABLE></CENTER><BR><BR><P>In PrinterClassDriver.c's <CODE>ControlStatusRequests()</CODE> add:</P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>switch( ((CntrlParam *) pb)-&gt;csCode ){case kDrvrCentronicsStatus:...case 200:case 201:case 202:    // do something useful here    break;...}</pre></TD></TR></TABLE></CENTER><BR><BR><BR><P><A HREF = "#top">Back to top</a></p><BR><P><A NAME="Section6"></A></P><H2>Gestalt Information</H2><P>The Gestalt Selector for USB Printer Sharing is <CODE>'zak '</CODE> and it returns    the version number of the running server.  The version number is encoded    in the low order word in the same manner as the system software version,    e.g., for 1.0 it would be <CODE>0x0100</CODE> and for version 1.2.3 it would be <CODE>0x0123</CODE>.    The upper two bits in the high order word are used as flags to indicate the    current state of USB Printer Sharing.</P>    <UL>   <LI>If the bit <CODE>0x80000000</CODE> is set, then USB Printer Sharing is running.</LI>   <LI>If the bit <CODE>0x40000000</CODE> is set, then USB Printer Sharing was installed at boot time.</LI>   <LI>A Gestalt error means that USB Printer Sharing is not installed.</LI></UL><P>Here are the constants to use for the above values:</P><TABLE BORDER=1 CELLPADDING=10 WIDTH=475>  <TR>     <td valign=top align=left>     <P><B>Constant</B></P>     </TD>     <td valign=top align=left>     <P><B>Value</B></P>     </TD>  </TR>  <TR><td valign=top align=left>     <P><CODE>kServerSignature</CODE></P></TD><td valign=top align=left>     <P><CODE>'zak '</CODE></P></TD>  </TR>  <TR><td valign=top align=left>     <P><CODE>gestaltUSBPrinterSharingVersion</CODE></P></TD><td valign=top align=left>     <P><CODE>kServerSignature</CODE></P></TD>  </TR>  <TR><td valign=top align=left>     <P><CODE>gestaltUSBPrinterSharingVersionMask</CODE></P></TD><td valign=top align=left>     <P><CODE>0x0000FFFF</CODE></P></TD>  </TR>  <TR><td valign=top align=left>     <P><CODE>gestaltUSBPrinterSharingAttr</CODE></P></TD><td valign=top align=left>     <P><CODE>kServerSignature</CODE></P></TD>  </TR>  <TR><td valign=top align=left>     <P><CODE>gestaltUSBPrinterSharingAttrMask</CODE></P></TD><td valign=top align=left>     <P><CODE>0xFFFF0000</CODE></P></TD>  </TR>  <TR><td valign=top align=left>     <P><CODE>gestaltUSBPrinterSharingAttrRunning</CODE></P></TD><td valign=top align=left>     <P><CODE>0x80000000</CODE></P></TD>  </TR>  <TR><td valign=top align=left>     <P><CODE>gestaltUSBPrinterSharingAttrBooted</CODE></P></TD><td valign=top align=left>     <P><CODE>0x40000000</CODE></P></TD>  </TR></TABLE><BR><P><A HREF = "#top">Back to top</a></p><BR><A NAME="Summary"></A>    <H2>Summary</H2><P>By paying attention to these simple guidelines, printer driver developerscan ensure that their drivers work seamlessly with USB Printer Sharingwhile retaining the ability to use custom <CODE>csCodes</CODE> and pass pointers to private data.</P>      <a name="References"></a><H2>References</H2>   <p><a href="http://developer.apple.com/macos/printing.html">   Apple's Printing Technologies</A></p>   <p><a href="http://developer.apple.com/hardware/usb/download.htm">Current USB DDK</A></p><BR><P><A HREF = "#top">Back to top</a></p><BR>      <A NAME="Downloads"></A> <h2>Downloadables</h2><center><TABLE BORDER=0 CELLPADDING=3 WIDTH="600"> <TR>     <td width=50 align=left>       <P ALIGN=center><img src="images/acrobatsmall.gif" align=middle alt="Acrobat" width=22 height=23></P>    </TD>    <td align="left">       <p>Acrobat version of this Note (120K).</P>    </TD>    <td width=60 align=left>       <p><A HREF="pdf/tn1199.pdf">Download</A></P>    </TD>  </TR> </table></center><BR><BR><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1199.html%3Fid%3DDTS10003038-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1199.html%3Fid%3DDTS10003038-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1199.html%3Fid%3DDTS10003038-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>