<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Error Handling Programming Guide For Cocoa: Recovering From Errors</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Recovering From Errors"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP40001806-CH206" title="Recovering From Errors"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000416" target="_top">Cocoa</a> &gt; <a href="../../../DesignGuidelines-date.html#//apple_ref/doc/uid/TP30000440-TP30000416-TP30000556" target="_top">Design Guidelines</a> &gt; <a href="../ErrorHandling/ErrorHandling.html#//apple_ref/doc/uid/TP40001806-CH201-SW1">Error Handling Programming Guide For Cocoa</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../HandleReceivedError/HandleReceivedError.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../RevisionHistory/RevisionHistory.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP40001806-CH206-BCIDEGGF" title="Recovering From Errors"></a><h1>Recovering From Errors</h1><p><a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_197"></a><a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_198"></a><a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_199"></a><a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_200"></a>As described in <span class="content_text"><a href="../ErrorObjectsDomains/ErrorObjectsDomains.html#//apple_ref/doc/uid/TP40001806-CH202-BBCJHJIG">“The Recovery Attempter,”</a></span> an <code><a href="../../../Reference/Foundation/Classes/NSError_Class/Reference/Reference.html#//apple_ref/occ/cl/NSError" target="_top">NSError</a></code> object can have a designated recovery attempter, an object that attempts to recover from the error if the user requests it. The error object holds a reference to the recovery attempter in its user info dictionary, so if the error object is passed around within an application, the recovery attempter stays with it. The user info dictionary<a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_201"></a> must also contain recovery options<a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_202"></a>, an array of localized strings for button titles, one or more of which requests recovery. When the error is presented in an alert and the user selects the recovery option, a message is sent to the recovery attempter, requesting it to do its job.</p><p>Ideally, the recovery attempter should be an independent object that knows something about the conditions of an error and how best to circumvent those conditions. An application could even have an object whose role is to recover from errors of various kinds. A recovery attempter must implement at least one of the two methods of the NSErrorRecoveryAttempting informal protocol<a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_203"></a>: <code>attemptRecoveryFromError:optionIndex:delegate:didRecoverSelector:contextInfo: <a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_204"></a></code> or <code>attemptRecoveryFromError:optionIndex:<a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_205"></a></code>. It implements the former method for error alerts presented document-modal<a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_206"></a>ly, and the latter method for application-modal alerts<a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_207"></a>.</p><p>You must also prepare an error object so that error recovery can take place. To do this, add three items to the user info dictionary of the error object:</p><ul class="ul"><li class="li"><p>The recovery-attempter object under the key <code><a href="../../../Reference/Foundation/Classes/NSError_Class/Reference/Reference.html#//apple_ref/doc/c_ref/NSRecoveryAttempterErrorKey" target="_top">NSRecoveryAttempterErrorKey</a></code><a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_208"></a></p></li><li class="li"><p>The recovery options, an array of localized strings, under the key <code><a href="../../../Reference/Foundation/Classes/NSError_Class/Reference/Reference.html#//apple_ref/doc/c_ref/NSLocalizedRecoveryOptionsErrorKey" target="_top">NSLocalizedRecoveryOptionsErrorKey</a></code><a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_209"></a></p></li><li class="li"><p>A recovery-suggestion<a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_210"></a> string, also localized, under the key <code><a href="../../../Reference/Foundation/Classes/NSError_Class/Reference/Reference.html#//apple_ref/doc/c_ref/NSLocalizedRecoverySuggestionErrorKey" target="_top">NSLocalizedRecoverySuggestionErrorKey</a></code><a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_211"></a>. Although this property is not strictly required, an error alert that offers recovery as an option should display this string. And if the string refers to particular button titles, it should use the same titles in the recovery-options array.</p><p>For guidelines about error alerts, see <em><a href="../../../../UserExperience/Conceptual/AppleHIGuidelines/index.html#//apple_ref/doc/uid/20000957" target="_top">Apple Human Interface Guidelines</a></em> (section on dialogs in “<span class="content_text"><a href="../../../../UserExperience/Conceptual/AppleHIGuidelines/XHIGWindows/XHIGWindows.html#//apple_ref/doc/uid/20000961" target="_top">Windows</a></span>“).</p></li></ul><p><span class="content_text">Listing 5-1</span> illustrates a case involving the NSXMLDocument class<a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_212"></a>. In this example, an NSDocument object attempts to create an internal tree representing an XML document using the <code>initWithContentsOfURL:options:error:</code> method of NSXMLDocument. If the attempt fails, the usual cause is that the source XML is malformed—for example, there is a missing end tag for an element, or an attribute value is not quoted. If the source XML is “tidied” first to fix the structural problems, it may be possible to create the XML tree. </p><p>In the example in <span class="content_text">Listing 5-1</span> if the invocation of <code>initWithContentsOfURL:options:error:</code> returns an error object by reference, the document object customizes the error object, adding (among other things) a recovery-attempter object, localized recovery options, and a localized recovery suggestion to its user info dictionary. Then it sends <code>presentError:modalForWindow:delegate:didPresentSelector:contextInfo:</code> to <code>self</code>.</p><a name="//apple_ref/doc/uid/TP40001806-CH206-BCIEDAIJ" title="Listing 5-1Preparing for error recovery"></a><p class="codesample"><strong>Listing 5-1&nbsp;&nbsp;</strong>Preparing for error recovery</p><div class="codesample"><table><tr><td scope="row"><pre>- (BOOL)readFromURL:(NSURL *)furl ofType:(NSString *)type error:(NSError **)anError {<span></span></pre></td></tr><tr><td scope="row"><pre>    NSError *err=nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    if (xmlDoc) {<span></span></pre></td></tr><tr><td scope="row"><pre>        [xmlDoc release];<span></span></pre></td></tr><tr><td scope="row"><pre>        xmlDoc = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    // xmlDoc is an NSXMLDocument instance variable<span></span></pre></td></tr><tr><td scope="row"><pre>    xmlDoc = [[NSXMLDocument alloc] initWithContentsOfURL:furl<span></span></pre></td></tr><tr><td scope="row"><pre>            options:NSXMLNodeOptionsNone error:&amp;err];<span></span></pre></td></tr><tr><td scope="row"><pre>    if (xmlDoc == nil &amp;&amp; err) {<span></span></pre></td></tr><tr><td scope="row"><pre>        NSString *newDesc = [[err localizedDescription] stringByAppendingString:<span></span></pre></td></tr><tr><td scope="row"><pre>            ([err localizedFailureReason] ? [err localizedFailureReason] : @"")];<span></span></pre></td></tr><tr><td scope="row"><pre>        NSMutableDictionary *newDict = [NSMutableDictionary dictionaryWithCapacity:4];<span></span></pre></td></tr><tr><td scope="row"><pre>        [newDict setObject:newDesc forKey:NSLocalizedDescriptionKey];<span></span></pre></td></tr><tr><td scope="row"><pre>        [newDict setObject:<span></span></pre></td></tr><tr><td scope="row"><pre>            NSLocalizedString(@"Would you like to tidy the XML and try again?", @"")<span></span></pre></td></tr><tr><td scope="row"><pre>            forKey:NSLocalizedRecoverySuggestionErrorKey];<span></span></pre></td></tr><tr><td scope="row"><pre>        [newDict setObject:self forKey:NSRecoveryAttempterErrorKey];<span></span></pre></td></tr><tr><td scope="row"><pre>        [newDict setObject:[NSArray arrayWithObjects:<span></span></pre></td></tr><tr><td scope="row"><pre>            NSLocalizedString(@"Try Again", @""), NSLocalizedString(@"Cancel", @""),<span></span></pre></td></tr><tr><td scope="row"><pre>            nil] forKey:NSLocalizedRecoveryOptionsErrorKey];<span></span></pre></td></tr><tr><td scope="row"><pre>        [newDict setObject:furl forKey:NSURLErrorKey];<span></span></pre></td></tr><tr><td scope="row"><pre>        NSError *newError = [[NSError alloc] initWithDomain:[err domain]<span></span></pre></td></tr><tr><td scope="row"><pre>            code:[err code] userInfo:newDict];<span></span></pre></td></tr><tr><td scope="row"><pre>        [self presentError:newError modalForWindow:[self windowForSheet]<span></span></pre></td></tr><tr><td scope="row"><pre>            delegate:self<span></span></pre></td></tr><tr><td scope="row"><pre>            didPresentSelector:@selector(didPresentErrorWithRecovery:contextInfo:)<span></span></pre></td></tr><tr><td scope="row"><pre>            contextInfo:nil];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>// ...<span></span></pre></td></tr></table></div>	<p>Note that the document object also adds to the user info dictionary the URL identifying the source of XML. The recovery attempter will use this URL when it attempts to create a tree representing the XML.</p><p>The error object is passed up the error-responder chain<a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_213"></a> and NSApp<a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_214"></a> displays it. When the user clicks any button of the error alert, NSApp checks to see if the error object has both a recovery attempter and recovery options. If both of these conditions are true, it invokes the method implemented by the recovery attempter that corresponds to the mode of the alert (that is, document-modal or application-modal). </p><p><span class="content_text">Listing 5-2</span> shows how the recovery attempter for the XML document implements the <code>attemptRecoveryFromError:optionIndex:delegate:didRecoverSelector:contextInfo:</code> method.</p><a name="//apple_ref/doc/uid/TP40001806-CH206-BBCJGGAI" title="Listing 5-2Recovering from the error and informing the modal delegate"></a><p class="codesample"><strong>Listing 5-2&nbsp;&nbsp;</strong>Recovering from the error and informing the modal delegate</p><div class="codesample"><table><tr><td scope="row"><pre>- (void)attemptRecoveryFromError:(NSError *)error<span></span></pre></td></tr><tr><td scope="row"><pre>                     optionIndex:(unsigned int)recoveryOptionIndex<span></span></pre></td></tr><tr><td scope="row"><pre>                        delegate:(id)delegate<span></span></pre></td></tr><tr><td scope="row"><pre>              didRecoverSelector:(SEL)didRecoverSelector<span></span></pre></td></tr><tr><td scope="row"><pre>                     contextInfo:(void *)contextInfo {<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    BOOL success=NO;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSError *err=nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSInvocation *invoke = [NSInvocation invocationWithMethodSignature:[delegate methodSignatureForSelector:didRecoverSelector]];<span></span></pre></td></tr><tr><td scope="row"><pre>    [invoke setSelector:didRecoverSelector];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (recoveryOptionIndex == 0) { // recovery requested<span></span></pre></td></tr><tr><td scope="row"><pre>        xmlDoc = [[NSXMLDocument alloc] initWithContentsOfURL:[[error userInfo]<span></span></pre></td></tr><tr><td scope="row"><pre>                objectForKey:NSURLErrorKey] options:NSXMLDocumentTidyXML error:&amp;err];<span></span></pre></td></tr><tr><td scope="row"><pre>        if (xmlDoc != nil) {<span></span></pre></td></tr><tr><td scope="row"><pre>            success = YES;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    [invoke setArgument:(void *)&amp;success atIndex:2];<span></span></pre></td></tr><tr><td scope="row"><pre>    if (err)<span></span></pre></td></tr><tr><td scope="row"><pre>        [invoke setArgument:&amp;err atIndex:3];<span></span></pre></td></tr><tr><td scope="row"><pre>    [invoke invokeWithTarget:delegate];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>	<p>The key part of the above example is the test the recovery attempter makes to determine if the user clicked the “Try Again” button: it checks the value of <code>recoveryOptionIndex</code>. If the user did click this button, the recovery attempter invokes the <code>initWithContentsOfURL:options:error:</code> method again, this time with the <code><a href="../../../Reference/Foundation/Classes/NSXMLDocument_Class/Reference/Reference.html#//apple_ref/doc/c_ref/NSXMLDocumentTidyXML" target="_top">NSXMLDocumentTidyXML</a></code> option. Then it creates and invokes an NSInvocation object, thereby sending the required message to the modal delegate of the error alert. The invocation object includes the two parameters required by the delegate’s selector: a Boolean indicating whether the recovery attempt succeeded and a “context info” parameter which, in this case, contains any error object returned from the recovery attempt.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP40001806-CH206-SW1" title="Note"></a><p><strong>Note:</strong>&nbsp;The example in <span class="content_text">Listing 5-2</span> shows the use of NSInvocation<a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_215"></a> to send a message. However, if you have a reference to the modal delegate and know the name of the method it implements, you can send the message directly.</p></div><p>When the modal delegate<a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_216"></a> receives the message from the recovery attempter, as in <span class="content_text">Listing 5-3</span>, it can respond appropriately.<a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_217"></a><a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_218"></a><a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_219"></a><a name="//apple_ref/doc/uid/TP40001806-CH206-DontLinkElementID_220"></a></p><a name="//apple_ref/doc/uid/TP40001806-CH206-BBCFBEDC" title="Listing 5-3Modal delegate responding to recovery attempter"></a><p class="codesample"><strong>Listing 5-3&nbsp;&nbsp;</strong>Modal delegate responding to recovery attempter</p><div class="codesample"><table><tr><td scope="row"><pre>- (void)didPresentErrorWithRecovery:(BOOL)didRecover<span></span></pre></td></tr><tr><td scope="row"><pre>            contextInfo:(void *)contextInfo {<span></span></pre></td></tr><tr><td scope="row"><pre>NSError *theError = (NSError *)contextInfo;<span></span></pre></td></tr><tr><td scope="row"><pre>    if (didRecover) {<span></span></pre></td></tr><tr><td scope="row"><pre>        [tableView reloadData];<span></span></pre></td></tr><tr><td scope="row"><pre>    } else if (theError &amp;&amp; [theError isKindOfClass:[NSError class]]) {<span></span></pre></td></tr><tr><td scope="row"><pre>        [NSAlert alertWithError:theError];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../HandleReceivedError/HandleReceivedError.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../RevisionHistory/RevisionHistory.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2005, 2009 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2009-03-04<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Cocoa/Conceptual/ErrorHandlingCocoa/RecoverFromErrors/RecoverFromErrors.html%3Fid%3DTP40001806-1.4&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Cocoa/Conceptual/ErrorHandlingCocoa/RecoverFromErrors/RecoverFromErrors.html%3Fid%3DTP40001806-1.4&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Cocoa/Conceptual/ErrorHandlingCocoa/RecoverFromErrors/RecoverFromErrors.html%3Fid%3DTP40001806-1.4&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>