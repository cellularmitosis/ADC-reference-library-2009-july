<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Quartz Composer Custom Patch Programming Guide: Writing Processor Patches</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Writing Processor Patches"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP40004787-CH4" title="Writing Processor Patches"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000424" target="_top">Graphics &amp; Imaging</a> &gt; <a href="../../../Quartz-date.html#//apple_ref/doc/uid/TP30000440-TP30000424-TP30000559" target="_top">Quartz</a> &gt; <a href="../Introduction/Introduction.html#//apple_ref/doc/uid/TP40004787-CH1-DontLinkElementID_14">Quartz Composer Custom Patch Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../plugin_1/plugin_1.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../qc_image_proc/qc_image_proc.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP40004787-CH4-SW1" title="Writing Processor Patches"></a><h1>Writing Processor Patches</h1><p>A custom processor patch is true to its name. It <em>processes</em> data in response to changes in the values of its input parameters. This chapter shows how to write a custom patch that processes strings and another that processes numeric values. You’ll use Objective-C 2.0 properties to define the input and output parameters. Then you’ll see how to modify the numeric value processor so that it uses internal settings. By using the template provided in Xcode, you’ll package each custom patch as a plug-in that the Quartz Composer development tool can recognize. Any custom patch included in a plug-in shows up in the Quartz Composer Patch Creator.</p>
<!-- This template is being used for both PDF and HTML. -->

    
    <h4>In this section:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="WritingProcessorPatches.html#//apple_ref/doc/uid/TP40004787-CH4-SW5">dotCom: Creating Domain Names</a>
				
			<br/>
			
        
			
			
				<a href="WritingProcessorPatches.html#//apple_ref/doc/uid/TP40004787-CH4-DontLinkElementID_5">MIDI2Color: Mapping MIDI Values to Colors</a>
				
			<br/>
			
        
			
			
				<a href="WritingProcessorPatches.html#//apple_ref/doc/uid/TP40004787-CH4-DontLinkElementID_6">Number2Color: Extending MIDI2Color</a>
				
			<br/>
			
        
			
			
				<a href="WritingProcessorPatches.html#//apple_ref/doc/uid/TP40004787-CH4-DontLinkElementID_7">Packaging Two Custom Patches in a Plug-in</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP40004787-CH4-SW5" title="dotCom: Creating Domain Names"></a><h2>dotCom: Creating Domain Names</h2><p>The dotCom custom patch takes any string as input and appends <code>.com</code> to it. For example, if the input string is <code>patch</code> then the output string is <code>patch.com</code>. When packaged as a plug-in that’s loaded into the Quartz Composer development tool, the resulting custom patch looks like what’s shown in <span class="content_text">Figure 2-1</span>.  By creating this simple patch first, you’ll learn the critical parts of a custom patch and how to bundle them together.</p><br/><div><a name="//apple_ref/doc/uid/TP40004787-CH4-SW2" title="Figure 2-1The dotCom custom patch"></a><p><strong>Figure 2-1&nbsp;&nbsp;</strong>The dotCom custom patch</p><img src = "../art/dotcom_patch.jpg" alt = "The dotCom custom patch" ></div><br/><p>Follow these steps to create the dotCom custom patch:</p><ol class="ol"><li class="li"><p>Open Xcode and choose File > New Project.</p></li><li class="li"><p>In the New Project window, choose Standard Apple Plug-ins > Quartz Composer Plug-in and click Next.</p></li><li class="li"><p>Enter <code>dotCom</code> in the Project Name text field and click Finish.</p><p>The project opens with these files.</p><div class="item_figure"><img src = "../art/dotcom_xcode_files.jpg" alt = "graphic" ></div></li><li class="li"><p>Open the <code>dotComPlugin.h</code> file.</p><p>The plug-in template automatically subclasses <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/cl/QCPlugIn" target="_top">QCPlugIn</a></code>. Declare two string properties to use as the input and output parameters. Recall that input parameter keys must start with <code>input</code> and output parameter keys must start with <code>output</code>. Your code should look as follows:</p><a name="//apple_ref/doc/uid/TP40004787-CH4-SW3"></a><div class="codesample"><table><tr><td scope="row"><pre>#import &lt;Quartz/Quartz.h><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@interface dotComPlugIn : QCPlugIn<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre>@property(assign) NSString* inputString;<span></span></pre></td></tr><tr><td scope="row"><pre>@property(assign) NSString* outputString;<span></span></pre></td></tr><tr><td scope="row"><pre>@end<span></span></pre></td></tr></table></div></li><li class="li"><p>Close the <code>dotComPlugIn.h</code> file.</p></li><li class="li"><p>Open the <code>dotComPlugIn.m</code> file. </p></li><li class="li"><p>Just after the <code>@implementation</code> statement, add the following directives so that Quartz Composer handles the  implementation of the parameters.</p><div class="codesample"><table><tr><td scope="row"><pre>@dynamic inputString, outputString;<span></span></pre></td></tr></table></div></li><li class="li"><p>Supply a description for the custom patch.</p><p>This description is what the user will see in Quartz Composer. Modify the description to look as follows:</p><div class="codesample"><table><tr><td scope="row"><pre>#define    kQCPlugIn_Description  @"Appends \".com\" to any string."<span></span></pre></td></tr></table></div><p>Note that Xcode automatically defines the custom patch name based on the project name you supplied. In this case, the name is <code>dotCom</code>.</p><div class="codesample"><table><tr><td scope="row"><pre>#define    kQCPlugIn_Name  @"dotCom"<span></span></pre></td></tr></table></div><p>You can change the name if you’d like. This name shows up in the Patch Creator as the patch name. Although the name does not need to be unique, it’s best for the user if the patch name is both descriptive and unique.</p></li><li class="li"><p>Next you’ll write the methods needed to implement the <code>dotComPlugIn</code> subclass. You do not need to modify the default <code>attributes</code> method supplied in the template, which should look as follows: </p><div class="codesample"><table><tr><td scope="row"><pre>+ (NSDictionary*) attributes<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return [NSDictionary dictionaryWithObjectsAndKeys:<span></span></pre></td></tr><tr><td scope="row"><pre>                kQCPlugIn_Name,QCPlugInAttributeNameKey,<span></span></pre></td></tr><tr><td scope="row"><pre>                kQCPlugIn_Description,QCPlugInAttributeDescriptionKey,<span></span></pre></td></tr><tr><td scope="row"><pre>                nil];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Modify the <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/clm/QCPlugIn/attributesForPropertyPortWithKey:" target="_top">attributesForPropertyPortWithKey:</a></code> so that it returns a dictionary for each input and output parameter. Each dictionary must contain a value followed by its port attribute name key. If the port has a default value, the dictionary should contain the value followed by the default value key.</p><p>The port attribute key name is what appears as a label for the custom patch port in Quartz Composer. Essentially what you are doing is mapping the <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/cl/QCPlugIn" target="_top">QCPlugIn</a></code> subclass parameter keys to custom patch port names. You’ll also want to define a reasonable default value.</p><p>For the dotCom plug-in, modify the method so it looks as follows:</p><div class="codesample"><table><tr><td scope="row"><pre>+ (NSDictionary*) attributesForPropertyPortWithKey:(NSString*)key<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    if([key isEqualToString:@"inputString"])<span></span></pre></td></tr><tr><td scope="row"><pre>        return [NSDictionary dictionaryWithObjectsAndKeys:<span></span></pre></td></tr><tr><td scope="row"><pre>            @"Name", QCPortAttributeNameKey,<span></span></pre></td></tr><tr><td scope="row"><pre>            @"mydomain",  QCPortAttributeDefaultValueKey,<span></span></pre></td></tr><tr><td scope="row"><pre>            nil];<span></span></pre></td></tr><tr><td scope="row"><pre>    if([key isEqualToString:@"outputString"])<span></span></pre></td></tr><tr><td scope="row"><pre>        return [NSDictionary dictionaryWithObjectsAndKeys:<span></span></pre></td></tr><tr><td scope="row"><pre>            @"Name.com", QCPortAttributeNameKey,<span></span></pre></td></tr><tr><td scope="row"><pre>            nil];<span></span></pre></td></tr><tr><td scope="row"><pre>    return nil;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Make sure the <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/clm/QCPlugIn/executionMode" target="_top">executionMode</a></code>  method returns  <code>kQCPlugInExecutionModeProcessor</code>.</p><p>This is a processor patch—it takes input values, processes them, and outputs a value.</p><div class="codesample"><table><tr><td scope="row"><pre>+ (QCPlugInExecutionMode) executionMode<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return kQCPlugInExecutionModeProcessor;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Make sure the <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/clm/QCPlugIn/timeMode" target="_top">timeMode</a></code> method returns <code>kQCPlugInTimeModeNone</code>.</p><p>The dotCom plug-in needs to execute only when the input string changes.</p><div class="codesample"><table><tr><td scope="row"><pre>+ (QCPlugInTimeMode) timeMode<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return kQCPlugInTimeModeNone;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>The execution method is where the processing takes place. For the dotCom custom patch, it is fairly straightforward. The method needs to append the string <code>.com</code> to whatever string it passed to the patch. The code should look as follows: </p><div class="codesample"><table><tr><td scope="row"><pre>- (BOOL) execute:(id&lt;QCPlugInContext>)context<span></span></pre></td></tr><tr><td scope="row"><pre>            atTime:(NSTimeInterval)time<span></span></pre></td></tr><tr><td scope="row"><pre>            withArguments:(NSDictionary*)arguments<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    self.outputString = [self.inputString stringByAppendingString:@".com"];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return YES;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Note that you use <code>self.&lt;propertyname></code> to access property values. Recall that you can only read the values of input parameters, but you can read and write the values of output parameters.</p></li><li class="li"><p>Save and close the <code>dotComPlugIn.m</code> file.</p></li><li class="li"><p>Open the <code>Info.plist</code> file.</p><p>Notice that Xcode automatically adds the following entry, which is required, in the dictionary.</p><div class="codesample"><table><tr><td scope="row"><pre>&lt;key>QCPlugInClasses&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;array><span></span></pre></td></tr><tr><td scope="row"><pre>    &lt;string>dotComPlugIn&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;/array><span></span></pre></td></tr></table></div><p>If you add another custom patch to the project, you need to add the name of the <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/cl/QCPlugIn" target="_top">QCPlugIn</a></code> subclass as an entry here. However, you don’t need to add anything for the dotCom custom patch. </p><p>If you want, you can customize the bundle identifier before saving and closing the file.</p></li><li class="li"><p>Under Targets, choose Build &amp; Copy. Then, click Build “Build &amp; Copy” and Start from the Action pop-up menu.</p><p>When you build using this option, Xcode copies the successfully built plug-in to <code>~/Library/Graphics/Quartz Composer Plug-Ins</code> and launches the Quartz Composer development tool.</p></li><li class="li"><p>After Quartz Composer launches, create a blank composition. Click Patch Creator and type <code>dot</code> in the Search field.</p><div class="item_figure"><img src = "../art/dotcom_in_library.jpg" alt = "graphic" ></div></li><li class="li"><p>Double-click the dotCom name to create an instance in the Editor window. Then add instances of the Image With String, Clear, and Billboard patches to the editor window. Connect them as shown and make sure that the dotCom custom patch works as it should.</p><div class="item_figure"><img src = "../art/dotcom_comp.jpg" alt = "graphic" ></div><p>The output in the Viewer should look like this:</p><div class="item_figure"><img src = "../art/dotcom_output.jpg" alt = "graphic" ></div></li></ol><a name="//apple_ref/doc/uid/TP40004787-CH4-DontLinkElementID_5" title="MIDI2Color: Mapping MIDI Values to Colors"></a><h2>MIDI2Color: Mapping MIDI Values to Colors</h2><p>MIDI (Musical Instrument Digital Interface) is a communication standard that allows electronic musical instruments to send signals to each other for the purpose of controlling, monitoring, and editing musical events (note on, note off, volume, synthesizer voice, and so on). The MIDI2Color custom patch that you’ll create in this section maps a numerical value, in the range of 0 to 127, to a color. Many MIDI values fall in the 0 to 127 range, such as MIDI note number and volume. </p><p>The idea behind the MIDI2Color custom patch is to map a particular pitch (C, C#/Db, D, D#/Eb,E, F, and so on) to a color and to map the octave that the pitch resides in to an alpha value. Low pitches produce the most opaque colors and high pitches produce the most transparent colors. In this way, you can create a composition that uses MIDI information to drive the colors used for graphical output.  <span class="content_text">Figure 2-2</span> shows the spectrum of colors that the MIDI2Color custom patch produces. The lowest octaves are on the left, the highest on the right. The pitches range from C to B, starting at the bottom and increasing towards the top.</p><br/><div><a name="//apple_ref/doc/uid/TP40004787-CH4-SW4" title="Figure 2-2The spectrum of RGBA colors produced by the MIDI2Color custom patch"></a><p><strong>Figure 2-2&nbsp;&nbsp;</strong>The spectrum of RGBA colors produced by the MIDI2Color custom patch</p><img src = "../art/spectrum.jpg" alt = "The spectrum of RGBA colors produced by the MIDI2Color custom patch" ></div><br/><p>You’ll see that many of the steps needed to create the MIDI2Color custom patch are the same as those used to create the dotCom custom patch.</p><p>To create the MIDI2Color custom patch, follow these steps:</p><ol class="ol"><li class="li"><p>Open Xcode and choose File > New Project.</p></li><li class="li"><p>In the New Project window, choose Standard Apple Plug-ins > Quartz Composer Plug-in and click Next.</p></li><li class="li"><p>Enter <code>MIDI2Color</code> in the Project Name text field and click Finish.</p></li><li class="li"><p>Open the <code>MIDI2ColorPlugin.h</code> file.</p><p>The Xcode template automatically subclasses <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/cl/QCPlugIn" target="_top">QCPlugIn</a></code>. You need to  add property declarations for an input parameter that is a numerical value and an output parameter that is a color. Recall from <span class="content_text"><a href="../plugin_1/plugin_1.html#//apple_ref/doc/uid/TP40004787-CH3-SW2">Table 1-1</a></span> that ports that take a numerical value are declared as properties whose data type is <code>double</code>. Ports that are for colors require a property whose data type is a <code><a href="../../../Reference/CGColor/Reference/reference.html#//apple_ref/c/tdef/CGColorRef" target="_top">CGColorRef</a></code>.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP40004787-CH4-DontLinkElementID_17" title="Note"></a><p><strong>Note:</strong>&nbsp;<code><a href="../../../Reference/CGColor/Reference/reference.html#//apple_ref/c/tdef/CGColorRef" target="_top">CGColorRef</a></code> is defined in the Quartz 2D programming interface (see <em><a href="../../../Reference/CGColor/index.html#//apple_ref/doc/uid/TP30000948" target="_top">CGColor Reference</a></em>). If you are unfamiliar with Quartz colors and color spaces, you may want to take a look at the reference and read the chapter on colors in <em><a href="../../drawingwithquartz2d/index.html#//apple_ref/doc/uid/TP30001066" target="_top">Quartz 2D Programming Guide</a></em>. </p></div><p>You should also add an internal variable for a color space. Later, you’ll create a color space and save it in this variable to avoid creating and releasing the color space each time you need to output a different color. Although the color output by your custom patch may change, the color space remains the same for each instance of the patch.</p><p>When you are done modifying the interface file, it should look as follows: </p><div class="codesample"><table><tr><td scope="row"><pre>#import &lt;Quartz/Quartz.h><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@interface MIDI2ColorPlugIn : QCPlugIn<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CGColorSpaceRef myColorSpace;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre>// Declare a property input port of type Index and with the key inputValue<span></span></pre></td></tr><tr><td scope="row"><pre>@property NSUInteger inputValue;<span></span></pre></td></tr><tr><td scope="row"><pre>// Declare a property input port of type "Color" and with the key outputColor<span></span></pre></td></tr><tr><td scope="row"><pre>@property(assign) CGColorRef outputColor;<span></span></pre></td></tr><tr><td scope="row"><pre>@end<span></span></pre></td></tr></table></div></li><li class="li"><p>Save and close the <code>MIDI2ColorPlugIn.h</code> file.</p></li><li class="li"><p>Open the <code>MIDI2ColorPlugin.m</code> file.</p></li><li class="li"><p>Just after the <code>@implementation</code> statement, add the following directives. Quartz Composer will handle their implementation.</p><div class="codesample"><table><tr><td scope="row"><pre>@dynamic inputValue, outputColor;<span></span></pre></td></tr></table></div></li><li class="li"><p>Define a name and description for the custom patch.</p><p>The name is already provided for you. You don’t need to change it. Modify the description as shown:</p><div class="codesample"><table><tr><td scope="row"><pre>#define    kQCPlugIn_Name @"MIDI2Color"<span></span></pre></td></tr><tr><td scope="row"><pre>#define    kQCPlugIn_Description  @"Converts a MIDI value to a color with transparency."<span></span></pre></td></tr></table></div></li><li class="li"><p>Next you’ll write the methods needed to implement the <code>MIDI2ColorPlugIn</code> subclass, starting with the  <code>attributes</code> method. The implementation provided by the template should look as follows and doesn’t need any modification:</p><div class="codesample"><table><tr><td scope="row"><pre>+ (NSDictionary*) attributes<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return [NSDictionary dictionaryWithObjectsAndKeys:<span></span></pre></td></tr><tr><td scope="row"><pre>                kQCPlugIn_Name,QCPlugInAttributeNameKey,<span></span></pre></td></tr><tr><td scope="row"><pre>                kQCPlugIn_Description,QCPlugInAttributeDescriptionKey,<span></span></pre></td></tr><tr><td scope="row"><pre>                nil];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Modify the <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/clm/QCPlugIn/attributesForPropertyPortWithKey:" target="_top">attributesForPropertyPortWithKey:</a></code>  so that it returns a dictionary for each input and output parameter. Each dictionary must contain a value followed by its port attribute name key. If the port has a default value, the dictionary should contain the value followed by the default value key. </p><p>If the input values need to be within a certain range, you should provide maximum and minimum values. MIDI values should range from 0 to 127, inclusive, so this example provides an opportunity for you to add these values.</p><p>For the MIDI2Color plug-in, modify the method so it looks as follows. </p><div class="codesample"><table><tr><td scope="row"><pre>+ (NSDictionary*) attributesForPropertyPortWithKey:(NSString*)key<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    if([key isEqualToString:@"inputValue"])<span></span></pre></td></tr><tr><td scope="row"><pre>        return [NSDictionary dictionaryWithObjectsAndKeys:<span></span></pre></td></tr><tr><td scope="row"><pre>            @"Input Value", QCPortAttributeNameKey,<span></span></pre></td></tr><tr><td scope="row"><pre>            [NSNumber numberWithUnsignedInteger:64],  QCPortAttributeDefaultValueKey,<span></span></pre></td></tr><tr><td scope="row"><pre>            [NSNumber numberWithUnsignedInteger:127],  QCPortAttributeMaximumValueKey,<span></span></pre></td></tr><tr><td scope="row"><pre>            [NSNumber numberWithUnsignedInteger:0],  QCPortAttributeMinimumValueKey,<span></span></pre></td></tr><tr><td scope="row"><pre>            nil];<span></span></pre></td></tr><tr><td scope="row"><pre>    if([key isEqualToString:@"outputColor"])<span></span></pre></td></tr><tr><td scope="row"><pre>        return [NSDictionary dictionaryWithObjectsAndKeys:<span></span></pre></td></tr><tr><td scope="row"><pre>            @"Output Color", QCPortAttributeNameKey,<span></span></pre></td></tr><tr><td scope="row"><pre>            nil];<span></span></pre></td></tr><tr><td scope="row"><pre>    return nil;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Make sure the <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/clm/QCPlugIn/executionMode" target="_top">executionMode</a></code> method returns <code>kQCPlugInExecutionModeProcessor</code></p><div class="codesample"><table><tr><td scope="row"><pre>+ (QCPlugInExecutionMode) executionMode<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return kQCPlugInExecutionModeProcessor;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Make sure the <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/clm/QCPlugIn/timeMode" target="_top">timeMode</a></code>  method returns <code>kQCPlugInTimeModeNone</code>.</p><p>The MIDI2Color custom patch needs to execute only when the input value changes; it does not depend on time.</p><div class="codesample"><table><tr><td scope="row"><pre>+ (QCPlugInTimeMode) timeMode<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return kQCPlugInTimeModeNone;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Modify the <code>startExecution:</code> method to create a color space object.</p><p>For this example, you can use the <code>startExecution:</code> method to create and initialize a Quartz color space. The color space should remain the same throughout the life of the custom patch instance. You’ll create the color space when the patch starts executing, store it in the <code>colorSpace</code> instance variable you created previously, and then release it when the custom patch instance is no longer executing.</p><div class="codesample"><table><tr><td scope="row"><pre>- (BOOL) startExecution:(id&lt;QCPlugInContext>)context<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>   myColorSpace = CGColorSpaceCreateWithName(kCGColorSpaceGenericRGB);<span></span></pre></td></tr><tr><td scope="row"><pre>   return YES;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Modify the <code>stopExecution:</code> method to release the color space object.</p><div class="codesample"><table><tr><td scope="row"><pre>- (void) stopExecution:(id&lt;QCPlugInContext>)context<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CGColorSpaceRelease(myColorSpace);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Write the execution method for the MIDI2Color custom patch. </p><p>The method converts a value that’s in the range of 0 to 127 to an RGBA color (red, green, blue, alpha). First, the code figures out which octave the input value resides in. Then it finds out which pitch class the value represents. The RGB color values are determined by the pitch class, while the alpha value is determined by the octave. The lower the octave, the more opaque the color.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP40004787-CH4-DontLinkElementID_18" title="Note"></a><p><strong>Note:</strong>&nbsp;A pitch class represents the pitches that have the same note name, regardless of octave. There are twelve pitch classes—C, C#/Db, D, D#/Eb, E, F, F#/Gb, G, G#/Ab, A, A#/Bb, and B. C# and Db are enharmonic equivalents—different labels for the same thing—as are D# and Eb, F# and Gb, and so on.</p></div><p>Modify the <code>execute:atTime:withArguments:</code> method to look as follows:</p><div class="codesample"><table><tr><td scope="row"><pre>- (BOOL) execute:(id&lt;QCPlugInContext>)context<span></span></pre></td></tr><tr><td scope="row"><pre>            atTime:(NSTimeInterval)time<span></span></pre></td></tr><tr><td scope="row"><pre>            withArguments:(NSDictionary*)arguments<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    static float color[4];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Use a Quartz color<span></span></pre></td></tr><tr><td scope="row"><pre>    CGColorRef myColor;<span></span></pre></td></tr><tr><td scope="row"><pre>    int pitch, octave;<span></span></pre></td></tr><tr><td scope="row"><pre>    float alpha;<span></span></pre></td></tr><tr><td scope="row"><pre>    octave = floor(self.inputValue/12);<span></span></pre></td></tr><tr><td scope="row"><pre>    pitch = (int) (self.inputValue - (octave * 12));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Set the RGB values according to pitch: C, C#/Db, D, E, and so on<span></span></pre></td></tr><tr><td scope="row"><pre>    switch (pitch) {<span></span></pre></td></tr><tr><td scope="row"><pre>        case 0: color[0] = 1.0; color[1] = 0.0; color[2] = 0.0; break; // C<span></span></pre></td></tr><tr><td scope="row"><pre>        case 1: color[0] = 1.0; color[1] = 0.5; color[2] = 0.0; break; // C#/Db<span></span></pre></td></tr><tr><td scope="row"><pre>        case 2: color[0] = 1.0; color[1] = 0.75; color[2] = 0.0; break; // D<span></span></pre></td></tr><tr><td scope="row"><pre>        case 3: color[0] = 1.0; color[1] = 1.0; color[2] = 0.0; break; //D#/Eb<span></span></pre></td></tr><tr><td scope="row"><pre>        case 4: color[0] = 0.5; color[1] = 1.0; color[2] = 0.0; break; //E<span></span></pre></td></tr><tr><td scope="row"><pre>        case 5: color[0] = 0.0; color[1] = 1.0; color[2] = 0.0; break; //F<span></span></pre></td></tr><tr><td scope="row"><pre>        case 6: color[0] = 0.0; color[1] = 0.5; color[2] = 0.5; break; //F#/Gb<span></span></pre></td></tr><tr><td scope="row"><pre>        case 7: color[0] = 0.0; color[1] = 0.0; color[2] = 1.0; break; //G<span></span></pre></td></tr><tr><td scope="row"><pre>        case 8: color[0] = 0.25; color[1] = 0.0; color[2] = 0.75; break; //G#/Ab<span></span></pre></td></tr><tr><td scope="row"><pre>        case 9: color[0] = 0.3; color[1] = 0.0; color[2] = 0.5; break; // A<span></span></pre></td></tr><tr><td scope="row"><pre>        case 10: color[0] = 0.4; color[1] = 0.0; color[2] = 0.75; break; //A#/Bb<span></span></pre></td></tr><tr><td scope="row"><pre>        case 11: color[0] = 0.5; color[1] = 0.0; color[2] = 1.0; break;// B<span></span></pre></td></tr><tr><td scope="row"><pre>        default: color[0] = 0.5; color[1] = 0.5; color[2] = 0.5;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    // Set the alpha value, based on octave<span></span></pre></td></tr><tr><td scope="row"><pre>    alpha = 1.0 - ((float)octave/11.0);<span></span></pre></td></tr><tr><td scope="row"><pre>    color[3] = alpha;<span></span></pre></td></tr><tr><td scope="row"><pre>    // Create a Quartz color object using the previously created color space<span></span></pre></td></tr><tr><td scope="row"><pre>    myColor = CGColorCreate(myColorSpace, color);<span></span></pre></td></tr><tr><td scope="row"><pre>    // Set the color on the output (this also retains the color)<span></span></pre></td></tr><tr><td scope="row"><pre>    self.outputColor = myColor;<span></span></pre></td></tr><tr><td scope="row"><pre>    // Release the color object since it is now stored in the output parameter<span></span></pre></td></tr><tr><td scope="row"><pre>    CGColorRelease(myColor);<span></span></pre></td></tr><tr><td scope="row"><pre>    return YES;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Save and close the <code>MIDI2ColorPlugIn.m</code> file.</p></li><li class="li"><p>Open the <code>Info.plist</code> file and make sure the following key is an entry in the dictionary:</p><div class="codesample"><table><tr><td scope="row"><pre>&lt;key>QCPlugInClasses&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;array><span></span></pre></td></tr><tr><td scope="row"><pre>    &lt;string>MIDI2ColorPlugIn&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;/array><span></span></pre></td></tr></table></div><p>If you want, customize the bundle identifier, then save and close the file.</p></li><li class="li"><p>Under Targets, choose Build &amp; Copy. Then, click Build Build &amp; Copy from the Action pop-up menu.</p><p>When you build using this option, Xcode copies the successfully built plug-in to <code>~/Library/Graphics/Quartz Composer Plug-Ins</code>.</p></li><li class="li"><p>Open the Quartz Composer development environment and search for the MIDI2Color custom patch in the Patch Creator.</p></li><li class="li"><p>Make sure the MIDI2Color patch works by creating a composition that uses it.</p><p>You can use an interpolation patch to provide values that include the 0 to 127 range. It’s best to extend the range to make sure the edge cases are processed correctly. Set the start and end value of the interpolation patch to -20 and 150, respectively. Then set the repeat mode to Mirrored Loop and the duration to 25 or higher. Connect the output port of the interpolation patch to the input port of the MIDI2Color patch. After setting up a Clear patch, drag a Particle System patch to the editor and connect the output of the MIDI2Color patch to the Color port of the Particle System patch. </p><p>Drag an image directly to the editor widow. Then connect the image output port to the Image input port of the Particle System patch. (If you don’t have any images readily available, you might choose one of the images located in <code>~Pictures/iChat Icons/Flowers</code>.) Your test application should look similar to this:</p><div class="item_figure"><img src = "../art/test_flowers.jpg" alt = "graphic" ></div><p>You might want to make a few adjustments to the input parameters of the Particle System patch to get a result that is aesthetically pleasing to you, but you don’t need to. Because the images produced by the Particle System have a lifetime, you’ll be able to more easily see the colors and observe not only how the hues change but how the opacity changes. </p><div class="item_figure"><img src = "../art/flower_compare.jpg" alt = "graphic" ></div></li></ol><a name="//apple_ref/doc/uid/TP40004787-CH4-DontLinkElementID_6" title="Number2Color: Extending MIDI2Color"></a><h2>Number2Color: Extending MIDI2Color</h2><p>The MIDI2Color custom patch has a major shortcoming; it processes input values that are in the range of 0 to 127. Although MIDI electronic instruments use those values to designate pitch and other aspects of music, many of the built-in Quartz Composer MIDI custom patches provide normalized output values (<code>0.0</code> to <code>1.0</code>) instead of raw MIDI values. In addition, the MIDI2Color patch can operate on any numerical values, not just those provided by MIDI, as you saw with the test composition that used the Interpolation patch. Its use does not need to be restricted to MIDI input, so a name change is in order. </p><p>In this section you’ll see how to improve the MIDI2Color patch by writing a similar custom patch that accepts any range of values. You’ll add two  parameters that will be available on the Settings pane of the inspector for the patch so that the user can set the range. You’ll write an execution method that maps any range of values to over ten “octaves” of "pitch” values. You’ll name the patch Number2Color to indicate that the patch can be used for any numeric value.</p><p>Follow these steps to create a Number2Color patch:</p><ol class="ol"><li class="li"><p>Open Xcode and choose File > New Project.</p></li><li class="li"><p>In the New Project window, choose Standard Apple Plug-ins > Quartz Composer Plug-in for Objective C With Internal Settings And User Interface. Then click click Next.</p><p>This template provides the nib file that you’ll modify for the user interface of the Settings pane.</p></li><li class="li"><p>Enter <code>Number2Color</code> in the Project Name text field and click Finish.</p></li><li class="li"><p>Open the <code>Number2ColorPlugin.h</code> file.</p><p>Modify the interface file so that it has two dynamic Objective-C properties and two instance variable properties. The dynamic Objective-C properties—<code>inputValue</code> and <code>outputColor</code>—are the input and output parameters for the input and output ports of the patch. The instance variable properties—<code>minValue</code> and <code>maxValue</code>—are the internal parameters that will be available on the Settings pane in the inspector for the patch. You also need to add a variable to keep track of the color space, just as you did for the MIDI2Color custom patch.</p><div class="codesample"><table><tr><td scope="row"><pre>#import &lt;Quartz/Quartz.h><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@interface Number2ColorPlugIn : QCPlugIn<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>   CGColorSpaceRef myColorSpace;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre>// Declare a property input port of type Number and with the key inputValue<span></span></pre></td></tr><tr><td scope="row"><pre>@property double inputValue;<span></span></pre></td></tr><tr><td scope="row"><pre>// Declare a property input port of type Color and with the key outputColor<span></span></pre></td></tr><tr><td scope="row"><pre>@property CGColorRef outputColor;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Declare internal settings as properties of type double<span></span></pre></td></tr><tr><td scope="row"><pre>@property double minValue;<span></span></pre></td></tr><tr><td scope="row"><pre>@property double maxValue;<span></span></pre></td></tr><tr><td scope="row"><pre>@end<span></span></pre></td></tr></table></div></li><li class="li"><p>Save and close the <code>Number2ColorPlugIn.h</code> file.</p></li><li class="li"><p>Open the <code>Number2ColorPlugin.m</code> file.</p></li><li class="li"><p>Just after the <code>@implementation</code> statement, add the following directives. Quartz Composer will handle their implementation.</p><div class="codesample"><table><tr><td scope="row"><pre>@dynamic inputValue, outputColor;<span></span></pre></td></tr><tr><td scope="row"><pre>@synthesize minValue, maxValue;<span></span></pre></td></tr></table></div></li><li class="li"><p>Add a description for the custom patch by modifying the appropriate  <code>#define</code> statement.</p><div class="codesample"><table><tr><td scope="row"><pre>#define    kQCPlugIn_Name @"Number2Color"<span></span></pre></td></tr><tr><td scope="row"><pre>#define    kQCPlugIn_Description  @"Converts a value to a color with transparency. You can define a range of values to use for the color mapping."<span></span></pre></td></tr></table></div></li><li class="li"><p>Next you’ll write the methods needed to implement the <code>Number2ColorPlugIn</code> subclass. The <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/clm/QCPlugIn/attributes" target="_top">attributes</a></code> method should already look as follows:</p><div class="codesample"><table><tr><td scope="row"><pre>+ (NSDictionary*) attributes<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return [NSDictionary dictionaryWithObjectsAndKeys:<span></span></pre></td></tr><tr><td scope="row"><pre>                kQCPlugIn_Name,QCPlugInAttributeNameKey,<span></span></pre></td></tr><tr><td scope="row"><pre>                kQCPlugIn_Description,QCPlugInAttributeDescriptionKey,<span></span></pre></td></tr><tr><td scope="row"><pre>                nil];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Modify the <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/clm/QCPlugIn/attributesForPropertyPortWithKey:" target="_top">attributesForPropertyPortWithKey:</a></code> so that it returns a dictionary for each input and output parameter. Do not include the <code>maxValue</code> and <code>minValue</code> properties here. These require different setup work because those are patch settings, not input parameters.</p><p>The method should look as follows:</p><div class="codesample"><table><tr><td scope="row"><pre>+ (NSDictionary*) attributesForPropertyPortWithKey:(NSString*)key<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    if([key isEqualToString:@"inputValue"])<span></span></pre></td></tr><tr><td scope="row"><pre>        return [NSDictionary dictionaryWithObjectsAndKeys:<span></span></pre></td></tr><tr><td scope="row"><pre>            @"Value", QCPortAttributeNameKey,<span></span></pre></td></tr><tr><td scope="row"><pre>            [NSNumber numberWithUnsignedInteger:64],  QCPortAttributeDefaultValueKey,<span></span></pre></td></tr><tr><td scope="row"><pre>            nil];<span></span></pre></td></tr><tr><td scope="row"><pre>    if([key isEqualToString:@"outputColor"])<span></span></pre></td></tr><tr><td scope="row"><pre>        return [NSDictionary dictionaryWithObjectsAndKeys:<span></span></pre></td></tr><tr><td scope="row"><pre>            @"Color", QCPortAttributeNameKey,<span></span></pre></td></tr><tr><td scope="row"><pre>            nil];<span></span></pre></td></tr><tr><td scope="row"><pre>    return nil;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Make sure the <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/clm/QCPlugIn/executionMode" target="_top">executionMode</a></code> method returns <code>kQCPlugInExecutionModeProcessor</code>.</p><div class="codesample"><table><tr><td scope="row"><pre>+ (QCPlugInExecutionMode) executionMode<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return kQCPlugInExecutionModeProcessor;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Make sure the <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/clm/QCPlugIn/timeMode" target="_top">timeMode</a></code> method returns <code>kQCPlugInTimeModeNone</code>.</p><p>Similar to MIDI2Color, the Number2Color plug-in executes only when the input value changes; it does not depend on time.</p><div class="codesample"><table><tr><td scope="row"><pre>+ (QCPlugInTimeMode) timeMode<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return kQCPlugInTimeModeNone;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Next you’ll  implement methods that are required when you use internal parameters. First you need to write an <code>init</code> method to set the initial values of the <code>minValue</code> and <code>maxValue</code> parameters to a default value.</p><div class="codesample"><table><tr><td scope="row"><pre> (id) init<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    if(self = [super init]) {<span></span></pre></td></tr><tr><td scope="row"><pre>        self.minValue = 0.0;<span></span></pre></td></tr><tr><td scope="row"><pre>        self.maxValue = 127.0;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return self;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Write a <code>dealloc</code> method. If any of the internal parameters are objects, such as a color, you would release the object in this method (for example <code>self.foo = nil;</code>). But because none of the internal parameters are objects, the <code>dealloc</code> method provided by the template is okay as is.</p><div class="codesample"><table><tr><td scope="row"><pre>- (void) dealloc<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [super dealloc];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Implement the <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/clm/QCPlugIn/plugInKeys" target="_top">plugInKeys</a></code> method so that it returns the keys that represent the internal parameters for the plug-in. This list is used to serialize the settings automatically. It’s also used by the <code><a href="../../../../Cocoa/Reference/QCPlugInViewController_Class/Introduction/Introduction.html#//apple_ref/occ/cl/QCPlugInViewController" target="_top">QCPlugInViewController</a></code> object to allow editing the values for these keys in the user interface. Make sure that you terminate the list with <code>nil</code>.</p><div class="codesample"><table><tr><td scope="row"><pre>+ (NSArray*) plugInKeys<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return [NSArray arrayWithObjects:@"minValue", @"maxValue", nil];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Provide a <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/instm/QCPlugIn/createViewController" target="_top">createViewController</a></code> method so that you can provide support in the user interface for viewing and setting the internal parameters. The <code>viewNibName</code> string must match the name of the nib file.</p><p>This method is is already included as part of the template. It should look like this:</p><div class="codesample"><table><tr><td scope="row"><pre>- (QCPlugInViewController*) createViewController<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return [[QCPlugInViewController alloc]<span></span></pre></td></tr><tr><td scope="row"><pre>            initWithPlugIn:self<span></span></pre></td></tr><tr><td scope="row"><pre>            viewNibName:@"Number2ColorSettings"];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Modify the <code>startExecution:</code> method to create a color space object.</p><p>For this example, you can use the <code>startExecution:</code> method to create and initialize a Quartz color space. The color space should remain the same throughout the life of the custom patch instance. You’ll create the color space when the patch starts to execute, store it in the instance variable you created previously, and then release the color space when the custom patch instance is no longer executing.</p><div class="codesample"><table><tr><td scope="row"><pre>- (BOOL) startExecution:(id&lt;QCPlugInContext>)context<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>   myColorSpace = CGColorSpaceCreateWithName(kCGColorSpaceGenericRGB);<span></span></pre></td></tr><tr><td scope="row"><pre>   return YES;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Modify the <code>stopExecution:</code> method to release the color space object.</p><div class="codesample"><table><tr><td scope="row"><pre>- (void) stopExecution:(id&lt;QCPlugInContext>)context<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>   CGColorSpaceRelease(myColorSpace);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Implement the execution method. Similar to the MIDI2Color plug-in, this is where the processing takes place. You’ll notice that the Number2Color execution method is similar to the MIDI2Color execution method except that Number2Color uses the minimum and maximum values to map the input value to the specified range.</p><div class="codesample"><table><tr><td scope="row"><pre>- (BOOL) execute:(id&lt;QCPlugInContext>)context<span></span></pre></td></tr><tr><td scope="row"><pre>            atTime:(NSTimeInterval)time<span></span></pre></td></tr><tr><td scope="row"><pre>            withArguments:(NSDictionary*)arguments<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    static float color[4];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    CGColorRef myColor;<span></span></pre></td></tr><tr><td scope="row"><pre>    int pitch, octave;<span></span></pre></td></tr><tr><td scope="row"><pre>    double convertedInputValue;<span></span></pre></td></tr><tr><td scope="row"><pre>    float alpha;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Make sure there is a range of values<span></span></pre></td></tr><tr><td scope="row"><pre>    if (self.maxValue == self.minValue)<span></span></pre></td></tr><tr><td scope="row"><pre>        // If not, execution fails.<span></span></pre></td></tr><tr><td scope="row"><pre>        return NO;<span></span></pre></td></tr><tr><td scope="row"><pre>    // Use the internal settings to scale the input value<span></span></pre></td></tr><tr><td scope="row"><pre>    convertedInputValue = (self.inputValue - self.minValue)/(self.maxValue - self.minValue) * 127.0);<span></span></pre></td></tr><tr><td scope="row"><pre>    // The remaining code is the same as that used for MIDI2Color<span></span></pre></td></tr><tr><td scope="row"><pre>    octave = floor(convertedInputValue/12);<span></span></pre></td></tr><tr><td scope="row"><pre>    pitch = (int) (convertedInputValue - (octave * 12));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    switch (pitch) {<span></span></pre></td></tr><tr><td scope="row"><pre>        case 0: color[0] = 1.0; color[1] = 0.0; color[2] = 0.0; break;<span></span></pre></td></tr><tr><td scope="row"><pre>        case 1: color[0] = 1.0; color[1] = 0.5; color[2] = 0.0; break;<span></span></pre></td></tr><tr><td scope="row"><pre>        case 2: color[0] = 1.0; color[1] = 0.75; color[2] = 0.0; break;<span></span></pre></td></tr><tr><td scope="row"><pre>        case 3: color[0] = 1.0; color[1] = 1.0; color[2] = 0.0; break;<span></span></pre></td></tr><tr><td scope="row"><pre>        case 4: color[0] = 0.5; color[1] = 1.0; color[2] = 0.0; break;<span></span></pre></td></tr><tr><td scope="row"><pre>        case 5: color[0] = 0.0; color[1] = 1.0; color[2] = 0.0; break;<span></span></pre></td></tr><tr><td scope="row"><pre>        case 6: color[0] = 0.0; color[1] = 0.5; color[2] = 0.5; break;<span></span></pre></td></tr><tr><td scope="row"><pre>        case 7: color[0] = 0.0; color[1] = 0.0; color[2] = 1.0; break;<span></span></pre></td></tr><tr><td scope="row"><pre>        case 8: color[0] = 0.25; color[1] = 0.0; color[2] = 0.75; break;<span></span></pre></td></tr><tr><td scope="row"><pre>        case 9: color[0] = 0.3; color[1] = 0.0; color[2] = 0.5; break;<span></span></pre></td></tr><tr><td scope="row"><pre>        case 10: color[0] = 0.4; color[1] = 0.0; color[2] = 0.75; break;<span></span></pre></td></tr><tr><td scope="row"><pre>        case 11: color[0] = 0.5; color[1] = 0.0; color[2] = 1.0; break;<span></span></pre></td></tr><tr><td scope="row"><pre>        default: color[0] = 0.5; color[1] = 0.5; color[2] = 0.5;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    alpha = 1.0 - ((float)octave/11.0);<span></span></pre></td></tr><tr><td scope="row"><pre>    color[3] = alpha;<span></span></pre></td></tr><tr><td scope="row"><pre>    myColor = CGColorCreate(myColorSpace, color);<span></span></pre></td></tr><tr><td scope="row"><pre>    self.outputColor = myColor;<span></span></pre></td></tr><tr><td scope="row"><pre>    CGColorRelease(myColor);<span></span></pre></td></tr><tr><td scope="row"><pre>    return YES;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Open the <code>Info.plist</code> file and make sure the following key is an entry in the dictionary:</p><div class="codesample"><table><tr><td scope="row"><pre>&lt;key>QCPlugInClasses&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;array><span></span></pre></td></tr><tr><td scope="row"><pre>    &lt;string>Number2ColorPlugIn&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;/array><span></span></pre></td></tr></table></div><p>If you want, customize the bundle identifier, then save and close the file.</p></li><li class="li"><p>Next you’ll use Interface Builder to create the user interface for the Settings pane.</p></li><li class="li"><p>Double click  <code>Number2ColorSettings.nib</code>. </p><p>Interface Builder launches with a View window.</p></li><li class="li"><p>Drag a Text Field (<code>NSTextField</code>) from the Library to the View window.</p></li><li class="li"><p>Drag a Label from the Library, place it next to the text field, and label it <code>Minimum value:</code>.</p></li><li class="li"><p>With the text field selected, open the Bindings inspector.</p></li><li class="li"><p>Click the disclosure triangle next to Value, click “Bind to”, and choose File’s Owner.</p></li><li class="li"><p>Enter <code>plugIn.minValue</code>  in the Model Key Path text field.</p><p>Recall that the model key path is <code>plugIn.XXX</code>,  where <code>XXX</code> is the corresponding key for the internal setting.</p></li><li class="li"><p>Drag a text field  to the view.</p></li><li class="li"><p>Drag a label next to the text field and label it <code>Maximum value:</code>.</p><p>The user interface should now look like this:</p><div class="item_figure"><img src = "../art/settings_view.jpg" alt = "The settings view user interface in Interface Builder." ></div></li><li class="li"><p>With the text field selection, open the Bindings inspector.</p></li><li class="li"><p>Bind the text field to the File’s owner and enter <code>plugIn.maxValue</code> as the Model Key Path. </p></li><li class="li"><p>Control-drag from File’s Owner icon in the Nib document window to the view. Then click <code>view</code> in the heads-up display that appears.</p></li><li class="li"><p>Save the file and quit Interface Builder.</p></li><li class="li"><p>Under Targets, choose Build &amp; Copy. Then, click Build “Build &amp; Copy” from the Action pop-up menu.</p><p>When you build using this option, Xcode copies the successfully built plug-in to <code>~/Library/Graphics/Quartz Composer Plug-Ins</code>.</p></li><li class="li"><p>Open the Quartz Composer development and search for the Number2Color custom patch in the Patch Creator.</p></li><li class="li"><p>Drag the patch to the editor. Then open the inspector to the Settings pane. The pane should look similar to the following.</p><div class="item_figure"><img src = "../art/number_settings.jpg" alt = "graphic" ></div></li><li class="li"><p>Test the composition with a variety of ranges of input values.</p></li></ol><div class="notebox"><a name="//apple_ref/doc/uid/TP40004787-CH4-DontLinkElementID_19" title="Note"></a><p><strong>Note:</strong>&nbsp;If you create a plug-in that uses variables in the Settings pane whose values do not conform to the <code><a href="../../../../Cocoa/Reference/Foundation/Protocols/NSCoding_Protocol/Reference/Reference.html#//apple_ref/occ/intf/NSCoding" target="_top">NSCoding</a></code> protocol, then you must implement <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/instm/QCPlugIn/serializedValueForKey:" target="_top">serializedValueForKey:</a></code> and <code><a href="../../../../Cocoa/Reference/QCPlugIn_Class/Introduction/Introduction.html#//apple_ref/occ/instm/QCPlugIn/setSerializedValue:forKey:" target="_top">setSerializedValue:forKey:</a></code>.  </p></div><a name="//apple_ref/doc/uid/TP40004787-CH4-DontLinkElementID_7" title="Packaging Two Custom Patches in a Plug-in"></a><h2>Packaging Two Custom Patches in a Plug-in</h2><p>Although, for testing purposes, you might want to develop each custom patch separately, you can combine several patches into one plug-in when you are ready to distribute the patches. This section shows you how to package the MIDI2Color and Number2Color custom patches together. First you’ll add the files for the MIDI2Color custom patch to the Number2Color project. Then you’ll modify the property list file to include the <code>MIDI2ColorPlugIn</code> class.</p><ol class="ol"><li class="li"><p>Open the Number2Color Xcode project.</p></li><li class="li"><p>Choose Project > Add to Project.</p></li><li class="li"><p>Navigate to the MIDI2ColorPlugin.h and MIDI2ColorPlugin.m files, select them, and click Add. </p></li><li class="li"><p>In the sheet that appears, click Add.</p><p>Make sure that the Number2Color target is selected.</p></li><li class="li"><p>Open the <code>Info.plist</code> file.</p></li><li class="li"><p>Enter the <code>MIDI2ColorPlugIn</code> class so that the <code>QCPlugInClasses</code> entry looks like this:</p><div class="codesample"><table><tr><td scope="row"><pre>&lt;key>QCPlugInClasses&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;array><span></span></pre></td></tr><tr><td scope="row"><pre>  &lt;string>Number2ColorPlugIn&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>  &lt;string>MIDI2ColorPlugIn&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;/array><span></span></pre></td></tr></table></div></li><li class="li"><p>Save the project.</p></li><li class="li"><p>Under Targets, choose Build &amp; Copy. Then, click Build Build &amp; Copy from the Action pop-up menu.</p></li></ol><p>After following these instructions, the name of the plug-in remains Number2Color. You might want to rename it to MyColorGenerators or some other name that indicates the plug-in contains more than one custom patch. If you want, you can add additional custom patches to the plug-in.</p>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../plugin_1/plugin_1.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../qc_image_proc/qc_image_proc.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2007 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2007-12-11<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/GraphicsImaging/Conceptual/QuartzComposer_Patch_PlugIn_ProgGuide/WritingProcessorPatches/WritingProcessorPatches.html%3Fid%3DTP40004787-1.1&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/GraphicsImaging/Conceptual/QuartzComposer_Patch_PlugIn_ProgGuide/WritingProcessorPatches/WritingProcessorPatches.html%3Fid%3DTP40004787-1.1&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/GraphicsImaging/Conceptual/QuartzComposer_Patch_PlugIn_ProgGuide/WritingProcessorPatches/WritingProcessorPatches.html%3Fid%3DTP40004787-1.1&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>