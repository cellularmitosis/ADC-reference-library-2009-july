<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!--Template 06-20-02--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Q&amp;A HW08: Implementing read-modify-write on PCI</title><meta name="keywords" content="Mac OS 8 PCI bus read-modify-write implement atomic operations"><meta name="Description" content="Technical Q&amp;A HW08: Q&amp;A presents the Driver Services Library's32, 16, 8 bit atomic memory operations for use by devicedrivers as a means for implementing read-modify-write ona PCI card to lock the PCI target device."><meta name="categories" content="Hardware"><meta name="week-posted" content="Jul 10, 1995 - Jul 21, 1995"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10001278" title="Implementing read-modify-write on PCI"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalqas/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/idxPCIandPCCard-date.html" target="_blank">Hardware & Drivers > PCI and PC Card</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A HW08</div>
<div id="pageheadsub">Implementing read-modify-write on PCI</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment -->						<!-- begin_content --><CENTER><TABLE BORDER=0 CELLPADDING=0 WIDTH=600><TR> <td align="left"><hr width=500 align=center><p id = p2>Q:  We are converting our Nubus card to a PCI card, and we need to know how toimplement read-modify-write to lock the PCI target device.</p><p id=p4>A:  <i>Designing PCI Cards and Drivers</i>, which is on the PCI Driver DevelopmentKit (DDK), explains this as follows:</p><p id=p4><u>Atomic Memory Operations</u></p><p id=p4>The Driver Services Library provides the following 32-, 16-, and 8-bit atomicmemory operations for use by device drivers. </p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>Boolean CompareAndSwap(long oldValue, long newValue, long *Value);SInt32            IncrementAtomic( SInt32 *value );SInt32            DecrementAtomic( SInt32 *value );SInt32            AddAtomic( SInt32 amount, SInt32 *value );UInt32        BitAndAtomic( UInt32 mask, UInt32 *value );UInt32        BitOrAtomic( UInt32 mask, UInt32 *value );UInt32        BitXorAtomic( UInt32 mask, UInt32 *value );SInt8             IncrementAtomic8( SInt8 *value );SInt8             DecrementAtomic8( SInt8 *value );SInt8             AddAtomic8( SInt32 amount, SInt8 *value );UInt8             BitAndAtomic8( UInt32 mask, UInt8 *value );UInt8             BitOrAtomic8( UInt32 mask, UInt8 *value );UInt8             BitXorAtomic8( UInt32 mask, UInt8 *value );SInt16            IncrementAtomic16( SInt16 *value );SInt16            DecrementAtomic16( SInt16 *value );SInt16            AddAtomic16( SInt32 amount, SInt16 *value );UInt16        BitAndAtomic16( UInt32 mask, UInt16 *value );UInt16        BitOrAtomic16( UInt32 mask, UInt16 *value );UInt16        BitXorAtomic16( UInt32 mask, UInt16 *value );</pre>	</TD></TR></TABLE></CENTER><p id=p4>Theatomic routines perform various operations on the memory address specified byvalue: </p><ul type="circle"><li><code>IncrementAtomic</code> increments the value by one and <code>DecrementAtomic</code> decrements itby one. These functions return the value as it was before the change.</li>	<li><code>AddAtomic</code> adds the specified amount to the value at the specified address and returns the result.</li>	<li><code>BitAndAtomic</code> performs a logical and operation between the bits of the specified mask and the value at the specified address, returning the result. Similarly, <code>BitOrAtomic</code> performs a logical or operation and <code>BitXorAtomic</code> performs a logical <code>XOR</code> operation.</li>	<li>The <code>CompareAndSwap</code> routine compares the value at the specified address with <code>oldValue</code>. The value of <code>newValue</code> is written to the specified address only if <code>oldValue</code> and the value at the specified address are equal. <code>CompareAndSwap</code> returns true if <code>newValue</code> is written to the specified address; otherwise it returns false. A false return value does not imply that <code>oldValue</code> and the value at the specified address are not equal; it only implies that <code>CompareAndSwap</code> did not write newValue to the specified address.</li></ul><p id=p4>These routines take logical address pointers and ensure that the operations areatomic with respect to all devices (for example, other processors, DMA engines)that participate in the coherency architecture of the Macintosh system.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>TestAndSet        (UInt32            theBit                  UInt8            *theAddress);TestAndClear    (UInt32            theBit                  UInt8               *theAddress);theBit            The bit number in the range 0 through 7.theAddress        The address of the byte in which the bit is located.</pre>	</TD></TR></TABLE></CENTER><p id=p4><code>TestAndSet</code> and <code>TestAndClear</code> set and clear a single bit in a byte at a specifiedaddress.</p></td></tr></table></center><!-- end_content --><!-- begin_date --><H4 ALIGN=center>[Jul 15 1995]</H4><!-- end_date --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/hw/hw08.html%3Fid%3DDTS10001278-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/hw/hw08.html%3Fid%3DDTS10001278-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/hw/hw08.html%3Fid%3DDTS10001278-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --> <hr width=500 align=center> </BODY> </HTML>