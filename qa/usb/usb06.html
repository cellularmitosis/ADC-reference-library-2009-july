<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Q&amp;A USB06: Implementing MacsBug-Compatible USB Keyboard and Mouse Drivers</title>	<meta name="keywords" content="USB keyboard">	<meta name="Description" content="Technical Q&amp;A USB06: Implementing MacsBug-Compatible USBKeyboard          and Mouse Drivers."><meta name="categories" content="USB"><meta name="week-posted" content="May 29, 2000 - Jun 2, 2000"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"><a name="//apple_ref/doc/uid/DTS10002272" title="Implementing MacsBug-Compatible USB Keyboard and Mouse Drivers"></a> <!-- white background --><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalqas/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/idxUSB-date.html" target="_blank">Hardware & Drivers > USB</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A USB06</div>
<div id="pageheadsub">Implementing MacsBug-Compatible USB Keyboard and Mouse Drivers</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER>			<!-- -->						<!-- Document Body --><table cellspacing="0" cellpadding="0" border="0" WIDTH="600"><tr><td align="left">         <hr width=500 align=center>                  <P id=p2>Q: Under MacOS USB 1.4.x, the Apple USB Mouse and         Keyboard drivers work better with MacsBug. How can I         implement similar functionality in my vendor-specific Mouse         and Keyboard driver?</P>                  <P id=p4>A: MacOS USB 1.4.x implements modifications within         the USB Services Library so that when MacsBug is active, the         USB Interrupt Service Routine (ISR) limits the processing of         data to those devices whose drivers support MacsBug. In         prior versions of MacOS USB, the USB ISR continued to         process incoming data requests, such that all USB devices         would still function within the MacsBug context. To support         MacsBug, the following conditions must be true:</P>                  <UL id=p4>            <LI>The USB parameter block request must have the            <code>kUSBDebugAwareFlag</code> bit set in            the <code>usbFlags</code> field.</LI>                        <LI>The <CODE>ADBShim</CODE> implemented in MacOS 9.0.4 or greater            must be present.</LI>                        <LI>The <CODE>ADBShim</CODE> must be actively supporting a keyboard            attached to the system.</LI>         </UL>                  <P id=p4>The <CODE>ADBShim</CODE> that ships as part of the MacOS ROM         file for MacOS 9.0.4 was modified to provide MacsBug         support for USB keyboards and mice. The MacOS ROM file is         only present on Power Macintosh systems with USB built-in.         As of the writing of this Q&amp;A, there is no support for         MacsBug for USB keyboards and mice on older Power Macintosh         G3 systems.</P>                  <P id=p4>To support MacsBug, the USB ISR must be aware that         MacsBug has been entered. This is handled by the <CODE>ADBShim</CODE>,         when it loads to support a dependent USB Keyboard. The         <CODE>ADBShim</CODE> is also activated for a Blue&amp;White G3 with an         ADB keyboard and for keyboards on PowerBook G3 systems with         USB built-in. If the <CODE>ADBShim</CODE> is active only to support a USB         mouse, the mouse will not work within MacsBug.</P>                  <H3 id=p4>Setting the <CODE>kUSBDebugAwareFlag</CODE> Bit</H3>                  <P id=p4>In the <a href="http://developer.apple.com/hardware/usb/download.htm">MacOS         USB DDK 1.4.1</A> and greater, both the Keyboard and Mouse         examples demonstrate the use of the <CODE>kUSBDebugAwareFlag</CODE>.         The flag bit is set in the <CODE>USBIntRead</CODE>         parameter block call. When MacsBug is entered, the USB scans         each incoming request to check if the <code>kUSBDebugAwareFlag</code>         bit is set in the usbFlags field. If so, then the         <code>usbCompletion</code> routine is         executed, which normally chains to another <code>USBIntRead</code>         call. If the bit is not set, the USB ISR queues the request         for later processing, after the user leaves MacsBug. The         following is an example of setting the <code>kUSBDebugAwareFlag</code>         bit from code modified from the keyboard sample.</P>                  <TABLE BORDER=0>            <TR>               <td bgcolor="#EEEEE0" align=left>                  <pre>    // initialize the parameter block    InitParamBlock(pKeyboardPB-&gt;pipeRef, &amp;pKeyboardPB-&gt;pb);    // specify where the response buffer    pKeyboardPB-&gt;pb.usbBuffer = (Ptr)response;    // 8 bytes of data requested for a keyboard read    pKeyboardPB-&gt;pb.usbReqCount = 0x08;    // set the interfaceNumber of the keyboard    pKeyboardPB-&gt;pb.usb.cntl.WIndex = interfaceNumber;    // set the completion proc    pKeyboardPB-&gt;pb.usbCompletion = (USBCompletion)KeyboardCompletionProc;    // user sets the usbRefcon field which remains unchanged    // across the call    pKeyboardPB-&gt;pb.usbRefcon |= kCompletionPending;    // Get USB Version to see if we support the    // debug aware flag ( version &gt; 1.4 )    if ( pKeyboardPB-&gt;usbVersion &gt;=  kUSBVersion14 )    {        pKeyboardPB-&gt;pb.usbFlags |= kUSBDebugAwareFlag;    }    // post the USBIntRead call    myErr = USBIntRead(&amp;pKeyboardPB-&gt;pb);</pre>               </TD>            </TR>         </TABLE>                           <H3>Supporting the ADBShim</H3>                  <P id=p4>When the mouse or keyboard device is attached, the         <CODE>ADBShim</CODE> is notified and it searches for an exported         <code>TheHIDModuleDispatchTable</code> symbol         associated with the device driver. If the symbol is found,         then the <code>USBHIDInstallInterruptProcPtr</code>         field is checked to make sure that it is not nil. The         <CODE>ADBShim</CODE> passes the driver its ISR to be used to process all         incoming data. If there is no <code>TheHIDModuleDispatchTable</code>         or if the <code>USBHIDInstallInterruptProcPtr</code>         is nil, the <CODE>ADBShim</CODE> does not support the device. An example         of implementing the <code>TheHIDModuleDispatchTable</code>,         is demonstrated in the Keyboard and Mouse module driver         samples which are part of the <a href="http://developer.apple.com/hardware/usb/download.htm">MacOS         USB DDK 1.4.1.</A></P>                  <P id=p4>A vendor specific keyboard or mouse driver may implement         support for the <code>kUSBDebugAwareFlag</code>         bit, but not export the <code>TheHIDModuleDispatchTable</code>,         and still work with MacsBug. For this to happen, a keyboard         that is supported by the <CODE>ADBShim</CODE> must be attached. For this         reason, developers find that their keyboards and mice that         are supported by vendor-specific drivers work within         MacsBug with an Apple USB keyboard attached, but not without         it.</P>                  <P id=p4>A vendor-specific keyboard or mouse driver can implement         support for the <code>TheHIDModuleDispatchTable</code>         as well as the <code>USBHIDInstallInterruptProcPtr</code>         and still selectively support additional functionality which         their product provides. When processing each event,         determine which events should be passed to the <CODE>ADBShim</CODE>. If         the event is to be handled by your own code, be aware that         the driver may be operating within the MacsBug context.         Consider using a <a href="../../documentation/mac/Processes/Processes-120.html#HEADING120-0">Deferred         Task</A> to execute your code, in this case.</P>                             <!-- begin_date --><H4 ALIGN=center>[May 31 2000]</H4><!-- end_date -->          </TD>   </TR></TABLE> <!--------------------------- Navigation Area ----------------------------------><!-- Navigation Area --> </CENTER><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/usb/usb06.html%3Fid%3DDTS10002272-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/usb/usb06.html%3Fid%3DDTS10002272-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/usb/usb06.html%3Fid%3DDTS10002272-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>