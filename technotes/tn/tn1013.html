<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><!--Includes revisions to code listings--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TN1013: Printer Direct Mode APIs for Macintosh Printer Drivers</title>    <meta name="keywords" content="Mac OS 8 Printer Direct Mode APIs Drivers Despool pass-thru">    <meta name="Description" content="Technical Note TN1013: This Technical Note describes theAPIs for implementing a printer-direct (or pass-thru) modefor Macintosh printer drivers. Implementing this featurewill allow applications to identify and send printer datathat is unique to the printer connected to the Macintoshwithout having to generate QuickDraw codes, understand howto connect to and maintain a connection with a particularprinter, or handle communications errors with the printer.">                                       <meta name="categories" content="Printing"><meta name="week-posted" content="Jan 29, 1996 - Feb 2, 1996"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002855" title="Printer Direct Mode APIs for Macintosh Printer Drivers"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxPrinting-date.html">Printing</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Printing/index.html" target="_blank">Reference Library > Printing</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1013</div>
<div id="pageheadsub">Printer Direct Mode APIs for Macintosh Printer Drivers</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left">         <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                        <span id="menutitle">                            CONTENTS                             <BR>                            <BR>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc --><p id="menutext"><A HREF = "#RTFToC1">About the Printer Direct Mode</a><br><br><A HREF = "#RTFToC2">Using the Printer Direct APIs</a><br><br><A HREF = "#RTFToC3">Summary of the Printer Direct APIs</a><br><br><A HREF = "#Summary">Summary</a><br><br><A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                 <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">This Technote describes the APIs for implementing a printer-direct (or pass-thru) mode for Macintosh printer drivers. Implementing this feature will allow applications to identify and send printer data that is unique to the printer connected to the Macintosh without having to generate QuickDraw codes, understand how to connect to and maintain a connection with a particular printer, or handle communications errors with the printer.</p><P id = "introtext">Apple's PC Compatibility systems present an interesting dilemma when trying to print from the DOS/Windows side of the CPU because all of the I/O of this system must occur through the Macintosh. DOS applications and Windows printer drivers generate native printer codes for specific printers, but do not generate the QuickDraw commands that Macintosh printer drivers depend on in order to image data to a specific printer. This printer direct mode will allow a "back-door" for these native printer commands to get directly to the printer through the Macintosh printer driver.</p><P id = "introtext">This Technote is directed towards printer driver developers who write drivers for non-PostScript printers. Implementing this feature will allow faster and better quality printing with Apple's PC Compatibility products, where printing must always occur on the Macintosh, even though the printer driver generating the printer commands may be on a DOS/Windows system.</p><P id = "introtext">This document assumes you are familiar with the Macintosh Printing Manager and Apple's PC Compatibility products. See <CITE>Inside Macintosh:Imaging with QuickDraw</CITE> for further details on the Printing Manager.</p> <!-- end_intro_text --><!-- begin_date --><h3 align=center>&nbsp;[Feb 1 1996]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>                   <!-- begin_content --><a name="RTFToC1"></a><h2>About the Printer Direct Mode</h2><P>The printer direct (or pass-thru) mode is specifically intended to allow printer manufacturers and printer driver developers to make products that will easily integrate into the PC Compatibility CPU marketplace. Since most new printers are not being developed for a single CPU platform, the printer direct mode will give end-users the best printing results possible.</p><a name="RTFToC2"></a><h2>Using the Printer Direct APIs</h2><P>The printer direct printer driver functions are implemented via a set of PrGeneral routines and a reserved opCode for those routines. There is a set of six functions (for which there are selectors) that the Macintosh printer driver must support:Open, Close, SendData, SendFile, Despool, and Verify. The PrGeneral opCode reserved by Apple for this operation is 20 decimal ($14 hex). Each of the five functions take a selector code as defined by these constants:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>#define kPrinterDirectOpCode        20#define kPDOpenSelect            1#define kPDSendDataSelect        2#define kPDSendFileSelect        3#define kPDCloseSelect            4#define kPDDespoolSelect        5#define kPDVerifySelect            6</pre>	</TD></TR></TABLE></CENTER><P>If the driver does not support the printer direct opCode, the PrGeneral function should return a opNotImpl error. This is the one case where an error code will only be returned in the printer error (PrError). For all the rest of the functions, error codes need to be returned in the error field of the parameter block as well as the printing error variable (PrSetError).</p><h3>Open Printer Direct</h3><P>The Open command alerts the printer driver that data is about to be sent and it should allocate whatever memory structures are needed to begin receiving the printer data. This printer data can be passed to the driver in one of two ways: 1) As a pointer to data blocks of a specific size, or 2) an FSSpec record which points to a spool file where the data is located. The appropriate selector code for Open command and an appropriate selector for the type of data to be sent to the driver must entered into the selector and spoolType fields of the OpenPDBlk. The spoolType valid values are:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>#define kPDData                1#define kPDFileSpec            2</pre>	</TD></TR></TABLE></CENTER><P>If any other value is set in the spoolType field, the function should return the pdBadSpoolTypeErr. The format of the parameter block is:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>struct OpenPDBlk {    SInt16 opCode;        // Printer Direct opCode = 20    OSErr error;        // Result code    UInt32 reserved;    // reserved    UInt32 selector;    // Function selector code    UInt32 jobID;        // ID referencing this job    UInt32 spoolType;    // Ptr to data or FSSpec.};typedef struct OpenPDBlk OpenPDBlk, *OpenPDBlkPtr;</pre>	</TD></TR></TABLE></CENTER><h5>ERRORS</h5><ul>	<li>opNotImpl, </li>	<li>pdBadSelectorErr, </li>	<li>pdBadJobIDErr, </li>	<li>pdBadSpoolTypeErr</li></ul><P>The opCode is always 20 (kPrinterDirectOpCode). The error and reserved fields should be initialized to zero. The jobID is returned from the Open function and it is the calling function's unique identifier to the print job being opened.</p><h3>Send Data</h3><P>There are two Send commands for sending the print job to the printer:SendPDData and SendFileSpec. For sending data, the driver must minimally be able to handle 4K data blocks which are repeatedly sent to the printer until all the data has been sent. However, more data can be sent if the driver can handle additional memory requirements. If the driver is not able to handle any data block larger than 4K, an error must be appropriately returned by the printer driver.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>struct SendPDDataBlk {    SInt16 opCode;        // Printer Direct opCode = 20    OSErr error;        // Result code    UInt32 reserved;    // reserved    UInt32 selector;    // Function selector code    UInt32 jobID;        // ID referencing this job    Ptr Data;        // Pointer to the data.    UInt32 count;        // Number of bytes Data points to.};typedef struct SendPDDataBlk SendPDDataBlk, *SendPDDataBlkPtr;</pre>	</TD></TR></TABLE></CENTER><h5>ERRORS</h5><ul>	<li>opNotImpl, </li>	<li>pdBadSelectorErr, </li>	<li>pdBadJobIDErr, </li>	<li>Memory Manager Errors</li></ul><h3>Send File</h3><P>The Send File command is issued once and specifies a fileSpec for the location of the spooler file containing all of the print job data. This file must be in a closed state when it is passed to the driver. The printer driver is responsible for deleting the spool file when it is finished spooling the file to the printer.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>struct SendPDFileSpecBlk {    SInt16 opCode;            // Printer Direct opCode = 20    OSErr error;            // Result code    UInt32 reserved;        // reserved    UInt32 selector;        // Function selector code    UInt32 jobID;            // ID referencing this job    FSSpec fileSpec;        // Points to file where data is};typedef struct SendPDFileSpecBlk SendPDFileSpecBlk,        *SendPDFileSpecBlkPtr;</pre>	</TD></TR></TABLE></CENTER><h5>ERRORS </H5><ul>	<li>opNotImpl, </li>	<li>pdBadSelectorErr, </li>	<li>pdBadJobIDErr, </li>	<li>File System Errors</li></ul><h3>Close Printer Direct</h3><P>The Close commands tells the printer driver to stop receiving printer data and prepare the data to be spooled to the printer.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>struct ClosePDBlk {    SInt16 opCode;        // Printer Direct opCode = 20    OSErr error;        // Result code    UInt32 reserved;    // reserved    UInt32 selector;    // Function selector code    UInt32 jobID;        // ID referencing this job};typedef struct ClosePDBlk ClosePDBlk, *ClosePDBlkPtr;</pre>	</TD></TR></TABLE></CENTER><h5>ERRORS</H5><ul>	<li>opNotImpl, </li>	<li>pdBadSelectorErr, </li>	<li>pdBadJobIDErr</li></ul><h3>Despool Print Job</h3><P>Once the Close command is completed, the printer driver will only dispatch the printer data once it has received the Despool command. Despooling can take place either in the foreground or the background, depending on the user's selection in the Chooser.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>struct DespoolPDBlk {    SInt16 opCode;            // Printer Direct opCode = 20    OSErr error;            // Result code    UInt32 reserved;        // reserved    UInt32 selector;        // Function selector code    UInt32 jobID;            // ID referencing this job    UniversalProcPtr idleProcPtr;    // idleProc};typedef struct DespoolPDBlk DespoolPDBlk, *DespoolPDBlkPtr;</pre>	</TD></TR></TABLE></CENTER><h5>ERRORS </H5><ul>	<li>opNotImpl, </li>	<li>iPrAbort, </li>	<li>pdBadSelectorErr, </li>	<li>pdBadJobIDErr, </li>	<li>pdDespoolFailedErr</li></ul><P>An idleProcPtr can be supplied for Despool function which the driver should execute periodically. The idleProc should be a function which takes no arguments and returns no values and should be of the form:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>pascal void MyIdleProc(void);</pre>	</TD></TR></TABLE></CENTER><P>The primary purpose of the idleProc is to sense events when a user is attempting to abort the print job. Should the idleProc sense this, it must set the printing error (via the PrSetError function) with the iPrAbort error. Otherwise, the idleProc should return a noErr. The driver should check the error returned and abort the print job upon receiving the abort error.</p><P>Should the despool procedure be aborted, it should return the iPrAbort error. If the despool function should fail for any other reason, it should return the pdDespoolFailedErr so the calling application can prompt the user.</p><P>If the idleProc is nil, it is the printer driver's option to supply a default idleProc routine.</p><h3>Verify Printer Direct Mode</h3><P>The Verify function allows an application to verify that the driver supports printer direct mode. If the driver does not support the printer direct opCode, the PrGeneral function should return an opNotImpl error.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>struct VerifyPDBlk {    SInt16 opCode;            // Printer Direct opCode = 20    OSErr error;            // Result code    UInt32 reserved;        // reserved    UInt32 selector;        // Function selector code    OSType drvrCreator;        // Printer driver's creator type    NumVersion drvrVersion;        // Printer driver's version number};typedef struct VerifyPDBlk VerifyPDBlk, *VerifyPDBlkPtr;</pre>	</TD></TR></TABLE></CENTER><P>The drvrCreator and drvrVersion fields are returned by the printer driver. The drvrCreator is a 4 character OSType that is part of the driver's file info. The drvrVersion field is of type NumVersion which is defined in the Types.h file of the Macintosh headers. It is defined there as follows:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>struct NumVersion {    UInt8 majorRev;        /*1st part of version number in BCD*/    UInt8 minorAndBugRev;    /*2nd &amp; 3rd part of version number                    share a byte*/    UInt8 stage;        /*stage code:dev, alpha, beta, final*/    UInt8 nonRelRev;     /*revision level of non-released version*/};typedef struct NumVersion NumVersion;</pre>	</TD></TR></TABLE></CENTER><P>Based on the creator and version information, and any pertinent information in the printer record, it is up to the calling application to determine whether the printer data being sent to this driver would be handled properly by this printer.</p><a name="RTFToC3"></a><h2>Summary of the Printer Direct APIs</h2><h3>Constants</h3><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>#define kPrinterDirectOpCode    20#define kPDOpenSelect        1#define kPDSendDataSelect    2#define kPDSendFileSelect    3#define kPDCloseSelect        4#define kPDDespoolSelect    5#define kPDVerifySelect        6#define kPDNoData        0#define kPDData            1#define kPDFileSpec        2enum {    pdBadSelectorErr    = -10001,    pdBadSendModeErr    = -10002,    pdBadJobIDErr        = -10003,    pdDespoolFailed        = -10004};</pre>	</TD></TR></TABLE></CENTER><h3>Data Types</h3><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>struct OpenPDBlk {    SInt16 opCode;        // Printer Direct opCode = 20    OSErr error;        // Result code    UInt32 reserved;    // reserved    UInt32 selector;    // Function selector code    UInt32 jobID;        // ID referencing this job    UInt32 spoolType;    // Ptr to data or FSSpec.};typedef struct OpenPDBlk OpenPDBlk, *OpenPDBlkPtr;struct SendPDDataBlk {    SInt16 opCode;        // Printer Direct opCode = 20    OSErr error;        // Result code    UInt32 reserved;    // reserved    UInt32 selector;    // Function selector code    UInt32 jobID;        // ID referencing this job    Ptr Data;        // Pointer to the data.    UInt32 count;        // Number of bytes Data points to.};typedef struct SendPDDataBlk SendPDDataBlk, *SendPDDataBlkPtr;struct SendPDFileSpecBlk {    SInt16 opCode;        // Printer Direct opCode = 20    OSErr error;        // Result code    UInt32 reserved;    // reserved    UInt32 selector;    // Function selector code    UInt32 jobID;        // ID referencing this job    FSSpec fileSpec;    // Points to file where data is};typedef struct SendPDFileSpecBlk SendPDFileSpecBlk, *SendPDFileSpecBlkPtr;struct ClosePDBlk {    SInt16 opCode;        // Printer Direct opCode = 20    OSErr error;        // Result code    UInt32 reserved;    // reserved    UInt32 selector;    // Function selector code    UInt32 jobID;        // ID referencing this job};typedef struct ClosePDBlk ClosePDBlk, *ClosePDBlkPtr;struct DespoolPDBlk {    SInt16 opCode;            // Printer Direct opCode = 20    OSErr error;            // Result code    UInt32 reserved;        // reserved    UInt32 selector;        // Function selector code    UInt32 jobID;            // ID referencing this job    UniversalProcPtr idleProcPtr;    // idleProc};typedef struct DespoolPDBlk DespoolPDBlk, *DespoolPDBlkPtr;struct VerifyPDBlk {    SInt16 opCode;            // Printer Direct opCode = 20    OSErr error;            // Result code    UInt32 reserved;        // reserved    UInt32 selector;        // Function selector code    OSType drvrCreator;        // Printer driver's creator type    NumVersion drvrVersion;        // Printer driver's version number};typedef struct VerifyPDBlk VerifyPDBlk, *VerifyPDBlkPtr;</pre>	</TD></TR></TABLE></CENTER><a name="Summary"></a><h2>Summary</h2><P>The printer-direct mode for Macintosh printer drivers described in this Technote will be used by the PC Print Spooler application, which is part of Apple's new PC Compatibility System and should be relased in the first part of 1996. The PC Print Spooler application spools print jobs from the PC side of the CPU to the printer connected to the Macintosh and selected in the Chooser.</p><P>The printer-direct mode will be implemented in PowerPrint 3.0.1 Classic and LT driver packages from GDT Softworks in February, 1996. This feature is also being considered in a future release of Apple's LaserWriter 8 driver. In addition, other third-party providers have shown interest in implementing this feature in their printer drivers in the future.</p><P>A caveat: Application developers should realize that this feature is currently not supported by Apple's drivers.</p><P><A HREF="#top">Back to top</A></P>                           <A NAME=Downloads></A>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (56K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tn1013.pdf">Download</A></P>               </TD>            </TR>         </TABLE>         <BR><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER>		<!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1013.html%3Fid%3DDTS10002855-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1013.html%3Fid%3DDTS10002855-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1013.html%3Fid%3DDTS10002855-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>