<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>DropPrint USB - /DSUtils.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; <A HREF="javascript:location.replace('index.html');">DropPrint USB</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/idxUSB-date.html" target="_blank">Hardware & Drivers > USB</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">DropPrint USB</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/DSUtils.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/DropShell.c</option>
<option value="listing2.html">/DropShell.h</option>
<option value="listing3.html">/dropshell.r</option>
<option value="listing4.html">/DSAppleEvents.c</option>
<option value="listing5.html">/DSAppleEvents.h</option>
<option value="listing6.html">/DSGlobals.h</option>
<option value="listing7.html">/DSUserProcs.c</option>
<option value="listing8.html">/DSUserProcs.h</option>
<option value="listing9.html">/DSUtils.c</option>
<option value="listing10.html">/DSUtils.h</option>
<option value="listing11.html">/ListInDialog.c</option>
<option value="listing12.html">/ListInDialog.h</option>
<option value="listing13.html">/ListInDialog.r</option>
<option value="listing14.html">/Prefix.h</option>
<option value="listing15.html">/SafeNameRegistry.c</option>
<option value="listing16.html">/SafeNameRegistry.h</option>
<option value="listing17.html">/TestPrinterClass.c</option>
<option value="listing18.html">/TestPrinterClass.h</option></select>
				</p>
				</form>
				<p><strong><a href="DropPrint_USB.zip">Download Sample</a></strong> (&#147;DropPrint_USB.zip&#148;, 72.5K)<BR>
<strong><a href="DropPrint_USB.dmg">Download Sample</a></strong> (&#147;DropPrint_USB.dmg&#148;, 133.2K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/**********************************************************************************  Project Name:  DropShell**     File Name:  DSUtils.c****   Description:  Utility routines that may be useful to DropBoxes***********************************************************************************                       A U T H O R   I D E N T I T Y***********************************************************************************  Initials  Name**  --------  -----------------------------------------------**  SCS      Stephan Somogyi**  LDR      Leonard Rosenthol***********************************************************************************                      R E V I S I O N   H I S T O R Y***********************************************************************************    Date    Author  Description**  ---------  ------  ---------------------------------------------**  23 Jun 94  LDR    Added a bunch of new routines for Marshall**  20 Feb 94  LDR    Added some new useful File System routines**  11 Dec 93  SCS    Universal Headers/UPPs (Phoenix 68k/PPC &amp; PPCC)**            Skipped System 6 compatible rev of DropShell source**            Changed GetAppName to GetMyAppName (StdCLib conflict)**  12/09/91  LDR    Added the Apple event routines**  11/24/91  LDR    Original Version********************************************************************************/#include &lt;Dialogs.h&gt;#include &lt;Types.h&gt;#ifndef __EPPC__#include &lt;eppc.h&gt;#endif#include &quot;DSGlobals.h&quot;#include &quot;DSUtils.h&quot;/*  This routine is used to properly center an Alert before showing.    It is per Human Interface specs by putting it in the top 1/3 of screen.  NOTE: This same technique can be used with DLOG resources as well.*/#pragma segment Mainvoid CenterAlert ( short theID ) {  short    theX, theY;  AlertTHndl  theAlertHandle;  Rect    screen, alrt;    theAlertHandle = (AlertTHndl) GetResource ( 'ALRT', theID );  if ( theAlertHandle != NULL ) {    HLock ((Handle) theAlertHandle );    alrt = (*theAlertHandle)-&gt;boundsRect;    screen = qd.screenBits.bounds;        theX = (( screen.right - screen.left ) - (alrt.right - alrt.left )) &gt;&gt; 1;    theY = (( screen.bottom - screen.top ) + GetMBarHeight () - (alrt.bottom - alrt.top)) &gt;&gt; 1;    theY -= ( screen.bottom - screen.top ) &gt;&gt; 2;  /* this moves it up for better viewing! */    OffsetRect ( &amp;(*theAlertHandle)-&gt;boundsRect, theX - alrt.left, theY - alrt.top );  }      SetCursor ( &amp;qd.arrow );  // change this for code resources!}/*  This routine is just a quick &amp; dirty error reporter*/#pragma segment Mainvoid ErrorAlert ( short stringListID, short stringIndexID, short errorID ) {  #define  kAlertID  200  Str255  param, errorStr;  NumToString ( errorID, errorStr );  GetIndString ( param, stringListID, stringIndexID );  ParamText ( param,  errorStr, NULL, NULL );  CenterAlert ( kAlertID );  (void) Alert ( kAlertID, NULL );}/*** These routines use the Process Manager to give you information about yourself ***/#pragma segment Mainvoid GetMyAppName(Str255 appName)  {  OSErr        err;  ProcessInfoRec    info;  ProcessSerialNumber  curPSN;  err = GetCurrentProcess(&amp;curPSN);    info.processInfoLength = sizeof(ProcessInfoRec);  // ALWAYS USE sizeof!  info.processName = appName;              // so it returned somewhere  info.processAppSpec = NULL;              // I don't care!  err = GetProcessInformation(&amp;curPSN, &amp;info);}#pragma segment Mainvoid GetAppFSSpec(FSSpec *appSpec)  {  OSErr        err;  Str255        appName;  ProcessInfoRec    info;  ProcessSerialNumber  curPSN;  err = GetCurrentProcess(&amp;curPSN);    info.processInfoLength = sizeof(ProcessInfoRec);  // ALWAYS USE sizeof!  info.processName = appName;              // so it returned somewhere  info.processAppSpec = appSpec;            // so it can get returned!  err = GetProcessInformation(&amp;curPSN, &amp;info);}/* *** File Routines begin here *** *//*  This routine is used to force the Finder (as much as is possible) to update  information about a newly changed file or folder.    It does this by changing the modification date of the surrounding folder.*/OSErr ForceFinderUpdate(FSSpec *pFSS, Boolean flush){  OSErr      lErr;  CInfoPBRec    lCBlk;    if (pFSS-&gt;parID != 1)              // if it's a vol then reuse the NameStr    lCBlk.dirInfo.ioNamePtr = 0L;  lCBlk.dirInfo.ioVRefNum = pFSS-&gt;vRefNum;      lCBlk.dirInfo.ioDrDirID = pFSS-&gt;parID;  lCBlk.dirInfo.ioFDirIndex = 0;  lCBlk.dirInfo.ioCompletion = 0;  lErr = PBGetCatInfoSync(&amp;lCBlk);  if (!lErr) {    GetDateTime(&amp;lCBlk.dirInfo.ioDrMdDat);    lCBlk.dirInfo.ioDrDirID = pFSS-&gt;parID;    lErr = PBSetCatInfoSync(&amp;lCBlk);      if ((!lErr) &amp;&amp; (flush))      lErr = FlushVol(nil, pFSS-&gt;vRefNum);  }    return (lErr);}/*  Is the file in use (busy)? */Boolean FSpIsBusy(FSSpecPtr theFile){  Boolean    isBusy = false;  OSErr    err;  CInfoPBRec  cipb;    cipb.hFileInfo.ioCompletion  = 0L;  cipb.hFileInfo.ioNamePtr  = theFile-&gt;name;  cipb.hFileInfo.ioVRefNum  = theFile-&gt;vRefNum;  cipb.hFileInfo.ioFDirIndex  = 0;  cipb.hFileInfo.ioDirID    = theFile-&gt;parID;  err = PBGetCatInfoSync(&amp;cipb);  if (!err) {    isBusy = (cipb.hFileInfo.ioFlAttrib &amp; 0x80) == 0x80;  // bit 7 = either fork open  }  return(isBusy);}/*  Is the &quot;file&quot; represented by this FSSpec really a folder? */Boolean  FSpIsFolder (FSSpecPtr theFSSpec) {  OSErr  err;  CInfoPBRec  pb;  Str255  fName;    if (theFSSpec-&gt;parID == fsRtParID)  // it's a volume!!    return(true);      BlockMoveData (theFSSpec-&gt;name, fName, 32);  pb.hFileInfo.ioDirID    = theFSSpec-&gt;parID;  pb.hFileInfo.ioCompletion  = NULL;  pb.hFileInfo.ioNamePtr    = fName;  pb.hFileInfo.ioVRefNum    = theFSSpec-&gt;vRefNum;  pb.hFileInfo.ioFDirIndex  = 0;  pb.hFileInfo.ioFVersNum    = 0;  err = PBGetCatInfoSync(&amp;pb);    if (!err) {    if (pb.hFileInfo.ioFlAttrib &amp; ioDirMask)      return(true);  }  return(false);}// Creates an empty handle to which FSSpecs could be added later!FSSpecArrayHandle  NewFSSpecList(void){  return((FSSpecArrayHandle)NewHandle(0));}// Releases memory used by an FSSpecList when all donevoid DisposeFSSpecList(FSSpecArrayHandle fsList){  DisposeHandle((Handle)fsList);}// Adds the new FSSpec to the end of an FSSpecListvoid AddToFSSpecList(FSSpec *fSpec, FSSpecArrayHandle fileList){  Size  curSize, newSize;  long  numFiles;  if ((!fileList) || (!fSpec)) return;  // if either is bogus, get out fast    curSize = GetHandleSize((Handle)fileList);  numFiles = curSize / sizeof(FSSpec);  newSize = curSize + sizeof(FSSpec);  SetHandleSize((Handle)fileList, newSize);  if (MemError())  return;    // any problems, get out    BlockMove(fSpec, &amp;(*fileList)[numFiles], sizeof(FSSpec));}/* *** Apple event routines begin here *** *//*  This routine will create a targetDesc for sending to self.  We take IM VI's advice and use the typePSN form with   kCurrentProcess as the targetPSN.*/OSErr GetTargetFromSelf (AEAddressDesc *targetDesc){  ProcessSerialNumber  psn;  psn.highLongOfPSN   = 0;  psn.lowLongOfPSN   = kCurrentProcess;  return( AECreateDesc(typeProcessSerialNumber, (Ptr)&amp;psn, sizeof(ProcessSerialNumber), targetDesc) );}/* This routine will create a targetDesc using the apps signature */OSErr GetTargetFromSignature (OSType processSig, AEAddressDesc *targetDesc){  return( AECreateDesc(typeApplSignature, (Ptr)&amp;processSig, sizeof(processSig), targetDesc) );}/* This routine will create a targetDesc by bringing up the PPCBrowser */OSErr GetTargetFromBrowser(Str255 promptStr, AEAddressDesc *targetDesc){  OSErr    err;  TargetID  theTarget;  PortInfoRec  portInfo;    err = PPCBrowser(promptStr, &quot;\p&quot;, false, &amp;theTarget.location, &amp;portInfo, NULL, &quot;\p&quot;);  if (err == noErr) {    theTarget.name = portInfo.name;    err = AECreateDesc(typeTargetID, (Ptr)&amp;theTarget, sizeof(TargetID), targetDesc);  }  return( err );}/*  This routine is the low level routine used by the SendODOCToSelf  routine.  It gets passed the list of files (in an AEDescList)  to be sent as the data for the 'odoc', builds up the event  and sends off the event.    It is broken out from SendODOCToSelf so that a SendODOCListToSelf could  easily be written and it could then call this routine - but that is left  as an exercise to the reader.    Read the comments in the code for the order and details*/void _SendDocsToSelf (AEDescList *aliasList){  OSErr      err;  AEAddressDesc  theTarget;  AppleEvent    openDocAE, replyAE;/*  First we create the target for the event.   We call another  utility routine for creating the target.*/  err = GetTargetFromSelf(&amp;theTarget);  if (err == noErr) {    /* Next we create the Apple event that will later get sent. */    err = AECreateAppleEvent(kCoreEventClass, kAEOpenDocuments, &amp;theTarget, kAutoGenerateReturnID, kAnyTransactionID, &amp;openDocAE);    if (err == noErr) {      /* Now add the aliasDescList to the openDocAE */      err = AEPutParamDesc(&amp;openDocAE, keyDirectObject, aliasList);      if (err == noErr) {        /*          and finally send the event          Since we are sending to ourselves, no need for reply.        */        err = AESend(&amp;openDocAE, &amp;replyAE, kAENoReply + kAECanInteract, kAENormalPriority, 3600, NULL, NULL);        /*          NOTE: Since we are not requesting a reply, we do not need to          need to dispose of the replyAE.  It is there simply as a           placeholder.        */      }    /*        Dispose of the aliasList descriptor      We do this instead of the caller since it needs to be done      before disposing the AEVT    */      err = AEDisposeDesc(aliasList);    }  /*and of course dispose of the openDoc AEVT itself*/    err = AEDisposeDesc(&amp;openDocAE);  }}/*  This is the routine called by SelectFile to send a single odoc to ourselves.    It calls the above low level routine to do the dirty work of sending the AEVT -  all we do here is build a AEDescList of the file to be opened.*/void SendODOCToSelf (FSSpec *theFileSpec) {  OSErr    err;  AEDescList  aliasList;  AEDesc    aliasDesc;  AliasHandle  aliasH;    /*Create the descList to hold the list of files*/  err = AECreateList(NULL, 0, false, &amp;aliasList);  if (err == noErr) {    /* First we setup the type of descriptor */    aliasDesc.descriptorType = typeAlias;    /*      Now we add the file to descList by creating an alias and then      adding it into the descList using AEPutDesc    */    err = NewAlias(NULL, theFileSpec, &amp;aliasH);    aliasDesc.dataHandle = (Handle)aliasH;    err = AEPutDesc(&amp;aliasList, 0, &amp;aliasDesc);    DisposeHandle((Handle)aliasH);    /*Now call the real gut level routine to do the dirty work*/    _SendDocsToSelf(&amp;aliasList);    /*_SendDocsToSelf will dispose of aliasList for me*/  }}void SendQuitToSelf (void){  OSErr      err;  AEAddressDesc  theTarget;  AppleEvent    quitAE, replyAE;/*  First we create the target for the event.   We call another  utility routine for creating the target.*/  err = GetTargetFromSelf(&amp;theTarget);  if (err == noErr) {    /* Next we create the Apple event that will later get sent. */    err = AECreateAppleEvent(kCoreEventClass, kAEQuitApplication, &amp;theTarget, kAutoGenerateReturnID, kAnyTransactionID, &amp;quitAE);    if (err == noErr) {      /*        and finally send the event        Since we are sending to ourselves, no need for reply.      */      err = AESend(&amp;quitAE, &amp;replyAE, kAENoReply + kAECanInteract, kAENormalPriority, 3600, NULL, NULL);      /*        NOTE: Since we are not requesting a reply, we do not need to        need to dispose of the replyAE.  It is there simply as a         placeholder.      */    }    /* and of course dispose of the quit AEVT itself */    err = AEDisposeDesc(&amp;quitAE);  }}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/DropPrint_USB/listing9.html%3Fid%3DDTS10000288-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/DropPrint_USB/listing9.html%3Fid%3DDTS10000288-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/DropPrint_USB/listing9.html%3Fid%3DDTS10000288-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>