<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note NW22: SNMP Transports</title><meta name="keywords" content=""><meta name="Description" content="Technical Note NW22: ">    <meta name="categories" content="Networking"><meta name="week-posted" content="May 31, 1993 - Jun 4, 1993"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"><a name="//apple_ref/doc/uid/DTS10002564" title="SNMP Transports"></a><a name="top"></a>                                       <!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/index.html" target="_blank">Reference Library</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note NW22</div>
<div id="pageheadsub">SNMP Transports</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->					<p id="menutext"><a href="#Introduction">Introduction</a><BR><BR><a href="#Section1">SNMP Transports</a><BR><BR><a href="#Summary">Summary</a><BR><BR><a href="#References">References</a><BR><BR><a href="#Downloads">Downloadables</a></p>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">This Technical Note explains how to write an SNMP (Simple Network ManagementProtocol) Transport. An SNMP Transport is responsible for communicating betweenthe SNMP Manager and a particular network layer. Thus, if you were writing anew network stack for the Macintosh and wanted it to use the SNMP Manager, youwould write an SNMP Transport for your network stack.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Jun 01 1993]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR><!-- begin_content --><a name="Introduction"></a><h2>Introduction</h2><p>It is assumed in this document that you understand MacSNMP, object-orientedprogramming and the Shared Library Manager. The SNMP Manager is built using theShared Library Manager and is a set of shared libraries. The SNMP Managershared library contains the implementation of the base class for an SNMPTransport. Your transport must be a subclass of this SNMP Transport class. Formore information on MacSNMP and the Shared Library Manager see the E.T.O. CDROM.</p><p>This Technote provides some additional information needed to construct an SNMPTransport for a particular network stack. An SNMP Transport is required to knowabout all of the specific idiosyncrasies of SNMP for a particular networkstack. SNMP was originally defined to run over the TCP stack using UDP. TheIETF (Internet Engineering Task Force) has also defined how to run SNMP overthree other network stacks: AppleTalk, IPX, and OSI. These methods aredocumented by the IETF proposed standards: RFC 1419--SNMP over AppleTalk, RFC1420--SNMP over IPX, and RFC 1418--SNMP over OSI. There is also aninformational RFC draft that describes what must be defined to allow SNMP torun over any particular network stack.</p><p>Apple provides SNMP transports that support the TCP stack and the AppleTalkstack. The TCP SNMP Transport provides knowledge of IP addresses, listens onthe well-known SNMP sockets, sends SNMP packets on UDP, and resolves addressesin dotted notation into IP addresses for sending <code>Traps</code>. (An SNMP<code>Trap</code> is the method that SNMP entities use to send unsolicited warningmessages to each other and should not be confused with a Macintosh OperatingSystem Trap.) The AppleTalk SNMP Transport likewise provides knowledge ofAppleTalk addresses, listens on the well-known SNMP sockets, sends SNMP packetson DDP, and resolves NBP (Name Binding Protocol) names into AppleTalk addressesfor sending <code>Traps</code>. Similarly, a new SNMP Transport would have toprovide these same services: understanding the new network addresses, listeningfor SNMP packets, sending SNMP packets, and resolving stored console addressesto network addresses for sending <code>Traps</code>.</p><a name="Section1"></a><P><A HREF="#top">Back to top</A></P><h2>SNMP Transports</h2><p align="center"><img src="images/nw_22_001.gif" alt="Figure 1. An SNMP Transport provides theinterface between the SNMP Manager and a particular network stack." width=416 height=414></p><p align="center"><b>Figure 1</b>. An SNMP Transport provides the interface between the SNMP Managerand a particular network stack.</p><b>Creating an SNMP Transport</b><p>The file Transport.h defines the SNMP Transport class. To create an SNMPTransport, you must subclass the SNMP Transport class. The Shared LibraryManager allows a run-time link of your SNMP Transport subclass with the baseobject SNMP Transport provided in the SNMP Manager shared library. Thedefinition of the SNMP Transport object is as follows:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>/************************************************************************ Class TSNMPTransport***********************************************************************/#define kTSNMPTransportID     &quot;snmp:mgr$TSNMPTrans&quot;#define kLIB_TransID      &quot;snmp:trans$&quot;    // Library ID for an SNMP Transportclass TSNMPTransport : public TDynamic{public:                TSNMPTransport();    virtual        ~TSNMPTransport();    virtual Boolean    IsValid() const;        // returns valid or not    virtual OSErr     InitSNMPTransport(        TransportTag        aTag,        TIAddressPtr        aTrapSocketPtr,        TIAddressPtr        aReqSocketPtr,        Boolean        ahandlesresolution,        short            aWritebufsize,        TransportRWProcPtr    aWriteProcPtr,        short            aNumofReads,        short            aReadTIAddrSRCmax,        short            aReadTIAddrDESTmax,        short            aReadbufsize,        TransportRWProcPtr    aReadProcPtr);    virtual void        SNMPWriteDone(SNMPTransportBlockPtr snmpPtr);    virtual void        SNMPReadDone(SNMPTransportBlockPtr snmpPtr);    TSNMPManagerPrv*    fSNMPManagerPtr;friend TSNMPManagerPrv;protected:        Boolean    fValid;        Boolean    fhandlesresolution;        short        fNumofReads;        short        fReadTIAddrSRCmax;        short        fReadTIAddrDESTmax;        short        fReadbufsize;        short        fWritebufsize;private:        TransportTag        fTag;        TIAddressPtr        fTrapSocketPtr;        TIAddressPtr        fReqSocketPtr;        TransportRWProcPtr    fWriteProcPtr;        TransportRWProcPtr    fReadProcPtr;</pre>	</TD></TR></TABLE></CENTER><p>To start an SNMP Transport you must instantiate it. For the AppleTalk SNMPTransport, we install a process on the AppleTalk transition queue that tells uswhen AppleTalk is coming up or going down and instantiate or destroy theTransport as appropriate. For the TCP SNMP Transport, an INIT31 instantiatesthe Transport and it is never destroyed. For your Transport you must providethe code that instantiates and destroys your Transport.</p><p>When a Transport is instantiated the base class constructor is called first.The base class constructor fills in the <code>fSNMPManagerPtr</code> field with apointer to a class <code>TSNMPManagerPrv</code>, which can be cast to a pointer tothe class <code>TSNMPManager</code> defined in TSNMP.h. This pointer can be used toaccess the members of the <code>TSNMPManager</code> class. The constructor alsoadds a pointer to your SNMP Transport object to a queue of transports so thatit can find you later, and if everything worked, sets the <code>fValid</code> fieldto true. Your constructor is then called. If the <code>fValid</code> field is notset to true on the entrance to your constructor, you should bail out of theconstructor immediately. If your constructor fails for some reason, you shouldset the <code>fValid</code> field to false. The Shared Library Manager will thenclean up the object so that a partially constructed one does not remain.</p><b>Initializing an SNMP Transport</b><p>After your Transport is constructed it must be initialized. Your transport willnot work until <code>InitSNMPTransport()</code> is called. This routine sets all ofthe fields in the SNMP Transport from the parameter values that you pass in.You must call the inherited <code>InitSNMPTransport</code> member function if youoverride it. The following fields must be set.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>-&gt;    TransportTag        aTagA long that uniquely identifies a transport (analogous to OSType)-&gt;    TIAddressPtr        aTrapSocketPtrOpaque address of where the Transport listens for Traps-&gt;    TIAddressPtr        aReqSocketPtrOpaque address of where the Transport listens for Requests-&gt;    Boolean            ahandlesresolutionTrue if the transport can send Traps-&gt;    short            aWritebufsizeMaximum size of write buffers-&gt;    TransportRWProcPtr        aWriteProcPtrAddress of the write procedure-&gt;    short            aNumofReadsMaximum number of reads issued at once-&gt;    short            aReadTIAddrSRCmaxMaximum length of source address for read operations-&gt;    short            aReadTIAddrDESTmaxMaximum length of destination address for read operations-&gt;    short            aReadbufsizeMaximum size of a read buffer-&gt;    TransportRWProcPtr        aReadProcPtr</pre>	</TD></TR></TABLE></CENTER><p>It is recommended that the <code>TransportTag</code> be four human readable ASCIIcharacters that describe the network layer that the Transport talks to. Ifmultiple Transports with the same <code>TransportTag</code> are instantiated, theSNMP Manager will ignore all but the first one instantiated. For the AppleTalkSNMP Transport the tag is <code>'DDP '</code>, for the TCP SNMP Transport the tagis <code>'UDP '</code>. This value is used in the <code>Trap</code> Table in theMacintosh Agent to determine which Transport understands the console addressstored in a particular row of the table. The sockets are where the Transportlistens for <code>Traps</code> and <code>Requests</code>. The SNMP Manager does notunderstand the format of these addresses and just passes them along to yourTransport. They are also used as the source of <code>Traps</code> or<code>Responses</code> sent. Finally, they allow the SNMP Manager to determine whattype of packet it is decoding before parsing the raw ASN.1 data. In ourTransports we have stored pointers to the actual bits of the network layeraddresses in these fields. The <code>aWritebufsize</code> and <code>aReadbufsize</code>are the size of buffers that the SNMP Manager allocates for your Transport touse.</p><b>Reading SNMP Packets</b><p>Finally, <code>InitSNMPTransport()</code> tries to issue <code>aNumofReads</code>outstanding reads by calling your <code>aReadProc()</code> with a filled in<code>SNMPTransportBlock</code> as shown in Figure 2. The SNMPTransportBlock isdefined as follows:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>struct SNMPTransportBlock {    unsigned long        qLink;        // reserved for pointer to next block    short            qType;        // reserved for queue routines    TSNMPTransport*     transport;    // who was asked to read or write block    SNMPError        result;    // after request is serviced    void*             destopaqueData;// destination address to be resolved                                     // (used in write trap only)    TIAddressPtr        destination;    // who the packet was sent to    TIAddressPtr        source;    // who sent the packet to us    void *            UserDataPtr;    // Transport work space    Boolean        freeFlag;    // is the write finished?    Boolean        readFlag;    // managed by SNMP Manager    PacketElementPtr    pktelementPtr;// managed by SNMP Manager    SNMPPacketStructPtr    packetPtr;    // managed by SNMP Manager</pre>	</TD></TR></TABLE></CENTER><p>The <code>aReadProc()</code> must be able to catch both incoming <code>Traps</code> and<code>Requests</code>. It must also be able to be called at <i>any</i> time, thusyou must not allocate memory using the normal Macintosh memory calls. You mayuse the area pointed to by <code>UserDataPtr</code> for any scratch you might need.The SNMP Manager has preallocated this area for you according to the sizes youset in <code>aReadbufsize</code>. It must also return immediately. When a readactually completes you must call <code>SNMPReadDone()</code> after filling in thedata, the source and destination addresses, the actual number of bytes read (in<code>packetPtr-&gt;packetPiece.dataSize</code>), the <code>freeFlag</code> (set to<i>false</i>), and the <code>result</code> (<code>snmpNoError</code> if it worked.)</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Warning:</B><BR>If the <code>freeFlag</code> is incorrectly set, the SNMP Managerwill become hopelessly confused.</P></TD></TR></TABLE></CENTER><BR><p>After the read packet is processed by the SNMP Manager it issues another readcall to <code>aReadProc()</code> so that there will always be some number ofoutstanding reads. If there are no outstanding reads at any time it isallowable for your transport to drop SNMP packets.</p><p align="center"><img src="images/nw_22_002.gif" alt="Figure 2. Layout of SNMPTransportBlock when aReadProc() called. Only the fields that the Transport may need to access are shown." width=416 height=357></p><p align="center"><b>Figure 2</b>. Layout of <code>SNMPTransportBlock</code> when <code>aReadProc()</code> called. Only thefields that the Transport may need to access are shown.</p><p>When your Transport is deleted you must ensure that your completion routineswill not be called after your destructor is finished and your Transport objectis gone. You may have to wait for asynchronous writes to complete and cancelany outstanding reads. The base class destructor will ensure that any packetsyou have queued up for processing will be thrown away.</p><p align="center"><img src="images/nw_22_003.gif" alt="Figure 3. Layout of SNMPTransportBlock when the SNMP Manager calls aWriteProc() with a response to an SNMP Request." width=448 height=367></p><p align="center"><b>Figure 3</b>. Layout of <code>SNMPTransportBlock</code> when the SNMP Manager calls<code>aWriteProc()</code> with a response to an SNMP Request. *<br>*  Only the fields that the Transport may need to access are shown.</p><h3>Writing SNMP Packets</h3><p>After a packet is processed by the SNMP Manager, it will almost always generatea <code>Response</code> packet. The SNMP Manager will either respond to a<code>Request</code> or generate a <code>Trap</code>. In the cases of a simple<code>Response</code> the SNMP Manager will call your <code>aWriteProc()</code> with an<code>SNMPTransportBlock</code> filled out as shown in Figure 3. Your<code>aWriteProc()</code> may be called at <i>any</i> time, thus you must notallocate memory using the normal Macintosh memory calls. You may use the areapointed to by <code>UserDatPtr</code> for any scratch memory you need. The SNMPManager has preallocated this area for you according to the sizes you set in<code>aWritebufsize</code>. The destination socket is the same block as was passedin on the read as the source socket, the source socket is your initialized<code>fRequestSocketPtr</code>, the <code>packetPtr</code> points to the SNMP data toput on the wire. You must return immediately from the call to<code>aWriteProc()</code>. After the write completes you should fill in the<code>result</code>, set the <code>freeFlag</code> to <i>true,</i> and call<code>SNMPWriteDone()</code> so that the SNMP Manager can free up the memory itallocated.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Warning:</B><BR>If the <code>freeFlag</code> is incorrectly set the SNMP Managerwill become hopelessly confused.</TD></TR></TABLE></CENTER><BR> <p>If your Transport can send <code>Traps</code> it must set the<code>fHandlesResolution</code> field to true. It is strongly encouraged that yourtransport handle <code>Traps</code>, if it did not, it would not be fully compliantwith the SNMP standard. When a <code>Trap</code> is generated, the SNMP Managerwill determine if the <code>Trap</code> is supposed to be sent to a console thatsupports your Transport type by looking through the <code>Trap</code> table in theMacintosh System MIB implemented by the Macintosh Agent. If so, it will issue acall to your <code>aWriteProc()</code> as above, except that the<code>destOpaqueData</code> will point to a block that the SNMP Manager hasprocured from the <code>trapDestination</code> field in the <code>Trap</code> Table inthe Macintosh Agent. It is up to you to define how this address will be stored.However, it must be nonvolatile between reboots of the system. For theAppleTalk SNMP transport, we store the NBP name of the console as specified inthe AppleTalk over SNMP RFC. For the TCP SNMP Transport, we store the IPaddress of the console in dotted notation The Transport is responsible forturning this address into the wire address of the console. Everything else isas above. You must return immediately after the call to your<code>aWriteProc()</code> and call <code>SNMPWriteDone()</code> when the <code>Trap</code>write completes.</p><p>The <code>Trap</code> Table is implemented by the Macintosh Agent and is defined inASN.1 by the Macintosh System MIB as:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>TrapRequestEntry     ::= SEQUENCE {trapIndex        INTEGER,            // unsigned longtrapCommunity        MacintoshDisplayString,    // opaque datatrapProtocol        MacOSType,            // four bytestrapDestination    OCTET STRING,            // opaque datatrapValidity        INTEGER            // 1 = valid, 2 = invalid</pre>	</TD></TR></TABLE></CENTER><p>The two fields that an SNMP Transport author must define are the<code>trapProtocol</code> and the <code>trapDestination</code>. The<code>trapProtocol</code> is compared by the SNMP Manager to the<code>TransportTag</code> and is used to identify which SNMP Transport will be ableto resolve the <code>trapDestination</code> entry and send the <code>Trap</code>. The<code>trapProtocol</code> field must contain the same value that was initialized inthe <code>transportTag</code> field. Some care should be given to the format of the<code>trapDestination</code> as network managers will have to enter these addressesby hand from a console.</p><P><A HREF="#top">Back to top</A></P><a name="Summary"></a><h2>Summary</h2><p>An SNMP Transport provides an interface between the SNMP Manager and a networklayer of a particular network stack. It must be able to be called at any time,thus cannot depend on the Macintosh memory calls. A Transport must understandhow a <code>Trap</code> destination (console address) is to be stored in theMacintosh Agent's Trap Table. This address format must be stable betweenreboots of the system and must be resolvable into a network address for theconsole. It is the responsibility of the Transport developer to inform networkmanagers of how to store this address. For IPX, AppleTalk, and OSI, thesestandards have been specified in RFCs (Request For Comments). These documentsare available on-line off of the Internet and are maintained in variousrepositories and formats by the IETF.</p><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><P><i>MacSNMP Programmer's Guide</i></p><P><i>Shared Library Manager Programmer's Guide</i></p><P>RFC 1157, A Simple Network Management Protocol (SNMP)</p><P>RFC 1155, Structure and Identification of Management Information forTCP/IP-based Internets</p><P>RFC 1419, SNMP over AppleTalk, Internet Proposed Standard</p><P>Macintosh System MIB</p>                                     <P><A HREF="#top">Back to top</A></P><P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (312K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/nw_22.pdf">Download</A></P>               </TD>            </TR>                     </TABLE>         <BR>         <P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/nw/nw_22.html%3Fid%3DDTS10002564-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/nw/nw_22.html%3Fid%3DDTS10002564-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/nw/nw_22.html%3Fid%3DDTS10002564-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>