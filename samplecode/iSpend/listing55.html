<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>iSpend - /iSpendPlugin/main.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/Cocoa/index.html">Cocoa</a> &gt; <a href="../../samplecode/Cocoa/idxDataManagement-date.html">Data Management</a> &gt; <A HREF="javascript:location.replace('index.html');">iSpend</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">iSpend</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/iSpendPlugin/main.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/iSpend_01/ExpandableViewController.h</option>
<option value="listing2.html">/iSpend_01/ExpandableViewController.m</option>
<option value="listing3.html">/iSpend_01/main.m</option>
<option value="listing4.html">/iSpend_01/MyDocument.h</option>
<option value="listing5.html">/iSpend_01/MyDocument.m</option>
<option value="listing6.html">/iSpend_01/MyDocument_Toolbar.m</option>
<option value="listing7.html">/iSpend_01/Transaction.h</option>
<option value="listing8.html">/iSpend_01/Transaction.m</option>
<option value="listing9.html">/iSpend_01/TransactionsController.h</option>
<option value="listing10.html">/iSpend_01/TransactionsController.m</option>
<option value="listing11.html">/iSpend_02/ExpandableViewController.h</option>
<option value="listing12.html">/iSpend_02/ExpandableViewController.m</option>
<option value="listing13.html">/iSpend_02/main.m</option>
<option value="listing14.html">/iSpend_02/MyDocument.h</option>
<option value="listing15.html">/iSpend_02/MyDocument.m</option>
<option value="listing16.html">/iSpend_02/MyDocument_Pasteboard.h</option>
<option value="listing17.html">/iSpend_02/MyDocument_Pasteboard.m</option>
<option value="listing18.html">/iSpend_02/MyDocument_Toolbar.m</option>
<option value="listing19.html">/iSpend_02/Transaction.h</option>
<option value="listing20.html">/iSpend_02/Transaction.m</option>
<option value="listing21.html">/iSpend_02/TransactionsController.h</option>
<option value="listing22.html">/iSpend_02/TransactionsController.m</option>
<option value="listing23.html">/iSpend_02/TransactionsController_Dragging.m</option>
<option value="listing24.html">/iSpend_03/ExpandableViewController.h</option>
<option value="listing25.html">/iSpend_03/ExpandableViewController.m</option>
<option value="listing26.html">/iSpend_03/main.m</option>
<option value="listing27.html">/iSpend_03/MyDocument.h</option>
<option value="listing28.html">/iSpend_03/MyDocument.m</option>
<option value="listing29.html">/iSpend_03/MyDocument_Pasteboard.h</option>
<option value="listing30.html">/iSpend_03/MyDocument_Pasteboard.m</option>
<option value="listing31.html">/iSpend_03/MyDocument_Toolbar.m</option>
<option value="listing32.html">/iSpend_03/Transaction.h</option>
<option value="listing33.html">/iSpend_03/Transaction.m</option>
<option value="listing34.html">/iSpend_03/TransactionsController.h</option>
<option value="listing35.html">/iSpend_03/TransactionsController.m</option>
<option value="listing36.html">/iSpend_03/TransactionsController_Dragging.m</option>
<option value="listing37.html">/iSpend_03/TransactionsController_Sorting.m</option>
<option value="listing38.html">/iSpend_04/ExpandableViewController.h</option>
<option value="listing39.html">/iSpend_04/ExpandableViewController.m</option>
<option value="listing40.html">/iSpend_04/main.m</option>
<option value="listing41.html">/iSpend_04/MyDocument.h</option>
<option value="listing42.html">/iSpend_04/MyDocument.m</option>
<option value="listing43.html">/iSpend_04/MyDocument_Pasteboard.h</option>
<option value="listing44.html">/iSpend_04/MyDocument_Pasteboard.m</option>
<option value="listing45.html">/iSpend_04/MyDocument_Toolbar.m</option>
<option value="listing46.html">/iSpend_04/SearchController.h</option>
<option value="listing47.html">/iSpend_04/SearchController.m</option>
<option value="listing48.html">/iSpend_04/Transaction.h</option>
<option value="listing49.html">/iSpend_04/Transaction.m</option>
<option value="listing50.html">/iSpend_04/TransactionsController.h</option>
<option value="listing51.html">/iSpend_04/TransactionsController.m</option>
<option value="listing52.html">/iSpend_04/TransactionsController_Dragging.m</option>
<option value="listing53.html">/iSpend_04/TransactionsController_Sorting.m</option>
<option value="listing54.html">/iSpendPlugin/GetMetadataForFile.m</option>
<option value="listing55.html">/iSpendPlugin/main.c</option>
<option value="listing56.html">/iSpendPlugin/Transaction.h</option>
<option value="listing57.html">/iSpendPlugin/Transaction.m</option></select>
				</p>
				</form>
				<p><strong><a href="iSpend.zip">Download Sample</a></strong> (&#147;iSpend.zip&#148;, 1.04M)<BR>
<strong><a href="iSpend.dmg">Download Sample</a></strong> (&#147;iSpend.dmg&#148;, 1.32M)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*
 
 File: main.c
 
 Version: 1.0
 
 Copyright &copy; 2005 Apple Computer, Inc., All Rights Reserved
 
 */ 





//==============================================================================
//
//  DO NO MODIFY THE CONTENT OF THIS FILE
//
//  This file contains the generic CFPlug-in code necessary for your importer
//  To complete your importer implement the function in GetMetadataForFile.c
//
//==============================================================================






#include &lt;CoreFoundation/CoreFoundation.h&gt;
#include &lt;CoreFoundation/CFPlugInCOM.h&gt;
#include &lt;CoreServices/CoreServices.h&gt;

// -----------------------------------------------------------------------------
//  constants
// -----------------------------------------------------------------------------


#define PLUGIN_ID &quot;7DCC8D96-C843-4D1C-B0D0-8D9CE2443042&quot;

//
// Below is the generic glue code for all plug-ins.
//
// You should not have to modify this code aside from changing
// names if you decide to change the names defined in the Info.plist
//


// -----------------------------------------------------------------------------
//  typedefs
// -----------------------------------------------------------------------------

// The import function to be implemented in GetMetadataForFile.c
Boolean GetMetadataForFile(void *thisInterface, 
         CFMutableDictionaryRef attributes, 
         CFStringRef contentTypeUTI,
         CFStringRef pathToFile);
         
// The layout for an instance of MetaDataImporterPlugIn 
typedef struct __MetadataImporterPluginType
{
    MDImporterInterfaceStruct *conduitInterface;
    CFUUIDRef                 factoryID;
    UInt32                    refCount;
} MetadataImporterPluginType;

// -----------------------------------------------------------------------------
//  prototypes
// -----------------------------------------------------------------------------
//  Forward declaration for the IUnknown implementation.
//

MetadataImporterPluginType  *AllocMetadataImporterPluginType(CFUUIDRef inFactoryID);
void                      DeallocMetadataImporterPluginType(MetadataImporterPluginType *thisInstance);
HRESULT                   MetadataImporterQueryInterface(void *thisInstance,REFIID iid,LPVOID *ppv);
void                     *MetadataImporterPluginFactory(CFAllocatorRef allocator,CFUUIDRef typeID);
ULONG                     MetadataImporterPluginAddRef(void *thisInstance);
ULONG                     MetadataImporterPluginRelease(void *thisInstance);
// -----------------------------------------------------------------------------
//  testInterfaceFtbl  definition
// -----------------------------------------------------------------------------
//  The TestInterface function table.
//

static MDImporterInterfaceStruct testInterfaceFtbl = {
    NULL,
    MetadataImporterQueryInterface,
    MetadataImporterPluginAddRef,
    MetadataImporterPluginRelease,
    GetMetadataForFile
};


// -----------------------------------------------------------------------------
//  AllocMetadataImporterPluginType
// -----------------------------------------------------------------------------
//  Utility function that allocates a new instance.
//      You can do some initial setup for the importer here if you wish
//      like allocating globals etc...
//
MetadataImporterPluginType *AllocMetadataImporterPluginType(CFUUIDRef inFactoryID)
{
    MetadataImporterPluginType *theNewInstance;

    theNewInstance = (MetadataImporterPluginType *)malloc(sizeof(MetadataImporterPluginType));
    memset(theNewInstance,0,sizeof(MetadataImporterPluginType));

        /* Point to the function table */
    theNewInstance-&gt;conduitInterface = &amp;testInterfaceFtbl;

        /*  Retain and keep an open instance refcount for each factory. */
    theNewInstance-&gt;factoryID = CFRetain(inFactoryID);
    CFPlugInAddInstanceForFactory(inFactoryID);

        /* This function returns the IUnknown interface so set the refCount to one. */
    theNewInstance-&gt;refCount = 1;
    return theNewInstance;
}

// -----------------------------------------------------------------------------
//  DeallociSpendImporterMDImporterPluginType
// -----------------------------------------------------------------------------
//  Utility function that deallocates the instance when
//  the refCount goes to zero.
//      In the current implementation importer interfaces are never deallocated
//      but implement this as this might change in the future
//
void DeallocMetadataImporterPluginType(MetadataImporterPluginType *thisInstance)
{
    CFUUIDRef theFactoryID;

    theFactoryID = thisInstance-&gt;factoryID;
    free(thisInstance);
    if (theFactoryID){
        CFPlugInRemoveInstanceForFactory(theFactoryID);
        CFRelease(theFactoryID);
    }
}

// -----------------------------------------------------------------------------
//  MetadataImporterQueryInterface
// -----------------------------------------------------------------------------
//  Implementation of the IUnknown QueryInterface function.
//
HRESULT MetadataImporterQueryInterface(void *thisInstance,REFIID iid,LPVOID *ppv)
{
    CFUUIDRef interfaceID;

    interfaceID = CFUUIDCreateFromUUIDBytes(kCFAllocatorDefault,iid);

    if (CFEqual(interfaceID,kMDImporterInterfaceID)){
            /* If the Right interface was requested, bump the ref count,
             * set the ppv parameter equal to the instance, and
             * return good status.
             */
        ((MetadataImporterPluginType*)thisInstance)-&gt;conduitInterface-&gt;AddRef(thisInstance);
        *ppv = thisInstance;
        CFRelease(interfaceID);
        return S_OK;
    }else{
        if (CFEqual(interfaceID,IUnknownUUID)){
                /* If the IUnknown interface was requested, same as above. */
            ((MetadataImporterPluginType*)thisInstance )-&gt;conduitInterface-&gt;AddRef(thisInstance);
            *ppv = thisInstance;
            CFRelease(interfaceID);
            return S_OK;
        }else{
                /* Requested interface unknown, bail with error. */
            *ppv = NULL;
            CFRelease(interfaceID);
            return E_NOINTERFACE;
        }
    }
}

// -----------------------------------------------------------------------------
//  MetadataImporterPluginAddRef
// -----------------------------------------------------------------------------
//  Implementation of reference counting for this type. Whenever an interface
//  is requested, bump the refCount for the instance. NOTE: returning the
//  refcount is a convention but is not required so don't rely on it.
//
ULONG MetadataImporterPluginAddRef(void *thisInstance)
{
    ((MetadataImporterPluginType *)thisInstance )-&gt;refCount += 1;
    return ((MetadataImporterPluginType*) thisInstance)-&gt;refCount;
}

// -----------------------------------------------------------------------------
// SampleCMPluginRelease
// -----------------------------------------------------------------------------
//  When an interface is released, decrement the refCount.
//  If the refCount goes to zero, deallocate the instance.
//
ULONG MetadataImporterPluginRelease(void *thisInstance)
{
    ((MetadataImporterPluginType*)thisInstance)-&gt;refCount -= 1;
    if (((MetadataImporterPluginType*)thisInstance)-&gt;refCount == 0){
        DeallocMetadataImporterPluginType((MetadataImporterPluginType*)thisInstance );
        return 0;
    }else{
        return ((MetadataImporterPluginType*) thisInstance )-&gt;refCount;
    }
}

// -----------------------------------------------------------------------------
//  iSpendImporterMDImporterPluginFactory
// -----------------------------------------------------------------------------
//  Implementation of the factory function for this type.
//
void *MetadataImporterPluginFactory(CFAllocatorRef allocator,CFUUIDRef typeID)
{
    MetadataImporterPluginType *result;
    CFUUIDRef                 uuid;

        /* If correct type is being requested, allocate an
         * instance of TestType and return the IUnknown interface.
         */
    if (CFEqual(typeID,kMDImporterTypeID)){
        uuid = CFUUIDCreateFromString(kCFAllocatorDefault,CFSTR(PLUGIN_ID));
        result = AllocMetadataImporterPluginType(uuid);
        CFRelease(uuid);
        return result;
    }
        /* If the requested type is incorrect, return NULL. */
    return NULL;
}

</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/iSpend/listing55.html%3Fid%3DDTS10003625-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/iSpend/listing55.html%3Fid%3DDTS10003625-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/iSpend/listing55.html%3Fid%3DDTS10003625-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>