<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"            "http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note ME505: Memory Manager Q&amp;As</title><meta name="keywords" content="Mac OS 7 Memory Manager GetPhysical cache GetMHandle GetHandleSize"><meta name="Description" content="Technical Note ME505: This Technical Note contains a collectionof archived Q&amp;As relating to the Memory Manager--questionssent the Developer Support Center (DSC) along with answersfrom the DSC engineers. Archived questions include: Shouldthe range used by GetPhysical be locked if VM is disabled?Caching details for locked pages on 68030 and 68040; Howto validate handles passed from another application; Warningabout using GetMHandle; How to check for GetHandleSize errorconditions."><meta name="categories" content="Memory"><meta name="week-posted" content="Oct 1, 1990 - Oct 5, 1990"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"><a name="//apple_ref/doc/uid/DTS10002540" title="Memory Manager Q&As"></a><a name="top"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/index.html" target="_blank">Reference Library</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note ME505</div>
<div id="pageheadsub">Memory Manager Q&amp;As</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Section1">Lock GetPhysical address range even with VM disabled</a><BR><BR> <A HREF="#Section2">Caching details for locked pages on 68030 and 68040</a><BR><BR> <A HREF="#Section3">Validating handles passed from another application</a><BR><BR> <A HREF="#Section4">GetMHandle warning applies only to popUpCDEF menus</a><BR><BR> <A HREF="#Section5">Checking for GetHandleSize error conditions</a><BR><BR>  <A HREF="#Section6">How Macintosh memory location 0 gets changed</a><BR><BR> <A HREF="#References">References</A><BR><BR> <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">This Technical Note contains a collection of archived Q&amp;As relating to a specific topic--questions sent the Developer Support Center (DSC) along withanswers from the DSC engineers. Current Q&amp;As can be found on the <a href="../../qa/index.html">Macintosh Technical Q&amp;As web site</a>.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Oct 01 1990]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><a name="Section1"></a><h2>Lock GetPhysical address range even with VM disabled</h2><p>Date Written:  3/10/93</p><p>Last reviewed: 6/24/93</p><p>Page 318 of Inside Macintosh: Memory says you must lock the address rangepassed to the <code>GetPhysical</code> routine to guarantee that the translation data areaccurate (that is, paging activity hasn't invalidated translation data). Isthis true even if Virtual Memory is disabled? Does the Macintosh OperatingSystem ever change the mapping of physical to logical addresses when VM isreally off?</p><p>___</p><p>In the current implementation of the OS, pages don't move when VM isn't on;however, we can't guarantee that that will always be true. Also, the <code>GetPhysical</code> implementation may not always allow you to translate addresses that haven't been locked (currently, it appears to allow this, but this may also change). So, you should lock the <code>GetPhysical</code> address range even with VM disabled.</p> <P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>Caching details for locked pages on 68030 and 68040</h2><p>Date Written:  3/10/93</p><p>Last reviewed: 6/24/93</p><p>The Macintosh Technical Note <u><A HREF = "../hw/hw_06.html">"Cache as Cache Can"</a></u> states that data cacheing may be disabled or pages may be marked noncacheable in certain cases. Could youprovide details of what exactly happens in 68030 and '040 CPU types. Which option is taken and what criteria is used in each case?</p><p>___</p><p>Basically, the caching situation for locked pages is this: on the Macintosh IIci and IIsi, locking a page disables the cache as a fix for a hardware problem. On other 68030 machines, the cache will be disabled with a 1 megabyte page resolution; on 040 machines, the page size is 16K. (***Tim, add "when VM is off"?***)</p> <P><A HREF="#top">Back to top</A></P><a name="Section3"></a><h2>Validating handles passed from another application</h2><p>Date Written:  1/14/93</p><p>Last reviewed:  6/14/93</p><p>I've written a control that is passed a handle from an application for which Idon't have the source. This application sometimes passes invalid handles. Icheck to make sure a handle and its pointer are even and call <code>GetHandleSize</code> toverify the handle. This works about 95 percent of the time, but sometimes aninvalid handle causes GetHandleSize to crash. How can I verify a handle?</p><p>___</p><p>As you've found, passing a bogus handle to most Memory Manager calls will causea deadly crash, which helps make validating handles a challenge. Even when youcan determine that a long value is a valid handle, there's always thepossibility that it doesn't point to data that you want or should be messingwith. For example, you could be setting the size of a handle that belongs to aresource, completely confusing the Resource Manager. A valid handle pointing tosomeone else's data may make you crash after you try to use the data. You mustalso deal with the possibility that the handle is correct but your code doesn'tlike it because it's been allocated in the application's secondary heap, or itmay be in the system heap or temporary memory. There's also a performance hitwhen you take time to validate handles.</p><p>In short, it's better to change the source of the invalid handles so that itstops passing you garbage than to deal with validating handles. If you must doit, here are some checks that will help you get some certainty on the validityof a handle you receive:</p><ul type="disc">	<li>A handle is an multiple of four.<BR><BR></li>	<li>A handle is between the top of the system heap and bufPtr (within useful RAM).<BR><BR></li>	<li>If the heap is known, walk the heap or just check that the address is in bounds.<BR><BR></li>	<li>Repeat checks on handle^ to make sure.<BR><BR></li></ul><p>Again, there's no way to determine whether a random value is the handle youexpect to receive. The best documentation on the subject is the <i>InsideMacintosh: Memory;</i> it describes the structure of zones and heaps in depth.Check it out for more precise details on how to implement the validation codeif you decide to go ahead with it.</p> <P><A HREF="#top">Back to top</A></P><a name="Section4"></a><h2>GetMHandle warning applies only to popUpCDEF menus</h2><p>Date Written:  1/14/93</p><p>Last reviewed:  3/10/93</p><p>The System 7.1 Digest has a disturbing comment about <code>GetMHandle</code>--namely that itwas never supported and will no longer work. Is this true?</p><p>___</p><p>This warning is misleading and is being corrected in future release notes. Itapplies <i>only</i> to pop-up menus created with the pop-up menu control.Before System 7.1, after a control was created, <code>GetMHandle</code> would return themenu handle for the control although it was never documented as doing so. InSystem 7.1 it was changed so that the menu would be inserted into the menu listonly when the control was getting ready to pop up the menu and deleted as soonas the control was done with it, so you could no longer use <code>GetMHandle</code> toretrieve the menu handle. The proper way to get the menu handle is from themHandle field of the <code>popupPrivateData</code> structure. The handle to this structureis in the contrlData field of the pop-up menu's control record.</p><p>A corollary is that the pop-up control has always checked to see if the menuwas already in the menu list. If it is, the control doesn't get the menu fromthe menu resource and doesn't delete the menu when it's done. You can use thisfeature, for example, if you want to create a menu with <code>NewMenu</code> rather thangetting it from a resource. In this case, and all other cases where theapplication inserts and deletes the pop-up menu in the menu list itself,GetMHandle can be used to retrieve the menu handle because it 's under thecontrol of the application.</p> <P><A HREF="#top">Back to top</A></P><a name="Section5"></a><h2>Checking for GetHandleSize error conditions</h2><p>Date Written:  10/14/91</p><p>Last reviewed:  6/14/93</p><p><i>Inside Macintosh</i> Volume II, page 33, states that <code>_GetHandleSize</code> returnsD0.L &gt;= 0 if the trap is successful or D0.W &lt; 0 if the trap is unsuccessful. What happens if the handle size is 0xFFFF, for instance? A TST.W will indicate an error when in fact there is none. How should I check for this condition?</p><p>___</p><p><i>Inside Macintosh</i> is correct (although confusing) regarding thedetermination of an error condition. The way to do it is first test the long tosee if it's valid (D0 &gt;= 0). If the long is valid, you can continue withconfidence that no error occurred. If, however, the long in D0 is negative, thelow word contains the error (and currently the high word contains $FFFF, thesign extension). The reason the manual highlights the fact that only the lowword contains the error is to allow you to save the error in standard fashionsince all other errors are word sized, and also to caution you against usingthe processor status on exit from <code>GetHandleSize</code> since it will be based on thelow word only. In other words, if the long is negative, simply ignore the highword. Here's some assembly code that will work:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>      move.L    theHandle(a6),A0      _GetHandleSize      tst.L     D0      bpl.s     @valueOK      move.W    D0,theError(A5)      moveQ     #0,D0@valueOK</pre>	</TD></TR></TABLE></CENTER> <P><A HREF="#top">Back to top</A></P><a name="Section6"></a><h2>How Macintosh memory location 0 gets changed</h2><p>Date Written:  3/12/91</p><p>Last reviewed:  6/14/93</p><p>Why does the longword at location $0 get changed to 0x40810000 at every trap?</p><p>___</p><p>In System 7, the Process Manager slams a benign value into location $0 to helpprotect against bus errors when an application inadvertently dereferences a NILpointer. (There's no bus-error checking on writes to ROM, so the "benign value"is usually ROMBase+$10000.)</p><p>If you're debugging, you want the opposite effect: you want these inadvertent accesses to "cause" bus errors. If you put a different value in location $0 before the Process Manager starts up (that is, from MacsBug or TMON initialization, or from an INIT like <code>EvenBetterBusError</code>), it will force that value instead. For more information, see the "Macintosh Debugging" article in this issue.</p> <P><A HREF="#top">Back to top</A></P>                           <P><A NAME=Downloads></A></P>                  <h2>Downloadables</h2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/me_505.pdf">Download</A></P>               </TD>            </TR>                     </TABLE>         <BR>                  <P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/me/me_505.html%3Fid%3DDTS10002540-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/me/me_505.html%3Fid%3DDTS10002540-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/me/me_505.html%3Fid%3DDTS10002540-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>