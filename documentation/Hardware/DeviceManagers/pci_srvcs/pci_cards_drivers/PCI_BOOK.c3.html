<HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><script language="JavaScript" src="frametest.js"></script><TITLE> Initialization and Finalization Routines</TITLE></HEAD><BODY BGCOLOR="#ffffff"><DIV><a name="top"></a><!-- start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!-- start of path --><font face="Geneva,Helvetica,Arial" size="1"><b><br>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Documentation</a> &gt; <!-- a href="" target="_top" -->Hardware<!-- /a -->  <b>&gt; </b><a href="../../devicemgrs.html" target="_top">Device Managers and Drivers</a> <b>&gt; </b><a href="../pci_srvcs.html" target="_top">PCI Card Services</a> <b>&gt; </b>Designing PCI Cards and Drivers for Power Macintosh Computers</font><br><br><!-- end of path --><A HREF="PCI_BOOK.c2.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.c2.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.c4.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><HR></DIV><H1 CLASS="H3.Heading3"><A NAME="pgfId=3832"> </A><A NAME="13884"> </A>Initialization and Finalization Routines</H1><P CLASS="T1.Text1"><A NAME="pgfId=3833"> </A>The Device Manager sends <TT CLASS="cv">kInitializeCommand</TT> and <TT CLASS="cv">kFinalizeCommand</TT> commands to a native driver as its first and last commands. The <TT CLASS="cv">kInitializeCommand</TT> command gives the driver startup information; the <TT CLASS="cv">kFinalizeCommand</TT> command informs the driver that the system would like to unload it. </P><P CLASS="T1.Text1"><A NAME="pgfId=3834"> </A>A typical framework for a generic driver handler for Device Manager finalization and CFM initialization and termination commands is shown in <A HREF="PCI_BOOK.c3.html#38877" CLASS="XRef">Listing&nbsp;8-3</A>.</P><P CLASS="L.Listing"><B><A NAME="pgfId=3839"> </A>Listing&nbsp;8-3	<A NAME="38877"> </A>Initialization, finalization, and termination handlers</B></P><CODE CLASS="Cv.Code"><A NAME="pgfId=17486"> </A>refNum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gMyReferenceNumber;<BR>RegEntryID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gMyDeviceID;<BR><BR>OSErr DoInitializeCommand<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( refNum myRefNum, regEntryIDPtr myDevice )<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;/* remember the refNum and Registry entry spec */<BR>&nbsp;&nbsp;&nbsp;&nbsp;gMyReferenceNumber = myRefNum;<BR>&nbsp;&nbsp;&nbsp;&nbsp;gMyDeviceID = *myDevice;<BR>&nbsp;&nbsp;&nbsp;&nbsp;return noErr;<BR>}<BR><BR>OSErr DoFinalizeCommand<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( refNum myRefNum, RegEntryIDPtr myDevice )<BR>{<BR>#pragma unused ( myRefNum , myDevice )<BR>&nbsp;&nbsp;&nbsp;&nbsp;return noErr;<BR>}<BR><BR>CFMInitialize ()<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;return noErr;<BR>}<BR><BR>CFMTerminate ()<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;return noErr;<BR>}</CODE><P CLASS="T1.Text1"><A NAME="pgfId=3845"> </A>The driver's initialization routine should perform the following functions:</P><OL><LI CLASS="N/.NList=1"><A NAME="pgfId=3846"> </A>Check the device's <TT CLASS="cv">AAPL,address</TT> property to see that needed resources have been allocated. The <TT CLASS="cv">AAPL,address</TT> property is described in <A HREF="PCI_BOOK.1ba.html#14782" CLASS="XRef">Fast I/O Space Cycle Generation</A>.</LI><LI CLASS="N.NList"><A NAME="pgfId=3853"> </A>Enable PCI memory or I/O space, or both, using the logic illustrated in <A HREF="PCI_BOOK.c3.html#10514" CLASS="XRef">Listing&nbsp;8-4</A>.</LI><P CLASS="L.Listing"><B><A NAME="pgfId=3855"> </A>Listing&nbsp;8-4	<A NAME="10514"> </A>Enabling PCI spaces</B></P><CODE CLASS="Cv.Code"><A NAME="pgfId=17492"> </A>OSErr InitPCIMemorySpace&nbsp;&nbsp;&nbsp;&nbsp;(RegEntryIDPtr &nbsp;DeviceID,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LogicalAddress&nbsp;&nbsp;addr )<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;UInt16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmdWord;<BR>&nbsp;&nbsp;&nbsp;&nbsp;OSErr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;status = ExpMgrConfigReadWord (DeviceID,addr,&amp;cmdWord );<BR>&nbsp;&nbsp;&nbsp;&nbsp;if ( status != noErr )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return status;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;cmdWord |= &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cwCommandEnableMemorySpace |<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cwCommandEnableIOSpace;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;return ExpMgrConfigWriteWord (DeviceID,addr,cmdWord );<BR>}</CODE><LI CLASS="N.NList"><A NAME="pgfId=3863"> </A>Probe the device to verify the driver's match to it, as illustrated in <A HREF="PCI_BOOK.c3.html#19673" CLASS="XRef">Listing&nbsp;8-5</A>.</LI><P CLASS="L.Listing"><B><A NAME="pgfId=3865"> </A>Listing&nbsp;8-5	<A NAME="19673"> </A>Device probing</B></P><CODE CLASS="Cv.Code"><A NAME="pgfId=17498"> </A>OSErr ProbePCIMemorySpace ( LogicalAddress addr )<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;UInt8&nbsp;&nbsp;&nbsp;ctest3;<BR>&nbsp;&nbsp;&nbsp;&nbsp;OSErr&nbsp;&nbsp;&nbsp;status;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status = DeviceProbe(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(void *) (((UInt32)addr) + CTEST3),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;ctest3,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;k8BitAccess<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<BR>&nbsp;&nbsp;&nbsp;&nbsp;if ( status != noErr )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return status;<BR>}</CODE></ol><P CLASS="T1.Text1"><A NAME="pgfId=3868"> </A>The initialization code should also allocate any private storage the driver requires and place a pointer to it in its global variables. After allocating memory, the initialization routine should perform any other preparation required by the driver. If the handler fails to allocate memory for private storage, it should return an appropriate error code to notify the Device Manager that the driver did not initialize itself.</P><P CLASS="T1.Text1"><A NAME="pgfId=3869"> </A>If the Open Firmware FCode in the device's expansion ROM does not furnish either a <TT CLASS="cv">&quot;driver,AAPL,MacOS,PowerPC&quot;</TT> property or a unique <TT CLASS="cv">name</TT> property, or if the driver's PCI <TT CLASS="cv">vendor-id</TT> and <TT CLASS="cv">device-id</TT> properties are generic, then the initialization routine must always check that the device is the correct one for the driver. If the driver has been incorrectly matched, the initialization routine must return an error code so the Device Manager can attempt to make a match. Driver matching is discussed in <A HREF="PCI_BOOK.89.html#28331" CLASS="XRef">Matching Drivers With Devices</A>. PCI <TT CLASS="cv">vendor-id</TT> and <TT CLASS="cv">device-id</TT> properties are discussed in <A HREF="PCI_BOOK.86.html#33027" CLASS="XRef">Finding, Initializing, and Replacing Drivers</A></P><P CLASS="T1.Text1"><A NAME="pgfId=3876"> </A>The driver's finalization routine must reverse the effects of the initialization routine by releasing any memory allocated by the driver, removing interrupt handlers, and canceling outstanding timers. If the finalization routine cannot complete the finalization request, it can return an error result code. In any event, however, the driver will be removed.</P><P CLASS="T1.Text1"><A NAME="pgfId=3877"> </A>If the initialization routine needs to install an interrupt handler, see the discussion in <A HREF="PCI_BOOK.16b.html#32981" CLASS="XRef">Interrupt Management</A>.</P><P CLASS="T1.Text1"><A NAME="pgfId=3881"> </A>Initialization, finalization, and termination calls are always immediate.</P><HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 26 March 99)<P><A HREF="PCI_BOOK.c2.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.c2.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.c4.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>