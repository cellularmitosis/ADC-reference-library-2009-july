<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-05-01 --><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1111: Programmatic Mounting of AppleShare Volumes</title>       <meta name="keywords" content="Mac OS 8 AppleShare volumes mounted programmatically PBVolumeMount AFPXVolMountInfo UAMs">    <meta name="Description" content="Technical Note TN1111: This Technical Note shows how to mountan AppleShare                                     volumeusing the PBVolumeMount call. The AFPVolMountInfo structureis defined along with the AFPXVolMountInfo structure in thisNote. Use of custom UAMs and tagged data for addresses isalso discussed."><meta name="categories" content="Files"><meta name="week-posted" content="Sep 29, 1997 - Oct 3, 1997"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002951" title="Programmatic Mounting of AppleShare Volumes"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/Carbon/index.html">Carbon</a> &gt; <a href="../../technicalnotes/Carbon/idxFileManagement-date.html">File Management</a> &gt; </p><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1111</div>
<div id="pageheadsub">Programmatic Mounting of AppleShare Volumes</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><center><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left">          <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                        <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left><!-- begin_toc --><p id="menutext"><A HREF = "#Section1">Introduction</A><BR><BR><A HREF = "#Section2">AppleShare Clients 3.0 - 3.6.5</A><BR><BR><A HREF = "#Section3">AppleShare Client 3.7</A><BR><BR><A HREF = "#Summary">Summary</A><br><BR><A HREF="#References">References</a><BR><BR><A HREF="#Downloads">Downloadables</A></p>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left>            			<!-- begin_intro_text -->         <p id="introtext">This Technote shows how to mount          an AppleShare volume using the <CODE>PBVolumeMount</CODE> call.      </P>      <BR><BR><!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Feb 06 1998]</h3><!-- end_date -->        </td>    </tr></table> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR>          <!-- begin_content -->         <A NAME="Section1"></A>                  <H2>Introduction</H2><BR>                  <P>The AppleShare Client implements the <CODE>PBVolumeMount</CODE> trap to allowdevelopers to mount volumes programmatically. There are two ways touse the <CODE>PBVolumeMount</CODE> call to mount volumes. There is newfunctionality added to the <CODE>PBVolumeMount</CODE> call by AppleShare Client3.7 that allows for mounting servers over TCP/IP as well asAppleTalk.</P><P>The first method is best used when you are remounting a volumethat has been mounted by the user. Identify the volume that you wishto remount and call <CODE>GetVolMountInfoSize</CODE> to get the size of the <CODE>VolMount Block</CODE> that you will need to allocate. Allocate the memory forthe <CODE>Vol Mount Block</CODE> and call <CODE>GetVolMountInfo</CODE> to get the block filledin. When you wish to remount the volume call <CODE>PBVolumeMount</CODE> with the<CODE>Vol Mount Block</CODE> created earlier. You will need to store the passwordseparately as <CODE>GetVolMountInfo</CODE> will not return password information.The Alias manager uses this method to mount server volumes fromaliases.</P><P>The second method entails creating your own <CODE>Vol Mount Block</CODE>,filling in the fields yourself and calling <CODE>PBVolumeMount</CODE>. This methodgives great flexibility but is rather complex. I advise looking atthe code in the MoreFiles Sample Code. (see the<A HREF = "#References">References</A> section)</P><P><B>Snippet #1: Finding the version of the AppleShareClient</B></P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>const   short   kASver_3_5      = 1;const   short   kASver_3_6      = 2;const   short   kASver_3_6_1    = 3;const   short   kASver_3_6_2    = 4;const   short   kASver_3_6_3    = 5;    // incld. 3.6.3, 3.6.4, 3.6.5const   short   kASver_3_7      = 6;    // incld. 3.7.1const   short   kASver_3_7_2    = 7;&nbsp;short   ClientVersion(void){    long    result;    OSError theError = noErr;    theError = Gestalt('afps',&amp;result);    if(!theError)    {        return(result &amp; 0x0000ffff);    }    return 0;}</pre></TD></TR></TABLE></CENTER><BR><BR><BR><P><A HREF="#top">Back to top</A></P>         <A NAME="Section2"></A>                  <H2>AppleShare Clients 3.0 - 3.6.5</H2>         <P>AppleShare clients prior to version 3.7 mount volumes overAppleTalk only. The <A HREF = "#References">More Files</A> sample codehas a good example of using the <CODE>PBVolumeMount()</CODE> call to mount avolume given a server name and password. For maximum compatibilityset the <CODE>UAMType</CODE> field of the <CODE>AFPVolMountInfo</CODE> struct to 1 forguest login or 3 for login using a password.</P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>struct AFPVolMountInfo {    short       length;               /* length of location data (including self) */    VolumeType  media;                /* type of media                            */    short       flags;                /* bits for no messages, no reconnect       */    SInt8       nbpInterval;          /* NBP Interval parameter (IM2, p.322)      */    SInt8       nbpCount;             /* NBP Interval parameter (IM2, p.322)      */    short       uamType;              /* User Authentication Method               */    short       zoneNameOffset;       /* short positive offset from start of                                         struct to Zone Name */    short       serverNameOffset;     /* offset to pascal Server Name string      */    short       volNameOffset;        /* offset to pascal Volume Name string      */    short       userNameOffset;       /* offset to pascal User Name string        */    short       userPasswordOffset;   /* offset to pascal User Password string    */    short       volPasswordOffset;    /* offset to pascal Volume Password string  */    char        AFPData[176];         /* variable length data may follow      */};typedef struct AFPVolMountInfo AFPVolMountInfo;</pre></TD></TR></TABLE></CENTER><BR><BR><BR><P><A HREF="#top">Back to top</A></P>         <A NAME="Section3"></A>                  <H2>AppleShare Client 3.7</H2>                  <P>AppleShare Client 3.7 has several new features dealing with volumemounting:</P><UL>   <LI><A HREF = "#Connecting">Mounting volumes over   TCP/IP</A></li>      <LI><A HREF = "#">Option to use the AppleShare Client login and   Volume Select dialogs</A></li>      <LI><A HREF = "#Mounting">Support   for Custom User Authentication Modules (UAMs) in <CODE>PBVolumeMount</CODE></A></li></UL><P>&nbsp;</P><P><CODE>PBVolumeMount</CODE> with <CODE>AFPXVolMountInfo</CODE></P><P>As you can see, the <CODE>AFPXVolMountInfo</CODE> structure is anextension of the <CODE>AFPVolMountInfo</CODE> structure defined above.The three new fields and two new flag bits allow the developer tospecify the information needed to support TCP/IP and UAMs. The 3.7Client will also support the <CODE>old AFPVolMountInfo</CODE> struct.</P><P>From the latest <CODE>Files.h</CODE>:</P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>/* AFPXVolMountInfo is the new AFP volume mount info record,requires the 3.7 AppleShare Client */struct AFPXVolMountInfo {    short         length;                 /* length of location data (including self) */    VolumeType    media;                  /* type of media */    short         flags;                  /* bits for no messages, no reconnect */    SInt8         nbpInterval;            /* NBP Interval parameter (IM2, p.322) */    SInt8         nbpCount;               /* NBP Interval parameter (IM2, p.322) */    short         uamType;                /* User Authentication Method type */    short         zoneNameOffset;         /* short positive offset from start of struct                                             to Zone Name */    short         serverNameOffset;       /* offset to pascal Server Name string */    short         volNameOffset;          /* offset to pascal Volume Name string */    short         userNameOffset;         /* offset to pascal User Name string */    short         userPasswordOffset;     /* offset to pascal User Password string */    short         volPasswordOffset;      /* offset to pascal Volume Password string */    short         extendedFlags;          /* extended flags word */    short         uamNameOffset;          /* offset to a pascal UAM name string */    short         alternateAddressOffset; /* offset to Alternate Addresses in tagged format */    char          AFPData[176];           /* variable length data may follow */};typedef struct AFPXVolMountInfo AFPXVolMountInfo;typedef AFPXVolMountInfo *              AFPXVolMountInfoPtr;/* volume mount flags */enum {    volMountNoLoginMsgFlagBit   = 0,         /* Input to VolumeMount: If set, the file                                                system */    volMountNoLoginMsgFlagMask  = 0x0001,    /* should suppress any log-in message/greeting                                                dialog */    volMountExtendedFlagsBit    = 7,         /* Input to VolumeMount: If set, the mount                                                info is a */    volMountExtendedFlagsMask   = 0x0080,    /* AFPXVolMountInfo record for 3.7 AppleShare                                                Client */    volMountInteractBit         = 15,        /* Input to VolumeMount: If set, it's OK for                                                the file system */    volMountInteractMask        = 0x8000,    /* to perform user interaction to mount the                                                volume */    volMountChangedBit          = 14,        /* Output from VolumeMount: If set, the volume                                                was mounted, but */    volMountChangedMask         = 0x4000,    /* the volume mounting information record                                                needs to be updated. */    volMountFSReservedMask      = 0x00FF,    /* bits 0-7 are defined by each file system                                                for its own use */    volMountSysReservedMask     = 0xFF00     /* bits 8-15 are reserved for Apple system use */};enum {    kAFPExtendedFlagsAlternateAddressMask = 1  /* bit in AFPXVolMountInfo.extendedFlags                                                  that means alternateAddressOffset is used*/};</pre></TD></TR></TABLE></CENTER><BR><BR><P><img src="images/tn1111_001.gif" alt="AFPXVolMountInfo fields" width=468 height=948 border=0 align="middle"></P><P>In order to use the new features of the <CODE>PBMountVolume</CODE> trap youmust set the <CODE>extendedFlagsBit</CODE> in the <CODE>flags</CODE>word ofthe <CODE>AFPXVolMountInfo</CODE> structure, and use the new VMIBdefinition. Each of the offset fields specifies a 16 bit offset fromthe beginning of the struct to the data in question. To leave astring field empty you need to have the offset "point" to an emptystring. You cannot just leave the offset = 0.</P><P><A NAME=""></A>To have the AppleShare Client put up the logindialog, set the <CODE>volMountInteractBit</CODE> in the <CODE>flags</CODE>word. Make sure you have an A5 world and have initialized QuickDrawand the DialogManager before making this call with the bit set. Youalso must have this bit set if you are using a UAM other than thestandard Apple ones. AppleShare Client 3.7.2 and later: If you leavethe volume name blank in the <CODE>AFPXVolMountInfo</CODE> structure, theClient will put up the volume select window, allowing the user tochoose which volumes to mount.</P><P>The <CODE>uamNameOffset</CODE> offset specifies an offset to a pascal stringdenoting the User Authentication MOdule (UAM) to use for thisconnection. You must also set the <CODE>uamType</CODE> field. The UAM name stringis explained <A HREF = "#UAMName">below</A></P><P>The Alternate Address offset specifies an offset to a block oftagged data, containing IP addresses. The Block begins with a versionbyte and a count byte, followed by up to 255 tagged addresses,<A HREF = "#Tagged">see below for the format</A>.The current version byte is 0x00.</P><H4><A NAME="Connecting"></A>Connecting to an IPaddress</H4><P>To connect to a server over TCP/IP, you need to copy the IPaddress into an address tag and put the address tag into theAlternate Address field. A server name is still required, though itis not currently used. If you also specify a zone name the Clientwill fall back to AppleTalk if it cannot connect via TCP/IP, it willset the <CODE>volMountChangedBit</CODE> in the flags word if it fallsback. An example Alternate Address field for address 128.0.10.1 wouldlook like this:</P><P><CODE>0x00 0x01 0x08 0x02 0x80 0x00 0x0A 0x01 0x02 0x24</CODE></P><P>The client would use this address to connect to the default AFPover TCP/IP port 548 on the machine denoted by the address 128.0.10.1.</P><H4><A NAME="Tagged"></A>Tagged data forAddresses.</H4><P>The new tagged data format accommodates changes in addressformats, which will allow this client to support new addressingstandards such as IPv6 (IPNG) without changing the interface. Thefirst byte of the Alternate Address area is a version byte, currentlyset to 0. It is followed by an <CODE>AFPAlternateAddress</CODE> structure (definedbelow). The reason that the version byte is not included in the<CODE>AFPAlternateAddress</CODE> structure is that the <CODE>AFPAlternateAddress</CODE>structure is also used in the ServerInfo reply message in AFP 2.2.</P><P>Each Data Item consists of a length byte followed by a tagID bytefollowed by up to 254 bytes of data. ie | len&nbsp;| tag&nbsp;| up to 254 bytesof data&nbsp;|</P><BR><P>The 3.7 Client understands the following tags:</P><TABLE BORDER=0 width="500">   <TR>      <td width=30 align=left>         <P><B>Length</B></p>      </TD><td width=30 align=left>         <P><B>tagID</B></p>      </TD><td width=250 align=left>         <P><B>Description</B></p>         </TD></TR>      <TR>      <td width=30 align=left>         <P>0x06</p>      </TD><td width=30 align=left>         <P>0x01</p>      </TD><td width=250 align=left>         <P>Basic IP address; 4 bytes, no port number</p></TD></TR>   <TR>   <td width=30 align=left>         <P>0x08</p>      </TD><td width=30 align=left>         <P>0x02</p>      </TD><td width=250 align=left>         <P>IP address with Port; 4 bytes address, 2 bytes port</p></TD></TR></TABLE><BR><P>The length byte specifies the length of the whole tag, includingthe length byte. All fields are in network byte order. (MSB first)</P><P>From the latest <CODE>Files.h</CODE> (which is a part of the UniversalInterfaces &amp; Libraries v3.0.1):</P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>enum {    /* constants for use in AFPTagData.fType field*/    kAFPTagTypeIP        = 0x01,    kAFPTagTypeIPPort    = 0x02,    kAFPTagTypeDDP       = 0x03    /* Currently unused*/};&nbsp;&nbsp;&nbsp;enum {    /* constants for use in AFPTagData.fLength field*/    kAFPTagLengthIP        = 0x06,    kAFPTagLengthIPPort    = 0x08,    kAFPTagLengthDDP       = 0x06};&nbsp;struct AFPTagData {    UInt8    fLength;     /* length of this data tag including the fLength field */    UInt8    fType;    UInt8    fData[1];    /* variable length data */};typedef struct AFPTagData AFPTagData;&nbsp;struct AFPAlternateAddress {    UInt8    fAddressCount;    UInt8    fAddressList[1];    /* actually variable length packed set of AFPTagData */};typedef struct AFPAlternateAddress AFPAlternateAddress;</pre></TD></TR></TABLE></CENTER><BR><BR><BR><H4><A NAME="Mounting"></A>Mountinga Volume using a Custom UAM</H4><P>A UAM is a code resource with a single entry point that takes aselector. It lives in a file of type '<CODE>uams</CODE>'. It is used to extend theAppleShare Client, allowing it to connect to third party serversusing different authentication schemes. UAMs usually put up passwordand volume select dialogs, and thus require that the<CODE>volMountInteractBit</CODE> be set in the flags word of the<CODE>VolMountInfo</CODE> block. UAMs are stored the "AppleShare Folder" at thetop level of the System folder.</P><P>To use a Third-Party UAM for authentication, use the new VMIBdefinition (with the <CODE>extendedFlagsBit</CODE> set in the flagsword), put the UAM type from the 'uamg' id 0 resource (from the UAMfile) in the <CODE>uamType</CODE> field, and put the<A HREF = "#UAMName">UAM Name</A> into the VMIB at the<CODE>uamNameOffset.</CODE> Then call <CODE>PBVolumeMount()</CODE>.</P><P>You must make sure that you have an A5 world and have called<CODE>InitGraf</CODE> and <CODE>InitDialogs</CODE>, before making the <CODE>PBVolumeMount</CODE> call.Third-Party UAMs are currently (AppleShare Client 3.7.2 and earlier)limited to connecting over AppleTalk only.</P><H4><A NAME="UAMName"></A>UAMName</H4><P>This is the AFP protocol name for the UAM, from the 'uamn' id 1resource in the UAM file. It is a Pascal string.</P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>All structures must be 68k aligned.</P></TD></TR></TABLE></CENTER><BR><BR><BR><P><A HREF="#top">Back to top</A></P>         <A NAME="Summary"></A>                  <H2>Summary</H2>                  <P>The new <CODE>PBVolumeMount</CODE> interface gives the developer a great deal ofoptions in mounting AppleShare File Servers. <CODE>PBVolumeMount</CODE> can put uplogin and volume select dialogs. It can use custom UAMs in the samemanner as the AppleShare Client when called through the Chooser. Itcan connect to the server using AppleTalk or TCP/IP.</P><BR><P><A HREF="#top">Back to top</A></P><A NAME="References"></A><H2>References</h2>            <p><a href="http://developer.apple.com/dev/techsupport/source/SFiles.html">MoreFiles Sample Code</A></p>            <p><A HREF = "tn1106.html">Technote 1106: Borrowed AFP Sessions</A></p>            <p><A HREF = "http://appleshareip.apple.com/appleshareip/text/pdf/afp_2.2_specification.pdf">AFP 2.2 specification (41K PDF).</A></p>       <BR><P><A HREF="#top">Back to top</A></P>        <A NAME="Downloads"></A>         <br><h2>Downloadables</h2>        <center><TABLE BORDER=0 CELLPADDING=3 WIDTH="600">          <TR>             <td width=50 align=left>               <P ALIGN=center><img src="images/acrobatsmall.gif" align=middle alt="Acrobat" width=22 height=23></P>            </TD>            <td align="left">               <p>Acrobat version of this Note (260K).</P>            </TD>            <td width=60 align=left>               <p><A HREF="pdf/tn1111.pdf">Download</A></P>            </TD>          </TR>        </TABLE></center><BR><BR>        </td></tr></table></center><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1111.html%3Fid%3DDTS10002951-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1111.html%3Fid%3DDTS10002951-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1111.html%3Fid%3DDTS10002951-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>