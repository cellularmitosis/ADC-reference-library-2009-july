<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>Scriptable Print SimpleText - /Clipboard.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxPrinting-date.html">Printing</a> &gt; <A HREF="javascript:location.replace('index.html');">Scriptable Print SimpleText</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Printing/index.html" target="_blank">Reference Library > Printing</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">Scriptable Print SimpleText</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/Clipboard.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/AboutBox.c</option>
<option value="listing2.html">/AboutBox.h</option>
<option value="listing3.html">/AboutBox.r</option>
<option value="listing4.html">/aete.r</option>
<option value="listing5.html">/AGFile.h</option>
<option value="listing6.html">/Clipboard.c</option>
<option value="listing7.html">/Clipboard.h</option>
<option value="listing8.html">/Clipboard.r</option>
<option value="listing9.html">/CoercePrGeneral.h</option>
<option value="listing10.html">/ExtendPrintRecord.c</option>
<option value="listing11.html">/ExtendPrintRecord.h</option>
<option value="listing12.html">/Localize.r</option>
<option value="listing13.html">/MacIncludes.h</option>
<option value="listing14.html">/MovieFile.c</option>
<option value="listing15.html">/MovieFile.h</option>
<option value="listing16.html">/MovieFile.r</option>
<option value="listing17.html">/PICTFile.c</option>
<option value="listing18.html">/PICTFile.h</option>
<option value="listing19.html">/PICTFile.r</option>
<option value="listing20.html">/PrintAETypes.h</option>
<option value="listing21.html">/ScriptablePrinting.c</option>
<option value="listing22.html">/ScriptablePrinting.h</option>
<option value="listing23.html">/SimpleText.c</option>
<option value="listing24.html">/SimpleText.h</option>
<option value="listing25.html">/SimpleText.r</option>
<option value="listing26.html">/TextDrag.c</option>
<option value="listing27.html">/TextFile.a</option>
<option value="listing28.html">/TextFile.c</option>
<option value="listing29.html">/TextFile.h</option>
<option value="listing30.html">/TextFile.r</option>
<option value="listing31.html">/ThreeDMetafile.c</option>
<option value="listing32.html">/ThreeDMetafile.h</option>
<option value="listing33.html">/ThreeDMetafile.r</option></select>
				</p>
				</form>
				<p><strong><a href="Scriptable_Print_SimpleText.zip">Download Sample</a></strong> (&#147;Scriptable_Print_SimpleText.zip&#148;, 212.5K)<BR>
<strong><a href="Scriptable_Print_SimpleText.dmg">Download Sample</a></strong> (&#147;Scriptable_Print_SimpleText.dmg&#148;, 290.1K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/***  File:    Clipboard.c****  Contains:  Clipboard support for simple text application.****  Version:  SimpleText 1.4 or later**** Copyright 1993-1999 Apple Computer. All rights reserved.****  You may incorporate this sample code into your applications without**  restriction, though the sample code has been provided &quot;AS IS&quot; and the**  responsibility for its operation is 100% yours.  However, what you are**  not permitted to do is to redistribute the source as &quot;DSC Sample Code&quot;**  after having made changes. If you're going to re-distribute the source,**  we require that you make it clear in the source that the code was**  descended from Apple Sample Code, but that you've made changes.*/#include &quot;MacIncludes.h&quot;#include &quot;Clipboard.h&quot;// --------------------------------------------------------------------------------------------------------------// GLOBALS FOR THIS FILE ONLY// --------------------------------------------------------------------------------------------------------------static Handle      gScrapHandle;static long        gCurrentOffset;static QDProcsPtr        gSavedProcs;static QDProcs          gMyProcs;static CQDProcs          gMyColorProcs;// --------------------------------------------------------------------------------------------------------------// INTERNAL ROUTINES// --------------------------------------------------------------------------------------------------------------static pascal void GetPICTData(Ptr dataPtr, short byteCount)/*  replacement for the QuickDraw bottleneck routine*/{   long  longCount = byteCount;    BlockMoveData((*gScrapHandle)+gCurrentOffset, dataPtr, longCount);  gCurrentOffset += longCount;  } // GetPICTData#if GENERATINGCFM  static RoutineDescriptor gGetPICTDataRD = BUILD_ROUTINE_DESCRIPTOR(uppQDGetPicProcInfo, GetPICTData);  static QDGetPicUPP gGetPICTData = &amp;gGetPICTDataRD;#else  static QDGetPicUPP gGetPICTData = NewQDGetPicProc(GetPICTData);#endif// --------------------------------------------------------------------------------------------------------------static OSErr DrawPictureFromHandleAndOffset(  Rect  * pWhereToDraw,      // draw picture at this location  Handle  sourceHandle,      // handle containing data  long  sourceOffset)      // offset within handle to start at{  OSErr    anErr;  Rect    whereToDraw = *pWhereToDraw;  PicHandle  tempPict = (PicHandle) NewHandle(sizeof(Picture));    anErr = MemError();  nrequire(anErr, FailedNewHandle);      // calculate the rectangle in which to draw, save the picture header into  // our handle  {    PicPtr  pPicture;    pPicture = (PicPtr)((*sourceHandle) + sourceOffset);  whereToDraw.right = whereToDraw.left + pPicture-&gt;picFrame.right - pPicture-&gt;picFrame.left;  whereToDraw.bottom = whereToDraw.top + pPicture-&gt;picFrame.bottom - pPicture-&gt;picFrame.top;  BlockMoveData((Ptr)pPicture, (Ptr)*tempPict, sizeof(Picture));  }  // store into globals for our GetPicProc in preparation for the draw  gScrapHandle = sourceHandle;  gCurrentOffset = sourceOffset + sizeof(Picture);  // install our GetPic proc  if (gMachineInfo.theEnvirons.hasColorQD)    SetStdCProcs(&amp;gMyColorProcs);  else    SetStdProcs(&amp;gMyProcs);  gMyProcs.getPicProc = gGetPICTData;  gMyColorProcs.getPicProc = gGetPICTData;  gSavedProcs = (*qd.thePort).grafProcs;  if (gMachineInfo.theEnvirons.hasColorQD)    (*qd.thePort).grafProcs = (QDProcsPtr)&amp;gMyColorProcs;  else    (*qd.thePort).grafProcs = &amp;gMyProcs;    // Draw the picture  DrawPicture(tempPict, &amp;whereToDraw);    // remove our GetPic proc  (*qd.thePort).grafProcs = gSavedProcs;  DisposeHandle((Handle)tempPict);  // FALL THROUGH EXCEPTION HANDLINGFailedNewHandle:  return anErr;  } // DrawPictureFromHandleAndOffset// --------------------------------------------------------------------------------------------------------------// OOP INTERFACE ROUTINES// --------------------------------------------------------------------------------------------------------------static OSErr  ClipboardUpdateWindow(WindowRef pWindow, WindowDataPtr pData){#pragma unused (pData)  OSErr    anErr;  FontInfo  theInfo;  long    scrapResult;  long    offset;  ResType    validScrapType = '????';  Rect    topAreaRect;  RgnHandle  oldClip = NewRgn();    // clear out any data that was there before  GetClip(oldClip);  EraseRect(&amp;GetWindowPort(pWindow)-&gt;portRect);    // get that scrap!  anErr = LoadScrap();  nrequire(anErr, LoadScrap);    // figure out the scrap type and offset  {  short i = 0;  ResType    scrapTypes[] = {'TEXT', 'PICT', '????'};  while (scrapTypes[i] != '????')    {    scrapResult = GetScrap(nil, scrapTypes[i], &amp;offset);    if (scrapResult &gt; 0)      {      validScrapType = scrapTypes[i];      break;      }    ++i;    }  }    // setup for the drawing  TextFont(applFont);  TextSize(9);  GetFontInfo(&amp;theInfo);  // caclulate our area at the top to say what type of contents the scrap is  topAreaRect = GetWindowPort(pWindow)-&gt;portRect;  topAreaRect.bottom = topAreaRect.top + theInfo.ascent + theInfo.descent + theInfo.leading * 2 + 2;  // draw two lines under the area to separate it from the rest of the window  MoveTo(topAreaRect.left, topAreaRect.bottom - 2);  Line(topAreaRect.right - topAreaRect.left, 0);  Move(0, 2);  Line(-(topAreaRect.right - topAreaRect.left), 0);  // draw a string describing the contents  {  Str255  theString;    switch (validScrapType)    {    case 'PICT':      GetIndString(theString, kClipboardStrings, iClipboardPICT);      break;          case 'TEXT':      GetIndString(theString, kClipboardStrings, iClipboardText);      break;          default:      if (InfoScrap()-&gt;scrapCount == 0)        GetIndString(theString, kClipboardStrings, iClipboardNone);      else        GetIndString(theString, kClipboardStrings, iClipboardUnknown);      break;    }      MoveTo(topAreaRect.left + 4, topAreaRect.bottom - 4);  DrawString(theString);  }    // calculate the part *not* in our top area    topAreaRect.top = topAreaRect.bottom+1;  topAreaRect.bottom = GetWindowPort(pWindow)-&gt;portRect.bottom;  // remember the scrap count -- if it changes, we do an update!  ((ClipboardDataPtr)pData)-&gt;scrapCount = InfoScrap()-&gt;scrapCount;  // now, draw the contents, if we have a legal type to use  {  Rect  clipArea = topAreaRect;  Handle  scrapHandle = InfoScrap()-&gt;scrapHandle;    clipArea.right -= 15;  clipArea.bottom -= 15;  ClipRect(&amp;clipArea);  switch (validScrapType)    {    case 'PICT':      DrawPictureFromHandleAndOffset(&amp;clipArea,           scrapHandle, offset);      break;          case 'TEXT':      {      char  oldState;                oldState = HGetState(scrapHandle);      HLock(scrapHandle);      clipArea.right -= 15;      clipArea.bottom -= 15;      TETextBox(*scrapHandle+offset, scrapResult, &amp;clipArea, teJustLeft);      }      break;    }  }    // finally draw the grow icon, but omit our top area rect from the drawing  ClipRect(&amp;topAreaRect);  DrawGrowIcon(pWindow);    SetClip(oldClip);  DisposeRgn(oldClip);    UnloadScrap();  // FALL THROUGH EXCEPTION HANDLINGLoadScrap:  return anErr;  } // ClipboardUpdateWindow// --------------------------------------------------------------------------------------------------------------static Boolean  ClipboardFilterEvent(WindowRef pWindow, WindowDataPtr pData, EventRecord *pEvent){    // Force an update on scrap changes during activate/deactivate.  switch (pEvent-&gt;what)    {    case nullEvent:    case activateEvt:      if (LoadScrap() == noErr)        {        PScrapStuff pScrap = InfoScrap();                if (pScrap-&gt;scrapCount != ((ClipboardDataPtr)pData)-&gt;scrapCount)          {          GrafPtr  pPort = (GrafPtr)GetWindowPort(pWindow);                    SetPort(pPort);          InvalRect(&amp;pPort-&gt;portRect);          }        }      break;        // Follow the HI guidelines and hide the clipboard when we are suspended.      case osEvt:      if (((pEvent-&gt;message &gt;&gt; 24) &amp; 0x0FF) == suspendResumeMessage)        {        if((pEvent-&gt;message &amp; resumeFlag)==0)  // suspending          {          HideWindow(pWindow);          pWindow = FrontWindow();          if (pWindow)            HiliteWindow(pWindow, false);          }        else                  // resuming          ShowWindow(pWindow);        }      break;          } // switch(what)    return false;  } // ClipboardFilterEvent// --------------------------------------------------------------------------------------------------------------static OSErr  ClipboardKeyEvent(WindowRef pWindow, WindowDataPtr pData, EventRecord *pEvent, Boolean isMotionKey){    #pragma unused(pWindow, pData, pEvent, isMotionKey)  return noErr;} // ClipboardKeyEvent// --------------------------------------------------------------------------------------------------------------static OSErr  ClipboardGetBalloon(WindowRef pWindow, WindowDataPtr pData,     Point *localMouse, short * returnedBalloonIndex, Rect *returnedRectangle){#pragma unused (pWindow, pData, localMouse, returnedRectangle)  *returnedBalloonIndex = iNoBalloon;    return noErr;} // ClipboardGetBalloon// --------------------------------------------------------------------------------------------------------------static OSErr  ClipboardGetDocumentRect(WindowRef pWindow, WindowDataPtr pData,       LongRect * documentRectangle, Boolean forGrow){#pragma unused (pWindow, pData, forGrow)    Rect  maxSize = (**GetGrayRgn()).rgnBBox;    RectToLongRect(&amp;maxSize, documentRectangle);    return noErr;  } // ClipboardGetDocumentRect// --------------------------------------------------------------------------------------------------------------static OSErr  ClipboardCloseWindow(WindowRef pWindow, void* refCon){  #pragma unused(pWindow,refCon)  ChangeCommandName(cShowClipboard, kClipboardStrings, iClipboardShow);  UnloadScrap();    return noErr;} // ClipboardCloseWindow// --------------------------------------------------------------------------------------------------------------static OSErr  ClipboardMakeWindow(WindowRef pWindow, WindowDataPtr pData){#pragma unused (pWindow)  pData-&gt;hasGrow         = true;  pData-&gt;pFilterEvent     = (FilterEventProc)   ClipboardFilterEvent;  pData-&gt;pKeyEvent      = (KeyEventProc)     ClipboardKeyEvent;  pData-&gt;pGetBalloon      = (GetBalloonProc)     ClipboardGetBalloon;  pData-&gt;pUpdateWindow     = (UpdateWindowProc)   ClipboardUpdateWindow;  pData-&gt;pGetDocumentRect   = (GetDocumentRectProc) ClipboardGetDocumentRect;  pData-&gt;pCloseWindow      = (CloseWindowProc)    ClipboardCloseWindow;    pData-&gt;contentRect.right = pData-&gt;contentRect.left +           qd.screenBits.bounds.right - qd.screenBits.bounds.left - 96;  pData-&gt;contentRect.bottom = pData-&gt;contentRect.top + 150;  MoveWindow(pWindow,       qd.screenBits.bounds.left + 4,       qd.screenBits.bounds.bottom - 154, false);    ChangeCommandName(cShowClipboard, kClipboardStrings, iClipboardHide);  return noErr;  } // ClipboardMakeWindow// --------------------------------------------------------------------------------------------------------------OSErr  ClipboardPreflightWindow(PreflightPtr pPreflightData){    pPreflightData-&gt;resourceID      = kClipboardWindowID;  pPreflightData-&gt;continueWithOpen   = true;  pPreflightData-&gt;makeProcPtr     = ClipboardMakeWindow;  pPreflightData-&gt;storageSize     = sizeof(ClipboardDataRecord);    return noErr;  } // ClipboardPreflightWindow// --------------------------------------------------------------------------------------------------------------void ClipboardGetFileTypes(OSType * pFileTypes, OSType * pDocumentTypes, short * numTypes){#pragma unused (pFileTypes, pDocumentTypes, numTypes)} // ClipboardGetFileTypes</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/Scriptable_Print_SimpleText/listing6.html%3Fid%3DDTS10000305-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/Scriptable_Print_SimpleText/listing6.html%3Fid%3DDTS10000305-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/Scriptable_Print_SimpleText/listing6.html%3Fid%3DDTS10000305-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>