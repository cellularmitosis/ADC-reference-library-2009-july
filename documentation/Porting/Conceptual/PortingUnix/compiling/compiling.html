<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Porting UNIX/Linux Applications to Mac OS X: Compiling Your Code in Mac OS X</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Compiling Your Code in Mac OS X"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP40002850" title="Compiling Your Code in Mac OS X"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../../Darwin/index.html#//apple_ref/doc/uid/TP30000440-TP30000422" target="_top">Darwin</a> &gt; <a href="../../../../Darwin/Porting-date.html#//apple_ref/doc/uid/TP30000440-TP30000422-TP30000553" target="_top">Porting</a> &gt; <a href="../intro/intro.html#//apple_ref/doc/uid/TP40002847-TPXREF101">Porting UNIX/Linux Applications to Mac OS X</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../preparing/preparing.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../environments/environments.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP40002850-TPXREF101" title="Compiling Your Code in Mac OS X"></a><h1>Compiling Your Code in Mac OS X</h1><p>Now that you have the basic pieces in place, it is time to build your application. This section covers some of the more common issues that you may encounter in bringing your UNIX application to Mac OS X. These issues apply largely without regard to what type of development you are doing.</p>
<!-- This template is being used for both PDF and HTML. -->

    
    <h4>In this section:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="compiling.html#//apple_ref/doc/uid/TP40002850-TPXREF117">Using GNU Autoconf, Automake, and Autoheader</a>
				
			<br/>
			
        
			
			
				<a href="compiling.html#//apple_ref/doc/uid/TP40002850-BAJCFEBA">Compiling for Multiple CPU Architectures</a>
				
			<br/>
			
        
			
			
				<a href="compiling.html#//apple_ref/doc/uid/TP40002850-SW3">Conditional Compilation on Mac OS X</a>
				
			<br/>
			
        
			
			
				<a href="compiling.html#//apple_ref/doc/uid/TP40002850-BCIGGEEA">Choosing a Default Compiler</a>
				
			<br/>
			
        
			
			
				<a href="compiling.html#//apple_ref/doc/uid/TP40002850-TPXREF116">Setting Compiler Flags</a>
				
			<br/>
			
        
			
			
				<a href="compiling.html#//apple_ref/doc/uid/TP40002850-BCIHJBBF">Understanding Two-Level Namespaces</a>
				
			<br/>
			
        
			
			
				<a href="compiling.html#//apple_ref/doc/uid/TP40002850-TPXREF102">Executable Format</a>
				
			<br/>
			
        
			
			
				<a href="compiling.html#//apple_ref/doc/uid/TP40002850-TPXREF103">Dynamic Libraries and Plug-ins</a>
				
			<br/>
			
        
			
			
				<a href="compiling.html#//apple_ref/doc/uid/TP40002850-TPXREF108">Bundles</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP40002850-TPXREF117" title="Using GNU Autoconf, Automake, and Autoheader"></a><h2>Using GNU Autoconf, Automake, and Autoheader</h2><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_91"></a><p>If you are bringing a preexisting command-line utility to Mac OS X that uses GNU <code><a href="../../../../Darwin/Reference/ManPages/man1/autoconf.1.html#//apple_ref/doc/man/1/autoconf" target="_top">autoconf</a></code>, <code><a href="../../../../Darwin/Reference/ManPages/man1/automake.1.html#//apple_ref/doc/man/1/automake" target="_top">automake</a></code>, or <code><a href="../../../../Darwin/Reference/ManPages/man1/autoheader.1.html#//apple_ref/doc/man/1/autoheader" target="_top">autoheader</a></code>, you will probably find that it configures itself without modification (though the resulting configuration may be insufficient). Just run <code>configure</code> and <code>make</code> as you would on any other UNIX-based system.</p><p>If running the <code>configure</code> script fails because it doesn’t understand the architecture, try replacing the project’s <code>config.sub</code> and <code>config.guess</code> files with those available in <code>/usr/share/automake-1.6</code>. If you are distributing applications that use autoconf, you should include an up-to-date version of <code>config.sub</code> and <code>config.guess</code> so that Mac OS X users don’t have to do anything extra to build your project.</p><p>If that still fails, you may need to run <code>/usr/bin/autoconf</code> on your project to rebuild the <code>configure</code> script before it works. Mac OS X includes autoconf in the BSD tools package. Beyond these basics, if the project does not build, you may need to modify your makefile using some of the tips provided in the following sections. After you do that, more extensive refactoring may be required.<a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_92"></a></p><p>Some programs may use autoconf macros that are not supported by the version of autoconf that shipped with Mac OS X. Because autoconf changes periodically, you may actually need to get a new version of autoconf if you need to build the very latest sources for some projects. In general, most projects include a prebuilt <code>configure</code> script with releases, so this is usually not necessary unless you are building an open source project using sources obtained from CVS or from a daily source snapshot.</p><p>However, if you find it necessary to upgrade autoconf, you can get a current version from <span class="content_text"><a href="http://www.gnu.org/software/autoconf/" target="_blank">http://www.gnu.org/software/autoconf/</a></span>. Note that autoconf, by default, installs in <code>/usr/local/</code>, so you may need to modify your <code>PATH</code> environment variable to use the newly updated version. Do <em>not</em> attempt to replace the version installed in <code>/usr/</code>.</p><p>For additional information about using the GNU autotoolset, see <span class="content_text"><a href="http://autotoolset.sourceforge.net/tutorial.html" target="_blank">http://autotoolset.sourceforge.net/tutorial.html</a></span> and the manual pages <code><a href="../../../../Darwin/Reference/ManPages/man1/autoconf.1.html#//apple_ref/doc/man/1/autoconf" target="_top">autoconf</a></code>, <code><a href="../../../../Darwin/Reference/ManPages/man1/automake.1.html#//apple_ref/doc/man/1/automake" target="_top">automake</a></code>, and <code><a href="../../../../Darwin/Reference/ManPages/man1/autoheader.1.html#//apple_ref/doc/man/1/autoheader" target="_top">autoheader</a></code>.</p><a name="//apple_ref/doc/uid/TP40002850-BAJCFEBA" title="Compiling for Multiple CPU Architectures"></a><h2>Compiling for Multiple CPU Architectures</h2><p>Because the Macintosh platform includes more than one processor family, it is often important to compile software for multiple processor architectures. For example, libraries should generally be compiled as universal binaries even if you are exclusively targeting an Intel-based Macintosh computer, as your library may be used by a PowerPC binary running under Rosetta. For executables, if you plan to distribute compiled versions, you should generally create universal binaries for convenience.</p><p>When compiling programs for architectures other than your default host architecture, such as compiling for a ppc64 or Intel-based Macintosh target on a PowerPC-based build host, there are a few common problems that you may run into. Most of these problems result from one of the following mistakes:</p><ul class="ul"><li class="li"><p>Assuming that the build host is architecturally similar to the target architecture and will thus be capable of executing intermediate build products</p></li><li class="li"><p>Trying to determine target-processor-specific information at configuration time (by compiling and executing small code snippets) rather than at compile time (using macro tests) or execution time (for example, by using conditional byte swap functions)</p></li></ul><p>Whenever cross-compiling occurs, extra care must be taken to ensure that the target architecture is detected correctly. This is particularly an issue when generating a binary containing object code for more than one architecture.</p><p>In many cases, binaries containing object code for more than one architecture can be generated simply by running the normal configuration script, then overriding the architecture flags at compile time.</p><p>For example, you might run</p><div class="codesample"><table><tr><td scope="row"><pre>./configure<span></span></pre></td></tr></table></div><p>followed by</p><div class="codesample"><table><tr><td scope="row"><pre>make CFLAGS="-isysroot /Developer/SDKs/MacOSX10.4u.sdk -arch ppc \<span></span></pre></td></tr><tr><td scope="row"><pre>    -arch i386" LDFLAGS="-syslibroot /Developer/SDKs/MacOSX10.4u.sdk \<span></span></pre></td></tr><tr><td scope="row"><pre>    -arch ppc -arch i386 -arch ppc -arch i386"<span></span></pre></td></tr></table></div><p>to generate a universal binary (for Intel-based and PowerPC-based Macintosh computers). To generate a 4-way universal binary that includes 64-bit versions, you would add <code>-arch ppc64</code> and <code>-arch x86_64</code> to the <code>CFLAGS</code> and <code>LDFLAGS</code>.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_4" title="Note"></a><p><strong>Note:</strong>&nbsp;If you are using an older version of gcc and your makefile passes <code>LDFLAGS</code> to gcc instead of passing them directly to ld, you may need to specify the linker flags as <code>-Wl,-syslibroot,/Developer/SDKs/MacOSX10.4u.sdk</code>. This tells the compiler to pass the unknown flags to the linker without interpreting them. Do not pass the <code>LDFLAGS</code> in this form to ld, however; ld does not currently support the <code>-Wl</code> syntax.</p>If you need to support an older version of gcc and your makefile passes <code>LDFLAGS</code> to both gcc and ld, you may need to modify it to pass this argument in different forms, depending on which tool is being used. Fortunately, these cases are rare; most makefiles either pass <code>LDFLAGS</code> to gcc or ld, but not both. Newer versions of gcc support -<code>syslibroot</code> directly.</p>If your makefile does not explicitly pass the contents of <code>LDFLAGS</code> to <code>gcc</code> or <code>ld</code>, they may still be passed to one or the other by a make rule. If you are using the standard built-in make rules, the contents of <code>LDFLAGS</code> are passed directly to <code>ld</code>. If in doubt, assume that it is passed to <code>ld</code>. If you get an invalid flag error, you guessed incorrectly.</p>If your makefile uses gcc to run the linker instead of invoking it directly, you <em>must</em> specify a list of target architectures to link when working with universal binary object (.o) files even if you are not using all of the architectures of the object file. If you don't, you will not create a universal binary, and you may also get a linker error. For more information about 64-bit executables, see <em><a href="../../../../Darwin/Conceptual/64bitPorting/index.html#//apple_ref/doc/uid/TP40001064" target="_top">64-Bit Transition Guide</a></em>.</p></div><p>However, applications that make configuration-time decisions about the size of data structures will generally fail to build correctly in such an environment (since those sizes may need to be different depending on whether the compiler is executing a <code>ppc</code> pass, a <code>ppc64</code> pass, or an <code>i386</code> pass). When this happens, the tool must be configured and compiled for each architecture as separate executables, then glued together manually using <code><a href="../../../../Darwin/Reference/ManPages/man1/lipo.1.html#//apple_ref/doc/man/1/lipo" target="_top">lipo</a></code>.</p><p>In rare cases, software not written with cross-compilation in mind will make configure-time decisions by executing code on the build host. In these cases, you will have to manually alter either the configuration scripts or the resulting headers to be appropriate for the actual target architecture (rather than the build architecture). In some cases, this can be solved by telling the configure script that you are cross-compiling using the <code>--host</code>, <code>--build</code>, and <code>--target</code> flags. However, this may simply result in defaults for the target platform being inserted, which doesn’t really solve the problem.</p><p>The best fix is to replace configure-time detection of endianness, data type sizes, and so on with compile-time or run-time detection. For example, instead of testing the architecture for endianness to obtain consistent byte order in a file, you should do one of the following:</p><ul class="ul"><li class="li"><p>Use C preprocessor macros like <code>__BIG_ENDIAN__</code> and <code>__LITTLE_ENDIAN__</code> to test endianness at compile time.</p></li><li class="li"><p>Use functions like <code><!--a-->htonl<!--/a--></code>, <code><!--a-->htons<!--/a--></code>, <code><!--a-->ntohl<!--/a--></code>, and <code><!--a-->ntohs<!--/a--></code> to guarantee a big-endian representation on any architecture.</p></li><li class="li"><p>Extract individual bytes by bitwise masking and shifting (for example, <code>lowbyte=word &amp; 0xff; nextbyte = (word >> 8) &amp; 0xff;</code> and so on).</p></li></ul><p>Similarly, instead of performing elaborate tests to determine whether to use <code>int</code> or <code>long</code> for a 4-byte piece of data, you should simply use a standard sized type such as <code>uint32_t</code>.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_5" title="Note"></a><p><strong>Note:</strong>&nbsp;Not all script execution is incompatible with cross-compiling. A number of open source tools (GTK, for example) use script execution to determine the presence or absence of libraries, determine their versions and locations, and so on.</p>In those cases, you must be certain that the info script associated with the universal binary installation (or the target platform installation if you are strictly cross-compiling) is the one that executes during the configuration process, rather than the info script associated with an installation specific to your host architecture.</p></div><p>There are a few other caveats when working with universal binaries:</p><ul class="ul"><li class="li"><p>The library archive utility, <code><a href="../../../../Darwin/Reference/ManPages/man1/ar.1.html#//apple_ref/doc/man/1/ar" target="_top">ar</a></code>, cannot work with libraries containing code for more than one architecture (or single-architecture libraries generated with <code><a href="../../../../Darwin/Reference/ManPages/man1/lipo.1.html#//apple_ref/doc/man/1/lipo" target="_top">lipo</a></code>) after ranlib has added a table of contents to them. Thus, if you need to add additional object files to a library, you must keep a separate copy without a TOC.</p></li><li class="li"><p>The <code>-M</code> switch to gcc (to output dependency information) is not supported when multiple architectures are specified on the command line. Depending on your makefile, this may require substantial changes to your makefile rules. For autoconf-based configure scripts, the flag <code>--disable-dependency-tracking</code> should solve this problem.</p><p>For projects using automake, it may be necessary to run automake with the <code>-i</code> flag to disable dependency checks or put <code>no-dependencies</code> in the <code>AUTOMAKE_OPTIONS</code> variable in each Makefile.am file.</p></li><li class="li"><p>If you run into problems building a universal binary for an open source tool, the first thing you should do is to get the latest version of the source code. This does two things:</p><ul class="nested"><li class="nested li"><p>Ensures that the version of autoconf and automake used to generate the configuration scripts is reasonably current, reducing the likelihood of build failures, execution failures, backwards or forwards compatibility problems, and other idiosyncratic or downright broken behavior.</p></li><li class="nested li"><p>Reduces the likelihood of building a version of an open source tool that contains known security holes or other serious bugs.</p></li></ul></li><li class="li"><p>Older versions of autoconf do not handle the case where <code>--target</code>, <code>--host</code>, and <code>--build</code> are not handled gracefully. Different versions also behave differently when you specify only one or two of these flags. Thus, you should always specify all three of these options if you are running an autoconf-generated configure script with intent to cross-compile.</p></li><li class="li"><p>Some earlier versions of autoconf handle cross-compiling poorly. If your tool contains a configure script generated by an early autoconf, you may be able to significantly improve things by replacing some of the <code>config.*</code> files (and <code>config.guess</code> in particular) with updated copies from the version of autoconf that comes with Mac OS X.</p><p>This will not always work, however, in which case it may be necessary to actually regenerate the configure script by running autoconf. To do this, simply change into the root directory of the project and run <code>/usr/bin/autoconf</code>. It will automatically detect and use the <code>configure.in</code> file and use it to generate a new configure script. If you get warnings, you should first try a web search for the error message, as someone else may have already run into the problem (possibly on a different tool) and found a solution.</p><p>If you get errors about missing <code>AC_</code> macros, you may need to download a copy of libraries on which your tool depends and copy their <code>.m4</code> autoconf configuration files into <code>/usr/share/autoconf</code>. Alternately, you can add the macros to the file <code>acinclude.m4</code> in your project’s main directory and autoconf should automatically pick up those macros.</p><p>You may, in some cases, need to rerun <code>automake</code> and/or <code>autoheader</code> if your tool uses them. Be prepared to run into missing <code>AM_</code> and <code>AH_</code> macros if you do, however. Because of the added risk of missing macros, this should generally only be done if running autoconf by itself does not correct a build problem.</p><div class="importantbox"><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_6" title="Important:"></a><p><strong>Important:</strong>&nbsp;Be sure to make a backup copy of the original scripts, headers, and other generated files (or, ideally, the entire project directory) before running autoheader or automake.</p><p></p></div></li><li class="li"><p>Different makefiles and configure scripts handle command-line overrides in different ways. The most consistent way to force these overrides is to specify them prior to the command. For example:</p><div class="codesample"><table><tr><td scope="row"><pre>make CFLAGS="-isysroot /Developer/SDKs/MacOSX10.4u.sdk -arch i386 -arch ppc"<span></span></pre></td></tr></table></div><p>should generally result in the above being added to <code>CFLAGS</code> during compilation. However, this behavior is not completely consistent across makefiles from different projects.</p></li></ul><p>For additional information about autoconf, automake, and autoheader, you can view the autoconf documentation at <span class="content_text"><a href="http://www.gnu.org/software/autoconf/manual/index.html" target="_blank">http://www.gnu.org/software/autoconf/manual/index.html</a></span>.</p><p>For additional information on compiler flags for Intel-based Macintosh computers, modifying code to support little-endian CPUs, and other porting concerns, you should read <em><a href="../../../../MacOSX/Conceptual/universal_binary/index.html#//apple_ref/doc/uid/TP40002217" target="_top">Universal Binary Programming Guidelines, Second Edition</a></em>, available from the ADC Reference Library.</p><a name="//apple_ref/doc/uid/TP40002850-SW2" title="Cross-Compiling a Self-Bootstrapping Tool"></a><h3>Cross-Compiling a Self-Bootstrapping Tool</h3><p>Probably the most difficult situation you may experience is that of a self-bootstrapping tool—a tool that uses a (possibly stripped-down) copy of itself to either compile the final version of itself or to construct support files or libraries. Some examples include TeX, Perl, and gcc.</p><p>Ideally, you should be able to build the executable as a universal binary in a single build pass. If that is possible, everything “just works”, since the universal binary can execute on the host. However, this is not always possible. If you have to cross-compile and glue the pieces together with <code><a href="../../../../Darwin/Reference/ManPages/man1/lipo.1.html#//apple_ref/doc/man/1/lipo" target="_top">lipo</a></code>, this obviously will not work.</p><p>If the build system is written well, the tool will bootstrap itself by building a version compiled for the host, then use that to build the pieces for the target, and finally compile a version of the binary for the target. In that case, you should not have to do anything special for the build to succeed.</p><p>In some cases, however, it is not possible to simultaneously compile for multiple architectures and the build system wasn’t designed for cross-compiling. In those cases, the recommended solution is to pre-install a version of the tool for the host architecture, then modify the build scripts to rename the target’s intermediate copy of the tool and copy the host’s copy in place of that intermediate build product (for example, <code>mv miniperl miniperl-target; cp /usr/bin/perl miniperl</code>).</p><p>By doing this, later parts of the build script will execute the version of the tool built for the host architecture. Assuming there are no architecture dependencies in the dependent tools or support files, they should build correctly using the host’s copy of the tool. Once the dependent build is complete, you should swap back in the original target copy in the final build phase. The trick is in figuring out when to have each copy in place.</p><a name="//apple_ref/doc/uid/TP40002850-SW3" title="Conditional Compilation on Mac OS X"></a><h2>Conditional Compilation on Mac OS X</h2><p>You will sometimes find it necessary to use conditional compilation to make your code behave differently depending on whether certain functionality is available.</p><p>Older code sometimes used conditional statements like <code>#ifdef __MACH__</code> or <code>#ifdef __APPLE__</code> to try to determine whether it was being compiled on Mac OS X or not. While this seems appealing as a quick way of getting ported, it ultimately causes more work in the long run. For example, if you make the assumption that a particular function does not exist in Mac OS X and conditionally replace it with your own version that implements the same functionality as a wrapper around a different API, your application may no longer compile or may be less efficient if Apple adds that function in a later version.</p><p>Apart from displaying or using the name of the OS for some reason (which you can more portably obtain from the <code><a href="../../../../Darwin/Reference/ManPages/man3/uname.3.html#//apple_ref/doc/man/3/uname" target="_top">uname(3)</a></code> API), code should never behave differently on Mac OS X merely because it is running on Mac OS X. Code should behave differently because Mac OS X behaves differently in some way—offering an additional feature, not offering functionality specific to another operating system, and so on. Thus, for maximum portability and maintainability, you should focus on that difference and make the conditional compilation dependent upon detecting the <em>difference</em> rather than dependent upon the OS itself. This not only makes it easier to maintain your code as Mac OS X evolves, but also makes it easier to port your code to other platforms that may support different but overlapping feature sets.</p><p>The most common reasons you might want to use such conditional statements are attempts to detect differences in:</p><ul class="ul"><li class="li"><p>processor architecture</p></li><li class="li"><p>byte order</p></li><li class="li"><p>file system case sensitivity</p></li><li class="li"><p>other file system properties</p></li><li class="li"><p>compiler, linker, or toolchain differences</p></li><li class="li"><p>availability of application frameworks</p></li><li class="li"><p>availability of header files</p></li><li class="li"><p>support for a function or feature</p></li></ul><p>Instead it is better to figure out <em>why</em> your code needs to behave differently in Mac OS X, then use conditional compilation techniques that are appropriate for the <em>actual</em> root cause. </p><p>The misuse of these conditionals often causes problems. For example, if you assume that certain frameworks are present if those macros are defined, you might get compile failures when building a 64-bit executable. If you instead test for the availability of the framework, you might be able to fall back on an alternative mechanism such as X11, or you might skip building the graphical portions of the application entirely.</p><p>For example, Mac OS X provides preprocessor macros to determine the CPU architecture and byte order. These include:</p><ul class="ul"><li class="li"><p><code>__i386__</code>—Intel (32-bit)</p></li><li class="li"><p><code>__x86_64__</code>—Intel (64-bit)</p></li><li class="li"><p><code>__ppc__</code>—PowerPC (32-bit)</p></li><li class="li"><p><code>__ppc64__</code>—PowerPC (64-bit)</p></li><li class="li"><p><code>__BIG_ENDIAN__</code>—Big endian CPU</p></li><li class="li"><p><code>__LITTLE_ENDIAN__</code>—Little endian CPU</p></li><li class="li"><p><code>__LP64__</code>—The LP64 (64-bit) data model</p></li></ul><p>In addition, using tools like <code>autoconf</code>, you can create arbitrary conditional compilation on nearly any practical feature of the installation, from testing to see if a file exists to seeing if you can successfully compile a piece of code.</p><p>For example, if a portion of your project requires a particular application framework, you can compile a small test program whose <code>main</code> function calls a function in that framework. If the test program compiles and links successfully, the application framework is present for the specified CPU architecture.</p><p>You can even use this technique to determine whether to include workarounds for known bugs in Apple or third-party libraries and frameworks, either by testing the versions of those frameworks or by providing a test case that reproduces the bug and checking the results.</p><p>For example, in Mac OS X, <code><a href="../../../../Darwin/Reference/ManPages/man2/poll.2.html#//apple_ref/doc/man/2/poll" target="_top">poll(2)</a></code> does not support device files such as <code>/dev/tty</code>. If you just avoid <code>poll</code> if your code is running on Mac OS X, you are making two assumptions that you should not make:</p><ul class="ul"><li class="li"><p>You are assuming that what you are doing will always be unsupported. Mac OS X is an evolving operating system that adds new features on a regular basis, so this is not necessarily a valid assumption.</p></li><li class="li"><p>You are assuming that Mac OS X is the only platform that does not support using <code>poll</code> on device files. While this is probably true for most device files, not all device files support <code>poll</code> in all operating systems, so this is also not necessarily a valid assumption.</p></li></ul><p>A better solution is to use a configuration-time test that tries to use <code>poll</code> on a device file, and if the call fails, disables the use of <code>poll</code>. If using <code>poll</code> provides some significant advantage, it may be better to perform a runtime test early in your application execution, then use <code>poll</code> only if that test succeeds. By testing for support at runtime, your application can use the <code>poll</code> API if is supported by a particular version of any operating system, falling back gracefully if it is not supported.</p><p>A good rule is to always test for the most specific thing that is guaranteed to meet your requirements. If you need a framework, test for the framework. If you need a library, test for the library. If you need a particular compiler version, test the compiler version. And so on. By doing this, you increase your chances that your application will continue to work correctly without modification in the future.</p><a name="//apple_ref/doc/uid/TP40002850-BCIGGEEA" title="Choosing a Default Compiler "></a><h2>Choosing a Default Compiler </h2><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_93"></a><p>Mac OS X ships two compilers and their corresponding toolchains. The default compiler is based on gcc 4. In addition, a compiler based on gcc 3.3 is provided. Compiling for 64-bit PowerPC and Intel-based Macintosh computers is only supported in version 4.0 and later.</p><p>Always try to compile your software using gcc 4 because future toolchains will be based on gcc version 4 or later. However, because gcc 4 is a relatively new toolchain, you may find bugs that prevent compiling certain programs.</p><p>Use of the legacy gcc 2.95.2-based toolchain is strongly discouraged unless you have to maintain compatibility with Mac OS X version 10.1.</p><a name="//apple_ref/doc/uid/TP40002850-TPXREF123" title="Using the gcc_select Command"></a><h3>Using the gcc_select Command</h3><p>If you run into a problem that looks like a compiler bug, the command <code>sudo gcc_select 3.5</code> changes the default compiler to gcc 3.5. You can change it back at any time by typing <code>sudo gcc_select 4.0</code>. Do this only as a last resort, though. If possible, you should make whatever code and compiler flag changes are needed to get gcc 4.0 to compile your application.</p><a name="//apple_ref/doc/uid/TP40002850-TPXREF116" title="Setting Compiler Flags"></a><h2>Setting Compiler Flags</h2><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_94"></a><p>When building your projects in Mac OS X, simply supplying or modifying the compiler flags of a few key options is all you need to do to port most programs. These are usually specified by either the <code>CFLAGS</code> or <code>LDFLAGS</code> variable in your makefile, depending on which part of the compiler chain interprets the flags. Unless otherwise specified, you should add these flags to <code>CFLAGS</code> if needed.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_7" title="Note"></a><p><strong>Note:</strong>&nbsp;The 64-bit toolchain in Mac OS X v10.4 and later has additional compiler flags (and a few deprecated flags). These are described in more detail in <em><a href="../../../../Darwin/Conceptual/64bitPorting/index.html#//apple_ref/doc/uid/TP40001064" target="_top">64-Bit Transition Guide</a></em>.</p></div><p>Some common flags include:</p><dl class="termdef">	<dt><code>-flat_namespace</code><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_95"></a> (in <code>LDFLAGS</code>)</dt><dd><p>Changes from a two-level to a single-level (flat) namespace. By default, Mac OS X builds libraries and applications with a two-level namespace where references to dynamic libraries are resolved to a definition in a specific dynamic library when the image is built. Use of this flag is generally discouraged, but in some cases, is unavoidable. For more information, see <span class="content_text"><a href="compiling.html#//apple_ref/doc/uid/TP40002850-BCIHJBBF">“Understanding Two-Level Namespaces.”</a></span></p></dd><dt><code>-bundle</code><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_96"></a> (in <code>LDFLAGS</code>)</dt><dd><p>Produces a Mach-O bundle format file, which is used for creating loadable plug-ins. See the <code><a href="../../../../Darwin/Reference/ManPages/man1/ld.1.html#//apple_ref/doc/man/1/ld" target="_top">ld</a></code><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_97"></a> man page for more discussion of this flag.</p></dd><dt><code>-bundle_loader</code><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_98"></a><em> executable</em> (in <code>LDFLAGS</code>)</dt><dd><p>Specifies which executable will load a plug-in. Undefined symbols in that bundle are checked against the specified executable as if it were another dynamic library, thus ensuring that the bundle will actually be loadable without missing symbols.</p></dd><dt><code>-framework</code><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_99"></a><em> framework</em> (in <code>LDFLAGS</code>)</dt><dd><p>Links the executable being built against the listed framework.<a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_100"></a> For example, you might add -framework vecLib to include support for vector math.</p></dd><dt><code>-mmacosx-version-min</code><em> version</em></dt><dd><p>Specifies the version of Mac OS X you are targeting. You must target your compile for the <em>oldest</em> version of Mac OS X on which you want to run the executable. In addition, you should install and use the cross-development SDK for that version of Mac OS X. For more information, see <em><a href="../../../../DeveloperTools/Conceptual/cross_development/index.html#//apple_ref/doc/uid/10000163i" target="_top">Cross-Development Programming Guide</a></em>.</p></dd></dl><p>More extensive discussion for the compiler in general can be found at <span class="content_text"><a href="http://developer.apple.com/releasenotes/DeveloperTools/" target="_top">http://developer.apple.com/releasenotes/DeveloperTools/</a></span>.</p><a name="//apple_ref/doc/uid/TP40002850-BCIHJBBF" title="Understanding Two-Level Namespaces"></a><h2>Understanding Two-Level Namespaces</h2><p>By default, Mac OS X builds libraries and applications with a two-level namespace. In a two-level namespace environment, when you compile a new dynamic library, any references that the library might make to other dynamic libraries are resolved to a definition in those <em>specific</em> dynamic libraries.</p><p>The two-level namespace design has many advantages for Carbon applications. However, it can cause problems for many traditional UNIX applications if they were designed to work in a flat namespace environment.</p><p>For example, suppose one library, call it <code>libfoo</code>, uses another library, <code>libbar</code>, for its implementation of the function <code><!--a-->barIt<!--/a--></code>. Now suppose an application wants to override the use of <code>libbar</code> with a compressed version, called <code>libzbar</code>. Since <code>libfoo</code> was linked against <code>libbar</code> at compile time, this is not possible without recompiling <code>libfoo</code>.</p><p>To allow the application to override references made by <code>libfoo</code> to <code>libbar</code>, you would use the flag <code>-flat_namespace</code>. The <code><a href="../../../../Darwin/Reference/ManPages/man1/ld.1.html#//apple_ref/doc/man/1/ld" target="_top">ld</a></code><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_101"></a> man page has a more detailed discussion of this flag.</p><p>If you are writing libraries from scratch, it may be worth considering the two-level namespace issue in your design. If you expect that someone may want to override your library’s use of another library, you might have an initializer routine that takes pointers to the second library as its arguments, and then use those pointers for the calls instead of calling the second library directly.</p><p>Alternately, you might use a plug-in architecture in which the calls to the outside library are made from a plug-in that could be easily replaced with a different plug-in for a different outside library. See <span class="content_text"><a href="compiling.html#//apple_ref/doc/uid/TP40002850-TPXREF103">“Dynamic Libraries and Plug-ins”</a></span> for more information.</p><p>For the most part, however, unless you are designing a library from scratch, it is not practical to avoid using <code>-flat_namespace</code> if you need to override a library’s references to another library.</p><a name="//apple_ref/doc/uid/TP40002850-TPXREF102" title="Executable Format"></a><h2>Executable Format</h2><p>The only executable format that the Mac OS X kernel understands is the Mach-O <a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_102"></a><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_103"></a>format. Some bridging tools are provided for classic Macintosh executable formats, but Mach-O is the native format. It is very different from the commonly used Executable and Linking Format (ELF<a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_104"></a>). For more information on Mach-O, see <em><a href="../../../../DeveloperTools/Conceptual/MachORuntime/index.html#//apple_ref/doc/uid/TP40000895" target="_top">Mac OS X ABI Mach-O File Format Reference</a></em>.</p><a name="//apple_ref/doc/uid/TP40002850-TPXREF103" title="Dynamic Libraries and Plug-ins"></a><h2>Dynamic Libraries and Plug-ins</h2><p>Dynamic libraries and plug-ins behave differently in Mac OS X than in other operating systems. This section explains some of those differences.</p><a name="//apple_ref/doc/uid/TP40002850-SW4" title="Using Dynamic Libraries at Link Time"></a><h3>Using Dynamic Libraries at Link Time</h3><p>When linking an executable, Mac OS X treats dynamic libraries just like libraries in any other UNIX-based or UNIX-like operating system. If you have a library called <code>libmytool.a</code>, <code>libmytool.dylib</code>, or <code>libmytool.so</code>, for example, all you have to do is this:</p><div class="codesample"><table><tr><td scope="row"><pre>ld a.o b.o c.o ... -L/path/to/lib -lmytool<span></span></pre></td></tr></table></div><p>As a general rule, you should avoid creating static libraries (<code>.a</code>) except as a temporary side product of building an application. You <em>must</em> run <code><a href="../../../../Darwin/Reference/ManPages/man1/ranlib.1.html#//apple_ref/doc/man/1/ranlib" target="_top">ranlib</a></code> on any archive file before you attempt to link against it.</p><a name="//apple_ref/doc/uid/TP40002850-SW1" title="Using Dynamic Libraries Programmatically"></a><h3>Using Dynamic Libraries Programmatically</h3><p>Mac OS X makes heavy use of dynamically linked code<a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_105"></a>. Unlike other binary formats such as ELF and xcoff, Mach-O treats plug-ins differently than it treats shared libraries.</p><p>The preferred mechanism for dynamic loading of shared code, beginning in Mac OS X v10.4 and later, is the <code><a href="../../../../Darwin/Reference/ManPages/man3/dlopen.3.html#//apple_ref/doc/man/3/dlopen" target="_top">dlopen</a></code> family of functions. These are described in the man page for <code><a href="../../../../Darwin/Reference/ManPages/man3/dlopen.3.html#//apple_ref/doc/man/3/dlopen" target="_top">dlopen</a></code>. The <code><a href="../../../../Darwin/Reference/ManPages/man1/ld.1.html#//apple_ref/doc/man/1/ld" target="_top">ld</a></code><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_106"></a> and <code><a href="../../../../Darwin/Reference/ManPages/man1/dyld.1.html#//apple_ref/doc/man/1/dyld" target="_top">dyld</a></code><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_107"></a> man pages give more specific details of the dynamic linker’s implementation.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_8" title="Note"></a><p><strong>Note:</strong>&nbsp;By default, the names of dynamic libraries in Mac OS X end in <code>.dylib</code> instead of <code>.so</code>. You should be aware of this when writing code to load shared code in Mac OS X.</p></div><p>Libraries that you are familiar with from other UNIX-based systems might not be in the same location in Mac OS X. This is because Mac OS X has a single dynamically loadable framework, <code>libSystem<a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_108"></a></code>, that contains much of the core system functionality. This single module provides the standard C runtime environment, input/output routines, math libraries, and most of the normal functionality required by command-line applications and network services.</p><p>The <code>libSystem</code> library also includes functions that you would normally expect to find in libc<a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_109"></a> and libm<a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_110"></a>, RPC<a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_111"></a> services, and a name resolver<a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_112"></a>. Because <code>libSystem</code> is automatically linked into your application, you do not need to explicitly add it to the compiler’s link line. For your convenience, many of these libraries exist as symbolic links to <code>libSystem</code>, so while explicitly linking against <code>-lm</code> (for example) is not needed, it will not cause an error.</p><p>To learn more about how to use dynamic libraries, see <em><a href="../../../../DeveloperTools/Conceptual/DynamicLibraries/index.html#//apple_ref/doc/uid/TP40001869" target="_top">Dynamic Library Programming Topics</a></em>.</p><a name="//apple_ref/doc/uid/TP40002850-SW5" title="Compiling Dynamic Libraries and Plugins"></a><h3>Compiling Dynamic Libraries and Plugins</h3><p>For the most part, you can treat dynamic libraries and plugins the same way as on any other platform if you use GNU libtool. This tool is installed in Mac OS X as <code>glibtool</code> to avoid a name conflict with NeXT libtool. For more information, see the manual page for <code><a href="../../../../Darwin/Reference/ManPages/man1/glibtool.1.html#//apple_ref/doc/man/1/glibtool" target="_top">glibtool</a></code>.</p><p>You can also create dynamic libraries and plugins manually if desired. As mentioned in <span class="content_text"><a href="compiling.html#//apple_ref/doc/uid/TP40002850-SW1">“Using Dynamic Libraries Programmatically,”</a></span> dynamic libraries and plugins are not the same thing in Mac OS X. Thus, you must pass different flags when you create them.</p><p>To create dynamic libraries in Mac OS X, pass the <code>-dynamiclib</code> flag.</p><p>To create plugins, pass the <code>-bundle</code> flag.</p><p>Because plugins can be tailored to a particular application, the Mac OS X compiler provides the ability to check these plugins for loadability at compile time. To take advantage of this feature, use the <code>-bundle_loader</code> flag. For example:</p><div class="codesample"><table><tr><td scope="row"><pre>gcc -bundle a.o b.o c.o -o mybundle.bundle \<span></span></pre></td></tr><tr><td scope="row"><pre>    -bundle_loader /Applications/MyApp.app/Contents/MacOS/MyApp<span></span></pre></td></tr></table></div><p>If the compiler finds symbol requests in the plugin that cannot be resolved in the application, you will get a link error. This means that you <code>must</code> use the <code>-l</code> flag to link against any libraries that the plugin requires as though you were building a complete executable.</p><div class="importantbox"><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_9" title="Important:"></a><p><strong>Important:</strong>&nbsp;Mac OS X does not support the concept of weak linking<a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_113"></a> as it is found in systems like Linux. If you override one symbol, you must override all of the symbols in that object file.</p><p></p></div><p>To learn more about how to create and use dynamic libraries, see <em><a href="../../../../DeveloperTools/Conceptual/DynamicLibraries/index.html#//apple_ref/doc/uid/TP40001869" target="_top">Dynamic Library Programming Topics</a></em>.</p><a name="//apple_ref/doc/uid/TP40002850-TPXREF108" title="Bundles"></a><h2>Bundles</h2><a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_114"></a><p>In the Mac OS X file system, some directories store executable code and the software resources related to that code in one discrete package. These packages, known as bundles, come in two varieties: application bundles and frameworks.</p><p>There are two basic types of bundles that you should be familiar with during the basic porting process: application bundles and frameworks. In particular, you should be aware of how to use frameworks, since you may need to link against the contents of a framework when porting your application.</p><a name="//apple_ref/doc/uid/TP40002850-BAJIFGJB" title="Application Bundles"></a><h3>Application Bundles</h3><p>Application bundles are special directories that appear in the Finder as a single entity. Having only one item allows a user to double-click it to get the application with all of its supporting resources. If you are building Mac OS X applications, you should make application bundles. Xcode builds them by default if you select one of the application project types. More information on application bundles is available in <span class="content_text"><a href="../distributing/distibuting.html#//apple_ref/doc/uid/TP40002855-BABGECFG">“Bundles vs. Installers”</a></span> and in <em><a href="../../../../MacOSX/Conceptual/OSX_Technology_Overview/index.html#//apple_ref/doc/uid/TP40001067" target="_top">Mac OS X Technology Overview</a></em>.</p><a name="//apple_ref/doc/uid/TP40002850-TPXREF113" title="Frameworks"></a><h3>Frameworks</h3><p>A framework is a type of bundle that packages a shared library with the resources that the library requires. Depending on the library, this bundle could include header files, images, and reference documentation. If you are trying to maintain cross-platform compatibility, you may not want to create your own frameworks, but you should be aware of them because you might need to link against them. For example, you might want to link against the Core Foundation framework. Since a framework is just one form of a bundle, you can do this by linking against <code>/System/Library/Frameworks/CoreFoundation.framework</code> with the <code>-framework</code> <a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_115"></a>flag. A more thorough discussion of frameworks is in <em><a href="../../../../MacOSX/Conceptual/OSX_Technology_Overview/index.html#//apple_ref/doc/uid/TP40001067" target="_top">Mac OS X Technology Overview</a></em>.<a name="//apple_ref/doc/uid/TP40002850-DontLinkElementID_116"></a></p><a name="//apple_ref/doc/uid/TP40002850-TPXREF124" title="For More Information"></a><h3>For More Information</h3><p>You can find additional information about bundles in <em><a href="../../../../MacOSX/Conceptual/OSX_Technology_Overview/index.html#//apple_ref/doc/uid/TP40001067" target="_top">Mac OS X Technology Overview</a></em> and in <span class="content_text"><a href="../../../../CoreFoundation/Conceptual/CFBundles/Tasks/creating.html#//apple_ref/doc/uid/20001122" target="_top">Creating Bundles</a></span>, available from Apple’s Technical Publications website.</p>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../preparing/preparing.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../environments/environments.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2002, 2008 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2008-04-08<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Porting/Conceptual/PortingUnix/compiling/compiling.html%3Fid%3DTP30001003-2.13&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Porting/Conceptual/PortingUnix/compiling/compiling.html%3Fid%3DTP30001003-2.13&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Porting/Conceptual/PortingUnix/compiling/compiling.html%3Fid%3DTP30001003-2.13&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>