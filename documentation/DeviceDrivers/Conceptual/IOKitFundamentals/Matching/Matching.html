<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>I/O Kit Fundamentals: Driver and Device Matching</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Driver and Device Matching"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP0000015" title="Driver and Device Matching"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../../HardwareDrivers/index.html#//apple_ref/doc/uid/TP30000440-TP40003576" target="_top">Hardware &amp; Drivers</a> &gt; <a href="../Introduction/Introduction.html#//apple_ref/doc/uid/TP0000011-CH204-TPXREF101">I/O Kit Fundamentals</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../TheRegistry/TheRegistry.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../BaseClasses/BaseClasses.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP0000015-TP9" title="Driver and Device Matching"></a><h1>Driver and Device Matching</h1><p>Before a device—or any service provider—can be used, a driver for it must be found and loaded into the kernel. The I/O Kit defines a flexible, three-phase matching process that narrows a pool of candidate drivers down to one or more drivers. The final candidate (or, if multiple candidates, the most eligible one) is then loaded and given the first opportunity to manage the device or service provider.</p><p>The matching process makes use of the matching dictionaries defined as XML key-value pairs in a driver's information property list. Each matching dictionary specifies a personality of the driver, which declares its suitability for a device or service of a particular type.</p><p>This chapter discusses driver personalities and the matching language that describes them. It then describes the matching process, which uses the information in the driver personalities to identify the most appropriate driver for a detected device. The chapter also briefly discusses the device-matching procedure that applications use for loading device interfaces. See <em><a href="../../AccessingHardware/index.html#//apple_ref/doc/uid/TP30000376" target="_top">Accessing Hardware From Applications</a></em> for the complete details.</p>
<!-- This template is being used for both PDF and HTML. -->

    
    <h4>In this section:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="Matching.html#//apple_ref/doc/uid/TP0000015-BAJEICBG">Driver Personalities and Matching Languages</a>
				
			<br/>
			
        
			
			
				<a href="Matching.html#//apple_ref/doc/uid/TP0000015-TPXREF109">Driver Matching and Loading</a>
				
			<br/>
			
        
			
			
				<a href="Matching.html#//apple_ref/doc/uid/TP0000015-TPXREF5">Device Matching</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP0000015-BAJEICBG" title="Driver Personalities and Matching Languages"></a><h2>Driver Personalities and Matching Languages</h2><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_817"></a><p>Each device driver, considered as a loadable <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_818"></a>kernel extension (KEXT), must define one or more <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_819"></a>personalities that specify the kinds of devices it can support. This information is stored in XML <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_820"></a><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_821"></a>matching dictionaries defined in the information property list (<code>Info.plist</code>) in the driver’s KEXT bundle. A dictionary in this sense is a collection of key-value pairs where the XML tags <code>&lt;key></code> and <code>&lt;/key></code> enclose the key. Immediately following the key are the tags enclosing the value; these tags indicate the data type of the value; for example, </p><p><code>&lt;integer>74562&lt;/integer></code></p><p>would define an integer value.</p><p>Each matching dictionary is itself contained within the information property list’s <code>IOKitPersonalities</code><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_822"></a> dictionary. </p><p>The dictionary values of a personality specify whether a driver is a candidate for a particular device. All values in the personality must match in order for the driver to be selected for the device; in other words, a logical AND is performed on the values. Some of the keys may take a list of space-delimited values, which are generally examined in an OR fashion. Thus you might have a “model” key for a certain PC card driver personality that takes a list of model numbers, each identifying a supported model from a specific card vendor.</p><p>The specific keys that are required depend on the family. A driver for a PCI card, for example, can define a value that is checked against the PCI vendor and device ID registers. Some families, such as the PCI family, provide fairly elaborate matching strategies. For instance, consider this key-value pair:</p><div class="codesample"><table><tr><td scope="row"><pre>&lt;key>IOPCIMatch&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;string>0x00789004&amp;0x00ffffff 0x78009004&amp;0xff00ffff&lt;/string><span></span></pre></td></tr></table></div><p>This expression, which is used to match various Adaptec SCSI cards, consists of two compound values, each of which can be a valid match. To evaluate these values, the driver family reads the 32-bit vendor and device ID is read from the PCI card and masks it with the value to the right of each ampersand. The result of that operation is then compared with the value to the left of the ampersand to determine if there is a match.</p><p><span class="content_text"><a href="Matching.html#//apple_ref/doc/uid/TP0000015-CJAJBIIB">Listing 4-1</a></span> shows a partial listing of a driver personality from the XML file for an Ethernet controller driver. </p><a name="//apple_ref/doc/uid/TP0000015-CJAJBIIB" title="Listing 4-1A partial listing of an XML personality for an Ethernet controller"></a><p class="codesample"><strong>Listing 4-1&nbsp;&nbsp;</strong>A partial listing of an XML personality for an Ethernet controller</p><div class="codesample"><table><tr><td scope="row"><pre> &lt;key>IOKitPersonalities&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>    &lt;dict><span></span></pre></td></tr><tr><td scope="row"><pre>        &lt;dict><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;!-- Each personality has a different name. --><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>Name&lt;/key>      &lt;string>PCI Matching&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;!-- ... some keys not shown ... --><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;!-- The name of the class IOKit will instantiate when probing. --><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>IOClass&lt;/key>   &lt;string>ExampleIntel82558&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;!-- IOKit matching properties<span></span></pre></td></tr><tr><td scope="row"><pre>              -- All drivers must include the IOProviderClass key, giving<span></span></pre></td></tr><tr><td scope="row"><pre>              -- the name of the nub class that they attach to. The provider<span></span></pre></td></tr><tr><td scope="row"><pre>              -- class then determines the remaining match keys. A personality<span></span></pre></td></tr><tr><td scope="row"><pre>              -- matches if all match keys do; it is possible for a driver<span></span></pre></td></tr><tr><td scope="row"><pre>              -- with multiple personalities to be instantiated more than once<span></span></pre></td></tr><tr><td scope="row"><pre>              -- if several personalities match.<span></span></pre></td></tr><tr><td scope="row"><pre>              --><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>IOProviderClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                &lt;string>IOPCIDevice&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;!-- IOPCIDevice matching uses any of four possible PCI match<span></span></pre></td></tr><tr><td scope="row"><pre>             -- criteria. This personality just uses IOPCIMatch to check the<span></span></pre></td></tr><tr><td scope="row"><pre>              -- device/vendor ID.<span></span></pre></td></tr><tr><td scope="row"><pre>              --><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>IOPCIMatch&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                &lt;string>0x12298086&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;!-- The initial match score for this personality.--><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>IOProbeScore&lt;/key>    &lt;integer>400&lt;/integer><span></span></pre></td></tr><tr><td scope="row"><pre>        &lt;/dict><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        &lt;dict><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;!-- Can have additional personalities. --><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;!-- ... (not shown) --><span></span></pre></td></tr><tr><td scope="row"><pre>        &lt;/dict><span></span></pre></td></tr><tr><td scope="row"><pre>    &lt;/dict><span></span></pre></td></tr></table></div><p>As mentioned in <span class="content_text">Listing 4-1</span> every driver must include the <code>IOProviderClass</code> key with a value that identifies the nub to which the driver attaches. In very rare cases, a driver might declare <code><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_823"></a>IOResources</code> as the value of its <code>IOProviderClass</code> key. <code>IOResouces</code> is a special nub attached to the root of the I/O Registry that makes resources, such as the BSD kernel, available throughout the system. Traditionally, drivers of virtual devices match on <code>IOResources</code> because virtual devices do not publish nubs of their own. Another example of such a driver is the HelloIOKit KEXT (described in <span class="content_text"><a href="../../../../Darwin/Conceptual/KEXTConcept/KEXTConceptIOKit/hello_iokit.html#//apple_ref/doc/uid/20002366" target="_top">Hello I/O Kit: Creating a Device Driver With Xcode</a></span>) which matches on <code>IOResources</code> because it does not control any hardware.</p><div class="importantbox"><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_63" title="Important:"></a><p><strong>Important:</strong>&nbsp;Any driver that declares <code>IOResources</code> as the value of its <code>IOProviderClass</code> key must also include in its personality the <code><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_824"></a>IOMatchCategory</code> key and a private match category value. This prevents the driver from matching exclusively on the <code>IOResources</code> nub and thereby preventing other drivers from matching on it. It also prevents the driver from having to compete with all other drivers that need to match on <code>IOResources</code>. The value of the <code>IOMatchCategory</code> property should be identical to the value of the driver's <code>IOClass</code> property, which is the driver’s class name in reverse-DNS notation with underbars instead of dots, such as <code>com_MyCompany_driver_MyDriver</code>.</p><p></p></div><p>Because a driver can contain multiple matching dictionaries, each one defining a different personality for the driver, the same driver code can be loaded for different devices. For purposes of competition, the I/O Kit treats each personality as if it were a driver. If, in any single personality, all of the properties required by the family match, the driver’s code is loaded and given a chance to run for that device. </p><p>Your driver can have more than one personality for a variety of reasons. It could be that the driver (as packaged in the KEXT) supports more than one type of device, or more commonly, multiple versions of the same type of device. Another reason might be that the driver supports similar devices, each of which is attached to the system on different buses; for example, Zip drives can be attached to USB, FireWire, SCSI, ATAPI, and other buses. Because each of these attaches to a different nub class, it has different matching values. The personalities of a driver can also range from device-generic to device-specific. The personalities of the AppleUSBAudio driver (<span class="content_text"><a href="Matching.html#//apple_ref/doc/uid/TP0000015-BAJIDIGB">Listing 4-2</a></span>) illustrate this. </p><a name="//apple_ref/doc/uid/TP0000015-BAJIDIGB" title="Listing 4-2Driver personalities for the AppleUSBAudio driver"></a><p class="codesample"><strong>Listing 4-2&nbsp;&nbsp;</strong>Driver personalities for the AppleUSBAudio driver</p><div class="codesample"><table><tr><td scope="row"><pre>    &lt;key>IOKitPersonalities&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>    &lt;dict><span></span></pre></td></tr><tr><td scope="row"><pre>        &lt;key>AppleUSBAudioControl&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>        &lt;dict><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>CFBundleIdentifier&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;string>com.apple.driver.AppleUSBAudio&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>IOClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;string>AppleUSBAudioDevice&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>IOProviderClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;string>IOUSBInterface&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>bInterfaceClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;integer>1&lt;/integer><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>bInterfaceSubClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;integer>1&lt;/integer><span></span></pre></td></tr><tr><td scope="row"><pre>        &lt;/dict><span></span></pre></td></tr><tr><td scope="row"><pre>        &lt;key>AppleUSBAudioStream&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>        &lt;dict><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>CFBundleIdentifier&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;string>com.apple.driver.AppleUSBAudio&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>IOClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;string>AppleUSBAudioDMAEngine&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>IOProviderClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;string>IOUSBInterface&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>bInterfaceClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;integer>1&lt;/integer><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>bInterfaceSubClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;integer>2&lt;/integer><span></span></pre></td></tr><tr><td scope="row"><pre>        &lt;/dict><span></span></pre></td></tr><tr><td scope="row"><pre>        &lt;key>AppleUSBTrinityAudioControl&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>        &lt;dict><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>CFBundleIdentifier&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;string>com.apple.driver.AppleUSBAudio&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>IOClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;string>AppleUSBTrinityAudioDevice&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>IOProviderClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;string>IOUSBInterface&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>bConfigurationValue&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;integer>1&lt;/integer><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>bInterfaceNumber&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;integer>0&lt;/integer><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>idProduct&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;integer>4353&lt;/integer><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>idVendor&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;integer>1452&lt;/integer><span></span></pre></td></tr><tr><td scope="row"><pre>        &lt;/dict><span></span></pre></td></tr><tr><td scope="row"><pre>    &lt;/dict><span></span></pre></td></tr></table></div><p>This matching dictionary defines three personalities: <code>AppleUSBAudioControl</code>, <code>AppleUSBAudioStream</code>, and <code>AppleUSBTrinityAudioControl</code>. In matching for a detected USB Trinity audio-control device, the <code>AppleUSBTrinityAudioControl</code> would be chosen; for any other audio-control device, the generic personality (<code>AppleUSBAudioControl</code>) would match.</p><p>One common property of personalities is the <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_825"></a>probe score. A probe score is an integer that reflects how well-suited a driver is to drive a particular device. A driver may have an initial probe-score value in its personality and it may implement a <code><!--a-->probe<!--/a--></code> function that allows it to modify this default value, based on its suitability to drive a device. As with other matching values, probe scores are specific to each family. That’s because once matching proceeds past the class-matching stage, only personalities from the same family compete.<a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_826"></a> For more information on probe scores and what a driver does in the <code><!--a-->probe<!--/a--></code> function, see <span class="content_text"><a href="Matching.html#//apple_ref/doc/uid/TP0000015-BAJFFCJB">“Device Probing”</a></span></p><a name="//apple_ref/doc/uid/TP0000015-TPXREF109" title="Driver Matching and Loading"></a><h2>Driver Matching and Loading</h2><p>At boot time and at any time devices are added or removed, the process of driver matching occurs for each detected device (or other service <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_827"></a>provider). The process dynamically locates the most suitable driver in <code>/System/Library/Extensions</code> for the device or service. </p><p>As described in <span class="content_text"><a href="../ArchitectOverview/ArchitectOverview.html#//apple_ref/doc/uid/TP0000013-BABDJBGD">“Driver Matching”</a></span> in the chapter <span class="content_text"><a href="../ArchitectOverview/ArchitectOverview.html#//apple_ref/doc/uid/TP0000013-BEHJDFCA">“Architectural Overview”</a></span> the matching process is triggered when a <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_828"></a><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_829"></a>bus controller driver scans its bus and detects a new device attached to it. For each detected device the controller driver creates a <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_830"></a>nub. The I/O Kit then initiates the matching process and obtains the values from the device to use in matching (for example, examining the PCI registers). Once a suitable driver is found for the nub, the driver is registered and loaded. That driver, in turn, may create its own nub (possibly through behavior inherited from its family), which initiates the matching process to find a suitable driver.</p><a name="//apple_ref/doc/uid/TP0000015-CJACHJAJ" title="Driver Matching"></a><h3>Driver Matching</h3><p>When a nub detects a device, the I/O Kit finds and loads a driver for the nub in three distinct phases, using a subtractive process. In each phase, drivers that are <em>not</em> considered to be likely candidates for a match are subtracted from the total pool of possible candidates until a successful candidate is found.</p><p>The <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_831"></a>matching process proceeds as follows:</p><ol class="ol"><li class="li"><p>In the <strong>class matching</strong> step, the I/O Kit narrows the list of potential drivers by eliminating any drivers of the wrong class for the <em>provider</em> service (that is, the nub). For example, all driver objects that descend from a SCSI class can be ruled out when the search is for a USB driver.<a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_832"></a></p></li><li class="li"><p>In the <strong>passive matching</strong> step, the driver’s personality (specified in a driver’s XML information property list) is examined for properties specific to the provider’s family. For example, the personality might specify a particular vendor name.<a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_833"></a></p></li><li class="li"><p>In the <strong>active matching</strong> step, the driver’s <code><!--a-->probe<!--/a--></code> function is called with reference to the nub it is being matched against. This function allows the driver to communicate with the device and verify that it can in fact drive it. The driver returns a probe score that reflects its ability to drive the device. See <span class="content_text"><a href="Matching.html#//apple_ref/doc/uid/TP0000015-BAJFFCJB">“Device Probing”</a></span> for more information.<a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_834"></a> During active matching, the I/O Kit loads and probes all candidate drivers, then sorts them in order of highest to lowest <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_835"></a>probe score. </p></li></ol><p>The I/O Kit then chooses the remaining driver with the highest probe score and starts it. If the driver successfully starts, it is added to the <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_836"></a>I/O Registry and any remaining driver candidates are discarded. If it does not start successfully, the driver with the next highest probe score is started, and so on. If more than one driver is in the pool of possible candidates, the more generic driver typically loses out to the more specific driver if both claim to be able to drive the device.<a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_837"></a></p><a name="//apple_ref/doc/uid/TP0000015-BAJFFCJB" title="Device Probing"></a><h3>Device Probing</h3><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_838"></a><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_839"></a><p>During the active matching phase, the I/O Kit requests each driver in the pool of remaining candidates to probe the device to determine if they can drive it. The I/O Kit calls a series of member functions defined in the <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_840"></a>IOService class and overridden in some cases by the driver’s class. These <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_841"></a><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_842"></a>functions, and the order in which they are called, are</p><div class="codesample"><table><tr><td scope="row"><pre>init()<span></span></pre></td></tr><tr><td scope="row"><pre>attach()<span></span></pre></td></tr><tr><td scope="row"><pre>probe()<span></span></pre></td></tr><tr><td scope="row"><pre>detach()<span></span></pre></td></tr><tr><td scope="row"><pre>free() /* if probe fails */<span></span></pre></td></tr></table></div><p>These <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_843"></a><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_844"></a><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_845"></a>functions comprise the first part of a driver’s <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_846"></a><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_847"></a>life cycle (see <span class="content_text"><a href="../BaseClasses/BaseClasses.html#//apple_ref/doc/uid/TP0000016-CCDGAAJB">“Driver Object Life Cycle”</a></span> in the chapter <span class="content_text"><a href="../BaseClasses/BaseClasses.html#//apple_ref/doc/uid/TP0000016-BAJJFCHJ">“The Base Classes”</a></span> for the full story). Note that four of these functions form complementary pairs, one nested inside the other: <code>init</code> and <code>free</code> are one pair, and <code>attach</code> and <code>detach</code> are the other.</p><p>During <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_848"></a>active matching, the code of a candidate driver is loaded and an instance of the <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_849"></a>principal class listed in the personality is created. The first function invoked is <code><!--a-->init<!--/a--></code>, which is the <code>libkern</code> equivalent of the constructor function for the class. For I/O Kit drivers, this function takes as its sole argument an OSDictionary object containing the matching properties from the selected driver personality. The driver can use this to identify what specific personality it’s been loaded for, determine what level of diagnostic output to produce, or otherwise establish basic operating parameters. I/O Kit drivers typically don’t override the <code><!--a-->init<!--/a--></code> function, performing their initialization in later stages. </p><p>However, if you do override the <code>init</code> function—or almost any other function of the driver life cycle—you must take care to do two things. The first is to invoke your superclass’s implementation of the function. When you do this depends on the function; for example, in implementing <code>init</code> you should invoke the superclass’s implementation as the first thing, and in <code>free</code> you should invoke it as the last statement of the function. The second general rule is that you should undo in the second function of a pair what you’ve done in the first function; thus, if you allocate memory for any reason in <code>init</code>, you should free that memory in <code>free</code>. </p><p>Next, the <code>attach</code> function (which is bracketed with the <code>detach</code> function) is called. The default implementation of <code>attach</code> attaches the driver to the nub through registration in the I/O Registry; the default implementation of <code>detach</code> detaches the driver from the nub. A driver can override the default implementations, but rarely needs to do so.</p><p>After <code><!--a-->attach<!--/a--></code> the <code><!--a-->probe<!--/a--></code> function is invoked. The I/O Kit always calls a driver’s <code><!--a-->probe<!--/a--></code> function if the driver’s matching dictionary passively matches the <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_850"></a>provider (the nub). A driver may choose not to implement <code>probe</code>, in which case IOService’s default implementation is invoked, which simply returns <code>this</code>. </p><p>The <code>probe</code> function takes as arguments the driver’s provider and a pointer to a probe score. The probe score is a signed 32-bit integer initialized to a value specified in the driver’s personality (or to zero if not explicitly initialized). The driver with the highest initial probe score is given the first chance to start operating the device. The purpose of the <code><!--a-->probe<!--/a--></code> function is to offer drivers an opportunity to check the hardware and to modify their default probe scores as assigned in their personalities. A driver can check device-specific registers or attempt certain operations, adjusting its probe score up or down based on how well suited it is for the device it is examining. Whatever it finds, each driver must leave the hardware in the same state it was in when <code><!--a-->probe<!--/a--></code> was invoked so the next driver can probe the hardware in its original state.<a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_851"></a><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_852"></a><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_853"></a><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_854"></a><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_855"></a><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_856"></a></p><p>A driver, in its <code><!--a-->probe<!--/a--></code> function, returns a driver object (<code>IOService *</code>) if the probe was successful and returns zero otherwise. The returned object is usually the driver itself, but the driver can return another driver that is more suited to the provider. The probe score is an in-out parameter, which <code><!--a-->probe<!--/a--></code> can modify based on what it discovers about the device.</p><a name="//apple_ref/doc/uid/TP0000015-TPXREF115" title="Driver Loading"></a><h3>Driver Loading</h3><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_857"></a><p>After all drivers have probed the device, the one with the highest probe score is attached and its <code><!--a-->start<!--/a--></code><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_858"></a>function, which must be implemented by all drivers, is invoked. The <code><!--a-->start<!--/a--></code> function initializes the device hardware and prepares it for operation. If the driver succeeds in starting, it returns <code><!--a-->true<!--/a--></code>; the remaining candidate driver instances are discarded and the driver that started successfully continues operating. If the driver cannot initialize the hardware it must leave the hardware in the state it was in when <code><!--a-->start<!--/a--></code> was invoked and return <code><!--a-->false<!--/a--></code>. The failing driver is then detached and discarded, and the candidate driver with the next highest probe score is given a chance to start. </p><p>Some time after this occurs, all loaded drivers that are not currently in use are unloaded.<a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_859"></a></p><a name="//apple_ref/doc/uid/TP0000015-TPXREF5" title="Device Matching"></a><h2>Device Matching</h2><a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_860"></a><p>A user application that requires access to a device must first search for that device and then acquire the appropriate device interface to communicate with it. This process is known as device matching. Unlike driver matching, device matching searches the <a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_861"></a>I/O Registry for a driver that is already loaded.</p><p>To perform device matching, follow these basic steps:</p><ol class="ol"><li class="li"><p>Establish a connection with the I/O Kit by obtaining a Mach port.</p></li><li class="li"><p>Define a dictionary that specifies the type of device to search for in the I/O Registry. The search can be refined by setting additional values in the dictionary. For example, a search for IOMedia objects can be narrowed down to find all ejectable media. You can find the values to match in the device header files (such as <code>IOSCSIDevice.h</code> or <code>IOATADevice.h</code>), by referring to the family-specific documentation, or by looking at the information property lists displayed in output from the I/O Registry Explorer application.</p></li><li class="li"><p>Obtain a list of all objects in the Registry that match your dictionary and choose the appropriate device.</p></li><li class="li"><p>Access the device you have chosen by obtaining a device interface for it. This step is explained more fully in <span class="content_text"><a href="../ArchitectOverview/ArchitectOverview.html#//apple_ref/doc/uid/TP0000013-BEHEGHEG">“Controlling Devices From Outside the Kernel”</a></span></p></li></ol><p>See the document<em><a href="../../AccessingHardware/index.html#//apple_ref/doc/uid/TP30000376" target="_top"> Accessing Hardware From Applications</a></em> for a full description of device matching.<a name="//apple_ref/doc/uid/TP0000015-DontLinkElementID_862"></a></p>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../TheRegistry/TheRegistry.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../BaseClasses/BaseClasses.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2001, 2007 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2007-05-17<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/DeviceDrivers/Conceptual/IOKitFundamentals/Matching/Matching.html%3Fid%3DTP0000011-4.8&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/DeviceDrivers/Conceptual/IOKitFundamentals/Matching/Matching.html%3Fid%3DTP0000011-4.8&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/DeviceDrivers/Conceptual/IOKitFundamentals/Matching/Matching.html%3Fid%3DTP0000011-4.8&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>