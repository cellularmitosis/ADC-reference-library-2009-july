<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Using Ports</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING42></A>
<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->

<!-- Main Body -->

<CENTER>
<P>
<A HREF="NetworkingWOT-41.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="NetworkingWOT-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="NetworkingWOT-491.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A>  <A HREF="NetworkingWOT-43.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html"><B>Inside Macintosh:</B></A> <A HREF="NetworkingWOT-2.html"><B>Networking With Open Transport </B></A> / <A HREF="NetworkingWOT-10.html"><B>Part 1 - Open Transport Essentials</B></A><BR><DD><A HREF="NetworkingWOT-40.html"><B>Chapter 8 - Ports</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING42-0></A>
<H1>Using Ports</H1>
 This section describes how to obtain port information, and how to register as an Open Transport client.<P>
<A NAME=HEADING42-2></A>
<H2><A NAME=MARKER-13-36></A><A NAME=MARKER-9-37></A>Obtaining Port Information</H2>
 If your application manipulates ports, you may need port information to locate a specific port or to find out how what ports are registered on your computer. Open Transport registers all ports on your computer and creates a port structure for each port. You can then use the various Open Transport port functions to access these structures and get information from them. The port structure is described in <A HREF=NetworkingWOT-269.html#MARKER-9-63>"The Port Structure"</A>. <P>
 If you want to find out the port associated with a given provider, you can use the <CODE><A NAME=MARKER-13-107></A>OTGetProviderPortRef</CODE> function. If you don't know which port structure you want or if you want to provide a list of user-readable port names to your user, you can use the <A NAME=MARKER-13-110></A><CODE>OTGetIndexedPort</CODE> function to <A NAME=MARKER-13-40></A>iterate through all the ports available on a computer, obtaining the port structure of each. <P>
 There are also two functions you can use to find the port structure for a specific port: If you know its port name, you can use the <A NAME=MARKER-13-113></A><CODE>OTFindPort</CODE> function, or if you know its port reference, you can use the <A NAME=MARKER-13-116></A><CODE>OTFindPortByRef</CODE> function. <P>
 If you want to use the <CODE>OTFindPortByRef</CODE> function, you need a <A NAME=MARKER-13-43></A>port reference. There are several ways you can get one: Another application might have passed it to you, another application could have put it into a port structure that you can access by using the <CODE>OTGetIndexedPort</CODE> function, or you can create one. <P>
 To create a port reference, you use the <A NAME=MARKER-13-133></A><CODE>OTCreatePortRef</CODE> function. You must know all the port's hardware characteristics: its device and bus type, its slot number, and its multiport identifier (if it has one). You cannot use wildcards to fill in any element you don't know. Possible device and bus types are described in <A HREF=NetworkingWOT-270.html#MARKER-9-67>"The Port Reference"</A>. <P>
 For example, if you want to find out the port name of the Ethernet port in NuBus slot 13, you can use this line of code to create a port reference for this port:<P>
<PRE>
<A NAME=MARKER-0-95></A>OTPortRef ref = OTCreatePortRef(kOTNuBus, kOTEthernetDevice, 13, 0);
</PRE>
 If you then pass the result of this call to the <CODE>OTFindPortByRef</CODE> function, <CODE>OTFindPortByRef</CODE> fills a buffer with the port structure that has this port reference and returns a pointer to the buffer. You can examine the port structure's fields for its port name. <P>
 Open Transport has <A NAME=MARKER-13-136></A>predefined variants of the <CODE>OTCreatePortRef</CODE> function for the most commonly used hardware devices such as the NuBus, PCI, and PCMCIA devices. These are found in the section describing the function <CODE>OTCreatePortRef</CODE> <A HREF=NetworkingWOT-286.html#MARKER-9-134></A>.<P>
 If you want to extract information from a port reference, you have to use specific Open Transport functions: <CODE>OTGetDeviceTypeFromPortRef</CODE>, <CODE>OTGetBusTypeFromPortRef</CODE>, <CODE>OTGetPortIConFromPortRef</CODE>, <CODE>OTGetUserPortNameFromPortRef</CODE>, and <CODE>OTGetSlotFromPortRef</CODE>. <A NAME=MARKER-13-47></A><P>
<DL>
<DT><B>Note</B>
<DD><A HREF=#MARKER-9-50>Listing 8-1</A> shows the user-defined function <CODE>OTFindSerialPorts</CODE>. This function uses the <CODE>OTGetIndexedPort</CODE> function to find all valid ports. For each port, it gets and examines the device type and, if it's a serial port and not an alias, it calls the user-defined <CODE>PrintSerialPort</CODE> function to output information about the port. (Note that you don't want to include aliases to the serial ports in the list, otherwise a standard machine will have 3 serial ports, &quot;serialA&quot;, &quot;serialB&quot;and &quot;serial&quot;. The <CODE>PrintSerialPort</CODE> function uses the <CODE>OTGetUserPortNameFromPortRef</CODE> function to print the user name for each port.Note that the <A NAME=MARKER-13-48></A>slot numbers for NuBus(TM) cards are physical; that is, they are the slot numbers returned by the Slot Manager and not the slots seen in various network configuration applications. Physical slot numbers depend on the type of card installed. For example, NuBus cards number their slots 9 to 13, which appear in the AppleTalk or TCP control panels as slots 1 to 5. For <A NAME=MARKER-13-49></A>PCI cards, however, the slot numbers are their logical slot IDs as defined in the port structure. For cards in a PCI bus, it is not possible, a priori, to create a port reference that corresponds to a known card, so applications must iterate through the port registry to find appropriate PCI ports.<B></B>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
<B>Listing 8-1  <A NAME=MARKER-9-50></A>Finding all serial ports </B><P>
<PRE>
<A NAME=MARKER-0-95></A>static OSStatus OTFindSerialPorts(void)
{
   OSStatus err;
   Boolean portValid;
   SInt32 portIndex;
   OTPortRecord portRecord;
   UInt16 deviceType;
/* Start portIndex at 0 and call OTGetIndexedPort until */
/* there are no more ports. */
   portIndex = 0;
   err = kOTNoError;
   do {
      portValid = OTGetIndexedPort(&amp;portRecord, portIndex);

   /* Get the deviceType; and, if it's a serial port */
   /* and not an alias, call PrintSerialPort */
      if (portValid) {
         deviceType = OTGetDeviceTypeFromPortRef(portRecord.fRef);
         if (deviceType == kOTSerialDevice &amp;&amp; 
                  (portRecord.fInfoFlags &amp; kOTPortIsAlias) == 0) {
            err = PrintSerialPortInfo(&amp;portRecord);
         }
      }
      portIndex += 1;
   } while ( portValid &amp;&amp; err == kOTNoError);
   return err;
}
static OSStatus PrintSerialPortInfo(const OTPortRecord *portRecord)
{
   Str255 userVisibleName;
   
/* You must be running PPC codeto call OTGetUserPortNameFromPortRef */
/* on a PPC machine. */
   
   OTGetUserPortNameFromPortRef(portRecord-&gt;fRef, userVisibleName);
   
   printf(&quot;Found a serial port with port reference $%08lx:\n&quot;,
                                 portRecord-&gt;fRef);
   printf(&quot;  User visible name is                       "%#s".\n&quot;,
                                    userVisibleName);
   printf(&quot;  String to pass to OTCreateConfiguration is "%s".\n&quot;, 
                                 portRecord-&gt;fPortName);
   printf(&quot;  Name of provider module is                 "%s".\n&quot;, 
                                 portRecord-&gt;fModuleName);
   printf(&quot;\n&quot;);
   return kOTNoError;
}
</PRE>
<A NAME=HEADING42-16></A>
<H2><A NAME=MARKER-13-52></A>Requesting a Port to Yield Ownership</H2>
 There may be times when you need to use a particular port (normally, a serial port or modem) that is owned by another application. You can use the <A NAME=MARKER-13-143></A><CODE>OTYieldPortRequest</CODE> function to request the owner of a port to yield the use of the port to you. (Check the <CODE>kOTPortCanYield</CODE> bit in the port record's flags field to determine whether the port supports yielding.) Open Transport then issues a <A NAME=MARKER-13-102></A><CODE>kOTYieldPortRequest</CODE> event to each provider of any registered clients for that port for acceptance or refusal. If the owner has not registered as a client of Open Transport, compliance is assured. <P>
 If the current owner wants to deny the request, it puts a negative error code into the <CODE>fDenyReason</CODE> field in the <A NAME=MARKER-13-101></A>port close structure indicating its reason for refusal. The <CODE>OTYieldPortRequest</CODE> function then returns with this error code as its result and with a buffer <A NAME=MARKER-13-98></A>listing all the clients that have refused the request, (normally only one).<P>
 If the <CODE>OTYieldPortRequest</CODE> function returns without an error, the port is available for your use. You can then bind it with a queue length (<CODE>qlen</CODE>) greater than 0 or establish a connection with it. If you don't use the port within a short period of time (typically 10 seconds), the port automatically stops being available for your use and reverts to its original owner.<P>
 You can force a <A NAME=MARKER-13-57></A>passive client to yield by using a value of <CODE>NULL</CODE> in the <CODE>OTYieldPortRequest</CODE> function's <CODE>buffer</CODE> parameter. When the function returns without an error, the port is available. Note that a port can only be yielded in this manner if its current client is passively listening; it cannot be yielded if a connection is in progress.<P>
 Providers owned by unregistered clients need to be prepared to receive <CODE><A NAME=MARKER-13-53></A>kOTProviderIsDisconnected</CODE> and <A NAME=MARKER-13-54></A><CODE>kOTProviderIsReconnected</CODE> events when the connection between the provider and port is unexpectedly disconnected and reconnected due to a successful yield request. <A NAME=MARKER-13-60></A><P>
<A NAME=HEADING42-22></A>
<H2><A NAME=MARKER-13-61></A><A NAME=MARKER-9-62></A>Registering as an Open Transport Client</H2>
 You can use the <A NAME=MARKER-13-147></A><CODE>OTRegisterAsClient</CODE> function to register your application as an Open Transport client and provide Open Transport with a notifier function for sending messages to you. Once you are registered as a client, Open Transport can notify you of system events, such as the <A NAME=MARKER-13-64></A>port transition events that occur when a particular port is disabled or closed and when it is reenabled. By registering, you also provide Open Transport with a user-readable name to use when informing the user of port transition events. <P>
 If you use the <CODE>OTRegisterAsClient</CODE> function to register a notifier for client events, you would receive the events such as <CODE>kOTPortDisabled</CODE>, <CODE>kOTPortEnabled</CODE>, <CODE>kOTPortOffline</CODE>, <CODE>kOTPortOnline</CODE>, <CODE>kOTClosePortRequest</CODE>, <CODE>kOTYieldPortRequest</CODE>, and <CODE>kOTNewPortRegistered</CODE> to keep you informed. For information about port events, see <A HREF=NetworkingWOT-268.html#MARKER-9-49>"Port-Related Events"</A>.<P>
 <CODE>The OTRegisterAsClient</CODE> function is optional. If you do not want to receive these events, you do not have to call this function.<P>
 Calling the <CODE>CloseOpenTransport</CODE> function automatically unregisters you as a client. If you want to unregister prior to calling <CODE>CloseOpenTransport</CODE>, you can call the <A NAME=MARKER-13-150></A><CODE>OTUnregisterAsClient</CODE> function. <P>
<DL>
<DT><B>Note</B>
<DD>Client notifiers are distinct from a provider notifier. Provider notifiers tell you about events related to that specific provider. Client notifiers are sent events about the Open Transport system as a whole.  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
 <P>
<HR>
<B>Subtopics</B>
<B><!-- TOC --><DL>
<DT><A HREF="NetworkingWOT-42.html#HEADING42-2">Obtaining Port Information</A>
<DD>
<DT><A HREF="NetworkingWOT-42.html#HEADING42-16">Requesting a Port to Yield Ownership</A>
<DD>
<DT><A HREF="NetworkingWOT-42.html#HEADING42-22">Registering as an Open Transport Client</A>
<DD>
</DL>
</B>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="NetworkingWOT-41.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="NetworkingWOT-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="NetworkingWOT-491.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A>  <A HREF="NetworkingWOT-43.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="NetworkingWOT-4.html">&copy; Apple Computer, Inc.</A><br>15 JAN 1998<P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML> 
