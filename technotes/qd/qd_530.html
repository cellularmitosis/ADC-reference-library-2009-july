<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note QD530: Palette Manager Q&amp;As</title><meta name="keywords" content="Mac OS 8 Palette Manager questions colors flash default SetPalette"><meta name="Description" content="Technical Note QD530: This Technical Note contains a collectionof archived Q&amp;As relating to the Palette Manager--questionssent the Developer Support Center (DSC) along with answersfrom the DSC engineers. Archived Q&amp;As include: GetNewPaletteand default palette documentation update; RestoreDeviceClutand color flash when application quits to avoid weird flashof colors; and Restoring Finder desktop colors after usingPalette Manager; SetPalette cUpdates, NSetPalette, and windowupdate events. ">                                       <meta name="categories" content="QuickDraw"><meta name="week-posted" content="Oct 1, 1990 - Oct 5, 1990"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002740" title="Palette Manager Q&As"></a><a name="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxGraphicsImaging-date.html">Graphics & Imaging</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/GraphicsImaging/index.html" target="_blank">Reference Library > Graphics & Imaging</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note QD530</div>
<div id="pageheadsub">Palette Manager Q&amp;As</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Section1">Introduction</A><BR><BR><A HREF="#References">References</A><BR><BR><A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><p id="introtext">This Technical Note contains a collection of archived Q&amp;As relating to a specific topic - questions sent the Developer Support Center (DSC) along withanswers from the DSC engineers. Current Q&amp;As can be found on the <a href="../../qa/index.html">Macintosh Technical Q&amp;As web site</a>.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Oct 01 1990]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content --><a name=Section1></A><H2>GetNewPalette and default palette documentation update</h2><p>Date Written:   3/10/93</p><p>Last reviewed: 6/24/93</p><p>Our application has a <code>'pltt'</code> resource containing colors, which is replaced bythe user's palette from a Preferences file if it exists. Sometimes our Colordialog box displays black-and-white or incorrect colors. Does the PaletteManager documentation describe default palettes correctly? Should I call<code>GetNewPalette(0)</code> on my application resource fork instead of calling<code>GetPalette(-1)</code>?</p><p>The actual implementation of the Palette Manager is somewhat different than documented in Inside Macintosh Volume VI.</p><p>The Palette Manager has two levels of default palettes. First, there's a systempalette that's loaded at system startup time. This system palette (<code>'pltt'</code>,ID#0) is loaded from the system file if it exists and stored in the system heapalong with other Palette Manager globals. Once the system is booted, thissystem palette doesn't change. Even if you replace the palette in the systemfile, the new palette isn't reloaded. If there's no system palette resource inthe system file, the Palette Manager hard codes a 2 entry (black and white)palette as the system palette. The default system file for both Systems 6.0.8and 7.1 doesn't have a (<code>'pltt'</code>, ID#0) resource. Therefore, it seems that thedefault system palette is typically an entry palette with black and white.</p><p>The other level of default palette is the application palette. This palette isstored in a low-memory global called <code>AppPalette</code>. You probably won't find it inany documentation, but the address is $DCC. (This low-memory global is switchedduring context switches so you don't have to worry about losing the low-memoryglobal when switching applications.) The Palette Manager loads this defaultapplication palette when <code>InitPalette</code> is called. Normally, you don't call<code>InitPalette</code> directly in your code. Instead, <code>InitWindows</code> calls <code>InitPalette</code> foryou. Inside <code>InitPalette</code>, a call to <code>Get1Resource</code> is made with (<code>'pltt'</code>, ID#0).<code>Get1Resource</code> differs from <code>GetResource</code> because <code>Get1Resource</code> checks only thefirst resource file. Since your application is assumed to be at the top of theresource chain, this call will get a palette of ID #0 if it's available in thatfile *only*. This actually causes a problem when running an application from adevelopment environment such as Think C.</p><p>Unlike the default system palette, the default application palette can bemodified by a call to <code>SetPalette(WindowPtr(-1)</code>, <code>newDefaultAppPalette</code>, TRUE).You can also get the default palette with a call to <code>GetPalette(WindowPtr(-1)</code>).When there's no application default palette, <code>GetPalette(WindowPtr(-1)</code>) uses thedefault system palette instead. As mentioned earlier, this is typically a 2entry palette with black and white.</p><p>Lastly, the documentation for the call <code>GetNewPalette</code> on page 20-19 of InsideMacintosh Volume VI is completely misleading. <code>GetNewPalette</code> simply loads in thespecified <code>'pltt'</code> resource using <code>GetResource</code> and then detaches it withDetachResource to make it a handle. It doesn't attach it to the current window.And, it doesn't load the default application handle if the specified resourcecan't be found.</p><P><A HREF="#top">Back to top</A></p><H2>SetPalette cUpdates, NSetPalette, and window update events</h2><p>Date Written:  9/26/91</p><p>Last reviewed:  6/14/93</p><p>When I pass FALSE in the <code>cUpdates</code> parameter to <code>SetPalette</code>, I still get updateevents to that window when I modify its palette. What's going on?</p><p><code>SetPalette</code>'s <code>cUpdates</code> parameter controls whether color-table changes cause thatwindow to get update events only if that window is not the frontmost window. If that window isthe frontmost window, any changes to its palette cause it to get an update event regardless of what the <code>cUpdates</code> parameter is. When you call <code>SetEntryColor</code> and then <code>ActivatePalette</code> for your frontmost window, the window gets an update event because it's the frontmost window even though you passed FALSE in the <code>cUpdates</code> parameter. Another important point is that windows that don't have palettes always get update events when another window's palette is activated.</p><p>Fortunately, system software version 6.0.2 introduced the <code>NSetPalette</code> routine,which is documented in the Macintosh Technical Note <A HREF = "qd_09.html">"Palette Manager Changes in System 6.0.2"</a> and on page 20-20 in the Palette Manager chapter of <i>Inside Macintosh</i> Volume VI. This variation of <code>SetPalette</code> gives you the following options in controlling whether your window gets an update event:</p><ul type="circle">	<li>If you pass <code>pmAllUpdates</code> in the <code>nCUpdates</code> parameter, your window gets an update event when either it or another window's palette is activated.</li>	<li>If you pass <code>pmFgUpdates</code>, your window gets an update event when a palette is activated only if it's the frontmost window (in effect, it gets an update event only if its own palette is activated).</li>	<li>If you pass <code>pmBkUpdates</code>, your window gets an update event when a palette is activated only if it's not the frontmost window (in effect, it gets an update event only if another window's palette is activated).</li>	<li>If you pass <code>pmNoUpdates</code>, your window never gets an update event from any window's palette being activated, including that window itself.</li></ul><P><A HREF="#top">Back to top</A></p><H2>Restoring Finder desktop colors after using Palette Manager</h2><p>Date Written:  8/28/91</p><p>Last reviewed:  8/1/92</p><p>After using the Macintosh Palette Manager, how do I restore the Finder'sdesktop colors?</p><p>The Finder desktop's colors are restored automatically on quitting applicationsthat use the Palette Manager. Colors aren't restored automatically when switching from your application to another, but if that application needs a certain set of colors and uses the Palette Manager to get them, then it'll have them the moment it comes to the front. If you're concerned about applications that don't use the Palette Manager, you can use <code>RestoreDeviceClut(gd:GDHandle</code>), passing the handle to the <code>GDevice</code> of the screen you want to reset, or nil if you want to reset all of your devices. Passing nil to <code>RestoreDeviceClut</code> is your best bet, as it is very straightforward, and resets all of your monitors. You may not wish to do this, however, because <code>RestoreDeviceClut</code> is only available on machines with 32-bit color QuickDraw.</p><p>To reset a screen's <code>GDevice</code> for machines without 32-bit color QuickDraw, youwill need to keep track of the color table.When your application starts up, getthe <code>GDevice</code>'s color table and save it--you'll need it later. This value can befound at <code>(**(**GDHandle).gdPMap).pmTable</code>, where <code>gdPMap</code> is a <code>PixMapHandle</code>, andpmTable is a <code>CTabHandle</code> which tells you the absolute colors for this image.These data structures are found in <i>Inside Macintosh</i> Volume V, pages 52and 119.</p><p>Build your application's "world" using the Palette Manager, and avoid low-levelmethods of changing colors. When your application is about to quit and you wantto restore the environment to its original state, get the color table you savedin the beginning. Convert this to a palette using <code>CTab2Palette</code>. Then set yourwindow to this palette with <code>SetPalette</code>. This will cause the environment toupdate to the original color table that you initially got from the <code>GDevice</code>. Ifthe application that is behind your application is Palette Manager friendly,then it will restore the environment to its palette. You may also want to dothis procedure at the suspend event, as shown in the DTS sample MacApp program,<code>FracApp</code>. One of the problems that you won't be able to solve this way involvesmultiple monitors. You won't know which one to update. Only the monitor thathas the window that you've called <code>ActivatePalette</code> on will update.</p><p>If your application changes the color environment with the Palette Manager,then <code>RestoreDeviceClut</code> is called automatically when your application quits.This means that you shouldn't have to worry about restoring the palette if youdon't want to. There is a catch, however (there always is). When you use theSADE version of MultiFinder (6.1b9), it prevents this from automaticallyhappening. Other versions of MultiFinder don't have this side effect.</p><P><A HREF="#top">Back to top</A></p><H2>RestoreDeviceClut and color flash when application quits</h2><p>Date Written:  8/23/91</p><p>Last reviewed:  6/14/93</p><p>When my application, which uses a color palette, quits, there is momentary butdistracting flash of weird colors in the Finder windows and the desktop temporarily appears in a weird color. Is there any way to get around this?</p><p>When you quit, RestoreDeviceClut is called to restore the color table and anupdate event is called to redraw the screen. It's the delay between the changein the color table and the update event that causes the flash of incorrectcolors to be displayed. This, unfortunately, is unavoidable.</p><P><A HREF="#top">Back to top</A></p><H2>Macintosh Palette Manager and offscreen graphics</h2><p>Date Written:  7/22/91</p><p>Last reviewed:  8/1/92</p><p>The Macintosh Palette Manager doesn't work on offscreen environments the wayyou'd expect. Unlike color windows, <code>SetPalette</code> will not change the offscreen'scolor table; rather it just allows you to use <code>PMForeColor</code> and <code>PMBackColor</code> toset the current drawing color in that environment. To change the offscreen'scolor table you'll need to convert the palette to a color table and then setthe resulting color table to the off screen. Calling <code>Palette2CTab</code> will do theconverting for you.</p><p>To get around having to use palettes to define the current drawing color in theoff screen, you can always use <code>Index2Color</code> and then <code>RGBForeColor</code> to get the color to be set for drawing. A remake of <A HREF = "downloads/GiMeDaPalette.sea.hqx">GiMeDaPalette</a> code sample, availableon the latest <i>Developer CD Series</i> disc, does offscreen drawing in placeof having to continually copy a PICT.</p><a name="Downloads"></a>         <P><A HREF="#top">Back to top</A></p><H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (48K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/qd_530.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/qd/qd_530.html%3Fid%3DDTS10002740-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/qd/qd_530.html%3Fid%3DDTS10002740-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/qd/qd_530.html%3Fid%3DDTS10002740-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>