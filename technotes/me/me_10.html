<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"            "http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note ME10: MultiFinder and _SetGrowZone</title><meta name="keywords" content="Mac OS 8 MultiFinder GzProc grow zone memory application _SetGrowZone"><meta name="Description" content="Technical Note ME10: This Technical Note explains why anapplication may crash if it attempts to save and restorethe grow zone procedure of MultiFinder. Technical Note thendetails the correct way to allocate memory without invokingthe application's gzProc."><meta name="categories" content="Memory"><meta name="week-posted" content="May 29, 1989 - Jun 2, 1989"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"><a name="//apple_ref/doc/uid/DTS10002536" title="MultiFinder and _SetGrowZone"></a><a name="top"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/index.html" target="_blank">Reference Library</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note ME10</div>
<div id="pageheadsub">MultiFinder and _SetGrowZone</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Section1">MultiFinder</a><BR><BR>  <A HREF="#References">References</A><BR><BR> <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">MultiFinder patches the <code>_SetGrowZone</code> trap, and this patch can causeyour program to crash if you attempt to save and restore the grow zone procedure.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Jun 01 1989]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><a name="Section1"></a><h2>MultiFinder</h2><p>MultiFinder gives each application its own heap in which to run.  Because itwants to do some fairly tricky memory management, MultiFinder installs its owngrow zone procedure (<code>gzProc</code>) in the application heap, and patches<code>_SetGrowZone</code> to store your application's <code>gzProc</code> in atemporary variable inside of itself.</p><p>A problem arises when you want to allocate some memory <b>without</b> invokingthe application's <code>gzProc</code>.  This can be useful if you are writing alibrary of routines that does its own internal caching, and you do not wantthat cache to purge the application's reserved memory.  Let's say that to dothis, you write a pair of routines, <code>KillGZProc</code> and <code>RestoreGZProc</code>, which look like this:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    #include &lt;Memory.h&gt;    GrowZoneProcPtr savedGZProc;    pascal void KillGZProc(void)    {        THZ myZone;        myZone = GetZone();        /*    since there is no GetGrowZone trap, we have to pull it directly            from the zone header (Ugh! Very gross!) */        savedGZProc = myZone-&gt;gzProc;        /* we don't want a grow zone proc */        SetGrowZone( (GrowZoneProcPtr) nil);    }    pascal void RestoreGZProc(void)    {        /* set to saved value */        SetGrowZone(savedGZProc);    }</pre>	</TD></TR></TABLE></CENTER><p>Now let's say that you bracket your call to <code>_NewHandle</code> with these tworoutines.  When MultiFinder is active, you get the following:</p><ul type="disc">	<li><p>When the application starts, you set your <code>gzProc</code> to the routine <code>MyGZProc</code>.  MultiFinder stores the procedure pointer inside of your application's MultiFinder data area.</p><BR><BR></li>	<li><p>You call <code>KillGZProc</code>.  The global variable <code>savedGZProc</code> now contains a pointer to <b>MultiFinder's </b><code>gzProc</code>, which MultiFinder installed in your zone header before your application started.</p><BR><BR></li>	<li><p>You do your memory allocation, and your <code>gzProc</code> (<code>MyGZProc</code>) doesn't get called, just as you intended.</p><BR><BR></li>	<li><p>You call <code>RestoreGZProc</code>, which stores a pointer to MultiFinder's <code>gzProc</code> in your application's MultiFinder data area.</p><BR><BR></li>	<li><p>The next time you do a memory allocation that causes the <code>gzProc</code> to be called, MultiFinder's <code>gzProc</code> will be called.  One of the things this <code>gzProc</code> does is to see if there is a valid <code>gzProc</code> stored in your application's MultiFinder data area.  If there is a valid <code>gzProc</code>,  it gets called.  But the <code>gzProc</code> in your application's MultiFinder data area  is MultiFinder's <code>gzProc</code>, so we go into an infinite loop.  Oops...</p><BR><BR></li></ul><p>The only solution to work around this problem is to avoid reading the value ofthe <code>gzProc</code> out of the zone header, since it isn't valid when MultiFinder is active.  (Reading the fields of the zone header is dangerous, compatibility wise as well.)  Your application should only have one grow zone procedure, so you should change your <code>KillGZProc</code> and <code>RestoreGZProc</code> to restore your application's grow zone procedure directly.  The corrected code would look like the following:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    #include &lt;Memory.h&gt;    pascal long MyGrowZone(Size cbNeeded);    pascal void KillGZProc(void)    {        /* we don't want a grow zone proc */        SetGrowZone( (GrowZoneProcPtr) nil);    }    pascal void RestoreGZProc(void)    {        /* set to my routine */        SetGrowZone(MyGrowZone);    }</pre>	</TD></TR></TABLE></CENTER><p>As you can see, the code is simpler, though not quite as flexible, but at least it won't throw your machine for a loop.</p> <P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><p><i>Inside Macintosh</i>, Volume II, Memory Manager</p><p><i>Programmers Guide To MultiFinder</i></p><p>Technical Note M.TB.Multifinder - <u><A HREF = "../tb/tb_14.html">MultiFinder Questions</a></u></p><p>Technical Note M.OV.Multifinder - <u><A HREF = "../ov/ov_17.html">MultiFinder Revisited</a></u></p><p>Technical Note M.OV.32BitClean - <u><A HREF = "../ov/ov_11.html">The Joy Of Being 32-Bit Clean</a></u></p>         <P><A HREF="#top">Back to top</A></P>                           <P><A NAME=Downloads></A></P>                  <h2>Downloadables</h2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (36K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/me_10.pdf">Download</A></P>               </TD>            </TR>                     </TABLE>         <BR>                  <P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/me/me_10.html%3Fid%3DDTS10002536-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/me/me_10.html%3Fid%3DDTS10002536-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/me/me_10.html%3Fid%3DDTS10002536-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>