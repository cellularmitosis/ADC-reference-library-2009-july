<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Extending Printing Dialogs: Core Tasks</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Core Tasks"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30000979-CH206" title="Core Tasks"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000432" target="_top">Printing</a> &gt; <a href="../../../Carbon-date.html#//apple_ref/doc/uid/TP30000440-TP30000432-TP30000494" target="_top">Carbon</a> &gt; <a href="../Introduction/Introduction.html#//apple_ref/doc/uid/TP30000979-CH201-TP9">Extending Printing Dialogs</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../Project/Project.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../Custom/Custom.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30000979-CH206-TP9" title="Core Tasks"></a><h1>Core Tasks</h1><p>This chapter shows you how to implement most of the required callback functions in a printing dialog extension—that is, the functions in the <code>IUnknownVTbl</code> and <code>PlugInIntfVTable</code> interfaces. The source code presented here contains a core set of data types and functions that you can use in a real-world project with little or no modification.</p><p>All the code examples in this chapter are adapted from a complete sample project for writing a printing dialog extension. To view or download the current version of the sample project, see <em><a href="../../../../../samplecode/PDEProject/index.html#//apple_ref/doc/uid/DTS10000745" target="_top">PDEProject</a></em> in the ADC Reference Library.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000979-CH206-DontLinkElementID_1" title="Note"></a><p><strong>Note:</strong>&nbsp; If you’re using the sample project, this chapter is not required reading. You can proceed to <span class="content_text"><a href="../Custom/Custom.html#//apple_ref/doc/uid/TP30000979-CH207-TP9">“Custom Tasks”</a></span> and return to this chapter as needed.</p></div>
<!-- This template is being used for both PDF and HTML. -->

    
    <h4>In this section:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-TPXREF164">Plug-in Tasks</a>
				
			<br/>
			
        
			
			
				<a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-TPXREF165">Printing Dialog Extension Tasks</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF164" title="Plug-in Tasks"></a><h2>Plug-in Tasks</h2><p>A printing dialog extension is implemented as a loadable bundle that must perform a core set of tasks—including registration, interface discovery, and instance management—that allow it to operate as a printing plug-in in Mac OS X.</p><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF115" title="Defining Interface Structures"></a><h3>Defining Interface Structures</h3><p>To provide a way for the printing system to use your callback functions at runtime, you need to define the data structures described in the following sections:</p><ul class="spaceabove"><li class="li"><p><span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-BBCEAEAD">“Defining Function Tables”</a></span> describes how to define two static tables with pointers to your callback functions.</p></li><li class="li"><p><span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-CIHGJIHD">“Defining an Instance”</a></span> describes how to define a structure that represents an instance of one of your printing dialog extension interfaces.</p></li></ul><a name="//apple_ref/doc/uid/TP30000979-CH206-BBCEAEAD" title="Defining Function Tables"></a><h4>Defining Function Tables</h4><p>For each of the two required interfaces that your printing dialog extension must implement—<code>IUnknownVTbl</code> and <code>PlugInIntfVTable</code>—you need to define a table of function pointers. Taken together, these two tables give your client access to all of the required functions in your printing dialog extension.</p><p><span class="content_text">Listing 5-1</span> shows how to define two static data structures for this purpose.</p><a name="//apple_ref/doc/uid/TP30000979-CH206-BBCGEHBD" title="Listing 5-1Function tables for the two required interfaces"></a><p class="codesample"><strong>Listing 5-1&nbsp;&nbsp;</strong>Function tables for the two required interfaces</p><div class="codesample"><table><tr><td scope="row"><pre>static const IUnknownVTbl sMyIUnknownVTable =<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    NULL, // required padding for COM<span></span></pre></td></tr><tr><td scope="row"><pre>    MyQueryInterface,<span></span></pre></td></tr><tr><td scope="row"><pre>    MyIUnknownRetain,<span></span></pre></td></tr><tr><td scope="row"><pre>    MyIUnknownRelease<span></span></pre></td></tr><tr><td scope="row"><pre>};<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>static const PlugInIntfVTable sMyPDEVTable =<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        MyPMRetain,<span></span></pre></td></tr><tr><td scope="row"><pre>        MyPMRelease,<span></span></pre></td></tr><tr><td scope="row"><pre>        MyPMGetAPIVersion<span></span></pre></td></tr><tr><td scope="row"><pre>    },<span></span></pre></td></tr><tr><td scope="row"><pre>    MyPrologue,<span></span></pre></td></tr><tr><td scope="row"><pre>    MyInitialize,<span></span></pre></td></tr><tr><td scope="row"><pre>    MySync,<span></span></pre></td></tr><tr><td scope="row"><pre>    MyGetSummary,<span></span></pre></td></tr><tr><td scope="row"><pre>    MyOpen,<span></span></pre></td></tr><tr><td scope="row"><pre>    MyClose,<span></span></pre></td></tr><tr><td scope="row"><pre>    MyTerminate<span></span></pre></td></tr><tr><td scope="row"><pre>};<span></span></pre></td></tr></table></div><p>The <code>sMyIUnknownTable</code> structure consists of a table of pointers to the three callback functions that all Core Foundation plug-ins must implement.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000979-CH206-DontLinkElementID_2" title="Note"></a><p><strong>Note:</strong>&nbsp;The <code>IUnknownVTbl</code> data type is based on the Component Object Model (COM) specification for IUnknown, the base interface that every COM plug-in implements. In this chapter, IUnknown and <code>IUnknownVTbl</code> refer to the same programming interface.</p></div><p>The <code>sMyPDEVTable</code> structure consists of a table of pointers to three functions that all printing plug-ins must implement and to seven functions that all printing dialog extensions must implement.</p><p>Your printing dialog extension supplies the base address of each table at runtime, as explained in <span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-CIHGJIHD">“Defining an Instance.”</a></span></p><a name="//apple_ref/doc/uid/TP30000979-CH206-CIHGJIHD" title="Defining an Instance"></a><h4>Defining an Instance</h4><p><span class="content_text">Listing 5-2</span> illustrates how you might define instance structures for these two interfaces. Because both interfaces support reference counting, each structure includes an integer counter.</p><a name="//apple_ref/doc/uid/TP30000979-CH206-CIHIHAFH" title="Listing 5-2Definition of instances in a printing dialog extension"></a><p class="codesample"><strong>Listing 5-2&nbsp;&nbsp;</strong>Definition of instances in a printing dialog extension</p><div class="codesample"><table><tr><td scope="row"><pre>typedef struct<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    const IUnknownVTbl *vtable;<span></span></pre></td></tr><tr><td scope="row"><pre>    SInt32 refCount;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFUUIDRef factoryID;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>} MyIUnknownInstance;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>typedef struct<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    const PlugInIntfVTable *vtable;<span></span></pre></td></tr><tr><td scope="row"><pre>    SInt32 refCount;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>} MyPDEInstance;<span></span></pre></td></tr></table></div><p>Each <code>vtable</code> field points to a function table for one of the two required interfaces. You should assign a pointer to the appropriate function table described in <code></code><span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-BBCEAEAD">“Defining Function Tables.”</a></span></p><p>Each <code>refCount</code> field is an integer used to keep track of the number of references to an instance. For more information on reference counting, see the discussion of memory management in <em>Core Foundation Overview</em>.</p><p>In the<code>IUnknownVTbl</code> instance, the <code>factoryID</code> field identifies the factory function that created the instance.</p><p>When a caller asks for an interface at runtime, you should construct an instance and pass its address back to the caller. The caller will pass this pointer back to your printing dialog extension later, giving various callback functions access to the same instance.</p><p>The instance pointer you supply must also point to the base address of the function table for the requested interface. In other words, the address of the function table must always be the first field in the instance structure. In <span class="content_text">Listing 5-2</span><code></code> this is the <code>vtable</code> field.</p><p>Later in this chapter, you will learn when and how to construct a new instance for each of the two required interfaces.</p><a name="//apple_ref/doc/uid/TP30000979-CH206-CIHCFFIE" title="Implementing a Factory Function"></a><h3>Implementing a Factory Function</h3><p>Your factory function is the main entry point for your printing dialog extension. When the printing system calls <code><a href="../../../../CoreFoundation/Reference/CFPlugInRef/Reference/reference.html#//apple_ref/doc/c_ref/CFPlugInInstanceCreate" target="_top">CFPlugInInstanceCreate</a></code> to request an instance of your <code>IUnknownVTbl</code> interface, Plug-in Services loads your executable and invokes its factory function.</p><p>You can give your factory function any name you wish. To support runtime name binding, you need to</p><ul class="spaceabove"><li class="li"><p>use this name in the <code>CFPlugInFactories</code> entry in your property list</p></li><li class="li"><p>direct the compiler to export the name</p></li></ul><p><span class="content_text">Listing 5-3</span> implements a factory function that constructs an instance of your <code>IUnknownVTbl</code> interface and returns its address to the caller.</p><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF145" title="Listing 5-3A factory function that supplies an instance of the IUnknownVTbl interface"></a><p class="codesample"><strong>Listing 5-3&nbsp;&nbsp;</strong>A factory function that supplies an instance of the <code>IUnknownVTbl</code> interface</p><div class="codesample"><table><tr><td scope="row"><pre>extern void* MyCFPlugInFactory (<span></span></pre></td></tr><tr><td scope="row"><pre>    CFAllocatorRef allocator,<span></span></pre></td></tr><tr><td scope="row"><pre>    CFUUIDRef typeUUID<span></span></pre></td></tr><tr><td scope="row"><pre>)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CFBundleRef         myBundle    = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFDictionaryRef     myTypes     = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFStringRef         requestType = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFArrayRef          factories   = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFStringRef         factory     = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFUUIDRef           factoryID   = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    MyIUnknownInstance  *instance   = NULL;<span>// 1</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    myBundle = MyGetBundle();<span>// 2</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (myBundle != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        myTypes = CFBundleGetValueForInfoDictionaryKey (<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>            myBundle, CFSTR("CFPlugInTypes"));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if (myTypes != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            requestType = CFUUIDCreateString (allocator, typeUUID);<span></span></pre></td></tr><tr><td scope="row"><pre>            if (requestType != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                factories = CFDictionaryGetValue (myTypes, requestType);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>                CFRelease (requestType);<span></span></pre></td></tr><tr><td scope="row"><pre>                if (factories != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>                {<span></span></pre></td></tr><tr><td scope="row"><pre>                    factory = CFArrayGetValueAtIndex (factories, 0);<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>                    if (factory != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>                    {<span></span></pre></td></tr><tr><td scope="row"><pre>                        factoryID = CFUUIDCreateFromString (<span></span></pre></td></tr><tr><td scope="row"><pre>                            allocator, factory);<span></span></pre></td></tr><tr><td scope="row"><pre>                        if (factoryID != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>                        {<span></span></pre></td></tr><tr><td scope="row"><pre>                            instance = malloc (sizeof(MyIUnknownInstance));<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>                            if (instance != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>                            {<span></span></pre></td></tr><tr><td scope="row"><pre>                                instance->vtable = &amp;sMyIUnknownVTable;<span></span></pre></td></tr><tr><td scope="row"><pre>                                instance->refCount = 1;<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>                                instance->factoryID = factoryID;<span>// 8</span></pre></td></tr><tr><td scope="row"><pre>                                CFPlugInAddInstanceForFactory (factoryID);<span>// 9</span></pre></td></tr><tr><td scope="row"><pre>                            }<span></span></pre></td></tr><tr><td scope="row"><pre>                            else {<span></span></pre></td></tr><tr><td scope="row"><pre>                                CFRelease (factoryID);<span></span></pre></td></tr><tr><td scope="row"><pre>                            }<span></span></pre></td></tr><tr><td scope="row"><pre>                        }<span></span></pre></td></tr><tr><td scope="row"><pre>                    }<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return instance;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>	<p>Here’s what the factory function in <span class="content_text">Listing 5-3</span> does:</p><ol class="ol"><li class="li"><p>Sets the default return value to <code>NULL</code>. The factory function returns <code>NULL</code> if there is an error, to indicate that no instance was created.</p></li><li class="li"><p>Calls a utility function that returns a reference to your plug-in bundle. An implementation of <code>MyGetBundle</code> is provided in the sample project.</p></li><li class="li"><p>Gets a reference to the <code>CFPlugInTypes</code> dictionary in the property list, which contains the type identifier for this plug-in.</p></li><li class="li"><p>Gets a reference to the <code>CFPlugInFactories</code> entry for the plug-in type requested by the caller.</p></li><li class="li"><p>Gets a reference to the factory identifier for this plug-in type. If your plug-in has more than one factory function, you may need to modify this code.</p></li><li class="li"><p>Allocates memory for a new instance of <code>IUnknownVTbl</code>.</p></li><li class="li"><p>Sets the initial reference count to 1, because the caller owns this instance.</p></li><li class="li"><p>Saves the identifier for the factory that created this instance. This identifier is needed later when you remove the registration for this instance.</p></li><li class="li"><p>Registers this instance with Plug-in Services. Plug-In Services will not unload your printing dialog extension while an instance is registered.</p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF118" title="Implementing the IUnknown Interface"></a><h3>Implementing the IUnknown Interface</h3><p>As a Core Foundation plug-in, your printing dialog extension must implement the three functions in <code>IUnknownVTbl</code>. These functions give the printing system access to the other interfaces your printing dialog extension implements. To learn more about how a plug-in provides access to an interface, see <span class="content_text"><a href="../PDEConcepts/PDEConcepts.html#//apple_ref/doc/uid/TP30000979-CH204-TPXREF166">“Instantiation of a Programming Interface.”</a></span></p><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF121" title="Query Interface"></a><h4>Query Interface</h4><p><span class="content_text">Listing 5-4</span> implements a query interface function that creates an instance of the <code>PlugInIntfVTable</code> interface.</p><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF144" title="Listing 5-4A query interface function in a printing dialog extension"></a><p class="codesample"><strong>Listing 5-4&nbsp;&nbsp;</strong>A query interface function in a printing dialog extension</p><div class="codesample"><table><tr><td scope="row"><pre>static HRESULT MyQueryInterface (<span></span></pre></td></tr><tr><td scope="row"><pre>    void *this, <span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    REFIID iID, <span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    LPVOID *ppv<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CFUUIDRef requestID = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFUUIDRef actualID  = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    HRESULT   result = E_UNEXPECTED;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    requestID = CFUUIDCreateFromUUIDBytes (kCFAllocatorDefault, iID);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    if (requestID != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        actualID = CFUUIDCreateFromString (<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>            kCFAllocatorDefault,<span></span></pre></td></tr><tr><td scope="row"><pre>            kDialogExtensionIntfIDStr<span></span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if (actualID != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            if (CFEqual (requestID, actualID))<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                MyPDEInstance *instance = malloc (sizeof(MyPDEInstance));<span></span></pre></td></tr><tr><td scope="row"><pre>                if (instance != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>                {<span></span></pre></td></tr><tr><td scope="row"><pre>                    instance->vtable = &amp;sMyPDEVTable;<span></span></pre></td></tr><tr><td scope="row"><pre>                    instance->refCount = 1;<span></span></pre></td></tr><tr><td scope="row"><pre>                    *ppv = instance;<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>                    result = S_OK;<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>            else<span></span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                if (CFEqual (requestID, IUnknownUUID))<span>// 8</span></pre></td></tr><tr><td scope="row"><pre>                {<span></span></pre></td></tr><tr><td scope="row"><pre>                    MyIUnknownRetain (this);<span></span></pre></td></tr><tr><td scope="row"><pre>                    *ppv = this;<span></span></pre></td></tr><tr><td scope="row"><pre>                    result = S_OK;<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>                else<span></span></pre></td></tr><tr><td scope="row"><pre>                {<span></span></pre></td></tr><tr><td scope="row"><pre>                    *ppv = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>                    result = E_NOINTERFACE;<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            CFRelease (actualID);<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease (requestID);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 5-4</span> does:</p><ol class="ol"><li class="li"><p>Receives a pointer to the same <code>IUnknownVTbl</code> instance that was constructed by your factory function. (To the caller, this pointer is the address of a pointer to the function table for your <code>IUnknownVTbl</code> interface.)</p></li><li class="li"><p>Receives a string that contains the UUID of the interface the client wants.</p></li><li class="li"><p>Receives the address of storage in the calling function for a pointer to a pointer to the function table.</p></li><li class="li"><p>Gets a reference to the <code>CFUUID</code> for the requested interface. In general, you should always convert a UUID string into a <code>CFUUID</code> object before using it.</p></li><li class="li"><p>Gets a reference to the conventional <code>CFUUID</code> for a printing dialog extension interface. The printing system (the caller) always requests an instance of this interface using the string constant kDialogExtensionIntfIDStr.</p></li><li class="li"><p>Checks to see if the caller wants an instance of the <code>PlugInIntfVTable</code> interface. This is the usual case.</p></li><li class="li"><p>Passes back a pointer to the new instance of the <code>PlugInIntfVTable</code> interface.</p></li><li class="li"><p>Checks to see if the caller wants a copy of the <code>IUnknownVTbl</code> instance. If so, this code assigns the same instance that your factory function supplied. The constant <code>IUnknownUUID</code> is defined in the Plug-in Services API.</p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF119" title="Add Reference"></a><h4>Add Reference</h4><p><span class="content_text">Listing 5-5</span> implements a function that retains (increments the reference count of) an instance of the IUnknown interface.</p><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF142" title="Listing 5-5A function that retains an instance of the IUnknown interface"></a><p class="codesample"><strong>Listing 5-5&nbsp;&nbsp;</strong>A function that retains an instance of the IUnknown interface</p><div class="codesample"><table><tr><td scope="row"><pre>static ULONG MyIUnknownRetain (void* this)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    MyIUnknownInstance* instance = (MyIUnknownInstance*) this;<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    ULONG refCount = 1;<span>// 2</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (instance != NULL) {<span></span></pre></td></tr><tr><td scope="row"><pre>        refCount = ++instance->refCount;<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return (refCount);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 5-5</span> does:</p><ol class="ol"><li class="li"><p>Defines a pointer to the <code>IUnknownVTbl</code> instance that was constructed by the factory function. This pointer provides access to the <code>refCount</code> field for this instance.</p></li><li class="li"><p>Defines a variable for the updated reference count, and sets its default value to 1.</p></li><li class="li"><p>Increments the reference count for this instance.</p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF120" title="Release Reference"></a><h4>Release Reference</h4><p><span class="content_text">Listing 5-6</span> implements a function that releases (decrements the reference count of) an instance of the IUnknown interface.</p><p>If the reference count reaches zero, the function releases Core Foundation objects on which the instance depended, and then destroys the instance.</p><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF143" title="Listing 5-6A function that releases an instance of the IUnknown interface"></a><p class="codesample"><strong>Listing 5-6&nbsp;&nbsp;</strong>A function that releases an instance of the IUnknown interface</p><div class="codesample"><table><tr><td scope="row"><pre>static ULONG MyIUnknownRelease (void* this)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    MyIUnknownInstance* instance = (MyIUnknownInstance*) this;<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    ULONG refCount = 0;<span>// 2</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (instance != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        refCount = --instance->refCount;<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>        if (refCount == 0)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            CFPlugInRemoveInstanceForFactory (instance->factoryID);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>            CFRelease (instance->factoryID);<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>            free (instance);<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>            MyFreeBundle();<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return refCount;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 5-6</span> does:</p><ol class="ol"><li class="li"><p>Defines a pointer to an instance of the <code>IUnknownVTbl</code> interface. This is the same instance the factory function supplied.</p></li><li class="li"><p>Defines a variable for the updated reference count, and sets its default value to zero.</p></li><li class="li"><p>Decrements the reference count for this instance.</p></li><li class="li"><p>Removes the instance from the Plug-in Services registry.</p></li><li class="li"><p>Releases the factory ID, because it is no longer needed.</p></li><li class="li"><p>Deallocates storage for the instance.</p></li><li class="li"><p>Releases our bundle reference, in case the plug-in is being unloaded. For more information about <code>MyFreeBundle</code>, see the comments in the sample project that accompanies this book.</p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF165" title="Printing Dialog Extension Tasks"></a><h2>Printing Dialog Extension Tasks</h2><p>The sample code presented in this section shows you how to implement the seven required callback functions discussed in <span class="content_text"><a href="../PDEConcepts/PDEConcepts.html#//apple_ref/doc/uid/TP30000979-CH204-TPXREF10">“Activation,”</a></span> in a manner that supports reentrancy.</p><a name="//apple_ref/doc/uid/TP30000979-CH206-CIHHEAGC" title="Defining a Context"></a><h3>Defining a Context</h3><p>To support document-modal (or sheet) dialogs, a printing dialog extension must be capable of managing the state of its pane in several dialog windows concurrently.</p><p>For each dialog window, your printing dialog extension allocates memory for pane state information and supplies its address—called a <strong>context</strong>—to the printing system.</p><p><span class="content_text">Listing 5-7</span> shows how the context is defined in the sample project.</p><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF141" title="Listing 5-7A sample context structure"></a><p class="codesample"><strong>Listing 5-7&nbsp;&nbsp;</strong>A sample context structure</p><div class="codesample"><table><tr><td scope="row"><pre>typedef struct<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    ControlRef       userPane;<span></span></pre></td></tr><tr><td scope="row"><pre>    EventHandlerRef  helpHandler;<span></span></pre></td></tr><tr><td scope="row"><pre>    EventHandlerUPP  helpHandlerUPP;<span></span></pre></td></tr><tr><td scope="row"><pre>    void*            customContext;<span></span></pre></td></tr><tr><td scope="row"><pre>    Boolean          initialized;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>} MyContextBlock;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>typedef MyContextBlock* MyContext;<span></span></pre></td></tr></table></div><p>The <code>userPane</code> field is a reference to the container control into which you embed the controls in your custom interface.</p><p>The <code>helpHandler</code> field is a reference to a Carbon event handler that’s active when your custom pane is visible. The handler detects when the help button is clicked, and displays your custom help content using Help Viewer.</p><p>The <code>helpHandlerUPP</code> field is a universal procedure pointer that’s allocated and used whenever the help event handler is installed.</p><p>The <code>customContext</code> field is for a pointer to a block of additional memory allocated in your custom code, as described in <span class="content_text"><a href="../Custom/Custom.html#//apple_ref/doc/uid/TP30000979-CH207-CIHHEAGC">“Defining a Custom Context.”</a></span></p><p>The <code>initialized</code> field indicates whether the interface in your custom pane has been constructed and initialized.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000979-CH206-DontLinkElementID_3" title="Note"></a><p><strong>Note:</strong>&nbsp; The printing system always refers to your context using the generic type <code>PMPDEContext</code>. To gain access to your context data, you should cast the generic type to your actual context type.</p></div><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF127" title="Implementing the Required Callbacks"></a><h3>Implementing the Required Callbacks</h3><p>All printing dialog extensions must implement the ten functions in the <code>PlugInIntfVTable</code> interface. The first three functions—<code>PMRetain</code>, <code>PMRelease</code>, and <code>PMGetAPIVersion</code>—are described in the appendix <span class="content_text"><a href="../PMPlugIn/PMPlugIn.html#//apple_ref/doc/uid/TP30000979-CH210-TP1">“Printing Plug-in Header Functions.”</a></span> The remaining seven functions are described here in this section.</p><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF128" title="Prologue"></a><h4>Prologue</h4><p>The prologue function allocates a block of memory for a context, and passes this context—along with some static information about your custom pane—back to the printing system.</p><p>You can give your prologue function any name you wish. You need to enter this name in the function table for the <code>PlugInIntfVTable</code> interface, as described in <span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-BBCEAEAD">“Defining Function Tables.”</a></span></p><p><span class="content_text">Listing 5-8</span> implements a prologue function.</p><a name="//apple_ref/doc/uid/TP30000979-CH206-CIHBBBCF" title="Listing 5-8A prologue function"></a><p class="codesample"><strong>Listing 5-8&nbsp;&nbsp;</strong>A prologue function</p><div class="codesample"><table><tr><td scope="row"><pre>static OSStatus MyPrologue<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>(<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPDEContext    *outContext,<span></span></pre></td></tr><tr><td scope="row"><pre>    OSType          *creator,<span></span></pre></td></tr><tr><td scope="row"><pre>    CFStringRef     *paneKind,<span></span></pre></td></tr><tr><td scope="row"><pre>    CFStringRef     *title,<span></span></pre></td></tr><tr><td scope="row"><pre>    UInt32          *maxH,<span></span></pre></td></tr><tr><td scope="row"><pre>    UInt32          *maxV<span></span></pre></td></tr><tr><td scope="row"><pre>)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    MyContext context = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus result = kPMInvalidPDEContext;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    context = malloc (sizeof (MyContextBlock));<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    if (context != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        context->customContext = MyCreateCustomContext();<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>        context->initialized = false;<span></span></pre></td></tr><tr><td scope="row"><pre>        context->userPane = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        *outContext = (PMPDEContext) context;<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>        *creator    = kMyBundleCreatorCode;<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>        *paneKind   = kMyPaneKindID;<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>        *title      = MyGetTitle();<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>        *maxH       = kMyMaxH;<span>// 8</span></pre></td></tr><tr><td scope="row"><pre>        *maxV       = kMyMaxV;<span>// 9</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span>// 10</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 5-8</span> does:</p><ol class="ol"><li class="li"><p>The six calling parameters are all pointers to storage provided by the caller (the printing system) to receive information from this prologue function.</p></li><li class="li"><p>Allocates memory for a new context.</p></li><li class="li"><p>Calls a function that creates and returns a custom context. This context is described in <span class="content_text"><a href="../Custom/Custom.html#//apple_ref/doc/uid/TP30000979-CH207-CIHHEAGC">“Defining a Custom Context.”</a></span></p></li><li class="li"><p>Passes back your context to the printing system.</p></li><li class="li"><p>Passes back the unique 4-byte creator code that identifies your printing dialog extension. This code is described in <span class="content_text"><a href="../Custom/Custom.html#//apple_ref/doc/uid/TP30000979-CH207-TPXREF169">“Defining Bundle, Pane, and Nib Identifiers.”</a></span></p></li><li class="li"><p>Passes back the string that identifies your custom pane. This identifier is described in <span class="content_text"><a href="../Custom/Custom.html#//apple_ref/doc/uid/TP30000979-CH207-TPXREF169">“Defining Bundle, Pane, and Nib Identifiers.”</a></span></p></li><li class="li"><p>Passes back the title of your custom pane, which is supplied by the custom function described in <span class="content_text"><a href="../Custom/Custom.html#//apple_ref/doc/uid/TP30000979-CH207-TPXREF128">“Providing the Title of your Custom Pane.”</a></span> Your printing dialog extension retains ownership of the title string, and should release it when it’s no longer needed.</p><p>If you are implementing one of the standard sets of printing features listed in <span class="content_text"><a href="../PaneConcepts/PaneConcepts.html#//apple_ref/doc/uid/TP30000979-CH202-BBCBHBDD">Table 1-1</a></span>, the printing system may not use your custom title.</p></li><li class="li"><p>Passes back the desired width of the custom pane in pixel units. While this value is not used by the printing system in Mac OS X version 10.2 and earlier, it might be used in a future version of Mac OS X.</p></li><li class="li"><p>Passes back the desired height of the custom pane in pixel units.</p></li><li class="li"><p>Returns a result code to the caller. If your prologue function returns a non-zero result code, the printing system immediately unloads your printing dialog extension (without calling your terminate function.)</p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF129" title="Initialize"></a><h4>Initialize</h4><p>If your prologue function returns <code>noErr</code>, the printing system proceeds to call your initialize function.</p><p>You can give the initialize function any name you wish. You need to enter this name in the function table for the <code>PlugInIntfVTable</code> interface, as described in <span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-BBCEAEAD">“Defining Function Tables.”</a></span></p><p>As the name suggests, the purpose of the initialize function is to provide initial values for the settings associated with your user interface. If the settings are already defined in a ticket, the initialize function should retrieve their values from the ticket at this time.</p><p>In Mac OS X version 10.2 and later, you can use <code>SetControlBounds</code> to adjust the vertical size of the user pane at this time. If your pane is displayed later, the dialog will reflect the adjusted pane height. This feature is useful if the desired size of your pane is not known until your initialize function is called.</p><p><span class="content_text">Listing 5-9</span> implements a “lazy” initialize function that defers the task of creating and embedding Carbon controls until later, when the open function is called (see <span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-BBCCGGBH">“Open”</a></span>). As a result, the cost of creating the user interface is not incurred unless a user actually displays the pane.</p><a name="//apple_ref/doc/uid/TP30000979-CH206-CIHHGGGD" title="Listing 5-9An initialize function"></a><p class="codesample"><strong>Listing 5-9&nbsp;&nbsp;</strong>An initialize function</p><div class="codesample"><table><tr><td scope="row"><pre>static OSStatus MyInitialize<span></span></pre></td></tr><tr><td scope="row"><pre>(<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPDEContext inContext,<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPDEFlags *flags,<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPDERef ref,<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    ControlRef userPane,<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    PMPrintSession session<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    MyContext context = (MyContext) inContext;<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    OSStatus result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    *flags = kPMPDENoFlags;<span></span></pre></td></tr><tr><td scope="row"><pre>    context->userPane = userPane;<span>// 5</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    result = MySync (<span></span></pre></td></tr><tr><td scope="row"><pre>        inContext, session, kSyncPaneFromTicket);<span>// 6</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 5-9</span> does:</p><ol class="ol"><li class="li"><p>The <code>ref</code> parameter is not used.</p></li><li class="li"><p>Receives a reference to a user pane created for you by the printing system. Later, you will embed the Carbon controls for your user interface into this user pane.</p></li><li class="li"><p>Receives a reference to a session object that contains information about the current printing session. Your printing dialog extension uses this parameter to gain access to a job ticket.</p></li><li class="li"><p>Casts the parameter to your context type. This is the same context you defined and passed back to the printing system in your prologue function.</p></li><li class="li"><p>Saves the pane reference for later use.</p></li><li class="li"><p>Calls the function described in <span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-TPXREF130">“Sync”</a></span> to initialize your settings. If the job ticket does not contain your settings, then default values are used.</p></li><li class="li"><p>Returns a result code to the caller. If your initialize function returns a non-zero result code, the printing system immediately calls your terminate function.</p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF130" title="Sync"></a><h4>Sync</h4><p>The sync function in a printing dialog extension maintains the correspondence between the settings in a custom pane and their recorded values in either the <code>PMPageFormat</code> or the <code>PMPrintSettings</code> ticket. </p><p>You can give your sync function any name you wish. You need to enter this name in the function table for the <code>PlugInIntfVTable</code> interface, as illustrated in <span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-BBCEAEAD">“Defining Function Tables.”</a></span></p><p>There are two possible ways to synchronize—update ticket from pane, or update pane from ticket. Because synchronization requires knowledge of your custom settings, the work is done in the custom functions <code>MySyncPaneFromTicket</code> and <code>MySyncTicketFromPane</code>. These two functions are described in <span class="content_text"><a href="../Custom/Custom.html#//apple_ref/doc/uid/TP30000979-CH207-TPXREF130">“Synchronizing User Settings With a Ticket.”</a></span></p><p><span class="content_text">Listing 5-10</span> implements a sync function that calls the appropriate custom sync function, based on the sync direction specified by the caller. Two parameters are passed to the custom function—the custom context described in <span class="content_text"><a href="../Custom/Custom.html#//apple_ref/doc/uid/TP30000979-CH207-CIHHEAGC">“Defining a Custom Context,”</a></span> and the printing session.</p><a name="//apple_ref/doc/uid/TP30000979-CH206-CIHIJCHI" title="Listing 5-10A sync function"></a><p class="codesample"><strong>Listing 5-10&nbsp;&nbsp;</strong>A sync function</p><div class="codesample"><table><tr><td scope="row"><pre>static OSStatus MySync<span></span></pre></td></tr><tr><td scope="row"><pre>(<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPDEContext inContext,<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPrintSession session,<span></span></pre></td></tr><tr><td scope="row"><pre>    Boolean syncDirection<span></span></pre></td></tr><tr><td scope="row"><pre>)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    MyContext context = (MyContext) inContext;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (syncDirection == kSyncPaneFromTicket) {<span></span></pre></td></tr><tr><td scope="row"><pre>        result = MySyncPaneFromTicket (context->customContext, session);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        result = MySyncTicketFromPane (context->customContext, session);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF131" title="Get Summary Text"></a><h4>Get Summary Text</h4><p>The summary function in a printing dialog extension provides the title and current value of each setting in its custom pane. The printing system displays this information in the Summary pane.</p><p>You can give this function any name you wish. You need to enter this name in the function table for the <code>PlugInIntfVTable</code> interface, as illustrated in <span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-BBCEAEAD">“Defining Function Tables.”</a></span></p><p><span class="content_text">Listing 5-11</span> implements a summary function that creates two summary arrays, calls the custom function <code>MyGetSummaryText</code> to fill them in, and then passes the arrays back to the printing system.</p><a name="//apple_ref/doc/uid/TP30000979-CH206-CIHHHAAJ" title="Listing 5-11A summary function"></a><p class="codesample"><strong>Listing 5-11&nbsp;&nbsp;</strong>A summary function</p><div class="codesample"><table><tr><td scope="row"><pre>static OSStatus MyGetSummary<span></span></pre></td></tr><tr><td scope="row"><pre>(<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPDEContext inContext,<span></span></pre></td></tr><tr><td scope="row"><pre>    CFArrayRef *titles,<span></span></pre></td></tr><tr><td scope="row"><pre>    CFArrayRef *values<span></span></pre></td></tr><tr><td scope="row"><pre>)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    MyContext context = (MyContext) inContext;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFMutableArrayRef titleArray = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFMutableArrayRef valueArray = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus result = kPMInvalidPDEContext;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    titleArray = CFArrayCreateMutable (<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>        kCFAllocatorDefault, 0, &amp;kCFTypeArrayCallBacks);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (titleArray != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        valueArray = CFArrayCreateMutable (<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>            kCFAllocatorDefault, 0, &amp;kCFTypeArrayCallBacks);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if (valueArray != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            result = MyGetSummaryText (<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>                context->customContext,<span></span></pre></td></tr><tr><td scope="row"><pre>                titleArray,<span></span></pre></td></tr><tr><td scope="row"><pre>                valueArray<span></span></pre></td></tr><tr><td scope="row"><pre>            );<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (result != noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        if (titleArray != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            CFRelease (titleArray);<span></span></pre></td></tr><tr><td scope="row"><pre>            titleArray = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        if (valueArray != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            CFRelease (valueArray);<span></span></pre></td></tr><tr><td scope="row"><pre>            valueArray = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    *titles = titleArray;<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    *values = valueArray;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 5-11</span> does:</p><ol class="ol"><li class="li"><p>Creates the mutable array <code>titleArray</code>. The second argument is zero to indicate that the array should not have a fixed size.</p><p>Core Foundation arrays may contain references to mixed types, but in this case the printing system assumes this is an array of strings.</p></li><li class="li"><p>Creates the mutable array <code>valueArray</code> with the same characteristics.</p></li><li class="li"><p>Calls a custom function that fills in <code>titleArray</code> and <code>valueArray</code> with strings that describe the current values of the settings in your pane.</p></li><li class="li"><p>Passes the arrays back to the printing system, which is responsible for releasing the arrays and their contents.</p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH206-BBCCGGBH" title="Open"></a><h4>Open</h4><p>When the dialog user displays your custom pane, the printing system calls your open function immediately before the pane becomes visible.</p><p>You can give this function any name you wish. You need to enter this name in the function table for the <code>PlugInIntfVTable</code> interface, as illustrated in <span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-BBCEAEAD">“Defining Function Tables.”</a></span></p><p><span class="content_text">Listing 5-12</span> implements an open function that constructs a custom nib-based interface inside a dialog pane, sets the default values of the controls in the interface, prepares the interface for display, and installs an event handler for the help button.</p><a name="//apple_ref/doc/uid/TP30000979-CH206-BBCFIIAC" title="Listing 5-12An open function"></a><p class="codesample"><strong>Listing 5-12&nbsp;&nbsp;</strong>An open function</p><div class="codesample"><table><tr><td scope="row"><pre>static OSStatus MyOpen (PMPDEContext inContext)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    MyContext context = (MyContext) inContext;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (!context->initialized)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        IBNibRef nib = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        result = CreateNibReferenceWithCFBundle (<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>            MyGetBundle(), <span>// 2</span></pre></td></tr><tr><td scope="row"><pre>            kMyNibFile,<span></span></pre></td></tr><tr><td scope="row"><pre>            &amp;nib<span></span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if (result == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            WindowRef nibWindow = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            result = CreateWindowFromNib (<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>                nib,<span></span></pre></td></tr><tr><td scope="row"><pre>                kMyNibWindow,<span></span></pre></td></tr><tr><td scope="row"><pre>                &amp;nibWindow<span></span></pre></td></tr><tr><td scope="row"><pre>            );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            if (result == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                result = MyEmbedCustomControls (<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>                    context->customContext,<span></span></pre></td></tr><tr><td scope="row"><pre>                    nibWindow,<span></span></pre></td></tr><tr><td scope="row"><pre>                    context->userPane<span></span></pre></td></tr><tr><td scope="row"><pre>                );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                if (result == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>                {<span></span></pre></td></tr><tr><td scope="row"><pre>                    context->initialized = TRUE;<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                DisposeWindow (nibWindow);<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            DisposeNibReference (nib);<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (context->initialized)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        result = MyInstallHelpEventHandler (<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>            GetControlOwner (context->userPane), <span>// 6</span></pre></td></tr><tr><td scope="row"><pre>            &amp;(context->helpHandler),<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>            &amp;(context->helpHandlerUPP)<span>// 8</span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 5-12</span> does:</p><ol class="ol"><li class="li"><p>Creates a nib object, using the nib file located inside the plug-in bundle for this printing dialog extension.</p></li><li class="li"><p>Calls a custom function that returns a reference to the plug-in bundle. For an implementation of this function, see the sample project.</p></li><li class="li"><p>Instantiates your nib-based interface in an offscreen Carbon window.</p></li><li class="li"><p>Calls a custom function that embeds your custom controls inside the dialog pane. For more information, see <span class="content_text"><a href="../Custom/Custom.html#//apple_ref/doc/uid/TP30000979-CH207-CACCEIEC">“Embedding Your Controls in a Dialog Pane.”</a></span></p></li><li class="li"><p>Calls a custom function that installs a Carbon event handler when your custom pane is visible. For more information, see <span class="content_text"><a href="../Utilities/Utilities.html#//apple_ref/doc/uid/TP30000979-CH209-TPXREF166">“Installing a Help Event Handler.”</a></span></p></li><li class="li"><p>Gets a reference to the dialog window.</p></li><li class="li"><p>Saves a reference to the event handler. You should remove the handler when the pane closes.</p></li><li class="li"><p>Saves the event handler UPP. You should deallocate the UPP when the event handler is removed.</p></li></ol><a name="//apple_ref/doc/uid/TP30000979-CH206-BBCJJHII" title="Close"></a><h4>Close</h4><p>The printing system pairs each call to the open function with a corresponding call to the close function—except when your pane is visible and the user cancels the dialog. The close function performs any necessary tasks when the printing system hides your pane.</p><p>You can give your close function any name you wish. You need to enter this name in the function table for the <code>PlugInIntfVTable</code> interface, as illustrated in <span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-BBCEAEAD">“Defining Function Tables.”</a></span></p><p><span class="content_text">Listing 5-13</span> implements a close function that removes the help event handler installed in <span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-BBCCGGBH">“Open.”</a></span></p><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF163" title="Listing 5-13A close function"></a><p class="codesample"><strong>Listing 5-13&nbsp;&nbsp;</strong>A close function</p><div class="codesample"><table><tr><td scope="row"><pre>static OSStatus MyClose (PMPDEContext inContext)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    MyContext context = (MyContext) inContext;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    result = MyRemoveHelpEventHandler (<span></span></pre></td></tr><tr><td scope="row"><pre>        &amp;(context->helpHandler),<span></span></pre></td></tr><tr><td scope="row"><pre>        &amp;(context->helpHandlerUPP)<span></span></pre></td></tr><tr><td scope="row"><pre>    );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000979-CH206-TPXREF134" title="Terminate"></a><h4>Terminate</h4><p>The printing system calls the terminate function when the dialog is dismissed for any reason, or when the user changes the destination printer. The terminate function performs necessary clean-up tasks, such as releasing resources and deallocating memory.</p><p>You can give this function any name you wish. You need to enter this name in the function table for the <code>PlugInIntfVTable</code> interface, as described in <span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-BBCEAEAD">“Defining Function Tables.”</a></span></p><p><span class="content_text">Listing 5-14</span> implements a terminate function that frees the two contexts allocated in the prologue function, described in <span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-TPXREF128">“Prologue.”</a></span></p><a name="//apple_ref/doc/uid/TP30000979-CH206-CIHDHIDD" title="Listing 5-14A terminate function"></a><p class="codesample"><strong>Listing 5-14&nbsp;&nbsp;</strong>A terminate function</p><div class="codesample"><table><tr><td scope="row"><pre>static OSStatus MyTerminate (<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPDEContext inContext,<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus inStatus<span></span></pre></td></tr><tr><td scope="row"><pre>)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    MyContext context = (MyContext) inContext;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (context != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        result = MyRemoveHelpEventHandler (<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>            &amp;(context->helpHandler),<span></span></pre></td></tr><tr><td scope="row"><pre>            &amp;(context->helpHandlerUPP)<span></span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if (context->customContext != NULL) {<span></span></pre></td></tr><tr><td scope="row"><pre>            MyReleaseCustomContext (context->customContext);<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        free (context);<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 5-14</span> does:</p><ol class="ol"><li class="li"><p>Removes the help event handler if it’s still installed. For more information, see <span class="content_text"><a href="../Utilities/Utilities.html#//apple_ref/doc/uid/TP30000979-CH209-TPXREF166">“Installing a Help Event Handler.”</a></span></p></li><li class="li"><p>Releases your custom context. For more information, see <span class="content_text"><a href="../Custom/Custom.html#//apple_ref/doc/uid/TP30000979-CH207-CIHHEAGC">“Defining a Custom Context.”</a></span></p></li><li class="li"><p>Frees memory allocated for the context. For more information about contexts, see<span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-CIHHEAGC">“Defining a Context”</a></span> and <span class="content_text"><a href="Core.html#//apple_ref/doc/uid/TP30000979-CH206-TPXREF128">“Prologue.”</a></span></p></li></ol>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../Project/Project.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../Custom/Custom.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2002, 2006 Apple Computer, Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2006-10-03<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Printing/Conceptual/ExtPrintingDialogs/Core/Core.html%3Fid%3DTP30000979-2.2&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Printing/Conceptual/ExtPrintingDialogs/Core/Core.html%3Fid%3DTP30000979-2.2&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Printing/Conceptual/ExtPrintingDialogs/Core/Core.html%3Fid%3DTP30000979-2.2&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>