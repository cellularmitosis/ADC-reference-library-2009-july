<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>Embedding Instruments - /MusicHelper.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxQuickTime-date.html">QuickTime</a> &gt; <A HREF="javascript:location.replace('index.html');">Embedding Instruments</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/QuickTime/index.html" target="_blank">Reference Library > QuickTime</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">Embedding Instruments</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/MusicHelper.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/BigEasy/BigEasy2.c</option>
<option value="listing2.html">/BigEasy/BigEasy2.h</option>
<option value="listing3.html">/BigEasy/BigEasyControls.c</option>
<option value="listing4.html">/BigEasy/BigEasyControls.h</option>
<option value="listing5.html">/BigEasy/BigEasyDialogs.c</option>
<option value="listing6.html">/BigEasy/BigEasyDialogs.h</option>
<option value="listing7.html">/BigEasy/BigEasyGestalt.c</option>
<option value="listing8.html">/BigEasy/BigEasyGestalt.h</option>
<option value="listing9.html">/BigEasy/BigEasyGrafish.c</option>
<option value="listing10.html">/BigEasy/BigEasyGrafish.h</option>
<option value="listing11.html">/BigEasy/BigEasyPPC.c</option>
<option value="listing12.html">/BigEasy/BigEasyPPC.h</option>
<option value="listing13.html">/BigEasy/BigEasyStandardControls.c</option>
<option value="listing14.html">/BigEasy/BigEasyStandardControls.h</option>
<option value="listing15.html">/BigEasy/BigEasyTextish.c</option>
<option value="listing16.html">/BigEasy/BigEasyTextish.h</option>
<option value="listing17.html">/BigEasy/BigEasyUtils.c</option>
<option value="listing18.html">/BigEasy/BigEasyUtils.h</option>
<option value="listing19.html">/BigEasy/IconUtilsPriv.h</option>
<option value="listing20.html">/BigEasy/NWindows.c</option>
<option value="listing21.html">/BigEasy/OneWindow.c</option>
<option value="listing22.html">/FlatInstrumentTest.c</option>
<option value="listing23.html">/FlatInstrumentTest.h</option>
<option value="listing24.html">/MusicHelper.c</option>
<option value="listing25.html">/MusicHelper.h</option>
<option value="listing26.html">/TuneGeneration2.0.c</option></select>
				</p>
				</form>
				<p><strong><a href="Embedding_Instruments.zip">Download Sample</a></strong> (&#147;Embedding_Instruments.zip&#148;, 84.3K)<BR>
<strong><a href="Embedding_Instruments.dmg">Download Sample</a></strong> (&#147;Embedding_Instruments.dmg&#148;, 147.7K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">#include &lt;types.h&gt;#include &lt;QuickTimeComponents.h&gt;#define _MusicHelperC_#define kFullVolume 256typedef struct  {  short partCount;  ToneDescription **toneDescriptions;  FlatInstrument ***flatInstruments;  long tuneSize;  long tuneHandleSize;  unsigned long **tune;  } MusicScoreRecord, **MusicScore;typedef struct  {  Movie mo;  Track tr;  Media me;  MusicDescriptionHandle mdH;  TimeValue duration;  short refNum;  } MusicMovieRecord, **MusicMovie;#include &quot;MusicHelper.h&quot;#define kTuneHandleBump 1024static void StuffToneDescription(short gmNumber,ToneDescription *td);static void BumpTuneHandleSize(MusicScoreRecord *msr);static short InternalAddPart(MusicScore ms,ToneDescription *td,FlatInstrument *flat);#define hLock(x) HLock((Handle)(x))#define hUnlock(x) HUnlock((Handle)(x))MusicScore NewMusicScore(void)  {  MusicScoreRecord *msr;  MusicScore ms;  ms = (MusicScore)NewHandle(sizeof(MusicScoreRecord));  hLock(ms);  msr = *ms;  msr-&gt;partCount= 0;  msr-&gt;toneDescriptions = (ToneDescription **)NewHandle(0);  msr-&gt;flatInstruments = (FlatInstrument ***)NewHandle(0);  msr-&gt;tuneSize = 0;  msr-&gt;tuneHandleSize = kTuneHandleBump;  msr-&gt;tune = (unsigned long**)NewHandle(kTuneHandleBump * sizeof(long));  hUnlock(ms);  return ms;  }void DisposeMusicScore(MusicScore *ms)  {  MusicScoreRecord *msr;  hLock(*ms);  msr = **ms;  DisposeHandle((Handle)msr-&gt;toneDescriptions);  DisposeHandle((Handle)msr-&gt;tune);  *ms = nil;  }short AddMusicScoreGMInstrument(MusicScore ms,short gmInstrument)  {  ToneDescription td;  StuffToneDescription(gmInstrument,&amp;td);  return AddMusicScoreInstrument(ms,&amp;td);  }short AddMusicScoreInstrument(MusicScore ms,ToneDescription *td)  {  return InternalAddPart(ms,td,nil);  }short AddMusicScoreFlatInstrument(MusicScore ms,FlatInstrument *flat)  {  return InternalAddPart(ms,&amp;flat-&gt;tone,flat);  }short InternalAddPart(MusicScore ms,ToneDescription *td,FlatInstrument *flat)  {  MusicScoreRecord *msr;  hLock(ms);  msr = *ms;  msr-&gt;partCount++;  SetHandleSize((Handle)msr-&gt;toneDescriptions,msr-&gt;partCount * sizeof(ToneDescription));  SetHandleSize((Handle)msr-&gt;flatInstruments,msr-&gt;partCount * sizeof(FlatInstrument *));  (*msr-&gt;toneDescriptions)[msr-&gt;partCount-1] = *td;  (*msr-&gt;flatInstruments)[msr-&gt;partCount-1] = flat;  hUnlock(ms);  return msr-&gt;partCount;  }void AddMusicScoreNote(MusicScore ms,short part,Fixed pitch,long velocity,TimeValue noteDuration)  {  MusicScoreRecord *msr;  unsigned long *w;  hLock(ms);  msr = *ms;    part--;  BumpTuneHandleSize(msr);  HLock((Handle)msr-&gt;tune);  w = *(msr-&gt;tune) + msr-&gt;tuneSize;  if(pitch &gt;= 32 &amp;&amp; pitch &lt;= 95 &amp;&amp; part &lt; 32      &amp;&amp; noteDuration &lt; 2048)    {    _StuffNoteEvent(*w,part,pitch,velocity,noteDuration);    msr-&gt;tuneSize ++;    }  else    {    _StuffXNoteEvent(*w,*(w+1),part,pitch,velocity,noteDuration);    msr-&gt;tuneSize += 2;    }  hUnlock(msr-&gt;tune);  hUnlock(ms);  }void AddMusicScoreRest(MusicScore ms,TimeValue restDuration)  {  MusicScoreRecord *msr;  unsigned long *w;  hLock(ms);  msr = *ms;  BumpTuneHandleSize(msr);  HLock((Handle)msr-&gt;tune);  w = *(msr-&gt;tune) + msr-&gt;tuneSize;  _StuffRestEvent(*w,restDuration);  msr-&gt;tuneSize ++;  hUnlock(msr-&gt;tune);  hUnlock(ms);  }#define kNoteRequestMessageSize sizeof(NoteRequest)/4 + 2Handle GetMusicScoreHeader(MusicScore ms)  {  Handle h;  unsigned long *w;  long size;  NoteRequest *nr;  FlatInstrument *flat;  MusicScoreRecord *msr;  int i;  hLock(ms);  msr = *ms;  size = msr-&gt;partCount*(8 + sizeof(NoteRequest))      + 4; /* 8 bytes for general music message,             + 4 for end marker */  for(i = 0; i &lt; msr-&gt;partCount; i++)    {    flat = (*msr-&gt;flatInstruments)[i];    if(flat)      size += flat-&gt;size;    }  h = NewHandleClear(size);  w = (unsigned long *)*h;  for(i = 0; i &lt; msr-&gt;partCount; i++)    {    flat = (*msr-&gt;flatInstruments)[i];    if(flat)      {      size = kNoteRequestMessageSize + (flat-&gt;size + 3)/4;      _StuffGeneralEvent(*w,*(w + size - 1),          i,kGeneralEventFlatInstrument,size);      nr = (NoteRequest *)(w + 1);        nr-&gt;polyphony = 1;      nr-&gt;typicalPolyphony = 0x10000;        nr-&gt;tone = (*msr-&gt;toneDescriptions)[i];      BlockMove(&amp;flat-&gt;size,((char *)&amp;nr-&gt;tone) + sizeof(ToneDescription),flat-&gt;size);        w += size;      }    else      {      _StuffGeneralEvent(*w,*(w + kNoteRequestMessageSize - 1),          i,kGeneralEventNoteRequest,kNoteRequestMessageSize);      nr = (NoteRequest *)(w + 1);        nr-&gt;polyphony = 1;      nr-&gt;typicalPolyphony = 0x10000;        nr-&gt;tone = (*msr-&gt;toneDescriptions)[i];        w += kNoteRequestMessageSize;      }    }  *w++ = 0x60000000;            /* end marker */  hUnlock(ms);  return h;  }Handle GetMusicScoreScore(MusicScore ms)  {  Handle h;  MusicScoreRecord *msr;  unsigned long *w;  long size;  hLock(ms);  msr = *ms;  size = msr-&gt;tuneSize * sizeof(unsigned long) + 4;  msr = *ms;  h = NewHandle(size);  BlockMove(*msr-&gt;tune, *h, size);  (*(unsigned long **)h)[msr-&gt;tuneSize] = 0x60000000;  hUnlock(ms);  return h;  }void StuffToneDescription(short gmNumber,ToneDescription *td)  {  ComponentResult result;  NoteAllocator na;  na = OpenDefaultComponent('nota',0);  if(na)    {    NAStuffToneDescription(na,gmNumber,td);    CloseComponent(na);    }  else    {    td-&gt;synthesizerType = 0;    td-&gt;synthesizerName[0] = 0;    td-&gt;instrumentName[0] = 0;    td-&gt;instrumentNumber = 0;    td-&gt;gmNumber = gmNumber;    }  }#define kTuneSizeMargin 16void BumpTuneHandleSize(MusicScoreRecord *msr)  {  if(msr-&gt;tuneHandleSize - msr-&gt;tuneSize &lt; kTuneSizeMargin)    {    msr-&gt;tuneHandleSize += kTuneHandleBump;    SetHandleSize((Handle)msr-&gt;tune,msr-&gt;tuneHandleSize * sizeof(unsigned long));    }  }MusicMovie StartMusicMovie(FSSpec *movieSpec,Handle header)  {  MusicMovie mm;  MusicMovieRecord *mmr;  ComponentResult thisError;  unsigned long size;  EnterMovies();  mm = (MusicMovie)NewHandle(sizeof(MusicMovieRecord));  hLock(mm);  mmr = *mm;  thisError = CreateMovieFile(movieSpec,'TVOD',0,       createMovieFileDeleteCurFile,       &amp;mmr-&gt;refNum,       &amp;mmr-&gt;mo);   SetMoviePreferredVolume(mmr-&gt;mo,kFullVolume);   SetMovieVolume(mmr-&gt;mo,kFullVolume);  mmr-&gt;tr = NewMovieTrack(mmr-&gt;mo,0,0,kFullVolume);  mmr-&gt;me = NewTrackMedia(mmr-&gt;tr,kMusicComponentType,600,0,0);  thisError = GetMoviesError();  size = sizeof(MusicDescription) + GetHandleSize(header);  mmr-&gt;mdH = (void *)NewHandleClear(size);// *** ???  (**mmr-&gt;mdH).size = size;// *** ???  (**mmr-&gt;mdH).type = 'musi';  BlockMove(*header,&amp;(**mmr-&gt;mdH).headerData,GetHandleSize(header));  mmr-&gt;duration = 0;  thisError = BeginMediaEdits(mmr-&gt;me);  hUnlock(mm);  return mm;  }void AddMusicMovieSample(MusicMovie mm,Handle score)  {  MusicMovieRecord *mmr;  ComponentResult thisError;  TimeValue sampleDuration;  unsigned long sampleLength;  hLock(mm);  mmr = *mm;  // * Compute duration of tune    {    unsigned long *start,*w,*end;    unsigned long eventType,eventLength;    unsigned long x;    start = (unsigned long *)*score;    end = (unsigned long *)( ((char *)*score) + GetHandleSize(score));    w = start;    sampleDuration = 0;    while(w &lt; end)      {      x = *w;      eventLength = _EventLength(x);      eventType = _EventType(x);      if(eventType == kRestEventType)        sampleDuration += _RestDuration(x);      if(eventLength &lt; 1 || eventLength &gt; 1000)        goto done;      w += eventLength;      }done:    sampleLength = (w - start) * sizeof(unsigned long);    }  thisError = AddMediaSample(mmr-&gt;me,score,0,sampleLength,      sampleDuration,(void *)mmr-&gt;mdH,      1,0,0);  mmr-&gt;duration += sampleDuration;  hUnlock(mm);  }void FinishMusicMovie(MusicMovie *mm)  {  MusicMovieRecord *mmr;  ComponentResult thisError;  hLock(*mm);  mmr = **mm;  thisError = InsertMediaIntoTrack(mmr-&gt;tr,0,0,mmr-&gt;duration,(1L&lt;&lt;16));  thisError = EndMediaEdits(mmr-&gt;me);   thisError = AddMovieResource(mmr-&gt;mo,mmr-&gt;refNum,nil,nil);  thisError = CloseMovieFile(mmr-&gt;refNum);  DisposeHandle((Handle)*mm);  *mm = 0;  ExitMovies();  }</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/Embedding_Instruments/listing24.html%3Fid%3DDTS10000321-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/Embedding_Instruments/listing24.html%3Fid%3DDTS10000321-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/Embedding_Instruments/listing24.html%3Fid%3DDTS10000321-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>