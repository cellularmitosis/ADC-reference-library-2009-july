<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Summary of the Mixed Mode Manager (IM: PS)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING39></A>



<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="PPCSoftware-38.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="PPCSoftware-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="PPCSoftware-86.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="PPCSoftware-40.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="PPCSoftware-2.html"><B>PowerPC System Software</B></A> / <BR><DD><A HREF="PPCSoftware-17.html"><B>Chapter 2 - Mixed Mode Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING39-0></A>
<H1>Summary of the Mixed Mode Manager</H1>
<A NAME=HEADING39-1></A>
<H2>C Summary</H2>
<A NAME=HEADING39-2></A>
<H3>Constants</H3>
<PRE>
/*Gestalt selector and response bits*/
#define gestaltMixedModeAttr     'mixd'   /*Mixed Mode Mgr attributes*/
enum {
   gestaltPowerPCAware           = 0      /*true if MMMgr supports PowerPC*/
};
enum {
   /*current version of RoutineDescriptor data type*/
   kRoutineDescriptorVersion     = 7
};
</PRE>
<A NAME=HEADING39-5></A>
<H4>Routine Flags</H4>
<PRE>
enum {
   kProcDescriptorIsAbsolute     = (RoutineFlagsType)0x00,
   kProcDescriptorIsRelative     = (RoutineFlagsType)0x01
};
enum {
   kFragmentIsPrepared           = (RoutineFlagsType)0x00,
   kFragmentNeedsPreparing       = (RoutineFlagsType)0x02
};
enum {
   kUseCurrentISA                = (RoutineFlagsType)0x00,
   kUseNativeISA                 = (RoutineFlagsType)0x04
};
enum {
   kPassSelector                 = (RoutineFlagsType)0x00,
   kDontPassSelector             = (RoutineFlagsType)0x08
};
enum {
   kRoutineIsNotDispatchedDefaultRoutine
                                 = (RoutineFlagsType)0x00,
   kRoutineIsDispatchedDefaultRoutine
                                 = (RoutineFlagsType)0x10
};
</PRE>
<A NAME=HEADING39-11></A>
<H4>Instruction Set Architectures</H4>
<PRE>
enum {
   kM68kISA                      = (ISAType)0,     /*MC680x0 architecture*/
   kPowerPCISA                   = (ISAType)1      /*PowerPC architecture*/
};
</PRE>
<A NAME=HEADING39-13></A>
<H4>Routine Descriptor Flags</H4>
<PRE>
enum {
   kSelectorsAreNotIndexable     = (RDFlagsType)0x00,
   kSelectorsAreIndexable        = (RDFlagsType)0x01
};
</PRE>
<A NAME=HEADING39-15></A>
<H4>Procedure Information</H4>
<PRE>
enum {
   /*size codes*/
   kNoByteCode                   = 0,
   kOneByteCode                  = 1,
   kTwoByteCode                  = 2,
   kFourByteCode                 = 3
};
/*offsets to and widths of procedure information fields*/
#define kCallingConventionPhase                       0
#define kCallingConventionWidth                       4
#define kResultSizePhase                              kCallingConventionWidth
#define kResultSizeWidth                              2
#define kResultSizeMask                               0x30
#define kStackParameterPhase                          6
#define kStackParameterWidth                          2
#define kRegisterResultLocationPhase                  \
                           (kCallingConventionWidth + kResultSizeWidth)
#define kRegisterResultLocationWidth                  5


#define kRegisterParameterPhase                       \
                           (kCallingConventionWidth + kResultSizeWidth + \
                              kRegisterResultLocationWidth)
#define kRegisterParameterWidth                       5
#define kRegisterParameterWhichPhase                  2
#define kRegisterParameterSizePhase                   0
#define kDispatchedSelectorSizeWidth                  2
#define kDispatchedSelectorSizePhase                  \
                           (kCallingConventionWidth + kResultSizeWidth)
#define kDispatchedParameterPhase                     \
                           (kCallingConventionWidth + kResultSizeWidth + \
                              kDispatchedSelectorSizeWidth)
enum {
   /*calling conventions*/
   kPascalStackBased                   = (CallingConventionType)0,
   kCStackBased                        = (CallingConventionType)1,
   kRegisterBased                      = (CallingConventionType)2,
   kThinkCStackBased                   = (CallingConventionType)5,
   kD0DispatchedPascalStackBased       = (CallingConventionType)8,
   kD0DispatchedCStackBased            = (CallingConventionType)9,
   kD1DispatchedPascalStackBased       = (CallingConventionType)12,
   kStackDispatchedPascalStackBased    = (CallingConventionType)14,
   kSpecialCase                        = (CallingConventionType)15
};
enum {
   /*special cases*/
   kSpecialCaseHighHook          = 0,
   kSpecialCaseCaretHook         = kSpecialCaseHighHook,
   kSpecialCaseEOLHook           = 1,
   kSpecialCaseWidthHook         = 2,
   kSpecialCaseNWidthHook        = 3,
   kSpecialCaseTextWidthHook     = kSpecialCaseWidthHook,
   kSpecialCaseDrawHook          = 4,
   kSpecialCaseHitTestHook       = 5,
   kSpecialCaseTEFindWord        = 6,
   kSpecialCaseProtocolHandler   = 7,
   kSpecialCaseSocketListener    = 8,
   kSpecialCaseTERecalc          = 9,
   kSpecialCaseTEDoText          = 10,
   kSpecialCaseGNEFilterProc     = 11,
   kSpecialCaseMBarHook          = 12
};
enum {
   /*680x0 registers*/
   kRegisterD0                   = 0,
   kRegisterD1                   = 1,
   kRegisterD2                   = 2,
   kRegisterD3                   = 3,
   kRegisterD4                   = 8,
   kRegisterD5                   = 9,
   kRegisterD6                   = 10,
   kRegisterD7                   = 11,
   kRegisterA0                   = 4,
   kRegisterA1                   = 5,
   kRegisterA2                   = 6,
   kRegisterA3                   = 7,
   kRegisterA4                   = 12,
   kRegisterA5                   = 13,
   kRegisterA6                   = 14,
   kCCRegisterCBit               = 16,
   kCCRegisterVBit               = 17,
   kCCRegisterZBit               = 18,
   kCCRegisterNBit               = 19,
   kCCRegisterXBit               = 20
};
</PRE>
<A NAME=HEADING39-21></A>
<H3><A NAME=MARKER-10-366></A>Data Types</H3>
<PRE>
typedef unsigned char ISAType;            /*instruction set architecture*/
typedef unsigned short CallingConventionType;   /*calling convention*/
typedef unsigned long ProcInfoType;       /*procedure information*/
typedef unsigned short RegisterSelectorType;
typedef unsigned short RoutineFlagsType;
struct RoutineRecord {
   ProcInfoType         procInfo;         /*calling conventions*/
   unsigned char        reserved1;        /*reserved*/
   ISAType              ISA;              /*instruction set architecture*/
   RoutineFlagsType     routineFlags;     /*flags for each routine*/
   ProcPtr              procDescriptor;   /*the thing we're calling*/
   unsigned long        reserved2;        /*reserved*/
   unsigned long        selector;         /*selector for dispatched calls*/
};
typedef struct RoutineRecord RoutineRecord;
typedef RoutineRecord *RoutineRecordPtr, **RoutineRecordHandle;
typedef unsigned char RDFlagsType;        /*routine descriptor flags*/
struct RoutineDescriptor {
   unsigned short       goMixedModeTrap;  /*mixed-mode A-trap*/
   char                 version;          /*routine descriptor version*/
   RDFlagsType          routineDescriptorFlags;
                                          /*routine descriptor flags*/
   unsigned long        reserved1;        /*reserved*/
   unsigned char        reserved2;        /*reserved*/
   unsigned char        selectorInfo;     /*selector information*/
   short                routineCount;     /*index of last RR in this RD*/
   RoutineRecord        routineRecords[1];/*the individual routines*/
};
typedef struct RoutineDescriptor RoutineDescriptor;
typedef RoutineDescriptor *UniversalProcPtr, **UniversalProcHandle;
typedef RoutineDescriptor *RoutineDescriptorPtr, **RoutineDescriptorHandle;
</PRE>
<A NAME=HEADING39-30></A>
<H3>Mixed Mode Manager Routines</H3>
<A NAME=HEADING39-31></A>
<H4>Creating and Disposing of Routine Descriptors</H4>
<PRE>
pascal UniversalProcPtr NewRoutineDescriptor
                  (ProcPtr theProc, ProcInfoType theProcInfo, ISAType theISA);
pascal UniversalProcPtr NewFatRoutineDescriptor
                  (ProcPtr theM68kProc, ProcPtr thePowerPCProc, 
                   ProcInfoType theProcInfo);
pascal void DisposeRoutineDescriptor
                  (UniversalProcPtr theProcPtr);
</PRE>
<A NAME=HEADING39-38></A>
<H4>Calling Routines via Universal Procedure Pointers</H4>
<PRE>
long CallUniversalProc  (UniversalProcPtr theProcPtr, 
                         ProcInfoType theProcInfo, ...);
long CallOSTrapUniversalProc
                        (UniversalProcPtr theProcPtr, 
                         ProcInfoType theProcInfo, ...);
</PRE>
<A NAME=HEADING39-42></A>
<H4>Determining Instruction Set Architectures</H4>
<PRE>
ISAType GetCurrentISA   (void);
</PRE>
<A NAME=HEADING39-44></A>
<H4><A NAME=MARKER-10-367></A><A NAME=MARKER-9-368></A>C Language Macros for Defining Procedure Information</H4>
<PRE>
#define SIZE_CODE(size) (((size) == 4) ? kFourByteCode : \
   (((size) == 2) ? kTwoByteCode : (((size) == 1) ? kOneByteCode : 0)))
#define RESULT_SIZE(sizeCode) ((ProcInfoType)(sizeCode) &lt;&lt; kResultSizePhase)
#define STACK_ROUTINE_PARAMETER(whichParam, sizeCode) \
   ((ProcInfoType)(sizeCode) &lt;&lt; (kStackParameterPhase + \
                  (((whichParam) - 1) * kStackParameterWidth)))
#define DISPATCHED_STACK_ROUTINE_PARAMETER(whichParam, sizeCode) \
   ((ProcInfoType)(sizeCode) &lt;&lt; (kDispatchedParameterPhase + \
                  (((whichParam) - 1) * kStackParameterWidth)))
#define DISPATCHED_STACK_ROUTINE_SELECTOR_SIZE(sizeCode) \
   ((ProcInfoType)(sizeCode) &lt;&lt; kDispatchedSelectorSizePhase)
#define REGISTER_RESULT_LOCATION(whichReg) \
   ((ProcInfoType)(whichReg) &lt;&lt; kRegisterResultLocationPhase)
#define REGISTER_ROUTINE_PARAMETER(whichParam, whichReg, sizeCode) \
   ((((ProcInfoType)(sizeCode) &lt;&lt; kRegisterParameterSizePhase) | \
   ((ProcInfoType)(whichReg) &lt;&lt; kRegisterParameterWhichPhase)) &lt;&lt; \
   (kRegisterParameterPhase + (((whichParam)- 1) * kRegisterParameterWidth)))
#define SPECIAL_CASE_PROCINFO(specialCaseCode) \
   (kSpecialCase | ((ProcInfoType)(specialCaseCode) &lt;&lt; 4))
</PRE>
 <A NAME=MARKER-2-144></A><A NAME=MARKER-2-84></A><A NAME=MARKER-2-371></A><A NAME=MARKER-2-372></A><A NAME=MARKER-2-373></A><A NAME=MARKER-2-374></A><A NAME=MARKER-2-375></A><P>
</BLOCKQUOTE><P>

</BLOCKQUOTE>
<HR>
<center>
<A HREF="PPCSoftware-38.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="PPCSoftware-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="PPCSoftware-86.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="PPCSoftware-40.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="PPCSoftware-3.html">&copy; Apple Computer, Inc.</A><br>3 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
