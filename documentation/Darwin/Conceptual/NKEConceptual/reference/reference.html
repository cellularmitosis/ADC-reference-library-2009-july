<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Network Kernel Extensions Programming Guide: Network Kernel Extensions Reference</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Network Kernel Extensions Reference"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP40001858-CH232" title="Network Kernel Extensions Reference"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000422" target="_top">Darwin</a> &gt; <a href="../../../Kernel-date.html#//apple_ref/doc/uid/TP30000440-TP30000422-TP30000532" target="_top">Kernel</a> &gt; <a href="../intro/intro.html#//apple_ref/doc/uid/TP40001858-CH225-DontLinkElementID_68">Network Kernel Extensions Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../interface_nke/interface_nke.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../glossary/glossary.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP40001858-CH232-DontLinkElementID_72" title="Network Kernel Extensions Reference"></a><h1>Network Kernel Extensions Reference</h1><p>The document <em><a href="../../../Reference/KPI_Reference/index.html#//apple_ref/doc/uid/TP40001274" target="_top">KPI Reference</a></em> describes the functions that NKEs can call and describes a few NKE-specific data types. They are organized by header file. This chapter includes a few additional APIs that may be useful when writing an NKE.</p><ul class="ul"><li class="li"><p><span class="content_text"><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-BBAGEJJJ">“Kernel Utilities”</a></span> lists some kernel utilities that NKEs can call.</p></li><li class="li"><p><code><a href="../../../Reference/KPI_Reference/kpi_interface/index.html#//apple_ref/doc/header/kpi_interface.h" target="_top">kpi_interface.h</a></code> includes functions for manipulating network interfaces, including packet injection, attaching/detaching protocols, attaching/detaching interfaces, and so on.</p></li><li class="li"><p><code><a href="../../../Reference/KPI_Reference/kpi_interfacefilter/index.html#//apple_ref/doc/header/kpi_interfacefilter.h" target="_top">kpi_interfacefilter.h</a></code> includes functions for filtering at the raw packet level, just above the network interface layer. These functions are appropriate for an interface filter.</p></li><li class="li"><p><code><a href="../../../Reference/KPI_Reference/kpi_ipfilter/index.html#//apple_ref/doc/header/kpi_ipfilter.h" target="_top">kpi_ipfilter.h</a></code> includes functions for attaching a packet filter for IPv4 or IPv6 packets. These functions are appropriate for a KEXT that filters IP traffic.</p></li><li class="li"><p><code><a href="../../../Reference/KPI_Reference/kpi_mbuf/index.html#//apple_ref/doc/header/kpi_mbuf.h" target="_top">kpi_mbuf.h</a></code> includes functions for manipulating mbuf data structures. These are used heavily for passing packets and packet fragments around throughout the protocol stack.</p></li><li class="li"><p><code><a href="../../../Reference/KPI_Reference/kpi_protocol/index.html#//apple_ref/doc/header/kpi_protocol.h" target="_top">kpi_protocol.h</a></code> includes functions for packet injection. It also includes functions to register “plumbers”—handlers that deal with requests for attaching a protocol to an interface (and detaching, and so on).</p></li><li class="li"><p><code><a href="../../../Reference/KPI_Reference/kpi_socket/index.html#//apple_ref/doc/header/kpi_socket.h" target="_top">kpi_socket.h</a></code> includes functions for manipulating a socket, including packet send/receive and flag manipulation.</p></li><li class="li"><p><code><a href="../../../Reference/KPI_Reference/kpi_socketfilter/index.html#//apple_ref/doc/header/kpi_socketfilter.h" target="_top">kpi_socketfilter.h</a></code> includes functions and data type definitions for creating a socket filter.</p></li></ul><a name="//apple_ref/doc/uid/TP40001858-CH232-BBAGEJJJ" title="Kernel Utilities"></a><h2>Kernel Utilities</h2><p>NKEs can call a number of kernel utility functions including the following:</p><ul class="ul"><li class="li"><p><code><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-BBAGGGED">“_MALLOC”</a></code></p></li><li class="li"><p><code><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-BBAHFHIC">“_FREE”</a></code></p></li><li class="li"><p><code><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-BBAHDHAG">“printf”</a></code></p></li><li class="li"><p><code><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-CIAGGEDF">“proc_exiting”</a></code></p></li><li class="li"><p><code><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-CIADHGCA">“proc_is64bit”</a></code></p></li><li class="li"><p><code><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-CIAFBAAG">“proc_rele”</a></code></p></li><li class="li"><p><code><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-CIAFBBBG">“proc_self”</a></code></p></li><li class="li"><p><code><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-BBAGIEGI">“proc_suser”</a></code></p></li><li class="li"><p><code><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-BBACFIFE">“msleep”</a></code></p></li><li class="li"><p><code><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-BBACBGFG">“wakeup”</a></code></p></li><li class="li"><p><code><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-CIAJIJFF">“wakeup_one”</a></code></p></li></ul><p>This list does not attempt to be exhaustive, but highlights many of the more frequently-used utility functions.</p><a name="//apple_ref/doc/uid/TP40001858-CH232-BBAGGGED" title="_MALLOC"></a><h3>_MALLOC</h3><p>Defined in: <code>&lt;sys/malloc.h></code></p><p>Allocates kernel memory.</p><div class="codesample"><table><tr><td scope="row"><pre>    void *_MALLOC(size_t size, int type, int flags);<span></span></pre></td></tr></table></div><p><code><!--a-->_MALLOC<!--/a--></code> is much like the user-space <code><!--a-->malloc<!--/a--></code> function, but it has additional parameters that require some explanation.</p><p>The <code>types</code> argument is a number representing the type of data that will be stored in the argument. This is used primarily for accounting purposes. The known types are described in <code>&lt;sys/malloc.h></code>.</p><p>The flags argument consists of some combination of <code><!--a  -->M_WAITOK<!--/a--></code>, <code><!--a  -->M_NOWAIT<!--/a--></code>, and <code><!--a  -->M_ZERO<!--/a--></code>.</p><p>The flag <code><!--a  -->M_NOWAIT<!--/a--></code> causes <code><!--a-->_MALLOC<!--/a--></code> to immediately return a null pointer if no space is available rather than waiting for space to become available. While this is appropriate for time-sensitive tasks that can be retried, it is not always what you want.</p><p>The more traditional (and default) behavior is <code><!--a  -->M_WAITOK<!--/a--></code>, which indicates that it is safe to wait for space to become available. If your code is in a critical path for performance, you should probably use <code><!--a  -->M_NOWAIT<!--/a--></code> if possible, and depend on the networking stack to retry after resources become available.</p><p>Finally, the flag <code><!--a  -->M_ZERO<!--/a--></code> requests that the allocator should zero the resulting allocation before returning it.</p><a name="//apple_ref/doc/uid/TP40001858-CH232-BBAHFHIC" title="_FREE"></a><h3>_FREE</h3><p>Defined in: <code>&lt;sys/malloc.h></code></p><p>Frees memory allocated with <code><!--a-->_MALLOC<!--/a--></code></p><div class="codesample"><table><tr><td scope="row"><pre>    void _FREE(void *addr, int type);<span></span></pre></td></tr></table></div><p>The <code>type</code> flag passed to <code><!--a-->_FREE<!--/a--></code> must be the same as the flag passed to the corresponding call to <code><!--a-->_MALLOC<!--/a--></code>.</p><a name="//apple_ref/doc/uid/TP40001858-CH232-BBAHDHAG" title="printf"></a><h3>printf</h3><p>Defined in: <code>&lt;libkern/libkern.h></code></p><p>Print text to the console.</p><div class="codesample"><table><tr><td scope="row"><pre>    void printf(const char *format, ... );<span></span></pre></td></tr></table></div><p>Identical to <code><!--a-->printf<!--/a--></code> in user space. It is not safe to call <code><!--a-->printf<!--/a--></code> from within an interrupt context. This should generally not be an issue, as you should avoid calling NKE functions from within an I/O Kit driver’s filter routine as a matter of course, but it is worth noting.</p><a name="//apple_ref/doc/uid/TP40001858-CH232-CIAGGEDF" title="proc_exiting"></a><h3>proc_exiting</h3><p>Defined in: <code>&lt;sys/proc.h></code></p><p>Returns 1 if a process is exiting, else 0.</p><div class="codesample"><table><tr><td scope="row"><pre>    int proc_exiting(proc_t);<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001858-CH232-CIADHGCA" title="proc_is64bit"></a><h3>proc_is64bit</h3><p>Defined in: <code>&lt;sys/proc.h></code></p><p>Returns 1 if a process is a 64-bit executable, else 0.</p><div class="codesample"><table><tr><td scope="row"><pre>    int proc_is64bit(proc_t);<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001858-CH232-CIAFBAAG" title="proc_rele"></a><h3>proc_rele</h3><p>Defined in: <code>&lt;sys/proc.h></code></p><p>Releases a reference to a process entry.</p><div class="codesample"><table><tr><td scope="row"><pre>    int proc_rele(proc_t);<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001858-CH232-CIAFBBBG" title="proc_self"></a><h3>proc_self</h3><p>Defined in: <code>&lt;sys/proc.h></code></p><p>Returns a reference to the running process. This must be released with <code><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-CIAFBAAG">“proc_rele”</a></code>.</p><div class="codesample"><table><tr><td scope="row"><pre>    proc_t proc_self(void);<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001858-CH232-BBAGIEGI" title="proc_suser"></a><h3>proc_suser</h3><p>Defined in: <code>&lt;sys/proc.h></code></p><p>Checks to see if a process is running as the super-user (root).</p><div class="codesample"><table><tr><td scope="row"><pre>    int proc_suser(struct proc *p);<span></span></pre></td></tr></table></div><div class="notebox"><a name="//apple_ref/doc/uid/TP40001858-CH232-DontLinkElementID_73" title="Note"></a><p><strong>Note:</strong>&nbsp;There are many other <code>proc_*</code> functions available. These are described in <code>&lt;sys/proc.h></code>. The ones here are just a few of the more commonly used functions in network-related KEXTs.</p></div><a name="//apple_ref/doc/uid/TP40001858-CH232-BBACFIFE" title="msleep"></a><h3>msleep</h3><p>Defined in: <code>&lt;sys/proc.h></code></p><p>Sleep until an event is posted with <code><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-BBACBGFG">“wakeup”</a></code> or until a timeout occurs. This is commonly combined with a timeout value to bound the wait.</p><div class="codesample"><table><tr><td scope="row"><pre>    int msleep(void *chan, lck_mtx_t *mtx, int pri, const char *wmesg, struct timespec *ts);<span></span></pre></td></tr></table></div><p>The timeout value is a standard timespec (defined in <code>&lt;sys/time.h></code>, and is measured in seconds and nanoseconds. To sleep until woken, you should pass a <code>NULL</code> value for <code>ts</code>.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP40001858-CH232-DontLinkElementID_74" title="Note"></a><p><strong>Note:</strong>&nbsp;For compatibility reasons, an alternate form, <code><!--a-->msleep1<!--/a--></code>, is provided, in which the last argument is a 64-bit deadline in Mach abstime format. This form can be substituted in place of the <code><!--a-->tsleep<!--/a--></code> function used in pre-KPI network kernel extensions by using <code><!--a-->clock_interval_to_deadline<!--/a--></code> to obtain a mach abstime deadline from the time interval.</p></div><p>The parameter <code>mtx</code> is a mutex (defined in a processor-specific include, but included with <code>&lt;sys/lock.h></code>) that will be released prior to sleeping. (The mutex <em>must</em> be locked prior to calling msleep.) The mutex will also be reacquired upon wake unless the <code><!--a  -->PDROP<!--/a--></code> flag is set in the priority value.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP40001858-CH232-DontLinkElementID_75" title="Note"></a><p><strong>Note:</strong>&nbsp;If the <code><!--a  -->PDROP<!--/a--></code> flag is specified, <code><!--a-->msleep<!--/a--></code> returns with the mutex unlocked regardless of whether it actually blocks or not.</p></div><p>The parameter <code>chan</code> should be a unique identifier specific to a given wait event. Usually such an event is associated with the change in a variable, in which case the address of that variable makes a good value for <code>chan</code>.</p><p>The parameter <code>pri</code> is the desired priority on wake (defined in <code>&lt;sys/param.h></code>). After another thread has called <code><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-BBACBGFG">“wakeup”</a></code> on the desired event (specified by the value of <code>chan</code>), your code will begin executing at the specified priority. If the <code>PCATCH</code> flag is set on <code>pri</code>, signal handlers will be tried before and after the sleep.</p><p>Returns 0 if awakened with wakeup, <code>EWOULDBLOCK</code> on timeout expiry, and <code>ERESTART</code> or <code>EINTR</code> if <code>PCATCH</code> is set and a signal occurred, depending on whether the <code>SA_RESTART</code> flag is set on the signal.</p><a name="//apple_ref/doc/uid/TP40001858-CH232-BBACBGFG" title="wakeup"></a><h3>wakeup</h3><p>Defined in: <code>&lt;sys/proc.h></code></p><p>Wakes all threads sleeping on a given channel through a call to <code><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-BBACFIFE">“msleep”</a></code>.</p><div class="codesample"><table><tr><td scope="row"><pre>    void wakeup(void *chan);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001858-CH232-CIAJIJFF" title="wakeup_one"></a><h3>wakeup_one</h3><p>Defined in: <code>&lt;sys/proc.h></code></p><p>Wakes the first thread sleeping on a given channel through a call to <code><a href="reference.html#//apple_ref/doc/uid/TP40001858-CH232-BBACFIFE">“msleep”</a></code>.</p><div class="codesample"><table><tr><td scope="row"><pre>    void wakeup_one(void *chan);<span></span></pre></td></tr></table></div>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../interface_nke/interface_nke.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../glossary/glossary.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2003, 2009 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2009-03-02<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Darwin/Conceptual/NKEConceptual/reference/reference.html%3Fid%3DTP40001858-2.3&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Darwin/Conceptual/NKEConceptual/reference/reference.html%3Fid%3DTP40001858-2.3&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Darwin/Conceptual/NKEConceptual/reference/reference.html%3Fid%3DTP40001858-2.3&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>