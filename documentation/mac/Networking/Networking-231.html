<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>AFP Login Command Format(IM:N)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING231></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Networking-230.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-232.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Networking-2.html"><B>Networking</B></A> / <BR><DD><A HREF="Networking-223.html"><B>Chapter 9 - AppleTalk Filing Protocol (AFP)</B></A> / <A HREF="Networking-225.html"><B>AFP Reference</B></A><BR><DL><DD><A HREF="Networking-229.html"><B>Routines</B></A> / <A HREF="Networking-228.html"><B></B></A></DL></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING231-0></A>
<H3>AFP Login Command Format</H3>
 You use the <A NAME=MARKER-2-53></A>login command format for the <CODE>AFPCommand</CODE> function to pass the <CODE>afpLogin</CODE> command to the .XPP driver to open a session with an AFP file server.<P>
<PRE>
FUNCTION AFPCommand (thePBptr: XPPParmBlkPtr; 
                     async: Boolean): OSErr;
</PRE>
<DL>
<DT><CODE>thePBptr</CODE>
<DD> A pointer to the XPP parameter block format for the <CODE>afpLogin</CODE> command.<CODE> </CODE>
<DT><CODE><A NAME=MARKER-2-204></A>async</CODE> 
<DD> A Boolean that specifies whether the function is to execute synchronously or asynchronously. Set the <CODE>async</CODE> parameter to <CODE>TRUE</CODE> to execute the function asynchronously.
</DL>
<B>
<TABLE BORDER="0" CELLPADDING=3><TD>--><TD>ioCompletion<TD>ProcPtr<TD>A pointer to a completion routine.<TR>
<TD><--<TD>ioResult<TD>OSErr<TD>The function result.<TR>
<TD>--><TD>ioRefNum<TD>Integer<TD>The .XPP driver reference number.<TR>
<TD><--<TD>cmdResult<TD>LongInt<TD>The AFP command result.<TR>
<TD>--><TD>csCode<TD>Integer<TD>Always afpCall for this function.<TR>
<TD><--<TD>sessRefnum<TD>Integer<TD>The session reference number. <TR>
<TD>--><TD>aspTimeout<TD>Byte<TD>The retry interval in seconds.<TR>
<TD>--><TD>aspRetry<TD>Byte<TD>The number of retries.<TR>
<TD>--><TD>cbSize<TD>Integer<TD>The command buffer<EM> </EM>size.<TR>
<TD>--><TD>cbPtr<TD>Integer<TD>A pointer to the command buffer.<TR>
<TD><-><TD>rbSize<TD>Integer<TD>On input, the reply buffer size. On <BR>return, the actual reply size. <TR>
<TD>--><TD>rbPtr<TD>Ptr<TD>A pointer to the reply buffer.<TR>
<TD>--><TD>afpAddrBlock<TD>AddrBlock<TD>The internet socket address of the server. <TR>
<TD><-><TD>afpSCBPtr<TD>Ptr<TD>A pointer to the SCB.<TR>
<TD><-><TD>afpAttnRoutine<A NAME=MARKER-2-44></A><TD>Ptr<TD>A pointer to an attention routine.</TABLE>
</B><P>
<DL>
<H5>Field Description</H5>
<DT><CODE>cmdResult</CODE>
<DD> Four bytes of data returned from the server indicating the result of the AFP command. 
<DT><CODE><A NAME=MARKER-2-250></A>sessRefnum</CODE>
<DD> The session reference number, which is a unique number that the .XPP driver assigns to the session and returns. 
<DT><CODE><A NAME=MARKER-9-155></A>aspTimeout</CODE>
<DD> The interval in seconds that the .XPP driver waits between retries of the AFP command call.
<DT><CODE>aspRetry</CODE>
<DD> The number of times that the .XPP driver is to retry to execute the AFP command. 
<DT><CODE>cbSize</CODE>
<DD> The size in bytes of the block of data that contains the command and its parameters to be sent to the server across the session. The size of the command block must not exceed the value of <CODE>aspMaxCmdSize</CODE> that the <CODE>ASPGetParms</CODE> function returns. For information on <BR>the <CODE>ASPGetParms</CODE> function, see the chapter "AppleTalk Session <BR>Protocol (ASP)." 
<DT><CODE>cbPtr</CODE>
<DD> A pointer to the beginning of the command block that contains the AFP login command to be sent across the session to the server. The <CODE>cbSize</CODE> field value specifies the command block size. The first byte of the command block must contain the AFP login command. The following command block bytes contain the parameters for the command. For the definitions of the AFP commands and their command codes and parameters, see <I>Inside AppleTalk</I>, second edition, and the <I>AppleShare 3.0 Developer's Kit</I> version 3.0. 
<DT><CODE>rbSize</CODE>
<DD> On input, the size in bytes of the reply buffer that is to hold the expected response to the AFP login command. On return, the actual size of the reply to the AFP command that the .XPP driver returned in the buffer. 
<DT><CODE>rbPtr</CODE>
<DD> A pointer to the reply buffer. 
<DT><CODE>afpAddrBlock</CODE>
<DD> The internet socket address of the server to which the command is to be sent.
<DT><CODE><A NAME=MARKER-13-57></A><A NAME=MARKER-2-58></A>afpSCBPtr</CODE>
<DD> A pointer to a <A NAME=MARKER-2-59></A>session control block (<A NAME=MARKER-2-60></A>SCB) that the .XPP driver requires to maintain an open session. The <A NAME=MARKER-2-61></A><CODE>scbMemSize</CODE> constant defines the size of the session control block. The memory that you allocate for the SCB must be nonrelocatable or locked because it belongs to the .XPP driver for the life of the session. Each session requires its own SCB.
<DT><CODE>afpAttnRoutine</CODE>
<DD> A pointer to a routine that the .XPP driver calls when it receives an attention request from the server. If you do not want the .XPP driver to call an attention routine, set this field to 0.
</DL>
<A NAME=HEADING231-17></A>
<H5>DESCRIPTION</H5>
 To open a session with an AFP file server, you call the <CODE>AFPCommand</CODE> function and <BR>pass it the <CODE>afpLogin</CODE> command in the command block that you provide. You point <BR>to the command block from the XPP parameter block's <CODE>cbPtr</CODE> field. You specify the internet socket address of the server that you want to access as the value of the <CODE>afpAddrBlock</CODE> field. <P>
 In addition to allocating memory for the parameter block and the command block, you must provide a session control block (SCB) and pass the <CODE>AFPCommand</CODE> function a pointer to the SCB in the <CODE>afpSCBPtr</CODE> field. The .XPP driver uses the SCB internally to manage the session. Each session requires its own SCB. You must either allocate nonrelocatable memory for the session control block or lock the memory and not modify it for the duration of the session. The SCB size is defined by the constant <CODE>scbMemSize</CODE>. The memory belongs to the .XPP driver for the life of the session. You can reuse an SCB after either of the following events occurs: <P>
<UL>
<LI>You have called an <CODE>AFPCommand</CODE> function using the general command format to specify an <CODE>afpLogout</CODE> command to close the session and the <CODE>AFPCommand</CODE> function has successfully completed execution.
<LI>The server end of the session has closed the session or the .XPP driver has closed <BR>the session. <P>
</UL>
 AFP includes an attention mechanism that allows the server to send an attention request to the workstation. For example, a file server can use this messaging system to notify all of the workstations that are using the file server that it is shutting down. The XPP parameter block for the login format includes a pointer to an attention routine. <P>
 When the .XPP driver receives an attention request, it sets the first 2 bytes of the SCB to the attention bytes from the packet. If you have provided an attention routine, the .XPP driver calls it. The .XPP driver also calls the attention routine when the session is closed by either the workstation or the server or AFP itself, for example, because the .XPP driver could not open a session before it exhausted the number of retries. <P>
 You code the attention routine in assembly language. Because the .XPP driver calls your attention routine at interrupt level, you must observe the following interrupt conven-<BR>tions in writing the attention routine:<P>
<UL>
<LI>An attention routine can change registers A0 through A3 and D0 through D3. 
<LI>The routine must not call any Memory Manager routines. <P>
</UL>
 The .XPP driver calls your attention routine with<P>
<UL>
<LI>D0 (word) equal to the session reference number (<CODE>sessRefnum</CODE>) for that session. This is the number that AFP returns on completion of the <CODE>AFPCommand</CODE> function for the <CODE>afpLogin</CODE> command.
<LI>D1 (word) equal to the attention bytes passed by the server or 0 if the session <BR>is closing. <P>
</UL>
 To resume normal execution, your attention routine must return with an RTS (return from subroutine) instruction. <P>
 If you code your program in a high-level language, such as Pascal, you might not want to provide an attention routine written in assembly language. If you do not want to provide an attention routine, you can poll the attention bytes to determine if your application has received an attention request from the server. The attention bytes are the first 2 bytes of the session control block. When the server sends an attention request to the workstation, the .XPP driver receives the request and it sets the first 2 bytes of the SCB to the attention bytes from the packet. (When the session was opened, the .XPP driver set these bytes <BR>to 0.) If the first 2 bytes of the SCB are nonzero when your Pascal program polls them, <BR>the program will know that it has received an attention request from the server. Your program can handle the request and reset the SCB's attention bytes to 0. However, using this method to determine if the workstation has received an attention request from <BR>the server has limitations; two or more attention requests could be received between successive polls and only the last one would be preserved. <A NAME=MARKER-2-88></A><P>
<A NAME=HEADING231-32></A>
<H5>SPECIAL CONSIDERATIONS</H5>
 Note that you must provide the .XPP driver reference number as an input parameter <BR>to this function. You can obtain the driver reference number by calling the Device Manager's <CODE>OpenDriver</CODE> function. For more information on the <CODE>OpenDriver</CODE> function, see <I><A HREF = "../Devices/Devices-2.html">Inside Macintosh: Devices</A>.</I><P>
 In the XPP parameter block for the <CODE>AFPCommand</CODE> function login format, the <CODE>afpSCBPointer</CODE> and <CODE>afpAttnRoutine</CODE> fields overlap with the beginning of the <BR>CCB and are modified by <CODE>AFPCommand</CODE> function. <P>
 The memory that you allocate for the XPP parameter block, command block, and reply buffer belongs to AFP until the function completes execution, after which you can reuse the memory or release it. However, the memory that you allocate for the SCB belongs to AFP for the life of the session. You must either allocate nonrelocatable memory for the SCB or lock the memory and not modify it for the duration of the session.<P>
<A NAME=HEADING231-36></A>
<H5>ASSEMBLY-LANGUAGE INFORMATION</H5>
 To execute the <CODE>AFPCommand</CODE> function from assembly language, call the <CODE>_Control</CODE> trap macro with a value of <CODE>afpCall</CODE> in the <CODE>csCode</CODE> field of the parameter block. <P>
<A NAME=HEADING231-38></A>
<H5>RESULT CODES
<TABLE BORDER="0" CELLPADDING=3><TD>aspBadVersNum<TD>-1066<TD>The server cannot support the ASP version number<B></B><TR>
<TD>aspBufTooSmall<TD>-1067<TD>The command reply from the server is larger than <BR>the response buffer; ASP will fill the buffer and truncate the reply data <TR>
<TD>aspNoMoreSess<TD>-1068<TD>The .XPP driver cannot support another ASP session <TR>
<TD>aspNoServers<TD>-1069<TD>There is no server at the specified server address, <BR>or the server did not respond to the request<TR>
<TD>aspParamErr<TD>-1070<TD>You specified an invalid session reference number, <BR>or the session has been closed<TR>
<TD>aspServerBusy<TD>-1071<TD>The server cannot open another session<TR>
<TD>aspSizeErr<TD>-1073<TD>The size of the command block exceeds the <BR>maximum size of <CODE>aspMaxCmdSize</CODE></TABLE>
</H5>
<A NAME=HEADING231-39></A>
<H5>SEE ALSO </H5>
 For information on how to obtain the internet socket address of a<A NAME=MARKER-21-75></A> server, see the chapter "Name-Binding Protocol (NBP)" in this book. <P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Networking-230.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-232.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Networking-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
