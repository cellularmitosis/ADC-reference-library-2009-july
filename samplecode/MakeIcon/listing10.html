<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>MakeIcon - /TN120_Gworld.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxGraphicsImaging-date.html">Graphics & Imaging</a> &gt; <A HREF="javascript:location.replace('index.html');">MakeIcon</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/GraphicsImaging/index.html" target="_blank">Reference Library > Graphics & Imaging</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">MakeIcon</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/TN120_Gworld.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/IconUtil.c</option>
<option value="listing2.html">/IconUtil.h</option>
<option value="listing3.html">/InitMac.c</option>
<option value="listing4.html">/InitMac.h</option>
<option value="listing5.html">/MakeIcon.c</option>
<option value="listing6.html">/MiscCode.c</option>
<option value="listing7.html">/MiscCode.h</option>
<option value="listing8.html">/OldBitMap.c</option>
<option value="listing9.html">/OldBitMap.h</option>
<option value="listing10.html">/TN120_Gworld.c</option></select>
				</p>
				</form>
				<p><strong><a href="MakeIcon.zip">Download Sample</a></strong> (&#147;MakeIcon.zip&#148;, 26.8K)<BR>
<strong><a href="MakeIcon.dmg">Download Sample</a></strong> (&#147;MakeIcon.dmg&#148;, 84.4K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*  File:    TN120_Gworld.c  Contains:  THE CODE BELOW HERE WAS TAKEN STRAIGHT FROM TECH NOTE #120.        SEE THAT TECH NOTE FOR MORE INFORMATION.          (I did remove one parameter from set up pix map.)  Written by:     Copyright:  Copyright &copy; 1999 by Apple Computer, Inc., All Rights Reserved.        You may incorporate this Apple sample source code into your program(s) without        restriction. This Apple sample source code has been provided &quot;AS IS&quot; and the        responsibility for its operation is yours. You are not permitted to redistribute        this Apple sample source code as &quot;Apple sample source code&quot; after having made        changes. If you're going to re-distribute the source, we require that you make        it clear in the source that the code was descended from Apple sample source        code, but that you've made changes.  Change History (most recent first):        7/9/1999  Karl Groethe  Updated for Metrowerks Codewarror Pro 2.1        */#include &lt;QDOffscreen.h&gt;#include &lt;Memory.h&gt;#ifndef topLeft#define topLeft(r)                  (((Point *) &amp;(r))[0])#endif#ifndef botRight#define botRight(r)                 (((Point *) &amp;(r))[1])#endifGWorldPtr CreateOffScreen (WindowPtr basePort, short depth, Boolean UseTempMem);OSErr SetUpPixMap(    short        depth,       /* Desired number of bits/pixel in off-screen */    Rect         *bounds,     /* Bounding rectangle of off-screen */    CTabHandle   colors,      /* Color table to assign to off-screen */    PixMapHandle aPixMap      /* Handle to the PixMap being initialized */    );    #define kDefaultRes 0x00480000 /* Default resolution is 72 DPI; Fixed type */OSErr SetUpPixMap(    short        depth,       /* Desired number of bits/pixel in off-screen */    Rect         *bounds,     /* Bounding rectangle of off-screen */    CTabHandle   colors,      /* Color table to assign to off-screen */    PixMapHandle aPixMap      /* Handle to the PixMap being initialized */    ){    CTabHandle newColors;     /* Color table used for the off-screen PixMap */    Ptr        offBaseAddr;   /* Pointer to the off-screen pixel image */    OSErr      error;         /* Returns error code */    short      bytesPerRow;    /* Number of bytes per row in the PixMap */    error = noErr;    newColors = nil;    offBaseAddr = nil;    bytesPerRow = ((depth * (bounds-&gt;right - bounds-&gt;left) + 31) / 32) * 4;   /* Clone the clut if indexed color; allocate a dummy clut if direct color*/    if (depth &lt;= 8)        {        newColors = colors;        error = HandToHand((Handle *) &amp;newColors);        }    else        {        newColors = (CTabHandle) NewHandle(sizeof(ColorTable) -                sizeof(CSpecArray));        error = MemError();        }    if (error == noErr)        {        /* Allocate pixel image; long integer multiplication avoids overflow */        offBaseAddr = NewPtr((unsigned long) bytesPerRow * (bounds-&gt;bottom -                bounds-&gt;top));        if (offBaseAddr != nil)            {            /* Initialize fields common to indexed and direct PixMaps */            (**aPixMap).baseAddr = offBaseAddr;  /* Point to image */            (**aPixMap).rowBytes = bytesPerRow | /* MSB set for PixMap */                    0x8000;            (**aPixMap).bounds = *bounds;        /* Use given bounds */            (**aPixMap).pmVersion = 0;           /* No special stuff */            (**aPixMap).packType = 0;            /* Default PICT pack */            (**aPixMap).packSize = 0;            /* Always zero in mem */            (**aPixMap).hRes = kDefaultRes;      /* 72 DPI default res */            (**aPixMap).vRes = kDefaultRes;      /* 72 DPI default res */            (**aPixMap).pixelSize = depth;       /* Set # bits/pixel */            (**aPixMap).planeBytes = 0;          /* Not used */            (**aPixMap).pmReserved = 0;          /* Not used */            /* Initialize fields specific to indexed and direct PixMaps */            if (depth &lt;= 8)                {                /* PixMap is indexed */                (**aPixMap).pixelType = 0;       /* Indicates indexed */                (**aPixMap).cmpCount = 1;        /* Have 1 component */                (**aPixMap).cmpSize = depth;     /* Component size=depth */                (**aPixMap).pmTable = newColors; /* Handle to CLUT */                }            else                {                /* PixMap is direct */                (**aPixMap).pixelType = RGBDirect; /* Indicates direct */                (**aPixMap).cmpCount = 3;          /* Have 3 components */                if (depth == 16)                    (**aPixMap).cmpSize = 5;       /* 5 bits/component */                else                    (**aPixMap).cmpSize = 8;       /* 8 bits/component */                (**newColors).ctSeed = 3 * (**aPixMap).cmpSize;                (**newColors).ctFlags = 0;                (**newColors).ctSize = 0;                (**aPixMap).pmTable = newColors;                }            }        else            error = MemError();        }    else        newColors = nil;    /* If no errors occured, return a handle to the new off-screen PixMap */    if (error != noErr)        {        if (newColors != nil)            DisposeCTable(newColors);        }    /* Return the error code */    return error;    }GWorldPtr CreateOffScreen (WindowPtr basePort, short depth, Boolean UseTempMem){  CGrafPtr    currPort;    /* Pointer to the saved port */  GDHandle    currGDevice; /* Handle to the current GDevice */  GWorldPtr   offScreen;   /* Pointer to our GWorld */  Rect        offRect;     /* portRect of basePort in global coordinates */  GWorldFlags tempFlags;   /* Flag indicating if temp memory is to be used */  QDErr       result;      /* Error return from NewGWorld */  GetGWorld (&amp;currPort, &amp;currGDevice);  SetPort (basePort);  /* Globalize portRect of basePort */  offRect = basePort-&gt;portRect;  if (depth == 0)  {    LocalToGlobal (/*\xD7*/&amp;topLeft(offRect));    LocalToGlobal (/*\xD7*/&amp;botRight(offRect));  }  /* Set tempFlags to reflect desire for temporary memory */  if (UseTempMem)    tempFlags = useTempMem;  else    tempFlags = 0;  /* Create the new off-screen port and set it as the current port */  result = NewGWorld (/*&lt;*/&amp;offScreen, depth, &amp;offRect, nil, nil, tempFlags);  if (result == noErr)  {    SetGWorld (offScreen, (GDHandle) nil);    /* Good idea to set the clip region to the portRect of the new GWorld */    ClipRect (&amp;offScreen-&gt;portRect);    /* Clear the new GWorld to white */    if (LockPixels (GetGWorldPixMap (offScreen)))      {      EraseRect (&amp;offScreen-&gt;portRect);      UnlockPixels (GetGWorldPixMap (offScreen));      }    }  else    offScreen = nil;  /* Reset current GrafPort and GDevice to what it was when we were called */  SetGWorld (currPort, currGDevice);  return offScreen;}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/MakeIcon/listing10.html%3Fid%3DDTS10000089-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/MakeIcon/listing10.html%3Fid%3DDTS10000089-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/MakeIcon/listing10.html%3Fid%3DDTS10000089-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>