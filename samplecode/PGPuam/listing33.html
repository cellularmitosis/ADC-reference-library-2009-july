<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>PGPuam - /sources/PGPUAMclientLoginDialog.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxNetworking-date.html">Networking</a> &gt; <A HREF="javascript:location.replace('index.html');">PGPuam</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Networking/index.html" target="_blank">Reference Library > Networking</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">PGPuam</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/sources/PGPUAMclientLoginDialog.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/headers/AFPPackets.h</option>
<option value="listing2.html">/headers/AppleShare.h</option>
<option value="listing3.html">/headers/AppleShareFileServerRegistry.h</option>
<option value="listing4.html">/headers/AppleShareRegistry.h</option>
<option value="listing5.html">/headers/ClientUAM.h</option>
<option value="listing6.html">/headers/ICAPI.h</option>
<option value="listing7.html">/headers/ICCAPI.h</option>
<option value="listing8.html">/headers/ICComponentSelectors.h</option>
<option value="listing9.html">/headers/ICKeys.h</option>
<option value="listing10.html">/headers/ICTypes.h</option>
<option value="listing11.html">/headers/LibraryManager.h</option>
<option value="listing12.html">/headers/OAM.h</option>
<option value="listing13.html">/headers/OAMTypes.h</option>
<option value="listing14.html">/headers/RegisterFileLibs.h</option>
<option value="listing15.html">/headers/UAM.h</option>
<option value="listing16.html">/In process/dumpuserInfo.c</option>
<option value="listing17.html">/sources/ASIPChallenge.cp</option>
<option value="listing18.html">/sources/ASIPChallenge.h</option>
<option value="listing19.html">/sources/clientUAMGlue.c</option>
<option value="listing20.html">/sources/FatCR PPC.r</option>
<option value="listing21.html">/sources/LaunchApplication.c</option>
<option value="listing22.html">/sources/LaunchApplication.h</option>
<option value="listing23.html">/sources/machdepnetmacros.h</option>
<option value="listing24.html">/sources/PassphraseCache.c</option>
<option value="listing25.html">/sources/PassphraseCache.h</option>
<option value="listing26.html">/sources/PGPServerMemory.cp</option>
<option value="listing27.html">/sources/PGPServerMemory.h</option>
<option value="listing28.html">/sources/PGPserverUAM.c</option>
<option value="listing29.html">/sources/PGPUAM Client resources.r</option>
<option value="listing30.html">/sources/PGPuam Server Resources.r</option>
<option value="listing31.html">/sources/PGPUAMclient.c</option>
<option value="listing32.html">/sources/PGPUAMclient.h</option>
<option value="listing33.html">/sources/PGPUAMclientLoginDialog.c</option>
<option value="listing34.html">/sources/PGPUAMclientLoginDialog.h</option>
<option value="listing35.html">/sources/PGPUAMclientProtocol.c</option>
<option value="listing36.html">/sources/PGPUAMclientProtocol.h</option>
<option value="listing37.html">/sources/PGPUAMdefines.h</option>
<option value="listing38.html">/sources/PGPUAMDialogTest.c</option>
<option value="listing39.html">/sources/PGPUAMmsgFormat.c</option>
<option value="listing40.html">/sources/PGPUAMmsgFormat.h</option>
<option value="listing41.html">/sources/PPCGlue.c</option>
<option value="listing42.html">/sources/RemoveServerKey.c</option>
<option value="listing43.html">/sources/TAboutBoxPane.cp</option>
<option value="listing44.html">/sources/TAboutBoxPane.h</option>
<option value="listing45.html">/sources/TASIPKeyPane.cp</option>
<option value="listing46.html">/sources/TASIPKeyPane.h</option>
<option value="listing47.html">/sources/TASIPPGPkey.cp</option>
<option value="listing48.html">/sources/TASIPPGPkey.h</option>
<option value="listing49.html">/sources/TMacException.h</option>
<option value="listing50.html">/sources/TMemPGPkey.cp</option>
<option value="listing51.html">/sources/TMemPGPkey.h</option>
<option value="listing52.html">/sources/TPane.h</option>
<option value="listing53.html">/sources/TPGPException.h</option>
<option value="listing54.html">/sources/TPGPkey.cp</option>
<option value="listing55.html">/sources/TPGPkey.h</option>
<option value="listing56.html">/sources/TPGPUAMPrefs.cp</option>
<option value="listing57.html">/sources/TPGPUAMPrefs.h</option>
<option value="listing58.html">/sources/TPrefs.cp</option>
<option value="listing59.html">/sources/TPrefs.h</option>
<option value="listing60.html">/sources/TSetupPane.cp</option>
<option value="listing61.html">/sources/TSetupPane.h</option></select>
				</p>
				</form>
				<p><strong><a href="PGPuam.zip">Download Sample</a></strong> (&#147;PGPuam.zip&#148;, 803.2K)<BR>
<strong><a href="PGPuam.dmg">Download Sample</a></strong> (&#147;PGPuam.dmg&#148;, 1.12M)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*  File:      PGPUAMclientLoginDialog.c  Description:  Handles the PGPlogin Username Dialog  Written by:  Vinnie Moscaritolo  Copyright:  &copy; 1998 by Apple Computer, Inc., all rights reserved.  Change History (most recent first):  You may incorporate this sample code into your applications without  restriction, though the sample code has been provided &quot;AS IS&quot; and the  responsibility for its operation is 100% yours.  However, what you are  not permitted to do is to redistribute the source as &quot;DSC Sample Code&quot;  after having made changes. If you're going to re-distribute the source,  we require that you make it clear in the source that the code was  descended from Apple Sample Code, but that you've made changes.*///------------------------------------------------------------------------------------#pragma mark Includes//------------------------------------------------------------------------------------#include &lt;stdio.h&gt;#include &lt;string.h&gt;#include &lt;Appearance.h&gt;#include &lt;Dialogs.h&gt;#include &lt;Controls.h&gt;#include &lt;DateTimeUtils.h&gt;#include &lt;PLStringFuncs.h&gt;#include &quot;PGPUAMclient.h&quot;#include &quot;PGPUAMclientLoginDialog.h&quot;#include &quot;LaunchApplication.h&quot;#include &quot;TMacException.h&quot;#include &quot;TASIPPGPkey.h&quot;#include &quot;TASIPKeyPane.h&quot;#include &quot;TAboutBoxPane.h&quot;#include &quot;TSetupPane.h&quot;#include &quot;TPGPUAMPrefs.h&quot;#include &quot;PassphraseCache.h&quot; //------------------------------------------------------------------------------------#pragma mark Local Defines//------------------------------------------------------------------------------------const OSType kPGPkeysCreator  = 'pgpK';#define kLoginDialogID 130    static enum {  kConnectID   = 1,  kCancelID ,      // 2    kChangeKeyID,    // 37  kUserNameID,    // 3    STXT4_Name,      // 4  kInfoID,      // 5   kIcon,        // 6  kDisclosureTri,    // 7  kHelpItem,      // 9  kLaunchPGPKeysButton,// 35  kKeyIcon,      // 10  kProgressArrowsID,  // 12  kDisclosureText,  // 13  kTabsID,      // 14  kSeperatorLine,    // 15  KLastLoginDialogItem   } ;#define kDialogStringsID 128 static enum {  kNoDetailsStrID    =1,  kShowDetailsStrID,  kHideDetailsStrID,  kServerKeyNotFound,  kServerKeyNotFoundErrorMsg1,  kServerKeyNotFoundErrorMsg2};  #define kKeyStringsID 129 static enum {  kKeyNameStrID    =1,  kKeyIDStrID ,  kKeyTypeStrID,  kKeySizeStrID,  kKeyCreatedStrID,  kKeyExpiresStrID,  kKeyExpiredStrID,  kKeyRevokedStrID,  kKeyInvalidStrID,  kKeyValidStrID,  kKeyTrustedStrID,  kKeyUnTrustedStrID,  kKeyServerKeyIsEnabled,  kKeyServerKeyIsDisabled,  kKeyServerKeyIsRevoked,  kKeyServerKeyIsExpired   };static enum {  kHelpIconID      = 2200,  kHelpIconDisabledID  = 2201}; static enum{  kServerAuthPaneID = 1,  kSetupPaneID,  kAboutBoxPaneID};// ---------------------------------------------------------------------------#pragma mark Local Globals?// ---------------------------------------------------------------------------static  TASIPPGPkey    gServerKey;static   DialogPtr     gDialog = nil;static  TPane*      gPane  = nil;static  TPGPUAMPrefs*  gPrefs  = nil;static  EventCallbackPtr gEventCallbackUPP = nil;static  Boolean      gDialogForeground  = true;static   Boolean      appleGuideAvailable = false;// ---------------------------------------------------------------------------#pragma mark Local Prototypes// ---------------------------------------------------------------------------static       short        GetDlgItemTop(DialogPtr dlog, int item);static       short        GetDlgItemBottom(DialogPtr dlog, int item);static pascal void        KeyIconDrawProc    (ControlHandle theControl, SInt16 thePart);static pascal ControlPartCode KeyIconHitTestProc (ControlHandle theControl, Point where);static pascal Boolean       LoginDialogFilterProc (DialogRef dialog, EventRecord *event, short *itemHit);static       DialogPtr     NewLoginDialog(StringPtr userName, StringPtr serverName, TPGPUAMPrefs* userPrefs);static       void         SetDialogDisclosureState (DialogPtr theDialog, Boolean expanded);static       void         LoginDialogIdle();static       void         UpdateLoginDialog(DialogPtr theDialog); #pragma mark -  // ---------------------------------------------------------------------------OSErr DoLoginDialog( StringPtr userName,           StringPtr serverName,            short     *sessionRefNum,           TPGPUAMPrefs*  userPrefs,            LoginStartConnectionProcPtr startProc,             CancelConnectionProcPtr   cancelProc,            UniversalProcPtr      eventProcUPP,            void *context ) // ---------------------------------------------------------------------------  {   ModalFilterUPP         loginDialogFilterProcUPP = NewModalFilterProc (LoginDialogFilterProc);  ControlHandle  theControl;    short      itemNo;  Size      theSize;  long       response = 0;  GrafPtr      savePort;    OSErr      ErrNo     = noErr;  Boolean      busy;    if(startProc == nil) return paramErr;   GetPort(&amp;savePort);    gEventCallbackUPP = eventProcUPP;  gPrefs = userPrefs;    try    {   // setup prefs timelimit    EnablePassphraseCaching( userPrefs-&gt;GetCachePassPhrase() );     if( userPrefs-&gt;GetCachePassPhrase() )       SetPassphraseCacheTimeLimit( userPrefs-&gt;GetCachePassPhraseTimeLimit() );     // Is apple Guide available ?    ErrNo = Gestalt(gestaltHelpMgrAttr, &amp;response);    appleGuideAvailable =  (ErrNo == noErr &amp;&amp; (response &amp; (1 &lt;&lt; gestaltAppleGuidePresent)));    // update Key info     gServerKey.Initialize(gAFPSrvrSig);  // create Login Dialog    ThrowIfNil( gDialog = NewLoginDialog(userName, serverName, userPrefs));   // setup panel    gPane = new TASIPKeyPane(gDialog, CountDITL(gDialog),  &amp;gServerKey);     gPane-&gt;Refresh();          SetDialogDisclosureState(gDialog, userPrefs-&gt;GetDisclosureState()  );  // Showtime!        ShowWindow(gDialog);    busy = true;     while(busy)    {           ModalDialog(loginDialogFilterProcUPP, &amp;itemNo);                switch(itemNo){            case kCancelID:           if( cancelProc) cancelProc(context);            busy = false;          ErrNo = userCanceledErr;           break;                case  kConnectID:          GetDialogItemAsControl( gDialog, kConnectID, &amp;theControl );          DeactivateControl(theControl);  // force this to no longer be the default item  // else Appearance will re-activate it on process switch in.?          SetDialogDefaultItem(gDialog,0);           GetDialogItemAsControl( gDialog, kProgressArrowsID, &amp;theControl );          ShowControl(theControl);            GetDialogItemAsControl( gDialog, kUserNameID, &amp;theControl );          DeactivateControl(theControl);           GetControlData( theControl, 0, kControlEditTextTextTag, (Size) 63, (Ptr)&amp;userName[1], &amp;theSize );           userName[0] = (theSize &amp;0xFF);          ErrNo = (startProc)( userName,serverName,sessionRefNum,userPrefs, &amp;gServerKey, LoginDialogIdle, context );          busy = false;          break;            // toggle disclosure triangle       case kKeyIcon:             GetDialogItemAsControl( gDialog, kDisclosureTri, &amp;theControl );               SetControlValue(theControl,  0x1 ^ GetControlValue(theControl));         // user toggled it      case kDisclosureTri:              GetDialogItemAsControl( gDialog, kKeyIcon, &amp;theControl );              InvalRect(&amp;(**theControl).contrlRect);             GetDialogItemAsControl( gDialog, kDisclosureTri, &amp;theControl );            SizeWindow(gDialog,                      (GetDialogWindow(gDialog)-&gt;portRect.right -                       GetDialogWindow(gDialog)-&gt;portRect.left),                  ((GetControlValue(theControl) == 0)                    ?GetDlgItemTop(gDialog, kSeperatorLine ) - 2                     :GetDlgItemBottom(gDialog, kTabsID)) - 4,true);                                userPrefs-&gt;SetDisclosureState ( (GetControlValue(theControl) == 1 ));             break;                    case kHelpItem:            break;                      case kChangeKeyID:            break;                     case kIcon:            break;                  case kLaunchPGPKeysButton:            LaunchApplication(kPGPkeysCreator);            break;                  case kTabsID:              GetDialogItemAsControl( gDialog, kTabsID, &amp;theControl );              if(gPane) delete gPane; gPane = nil;            switch (GetControlValue( theControl ) )            {              case kServerAuthPaneID:                gPane = new TASIPKeyPane(gDialog, CountDITL(gDialog), &amp;gServerKey);                break;                              case kSetupPaneID:                gPane = new TSetupPane(gDialog, CountDITL(gDialog),userPrefs );                  break;                                case kAboutBoxPaneID:                 gPane = new TAboutBoxPane(gDialog, CountDITL(gDialog) );                   break;            }            if(gPane) gPane-&gt;Refresh();             break;                            default:          if((itemNo &gt;= KLastLoginDialogItem) &amp;&amp; gPane != nil)          {            gPane-&gt;ItemHit(itemNo);            UpdateLoginDialog(gDialog);          };                    break;      };    }    }// Error Reporting  catch (...)  {    if(gDialog)    {       ClearKeyboardFocus(gDialog);       if(gPane) delete gPane;       DisposeDialog(gDialog);    }    SetPort(savePort);    throw;   }     ClearKeyboardFocus(gDialog);   if(gPane)  delete gPane;   DisposeDialog(gDialog);  gDialog = nil;  SetPort(savePort);        return ErrNo;}// ---------------------------------------------------------------------------static DialogPtr NewLoginDialog(StringPtr userName, StringPtr serverName, TPGPUAMPrefs*  userPrefs )// ---------------------------------------------------------------------------{  ControlUserPaneDrawUPP     keyIconDrawProcUPP     = NewControlUserPaneDrawProc(KeyIconDrawProc);  ControlUserPaneHitTestUPP   keyIconHitTestProcUPP     = NewControlUserPaneHitTestProc(KeyIconHitTestProc);    Handle        uamName;  DialogPtr      theDialog = nil;  ControlHandle    theControl;    ControlFontStyleRec  fontInfo;  Str255         text;     // get Dialog Title   uamName = Get1Resource(kUAMStr,kUAMName);  if(!uamName) return nil;    // Get the Dialog  theDialog = GetNewDialog(kLoginDialogID, nil, (WindowPtr)-1);  SetPort((GrafPtr) theDialog);    // set dialog title  HLock(uamName);  SetWTitle(theDialog, (StringPtr) *uamName);  HUnlock(uamName);   // setup Dialog Items  SetDialogCancelItem  (theDialog,kCancelID);     SetDialogTracksCursor(theDialog,true);     UpdateLoginDialog(theDialog);      // setup key Icon &amp; triangle text draw routine   GetDialogItemAsControl( theDialog, kKeyIcon, &amp;theControl );  SetControlData(theControl, 0, kControlUserPaneDrawProcTag, sizeof(ControlUserPaneDrawUPP), (Ptr) &amp;keyIconDrawProcUPP);  SetControlData(theControl, 0, kControlUserPaneHitTestProcTag, sizeof(ControlUserPaneHitTestUPP), (Ptr) &amp;keyIconHitTestProcUPP);   // load serverName info   ParamText( serverName, &quot;\p&quot;,&quot;\p&quot;,&quot;\p&quot;);   // Preload and setup User name field   GetDialogItemAsControl( theDialog, kUserNameID, &amp;theControl );   SetControlData( theControl, 0, kControlEditTextTextTag, userName[0], (Ptr)(userName+1) );   SetKeyboardFocus(theDialog,theControl, kControlFocusNextPart);  // Change key is not yet supported   GetDialogItemAsControl( theDialog, kChangeKeyID, &amp;theControl );   DeactivateControl(theControl);  // is appleguide around?   GetDialogItemAsControl( theDialog, kHelpItem, &amp;theControl );  SetControlVisibility(theControl, appleGuideAvailable, true);   fontInfo.font = kControlFontBigSystemFont;  fontInfo.just = teJustRight;  fontInfo.flags = kControlUseFontMask | kControlUseJustMask;  // Name   GetDialogItemAsControl( theDialog, STXT4_Name, &amp;theControl );  SetControlData( theControl, 0, kControlStaticTextStyleTag, sizeof fontInfo, (Ptr)&amp;fontInfo); // select proper font for disclosure text  fontInfo.just = teJustLeft;  fontInfo.font = kControlFontSmallSystemFont;  GetDialogItemAsControl( theDialog, kDisclosureText, &amp;theControl );   SetControlData( theControl, 0, kControlStaticTextStyleTag, sizeof fontInfo, (Ptr)&amp;fontInfo);    return theDialog;}// ---------------------------------------------------------------------------static pascal Boolean LoginDialogFilterProc  (DialogRef dialog, EventRecord *event, short *itemHit)// ---------------------------------------------------------------------------{  ModalFilterUPP  upp;  ControlHandle  theControl;    Boolean handled;  // pre filtering  switch(event-&gt;what)    {    case nullEvent:      IdleControls(dialog);      if(gPane) gPane-&gt;Idle();      break;        case mouseDown:      if(( dialog == gDialog) &amp;&amp; (gPane != nil))        if( gPane-&gt;HandleMouseDown(event)) return true;       break;      // handle switch into background?    case osEvt:        if ((event-&gt;message &gt;&gt; 24) &amp; suspendResumeMessage )           {  if( gDialogForeground = (event-&gt;message  &amp; resumeFlag))          {                // finder resume event            // re-open PGP key database            TPGPkey::OpenKeyDefaultRing();            gServerKey.Initialize(gAFPSrvrSig);                         UpdateLoginDialog(gDialog);                          // update aprop panes              if(gPane) gPane-&gt;Refresh();           }           else          {            // finder suspend event            // close PGP key Database             TPGPkey::CloseKeyRing();           }          }      break;    }       if (!GetStdFilterProc (&amp;upp))    handled =  CallModalFilterProc (upp,dialog,event,itemHit);  if(!handled)    CallUniversalProc( gEventCallbackUPP, kEventCallbackProcInfo, event);  return handled;}// ---------------------------------------------------------------------------static void LoginDialogIdle()// ---------------------------------------------------------------------------{  EventRecord event;    event.what = nullEvent;    LoginDialogFilterProc (gDialog, &amp;event, 0);}// ---------------------------------------------------------------------------static void UpdateLoginDialog(DialogPtr dialog)// ---------------------------------------------------------------------------{  ControlHandle    theControl;    // can we connect with this key?  GetDialogItemAsControl( dialog, kConnectID, &amp;theControl );   if( gPrefs-&gt;GetAuthenticateServer()      &amp;&amp; (!gServerKey.CanVerify() || gServerKey.IsExpired() || gServerKey.IsRevoked() || gServerKey.IsDisabled())  )    {      SetDialogDefaultItem(dialog, 0);           DeactivateControl(theControl);   }  else  {    ActivateControl(theControl);    SetDialogDefaultItem(dialog,kConnectID);        } }#pragma mark -// ---------------------------------------------------------------------------static void SetDialogDisclosureState(DialogPtr theDialog, Boolean expanded)// --------------------------------------------------------------------------- // activate the disclosure triangle with the proper  window default state{  ControlHandle    theControl;    GetDialogItemAsControl( theDialog, kDisclosureTri, &amp;theControl );  SetControlValue(theControl, expanded?1:0);  SizeWindow(theDialog,            (GetDialogWindow(theDialog)-&gt;portRect.right -             GetDialogWindow(theDialog)-&gt;portRect.left),        ((GetControlValue(theControl) == 0)          ?GetDlgItemTop(theDialog, kSeperatorLine ) - 2           :GetDlgItemBottom(theDialog, kTabsID)) - 4,true);}// ---------------------------------------------------------------------------static pascal void  KeyIconDrawProc(ControlHandle theControl, SInt16 thePart)// ---------------------------------------------------------------------------{  #pragma unused( thePart )  Rect      bounds;  Str255      text;   GrafPtr      savePort;   GetPort(&amp;savePort);    SetPort((GrafPtr) gDialog);   bounds = (**theControl).contrlRect;   // paint the proper Icon  bounds.right = bounds.left+16;  EraseRect(&amp;bounds);    PlotIconID(&amp;bounds, atNone, gDialogForeground? ttNone: ttSelectedDisabled ,  gServerKey.GetIconID());  // get the right text string to display for the disclosure text  GetDialogItemAsControl( gDialog, kDisclosureTri, &amp;theControl );  if( gServerKey.IsInitialized() )    GetIndString(text, kDialogStringsID,       ( GetControlValue(theControl) == 0) ?kShowDetailsStrID:kHideDetailsStrID);   else    GetIndString(text, kDialogStringsID,kServerKeyNotFound); // update the text line using an imbebded text item  GetDialogItemAsControl( gDialog, kDisclosureText, &amp;theControl );  SetControlData( theControl, 0, kControlStaticTextTextTag, text[0], (Ptr)(text+1) );    SetPort(savePort); } // --------------------------------------------------------------------------- static pascal ControlPartCode KeyIconHitTestProc(ControlHandle theControl, Point where)// ---------------------------------------------------------------------------{  #pragma unused( where )  return kControlButtonPart;}#pragma mark -   // ---------------------------------------------------------------------------static short GetDlgItemTop(DialogPtr dlog, int item)// ---------------------------------------------------------------------------  {    short type; Handle hndl; Rect box;    GetDialogItem(dlog,item,&amp;type,&amp;hndl,&amp;box);    return (box.top);  } // ---------------------------------------------------------------------------static short GetDlgItemBottom(DialogPtr dlog, int item)// ---------------------------------------------------------------------------  {    short type; Handle hndl; Rect box;    GetDialogItem(dlog,item,&amp;type,&amp;hndl,&amp;box);    return (box.bottom);  }</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/PGPuam/listing33.html%3Fid%3DDTS10000259-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/PGPuam/listing33.html%3Fid%3DDTS10000259-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/PGPuam/listing33.html%3Fid%3DDTS10000259-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>