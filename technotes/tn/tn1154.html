<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-05-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">    <META HTTP-EQUIV="Content-Type" CONTENT="text/html;CHARSET=iso-8859-1"><meta name="keywords" content="Mac OS 8 Java MRJ debugging MacsBug dcmd stack crawl"><meta name="Description" content="Technical Note TN1154: This Technical Note describes how
Java 1.1.x code can be debugged using MacsBug in Mac OS Classic. It provides a brief
description of MacsBug itself( how to get it what its, etc.),
and then Note details the commands a programmer can use to
debug Java code, such as the mrj dcmd.">    <META NAME="GENERATOR" Content="Symantec Visual Page Mac 1.1.1">    <title>Technical Note TN1154: Debugging Java Code With MacsBug</title><meta name="categories" content="Java"><meta name="week-posted" content="Feb 28, 2000 - Mar 3, 2000"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002993" title="Debugging Java Code With MacsBug"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxJava-date.html">Java</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Java/idxTools-date.html" target="_blank">Java > Tools</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1154</div>
<div id="pageheadsub">Debugging Java Code With MacsBug</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left">   <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">     <tr><td width=300 valign="top" align=left scope="row">    <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>            <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>  </tr>  <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left> <span id="menutitle">CONTENTS   <br>  <br> </span>   </td>  </tr>  <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left> <!-- begin_toc --><P id = "menutext"><A HREF = "#Section1">MacsBug In a Nutshell</A><BR>            <BR>            <A HREF = "#Section2">The <CODE>'mrj' dcmd</CODE></A><BR>            <BR>            <A HREF = "#Section3">Basic Commands</A><BR>            <BR>            <A HREF = "#Section4">Commands Available In the Debug Build</A><BR>            <BR>            <A HREF = "#Section5">Inspecting Objects</A><BR>            <BR>            <A HREF = "#Section6">Interpreting Stack Crawls and Thread Dumps</A><BR>            <BR>            <A HREF = "#Section7">Switching Contexts</A><BR>            <BR>            <A HREF = "#References">References</A><BR><BR>         <A HREF="#Downloads">Downloadables</A></p>       <!-- end_toc --></td>  </tr>  <tr>   <td width=300 align=left scope="row"> <img src="images/tnmenubottom.gif" alt="" width=300 height=16>   </td>  </tr>    </table></td>  <td width=300 valign="top" align=left>            <!-- begin_intro_text --><P id = "introtext">MacsBug, the low-level debugger for the Mac            OS, seems unlikely to be useful for debugging a very high-level language like Java.            <I>Au contraire!</I> The MRJ plug-in <CODE>'dcmd'</CODE> for MacsBug adds a number            of commands that can help you debug everything from deadlocks to memory leaks.</P>         <!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Mar 20 1999]</h3><!-- end_date --></TD> </TR>    </TABLE> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR>      <!-- begin_content -->                  <P><A NAME="Section1"></A></P><H2>MacsBug In a Nutshell</H2><P>Before you can start using MacsBug to debug Java, you need to install MacsBugand learn the basics of how to use it. If you've already been developing Mac software,this is a non-issue since you're almost certainly already familiar with MacsBug,and you can skip to the <A HREF = "#Section2">next section</A>.</P><P>However, there are a lot of people developing or testing Java on the Macintoshwho are not otherwise Mac developers and don't know an A-trap from "Take theA Train." This section is for them, so it presumes a lot less Mac technicalknowledge than most technotes do.</P><H3>What's MacsBug?</H3><P>MacsBug is Apple's assembly-level 680x0 and PowerPC debugger for Mac&nbsp;OS.It can be used to debug code running in most execution environments, from applicationsto drivers, and everything in between. It's often used as a bug-reporting tool bymany third-party developers, as well as Mac OS system software developers.</P><P>MacsBug knows nothing about source code, only assembly-language instructions,and its support for high-level data structures is primitive. But it's great for examiningthe exact machine state.</P><P>Unlike debuggers on most other platforms, MacsBug is always resident once installed,and can take over instantly when a crash occurs or when you press a hot-key, evenif the machine is otherwise frozen.</P><H3>Download &amp; Installation</H3><P>MacsBug is available from <a href="http://developer.apple.com/tools/debuggers/MacsBug/index.html">Apple'sdeveloper Web site</A>. As befits a tweaky developer tool, it spends most of itstime in one prerelease state or another, and the latest and greatest version is nearlyalways marked as alpha or beta. Nonetheless, it's still usually best to install thelatest prerelease; they've proven to be pretty stable.</P><P>There are a lot of files in the download, but the only one you need is MacsBugitself, which you'll find in the "into System folder" folder. Drag it intoyour System folder (<I>not</I> the Extensions folder!) and restart. You should seethe message "Debugger Installed" appear below "Welcome To Mac OS"in the Mac OS splash screen as the system begins to boot.</P><H3>A Very Brief Overview</H3><P>The <a href="http://developer.apple.com/tools/debuggers/MacsBug/Documentation/MacsBugRef_6.2.pdf">MacsBugmanual</A> is also available online, but it's large and intimidating (not to mentionslightly obsolete) and actually overkill for the Java-only developer. Here's a verybrief introduction:</P><P>MacsBug loads itself into memory very early in the boot process and hides outinvisibly until it's needed. (It does consume a bit of RAM.) Three different circumstanceswill cause MacsBug to appear:</P><OL>    <LI>A CPU exception or a system error occurs -- both are usually referred to as "crashes."    If these occur and MacsBug is not installed, then depending on the severity, you    get either an "Unexpectedly quit" alert or a dread bomb box.</li>    <LI>The system routines <CODE>Debugger</CODE> or <CODE>DebugStr</CODE> are called.    MacsBug will report a "user break," usually with a message. This lets software    report messages to the user -- usually warnings of dangerous or unexpected situations.    Only special debug versions of software should contain user breaks.</li>    <LI>You explicitly invoke MacsBug by holding down the Command ("cloverleaf")    key and pressing the Power key (the one with the triangle that you use to turn your    system on). You can do this even if the computer is otherwise hung or frozen; if    it doesn't work, things are in really bad shape and your only option is to force    a restart by pressing Command-Control-Power, the dread "three-finger salute."</li></OL><P>When MacsBug appears, it completely takes over the screen and the CPU. No otherapplication or OS software can run while MacsBug is visible. This explains why MacsBug'suser interface is so completely non-Mac-like -- it can't use any of the Toolbox.</P><P>MacsBug is a command-line environment like DOS or a Unix shell. It shows one fixed-sizewindow in the middle of the screen, with garbage pixels outside the window. There'san input line at the bottom, a few lines of machine code disassembly above it, anda large scrolling output area above that. On the left side is a register and stackdisplay.</P><P>You type commands into the input line at the bottom and press Return to run them.You can't use the mouse to select text, but most standard editing keystrokes work(arrow keys, delete and forward-delete, option- and Command- arrow, etc.) You canalso press Cmd-V to copy the previous command into the input line.</P><H3>Some essential commands</H3><P>The most vital MacsBug commands are:</P><UL>    <LI><B><CODE>help</CODE></B> -- Displays a list of help topics. You can get more    info by entering "help" followed by the name of a topic or command.</li>    <LI><B><CODE>g</CODE></B> -- "Go." Attempts to resume normal operation.    This will only work if you entered MacsBug on purpose via Command-Power or after    a user break: if the system is crashed, you can't continue normally.</li>    <LI><B><CODE>es</CODE></B> -- "Exit to Shell." Attempts to force the currently    active application to quit. This is just like the Command-Option-Escape panic button    that non-MacsBug-users use. This may or may not succeed, depending on how damaged    the system is and exactly where you were at the point you entered MacsBug. If it    succeeds, restart ASAP. If not, use...</li>    <LI><B><CODE>rs</CODE></B> -- "ReStart." Attempts to restart/reboot the    system after some clean-up (for instance, flushing the disk cache). This is friendlier    than Command-Control-Power or pulling out the power cord, and less likely to cause    disk damage.</li>    <LI><B><CODE>stdlog</CODE></B> -- dumps a text file to your desktop, containing a    lot of information about the current machine state. We ask you to submit one of these    when reporting any crash or user-break involving MRJ.</li>    <LI><B><CODE>log</CODE></B> -- If you put a filename after the log command, all subsequent    MacsBug output will be written to that file. (The file usually appears in the same                folder as the current application.) "log" with no filename turns off logging.</li>            </UL>        <br><P><A HREF = "#top">Back to top</A></P><H2><A NAME="Section2"></A>The 'mrj' dcmd</H2><P>We've written a plug-in (called a "dcmd") for MacsBug that adds a newcommand, <B><CODE>mrj</CODE></B>. Actually it adds many new commands, invoked byname on the command line after the "<CODE>mrj</CODE>" part. For instance,"<CODE>mrj sc</CODE>" dumps a Java stack crawl.</P><P>The <CODE>dcmd</CODE> is available as part of the <a href="http://developer.apple.com/java/text/download.html#sdk">MRJSDK</A>, in the folder "Tools: Other Tools: MRJ<CODE>dcmd</CODE> for PPC:". Just put the file "MRJ<CODE>dcmd</CODE>" into the MacsBug Preferencesfolder of the Preferences folder of your Systemfolder, and restart.</P><P>To use the <CODE>dcmd</CODE>, you must have a Java application or applet running. Most of the <CODE>dcmd</CODE>'s commands are not available, and make no sense, otherwise.</P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>IMPORTANT:</B><BR>Almost all of the commands described below work only with MRJ 2.1 and later. MRJ2.0's SDK included an earlier version of the <CODE>dcmd</CODE> with only two or threecommands. Make sure you install the <CODE>dcmd</CODE> from the latest <a href="http://developer.apple.com/java/text/download.html#sdk">MRJ            SDK</A>.                        <B>Disclaimer:</B><BR>                        This technote describes MRJ 2.2. It is quite likely that the <CODE>dcmd</CODE>'s                        feature set and details of its commands may change in the future as the JVM is improved.                        Some commands or features of commands may not be available depending on how the corresponding                        area of the JVM is reimplemented.</p></TD></TR></TABLE></CENTER>                                                <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>IMPORTANT:</B><BR>GC-Related Commands:<BR>                        It's best if the system is quiescent (the garbage collector is not running), so if                        possible set a tvector break on <CODE>WaitNextEvent</CODE> and then run the gc-related command                        when you hit the break. To do this use the following syntax in MacsBug:</P></TD></TR></TABLE></CENTER><BR>   <CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>tvb WaitNextEvent;g</pre></TD></TR></TABLE></CENTER>                        <P>To clear all tvector breaks use:</P><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>tvc</pre></TD></TR></TABLE></CENTER>                                      <P><A HREF = "#top">Back to top</A></P><H2><A NAME="Section3"></A>Basic Commands</H2><P>Here's information about the most commonly used commands. (Many of the other commandsare for querying internal data structures and are only of use for debugging MRJ itself.)</P><P>If you invoke the <CODE>dcmd</CODE> without any command (by typing just "<CODE>mrj</CODE>")it will display a brief list of commands:</P><H3>Java log (<CODE>mrjlog</CODE>)</H3><P>This is the Java equivalent of <CODE>stdlog</CODE> -- it writes a text file toyour desktop that contains a lot of information about the current Java state. <B>Note</B>that there is no space in "<CODE>mrjlog</CODE>"! This is really a macrothat opens a log file and runs several <CODE>mrj dcmd</CODE> commands that writeto it.</P><H3>Stack crawl (<CODE>mrj sc</CODE>)</H3><P>Displays information about the current thread and its Java stack, with the currentstack frame listed first. The details are described <A HREF = "#Section6">below</A>.</P><H3>Thread dump (<CODE>mrj threads</CODE>)</H3><P>Displays information about all active threads, including their stacks. Each threadalso tells what monitors it's acquired (what object it's currently synchronized against,in Java parlance) and at the end of the listing is a dump of the cache of the mostrecently used monitors and who owns them or is waiting for them.</P><H3>Deadlock detection (<CODE>mrj dl</CODE>)</H3><P>Looks for a classic deadlock -- two threads, each one blocked waiting for a monitorowned by the other thread. If it finds one, it will list information about the threadsand the monitors.</P><H3>Synchronization check (<CODE>mrj sync</CODE>)</H3><P>Looks for other possible synchronization problems besides deadlocks, and displaysinformation about them if it finds any. These include:</P><UL>    <LI>Thread holding any monitor (synchronized against anything) while blocked in <CODE>Object.wait</CODE></li>    <LI>Thread blocked on a monitor while holding another monitor</li>    <LI>Thread suspended (via <CODE>Thread.suspend</CODE>) while holding a monitor</li></UL><P>These are all technically legal situations but can often lead to deadlock andare thus suspicious if they turn up.</P><H3>Redirect output (<CODE>mrj redirect <I>filename</I></CODE>)</H3><P>Redirects <CODE>System.out</CODE> and <CODE>System.err</CODE> to the given filename,which should be a full path. If no filename is given, output is disabled entirely.</P><P>The redirection does not take effect immediately -- some Java code needs to becalled, and the JVM is usually not in the right state to do this at the moment thatMacsBug was invoked, so the request is queued until the next time the main threadruns.</P><H3>Java heap usage (<CODE>mrj chunks</CODE>)</H3><P>Displays the total, used and free space in the Java object heap, and in the handleheap which is associated with it. Also displays info about each memory "chunk"in the heap, which is generally not of interest.</P><H3>MRJ non-Java heap usage (<CODE>mrj alloch</CODE>)</H3><P>Displays the amount of memory used by MRJ for things other than objects. Theseinclude data loaded from <CODE>.class</CODE> files and internal data structures associatedwith classes, threads and other things.</P><H3>Find monitor (<CODE>mrj fm <I>monitor</I></CODE>)</H3><P>Given a monitor ID (as reported as the "<CODE>mon:</CODE>" value inan <CODE>mrj sc</CODE> or <CODE>mrj threads</CODE> dump) this locates the objectthe monitor is associated with, giving its classname and handle. You can then usethe handle with <A HREF = "#Section5">object inspection commands</A> like <CODE>mrjdo</CODE> to get more information about the object.</P><H3>Execute a method (<CODE>mrj exec <I>classname</I> <I>methodname</I></CODE>)</H3><P>Waits for the MRJ main thread to get control, then calls a single parameterlessstatic void method. The classname needs to be fully qualified with package namesseparated by "<CODE>/</CODE>"s. The method name is separated by a space,not a "<CODE>.</CODE>"!</P><P>This isn't too useful out of the box, but you can turn it into a powerful debuggingtool by adding such methods to your app. For instance, you could add a <CODE>Debug</CODE>class in the default/root package, and give it static void methods like <CODE>dumpState</CODE>or <CODE>startLogging</CODE>. Then at any moment you can press Command-Power to enterMacsBug, type "<CODE>mrj exec Debug dumpState</CODE>", and get all kindsof useful info printed to the console.</P><H3>Find references (<CODE>mrj fr <I>handle</I></CODE>)</H3><P>Searches moderately hard for things that point to the given object. This can beuseful if you're trying to figure out why objects aren't being garbage collected.I say "moderately hard" because this command searches the object heap andJNI global references, but not thread stacks, so it may not find all references.</P><P>The references will be listed one per line and described as "instance field,""array element," etc. The handle of the object containing the referencewill be given, which you can use as the argument to another <CODE>mrj fr</CODE> commandif you want to trace further.</P><P>A more sophisticated reference-finder is <CODE>mrj graphrefs</CODE>, but it'sonly available in the debug build.</P><H3>Find instances (<CODE>mrj fi <I>classname</I></CODE>)</H3><P>This command takes a classname (often acquired from <A HREF = "#extant">mrj extant</A>)and lists the handle for all current instances of the class. This is useful as aninput to mrj fr or mrj graphrefs. It's best if the system is quiescent (the garbagecollector is not running), so if possible tvb WaitNextEvent, go and then run thecommand when you hit the tvector break.</p>       <H3>Instruction listing (<CODE>mrj il <I>methodname</I></CODE>)</H3><P>Disassembles the bytecodes of a method. The method has to be named in the usualinternal format:</P><UL>    <LI>Fully qualified classname with packages separated by "<CODE>/</CODE>"s</li>    <LI>"<CODE>.</CODE>",</li>    <LI>method name</li>    <LI>"<CODE>.</CODE>"</li>    <LI>Encoded parameter types in parentheses</li>    <LI>Encoded return type</li></UL><P>For example:</P><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre><B>il java/lang/Thread.join.()V</B>      disassembly from $659ed84 java.lang.Thread.join(Thread.java:873)      [0]  2A aload_0      [1]  9 lconst_0      [2]  E2 invokevirtual_quick_w Method: "java/lang/Thread.join(J)V"      [5]  B1 return</pre></TD></TR></TABLE></CENTER>        <P><A HREF = "#top">Back to top</A></P><H2><A NAME="Section4"></A>Commands Available Only In the DebugBuild</H2>            <P>The debug build of MRJ enables extra commands in the MRJ <CODE>dcmd</CODE>. (They're            not in the regular build because supporting them makes MRJ slower or use more memory            or both.)</P>            <P>The <a href="http://developer.apple.com/java/text/download.html#debug">debug build</A> also has a limited            form of deadlock-checking built into the thread scheduler: in the case of a classic            two-thread deadlock it will automatically drop into MacsBug with a user break warning            about a deadlock. You should immediately use "<CODE>mrj dl</CODE>" to get            more information.</P>            <P>Another handy feature of the debug build is that it will display a cursor shaped            like a little bulldozer while it garbage-collects. This can help you tell whether            long pauses in your app are actually caused by garbage collection.</P>            <H3><A NAME="extant"></A>Count class instances (<CODE>mrj extant</CODE>)</H3>            <P>Lists every class currently loaded, in alphabetical order, plus the current and            maximum number of instances. If you add a numeric argument to this command, it displays            only classes with at least that many current instances.</P>            <H3>Method tracing (<CODE>mrj tracem <I>value</I></CODE>)</H3>            <P>A <I>value</I> of <I>1</I> turns on method tracing, <I>0 </I>turns it off. Method            tracing writes a line of output to the console whenever any method is entered or            exited. This results in reams of output -- you should first use <CODE>mrj redirect</CODE>            to write to a file, not the console window! -- but can be quite useful for examining            the flow of execution without stopping the program or when no high-level debugger            is available.</P>            <H3>Instruction tracing (<CODE>mrj trace <I>value</I></CODE>)</H3>            <P>A <I>value</I> of <I>1</I> turns on instruction tracing, <I>0</I> turns it off.            Instruction tracing writes a line of output to the console for every Java bytecode            instruction that's executed. This is very rarely useful, and produces staggering            amounts of output -- use <CODE>mrj redirect</CODE> first to write to a file. It also            has no effect when running JITted code, so you probably want to disable the JIT before            launching MRJ if you plan on using this.</P>            <P>In MRJ 2.1 not all bytecodes executed get displayed. We plan to fix this in the            next release.</P>            <H3>Graph references (<CODE>mrj graphrefs <I>handle</I></CODE>)</H3>            <P>A more involved reference tracker than mrj fr, this transitively discloses chains            of references to the roots (like static variables) that point to the given object            and thus keep it from being garbage collected.</p>        <P>This command writes the results to Macsbug. It's best if the system is quiescent(the garbage collector is not running), so if possible tvb <CODE>WaitNextEvent</CODE>, go andthen run the command when you hit the tvector break.</P><br><P>Here's the beginning of some typical output:</p>            <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre><B>mrj graphrefs $6b11f18</B>          recursively searching for references to $6b11f18          References to: $6b11f18          instance field: $6b11aa8 java/lang/  Thread.target(Ljava/lang/Runnable;)          instance field: $6b126c8com/apple/mrj/console/Console$ConsoleArea.this$0(Lcom/  apple/mrj/console/Console;)          instance field: $6b13628 com/apple/mrj/  console/Console$1.this$0(Lcom/apple/mrj/console/Console;)          java thread var ref $6b11f18 at $x (tid $68ef584, )    References to: $6b11aa8    array element: $6b11ea8 [1]    c thread found $6b11aa8 at $680f2fc (tid $6adda7c, ConsoleThread)    c thread found $6b11aa8 at $680f34c (tid $6adda7c, ConsoleThread)    c thread found $6b11aa8 at $680f370 (tid $6adda7c, ConsoleThread)    c thread found $6b11aa8 at $680f3e8 (tid $6adda7c, ConsoleThread)    java thread var ref $6b11aa8 at $x (tid $68ef558, )</pre></TD></TR></TABLE></CENTER><BR><BR>       <br><P>Traces are separated by blank lines. Each trace starts with "References to:"            followed by the handle of the object it's tracing, and then lists all references            to that object, such as instance variables in other objects, static variables, and            local variables of current stack frames. The first trace is for the object you requested.            Subsequent traces are for objects found in previous traces. The result, if you follow            from one trace to another, lets you find out exactly what chains of references are            keeping an object from being garbage collected.<BR>            <BR>            This output is pretty hard to read and cries out for a nice tool to interpret it.            For now all we can suggest is saving using log in Macsbug, then invoking a good programmer's            editor and using the Find command to find matching hex values.</p>    <br><P><A HREF = "#top">Back to top</A></P>            <H2><A NAME="Section5"></A>Inspecting Objects</H2>            <P>You can examine the fields of Java objects and the elements of arrays if you know            the object/array's <I>handle</I>. This is a 32-bit object ID. There are three ways            to find a handle:</P>            <OL>                <LI>Many <CODE>dcmd</CODE> commands display object handles. For instance, <CODE>mrj                sc</CODE> displays the handle of the <CODE>Thread</CODE> and of the receiver ("<CODE>this</CODE>")                of every stack frame.</li>                <LI>The method <CODE>Object.hashCode</CODE> happens to return the object's handle                shifted right 3 bits. So to print foo's handle to the console you can use:<BR>                <CODE>System.out.println(Integer.toHexString(foo.hashCode()&lt;&lt;3));<BR>                </CODE>This will not work if the object's class overrides <CODE>hashCode</CODE> to                return a different value! So it's useless on <CODE>String</CODE>s and <CODE>Point</CODE>s,                for instance. But for most classes you can use this in your logging code to dump                the handles of useful objects to the console.<BR>                This behavior may obviously change in the future if we re-implement the JVM.</li>            </OL>            <H3>Display Object (<CODE>mrj do <I>handle</I></CODE>)</H3>            <P>Displays the object with the given <I>handle</I>. The results might look like:</P>                        <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre> java.lang.ThreadGroup@5D590C0/5D0A668      SuperName: java/lang/Object      # ClassName: java/lang/ThreadGroup          parent.(Ljava/lang/ThreadGroup;) = $05d540a0          name.(Ljava/lang/String;) = $05d590d0          maxPriority.(I) = 10          destroyed.(Z) = false          daemon.(Z) = false          vmAllowSuspension.(Z) = false          nthreads.(I) = 3          threads.([Ljava/lang/Thread;) = $05d59090          ngroups.(I) = 1          groups.([Ljava/lang/ThreadGroup;) = $05d5a948      # ClassName: java/lang/Object</pre></TD></TR></TABLE></CENTER><BR><BR>                 <br>            <P>The first line shows the object's class-name and handle. (The second number after            the "<CODE>/</CODE>" is not useful.) The second line shows the name of            the superclass.</P>            <P>After that, follow blocks for the object's class and each superclass. Each block            starts with the classname and then shows all variables declared in that class and            their values for that object. (Static variables have "<CODE>[static]</CODE>"            at the end.)</P>            <P>Each variable entry shows its name, then its type in parentheses. The type follows            the typical encoding scheme used by the JVM: Single letters for primitive types (<CODE>I</CODE>            for int, <CODE>Z</CODE> for boolean, etc.) and for object types, "<CODE>L</CODE>"            followed by the classname followed by "<CODE>;</CODE>".</P>            <P>If a variable's type is an object, the value shown is the object's handle, so            you can use a further <CODE>mrj do</CODE> command to inspect <I>that</I> object.</P>            <H3>Display array (<CODE>mrj da <I>handle</I></CODE>)</H3>            <P>Displays the contents of the array with the given <I>handle</I>. The first line            shows the type of the array elements and the length of the array; then, each element            is listed on a separate line.</P>            <P>To list only a portion of an array, you can provide two extra parameters that            specify the first item to display and the item <I>after</I> the last one to display;            for example:</P>                                              <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre><B>mrj da 05d5a948 1 3                  </B>     java.lang.ThreadGroup[4]      1: $00000000 -&gt; NULL      2: $00000000 -&gt; NULL</pre></TD></TR></TABLE></CENTER><BR><BR>                                                  <H3>Display string (<CODE>mrj ds <I>handle</I></CODE>)</H3>            <P>A convenient way to display the contents of a String object. (You could use <CODE>do</CODE>            and <CODE>da</CODE> to find and dump the <CODE>char[ ]</CODE> array in the String,            but it's awkward.)</P>            <P>This command doesn't do very well with non-ASCII characters, since that would            require higher level translation services that aren't available from within MacsBug.</P>            <H3>Find a class (<CODE>mrj fc <I>name</I></CODE>)</H3>            <P>Locates a loaded class with the given <I>name</I>. You need to specify the complete            name including packages, and package names need to be separated with "<CODE>/</CODE>"            instead of "<CODE>.</CODE>"; for historical reasons, that's the way classnames            are represented internally.</P>            <P>If the class is found, the command will return the handle of its <CODE>Class</CODE>            object. That object usually isn't very useful, but this command can still be handy            to determine whether or not a particular class has been loaded yet.</P>            <H3>Dump class methods (<CODE>mrj dcm <I>classname</I></CODE>)</H3>            <P>Displays all the methods of a given class (including inherited ones.) The classname            has to be fully specified, with "<CODE>/</CODE>"s, as described above for            <CODE>mrj fc</CODE>. The output format is similar to that of <CODE>mrj do</CODE>:</P>            <P>There's a section for the class and each superclass. Each section shows the classname,            then each method introduced by that class. Each method is shown on a line containing:</P>            <OL>                <LI>The method's name.</li>                <LI>The method's signature. The parameter types are shown in parentheses, then the                return type. The types follow the typical encoding scheme used by the JVM: Single                letters for primitive types (<CODE>I</CODE> for <CODE>int</CODE>, <CODE>V</CODE>                for void, <CODE>Z</CODE> for <CODE>boolean</CODE>, etc.) and for object types, "<CODE>L</CODE>"                followed by the classname followed by "<CODE>;</CODE>".</li>                <LI>Modifiers like <CODE>static</CODE> and <CODE>synchronized</CODE>.</li>            </OL>            <H3>Dump object methods (<CODE>mrj dom <I>handle</I></CODE>)</H3>            <P>Similar to <CODE>mrj dcm</CODE>, but dumps the methods of the class of the object            whose <I>handle</I> is given.</p>        <br><P><A HREF = "#top">Back to top</A></P>            <H2><A NAME="Section6"></A>Interpreting Stack Crawls and Thread            Dumps</H2>            <P>The <B><CODE>mrj sc</CODE></B> and <B><CODE>mrj threads</CODE></B> commands both            display stack crawls, and there's a lot of cryptic but useful information packed            into them. A typical stack crawl looks like:</P>                                   <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>"QDPipeline"  TID: $60a1bf8, prio: 5  sys_thread: $5fe3200, priority: 5, saved_sp: $5fc5980  state: WCV, mon: $727ec24, cq: $727ec30$60a1c20 -&gt; java.lang.Object.wait(Object.java:315)$60a1c20 -&gt; com.apple.mrj.internal.awt.QDPipeline.run(QDPipeline.java:289)$60a1bf8 -&gt; java.lang.Thread.run(Thread.java:474)</pre></TD></TR></TABLE></CENTER><BR><BR>                    <br>            <H3>The thread header</H3>            <P>The first four lines display information about the thread:</P>            <P><B>"The thread's name"</B> In quotes on the first line. This is the            String parameter passed to the thread's constructor. If you don't provide one, you            get a default name like "Thread-7." Giving your threads meaningful names            is quite useful when debugging.</P>            <P><B><CODE>TID:</CODE></B> This is the handle of the Thread object. You can use            this with object-inspection commands like <CODE>mrj do</CODE>.</P>            <P><B><CODE>prio:</CODE></B> The regular Java thread priority, from 1 to 10. You            might notice that the "main" thread has priority 11 -- this is impossible            to do programmatically, but we can set it that way because we wrote the JVM. The            main thread needs to be able to pre-empt any other thread when a <CODE>JManager</CODE>            call comes in.</P>            <P><B><CODE>sys_thread:</CODE></B> Points to the native thread structure. You can            use the <CODE>mrj thd</CODE> command to display lots of cryptic information about            it.</P>            <P><B><CODE>saved_sp:</CODE> or <CODE>*current thread*</CODE>:</B> The <CODE>saved_sp</CODE>            points to the thread's <I>native</I> stack; use it as the argument to MacsBug's regular            stack crawl command <CODE>sc7</CODE> to display the stack. (But <CODE>sc7</CODE>            stack crawls aren't very accurate and tend to display a lot of junk.) If you see            <CODE>*current thread*</CODE> instead, that means that this is the thread currently            running; use <CODE>sc</CODE> or <CODE>sc7</CODE> with no arguments to see its native            stack.</P>            <P><B><CODE>priority:</CODE></B> For historical reasons, this is a duplicate of the            <CODE>prio:</CODE> field on the previous line.</P>            <P><B><CODE>state:</CODE></B> The thread's current state. <B><CODE>RDY</CODE></B>            means "ready": the thread is runnable, and is either running now or will            run when the scheduler gives it a chance. (It might still never get a chance to run            if higher priority threads are always busy.) <B><CODE>WMON</CODE></B> means "waiting            on monitor": this usually means that the thread is blocked entering a <CODE>synchronized</CODE>            method or statement because another thread is already synchronized against that object.            (Unfortunately, due to a bug in the <CODE>dcmd</CODE>, a runnable thread is sometimes            incorrectly listed as <CODE>WMON</CODE>.) <B><CODE>WCV</CODE></B> means "waiting            on condition variable": the thread is blocked in the <CODE>Object.wait</CODE>            method and hasn't yet been woken up by an <CODE>Object.notify</CODE> or <CODE>notifyAll</CODE>            call. <B><CODE>SUSP</CODE></B> means the thread has been suspended via <CODE>Thread.suspend</CODE>.</P>            <P><B><CODE>mon:</CODE></B> If the thread's state is <CODE>WMON</CODE>, this field            shows the ID of the monitor it's blocked on. Monitors are usually associated with            objects, but a monitor ID is <I>not</I> an object handle, and there are monitors            that don't correspond to objects. You can use the <CODE>mrj fm</CODE> command to            find which Java object owns that monitor, or possibly the <CODE>mrj mon</CODE> command            to display cryptic information about the monitor itself.</P>            <P><B><CODE>cq:</CODE></B> If the thread's state is <CODE>WCV</CODE>, this field            shows the ID of the condition queue it's waiting on. This is an internal data structure            with no user-serviceable parts inside.</P><H3>The stack crawl itself</H3><P>After the thread header comes the Java stack crawl. This is mostly identical tothe kind of stack crawl you're used to seeing when an exception is dumped to theconsole.</P><P>The stack frames are listed in reverse chronological order, so the current methodis at the top.</P><P>There's an additional hex number at the beginning of each line, which is the objecthandle of the "<CODE>this</CODE>" variable (or receiver) of the method.You can use this in conjunction with object inspection commands like <CODE>mrj do</CODE>.</P><P>After the object handle comes the name of the method. After that in parenthesesis the name of the source file and the exact line number.</P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>The source file and line number will not be displayed if the line-number mappingtable is not found in the class file. (If you compiled your code with MetrowerksCodeWarrior, make sure the debugging dot is turned on next to the source file inthe project window.)<BR><BR>The source/line information will also be replaced with "(Compiled Code)"if the method has been translated into native code by the JIT: the JIT isn't ableto perform the (very difficult) reverse mapping of native instructions to Java bytecodes.You can prevent this by disabling the JIT: remove the "MRJ PPC JITC" libraryfrom the MRJ Libraries folder.</p></TD></TR></TABLE></CENTER><BR><BR><H3>The Monitor Cache Dump</H3><P>Monitors are the primitives used to implement synchronization on objects. Monitorsare not objects, but an object is assigned a monitor when a thread synchronizes againstit. (There are also special internal monitors that are not associated with objects.)</P><P>As described above, the header of a stack crawl tells whether the thread is blockedon a monitor and, if so, which one. The thing you probably want to know next is whatobject that monitor corresponds to. Usually (not always) you can determine this bylooking in the Monitor Cache Dump section in the "<CODE>mrj threads</CODE>"dump. This section comes right after the last thread's stack crawl, and lists the            objects that have most recently acquired monitors. A typical entry looks like this:</P>                        <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>    "com.apple.mrj.JManager.AVDispatcherThread@60A09C8/618AD48"       &lt;unowned&gt;      Waiting to be notified:         "AVGrp-com.apple.mrj.JManager.JMAWTContextImpl@c6ce6f-Disp" prio 4</pre></TD></TR></TABLE></CENTER><BR><BR>                                                <P>The first line shows the object's class. The hex number between the "<CODE>@</CODE>"            and the "<CODE>/</CODE>" is the object's handle, which lets you inspect            the object via commands like <CODE>mrj do</CODE>.</P>            <P>The second line shows which thread owns (is currently holding) that monitor, or            <CODE>&lt;unowned&gt;</CODE> if no thread owns it.</P>            <P>If one or more other threads are blocked on that monitor, they will be listed            after a line reading "<CODE>Waiting to be notified:</CODE>". Each thread            is listed by name, followed by "<CODE>@</CODE>", followed by the handle            of the thread object and its priority. You can of course find more info about the            thread in its stack crawl above.</P>            <P>It's worth pointing out two Java objects that often play a prominent role in synchronization            problems. <CODE>com.apple.mrj.macos.toolbox.Toolbox</CODE> is the <I>Toolbox lock</I>,            which is used by the AWT peers and other native or <CODE>JDirect</CODE> code to synchronize            access to the Mac Toolbox. (It's described in much more detail in <A HREF = "tn1153.html">Technote            1153, <I>Thread-Safe Toolbox Access From MRJ</I></A>. And if you see a <CODE>java.lang.Object</CODE>            in the monitor cache, it's probably the <CODE>treeLock</CODE> used by the public            AWT classes (it's declared in <CODE>java.awt.Component</CODE>) to synchronize access            to the component hierarchy. AWT-related deadlocks often involve one or both of these.</P>            <H3>The Registered Monitor Dump</H3>            <P>The last section of the thread dump shows the list of registered monitors. These            are monitors that are not associated with objects but which are known to the JVM.            These are used internally by things like the JIT, the class loader, and the finalizer            thread. Normally you don't need to pay attention to these, but very rarely you may            encounter a deadlock that involves one or them (for instance, we once had a nasty            bug that could cause the JIT and the class loader to deadlock). If you encounter            any problems involving these, it's almost certainly a bug in MRJ, which you should            report at once, including a <CODE>stdlog</CODE> and an <CODE>mrjlog</CODE>.</p><P><A HREF = "#top">Back to top</A></P>            <H2><A NAME="Section7"></A>Switching Contexts</H2>            <P>If only a single instance of MRJ is running, the <CODE>mrj dcmd</CODE> will automatically            target it; it doesn't matter which application is active at the moment MacsBug was            entered. But if you have two Java apps running at the same time, you'll need to disambiguate            them.</P>            <P>To target a particular instance of MRJ, you need to know its CFM <I>context ID</I>.            You can find this by using the MacsBug "<CODE>frags</CODE>" command. The            output shows a list of applications, and for each app the list of libraries it's            instantiated. The header line for an app shows its context ID (with a "#"            sign prepended to show that it's in decimal -- don't forget to include the "#"            sign when typing in the value.)</P>            <H3>Switch contexts (<CODE>mrj prf <I>context</I></CODE>)</H3>            <P>Targets the instance of MRJ running in the given <I>context</I>. Subsequent commands            will apply to this instance of MRJ until you target a different one.</P>            <H3>Tell context (<CODE>mrj pr</CODE>)</H3>            <P>Indicates which CFM context is targeted, if any.</p><P><A HREF = "#top">Back to top</A></P>            <H2><A NAME="References"></A>References</H2>                            <p>Apple Computer. <a href="http://developer.apple.com/tools/debuggers/MacsBug/Documentation/MacsBugRef_6.2.pdf"><I>MacsBug                Reference And Debugging Guide.</I></A> 1995. The complete guide to MacsBug -- not                very tutorial-like, unfortunately, and certainly overkill unless you plan on debugging                or testing a lot of native code.</p>                <p>Lindholm, Tim. <I>The Java Virtual Machine Specification.</I> Addison-Wesley,                1996. The exact specification for how the JVM operates. If you want to know the exact                details of how thread behavior is specified, look here. (It does not discuss implementation                specific details of object layout or thread scheduling, though.)</p>                <p>The MRJ <a href="http://developer.apple.com/java/text/download.html#debug">Debug </A>release.</p><BR><p><A HREF = "#top">Back to top</a></p><A NAME="Downloads"></A> <h2>Downloadables</h2><center><TABLE BORDER=0 CELLPADDING=3 WIDTH="600"> <TR> <td width=50 align=left>   <P ALIGN=center><img src="images/acrobatsmall.gif" align=middle alt="Acrobat" width=22 height=23></P></TD><td align="left">   <p>Acrobat version of this Note (76K).</P></TD><td width=60 align=left>   <p><A HREF="pdf/tn1154.pdf">Download</A></P></TD>  </TR> </table></center><BR><p><a href="#top">Back to top</a></p></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1154.html%3Fid%3DDTS10002993-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1154.html%3Fid%3DDTS10002993-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1154.html%3Fid%3DDTS10002993-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>