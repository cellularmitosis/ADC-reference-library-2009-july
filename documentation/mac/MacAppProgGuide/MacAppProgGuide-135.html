<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Recipes--Streams (MacApp PG)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING135></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="MacAppProgGuide-134.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="MacAppProgGuide-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="MacAppProgGuide-158.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="MacAppProgGuide-136.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="MacAppProgGuide-2.html"><B>Programmer's Guide to MacApp</B></A> / <A HREF="MacAppProgGuide-78.html"><B>Part 2 - Working With MacApp</B></A><BR><DD><A HREF="MacAppProgGuide-133.html"><B>Chapter 27 - Working With Streams</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING135-0></A>
<H1><A NAME=MARKER-9-39></A>Recipes--Streams</H1>
 The recipe and sample code in this section demonstrate how to use a handle stream.<P>
<A NAME=HEADING135-2></A>
<H2><A NAME=MARKER-2-34></A><A NAME=MARKER-9-35></A>Recipe--Using a Handle Stream to Write Text to a Handle</H2>
 The Calc sample application implements a spreadsheet view with rows and columns of cells. Calc supports publish and subscribe, and a user can select a group of cells and publish the data they contain. When a user publishes cell data, the Calc document object calls a method of the spreadsheet view (<CODE>TCellsView::DesignatorAsTEXT</CODE>) to write the text from the designated cells to a handle.<P>
 The <CODE>DesignatorAsTEXT</CODE> method provides a good example of using a stream to write data to a handle. The calling method passes a designator that identifies a group of one or more cells. The <CODE>DesignatorAsTEXT</CODE> method extracts text from the cells, uses a handle stream to write the text to a handle, and returns the handle. The calling method can use the handle (and its stored text) as required, but must be sure to free the handle when it has finished with it.<P>
 To use a handle stream to write text data to a handle, you perform these steps:<P>
<OL>
<LI>Create a handle.
<LI>Create a handle stream and initialize it with the handle you created.
<LI>Call methods of the stream to write your text data to the stream.
<LI>Free the handle stream.<P>
</OL>
 The sample code shown in this recipe is from the Calc application. <P>
<A NAME=HEADING135-11></A>
<H3>Create a Handle</H3>
  Creating a handle is a standard Macintosh operation. The <A NAME=MARKER-2-36></A><CODE>DesignatorAsTEXT</CODE> method creates a handle with an arbitrary initial size of 100. A handle stream will increase the size of its handle as necessary.<P>
<PRE>
Handle textHandle;
textHandle = NewPermHandle(100);
</PRE>
<A NAME=HEADING135-14></A>
<H3>Create and Initialize a Handle Stream</H3>
 When you initialize a handle stream, you pass it two items: a reference to a handle and a value that indicates the size by which the handle should be grown. When more space is needed, the handle stream will increase its handle size by the amount needed or by the specified growth size, whichever is larger.<P>
<PRE>
THandleStream * aHandleStream;
aHandleStream = new THandleStream;
aHandleStream-&gt;IHandleStream(textHandle, 10);
</PRE>
<A NAME=HEADING135-17></A>
<H3>Write Text Data to the Handle Stream</H3>
 The <CODE>DesignatorAsTEXT</CODE> method performs some additional operations to determine which cells should be examined and to set up an iterator to iterate over those cells. It then executes a loop to write the text from each cell to the handle stream. The complete code for <CODE>DesignatorAsTEXT</CODE> is shown on the following page.<P>
<PRE>
Handle TCellsView::DesignatorAsTEXT(TDesignator* aDesignator)
{
   CRect       bounds;
   Handle      textHandle;
   THandleStream * aHandleStream;
   CStr255     theString;
   RgnHandle   aRgn;

   textHandle = NewPermHandle(100);
   aHandleStream = new THandleStream;
   aHandleStream-&gt;IHandleStream(textHandle, 10);
   aRgn = ((TRegionDesignator *)(aDesignator))-&gt;fDesignation;
   bounds = (*aRgn)-&gt;rgnBBox;
   bounds.bottom--;
   bounds.right--;
   CCellIterator iter(this, bounds[topLeft], bounds[botRight], kIterateForward,
                  kIterateForward, CCellIterator::kIterateRowMajor);
   for (GridCell aCell = iter.FirstCell(); iter.More(); aCell = iter.NextCell())
   {
      SignedByte aChar;
      // Write out the cell's contents if the cell is included and it exists.
      if (PtInRgn(aCell, aRgn) &amp;&amp; fCalcDocument-&gt;CellExists(aCell.v, aCell.h))
      {
         fCalcDocument-&gt;GetCell(aCell.v, aCell.h)-&gt;GetValueAsString(theString);
         // Use WriteBytes instead of WriteString to avoid writing length byte.
         aHandleStream-&gt;WriteBytes(&amp;theString[1], theString.Length());
      }
      // Write out the delimiter: tab or carriage return.
      if (aCell.h == bounds.right)
         aChar = 0x0D;
      else
         aChar = 0x09;
      aHandleStream-&gt;WriteBytes(&amp;aChar, sizeof(SignedByte));
   }
   aHandleStream-&gt;Free();
   return textHandle;
}  // TCellsView::DesignatorAsTEXT\
</PRE>
<A NAME=HEADING135-20></A>
<H3>Free the Handle Stream</H3>
 The <CODE>DesignatorAsTEXT</CODE> method frees the handle stream, which frees the stream object itself but not its handle, then returns the handle.<P>
<PRE>
aHandleStream-&gt;Free();
return textHandle;
</PRE>
 The calling routine is responsible for freeing the handle when it has finished with it.<P>
<A NAME=HEADING135-24></A>
<H3>Using the Handle Data</H3>
 Once you have written data to a handle, you can use the handle just as you would any other handle variable. For example, you can use a file stream to write the handle to a document; you can also use a file stream to read the handle back from the document.<P>
 The Calc application uses this approach to read and write cell data. For writing, it writes cell data to a handle (with the <CODE>DesignatorAsTEXT</CODE> method<A NAME=MARKER-2-37></A> shown above), then uses a file stream to write the data to a document. For reading the data, it uses the <CODE>DoReadTEXT</CODE> method to read the handle from a file stream and then extract the data from the handle.<A NAME=MARKER-2-38></A><A NAME=MARKER-2-39></A><P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="MacAppProgGuide-134.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="MacAppProgGuide-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="MacAppProgGuide-158.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="MacAppProgGuide-136.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="MacAppProgGuide-3.html">&copy; Apple Computer, Inc.</A><br>25 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
