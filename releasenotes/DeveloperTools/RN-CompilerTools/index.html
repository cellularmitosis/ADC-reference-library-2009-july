<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<title>Compiler Tools Release Notes: Mac OS X Xcode 2.4 Release Notes: Compiler Tools</title>
	<meta name="Generator" content="Gutenberg"/>
	<meta name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta name = "Copyright" content="Copyright 2009 AppleInc. All Rights Reserved."/>
	<meta name="IndexTitle" content="Mac OS X Xcode 2.4 Release Notes: Compiler Tools"/>
	<meta name="xcode-display" content="render"/>
	<meta id="RESOURCES" content="../../../documentation/Resources" />
	<link rel="stylesheet" type="text/css" href="../../../documentation/Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../documentation/Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../documentation/Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../documentation/Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../documentation/Resources/JavaScript/pedia.js"></script>
</head>
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP40001264" title="Mac OS X Xcode 2.4 Release Notes: Compiler Tools"></a>
        <a name="top"></a>
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../index.html#//apple_ref/doc/uid/TP30000872" target="_top">Release Notes</a> &gt; <a href="../index.html#//apple_ref/doc/uid/TP30000872-TP30000436" target="_top">Tools</a> &gt; <a href="../idxCompilersDebuggers-date.html#//apple_ref/doc/uid/TP30000872-TP30000436-TP30001025">Compiling &amp; Debugging</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
                
        
        <a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_67" title="Mac OS X Xcode 2.4 Release Notes: Compiler Tools"></a><h1>Mac OS X Xcode 2.4 Release Notes: Compiler Tools</h1>
<!-- This template is being used for both PDF and HTML. -->
<!-- TopicBook.pm currently relies on the element name bmini_toc. -->

    <h4>Contents:</h4>
    
    <p class="blockquote">

        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_1" target="_top">Overview</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_2" target="_top">Notes Specific to Mac OS X Xcode 2.4 Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_3" target="_top">Notes Specific to Mac OS X Xcode 2.3.1 Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_4" target="_top">Notes Specific to Mac OS X Xcode 2.3 Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_5" target="_top">Notes Specific to Mac OS X Xcode 2.2.1 Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_6" target="_top">Notes Specific to Mac OS X Xcode 2.2 Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_8" target="_top">Notes Specific to Mac OS X Xcode 2.1 Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_10" target="_top">Notes Specific to Mac OS X Xcode 2.0 Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_12" target="_top">Notes Specific to Mac OS X Xcode 1.5 Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_23" target="_top">Notes Specific to Mac OS X 10.3.4 Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_27" target="_top">Notes Specific to Mac OS X December 2003 Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_28" target="_top">Notes Specific to Mac OS X 10.3 Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_31" target="_top">Notes Specific to Mac OS X June 2003 Developer Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_38" target="_top">Notes Specific to Mac OS X November 2002 Developer Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_43" target="_top">Notes Specific to Mac OS X 10.2 Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_47" target="_top">Notes Specific to Mac OS X 10.1 Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_49" target="_top">Notes Specific to Mac OS X 10.0 Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_50" target="_top">Notes Specific to Mac OS X Public Beta Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_52" target="_top">Notes Specific to Mac OS X Developer Release 4</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_53" target="_top">Notes Specific to Mac OS X Developer Release 3</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_55" target="_top">Notes Specific to Mac OS X Developer Preview Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_57" target="_top">Notes Specific to Mac OS X Server Release</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_59" target="_top">There are no Notes Specific to Rhapsody Developer Release 2</a>
                
            <br/>
            
        
			
            
                <a href="index.html#//apple_ref/doc/uid/TP40001264-DontLinkElementID_60" target="_top">Notes Specific to Rhapsody Developer Release</a>
                
            <br/>
            
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_1" title="Overview"></a><h2>Overview</h2><p>These notes are for the Mac OS X Xcode 2.4 Release of the compiler tools. They contain information about the following topics:</p><ul class="ul"><li class="li"><p>The Mac OS X Mach-O GNU-based assemblers</p></li><li class="li"><p>The Mac OS X 32-bit Mach-O static link editor</p></li><li class="li"><p>Mach-O object file tools (<strong>nm</strong>, <strong>otool</strong>, and so on)</p></li></ul><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_2" title="Notes Specific to Mac OS X Xcode 2.4 Release"></a><h2>Notes Specific to Mac OS X Xcode 2.4 Release</h2><p>The tools now support development of 64-bit Mach-O binaries for Intel with the -arch x86_64 flag.</p><p>The design of the relocation entries for the x86_64 architecture does not make it possible to strip local symbols from relocable object files. As such the feature of running strip(1) with the -x option to limit the symbols to just the exported symbols is not available on the x86_64 architeture. And the strip(1) -x option for an x86_64 object file does nothing.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_3" title="Notes Specific to Mac OS X Xcode 2.3.1 Release"></a><h2>Notes Specific to Mac OS X Xcode 2.3.1 Release</h2><p>The one feature of this release is support for the Intel Vanderpool instructions in the assembler and disassembler.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_4" title="Notes Specific to Mac OS X Xcode 2.3 Release"></a><h2>Notes Specific to Mac OS X Xcode 2.3 Release</h2><p>The major new feature for this release is the support of the use of DWARF for debug information.</p><p>The other new feature for this release is the support of the .quad assembler directive for the 32-bit assemblers. With this feature the assembler now treates all expressions as 64-bit values. This change can cause code code to no longer assemble. For example the following construct:</p><div class="codesample"><table><tr><td scope="row"><pre>addi r11, r11, (-33120 &amp;lt;&amp;lt; 16) >> 16<span></span></pre></td></tr></table></div><p>will now generate an error of the form:</p><p>x.s:1:Parameter error: expression out of range (parameter 3)</p><p>The correct way this should be coded is:</p><div class="codesample"><table><tr><td scope="row"><pre>addi r11, r11, lo16(-33120)<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_5" title="Notes Specific to Mac OS X Xcode 2.2.1 Release"></a><h2>Notes Specific to Mac OS X Xcode 2.2.1 Release</h2><p>There are no new features and only bug fixes. But there are some changes to improve the performance of the static link editor.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_6" title="Notes Specific to Mac OS X Xcode 2.2 Release"></a><h2>Notes Specific to Mac OS X Xcode 2.2 Release</h2><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_7" title="New Features"></a><h3>New Features</h3><p>The static link editor now supports the new option -Sp to strip, edit and add debugging symbols so the debugger can used most of the debugging symbols from the object files.</p><p>The ar(1) tool has the new -S option to suppress building the table of contents.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_8" title="Notes Specific to Mac OS X Xcode 2.1 Release"></a><h2>Notes Specific to Mac OS X Xcode 2.1 Release</h2><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_9" title="New Features"></a><h3>New Features</h3><p>The tools now have support for the handful of x86 sse3 instructions.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_10" title="Notes Specific to Mac OS X Xcode 2.0 Release"></a><h2>Notes Specific to Mac OS X Xcode 2.0 Release</h2><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_11" title="New Features"></a><h3>New Features</h3><p>The tools now support development of 64-bit Mach-O binaries for the PowerPC with the -arch ppc64 flag. The one tool that has not been seamlessly ported for this release is otool(1). And there is an otool64(1) for 64-bit Mach-O binaries.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_12" title="Notes Specific to Mac OS X Xcode 1.5 Release"></a><h2>Notes Specific to Mac OS X Xcode 1.5 Release</h2><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_13" title="New Features"></a><h3>New Features</h3><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_14" title="The static linker has an option to do dead code stripping"></a><h4>The static linker has an option to do dead code stripping</h4><p>The static link editor now can do dead code stripping. The new <em>ld</em>(1) option to do this is <strong>-dead_strip</strong>. There is also an additional option <strong>-no_dead_strip_inits_and_terms</strong> that can be used when <strong>-dead_strip</strong> is specified to cause all constructors and destructors to never be dead code stripped. The load map printed with the <em>ld</em>(1) option <strong>-M</strong> notes what was dead stripped from the input files.</p><p>There is one known bug with the tools that do dead code stripping. It is possible for some debugging information for types made to be stripped. This can lead to the debugger not being able to print the values of some variables and get unknow type errors.</p><p>For testing, the environment variable LD_DEAD_STRIP can be set. which causes <strong>-dead_strip</strong> to specified for all <em>ld</em>(1) commands that don't specify the <strong>-r</strong> option. The environment variable LD_NO_DEAD_STRIP_INITS_AND_TERMS likewise causes <strong>-no_dead_strip_inits_and_terms</strong> to specified for all <em>ld</em>(1) commands that don't specify the <strong>-r</strong> option. And the environment variable LD_DEAD_STRIP_DYLIB causes <strong>-dead_strip</strong> to specified for all <em>ld</em>(1) commands that have the <strong>-dylib</strong> option specified.</p><p>The static link editor determines what unreachable code and data can be stripped based on the references from the initial live symbols and blocks. The initial live symbols include the symbols to be exported in the linked output. The set of exported symbols are specified with the <strong>-exported_symbols_list</strong> option or a list of symbols not to be exported is specified with the <strong>-unexported_symbols_list</strong> option. If no exported symbols are specified and the output is not an executable (shared library, bundle, etc) it is assumed all global symbols are to be exported. If the output is a shared library and a shared library initialization symbol is specified with <strong>-init</strong>  <em>symbol_name</em> option then that <em>symbol_name</em> is an initial live symbol. If the output is an executable then the block that contains the entry point or the symbol specified with the <strong>-e</strong> <em>symbol_name</em> is an initial live symbol. Other symbols can be marked by the programmer as an initial live symbols with the GNU compiler's __attribute__((used)). For Objective-C code, the compiler will also mark the blocks of Objective-C runtime data it produces so they are part of the initial live blocks. For symbols marked referenced dynamically (via the REFERENCED_DYNAMICALLY bit in &lt;mach-o/nlist.h>), such as the symbol <strong>_environ</strong> from /usr/lib/crt1.o, they are also part of the initial live symbols.</p><p>Before turning on the <strong>-dead_strip</strong> option your project will first have to be "ported" to work with dead code stripping. This will include changing from -gused (the default for -g) to -gfull and re-compiling all of the objects files being linked into your program with the new compiler from the Mac OS X June 2004 release. Also if your building an executable that loads plugins, which uses symbols from the executable, you will have to make sure the symbols the plugins use are not stripped (by using __attribute__((used)) or the <strong>-exported_symbols_list</strong> option). If you are using an export list and building a shared library, or an executable that will be used with ld(1)'s -bundle_loader flag, you need to include the symbols for exception frame information in the export list for your exported C++ symbols. These symbols end with .eh and can be seen with the nm(1) tool.</p><p>Various auto configure test programs that expect to get undefined symbol errors when they have a possible undefined symbol referenced from dead code can't use the <strong>-dead_strip</strong> option. Because the dead code and the unused undefined reference will be stripped allowing the program to successfully linked. We have geneally found that auto configure programs on UNIX based system can't be configured with the <strong>-dead_strip</strong> option on.</p><p>Recompiling with a new compiler is required to get effective dead code stripping. As it marks the object files it creates as OK to divide up the section contents into individual blocks by the symbols that are in the object files. Objects not marked are assumed to be generated from assembly code, older compilers, or from compilers that are not know to be safe to divide up their section contents by their symbols. For non-marked objects if any symbol is used from a section the entire section is kept and not dead stripped.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_15" title="Work around for objects incorrectly marked object files as OK to divide up"></a><h4>Work around for objects incorrectly marked object files as OK to divide up</h4><p>The new compiler unconditionally marks the object files it creates as OK to divide up. There may be cases, especially with <strong>asm()</strong> statements, that it should not mark the object it creates as OK to divide up. In these cases turning on the <strong>-dead_strip</strong> option may fail to produce a working program because it can incorrectly strip a live block. The reason for this is that the heuristic of dividing up the section contents by their symbols is incorrect if any individual block has more than one symbol. This makes the heuristic fragile.</p><p>The reason that the current dead code stripping inplementation is fragile is because the static linker is guessing at the structure of the program. Namely it is guess at which bytes of a section make up a individual block of code or data. It makes its guess based on the symbols that are in the object files being linked. In the same way it guesses for the blocks it uses for the <strong>-sectorder</strong> option. With the difference being that all sections are broken up into individual blocks with the goal to eliminate the unreachable (dead) blocks in the linked output. The reason this is fragile is that all the symbols in an object file may not be the start of an individual block.</p><p>As a workaround to the problem of incorrectly strip a live block you can produce a -sectorder file for objects that have section contents that must be linked whole. You would create a line in the sectorder file specifying the object and the psuedo symbol .section_all. For example if .text section of crt1.o and the archive member of darwin-tramp.o in libgcc.a must be linked whole, you would add the following:</p><div class="codesample"><table><tr><td scope="row"><pre>/usr/lib/crt1.o:.section_all<span></span></pre></td></tr><tr><td scope="row"><pre>/usr/lib/libgcc.a:darwin-tramp.o:section_all<span></span></pre></td></tr></table></div><p>to your <em>order_file</em> for the __TEXT __text section. Then use the ld(1) option <strong>-sectorder</strong> __TEXT __text <em>order_file</em> when linking.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_16" title="Current design limitations"></a><h4>Current design limitations</h4><p>There is a limitation in the current design for individual blocks that have no symbols visible in the object file. Symbols that are temporary labels that start with a 'L', or symbols that have been stripped. An individual block that starts with these symbols will appear to be part of the previous block that has a symbol in the object file. This can result in a linked image that does not have all of its dead code stripped. When what would have been a dead individual block becomes part of the previous block which is live. Causing the dead individual block and all of its references to be live.</p><p>By default when there are multiply defined symbols in the linked objects this is treated as an error. Even when the <strong>-dead_strip</strong> option is specified. Unused multiply defined symbols can be stripped if the strongly discouraged <strong>-m</strong> option is also specified. The duplicate symbols other than the first symbol may still end up being used in the resulting output file through local references however.</p><p>Symbols from the linked objects in the output file that are only referenced via a shared library will not be dead stripped. Currently the static linker marks them with the REFERENCED_DYNAMICALLY bit in &lt;mach-o/nlist.h> which causes them to be live.</p><p>There is no support in the current design to dead strip branch islands created with the compiler option <strong>-mlongcall</strong>.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_17" title="Assembly level and object file support for dead code stripping"></a><h3>Assembly level and object file support for dead code stripping</h3><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_18" title="Marking of objects that can have their section contents divided up"></a><h4>Marking of objects that can have their section contents divided up</h4><p>The marking of object files which are OK to divide their section contents into individual blocks is done with the new assembler directive <strong>.subsections_via_symbols</strong>. This directive sets a previously unused bit in the object file's mach_header structure in the flags field. This bit is defined as the following new constant in the header file &lt;mach-o/loader.h>:</p><div class="codesample"><table><tr><td scope="row"><pre>#define MH_SUBSECTIONS_VIA_SYMBOLS 0x2000 /* safe to divide up the sections into sub-sections via symbols for dead code stripping */<span></span></pre></td></tr></table></div><p>This can be see with <em>otool</em>(1)'s <strong>-hv</strong> options and shows up as <strong>SUBSECTIONS_VIA_SYMBOLS</strong> in the following output:</p><div class="codesample"><table><tr><td scope="row"><pre>% otool.NEW -hv a.out a.out: Mach header magic cputype cpusubtype filetype ncmds sizeofcmds flags MH_MAGIC PPC ALL OBJECT 3 228 SUBSECTIONS_VIA_SYMBOLS<span></span></pre></td></tr></table></div><p>The new assembler directive <strong>.subsections_via_symbols</strong> can be added to hand written assembly files provided the symbols are at the start of individual blocks. Since this applies to the entire file, when multiple object files are combined by the static link ediror, ld(1), to produce a relocable object, using the -r flag, if any of the objects do not have this flag set the output file will not have this flag set.</p><p>For example this assembly code contains only two individual blocks but four symbols:</p><div class="codesample"><table><tr><td scope="row"><pre>.text .globl _plus_three _plus_three: addi r3, r3, 1 .globl _plus_two _plus_two: addi r3, r3, 1 .globl _plus_one _plus_one: addi r3, r3, 1 blr  .globl _some_other_routine _some_other_routine: blr<span></span></pre></td></tr></table></div><p>And if the new assembler directive <strong>.subsections_via_symbols</strong> were added to the above code the static link editor would make 4 blocks about of the above code. Then if the program uses _add_three but not _add_two or _add_one it will get the wrong answer if the <strong>-dead_strip</strong> option is used. As the blocks for _add_two or _add_one will be dead stripped. And if _some_other_routine is not live then when _add_three is called it will fall through to what ever bit of code follows it and likely crash.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_19" title="The .no_dead_strip assembler directive"></a><h4>The .no_dead_strip assembler directive</h4><p>The new assembler directive <strong>.no_dead_strip</strong>  <em>symbol_name</em> can be used to specify that a symbol is not to be dead stripped. For example:</p><div class="codesample"><table><tr><td scope="row"><pre>.no_dead_strip _my_version_string .cstring _my_version_string: .ascii "cctools-501"<span></span></pre></td></tr></table></div><p>This can be seen (in object files only) with <em>nm</em>(1)'s <strong>-m</strong> option and shows up as <strong>[no dead strip]</strong> in the following output:</p><div class="codesample"><table><tr><td scope="row"><pre>% nm -m x.o 00000000 (__TEXT,__cstring) non-external [no dead strip] _my_version_string<span></span></pre></td></tr></table></div><p>The <strong>.no_dead_strip</strong> directive is generated by the new compiler when the __attribute__((used)) is specified on a symbol.</p><p>In object files, this bit is N_NO_DEAD_STRIP as defined in &lt;mach-o/nlist.h>. And is set in relocatable .o files (MH_OBJECT filetype) only in the n_desc field of an nlist struct.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_20" title="The section attribute no_dead_strip"></a><h4>The section attribute no_dead_strip</h4><p>The new section attribute <strong>no_dead_strip</strong> can be specified on a section to cause its entire contents to not to be dead stripped. The new compiler uses this for all Objective-C sections it creates. For example:</p><div class="codesample"><table><tr><td scope="row"><pre>.section __OBJC, __image_info, regular, no_dead_strip<span></span></pre></td></tr></table></div><p>In object files, this bit is S_ATTR_NO_DEAD_STRIP as defined in &lt;mach-o/loader.h>. And is set in the flags field of a section struct.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_21" title="The section attribute live_support"></a><h4>The section attribute live_support</h4><p>The new section attribute <strong>live_support</strong> can be specified on a section to cause its blocks to not be dead stripped if they reference something that is live. The new compiler uses this for C++ exception frame information. For example:</p><div class="codesample"><table><tr><td scope="row"><pre>.section __TEXT, __eh_frame, coalesced, no_toc+strip_static_syms+live_support<span></span></pre></td></tr></table></div><p>In object files, this bit is S_ATTR_LIVE_SUPPORT as defined in &lt;mach-o/loader.h>. And is set in the flags field of a section struct.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_22" title="The assembler has a new .machine directive"></a><h4>The assembler has a new .machine directive</h4><p>The assembler now takes a new <strong>.machine</strong> directive as an alternate to using the command line <strong>-arch</strong> <em>arch_name</em> option. It is specified as for example as:</p><div class="codesample"><table><tr><td scope="row"><pre>.machine ppc970<span></span></pre></td></tr></table></div><p>Where <em>ppc970</em> can be any <em>arch_name</em> that would appear in the <strong>-arch</strong> <em>arch_name</em> option as listed on the <em>arch</em>(3) man page for the assembler's architecture family.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_23" title="Notes Specific to Mac OS X 10.3.4 Release"></a><h2>Notes Specific to Mac OS X 10.3.4 Release</h2><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_24" title="New Features"></a><h3>New Features</h3><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_25" title="Improved launch times of applications"></a><h4>Improved launch times of applications</h4><p>The dynamic linker has been changed that improve launch times of applications.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_26" title="The redo_prebinding command supports unprebinding"></a><h4>The redo_prebinding command supports unprebinding</h4><p>The <em>redo_prebinding</em>(1) command has a new option, <strong>-u</strong>, that does a unprebind operation. The unprebind operation produces a canonical form of a Mach-O file that can be used for binary diffing and patching. Bundles and non-prebound executables and dylibs can also be canonicalized with the unprebind operation.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_27" title="Notes Specific to Mac OS X December 2003 Release"></a><h2>Notes Specific to Mac OS X December 2003 Release</h2><p>There are no notes specific to the Mac OS X December 2003 release of the compiler tools.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_28" title="Notes Specific to Mac OS X 10.3 Release"></a><h2>Notes Specific to Mac OS X 10.3 Release</h2><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_29" title="New Features"></a><h3>New Features</h3><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_30" title="The static linker has an option to find @executable_path dynamic libraries"></a><h4>The static linker has an option to find @executable_path dynamic libraries</h4><p>Added the <strong>-executable_path</strong> <em>path_name</em> option to <em>ld</em>(1) where <em>path_name</em> is is used to replace @executable_path for dependent libraries.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_31" title="Notes Specific to Mac OS X June 2003 Developer Release"></a><h2>Notes Specific to Mac OS X June 2003 Developer Release</h2><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_32" title="New Features"></a><h3>New Features</h3><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_33" title="The compiler tools now support the PowerPC 970 processor"></a><h4>The compiler tools now support the PowerPC 970 processor</h4><p>The compiler tools now support the PowerPC 970 processor. The architecture specific flag <strong>-arch ppc970</strong> is used to specify this specific processor. The assembler will only assemble 64-bit instructions and other PowerPC AS User Instruction Set Architecture Version 2.00 instructions supported by the PowerPC 970 processor when <strong>-arch ppc970</strong> or <strong>-force_cpusubtype_ALL</strong> is specified.</p><p>To specify branch predictions which use the AT bit encodings for <em>The branch is very likely to be taken</em> and <em>The branch is very likely not to be taken</em> the two character suffixes ++ and -- are used. For example:</p><div class="codesample"><table><tr><td scope="row"><pre>bge-- foo<span></span></pre></td></tr></table></div><p>The single character suffixes + and - continue to encode branch predictions which use the Y-bit encoding by default. The encoding can be changed for the single character suffixes to use the AT bit encodings with the assembler flag <strong>-static_branch_prediction_AT_bits</strong> (see the <em>as</em>(1) man page for more details).</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_34" title="The compiler tools now support stub libraries"></a><h4>The compiler tools now support stub libraries</h4><p>The compiler tools now support stub libraries created from dynamic libraries which are used in the SDKs. Stub libraries are created via <em>strip</em>(1) and the new <strong>-c</strong> option. And can be linked against in place of the actual dynamic library.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_35" title="The static linker now can search for libraries first in the library paths"></a><h4>The static linker now can search for libraries first in the library paths</h4><p>By default when the <strong>-dynamic flag</strong> is in effect, the <strong>-l</strong><em>x</em> and <strong>-weak-l</strong><em>x</em> options first search for a file of the form lib<em>x</em>.dylib in each directory in the library search path, then a file of the form lib<em>x</em>.a is searched for in the library search paths. The new option <strong>-search_paths_first</strong> changes it so that in each path lib<em>x</em>.dylib is searched for then lib<em>x</em>.a before the next path in the library search path is searched.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_36" title="The static linker now supports forcing a dynamic library to be weak"></a><h4>The static linker now supports forcing a dynamic library to be weak</h4><p>Added the <strong>-weak_framework</strong>, <strong>-weak_library</strong> and <strong>-weak-l</strong> options to <em>ld</em>(1) to force the dynamic library and the symbols referenced from it to be marked as weak imports. See the <em>ld</em>(1) man page for more details.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_37" title="The static linker now has a work around for not having dead code stripping"></a><h4>The static linker now has a work around for not having dead code stripping</h4><p>Added the <strong>-undefined define_a_way</strong> option to <em>ld</em>(1) as a work a round to not having dead-code stripping that also strips out references to undefined symbols from the dead code. Which leads to link time failures due to undefined symbols. With this option <em>ld</em>(1) defines the remaining undefined symbols as private definitions and allows the link to succeed. The program then runs as long as it does not use any of the undefined symbols.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_38" title="Notes Specific to Mac OS X November 2002 Developer Release"></a><h2>Notes Specific to Mac OS X November 2002 Developer Release</h2><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_39" title="New Features"></a><h3>New Features</h3><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_40" title="Exports lists can now be specified to the static linker"></a><h4>Exports lists can now be specified to the static linker</h4><p>The static link editor, <em>ld</em>(1), now has two new options, <strong>-exported_symbols_list</strong> <em>filename</em> and <strong>-unexported_symbols_list</strong> <em>filename</em> to limit the global symbols in the linked output file. This was previously done by with an <em>nmedit</em>(1). By using the new options to <em>ld</em>(1) the use of <em>nmedit</em>(1) can be eliminated resulting in faster build times.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_41" title="The static linker now can build single module dynamic libraries"></a><h4>The static linker now can build single module dynamic libraries</h4><p>The static link editor, <em>ld</em>(1), now has a new option, <strong>-single_module</strong>, to build a dynamic library containing only one module. This was previously done by first creating a master.o file with an <em>ld</em>(1) <strong>-r</strong> step and then using the master.o to created the dynamic library. By using the new <strong>-single_module</strong> option to <em>ld</em>(1) this first step can be eliminated resulting in faster build times.</p><p>The default in the static link editor remains the same and dynamic libraries are built with multiple modules. The new flag <strong>-multi_module</strong> has also been added to allow this to be explicitly specified.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_42" title="The static linker&#39;s -s option now works like strip on dynamic executables"></a><h4>The static linker's -s option now works like strip on dynamic executables</h4><p>The static link editor's <strong>-s</strong> option can now be used to strip an executable that use the dynamic link editor. This will produce the same result as running <em>strip</em>(1) with no options on the executable. By using the <strong>-s</strong> option when building an executable the <em>strip</em>(1) step can be eliminated resulting in faster build times.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_43" title="Notes Specific to Mac OS X 10.2 Release"></a><h2>Notes Specific to Mac OS X 10.2 Release</h2><p>The compiler tools for the MacOS X 10.2 Release must be used with prebound images (executables, and shared libraries) from the MacOS X 10.2 User Release. The compiler tools in MacOS 10.1 will not work with prebound images from with the MacOS X 10.2 User Release. If the 10.1 compiler tools are used on prebound images from the MacOS X 10.2 User Release the compiler tools will generate error messages indicating that the image is a malformed file.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_44" title="New Features"></a><h3>New Features</h3><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_45" title="The dynamic linker now supports weak references and weak dylibs"></a><h4>The dynamic linker now supports weak references and weak dylibs</h4><p>The dynamic linker now supports weak symbol references and weak dymamic libraries. When creating a binary with the static link editor if all the symbols referenced from a given dependent dynamic library are weak references then the library is marked weak. When the binary is used at execution time and a weak library is missing the dynamic linker will not cause an error. For all weak symbols that are missing execution time the dynamic linker uses zero as their address. This allows a weak symbol's address to be tested for zero at runtime allowing the code to avoid using the weak symbol when it is missing. Binaries that use weak references require a dynamic linker from Mac OS X 10.2 or later.</p><p>To indicate a symbol is to be a weak reference the __attribute((weak_import)) is used on the prototype of the symbol. When a binary is created by the static link editor normally the all the undefined symbol references of the object files being linked should be consistent for each undefined symbol. That is all undefined symbols should either be weak or non-weak references. If they are not by default this is treated as an error and can be changed with the ld(1) <strong>-weak_reference_mismatches</strong> <em>treatment</em> flag (see the ld(1) man page for more details).</p><p>Weak referenced symbols and weak libraries are only created in the output by the static link editor, <em>ld</em>(1), when the MACOSX_DEPLOYMENT_TARGET environment variable is set to 10.2. If not a warning is generated when a weak reference would be in the output and it is not marked weak. Note the default for the MACOSX_DEPLOYMENT_TARGET environment variable 10.1 so weak referenced symbols and weak libraries are not created by default. See the <em>ld</em>(1) man page for more information on the MACOSX_DEPLOYMENT_TARGET environment variable.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_46" title="redo_prebinding can now slide dylibs"></a><h4>redo_prebinding can now slide dylibs</h4><p>The redo_prebinding(1) command now can slide dymamic libraries to new prefered addresses (see the man page for more details).</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_47" title="Notes Specific to Mac OS X 10.1 Release"></a><h2>Notes Specific to Mac OS X 10.1 Release</h2><p>You must use the 10.1 compiler tools with images (executables, plugins and shared libraries) created with the 10.1 tools. The compiler tools in MacOS 10.0 will not work with images created with the 10.1 compiler tools. If you attempt to use the 10.0 compiler tools on images created with the 10.1 compiler tools, error messages may result indicating that the image is a malformed file.</p><p>By default the compiler tools build images using the new two-level namespace binding semantics, which has important consequences for compatibility with Mac OS X 10.0 (see below for more information).</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_48" title="New Features"></a><h3>New Features</h3><p>The following new features have been added to the Compiler Tools for the Mac OS X 10.1 system release.</p><ul class="spaceabove"><li class="li"><p>The compiler tools now support two-level namespaces for binding undefined references from shared libraries. In flat namespace images, all symbols are referenced globally using a single name table. In two-level namespace images, symbols are referenced by library name and symbol name. This prevents multiple-defined-symbol errors when one image exports the same symbol as another image in the same program. You must rebuild your applications and plugins to take advantage of this feature, and there are compatibility restrictions with Mac OS X 10.0 that you should understand. For more information see the <em>ld</em>(1) man page and the <em><!--a target="_top" -->Two-Level Namespace Executables Release Notes<!--/a--></em>.</p></li><li class="li"><p>The dynamic linker now has API's for doing two-levelnamespace lookups. They are <code><a href="../../../documentation/DeveloperTools/Reference/MachOReference/Reference/reference.html#//apple_ref/c/func/NSAddImage" target="_top">NSAddImage</a></code>, <code><a href="../../../documentation/DeveloperTools/Reference/MachOReference/Reference/reference.html#//apple_ref/c/func/NSLookupSymbolInImage" target="_top">NSLookupSymbolInImage</a></code> and <code><a href="../../../documentation/DeveloperTools/Reference/MachOReference/Reference/reference.html#//apple_ref/c/func/NSIsSymbolNameDefinedInImage" target="_top">NSIsSymbolNameDefinedInImage</a></code>. For more information see the NSModule(3) man page. [This fixes Apple bug number 2689833.]</p></li><li class="li"><p>Prebinding is now documented in <em><!--a target="_top" -->Prebinding Release Notes<!--/a--></em>. [This fixes Apple bug number 2611234.]</p></li></ul><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_49" title="Notes Specific to Mac OS X 10.0 Release"></a><h2>Notes Specific to Mac OS X 10.0 Release</h2><p>There are no notes specific to the Mac OS X 10.0 release of the compiler tools.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_50" title="Notes Specific to Mac OS X Public Beta Release"></a><h2>Notes Specific to Mac OS X Public Beta Release</h2><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_51" title="New Features"></a><h3>New Features</h3><p>The following new features have been added to the Compiler Tools since the Mac OS X Developer Release 4.</p><ul class="spaceabove"><li class="li"><p>The dynamic linker now calls shared library initialization routines in their dependent order (reference number 2441683).</p></li><li class="li"><p>The new function __initialize_Cplusplus() now can be called from a shared library initialization routine to cause the static C++ objects in the library to be initialized. This allows shared library initialization routines to make use of statically initialized C++ objects (reference number 2441683).</p></li><li class="li"><p>The dynamic linker now supports module termination functions for all types of images (executables, plugins that are not unloaded and shared libraries). See the decription below as part of the notes specific to Mac OS X Developer preview of module termination functions (reference number 2469527).</p></li><li class="li"><p>The compiler tools support the new directory layout for MacOS X Public Beta. The new location for Frameworks local to the machine is /MacOSX/Library/Framework (in DP4 and previous releases this was /Local/Library/Frameworks).</p></li></ul><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_52" title="Notes Specific to Mac OS X Developer Release 4"></a><h2>Notes Specific to Mac OS X Developer Release 4</h2><p>There are no notes specific to the compiler tools for Developer Release 4.</p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_53" title="Notes Specific to Mac OS X Developer Release 3"></a><h2>Notes Specific to Mac OS X Developer Release 3</h2><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_54" title="New Features"></a><h3>New Features</h3><p>The following new features have been added to the Compiler Tools since the Mac OS X Developer Preview Release.</p><ul class="spaceabove"><li class="li"><p>Dynamic shared libraries now can have a dynamic shared library initialization routine (reference number 2367584). This routine is specified to libtool(1) with the new "-init <em>symbol_name</em>" argument. The library initialization routine is called before any symbol is used from the library including C++ static initializers (and #pragma CALL_ON_MODULE_BIND routines). So the code in a library initialization routine or code called by it can not depend on C++ static initializers. Also code in a library initialization routine or code called by it can not call any of the dynamic linker API, &lt;mach-o/dyld.h>, otherwise that could result in more than one library initialization routine being partially executed on the stack.</p></li><li class="li"><p>The dynamic linker now supports shared library install names that start with "@executable_path/" and substitutes the directory path of the executable for "@executable_path/"when locating the library. This requires a kernel from Mac OS X Developer Release 2 or later. Without that kernel, this feature can only be used if argv[0] is in fact the name of the executable and it is an absolute path or relative to the current directory (contains at a '/' in the argv[0] string).</p></li><li class="li"><p>The <code><a href="../../../documentation/DeveloperTools/Reference/MachOReference/Reference/reference.html#//apple_ref/c/func/NSLinkModule" target="_top">NSLinkModule</a></code> API now has an option to cause it to return when there is an error loading the module and a new API <code><!--a target="_top" -->NSLinkEditError<!--/a--></code> to get the error information. To use this the constant NSLINKMODULE_OPTION_RETURN_ON_ERROR needs to be or'ed into the options parameter to <code><a href="../../../documentation/DeveloperTools/Reference/MachOReference/Reference/reference.html#//apple_ref/c/func/NSLinkModule" target="_top">NSLinkModule</a></code>. Then if NSLinkModule returns NULL the error information can be retrieved with NSLinkEditError.</p><p>The NSLINKMODULE_OPTION_RETURN_ON_ERROR option is an alternative method to the existing dyld error handling which fits better with a plugin model. With the NSLINKMODULE_OPTION_RETURN_ON_ERROR option, the model for handling errors is to simply return without any changes to the program. To support this model of error handling a new API has been added to allow the programmer to get the error information that the dyld error handlers would normally have gotten. The API is similar to the dyld linkEdit error handler except that all the parameters are passed as pointers to be filled in.</p><div class="codesample"><table><tr><td scope="row"><pre>extern void NSLinkEditError(<span></span></pre></td></tr><tr><td scope="row"><pre>NSLinkEditErrors *c,<span></span></pre></td></tr><tr><td scope="row"><pre>int *errorNumber,<span></span></pre></td></tr><tr><td scope="row"><pre>const char **fileName,<span></span></pre></td></tr><tr><td scope="row"><pre>const char **errorString);<span></span></pre></td></tr></table></div><p>The last two parameters return pointers to static buffers allocated in the dynamic linker which get reused on subsequent calls to <code><!--a target="_top" -->NSLinkEditError<!--/a--></code>. The <code><!--a target="_top" -->NSLinkEditErrors<!--/a--></code> enum has been extended to include <code><!--a target="_top" -->NSLinkEditUndefinedError<!--/a--></code> and <code><!--a target="_top" -->NSLinkEditMultiplyDefinedError<!--/a--></code>.</p></li></ul><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_55" title="Notes Specific to Mac OS X Developer Preview Release"></a><h2>Notes Specific to Mac OS X Developer Preview Release</h2><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_56" title="New Features"></a><h3>New Features</h3><p>The following new features have been added to the Compiler Tools since the Mac OS X Server Release.</p><ul class="spaceabove"><li class="li"><p>The <code><a href="../../../documentation/DeveloperTools/Reference/MachOReference/Reference/reference.html#//apple_ref/c/func/NSLinkModule" target="_top">NSLinkModule</a></code> API now can create private modules and the new API <code><a href="../../../documentation/DeveloperTools/Reference/MachOReference/Reference/reference.html#//apple_ref/c/func/NSLookupSymbolInModule" target="_top">NSLookupSymbolInModule</a></code> allows symbols to be looked up in a private module. To do this the interface to <code><a href="../../../documentation/DeveloperTools/Reference/MachOReference/Reference/reference.html#//apple_ref/c/func/NSLinkModule" target="_top">NSLinkModule</a></code> has changed in a compatible way from:</p><div class="codesample"><table><tr><td scope="row"><pre>extern NSModule NSLinkModule(<span></span></pre></td></tr><tr><td scope="row"><pre>NSObjectFileImage objectFileImage,<span></span></pre></td></tr><tr><td scope="row"><pre>const char *moduleName,<span></span></pre></td></tr><tr><td scope="row"><pre>enum bool bindNow);<span></span></pre></td></tr></table></div><p>to:</p><div class="codesample"><table><tr><td scope="row"><pre>extern NSModule NSLinkModule(<span></span></pre></td></tr><tr><td scope="row"><pre>NSObjectFileImage objectFileImage,<span></span></pre></td></tr><tr><td scope="row"><pre>const char *moduleName,<span></span></pre></td></tr><tr><td scope="row"><pre>unsigned long options);<span></span></pre></td></tr></table></div><p>with the options as follows:</p><div class="codesample"><table><tr><td scope="row"><pre>#define NSLINKMODULE_OPTION_NONE 0x0<span></span></pre></td></tr><tr><td scope="row"><pre>#define NSLINKMODULE_OPTION_BINDNOW 0x1<span></span></pre></td></tr><tr><td scope="row"><pre>#define NSLINKMODULE_OPTION_PRIVATE 0x2<span></span></pre></td></tr></table></div><p>The first two are the same as bindNow with a value of FALSE and TRUE. The private options are used to load a private module. The API for getting to the symbols of a NSModule that has been privately linked is:</p><div class="codesample"><table><tr><td scope="row"><pre>extern NSSymbol NSLookupSymbolInModule(<span></span></pre></td></tr><tr><td scope="row"><pre>NSModule module,<span></span></pre></td></tr><tr><td scope="row"><pre>const char *symbolName);<span></span></pre></td></tr></table></div><p>Then to get the address of the returned NSSymbol, the existing <code><a href="../../../documentation/DeveloperTools/Reference/MachOReference/Reference/reference.html#//apple_ref/c/func/NSAddressOfSymbol" target="_top">NSAddressOfSymbol</a></code> API can be used.</p><p>The <code><a href="../../../documentation/DeveloperTools/Reference/MachOReference/Reference/reference.html#//apple_ref/c/func/NSUnLinkModule" target="_top">NSUnLinkModule</a></code> API is now implemented with enough functionality to make Apache work (reference number 2262020). It currently has the following limitations (to be fixed in future releases):</p><ul class="nested"><li class="nested li"><p>Only works for plugins (can only be called on modules that were returned by <code><a href="../../../documentation/DeveloperTools/Reference/MachOReference/Reference/reference.html#//apple_ref/c/func/NSLinkModule" target="_top">NSLinkModule</a></code>).</p></li><li class="nested li"><p>C++ plugins that have a static destructor can't be unloaded. The program will crash in atexit(3) when the unlinked destructor is attempted to be called.</p></li><li class="nested li"><p>Objective-C plugins should not be unloaded. The Objective-C runtime has not been updated to know about unloading and the result is very likely to crash the program.</p></li><li class="nested li"><p>The debugger has not been updated to know about unloading and trying to debug a program that unloads its plugins may confuse or crash the debugger.</p></li></ul><p>The interface to NSUnLinkModule has changed in a compatible way from:</p><div class="codesample"><table><tr><td scope="row"><pre>extern enum bool NSUnLinkModule(<span></span></pre></td></tr><tr><td scope="row"><pre>NSModule module,<span></span></pre></td></tr><tr><td scope="row"><pre>enum bool keepMemoryMapped);<span></span></pre></td></tr></table></div><p>to:</p><div class="codesample"><table><tr><td scope="row"><pre>extern enum bool NSUnLinkModule(<span></span></pre></td></tr><tr><td scope="row"><pre>NSModule module,<span></span></pre></td></tr><tr><td scope="row"><pre>int options);<span></span></pre></td></tr></table></div><p>where the options are:</p><div class="codesample"><table><tr><td scope="row"><pre>#define NSUNLINKMODULE_OPTION_NONE 0x0<span></span></pre></td></tr><tr><td scope="row"><pre>#define NSUNLINKMODULE_OPTION_KEEP_MEMORY_MAPPED 0x1<span></span></pre></td></tr><tr><td scope="row"><pre>#define NSUNLINKMODULE_OPTION_RESET_LAZY_REFERENCES 0x2<span></span></pre></td></tr></table></div><p>The first two are the same as keepMemoryMapped with a value of FALSE and TRUE. The reset lazy references option allows unloading modules with only call sites to undefined functions (direct calls, not calls through pointers) to not cause an undefined symbol error. Then if a subsequent module is loaded that defines symbols that were previously undefined, the call sites will use the new definitions. This is currently only implemented for PowerPC.</p><p>Support for module termination functions has been added for plugins (only). Currently the compiler pragma CALL_ON_UNLOAD (as well as CALL_ON_LOAD) is not yet implemented to use this feature as intended. A work around can be done in place of having the pragma:</p><div class="codesample"><table><tr><td scope="row"><pre>void my_term(void)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>/* do module termination */<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre>/* #pragma CALL_ON_UNLOAD my_term */<span></span></pre></td></tr><tr><td scope="row"><pre>#pragma SECTION data ".section __DATA, __mod_term_func,<span></span></pre></td></tr><tr><td scope="row"><pre>mod_init_funcs"<span></span></pre></td></tr><tr><td scope="row"><pre>static void (*dummy)(void) = my_term;<span></span></pre></td></tr><tr><td scope="row"><pre>#pragma SECTION data<span></span></pre></td></tr></table></div></li></ul><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_57" title="Notes Specific to Mac OS X Server Release"></a><h2>Notes Specific to Mac OS X Server Release</h2><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_58" title="New Features"></a><h3>New Features</h3><p>The following new features have been added to the Compiler Tools since the Rhapsody Developer Release 2:</p><ul class="spaceabove"><li class="li"><p>The 4.4bsd ar extended format #1 is now supported by the compiler tools. The default is to use 4.4bsd ar extended format #1 when creating static archives whose member names are longer than 16 characters or have spaces in the name. The tools that create static archives, ar(1), libtool(1) and ranlib(1), all take the options -T (to truncate member names) and -L (to used long member names, the default) (reference 1670513).</p></li><li class="li"><p>The AltiVec opcodes have been added to the Mac OS X PowerPC assembler. To assemble files with these instructions it requires the option -force_cpusubtype_ALL and then it is the code's responsibility to only use these instructions when the CPU supports them. (references 2237908, 2227999, 2213821, 2004760).</p></li><li class="li"><p>The header file &lt;mach-o/getsect.h> has been added to the system as the proper place to get the prototypes of the Mach-O routines. (reference 2227839).</p></li></ul><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_59" title="There are no Notes Specific to Rhapsody Developer Release 2"></a><h2>There are no Notes Specific to Rhapsody Developer Release 2</h2><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_60" title="Notes Specific to Rhapsody Developer Release"></a><h2>Notes Specific to Rhapsody Developer Release</h2><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_61" title="New Features"></a><h3>New Features</h3><p>The following new features have been added to the compiler tools since OPENSTEP 4.2 (NeXT):</p><ul class="spaceabove"><li class="li"><p>The PowerPC architecture is now supported via the <em>-arch ppc</em> switch.</p></li></ul><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_62" title="Known Problems"></a><h3>Known Problems</h3><p>These bugs are known to exist in the compiler tools:</p><p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_68" title="4.4BSD ar extended format #1 not compatible with compiler tools."></a><h3 class="tight">Radar #1670513</h3><p class="spaceabove">4.4BSD ar extended format #1 not compatible with compiler tools.</p><h5 class="tight">Description:</h5><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_63"></a><p>The 4.4 <strong>ar</strong> command can create an archive with the base name of an object file that is longer than 16 characters. With the <strong>-L</strong> option, it produces a format that makes the object file in the archive invisible to various tools, including the static link editor. This can lead to undefined symbols when this archive is linked against. Other tools like <strong>nm</strong> and <strong>ranlib</strong> also don't see the long-name object files in the archive. To avoid this problem, <strong>ar</strong> makes the <strong>-T</strong> option, which truncates names, a default option. The compiler tools will understand the extended format in future releases.</p><h5 class="tight">Workaround:</h5><p>Do not use the <strong>-L</strong> option with <strong>ar</strong> when creating archive libraries. Use the <strong>-T</strong> option (the default for the Premier release) to tuncate file names or use <strong>libtool -static</strong> to create archive libraries.</p></p><p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_69" title="The Mac OS X assembler is different from ppcasm."></a><h3 class="tight">Radar #1666993</h3><p class="spaceabove">The Mac OS X assembler is different from ppcasm.</p><h5 class="tight">Description:</h5><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_64"></a><p>The major difference is that the Mac OS X assembler is not TOC-based and uses two instructions to load a global or static item. The directives and the syntax of labels and directives of the two assemblers are very different. Also, the Mac OS X assembler is stricter in the parameter types and ranges for instructions. For more on this last topic, see "Instruction Parameter Differences," below.</p><h5 class="tight">Workaround:</h5><p>The difference between the Mac OS X assembler and the TOC-based model, plus the differences in directives and syntax, may necessitate significant rewriting of assembly code for the Developer Release. The strict parameter requirements might require rewriting of assembly code for the Developer Release but the resulting code should work with <strong>ppcasm</strong>.</p></p><p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_70" title="BSD 4.4 ar format is not compatible with compiler tools"></a><h3 class="tight">Radar #1670513</h3><p class="spaceabove">BSD 4.4 ar format is not compatible with compiler tools</p><h5 class="tight">Description:</h5><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_65"></a><p>The BSD 4.4 <strong>ar</strong> command, which creates an archive with object file names longer than 16 characters, produces a format that makes the object file invisible to various tools, including the static link editor. This can lead to undefined symbols when a program links against this archive. Other tools like <strong>nm</strong> and <strong>ranlib</strong> also don't see the object files with longer names in the archive.</p><h5 class="tight">Workaround:</h5><p>Use the <strong>-T</strong> option with <strong>ar</strong> to tuncate file names or use <strong>libtool -static</strong> to create archive libraries.</p></p><a name="//apple_ref/doc/uid/TP40001264-DontLinkElementID_66" title="PowerPC Assembly Instruction Parameter Differences"></a><h3>PowerPC Assembly Instruction Parameter Differences</h3><p>Register names can't be designated with just a number. You must refer to them with their register name. This restriction includes general registers (<code>r</code><em>N</em>), floating point registers, (<code>f</code><em>N</em>), condition registers (<code>cr</code><em>N</em>), and segment registers (<code>sr</code><em>N</em>). However, you can refer to special registers by their register number or their special register names. The special register names are in lowercase only (for example, <code>mq</code>, <code>xer</code>, <code>lr</code>, <code>ctr</code>, and <code>dsisr</code>).</p><p>For instance, for the <strong>ppcasm</strong> assember you could code a move from segment register instruction as:</p><div class="codesample"><table><tr><td scope="row"><pre>mfsr r24,9 ; ppcasm assembler<span></span></pre></td></tr></table></div><p>But, for the Mac OS X assembler, this same move would be coded as:</p><div class="codesample"><table><tr><td scope="row"><pre>mfsr r24,sr9 ; Mac OS X assembler<span></span></pre></td></tr></table></div><p>For instructions that take the value 0 or a register, shown in the processor manual as "(rA|0)", r0 can't be used and 0 must be coded. The Mac OS X assembler generates an error messages in these cases.</p><p>Where a numeric value is expected as a parameter, a register name can't be use. For example, the <strong>ppcasm</strong> assembler allows the following:</p><div class="codesample"><table><tr><td scope="row"><pre>lwz r1,r2(r3) ; ppcasm assembler<span></span></pre></td></tr></table></div><p>For Mac OS X, this must be coded as:</p><div class="codesample"><table><tr><td scope="row"><pre>lwz r1,2(r3) ; Mac OS X assembler<span></span></pre></td></tr></table></div><p>The Mac OS X assembler generates a warning if branch prediction is coded with an unconditional branch.</p><p>The Mac OS X assembler checks all fields for range errors and generates error messages if an expression is out of range. The <strong>ppcasm</strong> assembler simply uses the low <em>N</em> bits of the expression (where <em>N</em> is the field width) if the value is greater than zero. For example the simplified mnemonic:</p><div class="codesample"><table><tr><td scope="row"><pre>inslwi r<em>A</em>,r<em>S</em>,<em>n</em>,<em>b</em><span></span></pre></td></tr></table></div><p>is equivalent to</p><div class="codesample"><table><tr><td scope="row"><pre>rlwimi r<em>A</em>,r<em>S</em>,32-<em>b</em>,<em>b</em>,(<em>b</em>+<em>n</em>)-1<span></span></pre></td></tr></table></div><p>The following code:</p><div class="codesample"><table><tr><td scope="row"><pre>inslwi r17,r18,19,20 ; equivalent to rlwimi r17,r18,32-20,20,(20+19)-1<span></span></pre></td></tr></table></div><p>assembles to</p><div class="codesample"><table><tr><td scope="row"><pre>rlwimi r17,r18,12,20,6 ; where the low 5 bits (20+19)-1 is 6<span></span></pre></td></tr></table></div><p>with <strong>ppcasm</strong>. This generates an out-of-range error with the Mac OS X assembler.</p><p>For fields less than zero, the <strong>ppcasm</strong> assembler uses the value of zero. For example, the simplified mnemonic:</p><div class="codesample"><table><tr><td scope="row"><pre>clrlslwi r<em>A</em>,r<em>S</em>,<em>b</em>,<em>n</em><span></span></pre></td></tr></table></div><p>is equivalent to</p><div class="codesample"><table><tr><td scope="row"><pre>rlwinm r<em>A</em>,r<em>B</em>,<em>n</em>,<em>b</em>-<em>n</em>,31-<em>b</em><span></span></pre></td></tr></table></div><p>Thus the following code:</p><div class="codesample"><table><tr><td scope="row"><pre>clrlslwi r5,r6,7,8 ; equivalent to rlwinm r5,r6,8,7-8,31-7<span></span></pre></td></tr></table></div><p>assembles to:</p><div class="codesample"><table><tr><td scope="row"><pre>rlwinm r5,r6,7,0,24 ; where 7-8 gets turned into 0<span></span></pre></td></tr></table></div><p>with <strong>ppcasm</strong>. This generates an out-of-range error with the Mac OS X assembler.</p><p>All integer expressions in the Mac OS X assembler are signed 32-bit values. Parameters that are 16-bit signed or unsigned immediate values must agree in their upper 16 bits or the assembler generates an out-of-range error message.</p><p>For example:</p><div class="codesample"><table><tr><td scope="row"><pre>addi r1,r2,0xffff ; out of range for a 16-bit signed immediate<span></span></pre></td></tr></table></div><p>generates the message "Parameter error: expression out of range (parameter 3)".</p><p>The <code>addi</code> instruction takes a signed immediate value so it will sign extend its parameter to 32 bits before performing the operation. If the value 0xffffffff is intended, it would be coded as:</p><div class="codesample"><table><tr><td scope="row"><pre>addi r1,r2,0xffffffff<span></span></pre></td></tr></table></div><p>If this is half of a two-instruction 32-bit add it should be coded as:</p><div class="codesample"><table><tr><td scope="row"><pre>addis r1,0,ha16(expression)<span></span></pre></td></tr><tr><td scope="row"><pre>addi r1,r2,lo16(expression)<span></span></pre></td></tr></table></div><p>Many of the simplified mnemonics are implemented as Mac OS X assembler macros (as noted in the listing of PowerPC assembler instructions in the assember manual). Like all macros, the macro is expanded and assembled. This expansion can result in errors that can seem confusing when you look at the coded macro. For example, the simplified mnemonic:</p><div class="codesample"><table><tr><td scope="row"><pre>extldi r<em>A</em>,r<em>S</em>,<em>n</em>,<em>b</em><span></span></pre></td></tr></table></div><p>is equivalent to</p><div class="codesample"><table><tr><td scope="row"><pre>rldicr rA,rS,b,n-1<span></span></pre></td></tr></table></div><p>Thus the following code:</p><div class="codesample"><table><tr><td scope="row"><pre>extldi r1,r2,0,2<span></span></pre></td></tr></table></div><p>generates the error message "Parameter error: expression out of range (parameter 4)," which refers to "n-1" or "0-1", or parameter 4 of the expanded macro.</p><p>The instruction <code>tlbiex</code>, which has been removed from the PowerPC architecture, is not supported by the Mac OS X assembler. This instruction is assembled by <strong>ppcasm</strong>.</p>

        <br/><br/> 
        
        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2007 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2007-04-11<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/releasenotes/DeveloperTools/RN-CompilerTools/index.html%3Fid%3DTP40001264-3.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/releasenotes/DeveloperTools/RN-CompilerTools/index.html%3Fid%3DTP40001264-3.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/releasenotes/DeveloperTools/RN-CompilerTools/index.html%3Fid%3DTP40001264-3.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
</body>
</html>