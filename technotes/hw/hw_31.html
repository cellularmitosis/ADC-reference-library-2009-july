<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"        "http://www.w3.org/TR/1998/REC-html40-19980424/loose.dtd"><HTML><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note HW31: Sleep Queue Tasks</title><meta name="categories" content="Hardware"><meta name="week-posted" content="Apr 26, 1993 - May 7, 1993"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"><a name="//apple_ref/doc/uid/DTS10002500" title="Sleep Queue Tasks"></a><a name="top"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/MusicAudio/idxHardwareDrivers-date.html" target="_blank">Audio > Hardware & Drivers</a></li>
		<li><a href="../../referencelibrary/GraphicsImaging/idxHardwareDrivers-date.html" target="_blank">Graphics & Imaging > Hardware & Drivers</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxMusicAudio-date.html" target="_blank">Hardware & Drivers > Audio</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxEthernet-date.html" target="_blank">Hardware & Drivers > Ethernet</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxFireWire-date.html" target="_blank">Hardware & Drivers > FireWire</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxNetworking-date.html" target="_blank">Hardware & Drivers > Networking</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxPCIandPCCard-date.html" target="_blank">Hardware & Drivers > PCI and PC Card</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxPrinting-date.html" target="_blank">Hardware & Drivers > Printing</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxScanners-date.html" target="_blank">Hardware & Drivers > Scanners</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxSCSI-date.html" target="_blank">Hardware & Drivers > SCSI</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxSerial-date.html" target="_blank">Hardware & Drivers > Serial</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxStillCameras-date.html" target="_blank">Hardware & Drivers > Still Cameras</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxMassStorageDevices-date.html" target="_blank">Hardware & Drivers > Storage</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxUSB-date.html" target="_blank">Hardware & Drivers > USB</a></li>
		<li><a href="../../referencelibrary/Networking/idxHardwareDrivers-date.html" target="_blank">Networking > Hardware & Drivers</a></li>
		<li><a href="../../referencelibrary/Networking/idxPrinting-date.html" target="_blank">Networking > Printing</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note HW31</div>
<div id="pageheadsub">Sleep Queue Tasks</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->                     <P id = "menutext">         <A HREF="#Introduction">Introduction</A><BR><BR><A HREF="#Section1">How Do I Add an Entry to the Sleep Queue?</A><BR><BR><A HREF="#Section2">What Happens When the Macintosh Is Put to Sleep?</A><BR><BR><A HREF="#Section3">The Power Manager Calls My Subroutine From the<br> Sleep Queue but My Dialog Box Never Gets Drawn. Why?</A><BR><BR><A HREF="#Section4">The Sleep Queue Calls My Subroutine but It Cannot Find My Dialog Box. </A><BR><BR><A HREF="#Conclusion">Conclusion</A><BR><BR> <A HREF="#References">References</A><BR><BR><A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">This Technical Note demonstrates how one can write an application to display adialog box before a portable Macintosh goes to sleep.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Sep 01 1992]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR><!-- begin_content --><a name="Introduction"></a><h2>Introduction</h2><p>Many Developers have asked about the sleep queue code that is documented in thePower Manager chapter of <i>Inside Macintosh</i> Volume VI. Many have troubleswriting an application that adds an entry to the sleep queue and displays adialog or alert box when their routine receives a sleep demand. It all looksquite simple, but after trying it myself I was able to see that it is simplersaid than done.</p><p>The Power Manager chapter in <i>Inside Macintosh</i> Volume VI clearly statesthat "if you are writing an application that might be affected by the sleepstate of the computer, you can place in the sleep queue a routine that handleswhatever preparations are necessary to protect your program when the PowerBookenters the sleep state." It also goes on to say that </p><p>"You can, for example, display an alert box to inform the user of potentialproblems, or you can even display a dialog box that requires the user tospecify the action to be performed." </p><p>What the chapter fails to tell you is that there are special tricks that needto be done to display an alert box or dialog box from within an<b>application</b>.</p><p>This Technical Note describes the troubles that one may run into whenattempting to use a sleep queue routine to display an alert or dialog box whena sleep demand occurs. This note also explains just what one needs to do to getaround such difficult situations.</p><a name="Section1"></a><P><A HREF="#top">Back to top</A></P><h2>How Do I Add an Entry to the Sleep Queue?</h2><p>The Power Manager chapter in <i>Inside Macintosh</i> volume VI provides theassembly code needed to add an entry to the sleep queue.</p><a name="Section2"></a><P><A HREF="#top">Back to top</A></P><h2>What Happens When the Macintosh Is Put to Sleep?</h2><p>The Macintosh is usually put to sleep from within the Finder, when the userchooses Sleep from the Special menu. At this time the Power Manager walks thesleep queue and calls every subroutine that it finds there. When yoursubroutine gets called:</p><p><ul type="circle">	<li>The current A5 world is (usually) the Finder's. This means that you cannot access your applications globals from your sleep routine (unless you follow the guidelines further described in this note).</li>	<li>The current resource chain is also the Finder's so you can not access your applications resources either (unless you follow the guidelines further described in this note).</li></ul><a name="Section3"></a><P><A HREF="#top">Back to top</A></P><h2>The Power Manager Calls My Subroutine From the Sleep Queue but My Dialog BoxNever Gets Drawn. Why?</h2><p>To draw your dialog box, you need to restore your A5 world so you can use yourapplication's data and jump table. To do this, you will need to save a copy ofyour application's A5 to a memory location your subroutine can find later. Agood time to do this is when you install your sleep queue routine. Thefollowing code demonstrates how to do this:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>MyA5ref    PROC    EXPORT        ; store our A5 in memory        DS.L     1    ; location referenced by                ; myA5ref        ENDPStoreA5Ref    PROC    EXPORT        IMPORT    MyA5Ref        LEA     MyA5ref,a0    ; point to our storage area        MOVE.L     4(sp),d0        MOVE.L     d0,(a0)    ; save a copy of our A5 there        RTS        ENDPDoSleep    PROC    EXPORT        IMPORT     MyA5Ref,sleepdmd        LEA         MyA5ref,A0    ; point to our storage area.        MOVE.L     (a0),-(sp)    ; push our saved A5 onto the                                 ; stack        JSR         sleepdmd    ; call our C routine        ADDQ         #4,sp     ;We need to clear the stack                               ; since        RTS            ;C routines clear the stack on                               ; entry       ENDP            ;Pascal routines clear the                         ; stack on exit.</pre>	</TD></TR></TABLE></CENTER>                         <p>After this is done you will need to save the current A5 and restore A5 in yoursleep subroutine as follows:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>void SLEEPDMD(long theA5) {    short        item = 0;    long        oldA5;    DialogPtr    myDialog;    oldA5 = SetCurrentA5();    SetA5(theA5);    // Do whatever you need to do here to show your dialog box.    // The one thing to remember is that if adding a dialog box in    // your sleepQroutine, you should always make it a dialog box    // that times out. If the user is not present to answer the    // alert box or dialog box, control is never returned to the    // Power Manager, and the portable does not go to sleep. This is a    // great way to permanently burn in unwanted images in your screen!        :        :    // SetA5(oldA5);</pre>	</TD></TR></TABLE></CENTER>        <p>I used the following code to make sure that my dialog box timed out. You mayhave your own special technique for timing out your dialog box, butnevertheless you must ensure that the dialog box will time out in case the useris not present to answer the dialog box.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>void TimeoutDialog(short dialogID, long duration){    short itemHit = 0;    long startTicks = 0;    DialogPtr dialog = nil;    dialog = GetNewDialog(dialogID, nil, (WindowPtr) -1);    ShowWindow(dialog);    startTicks = TickCount();    while(((TickCount - startTicks) &lt; duration) &amp;&amp; (itemHit !=    kOKButtonItemID))    {    ModalDialog(nil, &amp;itemHit);    }    DisposeDialog(dialog);}</pre>	</TD></TR></TABLE></CENTER><a name="Section4"></a><P><A HREF="#top">Back to top</A></P><h2>The Sleep Queue Calls My Subroutine but It Cannot Find My Dialog Box.  </h2><p>In the same way that the Finder's world is unable to find your application'sglobals (because they reside in your application's A5 world), the Finder isalso unable to access your dialog box's resource. When the user chooses Sleepfrom the menu, the Finder tries to access the application's dialog resource.The Finder knows nothing about the application's resource list, nor does ithave access to it. It can only look to its own resource list to see if thedialog box can be found. To resolve this situation we will need to use the sametrick we used above. We need to save our dialog box's resource so that it willbe readily available when we call for it.</p><b></b><p>You might be tempted to create a DLOG/DITL pair, then call GetNewDialog atapplication startup time and save your dialogPtr away for later use by thesleep routine. However, this will not work because the dialog box will becreated in your application's window layer, so when you try to show the windowlater, it will appear behind the frontmost application (usually the Finder)when the portable is put to sleep.</p><p>One way around this is to create the dialog box from scratch using NewDialog atsleep time. This ensures that the dialog box is created and drawn in thefrontmost window layer when the PowerBook tries to go to sleep. You do not needto create the dialog box completely from scratch. You can read the items infrom a resource at application startup time, save the handle away, then passthis item handle to NewDialog. Then all you have to specify is the dialog box'srectangle.</p><p>This means that you will need to save your application's A5, the handle to thedialog box's DITL, and the pointer to the dialog box itself. This will ensurethat you will be properly pointing your application's window layer and thatyour dialog box will be the frontmost window when it appears.</p><p>Therefore, in your initialize routine your code will look as follows:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>void Initialize(){    InitGraf((Ptr) &amp;qd.thePort);    InitFonts();    InitWindows();    InitMenus();    TEInit();    InitDialogs(nil);    InitCursor();    gDitlHandle = Get1Resource('DITL', 130);    // error checking here    STOREA5REF(gMyDialog, gDitlHandle, SetCurrentA5());        :        :    /* install our assembler routine in the sleep process queue */    myRec.sleepQLink = 0;    myRec.sleepQType = slpQType;    myRec.sleepQProc = (ProcPtr) &amp;sleepQroutine;    myRec.sleepQFlags = 0;    SleepQInstall(&amp;myRec);        :        :} /* Initialize*/</pre>	</TD></TR></TABLE></CENTER><p>And your assembly code will look as follows:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>; Here's where we make storage for our dialog ptr, handle to our DITL and; your A5.MyA5ref    PROC    EXPORT        DS.L 1    ; storage for DialogPtr        DS.L 1    ; storage for handle to DITL        DS.L 1    ; storage for our saved A5         ENDP; void StoreA5Ref(DialogPtr theDialog, Handle ditlHandle, Ptr; SetCurrentA5());StoreA5Ref    PROC    EXPORT        IMPORT    MyA5Ref         LEA     MyA5ref,a0         MOVE.L     $4(sp),d0    ; grab our DialogPtr global         MOVE.L     d0,(a0)    ; store it         MOVE.L     $8(sp),d0    ; grab our ditlHandle global         MOVE.L     d0,4(a0)    ; store it         MOVE.L     $C(sp),d0    ; grab our saved A5         MOVE.L     d0,8(a0)    ; store it        RTS        ENDP; void StoreDialog(DialogPtr theDialog);StoreDialog    PROC    EXPORT        IMPORT    MyA5Ref        LEA     MyA5ref,a0        MOVE.L     $4(sp),d0    ; grab our DialogPtr global        MOVE.L     d0,(a0)    ; store it        RTS        ENDP; DialogPtr GetDialog();GetDialog    PROC    EXPORT        IMPORT    MyA5Ref         LEA     MyA5ref,a0         MOVE.L     (a0),d0    ; return our DialogPtr                              ; global        RTS        ENDP; void DoSleep(); Pushes our A5 and dialogPtr onto the stack, then calls our; sleep routine.DoSleep    PROC    EXPORT        IMPORT     MyA5Ref,sleepdmd        LEA     MyA5ref,A0        MOVE.L     (a0),-(sp)    ; push our saved DialogPtr        MOVE.L    $4(a0), -(sp)    ; push our saved ditlHandle        MOVE.L     $8(a0),-(sp)    ; push our saved A5        JSR     sleepdmd    ; call our C routine        ADD     #$C,sp     ; C routines clear the stack                ; on entry.        RTS        ; Pascal routines clear the        ENDP        ; stack on exit.;Our sleepQroutine (from the Power Manager Chapter of Inside Macintosh VI); looks as follows:sleepQroutine    PROC    EXPORTStackFrame    RECORD    {A6Link},DECRParamBegin    EQU        *ParamSize    EQU        ParamBegin-*RetAddr    DS.L        1A6Link    DS.L        1LocalSize    EQU        *    ENDR    IMPORT     sleepdmd,WAKEUPDMD    IMPORT     REVOKERQST    IMPORT     DoSleep    WITH    StackFrame    LINK    A6,#LocalSize    CMPI.L    #1,D0    ; Is it a sleep request?    BNE.S    @1    MOVE.L     #0,D0    ; We clear the register to            ; zero to allow for sleep.    BRA.S    Exit@1    CMPI.L    #2,D0    BNE.S    @2    BSR    DoSleep    ; Here you are supposed to do            ; whatever is needed            ; to prepare for sleep. ie: alert user.    BRA.S     Exit@2    CMPI.L    #3,D0    ; Are we being told to wake up?    BNE.S    @3    JSR     WAKEUPDMD    ; Here you are to do whatever is            ; needed to prepare for the operating            ; state and return control to the            ; Power Manager.    BRA.S    Exit@3    CMPI.L    #4,D0    ; Is a network sleep request            ; being cancelled?    BNE.S    Exit    JSR    REVOKERQSTExit    UNLK     A6    MOVEA.L     (SP)+, A0    ADDA.L     #ParamSize, SP    JMP    (A0)    END</pre>	</TD></TR></TABLE></CENTER>        <p>Our sleep subroutine will therefore look as follows:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>void SLEEPDMD(long theA5, Handle myDitl, DialogPtr myDialog) {    short        item = 0;    long        oldA5;    Rect        wRect;    oldA5 = SetCurrentA5();    SetA5(theA5);    //Need to build a dialog box from scratch using our previously saved DITL.    if (myDialog == nil) {           SetRect(&amp;wRect, 50, 50, 400, 200);           myDialog = NewDialog(nil, &amp;wRect, "", false, dBoxProc,           (WindowPtr) -1L, false, nil, myDitl);           STOREDIALOG(myDialog);    }    ShowWindow(myDialog);    SelectWindow(myDialog);    SetPort(myDialog);    while (item != 1) {        ModalDialog(NULL, &amp;item);    }    HideWindow(myDialog);    SetA5(oldA5);}/*sleepdmd*/</pre>	</TD></TR></TABLE></CENTER><a name="Conclusion"></a><P><A HREF="#top">Back to top</A></P><h2>Conclusion</h2><p>This note goes over a few special tricks that the Power Manager chapter in<i>Inside Macintosh</i> Volume VI failed to cover. The Power Manager chapterstates that an application could be written to add a routine in the sleep queueto put up a dialog or alert box before the system goes to sleep. It does notdiscuss any of the barriers that one may face when attempting to do this. Theabove tricks will allow you to use your application to display a dialog boxbefore the system goes to sleep. </p><a name="References"></a><h2>References</h2><P> Technical Note #256: <A HREF = "../pt/pt_35.html">Stand-Alone Code, ad nauseum</a></p><P> <i>develop</i> Issue #12: Another Take on Globals in Standalone Code</p><P> <i>Inside Macintosh, </i>Volume VI, Power Manager chapter</p><P> <i>Inside Macintosh, </i>Volume II, Segment Loader</p><P> "Tell me if you are sleepy" code sample available on <i>Developer CDSeries</i></p><P><A HREF="#top">Back to top</A></P><P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (60K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/hw_31.pdf">Download</A></P>               </TD>            </TR></table><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/hw/hw_31.html%3Fid%3DDTS10002500-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/hw/hw_31.html%3Fid%3DDTS10002500-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/hw/hw_31.html%3Fid%3DDTS10002500-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>