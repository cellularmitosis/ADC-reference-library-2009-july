<!-- legacy work start -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<!-- legacy work end -->


<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)

LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Implementing Callback Procedures (IM: S)  (deprecated)</Title>

<!-- legacy work start -->
        <META NAME="Generator" CONTENT="manual">
        <META http-equiv="content-type" CONTENT="text/html;charset=utf-8">
        <META NAME = "Copyright" CONTENT="Copyright 2007 Apple Inc. All Rights Reserved.">
        <META NAME="IndexTitle" CONTENT="Inside Macintosh: Sound (Not Recommended)">
        <meta name="xcode-display" content="render">

        <LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css"> <!-- before submitting, globally replace ".." with "developer.apple.com" -->
        <script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
<!-- legacy work end -->

</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<A NAME=HEADING199></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Sound-198.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Sound-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Sound-336.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Sound-200.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Sound-2.html"><B>Sound</B></A> / <BR><DD><A HREF="Sound-187.html"><B>Chapter 4 - Speech Manager</B></A> / <A HREF="Sound-193.html"><B>Using the Speech Manager</B></A></DL></FONT><P>
<HR>

<!-- legacy work start -->
<script type="text/javascript"> placeWatermark()</script>
<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
<i>Inside Macintosh: Sound</i> is deprecated as of Mac OS X v10.5. For new audio development in Mac OS X, use Core Audio. See the <a href="http://developer.apple.com/referencelibrary/MusicAudio/" target="_top">Audio</a> page in the ADC Reference Library.</p></div></div></div>
<!-- legacy work end -->


<BLOCKQUOTE>
<A NAME=HEADING199-0></A>
<H2><CODE><A NAME=MARKER-9-180></A></CODE>Implementing Callback Procedures</H2>
 <A NAME=MARKER-2-72></A><A NAME=MARKER-2-826></A>The Speech Manager makes it easy for you to synchronize other activities to speech generation by allowing you to install various types of callback procedures on a speech channel. A <B>callback procedure</B> is a procedure that executes whenever a certain type of event is about to occur or has occurred. For example, you might use a word callback procedure to ensure that whenever the Speech Manager is about to speak a word, the word is visible onscreen. Callback procedures also allow you to synchronize more mundane activities with the Speech Manager; for example, you might need to know when you can dispose of a certain text buffer that you had asked the Speech Manager to speak. This section provides an overview of the different callback procedures that you can define.<A NAME=MARKER-2-183></A><P>
 The <CODE>soTextDoneCallBack</CODE> and <CODE>soSpeechDoneCallBack</CODE> speech information selectors allow you to designate text-done and speech-done callback procedures. A <B>text-done callback procedure</B> executes whenever the Speech Manager finishes processing a buffer of text to be spoken. This procedure usually executes before the Speech Manager has finished generating speech from the text and indeed often before it has started. The text-done callback procedure provides a mechanism that allows you to specify to the Speech Manager an additional buffer of text to be spoken, so that speech is generated continuously. Once your text-done callback procedure executes, you can release the memory occupied by the text buffer processed. A <B>speech-done callback procedure</B> does not execute until after the Speech Manager has completed generating speech from a buffer of text.<A NAME=MARKER-2-51></A><A NAME=MARKER-2-55></A><A NAME=MARKER-2-56></A><A NAME=MARKER-2-334></A><A NAME=MARKER-2-324></A><P>
 <A NAME=MARKER-2-259></A><A NAME=MARKER-2-257></A>If your application uses or supports embedded speech commands, it may need to use the <CODE>soSyncCallBack</CODE> and <CODE>soErrorCallBack</CODE> speech information selectors to designate a synchronization callback procedure or an error callback procedure. A <B>synchronization callback procedure</B> executes whenever the Speech Manager encounters a synchronization command embedded within a text buffer to be spoken. An <B>error callback procedure</B> executes whenever the Speech Manager encounters an error when attempting to process an embedded speech command. The Speech Manager passes information about the synchronization message or type of error to your callback procedure. If your application does not use synchronization or error callback procedures, it can obtain information about synchronization or error messages by continually polling the speech channel by using the <CODE>GetSpeechInfo</CODE> function with the <CODE>soErrors</CODE> or <CODE>soRecentSync</CODE> selectors.<A NAME=MARKER-2-65></A><A NAME=MARKER-2-62></A><A NAME=MARKER-2-318></A><A NAME=MARKER-2-300></A><A NAME=MARKER-2-37></A><A NAME=MARKER-2-36></A><A NAME=MARKER-2-298></A><A NAME=MARKER-2-328></A><P>
 The <CODE>soPhonemeCallBack</CODE> and <CODE>soWordCallBack</CODE> speech information selectors allow you to designate a phoneme callback procedure and a word callback procedure, respectively. A <B>phoneme callback procedure</B> executes whenever a phoneme is about to be spoken on a speech channel. A <B>word callback procedure</B> executes whenever a word is about to be spoken on a speech channel.<A NAME=MARKER-2-339></A><A NAME=MARKER-2-307></A><P>
 Since callback procedures execute at interrupt time they face several restrictions, as discussed in detail in <I><A HREF="../Processes/Processes-2.html">Inside Macintosh: Processes</A></I>. Most significantly, your callback procedure must not allocate or move memory or call any Toolbox or Operating System routine that might do so. Thus, typically a callback procedure simply sets a flag variable; for example, a phoneme callback procedure might change a variable that indicates which phoneme is being spoken. Your application can then poll this flag variable each time through its main event loop and perform whatever activity is desired if it finds that the flag variable has changed. Remember to design callback procedures to execute quickly. <A NAME=MARKER-2-27></A><P>
 Because they execute at interrupt time, callback procedures also cannot access application global variables unless the A5 register contains the value of the application's A5, as discussed in <I><A HREF="../Memory/Memory-2.html">Inside Macintosh: Memory</A></I>. Fortunately, the Speech Manager provides a mechanism that makes it easy to ensure that A5 is set correctly. Your application can call the <CODE>SetSpeechInfo</CODE> function with the <CODE>soCurrentA5</CODE> selector to pass the application's A5 in the <CODE>speechInfo</CODE> parameter to the Speech Manager. The Speech Manager will then set the A5 register to the passed value whenever it executes an application-defined callback procedure for that speech channel.<A NAME=MARKER-2-294></A><A NAME=MARKER-2-203></A><P>
 Sometimes your application might wish to provide a callback procedure with additional information beyond that which can be provided by examining application global variables. For example, a callback procedure might need to know from which document speech is being generated. Your application can use the <CODE>SetSpeechInfo</CODE> function with the <CODE>soRefCon</CODE> selector to specify a 4-byte reference constant value--for example, a handle to a document record--that the Speech Manager passes to all callback procedures on a particular speech channel. Your application can use the same callback procedure on multiple speech channels, for each of which the Speech Manager can pass a different value to the callback procedure. Thus, as long as your application never uses a single speech channel to generate speech on multiple documents simultaneously, it can use the reference constant value mechanism to pass document-specific information to a callback procedure. Typically, you use the reference constant to contain a pointer or handle to more extensive information that the callback procedure would require.<A NAME=MARKER-2-204></A><A NAME=MARKER-2-205></A><A NAME=MARKER-2-320></A><P>
 <A HREF=#MARKER-9-207>Listing 4-6</A> shows how you can indicate to the Speech Manager both the value to which it should set the A5 register when it executes a callback procedure on a particular speech channel and the reference constant value to pass to that callback procedure.<P>
<B>Listing 4-6  <A NAME=MARKER-9-207></A>Setting up a speech channel for callbacks<A NAME=MARKER-2-208></A></B><P>
<PRE>
FUNCTION MySetupCallbacks (chan: SpeechChannel; refCon: LongInt): OSErr;
VAR
   myA5:       LongInt;                {application's A5}
   myErr:      OSErr;
BEGIN
   myA5 := SetCurrentA5;               {get application's A5}

   {Pass A5 value to speech channel.}
   myErr := SetSpeechInfo(chan, soCurrentA5, Ptr(myA5));
   IF myErr = noErr THEN               {set the reference constant}
      myErr := SetSpeechInfo(chan, soRefCon, Ptr(refCon));

   MySetupCallbacks := myErr;
END;
</PRE>
 The <CODE>MySetupCallbacks</CODE> function defined in <A HREF=#MARKER-9-207>Listing 4-6</A> uses the <CODE>SetSpeechInfo</CODE> function with both the <CODE>soCurrentA5</CODE> and the <CODE>soRefCon</CODE> selectors to prepare a specific speech channel for callbacks. Note that your application can call <CODE>MySetupCallbacks</CODE> as many times as desired for any particular speech channel; you might do this if you want to change the reference constant value to be passed to the speech channel.<A NAME=MARKER-2-209></A><A NAME=MARKER-2-210></A><P>
 Unlike other selectors, the <CODE>soCurrentA5</CODE> and <CODE>soRefCon</CODE> selectors do not require that you pass a pointer to the information you are specifying in the <CODE>speechInfo</CODE> parameter. Because an application's A5 value and a speech channel's reference constant value are always each 4 bytes long (the same size as the <CODE>speechInfo</CODE> parameter), your application passes these values directly, casting them to pointer values.<A NAME=MARKER-2-211></A><P>
 After your application sets up the A5 register and defines a reference constant value, it can install the appropriate type or types of callback procedure. <A HREF=#MARKER-9-212>Listing 4-7</A> shows how you might install a word callback procedure.<P>
<B>Listing 4-7  <A NAME=MARKER-9-212></A>Installing a word callback procedure<A NAME=MARKER-2-213></A></B><P>
<PRE>
PROCEDURE MyInstallWordCallback (chan: SpeechChannel; callbackProc: ProcPtr;
                                    refCon: LongInt);
VAR
   myErr:      OSErr;
BEGIN
   myErr := MySetupCallbacks(chan,  refCon);    {set up callbacks}
   myErr := SetSpeechInfo(chan, soWordCallBack, callbackProc);
   IF myErr &lt;&gt; noErr THEN
      DoError(myErr);                           {respond to an error}
END;
</PRE>
 The <CODE>MyInstallWordCallback</CODE> procedure defined in <A HREF=#MARKER-9-212>Listing 4-7</A> first prepares for callbacks by calling the <CODE>MySetupCallbacks</CODE> function defined in <A HREF=#MARKER-9-207>Listing 4-6</A> for the speech channel and reference constant value specified by the <CODE>chan</CODE> and <CODE>refCon</CODE> parameters, respectively. Then it installs the callback procedure specified by the <CODE>callbackProc</CODE> parameter by using the <CODE>SetSpeechInfo</CODE> function with the <CODE>soWordCallBack</CODE> speech information selector. If, for example, you want to pass to your word callback procedure a pointer to the window containing the document being used for speech generation, you might call the <CODE>MyInstallWordCallback</CODE> procedure like this:<A NAME=MARKER-2-214></A><P>
<PRE>
MyInstallWordCallback(mySpeechChan, @MyWordCallBack, LongInt(myWindow));
</PRE>
 <A HREF=#MARKER-9-215>Listing 4-8</A> defines a simple word callback procedure.<P>
<B>Listing 4-8  <A NAME=MARKER-9-215></A>A typical word callback procedure<A NAME=MARKER-2-216></A><A NAME=MARKER-2-217></A></B><P>
<PRE>
PROCEDURE MyWordCallback (chan: SpeechChannel; refCon: LongInt;
                           wordPos: LongInt; wordLen: Integer);
BEGIN
   gWindowBeingRead := WindowPtr(refCon);
   gWordPos := wordPos;
   gWordLen := wordLen;
END;
</PRE>
<DL>
<DT><B>WARNING</B>
<DD>Callback procedures are called at interrupt time and therefore must not attempt to allocate, move, or dispose of memory; dereference an unlocked handle; or call other routines that do so. Also, a callback procedure is a Pascal procedure and must preserve all registers other than A0-A1 and D0-D2. <EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 Because of the restrictions on callback procedures, a typical callback procedure usually just sets global flag variables based on the information passed to it. In <A HREF=#MARKER-9-215>Listing 4-8</A>, the callback procedure copies information from the <CODE>refCon</CODE>, <CODE>wordPos</CODE>, and <CODE>wordLen</CODE> parameters to the three global variables gWindowBeingRead, gWordPos, and gWordLen. You can then call a routine to check the values of these global variables once each time through your application's event loop and respond appropriately if the <CODE>gWindowBeingRead</CODE> global variable is not <CODE>NIL</CODE>. (Your application would have to initialize the variable to <CODE>NIL</CODE>.) For example, the routine might ensure that the word about to be spoken is visible onscreen and scroll the document appropriately if it is not.<A NAME=MARKER-2-218></A><P>
 Although they have different uses, speech-done callback procedures, synchronization callback procedures, error callback procedures, and phoneme callback procedures are typically defined in ways similar to that of the word callback procedure in <A HREF=#MARKER-9-215>Listing 4-8</A>. See <A HREF=Sound-250.html#MARKER-9-533>"Application-Defined Routines" beginning on page 4-82</A> for complete information on callback routines.<P>
 Text-done callback procedures are usually more complex than the other types. You can use a text-done callback procedure simply to determine when the Speech Manager has completed processing a buffer of input text. The callback procedure can just set a global flag variable that is inspected once each time through the application's main event loop; when the flag variable indicates that the input buffer processing is complete, you can dispose of the input buffer.<A NAME=MARKER-2-219></A><A NAME=MARKER-8-52></A><P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Sound-198.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Sound-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Sound-336.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Sound-200.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Sound-3.html">&copy; Apple Computer, Inc.</A><br>2 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
