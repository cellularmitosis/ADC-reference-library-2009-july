<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Writing a System Extension (IM: U)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING192></A>



<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="OSUtilities-191.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="OSUtilities-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="OSUtilities-222.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="OSUtilities-193.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="OSUtilities-2.html"><B>Operating System Utilities</B></A> / <BR><DD><A HREF="OSUtilities-188.html"><B>Chapter 9 - Start Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING192-0></A>
<H1><A NAME=MARKER-9-36></A><A NAME=MARKER-2-49></A>Writing a System Extension</H1>
 This section discusses <P>
<UL>
<LI>the profile of a system extension
<LI>the user interface for a system extension
<LI>how to create additional resources for a system extension
<LI>how to compile a system extension<P>
</UL>
 Before you begin to write a system extension, consider whether the feature that you have in mind is best governed by a system extension. A system extension does not enjoy the full status of an application. The user cannot launch a system extension. During system startup, each system extension is simply loaded and executed in a temporary heap that the system deallocates after the extension is called. <P>
<A NAME=HEADING192-7></A>
<H2>Profile of a System Extension</H2>
 A <B>system extension </B>is a file (of file type '<CODE>INIT</CODE>') containing a code resource of type '<CODE>INIT</CODE>' and additional other resources. A system extension typically contains code that provides a system-level service, such as a printer driver or a patch to a system software routine, and it contains code that loads this system-level service into the system at system startup time. <P>
 <A HREF=#MARKER-9-50>Listing 9-1</A> illustrates code for a simple system extension called <CODE>MySampleINIT</CODE>. When launched at system startup, <CODE>MySampleINIT</CODE> loads the <CODE>MyShutDownBeep</CODE> code resource into the system heap, installs a pointer to the shutdown code in the shutdown queue, and displays an icon indicating whether the installation succeeded or failed. The <CODE>MyShutDownBeep</CODE> procedure is executed just before the Macintosh computer shuts down or restarts. For more information about the shutdown process and the Shutdown Manager, see the chapter "Shutdown Manager" in <I><A HREF="../Processes/Processes-2.html">Inside Macintosh: Processes</A></I>.<P>
 The code for <CODE>MySampleINIT</CODE> places the <CODE>MyShutDownBeep</CODE> procedure in the system heap, making this procedure available after system startup. The <CODE>MyShutDownBeep</CODE> procedure calls <CODE>SysBeep</CODE> just before the Macintosh computer shuts down or restarts.<P>
<B>Listing 9-1  <A NAME=MARKER-9-50></A>The <EM>MySampleINIT</EM> system extension<A NAME=MARKER-2-51></A></B><P>
<PRE>
UNIT MySampleINIT    {write a Pascal system extension as a UNIT}

INTERFACE
USES
   Types, Events, Errors, Resources, Memory, Shutdown;
CONST
   kIconIDSuccess = 128;   {icon of this system extension}
   kIconIDFailure = 129;   {icon of this system extension }
                           { with an "X" on it}
   kMyShutDownResourceType = 'SHUT'
   kMyShutDownResourceID = 128;
   moveX = -1;

IMPLEMENTATION
PROCEDURE MyShowINIT(theIcon, moveX: Integer); EXTERNAL;
PROCEDURE MyShutDownBeep; FORWARD;

PROCEDURE MyINIT;
VAR
   theIcon:             Char;
   myShutDownCodeHndl:  Handle;
   myShutDownCodePtr:   ProcPtr;
BEGIN
   theIcon := kIconIDSuccess;
   {retrieve a handle to MyShutDownBeep procedure}
   myShutDownCodeHndl := GetResource(kMyShutDownResourceType,
                                    kMyShutDownResourceID);
   IF ((myShutDownCodeHndl = NIL) OR
      (ResError &lt;&gt; noErr) ) THEN
         theIcon := kIconIDFailed;
   


IF (theIcon = kIconIDSuccess) THEN
      BEGIN
         {the MyShutDownBeep code resource is present, detach it}
         { from the resource file and check for an error}
         DetachResource(myShutDownCodeHndl);
         IF (ResError &lt;&gt; noErr) THEN
            theIcon = kIconIDFailed;
         ELSE
            ReleaseResource(myShutDownCodeHndl);
      END;
      IF (theIcon = kIconIDSuccess) THEN
         BEGIN
            MoveHHi(myShutDownCodeHndl);
            HLock(myShutDownCodeHndl);
         END;
      MyShowINIT(theIcon, moveX);{place the icon at boot time}
      {install MyShutDownBeep procedure into shutdown queue}
      myShutDownCodePtr := myShutDownCodeHndl^);
      ShutDwnInstall(myShutDownCodePtr, sdOnUnmount);
END;

PROCEDURE MyShutDownBeep;
BEGIN
   SysBeep(40);
END;

END. {of UNIT}
</PRE>
 <A NAME=MARKER-2-52></A>Notice that the code for the <CODE>MySampleINIT</CODE> extension is defined as a Pascal <CODE>UNIT</CODE> rather than a <CODE>PROGRAM</CODE>. This distinction is important because Pascal programs are applications that require an application heap, an initialized A5 register, the Segment Loader, and the services of other Operating System and Toolbox managers. By comparison, a Pascal unit is merely a collection of routines. It does not enjoy the full status of an application. You cannot launch a system extension. It is simply loaded and executed in a temporary heap that the system deallocates soon after the system finishes booting the computer.<P>
 When <CODE>MySampleINIT</CODE> calls the application-defined procedure <CODE>MyShowInit</CODE>, <CODE>MyShowInit</CODE> displays an icon on the bottom left of the startup screen, and it does not erase the screen. If you want an icon displayed at system startup time, you must supply this application-defined procedure.<P>
<DL>
<DT><B>IMPORTANT</B>
<DD>If you provide a procedure that displays an icon of your system extension, do no erase the screen.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 For information about compiling system extensions, see the section <A HREF=#MARKER-9-66>"Building a System Extension" beginning on page 9-17</A>.<P>
<DL>
<DT><B>Note</B>
<DD>System extensions are not well equipped to declare global variables and deal with the A5 world. Stand-alone code modules that do these things are not system extensions and thus are beyond the scope of this discussion. See the chapter "Writing Stand-Alone Code" in <I>Building and Managing Programs in MPW</I> for information on this topic.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 Because a system extension possesses no A5 world of its own, it cannot easily define global variables: the system allocates no space for them, and the A5 register contains no meaningful value. Extension code that defines global variables usually compiles and links successfully without a warning from the linker; however, the extension's global variables typically overwrite globals defined by the current application.<P>
<DL>
<DT><B>WARNING</B>
<DD>Code containing references to global variables defined in the MPW libraries, such as QuickDraw globals, generate fatal link errors.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 As a general rule, a system extension can call Operating System managers at any time, but it can call only a few of the Toolbox managers before the startup process completes. It can call the routines from the File Manager, Memory Manager, Resource Manager, and the Notification Manager before the system extension is completely launched, but it must refrain from calling the <CODE>InitFonts</CODE>, <CODE>InitWindows</CODE>, <CODE>InitDialogs</CODE>, <CODE>InitMenus</CODE> and <CODE>TEInit</CODE> procedures, as well as other QuickDraw, Window Manager, Dialog Manager, and Font Manager routines. (Note that the code installed by a system extension can utilize the full set of Operating System and Toolbox routines.)<P>
 A system extension must do without the services of the Segment Loader, which divides application code into segments that the processor can handle. The size of a system extension's code resource should not exceed 32 KB.<P>
 You should consider installing your system extension in the system heap if you want its resources to be available after the computer finishes booting. For example, some system extensions leave routines in the system heap that can be called through patches to those routines. The <CODE>MySampleINIT</CODE> system extension shown in Listing 1-1 on <A HREF=#MARKER-9-50>page 9-11</A> loads the <CODE>MyShutDownBeep</CODE> procedure in the system heap.<P>
 The procedure your system extension uses to install code in the system heap varies according to what you want to accomplish. Basically, you have to request a block of memory in the system heap and store the code or resources you want to preserve in the block. To allocate memory in the system heap in System 7 and later, you merely need to call the appropriate Memory Manager routines, and the system heap expands dynamically to meet your requests. In earlier versions of system software, you must use a system heap space resource of type '<CODE>sysz</CODE>' to indicate how much the Operating System should increase the size of the system zone. <P>
 See the chapter "Memory Manager" in <I><A HREF="../Memory/Memory-2.html">Inside Macintosh: Memory</A></I> for details on how to allocate memory in the system heap.<A NAME=MARKER-2-53></A><P>
<A NAME=HEADING192-25></A>
<H2><A NAME=MARKER-9-54></A>Defining the User Interface for a System Extension</H2>
 The user interface for a system extension consists of <P>
<UL>
<LI>the system extension icon
<LI>other elements your system extension needs to communicate with the user<P>
</UL>
 You should provide an icon for the file that contains your system extension. An extension icon looks like a puzzle piece. <A HREF=#MARKER-9-56>Figure 9-1</A> illustrates the default icon for a system extension that appears in the Finder if you don't supply a custom icon for your system extension. You can customize an extension icon by adding a graphic to the default icon. You can display the system extension icon in a horizontal or vertical orientation with the protruding part facing any direction. If you do add graphics, keep them simple so that the icon still looks good when scaled to the small, 16-by-16 pixel icon size.<A NAME=MARKER-2-55></A><P>
<B>Figure 9-1  <A NAME=MARKER-9-56></A>The default system extension icon</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/Start-S-01.jpg"><P>
 The code in your system extension should also display the icon for your system extension when it is first executed at system startup time. You typically display this icon near the bottom-left corner of the startup screen. If the code installed by your extension requires resources or hardware that is not available at system startup, your extension can instead display a crossed-out version of the system extensions icon in the bottom-left corner of the screen.<P>
 You should design a system extension so that a user can install it by dragging the icon on top of the System Folder. The Finder then asks the user whether to place the system extension in the Extensions folder. Do not install system extensions in the System file.<A NAME=MARKER-2-57></A><P>
 When designing a system extension, avoid displaying dialog or alert boxes that interrupt system booting. Whenever possible, use the Notification Manager to notify users of important messages. See the chapter "Notification Manager" in <I><A HREF="../Processes/Processes-2.html">Inside Macintosh: Processes</A></I> for a description on how to send a notification request. You should also avoid calling routines like <CODE>InitWindows</CODE> that wipe the entire screen clean, obliterating any startup icons that other system extensions and drivers might have displayed.<A NAME=MARKER-2-58></A><P>
 Your system extension may only create files in the Preferences folder during execution. It is important that your system extension does not create files in the Extensions folder, the Control Panels folder, or the System Folder during execution. The system reads the files in each of these folders sequentially. Creating an additional file in one of these folders shifts the location of the other files, causing the system to either skip a system extension or execute one twice.<P>
 If your system extension requires a user interface, you can also create a control panel. If you use a system extension with your control panel, include it in the control panel file along with the required resources and any other optional resources you use. In System 7, system extensions can be installed in the Control Panels folder or in the Extensions folder (both of which are stored in the System Folder) or directly in the System Folder. However, if it contains a system extension, your control panel file must reside in the Controls Panels folder within the System Folder. At startup time, the system software opens files of type '<CODE>cdev</CODE>' that reside in the Control Panels folder and executes any system extensions that it finds there. If the system extension portion of a control panel is not loaded at startup, the control panel won't function properly. For additional information about control panels, see the chapter Control Panels in <I><A HREF="../MoreToolbox/MoreToolbox-2.html">Inside Macintosh: More Macintosh Toolbox</A></I>.<P>
<A NAME=HEADING192-37></A>
<H2><A NAME=MARKER-9-59></A>Creating a System Extension's Resources</H2>
 A file comprising a system extension contains a resource of type '<CODE>INIT</CODE>' and additional resources. A resource of type '<CODE>INIT</CODE>' contains the code that loads the system-level service into the system at system startup time, and it often contains the code that provides the system-level service. You can use additional resources to describe the icons for the system extension, specify a version number and copyright information for the information window displayed by the Get Info command, increase the size of the system heap, and more.<P>
 This list describes some of the additional resources you typically use when you create a system extension: <P>
<UL>
<LI>The version ('<CODE>vers</CODE>') resource, which you can use to record version information for your system extension. The version resource allows you to store a version number, a version message, and a region code.
<LI>The bundle ('<CODE>BNDL</CODE>') resource, which groups together your system extension's icons.
<LI>Icon family resources ('<CODE>ICN</CODE>#', '<CODE>ics#</CODE>', <CODE>ic18</CODE>', '<CODE>ic14</CODE>', <CODE>ics8</CODE>', and '<CODE>ics4</CODE>') to represent your system extension in the Finder.
<LI>The system heap space ('<CODE>sysz</CODE>') resource.<P>
</UL>
 The '<CODE>sysz</CODE>' resource is described in this section. See the chapter "Finder Interface" in <I><A HREF="../Toolbox/Toolbox-2.html">Inside Macintosh: Macintosh Toolbox Essentials</A></I> for additional information about the other resources mentioned in this section.<P>
 <A HREF=#MARKER-9-60>Figure 9-2</A> shows a ResEdit window containing additional resources for a system extension. These additional resources can be compiled with an <CODE>'INIT'</CODE> resource into a system extension that goes in the Extensions folder.<P>
<B>Figure 9-2  <A NAME=MARKER-9-60></A>Typical resources for a system extension</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/Start-S-02.jpg"><P>
 Not all of the resources in <A HREF=#MARKER-9-60>Figure 9-2</A> are required for all system extensions, but they do add useful features to a system extension. <P>
<DL>
<DT><B>Note</B>
<DD>You can use a high-level tool such as the ResEdit application, which is available through APDA, to create your resources. See <I>ResEdit Reference</I> for details on using ResEdit.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
<A NAME=HEADING192-50></A>
<H3>Creating Icons for a System Extension</H3>
 You should provide two sets of icons for your system extension: <P>
<UL>
<LI>an icon family for the file that contains your system extension
<LI>an icon that your system extension displays at system startup time. This icon indicate whether the installation succeeded or failed <P>
</UL>
 You should provide icon family resources for the file that contains your system extension. <A NAME=MARKER-2-61></A>See the chapter "Finder Interface" in <I><A HREF="../Toolbox/Toolbox-2.html">Inside Macintosh: Macintosh Toolbox Essentials</A></I> for a detailed description of the icon family resources.<P>
 You can create a color icon resource of type '<CODE>cicn</CODE>' for your system extension if you want to display a color startup icon at the bottom left of the screen. You can implement this feature by creating your own application-defined <CODE>MyShowINIT</CODE> procedure, or you can use a similar program called <CODE>ShowInit</CODE>. You can obtain the <CODE>ShowInit</CODE> program from various on-line services. (You can also contact APDA for further developer product information). To use <CODE>ShowINIT</CODE>, you pass the resource ID of your system extension's '<CODE>cicn</CODE>' resource to the <CODE>ShowINIT</CODE> procedure, and <CODE>ShowINIT</CODE> displays the '<CODE>cicn</CODE>' icon on the bottom-left corner of the screen. <P>
<A NAME=HEADING192-56></A>
<H3><A NAME=MARKER-2-62></A><A NAME=MARKER-2-32></A><A NAME=MARKER-9-64></A><A NAME=MARKER-2-65></A>Creating a System Heap Zone Resource for a System Extension</H3>
 You should read the information in this section only if you plan to install code from your system extension into the system heap and run your system extension on system software prior to System 7.<P>
 If you install code in the system heap and run your system extension on system software prior to System 7, you should include a system heap space resource of type '<CODE>sysz</CODE>'. The '<CODE>sysz</CODE>' resource tells the system software the amount of memory the system heap needs to expand by, in order to accommodate space for code installed by your system extension.<P>
<DL>
<DT><B>Note</B>
<DD>It is not necessary to include a '<CODE>sysz</CODE>' resource for system extensions running only on System 7 and later. The system heap in System 7 grows dynamically and expands as long as there is any unused RAM available.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 Using a '<CODE>sysz</CODE>' resource, you can request the system software to increase the memory in the system heap by the amount specified in the '<CODE>sysz</CODE>' resource. If the system software is able to allocate the needed memory in the system heap, your system extension will execute. If the system is unable to allocate the extra memory to the system heap, your system extension will not be able to execute.<P>
 To create a '<CODE>sysz</CODE>' resource, you can use an editor like the ResEdit application. Specify, in bytes, the amount of memory you want the system heap to increase by. For example, if your system extension takes 8 KB to execute, you should increase the system heap by that amount.<P>
 You do not need to allocate memory for the actual system extension code ('<CODE>INIT</CODE>' resource), only for the amount of memory for any code installed by your system extension needs to execute.<P>
<A NAME=HEADING192-63></A>
<H2><A NAME=MARKER-9-66></A>Building a System Extension</H2>
 Once you have created a file containing the '<CODE>INIT</CODE>' resource and a file containing all the additional resources, you can build your system extension. To build a system extension, compile and link the <CODE>'INIT'</CODE> resource and the additional resources into an executable file for your system extension. <P>
 When you compile the '<CODE>INIT</CODE>' resource and your additional resources, you should keep the following points in mind:<P>
<UL>
<LI>Make sure that the file type of the system extension is of type '<CODE>INIT</CODE>'.
<LI>Specify a creator if you want the Finder to use icons for your system extension.
<LI>Specify the resource type '<CODE>INIT</CODE>' and a resource ID (usually 128). 
<LI>Specify the main entry point for your system extension. When written in Pascal, the main entry point of a module is the first written instruction.
<LI>Specify that the '<CODE>INIT</CODE>' resource be loaded into the system heap if you want its resources to be available after the computer finishes booting.
<LI>Specify the '<CODE>INIT</CODE>' resource (code resource) as locked to prevent the system from moving the resource during execution.
<LI>Make sure that all additional resources are unlocked and purgeable.<P>
</UL>

</BLOCKQUOTE>
<HR>
<center>
<A HREF="OSUtilities-191.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="OSUtilities-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="OSUtilities-222.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="OSUtilities-193.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="OSUtilities-3.html">&copy; Apple Computer, Inc.</A><br>6 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
