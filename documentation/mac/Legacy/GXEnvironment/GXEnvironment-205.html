<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Installing an Exception Procedure(IM: XU)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING205></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="GXEnvironment-204.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="GXEnvironment-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="GXEnvironment-445.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="GXEnvironment-206.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="GXEnvironment-2.html"><B>QuickDraw GX Environment and Utilities</B></A> / <BR><DD><A HREF="GXEnvironment-182.html"><B>Chapter 5 - Collection Manager</B></A> / <A HREF="GXEnvironment-188.html"><B>Using the Collection Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING205-0></A>
<H2><A NAME=MARKER-9-104></A>Installing an Exception Procedure</H2>
 <A NAME=MARKER-2-105></A>The Collection Manager allows you to specify an exception procedure for each collection object. When you attempt to manipulate a collection object using a Collection Manager function and the function results in an error, the Collection Manager calls the exception procedure for the collection object and sends it two parameters: a reference to the collection object that caused the error and the error code that was generated.<P>
 In an exception procedure, you can handle the error and then change the error code to <CODE>noErr</CODE>, a process which indicates that the Collection Manager can return control to the place in your application that generated the error as if no error had occurred. You can also change the error from one error code to another. A third alternative is to use the ANSI C functions <CODE>setjmp</CODE> and <CODE>longjmp</CODE> to jump out of the exception handler and into code to handle the error. <A HREF=#MARKER-9-106>Listing 5-27</A> shows a sample exception procedure.<P>
<B>Listing 5-27  <A NAME=MARKER-9-106></A>A sample exception procedure</B><P>
<PRE>
jmp_buf cpuState; /* global machine state */
pascal OSErr MyExceptionHandler(Collection errorCollection,
                                OSErr status)
{
   /* ignore collectionItemLockedErr errors */
   if (status == collectionItemLockedErr)
      return noErr;

   /* all other errors must be handled by caller's setjmp block */
   /* jump back to callers setjmp block and return status */
   longjmp(cpuState, status);
}
void ExceptionTest(Collection anyCollection)
{
   OSErr result;

   SetCollectionExceptionProc(anyCollection, MyExceptionHandler);

   if (!(result = setjmp(cpuState))) {
      AddCollectionItem(anyCollection, 'tag1', 1, 4, &quot;data&quot;);
      AddCollectionItem(anyCollection, 'tag1', 2, 9, &quot;more data&quot;);
      AddCollectionItem(anyCollection, 'tag1', 3, 9, &quot;last data&quot;);

      /* cause an error . . . */
      RemoveCollectionItem(anyCollection, 'tag1', 4);
   } else {
      .
      .
      .
      /* handle errors other than collectionItemLockedErr */
      /* use result local variable to determine which error */
      .
      .
      .
   }
}
</PRE>
 In <A HREF=#MARKER-9-106>Listing 5-27</A>, the <CODE>ExceptionTest</CODE> sample function takes a single parameter: a reference to a collection object. The sample function first calls the <CODE>SetCollectionExceptionProc</CODE> function to install an exception handler for this collection object. In this example, the call to <CODE>SetCollectionExceptionProc</CODE> installs the <CODE>MyExceptionHandler</CODE> function as the exception handler. <P>
 The next line of the <CODE>ExceptionTest</CODE> sample function calls the <CODE>setjmp</CODE> function. This function stores the current machine state, including the current position in the sample code, into the <CODE>cpuState</CODE> global variable. It also returns a value of 0 as its function result, and this value is assigned to the local variable <CODE>result</CODE>. This value is negated (by the <CODE>!</CODE> operator), an operation that produces a Boolean value of <CODE>true</CODE>. Therefore, the block of code in the <CODE>if</CODE> clause begins to execute.<P>
 Imagine that the first call to the <CODE>AddCollectionItem</CODE> function completes successfully, but that the second call to <CODE>AddCollectionItem</CODE> generates a <CODE>collectionItemLockedErr</CODE> error. During the second call to <CODE>AddCollectionItem</CODE>, the Collection Manager responds to the error by calling the <CODE>MyExceptionHandler</CODE> function. The first parameter passed to this function indicates the collection that generated the error, and the second parameter passed to this function indicates the error that was generated. This sample exception handler determines whether the error is the <CODE>collectionItemLockedErr</CODE> error (which it is in this example) and then returns with the <CODE>noErr</CODE> error as the function result. The Collection Manager notices this change in error and returns control to the sample function as if no error had occurred. (Just as you can use this mechanism to ignore certain errors, you can also use this mechanism to change errors of one type into errors of another type.) Since effectively no error has now occurred, the <CODE>ExceptionTest</CODE> sample function continues by executing the third call to the <CODE>AddCollectionItem</CODE> function.<P>
 The subsequent line of the <CODE>ExceptionTest</CODE> sample function attempts to remove an item that is not in the collection, resulting in a <CODE>collectionItemNotFoundErr</CODE> error. Again, the Collection Manager responds by calling the exception handler. In this case, however, the error is not the <CODE>collectionItemLockedErr</CODE> error, so the exception handler executes this line of code:<P>
  longjmp(cpuState, status);<P>
 When you call the <CODE>longjmp</CODE> function,<P>
<UL>
<LI>control is passed to the location of the corresponding call to the <CODE>setjmp</CODE> function
<LI>the value passed as the second parameter to the <CODE>longjmp</CODE> function becomes the function result of the <CODE>setjmp</CODE> function<P>
</UL>
 Therefore, this call to the <CODE>longjmp</CODE> function passes control back to the location in the <CODE>ExceptionTest</CODE> sample function where <CODE>setjmp(cpuState)</CODE> was called earlier. This time, however, the function result returned by the <CODE>setjmp</CODE> function is not 0, as it was before, but instead is the value of <CODE>status</CODE>, the second parameter in the call to the <CODE>longjmp</CODE> function. Therefore, the function result of the <CODE>setjmp</CODE> function is set to be the <CODE>collectionItemNotFoundErr</CODE> error.<P>
 Once again, the <CODE>ExceptionTest</CODE> sample function assigns this function result to the <CODE>result</CODE> local variable, and negates it with the <CODE>!</CODE> operator. This time the negation produces a Boolean value of <CODE>false</CODE>, and therefore the block of code in the <CODE>else</CODE> clause begins to execute. In this block of code, you can handle errors not handled in the exception handler, using the <CODE>result</CODE> local variable to determine which error occurred.<P>
 You can find more information about the <CODE>SetCollectionExceptionProc</CODE> function on <A HREF=GXEnvironment-224.html#MARKER-9-150>page 5-59</A>. You can find more information about exception procedures on <A HREF=GXEnvironment-270.html#MARKER-9-278>page 5-101</A>.<A NAME=MARKER-2-107></A><P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="GXEnvironment-204.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="GXEnvironment-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="GXEnvironment-445.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="GXEnvironment-206.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="GXEnvironment-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
