<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Special Uses for the KeyTranslate Function(IM: Tx)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING585></A>



<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Text-584.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Text-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Text-594.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Text-586.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Text-2.html"><B>Text</B></A> / <BR><DD><A HREF="Text-570.html"><B>Appendix C - Keyboard Resources</B></A> / <A HREF="Text-582.html"><B>Keyboard-Layout Resource (Type 'KCHR')</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING585-0></A>
<H2><A NAME=MARKER-9-78></A>Special Uses for the KeyTranslate Function</H2>
 <A NAME=MARKER-2-79></A>In normal key translation, the Event Manager <CODE>KeyTranslate</CODE> function performs the conversion from virtual key code to character code and passes the result to your application in the <CODE>message</CODE> field of the event record for a key-down event. The script management system provides <CODE>KeyTranslate</CODE> with a pointer to the proper keyboard-layout resource to use, based on the current script.<P>
 There may be situations, however, in which you may want to explicitly call <CODE>KeyTranslate</CODE>, either to install your own keyboard layout or to perform special processing.<P>
<A NAME=HEADING585-3></A>
<H3>Installing a Custom Keyboard-Layout Resource</H3>
 <A NAME=MARKER-2-80></A>The script management system loads and uses only those keyboard-layout resources that are installed in the System file. It cannot load a keyboard-layout resource that is, for example, in the resource fork of your application. However, if your application needs to modify the keyboard layout temporarily without forcing users to install a new keyboard layout, you can load a keyboard-layout resource from your own application resource fork and call <CODE>KeyTranslate</CODE> directly after each key-down event, passing it a pointer to that keyboard-layout resource and using the same virtual key code and modifiers that you received in the event message.<P>
 To more permanently replace a script system's keyboard layout, you can have the user install a keyboard-layout resource and a keyboard-icon family in the System file. Both resources must have identical ID numbers, in the range for the script system for which they will be used. You call the Script Manager <CODE>SetScriptVariable</CODE> procedure twice, to make those IDs the defaults for the given script system. You then call the Script Manager <CODE>KeyScript</CODE> procedure to load the resources and make them available to the system. <A HREF=#MARKER-9-81>Listing C-1</A> demonstrates the calls for a Dvorak keyboard layout in the Roman script system.<P>
<B>Listing C-1  <A NAME=MARKER-9-81></A>Loading a non-system keyboard-layout resource</B><P>
<PRE>
CONST
   DvorakID =  500;

VAR
   err:  OSErr;

BEGIN
   err   := SetScriptVariable(smRoman, smScriptKeys, DvorakID);
   err   := SetScriptVariable(smRoman, smScriptIcon, DvorakID);
   KeyScript(smRoman);
END;
</PRE>
 In this example you do not need to call <CODE>KeyTranslate</CODE> to get character codes for the new keyboard layout, and the new keyboard layout will be in effect until the system is restarted or until your application restores the original keyboard layout.<P>
 The most permanent way to replace the keyboard layout is to make the system use your keyboard layout as its default. To do that you must modify the itlbKeys field of the target script system's international bundle (<CODE>'itlb'</CODE>) resource. The international bundle resource is described in the appendix "International Resources" in this book.<P>
<DL>
<DT><B>IMPORTANT</B>
<DD>Apple Computer's system software licensing policy forbids shipping a modified System file. If you want to modify the System file, it is best to have the user either run the Installer to install your resources, or drag a file consisting of those resources onto the System Folder. Contact Macintosh Developer Technical Support for information on the Installer.<B><EM></EM></B>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 You can inspect and edit any keyboard-layout resource by using a resource editor such as ResEdit.<P>
<A NAME=HEADING585-12></A>
<H3>Using KeyTranslate for Command-Key Equivalents</H3>
 <A NAME=MARKER-2-82></A>In some cases you may need to call <CODE>KeyTranslate</CODE> to regenerate a different character code using the same keyboard-layout resource. For example, the U.S. <CODE>'KCHR'</CODE> and some other Roman keyboard layouts ignore the Shift modifier key if the Command modifier key is also pressed. That means you cannot directly use uppercase characters or shifted symbols as Command equivalents. Furthermore, for those keyboard layouts where the period is a shifted key, it means that the standard Macintosh command to cancel an operation (Command-period) cannot be generated. As another example, some applications that accept Command-? as a request for Help simply assume that "?" is a shifted version of "/", and thus bring up a Help window whenever the Command key and "/" are pressed simultaneously. This gives incorrect behavior on keyboards in which "?" is not generated by Shift-/.<P>
 To overcome this and similar difficulties, you can use the virtual key code you receive in the key-down event record, and call <CODE>KeyTranslate</CODE> to run it back through the same keyboard-layout resource, but without the modifier(s) that applied when the character code was first generated. If the resulting character code is one that is significant for a command equivalent, you can use it plus the modifier state that originally applied to decide what action to take.<P>
 <A HREF=#MARKER-9-83>Listing C-2</A> is a routine that removes the Command-key bit from the modifiers field of an event record and runs the same virtual key code through <CODE>KeyTranslate</CODE>, using the same keyboard-layout resource, to see if a different character code results.<P>
<B>Listing C-2  <A NAME=MARKER-9-83></A>Regenerating a character code with <CODE>KeyTranslate</CODE></B><P>
<PRE>
FUNCTION TryAgain(myEvent: EventRecord): LongInt;

CONST
   newModifierMask = $FE00;            {turn off cmdKey bit}

VAR
   Modifiers:     Integer;
   VirtualCode:   Integer;
   KeyCode:       Integer;
   someState:     LongInt;
   KCHRPtr:       Ptr;

BEGIN
                                    {don't keep cmdKey bit}
   Modifiers := BAnd(myEvent.modifiers, newModifierMask);
                                    {keep virtual key code, put in low byte}
   VirtualCode := BSR(BAnd(myEvent.message, keyCodeMask), 8);
                                    {assemble new key code for KeyTranslate}
   KeyCode := BOr(Modifiers, VirtualCode);
                                    {get pointer to current 'KCHR'}
   KCHRPtr := Ptr(GetScriptManagerMVariable(smKCHRCache));
   someState := 0;                  {initialize KeyTranslate dead-key state}
                                    {see what ascii code is returned}
   TryAgain := KeyTranslate(KCHRPtr, KeyCode, someState);
                                    {look for returned values in both }
                                    { high and low word of result}
END;     
</PRE>
 In designing Command equivalents for your application, keep in mind that there may be less chance of inconsistency and confusion if you present Command equivalents to the user--and interpret them yourself--as grouped modifiers applied to the basic (unshifted) character you want to use for the command. (Note, however, that to do so you would have to write your own custom menu-definition resource.) For example, you might show "Command-Option-P" in the menu rather than "Command-\xBA"; when interpreting it, you could use <CODE>KeyTranslate</CODE> and the virtual key code in the event record to make sure that the key for "p" was pressed, rather than just assuming that "\xBA" is produced by Option-P.<P>
 Another possibility is to define few Commmand-key equivalents yourself, and to let the user create as many equivalents as desired.<P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Text-584.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Text-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Text-594.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Text-586.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Text-3.html">&copy; Apple Computer, Inc.</A><br>6 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
