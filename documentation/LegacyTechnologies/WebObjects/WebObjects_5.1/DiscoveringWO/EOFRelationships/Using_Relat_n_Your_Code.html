<HTML>		<HEAD>		<meta http-equiv="content-type" content="text/html;charset=iso-8859-1">		<meta name="Copyright" content="Copyright 2001 Apple Computer, Inc. All Rights Reserved.">        <title>Using Relationships in YourCode</title>		</HEAD>	<BODY bgcolor="#ffffff"><!-- start of header --><!--#include virtual="/includes/framesetheader" --><!-- end of header --><!-- start of path --><table cellspacing=0 border=0 width=600 valign="left"><tr><td scope="row"><font face="Geneva,Helvetica,Arial" size="1"><b>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="../../../index.html">Documentation</a> <b>&gt;</b> <a href="../../webobjects.html" target="_top">WebObjects</a></font></td></tr></table><br><!-- end of path --><a href="Completing__thors_Model.html" target="_right"><img src="../Images/previous.gif" border="0" alt="Previous"></a><a href="Running_the_Application.html" target="_right"><img src="../Images/next.gif" border="0" alt="Next"></a>&nbsp;<br><!-- apple_doc: pageHeadingStart --><a name = "TPXREF113"></a><h2><font face="Lucida Grande,Helvetica,Arial">Using Relationships in YourCode</font></h2><!-- apple_doc: pageHeadingEnd --><p>In this section you'll add to your application the abilityto maintain an author's books.</p><p>Before you can begin, you need to add the Java classes forAuthor and Book to your project. Because you've customized <code>Author.java</code>,you'll need to merge the new code generated by EOModeler withyour own.</p><br><a name = "TPXREF114"></a><h3><font face="Lucida Grande,Helvetica,Arial">Add Java Classes for Authorand Book to the Project</font></h3><ol><li>Open theAuthors project in Project Builder.</font></li><li>Open <code>Authors.eomodeld</code> inEOModeler.</font></li><li>Update your project's <code>Author.java</code> class.<ol><li>Select the Authorentity in the entity list.</font></li><li>Choose Property &gt; Generate Java Files. <img src = "../Art/eorelmerge.gif" alt = "[image: ../Art/eorelmerge.gif]"><p>You are notified that <code>Author.java</code> alreadyexists and asked how you wish to proceed.</p><p>Click Merge.The FileMerge application launches.</p></font></li><li>Merge the files.<p>As  <a href="#BBCEGHAB">Figure 12-2</a> shows, FileMerge outlinesand separates the differences between the two files. The file generatedby EOModeler is on the left, and the the one that you customizedis on the right.</p><br><a name = "BBCEGHAB"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Figure12-2  FileMerge window</font></b></p> <img src = "../Art/filemerge.gif" alt = "[image: ../Art/filemerge.gif]"><p>FileMerge highlightsthe differences between the files. Each highlighted area has a numberedarrow.</p><p>In this case you need to integrate the differencesinto the new file. The most important difference to include in thenew <code>Author.java</code> fileis the <code>fullName</code> method.</p><p>Clickthe arrow in the area that contains the <code>fullName</code> methodand choose "Choose both (left first)" from the Actions pop-upmenu, as shown in  <a href="#BBCGGJAA">Figure 12-3</a>.</p><br><a name = "BBCGGJAA"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Figure12-3  FileMerge window&#151;adding fullNamemethod to new Author.java</font></b></p> <img src = "../Art/filemerge2.gif" alt = "[image: ../Art/filemerge2.gif]"><p>Repeatthe process with the rest of the highlighted areas (you can ignoresections containing comments).</p><p>Choose File &gt; SaveMerge to save the new <code>Author.java</code> file.</p></font></li></ol></font></li><li>Add <code>Book.java</code> tothe project.<ol><li>Select the Book entity in the entity list in EOModeler'smain window.</font></li><li>Choose Property &gt; Generate Java Files.</font></li><li>Save <code>Book.java</code> inyour project's directory.</font></li><li>Add <code>Book.java</code> tothe project.<p>(For details on adding a custom Java class toa project, see  <a sector="mod" href="../EOCustomObjects/iGenerating_a_Custom_Class.html" target="_top">"Adding a Java Class to the Project"</a>.)</p></font></li></ol></font></li></ol><br><a name = "TPXREF115"></a><h4><font face="Lucida Grande,Helvetica,Arial">To-One Relationships in Java</font></h4><p>The <code>author</code> method in  <a href="#BBCHIHAE">Listing 12-1</a> implementsthe author relationship, a to-one relationship from Book to Author.</p><a name = "BBCHIHAE"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Listing12-1 The methods that implement the authorrelationship in Book.java</font></b></p><pre>    public Author author() {        return (Author)storedValueForKey("author");    }    public void setAuthor(Author value) {        takeStoredValueForKey(value, "author");    }}</pre><p>Enterprise Objects follows the procedure described in  <a sector="mod" href="../DatabaseBasics/iRelationship.html" target="_top">"To-One Relationships"</a> whenyou access the <code>author</code> propertyof Book objects. </p><br><a name = "TPXREF116"></a><h4><font face="Lucida Grande,Helvetica,Arial">To-Many Relationships in Java</font></h4><p>The code in  <a href="#TPXREF131">Listing 12-2</a> implements the to-many relationship between Authorand Book, <code>books</code>.</p><a name = "TPXREF131"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Listing12-2 The methods that implement the booksrelationship in Author.java</font></b></p><pre>    public NSArray books() {        return (NSArray)storedValueForKey("books");    }    public void setBooks(NSMutableArray value) {        takeStoredValueForKey(value, "books");    }    public void addToBooks(Book object) {        NSMutableArray array = (NSMutableArray)books();        willChange();        array.addObject(object);    }    public void removeFromBooks(Book object) {        NSMutableArray array = (NSMutableArray)books();        willChange();        array.removeObject(object);    }}</pre><p>Notice that the books associated with a particular authorcan be retrieved as an NSArray simply by calling the <code>books</code> method.The NSArray returned is an array of Book objects. Changes made tothem are automatically tracked by the editing context and are saved when <code>saveChanges</code> iscalled. Further, a book can be added to or removed from an author's listusing the two provided methods, <code>addToBooks</code> and <code>removeFromBooks</code>.In that case, however, the editing context has to be notified ofthe change.</p><p>At the database level, the AUTHOR_ID column in the BOOK tablecorresponds to the AUTHOR_ID of the owning AUTHOR row. Adding abook to an author's array is actually a matter of setting AUTHOR_IDon the new BOOK row to the same value as the author's AUTHOR_ID.When you use the <code>addToBooks</code> method,Enterprise Objects takes care of updating the value of the <code>authorId</code> propertyof the Book object for you.</p><br><a name = "TPXREF117"></a><h3><font face="Lucida Grande,Helvetica,Arial">Create the AuthorBookEdit Component</font></h3><p>In this section you'll create the component that allowsyour application's user to maintain the books of a specific author.</p><br><a name = "TPXREF118"></a><h4><font face="Lucida Grande,Helvetica,Arial">AuthorBookEdit.wo</font></h4><p>After performing the steps below, your <code>AuthorBookEdit.wo</code> componentshould look like  <a href="#BBCFIHFH">Figure 12-4</a>.</p><ol><li>Add the AuthorBookEditcomponent to the project.<p>This component allows editing thelist of books an author has written.</p><ol><li>Select Web Componentsfrom the Groups & Files list.</font></li><li>Choose File &gt; New File.</font></li><li>Under WebObjects, select Component and click Next.</font></li><li>Name the component AuthorBookEdit and click Finish.</font></li></ol></font></li><li>Design <code>AuthorBookEdit.wo</code>.<ol><li>Open <code>AuthorBookEdit.wo</code> inWebObjects Builder.</font></li><li>Add the <code>author</code> keyto the component, choose Author as its type, and include accessormethods.</font></li><li>Add the <code>bookItem</code> keyto the component, choose Book as its type, and do not include accessormethods.</font></li><li>Add an action called <code>deleteBook</code> thatreturns <code>null</code>.</font></li><li>Add an action called <code>addBook</code> thatreturns <code>null</code>.</font></li><li>Add an action called <code>returnToMain</code> thatreturns an object of type Main.</font></li><li>Enter the label "<code>Books by </code>",add a WOString after it, and press Shift-Enter.</font></li><li>Select the line containing the label and the WOString, andchoose Elements &gt; Heading &gt; H3.</font></li><li>Bind the WOString to <code>author.fullName</code>.</font></li><li>Add a WORepetition element.<p>Bind the <code>list</code> attributeto <code>author.books</code>.</p><p>Bindthe <code>item</code> attribute to <code>bookItem</code>.</p></font></li><li>Add the WORepetition's content.<p>Add a WOHyperlink,a space character, and a WOTextField inside the WORepetition andpress Shift-Enter.</p><p>Enter <code>Delete</code> asthe WOHyperlink's caption, and bind its <code>action</code> attributeto <code>deleteBook</code>. </p><p>Bindthe WOTextField's <code>value</code> attributeto <code>bookItem.title</code>.</p></font></li><li>Add two WOSubmitButtons below the WORepetition.<p>Enter <code>"Done"</code> forthe <code>value</code> attribute ofthe first WOSubmitButton, and bind its <code>action</code> attributeto <code>returnToMain</code>.</p><p>Enter <code>"Add"</code> forthe <code>value</code> attribute ofthe second WOSubmitButton, and bind its <code>action</code> attributeto <code>addBook</code>.</p></font></li><li>Add a WOForm element that encompasses all the elements you'veadded so far.<p>Select all the elements by choosing Edit &gt;Select All.</p><p>Choose Forms &gt; WOForm.</p><p>Clickanywhere inside a WOForm where there are no elements.</p><p>ChooseWindow &gt; Inspector.</p><p>Choose <code>true</code> forthe <code>multipleSubmit</code> attributeof the WOForm.</p></font></li></ol></font></li><li>Save <code>AuthorBookEdit.wo</code>.</font></li></ol><br><a name = "BBCFIHFH"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Figure12-4 AuthorBookEdit.wo</font></b></p> <img src = "../Art/authorbookeditwo.gif" alt = "[image: ../Art/authorbookeditwo.gif]"><br><a name = "TPXREF119"></a><h4><font face="Lucida Grande,Helvetica,Arial">AuthorBookEdit.java</font></h4><p>The Java code of the AuthorBookEdit component needs to beedited to implement the procedures needed to add and delete booksfrom the <code>books</code> relationshipof Author objects. However, all you have to do is maintain an arrayof books, in the same way as you would manipulate an NSArray (addan object to the array to add a book, and remove objects from itto delete books). The only additional code you need to include isto notify the editing context of the changes made to the array.</p><ol><li>Modify the <code>deleteBook</code> methodso that it looks like  <a href="#BBCJEBJI">Listing 12-3</a>.<a name = "BBCJEBJI"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Listing12-3  The deleteBook method in AuthorBooEdit.java</font></b></p><pre>public WOComponent deleteBook() {    // get editing context from book object    EOEditingContext ec = bookItem.editingContext();        // delete book from its editing context    ec.deleteObject(bookItem);        // remove object from relationship    author.removeObjectFromBothSidesOfRelationshipWithKey(bookItem, "books");    return null;}</pre><p>Theaction method first removes the book from the <code>books</code> arrayof author, and then notifies the editing context that the enterpriseobject in question should be deleted the next time changes are saved.</p><p>Whenthe page refreshes, the book in question is no longer displayedin the list because it has been removed from the <code>books</code> array(relationship) by the <code>removeObjectFromBothSidesOfRelationshipWithKey</code> method.</p></font></li><li>Modify the <code>addBook</code> methodso that it looks like  <a href="#BBCDJBDG">Listing 12-4</a>.<a name = "BBCDJBDG"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Listing12-4  The addBook method in AuthorBookEdit.java</font></b></p><pre>public WOComponent addBook() {    // get editing context    EOEditingContext ec = session().defaultEditingContext();        // create new book object    Book newBook = new Book();    newBook.setTitle("New Book");        // insert new book into editing context    ec.insertObject(newBook);        // add new book to books and set author for it    author.addObjectToBothSidesOfRelationshipWithKey(newBook, "books");    return null;}</pre><p>The <code>addObjectToBothSidesOfRelationshipWithKey</code> methodtakes care of adding the new book to the <code>books</code> arrayof <code>author</code>, as well assetting the <code>author</code> propertyfor the new book. Alternatively, you could have set each relationshipindividually, as shown in  <a href="#BBCECGBJ">Listing 12-5</a>.</p><a name = "BBCECGBJ"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Listing 12-5  Methodcalls to add a book and set its author</font></b></p><pre>author.addToBooks(newBook);newBook.setAuthor(author);</pre></font></li></ol><br><a name = "TPXREF120"></a><h3><font face="Lucida Grande,Helvetica,Arial">Modify Session.java</font></h3><p>The major change that needs to be made to the <code>Session.java</code> classis adding the <code>authorList</code> instancevariable. Each Session object also needs to fetch the list of authorsduring its creation.</p><ol><li>Cut the <code>fetchSpec</code> instancevariable definition from <code>Main.java</code> andpaste it in <code>Session.java</code>:<pre>private EOFetchSpecification fetchSpec;</pre></font></li><li>Edit the constructor so that it matches  <a href="#BBCEDDDF">Listing 12-6</a>.<a name = "BBCEDDDF"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Listing 12-6  Theconstructor in Session.java</font></b></p><pre>public Session() {    super();        // build fetch specification    fetchSpec = new EOFetchSpecification("Author", null, null);        // fetch    fetchAuthorList();}</pre></font></li><li>Add the <code>fetchAuthorList</code> methodin  <a href="#BBCJFDDE">Listing 12-7</a>.<a name = "BBCJFDDE"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Listing12-7  The fetchAuthorList method in Session.java</font></b></p><pre>public void fetchAuthorList() {    // get editing context    EOEditingContext ec = defaultEditingContext();        // fetch    authorList = new  NSMutableArray(ec.objectsWithFetchSpecification(fetchSpec));}</pre></font></li><li>Add the <code>addAuthor</code> method in  <a href="#BBCDHEBH">Listing 12-8</a>. (Youcan copy and paste the <code>addAuthor</code> methodin Main.java and make the necessary modifications.)<a name = "BBCDHEBH"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Listing12-8  The addAuthor method in Session.java</font></b></p><pre>public boolean addAuthor(Author author) {    // add only if the author is not already in the list    if (! authorList.containsObject(author)) {        // add author to list        authorList.addObject(author);        // insert author into editing context        defaultEditingContext().insertObject(author);        return true;    }    else {        return false;    }}</pre></font></li><li>Add the <code>deleteAuthor</code> method in  <a href="#BBCDCCGH">Listing 12-9</a>. (Youcan copy and paste the <code>deleteAuthor</code> methodin Main.java, and make the necessary modifications.)<a name = "BBCDCCGH"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Listing12-9  The deleteAuthor method in Session.java</font></b></p><pre>public void deleteAuthor(Author author) {    // remove author from authorList    authorList.removeObject(author);    // get object's editing context    EOEditingContext ec = author.editingContext();    // remove author from object graph    ec.deleteObject(author);    }</pre></font></li><li>Save Session.java.</font></li><li>Add the <code>authorList</code> instancevariable.<ol><li>InWebObjects Builder, select session from the AuthorBookEdit browser.</font></li><li>Control-click in the Session browser and choose Add Key toSession.</font></li><li>Name the key <code>authorList</code>,set its type to a mutable array of Author, and generate accessormethods.</font></li></ol></font></li></ol><br><a name = "TPXREF121"></a><h3><font face="Lucida Grande,Helvetica,Arial">Modify the Main Component</font></h3><p>The Main component needs to display the AuthorBookEdit component,so that the application's user can edit an author's books. Toaccomplish that, a WOHyperlink and its action need to be added to <code>Main.wo</code>.</p><br><a name = "TPXREF122"></a><h4><font face="Lucida Grande,Helvetica,Arial">Main.wo</font></h4><p>A new action, <code>editBooks</code>,needs to be added to the component. It also needs a new WOHyperlink,which invokes the new action. After completing the required changes,your <code>Main.wo</code> should looklike  <a href="#BBCEDFAB">Figure 12-5</a>.</p><ol><li>Open <code>Main.wo</code> inWebObjects Builder.</font></li><li>Add a new action named <code>editBooks</code> thatreturns AuthorBookEdit.</font></li><li>Add a WOHyperlink between the Delete WOHyperlink and the WOStringinside the WORepetition.<p>Set the caption to <code>Books</code> andbind its <code>action</code> attributeto <code>editBooks</code>.</p></font></li><li>Bind the WORepetition's <code>list</code> attributeto <code>session.authorList</code>.</font></li><li>Delete the <code>authorList</code> key.<ol><li>Select <code>authorList</code> inMain's browser.</font></li><li>Choose "Delete authorList" from the Edit Source pop-upmenu.</font></li></ol></font></li><li>Save <code>Main.wo</code>.</font></li></ol><br><a name = "BBCEDFAB"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Figure12-5 Main.wo with the editBooks actionand the Books WOHyperlink</font></b></p> <img src = "../Art/mainwowitheditbooks.gif" alt = "[image: ../Art/mainwowitheditbooks.gif]"><br><a name = "TPXREF123"></a><h4><font face="Lucida Grande,Helvetica,Arial">Main.java</font></h4><ol><li>Add a sessioninstance variable.<pre>private Session session;</pre></font></li><li>Edit the constructor so that it looks like  <a href="#BBCIGFCD">Listing 12-10</a>.<a name = "BBCIGFCD"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Listing12-10  The constructor in Main.java</font></b></p><pre> public Main(WOContext context) {        super(context);        // get session        session = (Session)session();        // get editing context        editingContext = session.defaultEditingContext();        // create a new author object (where form data is stored)        author = new Author();    }</pre></font></li><li>Edit the <code>addAuthor</code> methodso that it looks like  <a href="#BBCCHCBB">Listing 12-11</a>.<a name = "BBCCHCBB"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Listing12-11  The addAuthor method in Main.java&#151;usesthe addAuthor method in Session.java</font></b></p><pre>public WOComponent addAuthor() {    if (session.addAuthor(author) {        // create a new author        author = new Author();    }    return null;}</pre></font></li><li>Edit the <code>deleteAuthor</code> method so thatit looks like  <a href="#BBCDGACE">Listing 12-12</a>.<a name = "BBCDGACE"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Listing12-12  The deleteAuthor method in Main.java&#151;usesthe deleteAuthor method in Session.java</font></b></p><pre>public WOComponent deleteAuthor() {    session.deleteAuthor(authorItem);    return null;}</pre></font></li><li>Edit the <code>editBooks</code> methodso that it looks like  <a href="#BBCHGAJE">Listing 12-13</a>.<a name = "BBCHGAJE"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Listing12-13  The editBooks method in Main.java&#151;sendsAuthor object to AuthorBookEdit component</font></b></p><pre>public AuthorBookEdit editBooks() {    AuthorBookEdit nextPage = (AuthorBookEdit)pageWithName("AuthorBookEdit");    // Initialize your component here    nextPage.setAuthor(authorItem);    return nextPage;}</pre><p>The <code>editBooks</code> methodneeds to send the author whose books are to be edited to the AuthorBookEditcomponent (the next page to be displayed).</p></font></li><li>Edit the <code>revertChanges</code> methodso that it matches  <a href="#BBCFGHGJ">Listing 12-14</a>.<a name = "BBCFGHGJ"></a><p><b><font face="Geneva,Helvetica,Arial" size="2">Listing12-14  The revertChanges method in Main.java&#151;usesdefault editing context and the fetchAuthorList method in Session.java</font></b></p><pre>public WOComponent revertChanges() {    // revert object graph    editingContext.revert();        // refetch    session.fetchAuthorList();    return null;}</pre><p>Thismethod now uses the session's <code>fetchAuthorList</code> methodbecause the author list is stored in the session, not the Main component.</p></font></li><li>Save <code>Main.java</code>.</font></li></ol><br>    <br><a href="Completing__thors_Model.html" target="_right"><img src="../Images/previous.gif" border="0" alt="Previous"></a><a href="Running_the_Application.html" target="_right"><img src="../Images/next.gif" border="0" alt="Next"></a>&nbsp;<hr alt=""><p><font face="Palatino" size="1">&#169; 2001 Apple Computer, Inc.</font></p><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></html>