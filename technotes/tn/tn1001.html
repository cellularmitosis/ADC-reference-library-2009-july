<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><HTML><!-- Template 03-24-01 --><!--Includes revisions to code listings--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="Stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TN1001: On Power Macintosh Interrupt Management</title><meta name="keywords" content="Power Macintosh interrupt management ndrv porting 68k PCI I/O"><meta name="Description" content="Technical Note TN1001: This Technical Note briefly addressesporting existing 68K interrupt code to the NuBus PowerPC.It then discusses the new interrupt management scheme developedfor PCI PowerPC."><meta name="categories" content="Devices"><meta name="week-posted" content="Sep 25, 1995 - Oct 6, 1995"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002844" title="On Power Macintosh Interrupt Management"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/index.html" target="_blank">Reference Library > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1001</div>
<div id="pageheadsub">On Power Macintosh Interrupt Management</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left">         <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                        <span id="menutitle">                            CONTENTS                             <BR>                            <BR>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->					<p id="menutext">                   <A HREF="#Section1">About Power Macintosh                     Interrupt Management</A><BR>                  <BR>                  <A HREF="#Section2">PCI-Based Power Macintosh                     Interrupt Management</A><BR>                  <BR>                                   <A HREF="#Summary">Summary</A><BR>                  <BR>                  <A HREF="#References">References</A><BR>                  <BR>                  <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                 <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left>            <!-- begin_intro_text --><p id="introtext">The Note briefly addresses porting existing 68Kinterrupt code to the NuBus PowerPC. It thendiscusses the new interrupt management schemedeveloped for PCI PowerPC.</P><p id="introtext">This Note is written for driver writersdeveloping drivers of type 'ndrv' for PCI Macintoshcomputers and for any developer whose code makescalls to the Device Manager as a client of thesedrivers.</P><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Oct 01 1995]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>                   <!-- begin_content -->          <P><A NAME=Section1></A></P><H2>About Power Macintosh Interrupt Management</H2>                                    <P>Both the 68K and PowerPC microprocessors can be                  run in two modes: user and supervisor. The Mac OS                  runs in supervisor mode on both 68K and PowerPC                  Macintoshes. On 68K Macintoshes, the Mac OS allows                  any code to access supervisor mode. All code,                  therefore, has access to the status register, which                  can be used to program interrupts. With the                  introduction of the PowerPC, the Mac OS enforced                  the lock between the PowerPC user and supervisor                  modes. As a result, the PowerPC status register is                  no longer available for working with interrupts. To                  compound the interrupt problem, the 68K                  microprocessor has seven levels of available                  interrupts while the RISC- based PowerPC only has                  one interrupt level, requiring a different                  interrupt model.</P>                                    <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR><BR>Not all interrupt levels are used by the 68KMac OS.</P></TD></TR></TABLE></CENTER><BR><BR>                  <H3>Porting 68K Interrupt Code to PowerPC</H3>                                    <P>All code dealing with 68K interrupts (seven                  levels) is emulated on the PowerPC, since there is                  no transformation from seven levels to one. The                  mechanism for dealing with 68K code on PowerPC is                  the 68LC040 emulator. Therefore, developers may                  choose not to port at all and can be assured that                  their 68K interrupt code will run on the                  PowerPC.</P>                                    <P>For those few who choose to port parts of 68K                  'DRVR'driver to a native PowerPC code, 68K                  non-interrupt code can be ported, but the interrupt                  handling code must remain emulated because a native                  interrupt handler would not be able to access the                  PowerPC status register to block interrupts. If you                  were to use any PowerPC assembly language                  instructions dealing with that status register, you                  would cause a fatal supervisory exception. By                  leaving the interrupt handler as 68K code, that                  code could continue to "access" the 68K status                  register because the emulator provides these                  services to drivers. The native portions of these                  drivers will have to use UPPs to interface                  correctly with the 68K Device Manager. Even though                  the PowerPC code will have to go through a mixed                  mode switch for interrupt handling, the developer                  may choose to go this way because the bulk of the                  remaining code is PowerPC and could increase                  performance. This Note, however, does not address                  the details of using the Mixed Mode Manager.</P>                                    <P>See <CITE>Inside Macintosh: PowerPC System                  Software</CITE> for using 68K code with PowerPC                  code via the Mixed Mode Manager.</P>                                                     <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR><BR>For more details, see <a href="http://developer.apple.com/documentation/mac/PPCSoftware/PPCSoftware-2.html"><CITE>Inside Macintosh: PowerPC SystemSoftware</CITE></A>, p. 1-6.</P></TD></TR></TABLE></CENTER><BR><BR><P><A HREF="#top">Back to top</A></P>                                                         <P><A NAME=Section2></A></P>                                    <H2>PCI-Based Power Macintosh Interrupt                  Management</H2>                                    <P>With the introduction of the 9500 Power                  Macintosh, Apple has replaced its NuBus I/O model                  with the PCI I/O model and defined a new interrupt                  management scheme. This scheme is explained in                  detail in <CITE>Designing PCI Cards and Drivers for                  Power Macintosh Computers</CITE>, Chapter 9, Driver                  Services Library (DSL).</P>                                    <P>In this new I/O model, there are multiple levels                  of executions, including application, secondary,                  and primary execution levels that replace the old                  method of using interrupts to protect data. The                  primary and secondary execution levels are                  specifically for drivers and cannot use Toolbox                  services. Note that not a single Toolbox Manager is                  available. The services supplied at these primary                  and secondary levels via the Driver Services                  Library (DSL) include interrupt services. Other                  services, which replace the need to turn off                  interrupts that protect your data, include:</P>                                      <UL>                     <LI>memory management</LI>                                          <LI>timing services</LI>                                          <LI>atomic operations</LI>                                          <LI>queue operations</LI>                                          <LI>string operations</LI>                                          <LI>debugging support</LI>                  </UL>                                    <P>There are limitations placed on the execution                  context for some of these services. If you're an                  application developer, this means that some of                  these services - including interrupts - are off                  limits to your application. For the PCI driver                  writer, it means that these services, which exclude                  the Toolbox, are now your domain.</P>                                    <P>Again, there is no way to turn off the one and                  only interrupt on the PowerPC. If you are writing a                  driver, you may need to deal with a                  hardware-generated interrupts, assuming your device                  generates one. For example, a video driver may not                  generate one while a network driver most likely                  would. Also, there are new mechanisms and                  assumptions on how to deal with hardware generated                  interrupts.</P>                                    <P>The following example is one type of                  transactions between an application and a                  'ndrv' driver. There are other transactions at                  present and there will be more types defined with                  future releases of the Mac OS.</P>                                    <H3>An Example - A Simple Read Transaction</H3>                                    <P>Consider the following scenario. A PCI card in                  an expansion slot is capable of asynchronously                  reading data from an external source into the                  Macintosh main memory. This basic sample will                  describe this read transaction and what must be                  done to service the device generated interrupt. But                  there is an important caveat here. The driver in                  this example is a generic PCI driver of type                  'ndrv', as defined in <CITE>Designing PCI Cards and                  Drivers for Power Macintosh Computers</CITE>.</P>                                    <P>By choosing to write this kind of driver and                  following all of the guidelines in the above                  manual, you guarantee compatibility with future                  releases of the MacOS.</P>                                    <P>When the driver is loaded into memory by the Mac                  OS, the driver installs its interrupt routines and                  data in the Interrupt Source Tree (IST). It does so                  by using the Driver Services Library (DSL) routine                  <CODE>InstallInterruptFunctions</CODE>. The                  routines are used to disable, enable, and service                  device interrupts.</P>                                    <P>At some point, code running at the task level                  makes a PBRead asynchronous call to the driver via                  the Device Manager using a data structure called an                  <CODE>I/O Parameter Block (IOPB)</CODE>. Of special                  note here is that in the past, calls such as this                  one may have had private pointers contained in the                  parameter block that was passed to the driver. This                  will <I>not</I> work in future releases of the Mac                  OS because of the pending implementation of                  multiple address spaces. Publicly-documented buffer                  pointers and IOPB structures will continue to be                  supported.</P>                                    <P>The Device Manager makes a call to                  <CODE>DoDriverIO</CODE> with a read selector. The                  driver does what is necessary to set up its device                  for an asynchronous read and returns to the Device                  Manager with no return error and no indication that                  the read has been completed. The driver has                  completed its first task. The Device Manager                  returns to the caller. When the read has completed,                  the hardware generates an interrupt which is                  detected by the Mac OS. Using the interrupt                  structure which contains the address of the                  interrupt service routine (ISR) for the device,                  control is passed to the ISR.</P>                                    <P>The ISR is allowed to complete its function                  uninterrupted, which is why an ISR must make every                  effort to spend as little time as possible                  servicing its device at the primary interrupt                  level. The driver should then queue a secondary                  interrupt handler to do any remaining work to                  service the device and/or the data using the DSL                  function                  <CODE>QueueSecondaryInterruptHandler</CODE>. This                  ensures that interrupt latency for the system is                  kept to a minimum.</P>                   <H4>Returning Control to the Mac OS</H4>                                    <P>Having completed those tasks, the ISR returns                  control to the Mac OS. Secondary interrupt handlers                  are run before control is returned to task level                  code but can still be preempted by other primary                  interrupt handlers. By using the secondary                  interrupt handler to complete non-device-related                  tasks belonging to the read transaction, the driver                  writer is not locking out other code and is                  behaving appropriately in a multitasking                  environment. The secondary interrupt handler                  finishes any remaining tasks if they exist and                  makes a call to <CODE>IOCommandISComplete</CODE>                  passing a completion status, in this case, "read                  was successful." The IOPB is updated by the Device                  Manager and control is passed back to the caller's                  I/O completion routine.</P>                                    <P>And the point of this example? <I>Interrupts are                  not available to applications, but there are ways                  for applications and interrupt handlers to exchange                  information</I>.</P>                                                     <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR><BR>See <CITE>Designing PCI Cards and Driversfor Power Macintosh Computers</CITE>, Chapter 9,Memory Management Services, p.240.</P></TD></TR></TABLE></CENTER><BR><BR><P><A HREF="#top">Back to top</A></P>                                    <P>&nbsp;<A NAME=Summary></A></P>                                    <H2>Summary</H2>                                    <P>The PowerPC interrupt is not available to an                  application. Until the next major release of the                  Mac OS, you can use the emulated 68K interrupt                  mechanism. Using the interrupt on the PowerPC is                  not an option and would be catastrophic if                  attempted. Interrupts from expansion devices,                  however, are fully supported in PowerPC for both                  NuBus and PCI slots. For more information about how                  to manage expansion interrupts on the PowerPC with                  PCI, refer to <CITE>Designing PCI Cards and Drivers                  for Power Macintosh Computers</CITE>.</P><P><A HREF="#top">Back to top</A></P>                           <P>&nbsp;<A NAME=References></A></P>                  <H2>References</H2>                              <p><I>Designing PCI Cards and Drivers for Power                     Macintosh Computers</I>.</p>                                          <p>PowerPC 601 RISC microprocessor User's                     Manual MPC601UM/AD.</p>                                          <p>M68000 8-/16-/32-Bit microprocessors User's                     Manual, Sixth Edition, M68000UM/AD Rev 5.</p>                                          <p><a href="http://developer.apple.com/documentation/mac/PPCSoftware/PPCSoftware-2.html"><I>Inside                     Macintosh: PowerPC System Software</I></A>,                     Addison-Wesley.</p><BR><BR><P><A HREF="#top">Back to top</A></P>                                    <P>&nbsp;<A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (52K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tn1001.pdf">Download</A></P>               </TD>            </TR>         </TABLE>         <BR><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1001.html%3Fid%3DDTS10002844-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1001.html%3Fid%3DDTS10002844-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1001.html%3Fid%3DDTS10002844-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>