<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>CFM-68K Shared Library Structure</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING111></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="RTArch-110.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="RTArch-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="RTArch-147.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="RTArch-112.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="RTArch-2.html"><B>Mac OS Runtime Architectures</B></A> / <BR><DD><A HREF="RTArch-102.html"><B>Chapter 9 - CFM-68K Application and Shared Library Structure</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING111-0></A>
<H1>CFM-68K Shared Library Structure</H1>
 <A NAME=MARKER-2-64></A>In some development environments, creating a CFM-68K shared library involves first creating a segmented version of the library and then flattening it to produce a contiguous program that is stored in the file's data fork. In MPW, the mechanism for flattening segmented shared libraries is the MakeFlat tool. This section describes what conversions are necessary to go from a segmented state to a flattened state and how MakeFlat implements these conversions. <P>
 You need to read this section in either of these two cases:<P>
<UL>
<LI>You want to understand how the MPW MakeFlat tool flattens CFM-68K shared libraries.
<LI>You are writing a library flattening tool and want to understand what conversions are necessary.<P>
</UL>
 An unflattened shared library has a structure very similar to that of a CFM-68K runtime application. The main differences are as follows:<P>
<UL>
<LI>The transition vectors are 8 bytes long instead of 12.
<LI>The PEF container's data section is not compressed.
<LI>The<CODE> 'cfrg'0</CODE> resource indicates that the fragment is a library, not an application.<P>
</UL>
 The structure changes radically, however, when you flatten the segmented library using the MakeFlat tool. <A NAME=MARKER-2-39></A>MakeFlat makes the following changes to a segmented shared library:<P>
<UL>
<LI>Converts the shared library's <CODE>'CODE'</CODE> resources (except for <CODE>'CODE'0</CODE> and <CODE>'CODE'6</CODE>) into code sections in the output PEF container. 
<LI>Modifies the PEF relocations.
<LI>Converts jump table entries and transition vectors to their flattened state.
<LI>Compresses the PEF container's data section.
<LI>Creates a new <CODE>'cfrg'0</CODE> resource specifying the new location of the PEF container.
<LI>Adds a debug section to the output PEF container so you can use the 68K Macintosh Debugger to debug shared libraries.
<LI>Adds code to properly call static constructor or destructor routines if they exist in the shared library. <P>
</UL>
 After making these changes, MakeFlat writes the PEF container to the data fork of the output file. <P>
 The following sections describe some of the conversions in greater detail.<P>
<HR>
<B>Subtopics</B>
<B><!-- TOC --><DL>
<DL>
<DT><A HREF="RTArch-112.html#HEADING112-0">Jump Table Conversion</A>
<DD>
<DT><A HREF="RTArch-113.html#HEADING113-0">Transition Vector Conversion</A>
<DD>
<DT><A HREF="RTArch-114.html#HEADING114-0">Static Constructors and Destructors</A>
<DD>
</DL>
</DL>
</B>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="RTArch-110.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="RTArch-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="RTArch-147.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="RTArch-112.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="RTArch-3.html">&copy; Apple Computer, Inc.</A><br>11 MARCH 1997<P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML> 
