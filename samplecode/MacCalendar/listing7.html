<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>MacCalendar - /MacCalendarSetup.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; <A HREF="javascript:location.replace('index.html');">MacCalendar</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Carbon/idxHumanInterfaceToolbox-date.html" target="_blank">Carbon > Human Interface Toolbox</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">MacCalendar</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/MacCalendarSetup.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/DrawCalendar.c</option>
<option value="listing2.html">/DrawCalendar.h</option>
<option value="listing3.html">/MacCalendar.c</option>
<option value="listing4.html">/MacCalendar.h</option>
<option value="listing5.html">/MacCalendar.r</option>
<option value="listing6.html">/MacCalendarCommon.h</option>
<option value="listing7.html">/MacCalendarSetup.c</option>
<option value="listing8.html">/MacCalendarSetup.h</option>
<option value="listing9.html">/MacCalendarSetup.r</option></select>
				</p>
				</form>
				<p><strong><a href="MacCalendar.zip">Download Sample</a></strong> (&#147;MacCalendar.zip&#148;, 37.4K)<BR>
<strong><a href="MacCalendar.dmg">Download Sample</a></strong> (&#147;MacCalendar.dmg&#148;, 94.6K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*  File:    MacCalendarSetup.c  Contains:  Application for configuring the control strip.  Written by:  Martin Minow  Copyright:  &copy; 1994-1997 by Apple Computer, Inc., all rights reserved.  Change History (most recent first):  You may incorporate this sample code into your applications without  restriction, though the sample code has been provided &quot;AS IS&quot; and the  responsibility for its operation is 100% yours.  However, what you are  not permitted to do is to redistribute the source as &quot;DSC Sample Code&quot;  after having made changes. If you're going to re-distribute the source,  we require that you make it clear in the source that the code was  descended from Apple Sample Code, but that you've made changes.  Sets the configuration parameters for MacCalendar  File Type      APPL  File Creator    SCCF  -- registered with DTS *//////////////////////////////////////////////////////////////////////////// Pick up resource constants common to both control strip// module and application.#include &quot;MacCalendarCommon.h&quot;/////////////////////////////////////////////////////////////////////////// Pick up resource constants common to both C and Rez for// the application.#include &quot;MacCalendarSetup.h&quot;/////////////////////////////////////////////////////////////////////////// Pick up prototype for the core drawing code.#include &quot;DrawCalendar.h&quot;/////////////////////////////////////////////////////////////////////////#include &lt;Dialogs.h&gt;#include &lt;Errors.h&gt;#include &lt;Fonts.h&gt;#include &lt;Memory.h&gt;#include &lt;Menus.h&gt;#include &lt;Quickdraw.h&gt;#include &lt;Resources.h&gt;#include &lt;ToolUtils.h&gt;#include &lt;Types.h&gt;#include &lt;Gestalt.h&gt;#include &lt;Processes.h&gt;/////////////////////////////////////////////////////////////////////////// Various globals and constants.// Indices into the STRN_Messages STR# resource.enum {  kMsgSystemError = 1};/* * Items in the setup dialog ('DITL' ID=DLOG_Setup). * * Note: kOKButton is also used for Alerts. */enum {  kOKButton = 1,  kCancelButton,  kCalendarUserItem,  kFontNamePopupItem,  kFontSizePopupItem,  kFirstDayPopupItem,  kDayNameUserItem,  kSundayText,      /* Day names must be in order  */  kMondayText,  kTuesdayText,  kWednesdayText,  kThursdayText,  kFridayText,  kSaturdayText,#if DEBUG  kPrevMonth,  kNextMonth,#endif  kDummyLastEnumBecauseWeCare  };DialogPtr      gSetupDialog;short        gAppResourceFile;SavedSettingsHandle  gSettingHandle = NULL;DateTimeRec      gNow;/////////////////////////////////////////////////////////////////////////// Boiler plate error dialogs.static voidErrorAlert(    short          alertID,    OSErr          errorStatus,    short          errorMsgID  ){    Handle          errorTextHdl;    Str15          errorStatusText;    short          userChoice;    Str255          errorMsgText;    Str255          errorText;    short          saveResFile;        saveResFile = CurResFile();    UseResFile(gAppResourceFile);    GetIndString(errorMsgText, STRN_Messages, errorMsgID);    NumToString(errorStatus, errorStatusText);    errorTextHdl = GetResource('Estr', errorStatus);    if (errorTextHdl != NULL)      pstrcpy(errorText, *errorTextHdl);    else {      GetIndString(errorText, STRN_Messages, kMsgSystemError);    }    ParamText(errorStatusText, errorText, errorMsgText, &quot;\p&quot;);    userChoice = StopAlert(alertID, NULL);    UseResFile(saveResFile);    if (alertID == ALRT_FatalError || userChoice == kOKButton)      ExitToShell();}static voidNonFatalError(    OSErr          errorStatus,    short          errorMsgID  ){    ErrorAlert(ALRT_NonFatalError, errorStatus, errorMsgID);}static voidFatalError(    OSErr          errorStatus,    short          errorMsgID  ){    ErrorAlert(ALRT_FatalError, errorStatus, errorMsgID);}/////////////////////////////////////////////////////////////////////////static UserItemUPP gDrawDayNameUserItemUPP;static pascal voidDrawDayNameUserItem(    DialogPtr        theDialog,    short          itemNumber  ){    short          itemType;    Handle          itemHandle;    Rect          itemRect;    Rect          dayNameRect;    short          i;    Str255          work;    Intl1Rec        **itlHandle;    GrafPtr          savePort;    short          saveFontNumber;    short          saveFontSize;        GetPort(&amp;savePort);    SetPort(theDialog);    saveFontNumber = theDialog-&gt;txFont;    saveFontSize = theDialog-&gt;txSize;    GetDialogItem(      theDialog,      itemNumber,      &amp;itemType,      &amp;itemHandle,      &amp;dayNameRect    );    itlHandle = (Intl1Rec **) GetIntlResource(1);    for (i = 0; i &lt; 7; i++) {      /*       * Get the string, abbreviate it, and draw it in the       * day name rectangle, tabbed over the associated       *\xCAedit text area. Messy, but it looks nicer.       */      pstrcpy(work, (**itlHandle).days[i]);      GetDialogItem(        theDialog,        kSundayText + i,        &amp;itemType,        &amp;itemHandle,        &amp;itemRect      );      itemRect.top = dayNameRect.top;      itemRect.bottom = dayNameRect.bottom;      TETextBox(        &amp;work[1],        (**itlHandle).abbrLen,        &amp;itemRect,        teJustLeft      );    }    TextFont(saveFontNumber);    TextSize(saveFontSize);    SetPort(savePort);}/////////////////////////////////////////////////////////////////////////static voidAddThisDayName(    short          dayNumber  ){    short          itemType;    Handle          itemHandle;    Rect          itemRect;    Str255          work;    GetDialogItem(      gSetupDialog,      dayNumber,      &amp;itemType,      &amp;itemHandle,      &amp;itemRect    );    GetDialogItemText(itemHandle, work);    BlockMoveData(      work,      &amp;(**gSettingHandle).dayNameString[(**gSettingHandle).dayNameString[0] + 1],      work[0] + 1    );    (**gSettingHandle).dayNameString[0] += (work[0] + 1);}/////////////////////////////////////////////////////////////////////////static voidRebuildDayNameText(void){    short            i;        (**gSettingHandle).dayNameString[0] = 0;    if ((**gSettingHandle).firstDayOfWeek == kFirstIsMonday) {      for (i = kMondayText; i &lt;= kSaturdayText; i++)        AddThisDayName(i);      AddThisDayName(kSundayText);    }    else {      for (i = kSundayText; i &lt;= kSaturdayText; i++)        AddThisDayName(i);    }    (**gSettingHandle).dayNameString[++(**gSettingHandle).dayNameString[0]] = 0;}/////////////////////////////////////////////////////////////////////////static UserItemUPP gDrawCalendarUserItemUPP;static pascal voidDrawCalendarUserItem(    DialogPtr        theDialog,    short          itemNumber  ){    short          itemType;    Handle          itemHandle;    Rect          itemRect;    short          fontNumber;    GrafPtr          savePort;    short          saveFontNumber;    short          saveFontSize;    RgnHandle        saveRgn;        RebuildDayNameText();    GetPort(&amp;savePort);    SetPort(theDialog);    saveFontNumber = theDialog-&gt;txFont;    saveFontSize = theDialog-&gt;txSize;    GetDialogItem(      theDialog,      itemNumber,      &amp;itemType,      &amp;itemHandle,      &amp;itemRect    );    EraseRect(&amp;itemRect);    FrameRect(&amp;itemRect);    GetFNum((**gSettingHandle).fontName, &amp;fontNumber);    saveRgn = NewRgn();    GetClip(saveRgn);    ClipRect(&amp;itemRect);    DrawCalendar(      gSettingHandle,      gNow.year,      gNow.month,      &amp;itemRect    );    SetClip(saveRgn);    DisposeRgn(saveRgn);    TextFont(saveFontNumber);    TextSize(saveFontSize);    SetPort(savePort);}/////////////////////////////////////////////////////////////////////////static voidSetThisDayName(    short          itemNumber,    ConstStr255Param    itemText  ){    short        itemType;    Handle        itemHandle;    Rect        itemRect;    GetDialogItem(      gSetupDialog,      itemNumber,      &amp;itemType,      &amp;itemHandle,      &amp;itemRect    );    SetDialogItemText(itemHandle, itemText);}/////////////////////////////////////////////////////////////////////////static voidSetupDialog(void){    short        nMenuItems;    short        i;    Str255        work;    Str255        fontSizeText;    short        itemType;    Handle        itemHandle;    Rect        itemRect;    StringPtr      dayName;    SetDialogDefaultItem(gSetupDialog, kOKButton);    SetDialogCancelItem(gSetupDialog, kCancelButton);    /*     * Set the font name popup menu     */    nMenuItems = CountMItems(GetMenu(MENU_Font));    for (i = 1; i &lt;= nMenuItems; i++) {      GetMenuItemText(GetMenu(MENU_Font), i, work);      if (EqualString(work, (**gSettingHandle).fontName, FALSE, FALSE))        break;    }    if (i &lt;= nMenuItems) {      GetDialogItem(        gSetupDialog,        kFontNamePopupItem,        &amp;itemType,        &amp;itemHandle,        &amp;itemRect      );      SetControlValue((ControlHandle) itemHandle, i);    }    /*     * Set the font size popup menu     */    nMenuItems = CountMItems(GetMenu(MENU_FontSize));    NumToString((**gSettingHandle).fontSize, fontSizeText);    for (i = 1; i &lt;= nMenuItems; i++) {      GetMenuItemText(GetMenu(MENU_FontSize), i, work);      if (EqualString(work, fontSizeText, FALSE, FALSE))        break;    }    if (i &lt;= nMenuItems) {      GetDialogItem(        gSetupDialog,        kFontSizePopupItem,        &amp;itemType,        &amp;itemHandle,        &amp;itemRect      );      SetControlValue((ControlHandle) itemHandle, i);    }    /*     * Set the first day popup menu     */    GetDialogItem(      gSetupDialog,      kFirstDayPopupItem,      &amp;itemType,      &amp;itemHandle,      &amp;itemRect    );    SetControlValue(      (ControlHandle) itemHandle,      (**gSettingHandle).firstDayOfWeek    );    /*     * Set the calendar drawing procedure     */    GetDialogItem(      gSetupDialog,      kCalendarUserItem,      &amp;itemType,      &amp;itemHandle,      &amp;itemRect    );    SetDialogItem(      gSetupDialog,      kCalendarUserItem,      itemType,      (Handle) gDrawCalendarUserItemUPP,      &amp;itemRect    );    /*     * Setup the day name user item     */    GetDialogItem(      gSetupDialog,      kDayNameUserItem,      &amp;itemType,      &amp;itemHandle,      &amp;itemRect    );    SetDialogItem(      gSetupDialog,      kDayNameUserItem,      itemType,      (Handle) gDrawDayNameUserItemUPP,      &amp;itemRect    );    /*     * Move the current date string into the dialog edit records.     */    dayName = (StringPtr) &amp;(**gSettingHandle).dayNameString[1];    i = ((**gSettingHandle).firstDayOfWeek == kFirstIsSunday)      ? kSundayText : kMondayText;    for (; i &lt;= kSaturdayText; i++) {      SetThisDayName(i, dayName);      dayName = (StringPtr) &amp;dayName[dayName[0] + 1];    }    if ((**gSettingHandle).firstDayOfWeek == kFirstIsMonday)      SetThisDayName(kSundayText, dayName);}/////////////////////////////////////////////////////////////////////////static OSErrReadCurrentParameters(void){    OSErr          result;    result = Gestalt(kControlStripCreator, (long *) &amp;gSettingHandle);    if (result == noErr       &amp;&amp; gSettingHandle != nil       &amp;&amp; GetHandleSize((Handle) gSettingHandle) == sizeof (SavedSettings)       &amp;&amp; (**gSettingHandle).signature == kControlStripCreator       &amp;&amp; (**gSettingHandle).prefVersion == kPrefVersion) {      result = HandToHand( (Handle *) &amp;gSettingHandle );    } else {      if (result == noErr) {        result = gestaltUndefSelectorErr;      }    }        if (gSettingHandle != nil) {      HLock( (Handle) gSettingHandle);    }        return (result);}/////////////////////////////////////////////////////////////////////////static voidSaveNewParameters(void){    OSErr          status;    SavedSettingsHandle    controlStripSettings;    // Locate the control strip's settings handle.        status = Gestalt(kControlStripCreator, (long *) &amp;controlStripSettings);    QAssert(status == noErr);    QAssert(controlStripSettings != nil);    QAssert(GetHandleSize( (Handle) controlStripSettings) == sizeof (SavedSettings));    QAssert((**controlStripSettings).signature == kControlStripCreator);    QAssert((**controlStripSettings).prefVersion == kPrefVersion);        // Copy the new settings into the control strip's preferences.        pstrcpy( (**controlStripSettings).dayNameString , (**gSettingHandle).dayNameString );    pstrcpy( (**controlStripSettings).fontName , (**gSettingHandle).fontName );    (**controlStripSettings).fontSize = (**gSettingHandle).fontSize;    (**controlStripSettings).firstDayOfWeek = (**gSettingHandle).firstDayOfWeek;        // Bump the modification count so that the control strip knows we    // want it to save the settings.    (**controlStripSettings).modCount += 1;}/////////////////////////////////////////////////////////////////////////static voidInitApplication(void){    Handle          menuBarHdl;        InitGraf(&amp;qd.thePort);    InitFonts();    InitWindows();    InitMenus();    TEInit();    InitDialogs(0);    MaxApplZone();    menuBarHdl = GetNewMBar(MBAR_MenuBar);    SetMenuBar(menuBarHdl);    AppendResMenu(GetMenuHandle(MENU_Apple), 'DRVR');    AppendResMenu(GetMenu(MENU_Font), 'FONT');    DrawMenuBar();    gAppResourceFile = CurResFile();    gDrawCalendarUserItemUPP = NewUserItemProc(DrawCalendarUserItem);    gDrawDayNameUserItemUPP = NewUserItemProc(DrawDayNameUserItem);    InitCursor();}/////////////////////////////////////////////////////////////////////////static BooleanDoDialog(void){    short        itemHit;    short        itemType;    Handle        itemHandle;    Rect        itemRect;    short        i;    Str255        work;    Boolean        redraw;    long        newFontSize;        ShowWindow(gSetupDialog);    do {      ModalDialog(NULL, &amp;itemHit);      GetDialogItem(        gSetupDialog,        itemHit,        &amp;itemType,        &amp;itemHandle,        &amp;itemRect      );      redraw = FALSE;      switch (itemHit) {      case kFontNamePopupItem:        i = GetControlValue((ControlHandle) itemHandle);        GetMenuItemText(GetMenu(MENU_Font), i, work);        if (EqualString((**gSettingHandle).fontName, work, FALSE, FALSE) == FALSE) {          pstrcpy((**gSettingHandle).fontName, work);          redraw = TRUE;        }        break;      case kFontSizePopupItem:        i = GetControlValue((ControlHandle) itemHandle);        GetMenuItemText(GetMenu(MENU_FontSize), i, work);        StringToNum(work, &amp;newFontSize);        if (newFontSize != (**gSettingHandle).fontSize) {          (**gSettingHandle).fontSize = newFontSize;          redraw = TRUE;        }        break;      case kFirstDayPopupItem:        i =  GetControlValue((ControlHandle) itemHandle);        if (i != (**gSettingHandle).firstDayOfWeek) {          (**gSettingHandle).firstDayOfWeek = i;          redraw = TRUE;        }        break;#if DEBUG      /*       * This lets us test the drawing algorithm without rebuilding the       * actual status bar and rebooting the machine.       */      case kPrevMonth:        if (--gNow.month &lt; 1) {          gNow.month = 12;          --gNow.year;        }        redraw = TRUE;        break;      case kNextMonth:        if (++gNow.month &gt; 12) {          gNow.month = 1;          ++gNow.year;        }        redraw = TRUE;        break;#endif      default:        if (itemHit &gt;= kSundayText &amp;&amp; itemHit &lt;= kSaturdayText)          redraw = TRUE;        break;      }      if (redraw)        DrawCalendarUserItem(gSetupDialog, kCalendarUserItem);    } while (itemHit != kOKButton &amp;&amp; itemHit != kCancelButton);    return (itemHit == kOKButton);}/////////////////////////////////////////////////////////////////////////voidmain(void){    unsigned long      nowSeconds;    Boolean          updateNeeded;        InitApplication();    GetDateTime(&amp;nowSeconds);    SecondsToDate(nowSeconds, &amp;gNow);    gSetupDialog = GetNewDialog(DLOG_Setup, NULL, (WindowPtr) -1L);    if (gSetupDialog != NULL) {      if (ReadCurrentParameters() != noErr) {        NoteAlert(ALRT_NoPreferences, NULL);      } else {        SetupDialog();        updateNeeded = DoDialog();        if (updateNeeded) {          SaveNewParameters();        }      }      DisposeDialog(gSetupDialog);    }    ExitToShell();}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/MacCalendar/listing7.html%3Fid%3DDTS10000190-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/MacCalendar/listing7.html%3Fid%3DDTS10000190-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/MacCalendar/listing7.html%3Fid%3DDTS10000190-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>