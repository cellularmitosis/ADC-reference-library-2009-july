<HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><script language="JavaScript" src="frametest.js"></script><TITLE> Private Calls and Virtual Memory</TITLE></HEAD><BODY BGCOLOR="#ffffff"><DIV><a name="top"></a><!-- start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!-- start of path --><font face="Geneva,Helvetica,Arial" size="1"><b><br>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Documentation</a> &gt; <!-- a href="" target="_top" -->Hardware<!-- /a -->  <b>&gt; </b><a href="../../devicemgrs.html" target="_top">Device Managers and Drivers</a> <b>&gt; </b><a href="../pci_srvcs.html" target="_top">PCI Card Services</a> <b>&gt; </b>Designing PCI Cards and Drivers for Power Macintosh Computers</font><br><br><!-- end of path --><A HREF="PCI_BOOK.d9.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.db.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.dd.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><HR></DIV><H1 CLASS="H3.Heading3"><A NAME="pgfId=4731"> </A>Private Calls and Virtual Memory</H1><P CLASS="T1.Text1"><A NAME="pgfId=4732"> </A>If your driver supports virtual memory (you can use the <TT CLASS="cv">kdgVMOptions</TT> Driver Gestalt selector to indicate this), you must be careful to avoid fatal page faults when fielding private control calls. Specifically, your driver must not cause a page fault while it is fielding a queued (that is, synchronous or asynchronous) request.</P><P CLASS="T1.Text1"><A NAME="pgfId=4733"> </A>The Virtual Memory Manager holds the entire ParamBlockRec passed to all queued _Read, _Write, _Control, and _Status calls. In addition, VM holds the  I/O&nbsp;buffer (pointed to by <TT CLASS="cv">ioBuffer</TT>, for length <TT CLASS="cv">ioReqCount</TT>). Therefore your driver can safely access this memory without causing a fatal page fault.</P><P CLASS="T1.Text1"><A NAME="pgfId=4734"> </A>The problem comes when you define a private control call whose ParamBlockRec contains a pointer to another piece of memory. If your driver accesses that memory, it may cause a page fault. If your driver supports virtual memory, that page fault will be fatal (because a page fault while any paging device is busy is fatal).</P><P CLASS="T1.Text1"><A NAME="pgfId=4735"> </A>There are a number of ways to avoid this problem.</P><OL><LI CLASS="N/.NList=1"><A NAME="pgfId=4736"> </A>Always include all information inline in the parameter block. Remember that the parameter block is automatically held for you by the Virtual Memory Manager. </LI><LI CLASS="N.NList"><A NAME="pgfId=4737"> </A>If you must include pointers in your parameter block, define your private control call interface to be called immediate. Immediate calls to a driver do not mark the driver as busy, and hence any page faults they cause will not be fatal. However, your driver must be written to support immediate calls of this kind. </LI><LI CLASS="N.NList"><A NAME="pgfId=4738"> </A>If none of the above are suitable, you must require that your clients hold any buffers pointed to by the parameter block. </LI></OL><P CLASS="T1.Text1"><A NAME="pgfId=4739"> </A>If you make a Control or Status call to a device driver which supports paging and the parameter block contains pointers to other data structures, you should hold those data structures, just to be sure.</P><P CLASS="T1.Text1"><A NAME="pgfId=4740"> </A>For more background about how the Mac OS Virtual Memory Manager prevents fatal page faults, see DTS Technote 1094, &quot;Virtual Memory Application Compatibility.&quot; </P><HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 26 March 99)<P><A HREF="PCI_BOOK.d9.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.db.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.dd.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>