<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Opening a Secure Connection(IM:N)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING114></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Networking-113.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-115.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Networking-2.html"><B>Networking</B></A> / <BR><DD><A HREF="Networking-98.html"><B>Chapter 5 - AppleTalk Data Stream Protocol (ADSP) </B></A> / <A HREF="Networking-113.html"><B>Using ASDSP </B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING114-0></A>
<H2><A NAME=MARKER-9-203></A>Opening a Secure Connection</H2>
 <A NAME=MARKER-2-167></A>To open a secure ASDSP connection, both the initiator and the recipient must call the <CODE>sdspOpen</CODE> routine after calling the <CODE>dspInit</CODE> routine and, optionally, the <CODE>dspOptions</CODE> routine. First this section describes how the initiator part of an application opens a <BR>secure connection. Then it describes how the recipient end of an application opens <BR>a secure connection.<P>
<A NAME=HEADING114-2></A>
<H3>From the Initiator's End </H3>
 An <A NAME=MARKER-2-205></A>initiator can send a request to open a secure session to<P>
<UL>
<LI>a specific socket whose client application has opened a connection end to wait passively for a connection request
<LI>a connection listener whose function is to accept requests for secure connections and pass those requests on to a connection server<P>
</UL>
 The initiator makes either an AOCE <A NAME=MARKER-2-118></A><CODE>AuthTradeProxyForCredentials</CODE> call or an AOCE <A NAME=MARKER-2-176></A><CODE>AuthGetCredentials</CODE> call to the authentication server. It passes to the authenti-<BR>cation server its own name and the name of the recipient and gets back the session key and the credentials for the session. For an explanation of the calls that the initiator must make to the Authentication Manager, see the chapter "Authentication Manager" in <I>Inside Macintosh: AOCE Application Programming Interfaces.</I><P>
 Through the <CODE>sdspOpen</CODE> call, the initiator passes the credentials to ASDSP to send to the recipient. ASDSP decrypts the credentials and passes the decrypted credential informa-<BR>tion to the recipient. <P>
 To open a secure ASDSP connection, the initiator performs the following procedure:<P>
<OL>
<LI>Determine if the Apple Open Collaboration Environment (AOCE) software is installed by calling the <CODE>Gestalt</CODE> function. See the chapter "Introduction to AOCE" in <I>Inside Macintosh: AOCE Application Programming Interfaces</I> for a description of the selector values that you use. 
<LI>Allocate memory for the required data structures identified in this step. The memory belongs to ASDSP until the routine completes execution, after which you can either release or reuse the memory. You must either allocate nonrelocatable memory or lock the memory until the routine completes. See the chapter "Authentication Manager" in <I>Inside Macintosh: AOCE Application Programming Interfaces</I> for a description of the memory that you need to allocate for calls that you make to that interface. The data structures that you need to allocate memory for are listed here:<P>
<UL>
<LI>An ASDSP parameter block of type <CODE>SDSPParamBlock</CODE>. You pass a pointer to this parameter block as the value of the <CODE>paramBlock</CODE> parameter to the <CODE>PBControl</CODE> function. (See <A HREF=Networking-120.html#MARKER-9-264>"The ASDSP Parameter Block" on page 5-41</A>.)
<LI>A workspace buffer that the <CODE>sdspOpen</CODE> routine <A NAME=MARKER-2-107></A>uses internally whose size is equal to <CODE>sdspWorkSize</CODE>. The memory for this buffer must be aligned on an even boundary. You pass a pointer to this buffer as the value of the <CODE>workspace</CODE> parameter. 
<LI>A buffer for the credentials retrieved from the authentication server and passed <BR>to ASDSP. 
<LI>A buffer for the session key retrieved from the authentication server and passed to ASDSP. This is a data structure of type <CODE>AuthKey</CODE>.<P>
</UL>
<LI>Call the Authentication Manager's<A NAME=MARKER-2-212></A> <CODE>AuthGetUTCTime</CODE> function to get the <A NAME=MARKER-2-213></A>universal coordinated time (UTC). You base the credentials expiration time that you specify <BR>as input to the <CODE>AuthGetCredentials</CODE> function on the UTC. See the chapter "Authentication Manager" for a description of the <CODE>AuthGetUTCTime</CODE> function. 
<LI>Obtain your (the initiator's) identity and the recipient's record ID. (You can use the local identity or get a specific identity for the initiator.) You need to pass these values to the authentication server to get the session key and credential block from the server. See the chapter "Authentication Manager" for a discussion of identities and complete instruction on how to get these values.
<LI>Call the Authentication Manager's <CODE>AuthGetCredentials</CODE> function or <CODE>AuthTradeProxyForCredentials</CODE> function to get the credentials and the session key. You use these values as input to the <CODE>sdspOpen</CODE> routine. See the chapter "Authentication Manager" for information on the <CODE>AuthGetCredentials</CODE> and <CODE>AuthTradeProxyForCredentials</CODE> functions. <P>
You pass the <CODE>AuthGetCredentials</CODE> function or <CODE>AuthTradeProxyForCredentials</CODE> function the following values returned from the functions that you called in the previous steps:<P>
<UL>
<LI>The initiator's identity.
<LI>A pointer to a buffer containing the record ID for the recipient.
<LI>The desired expiration time of the credentials. You use the <CODE>expiry</CODE> parameter to specify for how long you want the credentials to be valid. Credentials are valid for at most eight hours after they are returned to the initiator by the server. You base the expiration time on the UTC time returned by the <CODE>AuthGetUTCTime</CODE> function. 
<LI>The expected length of the credentials. A buffer three times the size of a packed record ID is usually sufficient for credentials. The AOCE constant <CODE>kPackedRecordIDMaxBytes</CODE> specifies the size of a single packed record ID. <P>
</UL>
<LI>Call the <CODE>sdspOpen</CODE> routine to open a secure connection. To call the <CODE>sdspOpen</CODE> routine, you call the Device Manager's <A NAME=MARKER-2-99></A><CODE>PBControl</CODE> function and specify <CODE>sdspOpen</CODE> as the value of the <CODE>csCode</CODE> parameter. The parameter block for the <CODE>sdspOpen</CODE> routine includes fields also used for the standard <CODE>dspOpen</CODE> routine. In addition to these parameters, you specify parameters used in the authentication process to establish <BR>the secure connection. <P>
The initiator application calls the <CODE>sdspOpen</CODE> routine with a value of <CODE>ocRequest</CODE> for the <CODE>ocMode</CODE> parameter to direct ASDSP to open a connection with a specific socket on the AppleTalk internet. When you execute the <CODE>sdspOpen</CODE> routine in the <CODE>ocRequest</CODE> mode, ASDSP sends an open-connection request to the address you specify. <P>
If the socket to which you send the open-connection request is a connection listener, the connection server that operates that connection listener can select any socket on the internet to be the connection end that responds to the open-connection request. To restrict the socket from which you will accept a response to your open-connection request, specify a value for the <CODE>filterAddress</CODE> parameter to the <CODE>sdspOpen</CODE> routine.<P>
To use the <CODE>ocRequest</CODE> mode, you must know the complete internet address of the remote socket, and the ASDSP client at that address must either be a connection listener or have executed the <CODE>sdspOpen</CODE> routine in the <CODE>ocPassive</CODE> mode. You can use the NBP routines to obtain a list of the names of objects on the internet and to determine the internet address of a socket when you know its name. See the chapter "Name-Binding Protocol (NBP)" in this book for information on the NBP routines.<P>
In addition to the standard ADSP parameters required for a <CODE>dspOpen</CODE> call, the initiator supplies the following input values to the <CODE>sdspOpen</CODE> call:
<TABLE BORDER="0" CELLPADDING=3><TH ALIGN=LEFT>&nbsp;<TH>Parameter<TH>Value<TR>
<TD>&nbsp;<TD>secure<TD>To open a secure authenticated connection, pass a value <BR>of <CODE>TRUE</CODE>. To open a normal, unauthenticated connection, <BR>pass a value of <CODE>FALSE</CODE>.<TR>
<TD>&nbsp;<TD>sessionKey<TD>A pointer to the encryption key returned from <BR>the <CODE>AuthGetCredentials</CODE> or<CODE> AuthTradeProxyForCredentials</CODE> function. <TR>
<TD>&nbsp;<TD>credentialsSize<TD>The value that the <CODE>AuthGetCredentials</CODE> function or <BR>the <CODE>AuthTradeProxyForCredentials</CODE> function returned that specifies the length of the credentials.<TR>
<TD>&nbsp;<TD>credentials<TD>A pointer to the credentials that the <CODE>AuthGetCredentials</CODE> function or the <CODE>AuthTradeProxyForCredentials</CODE> function returned.<TR>
<TD>&nbsp;<TD>workspace<TD>A pointer to the workspace buffer that you allocated, which is for ASDSP's internal use.</TABLE>
<P>
</OL>
<A NAME=HEADING114-28></A>
<H3>From the Recipient End</H3>
 To open a secure ASDSP connection, the recipient performs the following procedure:<P>
<OL>
<LI>Allocate memory for the following data structures. The memory belongs to ASDSP until the routine completes execution, after which you can either release or reuse the memory. You must either allocate nonrelocatable memory or lock the memory until the routine completes.<P>
<UL>
<LI>An ASDSP secure parameter block of type <CODE>SDSPParamBlock</CODE>. You pass a pointer to this parameter block as the value of the <CODE>paramBlock</CODE> parameter to the <CODE>PBControl</CODE> function. (See <A HREF=Networking-120.html#MARKER-9-264>"The ASDSP Parameter Block" beginning on page 5-41</A>.)
<LI>A workspace buffer that the <CODE>sdspOpen</CODE> routine uses internally whose size is equal to <CODE>sdspWorkSize</CODE>. The memory for this buffer must be aligned on an even boundary. You must pass a pointer to the buffer as the value of the <CODE>workspace</CODE> parameter. 
<LI>A <A NAME=MARKER-2-215></A>data structure of type <CODE>AuthKey</CODE> for the <A NAME=MARKER-2-216></A>session key retrieved from the authentica-<BR>tion server and passed to ASDSP. ASDSP breaks out from the credentials block the session key encrypted in the recipient's private key and returns the session key to the recipient in the <CODE>sessionKey</CODE> buffer.
<LI>A buffer for the record ID of the initiator that ASDSP returns to the recipient in response to the recipient's <CODE>sdspOpen</CODE> routine. You pass a pointer to this buffer as the value of the <CODE>initiator</CODE> parameter. ASDSP breaks out the initiator's record ID from the credential block that the initiator passes to ASDSP and returns it to the recipient. See the chapter "Authentication Manager" in <I>Inside Macintosh: AOCE Application Programming Interfaces</I> for a description of how to create a maximum-<BR>size record ID structure that is large enough to hold any record ID. 
<LI>A buffer for the record ID of the intermediary that ASDSP returns to the <A NAME=MARKER-2-217></A>recipient if an intermediary is found in the credentials. You pass a pointer to this buffer as the value of the <CODE>intermediary</CODE> parameter. An intermediary is a proxy that has used the <CODE>AuthTradeProxyForCredentials</CODE> function to obtain the credentials used in the authentication process. See the chapter "Authentication Manager" in <I>Inside Macintosh: AOCE Application Programming Interfaces</I> for a discussion of the use of an intermediary and the <CODE>AuthTradeProxyForCredentials</CODE> function and for a description of how to create a maximum-size record ID structure that is large enough to hold any record ID.<P>
</UL>
<LI>Call the<A NAME=MARKER-9-264></A> <CODE>sdspOpen</CODE> routine to open a secure connection. To call the <CODE>sdspOpen</CODE> routine, you call the Device Manager's <CODE>PBControl</CODE> function and specify <CODE>sdspOpen</CODE> as the value of the <CODE>csCode</CODE> parameter. The parameter block for the <CODE>sdspOpen</CODE> routine includes fields also used for the standard <CODE>dspOpen</CODE> routine. In addition to these parameters, you specify parameters used in the authentication process to establish <BR>the secure connection. <P>
A recipient end of a connection can be either a connection listener that listens for connection requests and passes them on to a connection server or a socket that waits passively to receive a connection request. <P>
If the recipient is a <A NAME=MARKER-2-219></A>connection listener, it calls the <CODE>sdspOpen</CODE> routine with a <BR>value of <CODE>ocAccept</CODE> for the <CODE>ocMode</CODE> parameter. The connection server accepts <BR>and acknowledges receipt of a connection request. When you call the <CODE>sdspOpen</CODE> routine, you must provide the values returned by the <A NAME=MARKER-2-80></A><CODE>dspCLListen</CODE> routine <BR>for the <CODE>remoteCID</CODE>, <CODE>remoteAddress</CODE>, <CODE>sendSeq</CODE>, <CODE>sendWindow</CODE>, and <CODE>attnSendSeq</CODE> parameters. You can poll the <CODE>state</CODE> field in the CCB to determine when the connection is open. Alternatively, you can check the result code for the <CODE>sdspOpen</CODE> routine when the routine completes execution. If the routine returns the <CODE>noErr</CODE> <BR>result code, then the connection is open.<P>
If the recipient is a connection end associated with a passive socket that calls the <CODE>sdspOpen</CODE> routine with a value of <CODE>ocPassive</CODE> for the <CODE>ocMode</CODE> parameter, use the <CODE>ocPassive</CODE> mode when you expect to receive an open-connection request from a remote socket. You can specify a value for the <CODE>filterAddress</CODE> parameter to restrict the network number, node ID, or socket number from which you will accept an open-connection request. <P>
You can poll the state field in the CCB to determine when the connection end is waiting to receive an open-connection request, when the connection end is waiting to receive an acknowledgment of an open-connection request, and when the connection is open. See the section <A HREF=Networking-117.html#MARKER-9-232>"The ADSP Connection Control Block Record" beginning on page 5-35</A> for a description of the CCB fields. Alternatively, you can check the result code for the <CODE>dspOpen</CODE> routine when the routine completes execution. If the routine returns the <CODE>noErr</CODE> result code, then the connection is open.<P>
In addition to the standard ADSP parameters required for a <CODE>dspOpen</CODE> call, the recipient supplies the following input values to the <CODE>sdspOpen</CODE> call:
<TABLE BORDER="0" CELLPADDING=3><TH ALIGN=LEFT>&nbsp;<TH>Parameter<TH>Value<TR>
<TD>&nbsp;<TD>sessionKey<TD>A pointer to a data structure of type <CODE>AuthKey</CODE>, which you allocated. ASDSP copies the session key into this buffer if <BR>an authenticated connection was successfully opened.<TR>
<TD>&nbsp;<TD>workspace<TD>A pointer to the workspace buffer that you allocated, which is for ASDSP's internal use.<TR>
<TD>&nbsp;<TD>recipient<TD>The identity of the recipient.<TR>
<TD colspan=3>&nbsp;<TR>
<TD>&nbsp;<TD>initiator<TD>A pointer to a maximum-size record ID. ASDSP copies the initiator's record ID into this structure if an authenticated connection was successfully opened.<TR>
<TD>&nbsp;<TD>intermediary<TD>A pointer to a maximum-size record ID. ASDSP copies the intermediary's record ID into this structure if an authenticated connection was successfully opened and an intermediary was used to obtain the credentials used to authenticate the call.</TABLE>
<P>
If a secure connection was successfully opened, ASDSP returns the following values:
<TABLE BORDER="0" CELLPADDING=3><TH ALIGN=LEFT>&nbsp;<TH>Parameter<TH>Value<TR>
<TD>&nbsp;<TD>issueTime<TD>The time when the credentials were issued. ASDSP copies this value from the credentials.<TR>
<TD>&nbsp;<TD>expiry<TD>The time when the credentials expire. ASDSP copies this value from the credentials.<TR>
<TD>&nbsp;<TD>sessionKey<TD>The encryption key for the session. ASDSP copies this value from the credentials.<TR>
<TD>&nbsp;<TD>initiator<TD>A pointer to a maximum-size record ID structure. If an authenticated connection was successfully opened, this structure holds the initiator's record ID.<TR>
<TD>&nbsp;<TD>hasIntermediary<TD>A flag that is set to <CODE>TRUE</CODE> if an intermediary was used to obtain the credentials.<TR>
<TD>&nbsp;<TD>intermediary<TD>A pointer to a maximum-size record ID. If an authentication connection was successfully opened and an intermediary was used to obtain the credentials, this structure holds the intermediary's record ID.</TABLE>
 <P>
</OL>
<A NAME=HEADING114-43></A>
<H3>Sending <A NAME=MARKER-2-100></A>Encrypted Data Across a Secure Connection</H3>
 <A NAME=MARKER-2-101></A>After a secure connection is established, both ends can send encrypted data over the session. ASDSP client applications use the <CODE>dspWrite</CODE> routine to send data, encrypted <BR>or not, over a secure connection. You can turn the encryption feature on or off on a message-by-message basis by setting one flag to direct ASDSP to encrypt the data and setting another flag to terminate the message. <P>
 To set these flags, you use the bits of the end-of-message (<CODE>eom</CODE>) field; this field is part of the <CODE>ioParams</CODE> variant record of the DSP parameter block that you pass to the <CODE>dspWrite</CODE> routine. For secure connections, the <CODE>eom</CODE> field comprises these two single-bit flags instead of a zero-nonzero byte. You can use the <CODE>dspEncryptMask</CODE> and <CODE>dspEOMMask</CODE> masks to set these flags, or you can use the <CODE>dspEncryptBit</CODE> or <CODE>dspEOMBit</CODE> constant. <P>
<DL>
<DT><B>Note</B>
<DD>Apart from the <CODE>dspWrite</CODE> routine's <CODE>eom</CODE> parameter, the interface to ADSP remains unchanged in regard to encryption.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
 The encryption process is transparent to the client application that receives the data; ASDSP determines if the received information is encrypted, and, if so, it decrypts the byte stream before copying the data to the read buffer specified by the <CODE>dspRead</CODE> routine. <P>
 To write data that ASDSP encrypts and then transmits or to terminate data encryption, you call the <CODE>dspWrite</CODE> routine using the Device Manager's <CODE>PBControl</CODE> function.<P>
<UL>
<LI><A NAME=MARKER-2-223></A>Set the encrypt bit of the <CODE>eom</CODE> field (bit 1) of the DSP parameter block. To set the encrypt bit, you use the <CODE>dspEncryptMask</CODE> <A NAME=MARKER-9-57></A>mask or the <CODE>dspEncryptBit</CODE> constant. Note that ASDSP checks this flag on the first write of the connection or the first write following a write for which the end-of-message flag (bit 0 of the <CODE>eom</CODE> field) is set. 
<LI>Set the end-of-message bit (bit 0) of the <CODE>eom</CODE> field to terminate the encrypted message. To set the end-of-message bit, you use the <CODE>dspEOMMask</CODE> mask or the <CODE>dspEOMBit</CODE> constant.<P>
</UL>
 If you want to <A NAME=MARKER-2-170></A>encrypt all messages, you can simply set the encrypt bit on all <BR><CODE>dspWrite</CODE> <A NAME=MARKER-2-211></A>calls<A NAME=MARKER-2-227></A>.<P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Networking-113.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-115.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Networking-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
