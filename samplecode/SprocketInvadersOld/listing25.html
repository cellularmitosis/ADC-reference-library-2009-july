<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>SprocketInvadersOld - /Source/NetSprocketSupport.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxGames-date.html">Games</a> &gt; <A HREF="javascript:location.replace('index.html');">SprocketInvadersOld</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Games/index.html" target="_blank">Reference Library > Games</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">SprocketInvadersOld</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/Source/NetSprocketSupport.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/Resources/Art.r</option>
<option value="listing2.html">/Source/AboutBox.c</option>
<option value="listing3.html">/Source/AboutBox.h</option>
<option value="listing4.html">/Source/Blitter.c</option>
<option value="listing5.html">/Source/Blitter.h</option>
<option value="listing6.html">/Source/CD_Utils.c</option>
<option value="listing7.html">/Source/CD_Utils.h</option>
<option value="listing8.html">/Source/CommonStuff.c</option>
<option value="listing9.html">/Source/CommonStuff.h</option>
<option value="listing10.html">/Source/ErrorHandler.c</option>
<option value="listing11.html">/Source/ErrorHandler.h</option>
<option value="listing12.html">/Source/EventHandler.c</option>
<option value="listing13.html">/Source/EventHandler.h</option>
<option value="listing14.html">/Source/GameObject.c</option>
<option value="listing15.html">/Source/GameObject.h</option>
<option value="listing16.html">/Source/Graphics.c</option>
<option value="listing17.html">/Source/Graphics.h</option>
<option value="listing18.html">/Source/main.c</option>
<option value="listing19.html">/Source/MemoryHandler.c</option>
<option value="listing20.html">/Source/MemoryHandler.h</option>
<option value="listing21.html">/Source/MenuHandler.c</option>
<option value="listing22.html">/Source/MenuHandler.h</option>
<option value="listing23.html">/Source/MoviePlayback.c</option>
<option value="listing24.html">/Source/MoviePlayback.h</option>
<option value="listing25.html">/Source/NetSprocketSupport.c</option>
<option value="listing26.html">/Source/NetSprocketSupport.h</option>
<option value="listing27.html">/Source/ObjectActions.c</option>
<option value="listing28.html">/Source/ObjectActions.h</option>
<option value="listing29.html">/Source/Particles.c</option>
<option value="listing30.html">/Source/Particles.h</option>
<option value="listing31.html">/Source/SIResources.h</option>
<option value="listing32.html">/Source/SIâ€¢Prefix.h</option>
<option value="listing33.html">/Source/SoundHandler.c</option>
<option value="listing34.html">/Source/SoundHandler.h</option>
<option value="listing35.html">/Source/SpaceInvaders.c</option>
<option value="listing36.html">/Source/Sprite.c</option>
<option value="listing37.html">/Source/Sprite.h</option>
<option value="listing38.html">/Source/SprocketInvaders.c</option>
<option value="listing39.html">/Source/SprocketInvaders.h</option></select>
				</p>
				</form>
				<p><strong><a href="SprocketInvadersOld.zip">Download Sample</a></strong> (&#147;SprocketInvadersOld.zip&#148;, 178.4K)<BR>
<strong><a href="SprocketInvadersOld.dmg">Download Sample</a></strong> (&#147;SprocketInvadersOld.dmg&#148;, 235.8K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*  File:    NetSprocketSupport.c  Contains:  xxx put contents here xxx  Version:  xxx put version here xxx  Copyright:  &copy; 1999 by Apple Computer, Inc., all rights reserved.  File Ownership:    DRI:        xxx put dri here xxx    Other Contact:    xxx put other contact here xxx    Technology:      xxx put technology here xxx  Writers:    (cjd)  Chris De Salvo  Change History (most recent first):     &lt;SP7&gt;    3/3/99  cjd    Updated chat window UI code*///*  ------------------------------------------------------------------------------------------  *//*//*  Copyright &copy; 1996 Apple Computer, Inc., All Rights Reserved//*//*//*    You may incorporate this sample code into your applications without//*    restriction, though the sample code has been provided &quot;AS IS&quot; and the//*    responsibility for its operation is 100% yours.  However, what you are//*    not permitted to do is to redistribute the source as &quot;DSC Sample Code&quot;//*    after having made changes. If you're going to re-distribute the source,//*    we require that you make it clear in the source that the code was//*    descended from Apple Sample Code, but that you've made changes.//*//*    Authors://*      Jamie Osborne//*//*  ------------------------------------------------------------------------------------------  *//*  ------------------------------  Includes#include &lt;ControlDefinitions.h&gt;#include &lt;Dialogs.h&gt;#include &lt;Fonts.h&gt;#include &lt;Lists.h&gt;#include &lt;QDOffScreen.h&gt;#include &lt;Resources.h&gt;#include &lt;Sound.h&gt;#include &lt;TextEdit.h&gt;#include &lt;TextUtils.h&gt;#include &quot;CommonStuff.h&quot;#include &quot;EventHandler.h&quot;#include &quot;NetSprocketSupport.h&quot;//*  ------------------------------  Private Definitions//*  ------------------------------  Private Typesenum{  kWaitForPlayersDialogID = 1000};enum{  kOKButton = 1,   kCancelButton,  kPlayerListLabel,  kPlayerList,  kChatWindow,  kChatTextEntry,  kStatus};    typedef struct DialogInfo{  ListHandle  playerList;  TEHandle  teHandle;  Str32    nameListBuffer[kMaxPlayers];} DialogInfo;//*  ------------------------------  Private Variables//*  ------------------------------  Private Functionsstatic void GetChooserName(Str255 name);static void SendChatText(StringPtr inText, NSpPlayerID inTo);static void DoHandleMessage(NSpMessageHeader *inMessage);static pascal void PlayerListProc(WindowPtr dialog, SInt16 itemNo);static pascal void ChatViewProc(WindowPtr dialog, SInt16 itemNo);static void SetDialogtemUserProc(DialogPtr dialog, SInt16 item, UserItemUPP theProc);static void WatchForPlayers(DialogPtr dialog);static OSStatus SendWelcomeMessage(NSpPlayerID inID);static void MakePlayerList(DialogPtr dialog);static void SendText(DialogPtr dialog);static pascal Boolean DialogEventFilter(DialogPtr dialog, EventRecord *event, SInt16 *itemHit);static void DoHandleChatTextMessage(ChatTextMessage *inMessage, DialogPtr dialog);static void PrintPlayerText(StringPtr inText, NSpPlayerID inPlayer, TEHandle inTEHandle);static void DoHandlePlayerInput(PlayerInputMessage *inMessage);static void DoHandleEndGameMessage(void);static void DoHandleStartGame(StartGameMessage *inMessage);static void DisableDialogItem(DialogPtr theDialog, SInt16 theItem);//*  ------------------------------  Public VariablesNSpGameReference  gNetGame = NULL;Boolean        gIAmHost = false;Str31        kNetworkGameName = &quot;\pNetSprocket Game&quot;;Str31        kJoinDialogLabel = &quot;\pChoose a Game:&quot;;Str31         kNBPType = &quot;\pInvd&quot;;    // This should be the same as kGameIDNetworkState    gNetState;Str31        kSeparatorString = &quot;\p: &quot;;SInt8        kReturn = '\r';Boolean        gGotEndGameMessage = false;Boolean        gReceivedInput;Boolean        gNetSprocketPresent;#pragma mark === Utility functions ===//*  --------------------  NetSprocketPresent//*//*  returns TRUE if networking is present, FALSE otherwiseBooleanNetSprocketPresent(void){  return (NSpInitialize != nil);}//*  --------------------  GetChooserNamestatic voidGetChooserName(Str255 name){StringHandle  userName;    userName = GetString(-16096);  FAIL_NIL(userName, &quot;GetString for Chooser Name failed&quot;);    CopyPStr(*userName, name);  ReleaseResource ((Handle) userName);error:  return;}#pragma mark === Networking stuff ===//*  --------------------  InitNetworkingBooleanInitNetworking(void){OSStatus  status;    if (! NetSprocketPresent())    return (false);      //*  Initialize NetSprocket  status = NSpInitialize(kStandardMessageSize, kBufferSize, kQElements, kGameID, kTimeout);  FAIL_OSSTATUS(status, &quot;NSpInitialize failed&quot;);  if (status != noErr)    return (false);  gNetState = kSlacking;    return (true);  error:  return (false);}//*  --------------------  ShutdownNetworkingvoidShutdownNetworking(void){OSStatus  status;    if (gNetGame)    status = NSpGame_Dispose( gNetGame, kNSpGameFlag_ForceTerminateGame );  gNetState = kSlacking;  gNetGame = NULL;}//*  --------------------  DoHostGame//*//*  Returns TRUE if the user says OK (and NetSprocket doesn't return an error), false otherwiseBooleanDoHostGame(void){OSStatus          status = noErr;NSpProtocolListReference  theList = NULL;Str31            playerName, gameName, password;Boolean           OKHit;    status = NSpProtocolList_New(NULL, &amp;theList);  FAIL_OSSTATUS(status, &quot;Couldn't create a protocol list&quot;);      //  Do the host dialog  GetChooserName(playerName);  CopyPStr(kNetworkGameName, gameName);  password[0] = 0;  OKHit = NSpDoModalHostDialog(theList, gameName, playerName, password, NULL);  if (!OKHit)    return (false);      //  Now host the game  status = NSpGame_Host(&amp;gNetGame, theList, kMaxPlayers, gameName,        password, playerName, 0, kNSpClientServer, 0);  FAIL_OSSTATUS(status, &quot;NSpGame_Host returned an error&quot;);    NSpProtocolList_Dispose(theList);  gIAmHost = true;  gNetState = kHosting;    // let all the players join  OKHit = WaitForAllPlayers();  if (OKHit == false)  {    ShutdownNetworking();    return (false);      }  else  {    gNetState = kStarting;    SendStartGame();  }    return (true);  error:  if (theList)    NSpProtocolList_Dispose(theList);      return (false);}//*  --------------------  DoJoinGame//*//*  Returns TRUE if the user says OK (and NetSprocket doesn't return an error), false otherwiseBooleanDoJoinGame(void){NSpAddressReference  theAddress;Str31        name;Str31        password;OSStatus      status;Boolean       OKHit = true;    GetChooserName(name);  password[0] = 0;    gIAmHost = false;    theAddress = NSpDoModalJoinDialog(kNBPType, kJoinDialogLabel, name, password, NULL);  if (theAddress == NULL)    // The user cancelled    return (false);      status = NSpGame_Join(&amp;gNetGame, theAddress, name, password, 0, NULL, 0, 0);  FAIL_OSSTATUS(status, &quot;NSpGame_Join returned an error&quot;);    gNetState = kJoining;  OKHit = WaitForAllPlayers();  if (OKHit == false)  {    gNetState = kSlacking;    ShutdownNetworking();  }    return OKHit;  error:  return (false);}//*  --------------------  HandleNetworkingvoidHandleNetworking(void){NSpMessageHeader  *theMessage;    if (gNetGame == NULL)    return;  theMessage = NSpMessage_Get(gNetGame);  if (theMessage != NULL)  {    DoHandleMessage(theMessage);    NSpMessage_Release(gNetGame, theMessage);  }}//*  --------------------  DoHandleMessagestatic voidDoHandleMessage(NSpMessageHeader *inMessage){  switch (inMessage-&gt;what)  {    case kNSpPlayerJoined:      break;          case kNSpPlayerLeft:      break;          case kChatTextMessage:      DoHandleChatTextMessage((ChatTextMessage *)inMessage, nil);      break;          case kStartGameMessage:      DoHandleStartGame((StartGameMessage *) inMessage);      break;          case kInputMessage:      DoHandlePlayerInput((PlayerInputMessage *) inMessage);      break;          case kEndGameMessage:      DoHandleEndGameMessage();      break;          default:      break;  }}//*  --------------------  WatchForPlayersstatic voidWatchForPlayers(DialogPtr dialog){NSpMessageHeader  *theMessage;    if (gNetGame == NULL)    return;  while ((theMessage = NSpMessage_Get(gNetGame)) != NULL)  {    if (theMessage-&gt;what == kNSpPlayerJoined)    {      if (gNetState == kHosting)        SendWelcomeMessage(((NSpPlayerJoinedMessage *) theMessage)-&gt;playerInfo.id);            MakePlayerList(dialog);      }    else if (theMessage-&gt;what == kNSpPlayerLeft)     {      MakePlayerList(dialog);      }    else if (theMessage-&gt;what == kChatTextMessage)    {      DoHandleChatTextMessage((ChatTextMessage *)theMessage, dialog);    }    else    {      DoHandleMessage(theMessage);    }          NSpMessage_Release(gNetGame, theMessage);  }}//*  --------------------  SendWelcomeMessagestatic OSStatusSendWelcomeMessage(NSpPlayerID inID){#pragma unused (inID)OSStatus  status = noErr;    return (status);}#pragma mark === Dialog Manager Cruft//*  --------------------  SetDialogtemUserProcstatic voidSetDialogtemUserProc(DialogPtr dialog, SInt16 item, UserItemUPP theProc){Rect   r;SInt16  itemType;Handle  itemH;  GetDialogItem(dialog, item, &amp;itemType, &amp;itemH, &amp;r);  itemH = (Handle) theProc;  SetDialogItem(dialog, item, itemType, itemH, &amp;r);}//*  --------------------  MakePlayerListstatic voidMakePlayerList(DialogPtr dialog){SInt16          i;Cell          theCell;NSpPlayerEnumerationPtr  players;OSStatus        status;DialogInfo        *theInfo = (DialogInfo *) GetWRefCon(dialog);ListHandle        theList = theInfo-&gt;playerList;  LSetDrawingMode(true, theList);              // turn on updating  status = NSpPlayer_GetEnumeration(gNetGame, &amp;players);  FAIL_OSSTATUS(status, &quot;NSpPlayer_GetEnumeration returned an error&quot;);      for (i = 0; i &lt; players-&gt;count; i++)    CopyPStr(players-&gt;playerInfo[i]-&gt;name, theInfo-&gt;nameListBuffer[i]);  /* DELETE ALL EXISTING ROWS IN LIST */  LDelRow(0, 0, theList);  /* ADD NAMES TO LIST */  if (players-&gt;count &gt; 0)    LAddRow(players-&gt;count, 0, theList);    // create rows  for (i = 0; i &lt; players-&gt;count; i++)  {    theCell.h = 0;    theCell.v = i;    LSetCell(&amp;theInfo-&gt;nameListBuffer[i][1], theInfo-&gt;nameListBuffer[i][0], theCell, theList);  }  NSpPlayer_ReleaseEnumeration(gNetGame, players);  error:  return;}//*  --------------------  WaitForAllPlayersBooleanWaitForAllPlayers(void){DialogPtr    theDialog = GetNewDialog(kWaitForPlayersDialogID, NULL, (WindowPtr) -1);ListHandle    playerList;SInt16       itemHit;Boolean     okHit = false;Rect       r, dataBounds = {0,0,0,1};Point      cellSize = {0,0};SInt16      itemType;Handle      itemH;DialogInfo    info;TextStyle    theStyle;ControlHandle  theControl;    ModalFilterUPP theFilter = NewModalFilterProc(DialogEventFilter);  UserItemUPP playerListProc = NewUserItemProc(PlayerListProc);  UserItemUPP chatViewProc = NewUserItemProc(ChatViewProc);    // NOTE: check okUserItemProcUPP != NULL    if (theDialog == NULL)    return (false);    SetPort(theDialog);  SetDialogDefaultItem(theDialog, kOKButton);  SetDialogCancelItem(theDialog, kCancelButton);  SetDialogtemUserProc(theDialog, kPlayerList, playerListProc);  SetDialogtemUserProc(theDialog, kChatWindow, chatViewProc);  (void) GetDialogItemAsControl(theDialog, kChatTextEntry, &amp;theControl);  (void) SetKeyboardFocus(theDialog, theControl, kControlLabelPart);  //  Now create the list of players  GetDialogItem(theDialog, kPlayerList, &amp;itemType, &amp;itemH, &amp;r);  r.right -= 15;    playerList = LNew(&amp;r, &amp;dataBounds, cellSize, 0, theDialog, true,          false, false, true);    info.playerList = playerList;  //  Set up the text edut stuff  GetDialogItem(theDialog, kChatWindow, &amp;itemType, &amp;itemH, &amp;r);  InsetRect(&amp;r, 2, 2);    info.teHandle = TEStyleNew(&amp;r, &amp;r);  TEAutoView(true, info.teHandle);  //  Set up the default drawing info  theStyle.tsFont = kFontIDMonaco;  theStyle.tsSize = 9;  theStyle.tsColor.red = 0;  theStyle.tsColor.green = 0;  theStyle.tsColor.blue = 0;  theStyle.tsFace = normal;  TESetStyle(doAll, &amp;theStyle, true, info.teHandle);    //  If we're the joiner, disable the OK button  if (gNetState == kJoining)    DisableDialogItem(theDialog, kOKButton);    //  Save our custom stuff in the refcon  SetWRefCon(theDialog, (SInt32) &amp;info);    ShowWindow(theDialog);  DrawControls(theDialog);      do  {    ModalDialog(theFilter, &amp;itemHit);  } while (itemHit != kOKButton &amp;&amp; itemHit != kCancelButton);    LDispose(playerList);  DisposeDialog(theDialog);    DisposeRoutineDescriptor(theFilter);  DisposeRoutineDescriptor(playerListProc);  DisposeRoutineDescriptor(chatViewProc);    okHit = (itemHit == kOKButton || gNetState == kRunning);  return (okHit);}//*  --------------------  DisableDialogItemstatic voidDisableDialogItem(DialogPtr theDialog, SInt16 theItem){SInt16  theType;Rect  theRect;Handle  theHandle;  if (! theDialog)    return;  GetDialogItem(theDialog, theItem, &amp;theType, &amp;theHandle, &amp;theRect);  if (! theHandle)    return;  HiliteControl((ControlHandle) theHandle, 255);  theType |= kItemDisableBit;  SetDialogItem(theDialog, theItem, theType, theHandle, &amp;theRect);}#pragma mark === Callback Procs ===//*  --------------------  PlayerListProcstatic pascal voidPlayerListProc(WindowPtr dialog, SInt16 itemNo){Rect     r;SInt16    itemType;Handle    item;GrafPtr    theWindow = (GrafPtr) dialog;DialogInfo  *theInfo = (DialogInfo *)GetWRefCon(dialog);ListHandle  list = theInfo-&gt;playerList;  if (itemNo == kPlayerList)  {      GetDialogItem(dialog, itemNo, &amp;itemType, &amp;item, &amp;r);    InsetRect(&amp;r, -1, -1);    FrameRect(&amp;r);    LUpdate(theWindow-&gt;visRgn, list);  }}//*  --------------------  ChatViewProcstatic pascal voidChatViewProc(WindowPtr dialog, SInt16 itemNo){Rect     r;SInt16    itemType;Handle    item;DialogInfo *theInfo;    GetDialogItem(dialog, itemNo, &amp;itemType, &amp;item, &amp;r);  theInfo = (DialogInfo *)GetWRefCon(dialog);  FrameRect(&amp;r);  InsetRect(&amp;r, 2, 2);  TEUpdate(&amp;r, theInfo-&gt;teHandle);  }//*  --------------------  DialogEventFilterstatic pascal BooleanDialogEventFilter(DialogPtr dialog, EventRecord *event, SInt16 *itemHit){OSErr        err;CGrafPtr      oldPort;GDHandle      oldGD;WindowRef      window;ModalFilterUPP    modalProc;Rect        itemRect;SInt16        key;SInt16        thePart;Boolean        accepted = false;Point theP;Boolean        hit;DialogInfo      *theInfo;    GetGWorld(&amp;oldPort, &amp;oldGD);  SetGWorld((CGrafPtr)dialog, nil);  IdleControls(dialog);  WatchForPlayers(dialog);  if (gNetState == kRunning)  {    *itemHit = kOKButton;    return (true);  }  switch(event-&gt;what)   {    case keyDown:    case autoKey:      key = event-&gt;message &amp; charCodeMask;      if (key == 0x0D)      {        SendText(dialog);        accepted = true;      }      else if (key == '\t')      {        if (event-&gt;modifiers &amp; shiftKey)          ReverseKeyboardFocus(dialog);        else          AdvanceKeyboardFocus(dialog);      }      else      {        accepted = false;      }              break;      case updateEvt:      if (event-&gt;message == (SInt32)dialog)       {        // in case a screen saver activates.        UpdateDialog(dialog, dialog-&gt;visRgn);        SetCursor(&amp;qd.arrow);      }        break;    case activateEvt:      accepted = true;      break;          case mouseDown:        thePart = FindWindow(event-&gt;where,&amp;window);        switch (thePart)       {        case inContent:          theP = event-&gt;where;          GlobalToLocal(&amp;theP);          theInfo = (DialogInfo *)GetWRefCon(dialog);          itemRect = (*theInfo-&gt;playerList)-&gt;rView;                          // add the scroll bar back in for hit testing (remember we took it out earlier)                itemRect.right += 16;                                // See if they clicked in our list!                if (PtInRect(theP, &amp;itemRect))                {                    hit = LClick(theP, nil, theInfo-&gt;playerList);                    // if they double-clicked the list, return 1, as if the OK button had been pressed                    if (hit)                        *itemHit = kOKButton;                    else                        *itemHit = kPlayerList;                                        // tell the Dialog Manager that we handled this click, it can stop searching for a click-owner                    accepted = true;                }          break;          case inSysWindow:          SysBeep(30);          break;          case inDrag:          if (window == dialog)           {            DragWindow(dialog, event-&gt;where,&amp;qd.screenBits.bounds);            accepted = true;          }          break;      }      break;      }    if (false == accepted)   {    err = GetStdFilterProc(&amp;modalProc);      if (err == noErr)        accepted = CallModalFilterProc(modalProc, dialog, event, itemHit);  }    SetGWorld(oldPort, oldGD);  return (accepted);}//*  --------------------  SendTextstatic voidSendText(DialogPtr dialog){ControlHandle  item;Str255      theText;    (void) GetDialogItemAsControl(dialog, kChatTextEntry, &amp;item);  GetDialogItemText((Handle) item, theText);  SetDialogItemText((Handle) item, &quot;\p&quot;);  DrawOneControl(item);    if (theText[0] &gt; 0)    SendChatText(theText, kNSpAllPlayers);}#pragma mark =====//*  --------------------  SendChatTextstatic voidSendChatText(StringPtr inText, NSpPlayerID inTo){ChatTextMessage  theMessage;OSStatus     status;    theMessage.h.to = inTo;  theMessage.h.what = kChatTextMessage;  theMessage.h.messageLen = sizeof(ChatTextMessage);  CopyPStr(inText, theMessage.text);    status = NSpMessage_Send(gNetGame, &amp;theMessage.h, kNSpSendFlag_Junk | kNSpSendFlag_SelfSend);}//*  --------------------  SendStartGamevoidSendStartGame(void){StartGameMessage  theMessage;OSStatus      status;    NSpClearMessageHeader(&amp;theMessage.h);  theMessage.h.to = kNSpAllPlayers;  theMessage.h.what = kStartGameMessage;  theMessage.h.messageLen = sizeof(StartGameMessage);  theMessage.seed = qd.randSeed;    status = NSpMessage_Send(gNetGame, &amp;theMessage.h, kNSpSendFlag_Registered | kNSpSendFlag_SelfSend);}//*  --------------------  SendInputStatevoidSendInputState(Boolean left, Boolean right, Boolean fire){PlayerInputMessage  theMessage;OSStatus  status;    NSpClearMessageHeader(&amp;theMessage.h);  theMessage.h.to = kNSpAllPlayers;  theMessage.h.what = kInputMessage;  theMessage.h.messageLen = sizeof(PlayerInputMessage);  theMessage.left = left;  theMessage.right = right;  theMessage.fire = fire;  status = NSpMessage_Send(gNetGame, &amp;theMessage.h, kNSpSendFlag_Registered);}//*  --------------------  SendEndGamevoidSendEndGame(void){OSStatus  status;NSpMessageHeader theMessage;    NSpClearMessageHeader(&amp;theMessage);  theMessage.to = kNSpAllPlayers;  theMessage.what = kEndGameMessage;  theMessage.messageLen = sizeof(NSpMessageHeader);    status = NSpMessage_Send(gNetGame, &amp;theMessage, kNSpSendFlag_Registered);}//*  --------------------  DoHandleChatTextMessagestatic voidDoHandleChatTextMessage(ChatTextMessage *inMessage, DialogPtr dialog){DialogInfo  *theInfo;    if (! dialog)    return;      theInfo = (DialogInfo *)GetWRefCon(dialog);  PrintPlayerText(inMessage-&gt;text, inMessage-&gt;h.from, theInfo-&gt;teHandle);}//*  --------------------  DoHandleStartGamestatic voidDoHandleStartGame(StartGameMessage *inMessage){  gNetState = kRunning;  qd.randSeed = inMessage-&gt;seed;}//*  --------------------  DoHandlePlayerInputstatic voidDoHandlePlayerInput(PlayerInputMessage *inMessage){  if (gIAmHost)  {    gGameKeys.redLeft = inMessage-&gt;left;    gGameKeys.redRight = inMessage-&gt;right;    gGameKeys.redFire = inMessage-&gt;fire;  }  else  {    gGameKeys.greenLeft = inMessage-&gt;left;    gGameKeys.greenRight = inMessage-&gt;right;    gGameKeys.greenFire = inMessage-&gt;fire;  }    gReceivedInput = true;}//*  --------------------  DoHandleEndGameMessagestatic voidDoHandleEndGameMessage(void){  gGotEndGameMessage = true;}//*  --------------------  PrintPlayerTextstatic voidPrintPlayerText(StringPtr inText, NSpPlayerID inPlayer, TEHandle inTEHandle){NSpPlayerInfoPtr  info;    NSpPlayer_GetInfo(gNetGame, inPlayer, &amp;info);    TEInsert(&amp;info-&gt;name[1], info-&gt;name[0], inTEHandle);  TEInsert(&amp;kSeparatorString[1], kSeparatorString[0], inTEHandle);  TEInsert(&amp;inText[1], inText[0], inTEHandle);  TEInsert(&amp;kReturn, 1, inTEHandle);  //*  Select end of the TE text  TESetSelect(32767L, 32767L, inTEHandle);  //*  Scroll it into view if necessary  TESelView(inTEHandle);}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/SprocketInvadersOld/listing25.html%3Fid%3DDTS10000061-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/SprocketInvadersOld/listing25.html%3Fid%3DDTS10000061-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/SprocketInvadersOld/listing25.html%3Fid%3DDTS10000061-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>