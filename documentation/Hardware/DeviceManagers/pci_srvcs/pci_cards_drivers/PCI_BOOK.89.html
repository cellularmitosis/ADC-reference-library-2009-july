<HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><script language="JavaScript" src="frametest.js"></script><TITLE> Matching Drivers With Devices</TITLE></HEAD><BODY BGCOLOR="#ffffff"><DIV><a name="top"></a><!-- start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!-- start of path --><font face="Geneva,Helvetica,Arial" size="1"><b><br>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Documentation</a> &gt; <!-- a href="" target="_top" -->Hardware<!-- /a -->  <b>&gt; </b><a href="../../devicemgrs.html" target="_top">Device Managers and Drivers</a> <b>&gt; </b><a href="../pci_srvcs.html" target="_top">PCI Card Services</a> <b>&gt; </b>Designing PCI Cards and Drivers for Power Macintosh Computers</font><br><br><!-- end of path --><A HREF="PCI_BOOK.86.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.88.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.8a.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><HR></DIV><H1 CLASS="H1.Heading1"><A NAME="pgfId=3343"> </A><A NAME="28331"> </A>Matching Drivers With Devices</H1><P CLASS="T1.Text1"><A NAME="pgfId=3344"> </A>Mac&nbsp;OS matches drivers to devices by using the following algorithm:</P><UL><LI CLASS="B1.Bullet1"><A NAME="pgfId=3345"> </A>When a device node has a driver in ROM, no driver matching is required. Mac&nbsp;OS uses the driver name and compares the version numbers of ROM-based and disk-based drivers to select the newest version of the driver.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3346"> </A>When a device node has a <TT CLASS="cv">name</TT> property that was supplied by the FCode in a device's expansion ROM, Mac&nbsp;OS checks the name property against all disk-based drivers and finds the first matching driver with the latest version number. If there is no match against the <TT CLASS="cv">name</TT> property, then Mac&nbsp;OS attempts a match against each name string in the device's <A NAME="marker=3347"> </A><TT CLASS="cv">compatible</TT> property. The comparison is always against the <TT CLASS="cv">nameInfoStr</TT> parameter in the driver description structure for each disk-based driver. The first match is used. If no match is found against <TT CLASS="cv">name</TT> or <TT CLASS="cv">compatible</TT> strings, the device is not usable.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3348"> </A>When a device node has no FCode, Mac&nbsp;OS tries to match the device with a driver based on the generated name <TT CLASS="cv">pci</TT><I CLASS="italics">xxxx,yyyy</I> where <I CLASS="italics">xxxx</I> is the vendor ID and <I CLASS="italics">yyyy</I> is the device ID. Both these ID values must be hexadecimal numbers, without leading 0s, that use lower case for the letters A through F and are rendered as ASCII characters. If a match is found, but the first initialization call to the driver fails, then the code that is attempting to use the driver must call the Driver Loader Library's best match routine (again) to find the next-best driver.</LI></UL><DIV><blockquote><p CLASS="NoteHead"><b><A NAME="pgfId=14219"> </A>Note</b></p><P CLASS="Note"><A NAME="pgfId=3349"> </A>Each device node should have just one <TT CLASS="cv">compatible</TT> property, containing one or more C-formatted name strings as its value. The strings must be packed in sequence with no unused bytes between them and should be arranged with the more compatible names first. </P></blockquote><P CLASS="T1.Text1"><A NAME="pgfId=3353"> </A>The DLL routines <TT CLASS="cv">GetDriverForDevice</TT>, <TT CLASS="cv">InstallDriverForDevice</TT>, and <TT CLASS="cv">FindDriversForDevice</TT> use the following algorithm to match or install the &quot;best&quot; driver for a device:</P><OL><LI CLASS="N/.NList=1"><A NAME="pgfId=3354"> </A>Find all candidate drivers for the device. A driver is a candidate if its <TT CLASS="cv">nameInfoStr</TT> value matches either the device's name or one of the names found in the device's <TT CLASS="cv">compatible</TT> property.</LI><LI CLASS="N.NList"><A NAME="pgfId=3355"> </A>Sort this list based on whether the driver matched using the device's name or a compatible name. Those matched with the device name are put at the head of the list. Ties are broken using the driver's version number (See <A HREF="PCI_BOOK.f0.html#41749" CLASS="XRef">HigherDriverVersion</A>.) Pseudo code for file-based driver sorting is shown in <A HREF="PCI_BOOK.89.html#14170" CLASS="XRef">Listing&nbsp;7-1</A>. The code returns 0 if two drivers are equally compatible, a negative number if <TT CLASS="cv">driver1</TT> is less compatible than <TT CLASS="cv">driver2</TT>, and a positive number if <TT CLASS="cv">driver1</TT> is more compatible than <TT CLASS="cv">driver2</TT>.</LI><LI CLASS="N.NList"><A NAME="pgfId=3362"> </A>If not installing the driver, return the driver at the head of the candidate list and discard any remaining candidates.</LI></OL><P CLASS="T1.Text1"><A NAME="pgfId=3363"> </A>If you still have candidates with which to attempt an installation, do the following:</P><OL><LI CLASS="N/.NList=1"><A NAME="pgfId=3364"> </A>Load and install the driver located at the head of the list.</LI><LI CLASS="N.NList"><A NAME="pgfId=3365"> </A>The driver should probe the device, using DSL services, to verify the match. If the driver did not successfully initialize itself, discard it and return to step&nbsp;1.</LI><LI CLASS="N.NList"><A NAME="pgfId=3366"> </A>Discard any remaining candidates.</LI></OL><P CLASS="T1.Text1"><A NAME="pgfId=3367"> </A>The routines that use this algorithm are described in detail in the sections that start with <A HREF="PCI_BOOK.de.html#36554" CLASS="XRef">Loading and Unloading</A>.</P><P CLASS="L.Listing"><B><A NAME="pgfId=3372"> </A>Listing&nbsp;7-1	<A NAME="14170"> </A>File-based driver sorting</B></P><CODE CLASS="CvF.CodeFull"><A NAME="pgfId=14427"> </A>SInt16 CandidateCompareRoutine<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(FileBasedDriverInfoPtr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Driver1,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FileBasedDriverInfoPtr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Driver2,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; StringPtr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CompatibleNames,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ItemCount&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nCompatibleNames)<BR><BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;SInt16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matchResults = 0;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;if ( Driver1 and Driver2 matched using same property (name or compatible))<BR>&nbsp;&nbsp;&nbsp;&nbsp;{<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( both drivers matched using compatible property )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( drivers not matched with identical compatible name )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* Which compatible name (by number) did driver1/driver2 match? */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Driver1CompatibleName = WhichCompatibleName(Driver1,...);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Driver2CompatibleName = WhichCompatibleName(Driver2,...);<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( Driver1CompatibleName != Driver2CompatibleName )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( Driver1CompatibleName &lt; Driver2CompatibleName )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return  1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* driver1 is &quot;more compatible&quot; */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return -1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* driver2 is &quot;more compatible&quot; */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;/* Break tie with version numbers, if possible. */<BR>&nbsp;&nbsp;&nbsp;&nbsp;matchResults = HigherDriverVersion&nbsp;&nbsp;(&amp;Driver1 -&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;info.theType.version, &amp;Driver2 -&gt; info.theType.version);<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;/* Same version number too? */<BR>&nbsp;&nbsp;&nbsp;&nbsp;if ( matchResults == 0 )<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* Final tie breaker is their filenames */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* Reverse the compare with RelString */<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matchResults = RelString &nbsp;&nbsp;&nbsp;(Driver2 -&gt; info.theSpec.name,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Driver1 -&gt; info.theSpec.name, true, true );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;return matchResults;<BR>&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;/* Matched using different property */<BR>&nbsp;&nbsp;&nbsp;&nbsp;if ( Driver1 matched using compatible property )<BR>&nbsp;&nbsp;&nbsp;&nbsp;return -1; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* driver 2 is higher */<BR>&nbsp;&nbsp;&nbsp;&nbsp;return 1; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/* else driver 1 is higher */<BR>}</CODE></DIV><HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 26 March 99)<P><A HREF="PCI_BOOK.86.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.88.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.8a.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>