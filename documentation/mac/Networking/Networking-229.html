<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Routines(IM:N)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING229></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Networking-228.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-230.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Networking-2.html"><B>Networking</B></A> / <BR><DD><A HREF="Networking-223.html"><B>Chapter 9 - AppleTalk Filing Protocol (AFP)</B></A> / <A HREF="Networking-225.html"><B>AFP Reference</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING229-0></A>
<H2>Routines</H2>
 <A NAME=MARKER-2-33></A>The programming interface to AFP is different in form from the programming interfaces to the other AppleTalk protocols described in this book. For AFP, the programming interface consists of a single function, the <A NAME=MARKER-2-34></A><CODE>AFPCommand</CODE> function, which allows you to call AFP and pass it the command code for a particular AFP command. There are four categories or types of commands that you can send to a server: general, login, write, and read. To use the commands that form these categories, in addition to this chapter, you must also refer to the books <I>Inside AppleTalk</I>, second edition, and <I>AppleShare 3.0 Developer's Kit</I> version 3.0.<P>
 The <CODE>AFPCommand</CODE> function requires as a parameter a pointer to an XPP parameter block. This function uses a different parameter block format for each category. You do not specify the command code as a parameter block field value, as you might expect. Instead, as the value of a parameter block field you specify a pointer to a command buffer. You use the command buffer to specify the command code of the AFP command to be sent to <BR>the server.<P>
 Although the <CODE>AFPCommand</CODE> function syntax is the same for all four formats, the fields of the XPP parameter block that are used for each format differ. The <CODE>AFPCommand</CODE> function is defined as follows: <P>
<PRE>
FUNCTION AFPCommand (thePBptr: XPPParmBlkPtr; 
                     async: Boolean): OSErr;
</PRE>
<DL>
<DT><CODE>thePBptr</CODE>
<DD> A pointer to the XPP parameter block format for a particular group of AFP commands.<CODE> </CODE>
<DT><CODE><A NAME=MARKER-2-236></A>async</CODE> 
<DD> A Boolean that specifies whether the function is to execute synchronously or asynchronously. Set the <CODE>async</CODE> parameter to <CODE>TRUE</CODE> to execute the function asynchronously.
</DL>
 This section describes the XPP parameter block format for each category of commands. An arrow preceding a parameter block field indicates whether the field's value is an input parameter, an output parameter, or both:
<TABLE BORDER="0" CELLPADDING=3><TH ALIGN=LEFT>Arrow<TH>Meaning<TR>
<TD>--><TD>Input<TR>
<TD><--<TD>Output<TR>
<TD><-><TD>Both</TABLE>
<P>
 Within the parameter block, you specify a pointer to a command block, the first byte of which contains the command code of the command to be sent to the server. The range <BR>of command codes is 0 through 255, inclusive, although AppleTalk does not currently implement all command codes and some command codes are invalid. <A HREF=#MARKER-9-5>Table 9-1</A> shows the AFP command codes that are implemented in AppleTalk. This table shows the AFP command code constant, the numeric value, and a description of the command. <P>
<DL>
<DT><B>Note</B>
<DD>The following six constants may not be defined in the header files: <CODE>afpGetSrvrMsg</CODE>, <CODE>afpCreateID</CODE>, <CODE>afpDeleteID</CODE>, <CODE>afpResolveID</CODE>, <CODE>afpExchangeFiles</CODE>, and <CODE>afpCatSearch</CODE>. If you use the commands that these constants identify, you must either specify the numeric values for the commands or declare the constants in your application.
<TABLE BORDER="0" CELLPADDING=3>
<CAPTION><A NAME=MARKER-9-5></A>AFP<A NAME=MARKER-2-6></A> command codes </CAPTION>
<TH>AFP<BR>command constant<TH>Command<BR>code<TH>Action<TR>
<TD>afpByteRangeLock<TD> 1<TD>Locks or unlocks a specified range of bytes within an open fork.<TR>
<TD>afpVolClose<TD> 2<TD>Informs the server that the workstation no longer needs the volume.<TR>
<TD>afpDirClose<TD> 3<TD>Closes a directory and invalidates its directory identifier.<TR>
<TD colspan=3>&nbsp;<TR>
<TD>afpForkClose<TD> 4<TD>Closes a fork that was opened <BR>by <CODE>afpOpenFork</CODE>.<TR>
<TD>afpCopyFile<TD> 5<TD>Copies a file from one location to <BR>another on the same file server.<TR>
<TD>afpDirCreate<TD> 6<TD>Creates a new directory.<TR>
<TD>afpFileCreate<TD> 7<TD>Creates a new file.<TR>
<TD>afpDelete<TD> 8<TD>Deletes a file or directory.<TR>
<TD>afpEnumerate<TD> 9<TD>Lists the contents of a directory.<TR>
<TD>afpFlush<TD>10<TD>Writes to a disk any volume data that has been modified.<TR>
<TD>afpForkFlush<TD>11<TD>Writes to a disk any data buffered from previous <CODE>afpWrite</CODE> calls.<TR>
<TD>afpGetForkParms<TD>14<TD>Retrieves parameters for a file associated with a particular open fork.<TR>
<TD>afpGetSInfo<TD>15<TD>Obtains a block of descriptive information from the server, without requiring an <BR>open session. <P>Use the <CODE>ASPGetStatus</CODE> function instead <BR>of this command code. See the chapter "AppleTalk Session Protocol (ASP)" in this book for information on <CODE>ASPGetStatus</CODE>. Making an <CODE>afpGetSInfo</CODE> call using the <CODE>AFPCommand</CODE> results in an error.<TR>
<TD>afpGetSParms<TD>16<TD>Retrieves server parameters.<TR>
<TD>afpGetVolParms<TD>17<TD>Retrieves parameters for a particular volume.<TR>
<TD>afpLogin<TD>18<TD>Establishes an AFP session with a server.<TR>
<TD>afpContLogin<TD>19<TD>Continues the login and user authentication process started by the <CODE>afpLogin</CODE> command.<TR>
<TD>afpLogout<TD>20<TD>Terminates a session with a server.<TR>
<TD>afpMapID<TD>21<TD>Maps a user ID to a user name, or a <BR>group ID to a group name.<TR>
<TD>afpMapName<TD>22<TD>Maps a user name to a user ID, or a group name to a group ID.<TR>
<TD>afpMove<TD>23<TD>Moves a directory or file to another location on the same volume.<TR>
<TD>afpOpenVol<TD>24<TD>Makes a volume available to the workstation.<TR>
<TD>afpOpenDir<TD>25<TD>Opens a directory on a variable directory ID volume and returns its directory ID.<TR>
<TD colspan=3>&nbsp;<TR>
<TD>afpOpenFork<TD>26<TD>Opens the data or resource fork of an existing file to read from it or write to it.<TR>
<TD>afpRead<TD>27<TD>Reads a block of data from an open fork.<TR>
<TD>afpRename<TD>28<TD>Renames a directory or file.<TR>
<TD>afpSetDirParms<TD>29<TD>Sets parameters for a specified directory.<TR>
<TD>afpSetFileParms<TD>30<TD>Sets parameters for a specified file.<TR>
<TD>afpSetForkParms<TD>31<TD>Sets the fork length for a specified open fork.<TR>
<TD>afpSetVolParms<TD>32<TD>Sets the backup date for a specified volume.<TR>
<TD>afpWrite<TD>33<TD>Writes a block of data to an open fork.<TR>
<TD>afpGetFlDrParms<TD>34<TD>Retrieves parameters for either a <BR>file or a directory.<TR>
<TD>afpSetFlDrParms<TD>35<TD>Sets parameters for a file or directory.<TR>
<TD>afpGetSrvrMsg<A HREF="#FOOTNOTE-1">[1]</A><TD>38<TD>Gets a string message from the server, such <BR>as shutdown, user, and login messages.<TR>
<TD>afpCreateID<A HREF=#nonexistent-marker><EM>*</EM></A><TD>39<TD>Creates a unique file ID for a specified file.<TR>
<TD>afpDeleteID<A HREF=#nonexistent-marker><EM>*</EM></A><TD>40<TD>Invalidates all instances of a specified file ID.<TR>
<TD>afpResolveID<A HREF=#nonexistent-marker><EM>*</EM></A><TD>41<TD>Returns parameters for the file referred to <BR>by the specified file ID.<TR>
<TD>afpExchangeFiles<A HREF=#nonexistent-marker><EM>*</EM></A><TD>42<TD>Preserves an existing file ID when an application performs a "Save" or <BR>"Save As" operation.<TR>
<TD>afpCatSearch<A HREF=#nonexistent-marker><EM>*</EM></A><TD>43<TD>Allows an application to efficiently search <BR>an entire volume for files that match <BR>specified criteria.<TR>
<TD>afpDTOpen<TD>48<TD>Opens the Desktop database on a <BR>particular volume.<TR>
<TD>afpDTClose<TD>49<TD>Informs the server that the workstation no longer needs the volume's Desktop database.<TR>
<TD>afpGetIcon<TD>51<TD>Retrieves an icon from the volume's <BR>Desktop database.<TR>
<TD>afpGtIcnInfo<TD>52<TD>Retrieves icon information from the volume's Desktop database.<TR>
<TD>afpAddAPPL<TD>53<TD>Adds an APPL mapping to the <BR>Desktop database.<TR>
<TD>afpRmvAPPL<TD>54<TD>Removes an APPL mapping from the volume's Desktop database.<TR>
<TD colspan=3>&nbsp;<TR>
<TD>afpGetAPPL<TD> 55<TD>Retrieves an APPL mapping from the volume's Desktop database.<TR>
<TD>afpAddCmt<TD> 56<TD>Adds a comment for a file or directory <BR>to the volume's Desktop database.<TR>
<TD>afpRmvCmt<TD> 57<TD>Removes a comment from the volume's Desktop database.<TR>
<TD>afpGetCmt<TD> 58<TD>Retrieves a comment associated with a specified file or directory from the volume's Desktop database.<TR>
<TD>afpAddIcon<TD>192<TD>Adds an icon bitmap to the volume's <BR>Desktop database<A NAME=MARKER-2-5></A>.</TABLE>
<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
 The command block buffer that you provide for each <CODE>AFPCommand</CODE> function contains the command code and the command parameters. The format for the command block differs for each command. <P>
 For a description of the commands and their required command block formats and parameters, see <I>Inside AppleTalk</I>, second edition, and the <I>AppleShare 3.0 Developer's Kit</I> version 3.0 as follows:<P>
<UL>
<LI>For command codes 38 through 43, inclusive, see the <I>AppleShare 3.0 Developer's Kit</I> version 3.0.
<LI>For all other AFP command codes, see <I>Inside AppleTalk,</I> second edition. <P>
</UL>
 The .XPP driver implements most <A NAME=MARKER-2-36></A>AFP commands by mapping the AFP command to an ASP function, without interpreting or verifying the data. The .XPP driver maps AFP commands to ASP functions according to the following conventions:<P>
 AFP commands are mapped to ASP functions, which use the services of ATP to transport data. The following two AFP command codes can send or receive more data than a single eight-packet ATP transaction will support. <P>
<UL>
<LI>The <CODE>afpRead</CODE> command (27) can cause the server to return more data than fits in <BR>eight ATP response packets. (The <CODE>aspQuantumSize</CODE> parameter of the <CODE>ASPGetParms </CODE>function returns the maxi<CODE>mum</CODE> amount of data that you can receive from the server.) The <CODE>afpRead</CODE> command can return up to the number of bytes indicated in the command block's requested count (<CODE>reqCount</CODE>) field. The .XPP driver may issue multiple calls to ASP for this command mapping. 
<LI>The <CODE>afpWrite</CODE> command (33) can pass more data than fits in eight ATP response packets. The <CODE>afpWrite</CODE> command can pass up to the number of bytes indicated in <BR>the command block's requested count (<CODE>reqCount</CODE>) field. The .XPP driver may issue multiple calls to ASP for this command mapping.<A NAME=MARKER-2-37></A> <P>
</UL>
 <A HREF=#MARKER-9-3>Table 9-2</A> summarizes the mapping of AFP commands to ASP functions.
<TABLE BORDER="0" CELLPADDING=3>
<CAPTION><A NAME=MARKER-9-3></A><B>Table 9-2 Mapping of AFP commands to ASP functions</B></CAPTION>
<TH>AFP <BR>command code<TH>ASP function mapping<TR>
<TD>0<TD>Invalid AFP command.<TR>
<TD>1-14, 16, 17, 21-32, 34-190<TD>Mapped to <A NAME=MARKER-2-4></A><CODE>ASPUserCommand</CODE>.<TR>
<TD>15<TD>Mapped to <CODE>ASPGetStatus</CODE>. <P>Use <CODE>ASPGetStatus</CODE> instead of this command code. Making an <CODE>afpGetSInfo</CODE> call using the <CODE>AFPCommand</CODE> function results in <BR>an error.<TR>
<TD>18<TD>Mapped to appropriate login dialog including <CODE>ASPOpenSession</CODE>.<TR>
<TD>19<TD>Mapped to appropriate login dialog.<TR>
<TD>20<TD>Mapped to <CODE>ASPCloseSession</CODE>.<TR>
<TD>33<TD>Mapped to <CODE>ASPUserWrite</CODE>.<TR>
<TD>191<TD>Mapped to <CODE>ASPUserCommand</CODE>. Reserved for developers; <BR>Apple Computer, Inc., will not use this command code.<TR>
<TD>192-253<TD>Mapped to <CODE>ASPUserWrite</CODE>.<TR>
<TD>254<TD>Mapped to <CODE>ASPUserWrite</CODE>. Reserved for developers; <BR>Apple Computer, Inc., will not use this command code.<TR>
<TD>255<TD>Invalid AFP command.</TABLE>
<P>
 <A NAME=MARKER-2-68></A>Before you can call the <CODE>AFPCommand</CODE> function, you must open the .XPP driver. You can use the Device Manager's <CODE>OpenDriver</CODE> function to open the .XPP driver. You should not close the .XPP driver because other applications and processes may be using it. For more information on opening the .XPP driver, see the chapter "AppleTalk Utilities" in this book. The .MPP and .ATP drivers must be open before you open the .XPP driver.<P>
 The chapter "AppleTalk Utilities" also describes how to close the .XPP driver. However, in most circumstances, you should not close the .XPP driver because other applications and processes could be using the protocols implemented by the .XPP driver. <P>
 You must pass the .XPP driver reference number as a parameter to the <CODE>AFPCommand</CODE> function; the MPW interface does not fill in this value. The <CODE>OpenXPP</CODE> function that you use to open the .XPP driver returns the driver reference number in the <CODE>refnum</CODE> field. You can call this function to obtain the .XPP driver's reference number even if the .XPP driver is already open.<P>
 For all <CODE>AFPCommand</CODE> formats, the XPP parameter block includes a <CODE>CCBStart</CODE> field. <BR>The .XPP driver uses the memory at the end of the XPP parameter block defined as <BR>a <CODE>CCBStart</CODE> array as an internal <A NAME=MARKER-2-27></A>command control block (CCB<I>)</I>. To ensure that the function executes successfully, you can specify the maximum size for this array as indicated for the particular function that uses it.<A NAME=MARKER-2-1></A> <P>
<HR>

<A NAME="FOOTNOTE-1">[1] An asterisk (*) marks the constants that may not be defined in the header files. If you use them, you must first declare the constants in your application.



</BLOCKQUOTE>
<HR>
<center>
<A HREF="Networking-228.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-230.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Networking-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
