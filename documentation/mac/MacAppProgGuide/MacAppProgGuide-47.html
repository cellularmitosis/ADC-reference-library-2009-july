<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>MacApp's Idling Mechanism (MacApp PG)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING47></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="MacAppProgGuide-46.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="MacAppProgGuide-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="MacAppProgGuide-158.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="MacAppProgGuide-48.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="MacAppProgGuide-2.html"><B>Programmer's Guide to MacApp</B></A> / <A HREF="MacAppProgGuide-21.html"><B>Part 1 - MacApp Theory and Architecture</B></A><BR><DD><A HREF="MacAppProgGuide-40.html"><B>Chapter 5 - Events and Commands</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING47-0></A>
<H1><A NAME=MARKER-9-59></A><A NAME=MARKER-9-253></A><A NAME=MARKER-2-254></A>MacApp's Idling Mechanism</H1>
 There are many possible uses for idle-time processing, such as displaying a screen saver (perhaps with a password, to protect sensitive data), checking a network connection, or validating entries in a dialog box. MacApp provides a mechanism to parcel out idle time when your program isn't busy. Idle time can be distributed to the Standard Mail Package (if the application uses it), to an attached script, to any event-handler object or behavior object in the target chain, and to any event-handler object or behavior object in a special chain called the cohandler chain.<P>
<A NAME=HEADING47-2></A>
<H2><A NAME=MARKER-9-255></A>The Cohandler Chain</H2>
 The <A NAME=MARKER-2-256></A><B>cohandler chain</B> is a list of event-handler objects (objects based on classes that descend from the <CODE>TEventhandler</CODE> class) pointed to by the application object's <CODE>fHeadCohandler</CODE> field. The cohandler chain can be used to add background or polling tasks to your application. <B>Polling</B> means continually checking to see if an event has happened. A <B>background task</B> is one that continues to operate while another task is primary, such as a printing task that operates while you are actively typing in a word processor. <P>
 A <B>cohandler</B> is an event-handler object that has been installed in the cohandler chain. You install a cohandler by calling <CODE>TApplication</CODE>::<CODE><A NAME=MARKER-2-258></A>InstallCohandler</CODE>, and you use the same method to remove the cohandler when it has finished its task. You set the <CODE>TEventHandler</CODE> field <CODE>fIdleFreq</CODE> of the cohandler to determine how often the cohandler is called. The smaller the value of <CODE>fIdleFreq</CODE>, the more frequently the cohandler is called. A value of 0 indicates that the cohandler should be called as frequently as possible, while a value of <A NAME=MARKER-2-260></A>LONG_MAX (231 - 1, or 2,147,483,647) essentially disables idling.<P>
 For an example of how to implement a cohandler, see <A HREF=MacAppProgGuide-90.html#MARKER-9-37>"Recipe--Ensuring Idle Time for an Event-Handler Object," beginning on page 341</A>.<P>
<A NAME=HEADING47-6></A>
<H2>How Idling Happens</H2>
 The application object periodically calls its <CODE><A NAME=MARKER-9-170></A>PollToolboxEvent</CODE> method to check for any waiting Toolbox events. <CODE>PollToolBoxEvent</CODE> also controls idling in the application, as described in the next sections.<P>
<A NAME=HEADING47-8></A>
<H3>The Three Phases of Idling</H3>
 There are three phases of idling, identified by the constants <CODE><A NAME=MARKER-2-262></A>idleBegin</CODE>, <CODE><A NAME=MARKER-2-263></A>idleContinue</CODE>, and <CODE><A NAME=MARKER-2-264></A>idleEnd</CODE>. After the <CODE>PollToolBoxEvent</CODE> method retrieves an event, it calls the application's <CODE>Idle</CODE> method, passing an idle constant that depends on the type of event and the current idle phase:<P>
<UL>
<LI>For a non-<CODE>NULL</CODE> event, and if the current idle phase is <CODE>idleContinue</CODE>, <CODE>PollToolBoxEvent</CODE> makes the following call to indicate that idling is ending:<P>
<pre>this-&gt;Idle(idleEnd);</pre><P>
It then sets the <CODE><A NAME=MARKER-2-265></A>fIdlePhase</CODE> field to <CODE>idleBegin</CODE> (for the next time <CODE>PollToolBoxEvent</CODE> is called).
<LI>For a <CODE>NULL</CODE> event, <CODE>PollToolBoxEvent</CODE> calls <P>
<pre>this-&gt;Idle(fIdlePhase);</pre><P>
to indicate that idling is either beginning or continuing, then sets <CODE>fIdlePhase</CODE> to <CODE>idleContinue</CODE> (for the next time <CODE>PollToolBoxEvent</CODE> is called).<A NAME=MARKER-2-266></A><P>
</UL>
 The result of these calls is shown in <A HREF=#MARKER-9-274>"The Sequence of Idle Phases," beginning on page 136</A>.<P>
<A NAME=HEADING47-17></A>
<H3><A NAME=MARKER-2-267></A>Distributing Idle Time</H3>
 Idle time is distributed by the application object's <CODE><A NAME=MARKER-2-268></A>Idle</CODE> method. If your application class descends from <CODE>TMailingApplication</CODE>, which provides support for PowerTalk mailers, the <CODE>TMailingApplication::Idle</CODE> method calls the <CODE>DoMailerEvent</CODE> method of the mixin class <CODE>MMailable</CODE>. The <CODE>DoMailerEvent</CODE> method gives the Standard Mail Package a chance to deal with certain kinds of events it is interested in--for example, it may need to focus a mailer window or perform internal processing.<P>
 The <CODE>TMailingApplication::Idle</CODE> method then calls <CODE>Inherited</CODE>. That results in execution of the <CODE>TApplication::Idle</CODE> method, which distributes idle time in the following order:<P>
<OL>
<LI>If the phase is <CODE>idleContinue</CODE>, the <CODE>Idle</CODE> method calls MacApp's <CODE>IdleOSAScript</CODE> routine to give an attached script some idle time.
<LI>The <CODE>Idle</CODE> method iterates over any handlers in the application's cohandler chain, calling the <CODE><A NAME=MARKER-2-269></A>HandleIdle</CODE> method for each cohandler.<P>
The <CODE>HandleIdle</CODE> method is a method of <CODE>TEventHandler</CODE>. It gives any behaviors attached to the cohandler a chance to have some idle time. Then, if the cohandler is enabled and the phase is <CODE>idleBegin</CODE> or <CODE>idleEnd</CODE>, or if the phase is <CODE>idleContinue</CODE> and the count indicates it is time, <CODE>HandleIdle</CODE> calls the cohandler's <CODE><A NAME=MARKER-2-270></A>DoIdle</CODE> method. Your cohandler gets control in its <CODE>DoIdle</CODE> method.
<LI>The <CODE>Idle</CODE> method iterates over any objects in the application's target chain, calling the <CODE>HandleIdle</CODE> method for each event-handler object. Objects and behaviors in the target chain get a chance at idle time in the same way that cohandlers and behaviors do in the cohandler chain.<A NAME=MARKER-2-271></A><P>
Note that the default value for <CODE>fIdleFreq</CODE>, set in the constructor method for the <CODE>TEventHandler</CODE> class, is <CODE>kMaxIdleTime</CODE>. As a result, an event-handler object will not receive idle time unless you set <CODE>fIdleFreq</CODE> to a smaller value.<P>
</OL>
 One MacApp class that overrides <CODE>DoIdle</CODE> is <CODE>TTEView</CODE>. In its <CODE>DoIdle</CODE> method it calls the Toolbox routine <CODE>TEIdle</CODE> to ensure blinking of the insertion point.<A NAME=MARKER-2-272></A><P>
<A NAME=HEADING47-26></A>
<H3><A NAME=MARKER-2-273></A><A NAME=MARKER-9-274></A>The Sequence of Idle Phases</H3>
 As a result of MacApp's idling algorithm, the sequence of events and idle phases over time may look something like the following (boldface used for emphasis):<P>
<UL>
<UL>
<LI><B>event received</B>
<LI><CODE>idleBegin</CODE> phase
<LI><CODE>idleContinue</CODE> phase
<LI><CODE>idleContinue</CODE> phase
<LI>. . . (<CODE>idleContinue</CODE> phase multiple times)
<LI><CODE>idleEnd</CODE> phase
<LI><B>event received</B>
<LI><B>event received</B> (no idling between events)
<LI><CODE>idleBegin</CODE> phase
<LI><CODE>idleEnd</CODE> phase (no <CODE>idleContinue</CODE> phase)
<LI><B>event received</B>
<LI>. . .<P>
</UL>
</UL>
 This sequence can lead to some surprising results, described in the next section.<P>
<A NAME=HEADING47-41></A>
<H3>Idle Thoughts</H3>
 Developers often expect that the <CODE>DoIdle</CODE> method of their event-handler object will be called regularly, every <CODE>fIdleFreq</CODE> ticks. It won't. MacApp's idling mechanism is not a timer. Your <CODE>DoIdle</CODE> method is called only when the application has been idle for <CODE><A NAME=MARKER-2-276></A>fIdleFreq</CODE> ticks. When the application is busy, your <CODE>DoIdle</CODE> method will not be called (with the <CODE>idleContinue</CODE> value) as often, if at all.<P>
 Another common error is to perform a task in the <CODE>DoIdle</CODE> method without checking the idle phase. Your <CODE>DoIdle</CODE> method may be called with <CODE>idleBegin</CODE> and <CODE>idleEnd</CODE> for every event the application processes. If you don't check the idle phase, your idle task may be performed much more frequently than you expect.<P>
 In summary:<P>
<UL>
<LI><CODE>DoIdle</CODE> gets called very frequently with the idle phase <CODE>idleBegin</CODE> or <CODE>idleEnd</CODE>. It may be called too frequently to schedule an idle task (at least one of substantial length) for every begin or end phase.
<LI><CODE>DoIdle</CODE> may get called with <CODE><A NAME=MARKER-2-278></A>idleContinue</CODE> less frequently than you expect. Empirical testing can help determine if the frequency is sufficient for your purpose.<P>
</UL>
<A NAME=HEADING47-47></A>
<H2><A NAME=MARKER-2-279></A>Responding to Alien Events With a Cohandler</H2>
 MacApp defines an event it doesn't anticipate handling as an <I>alien event</I>. Alien events include network events, driver events, null events, events defined by the Toolbox constants <CODE><A NAME=MARKER-2-280></A>app1Evt</CODE>, <CODE><A NAME=MARKER-2-281></A>app2Evt</CODE>, and <CODE><A NAME=MARKER-2-282></A>app3Evt</CODE>, and any other events MacApp doesn't recognize, such as events defined by your application.<P>
 The application dispatches alien events by calling its <CODE><A NAME=MARKER-2-283></A>HandleAlienEvent</CODE> method. The <CODE>HandleAlienEvent</CODE> method iterates over the cohandlers in the application's cohandler chain (pointed to by <CODE><A NAME=MARKER-2-284></A>fHeadCohandler</CODE>), calling <CODE><A NAME=MARKER-2-285></A>DoCoHandlerEvent</CODE>. The <CODE>DoCoHandlerEvent</CODE> method does nothing in <CODE>TEventHandler</CODE>, but your cohandler class can override it to process alien events.<A NAME=MARKER-2-286></A><P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="MacAppProgGuide-46.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="MacAppProgGuide-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="MacAppProgGuide-158.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="MacAppProgGuide-48.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="MacAppProgGuide-3.html">&copy; Apple Computer, Inc.</A><br>25 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
