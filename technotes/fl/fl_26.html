<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-August-01 --><!-- Includes revisions to graphics tags --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note FL26: Lock, Unlock the Range</title><meta name="keywords" content="Mac OS 8 _PBLockRange _PBUnlockRange ioPosMode fsFromLEOF AppleShare"><meta name="Description" content="Technical Note FL26: This Technical Note discusses the _PBLockRangeand _PBUnlockRange routines; how they act on local and sharedvolumes; how to determine what range of bytes were just lockedand why you should not set the ioPosMode field to fsFromLEOFin the parameter block for those routines when accessinga file on an AppleShare volume.">                                       <meta name="categories" content="Files"><meta name="week-posted" content="Mar 28, 1988 - Apr 1, 1988"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002452" title="Lock, Unlock the Range"></a><A NAME="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxCarbon-date.html">Carbon</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/Carbon/idxFileManagement-date.html" target="_blank">Carbon > File Management</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note FL26</div>
<div id="pageheadsub">Lock, Unlock the Range</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext">					<A HREF="#Section1">Introduction</A><BR><BR> 					<A HREF="#Section2">Local Versus AppleShare</A><BR><BR>  					<A HREF="#Section3">One Way To Lock, Two Ways To Unlock</A><BR><BR>  					<A HREF="#Section4">What Range Did I Just Lock?</A><BR><BR>  					<A HREF="#Section5">An Off By EOF Bug</A><BR><BR>  					<A HREF="#Summary">Summary</A><BR><BR>   					<A HREF="#References">References</A><BR><BR>   <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">This Technical Note discusses the <code>_PBLockRange</code> and <code>_PBUnlockRange</code> routines; how they act on local and shared volumes and why you should not set the <code>ioPosMode</code> field to <code>fsFromLEOF</code> in the parameter block for those routines when accessing a file onan AppleShare volume.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Apr 01 1988]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR><!-- begin_content --><a name="Section1"></a><h2>Introduction</h2><p>A file can be opened with a shared read and write permission (<code>ioPermssn</code> = <code>fsRdWrShPerm</code>) to allow several users to share the data in that file.  (When a file is opened more than once, each open is considered a different "user".)  When you, as a user of a shared file, need to modify a portion of the file(for example, a record in a database), it is usually very desirable to make that portion of the file unavailable to otherusers while you are making your changes.  The <code>_PBLockRange</code> call is provided to lock a portion orrange of bytes of the file. <code>_PBUnlockRange</code> can be called later to unlock the portion of a file locked with <code>_PBLockRange</code>. If you have read the File Manager chapters of Inside Macintosh IV and V, you know all of that, but there are a few things that it doesn't tell you, and that is the topic of this Note.</p><P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>Local Versus AppleShare</h2><p><code>_PBLockRange</code> and <code>_PBUnlockRange</code> do nothing when used on filesthat are on a local HFS (or MFS) volume unless local file sharing is in effectunder System Software 7.0.  The two routines do not return any errors and theydo not lock or unlock a range of bytes.  Following is a way to verify that<code>_PBLockRange</code> works on an open file:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    {Start with an open file}    WITH theParmBlk DO      BEGIN        {ioRefNum from open call}        ioCompletion := NIL;        ioReqCount := 1;          {lock a single byte}        ioPosMode := fsFromStart; {at the beginning of the file}        ioPosOffset := 0;      END;    theErr := PBLockRange(@theParmBlk, FALSE);   {lock the byte - ignore error}    theErr := PBLockRange(@theParmBlk, FALSE);   {lock it again}    IF theErr = afpRangeOverlap {see if PBLockRange locked it the first time}      THEN        BEGIN          RangeLockPresent := TRUE; {Range was locked}          theErr := PBUnlockRange(@theParmBlk, FALSE); {unlock the locked byte}        END;      ELSE RangeLockPresent := FALSE; {Range was not locked}</pre>	</TD></TR></TABLE></CENTER><p>Luckily, <code>_PBLockRange</code> and <code>_PBUnlockRange</code> work when used on files that are on a shared volume (i.e., AppleShare) where the possibility of shared access usually comes up much more often.  When <code>_PBLockRange</code>and <code>_PBUnlockRange</code> are used on a file on a shared volume, both calls are translated into an AppleTalk Filing Protocol (AFP) call, <code>FPByteRangeLock</code>.  The <code>FPByteRangeLock</code> call locks or unlocks a specified range of bytes within an open fork.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>With System Software 7.0, file sharing can be started or stoppedwith the Sharing Setup Control Panel while your application is running.  Iffile sharing is stopped, AppleTalk AFP specific attributes on local volumes,including locked ranges, become invalid.  The<code>bHasPersonalAccessPrivileges</code> bit in the <code>vMAttrib</code> longword returned by <code>_PBHGetVolParms</code> can be used to check the current state of file sharing on local volumes.</p></TD></TR></TABLE></CENTER><BR> <P><A HREF="#top">Back to top</A></P><a name="Section3"></a><h2>One Way To Lock, Two Ways To Unlock</h2><p>The File Manager only gives one way to lock a range of bytes of a file, the <code>_PBLockRange</code> routine.  However, there are two ways to unlock a locked range of bytes of a file.  The obvious method of unlocking a rangeof bytes is the <code>_PBUnlockRange</code> routine; the not so obvious method is to close the file.  When a file is closed, all locked ranges held by a user of the file are unlocked.</p><p>The range of bytes unlocked by <code>_PBUnlockRange</code> must be the exact same range locked by a <code>_PBLockRange</code> call; you cannot unlock a portion of a locked range nor can you unlock portions of a file thatare not locked.  If, for some reason, you need to unlock a range you have locked and you do not know where the range started or how long the range is, you must close the file to unlock the range.</p><P><A HREF="#top">Back to top</A></P><a name="Section4"></a><h2>What Range Did I Just Lock?</h2><p>A range of bytes may be locked relative to the beginning or the end of thefile, however AFP's <code>FPByteRangeLock</code> call only lets you unlock a rangeof bytes relative to the beginning of the file.  If a range of bytes issuccessfully locked with the <code>FPByteRangeLock</code> call, then a reply packetcontaining <code>RangeStart</code>, the number of the first byte of the range justlocked (i.e., the offset from the beginning of the fork) is returned to<code>FPByteRangeLock</code>.  That offset allows an application to set a lock whenthe application does not know the exact end of file (which can often happenwhen sharing a file) and later know what range to unlock.</p><p>This brings us to an interesting fact:  <code>_PBLockRange</code> does not return the number of the first byte of the range just locked to your application.  The reply packet containing <code>RangeStart</code> is returned by <code>FPByteRangeLock</code>, but <code>_PBLockRange</code> does not return it to your application.  That would make it impossible to really know what range you just locked if the range locked were relative to the end of file.  However, the Macintosh does not use the file server's end of file.  Instead, the file's logical end of file is retrieved from the server when the file is opened and that local copy of end of file is used whenever the <code>ioPosMode</code> field is set to <code>fsFromLEOF</code> (the current logical end of file can be retrieved with <code>_PBGetEOF</code>).</p><P><A HREF="#top">Back to top</A></P><a name="Section5"></a><h2>An Off By EOF Bug</h2><p>With Macintosh System Software 6.0.7 and earlier, the <code>_PBLockRange</code>call's parameters are incorrectly translated to the parameters passed to theAFP <code>FPByteRangeLock</code> call.  When <code>ioPosMode</code> field is set to<code>fsFromLEOF</code> the offset parameter sent is equal to the offset suppliedto the <code>_PBLockRange</code> call plus what your system locally thinks is thecurrent EOF.  This would work correctly except that the <code>Start/EndFlag</code>in the <code>FPByteRangeLock</code> call's parameter list is set to <code>End</code>(relative to end of file) which means that the range locked is EOF bytesfurther out than that for which you asked.</p><p>The problem can be avoided under System Software 6.0.7 and earlier by using<code>fsFromStart</code>, <code>fsAtMark</code>, or <code>fsFromMark</code> for the<code>ioPosMode</code> field.  System Software 7.0 fixes the bug by setting the<code>Start/EndFlag</code> in the <code>FPByteRangeLock</code> call's parameter list to<code>Start </code>(relative to beginning of file) when <code>ioPosMode</code> is setto <code>fsFromLEOF</code>.</p><P><A HREF="#top">Back to top</A></P><a name="Summary"></a><h2>Summary</h2><p>Remember, <code>_PBLockRange</code> does not do anything on local unshared volumes,and if you use <code>_PBLockRange</code> under Macintosh System Software 6.0.7 or earlier, never set <code>ioPosMode</code> to <code>fsFromLEOF</code>.</p><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><p><i>Inside Macintosh</i>, Volumes IV &amp; VI, The File Manager</p><p><i>Inside Macintosh</i>, Volume V, File Manager Extensions In a Shared Environment</p><p><i>Inside AppleTalk</i>, AppleTalk Filing Protocol</p><P><A HREF="#top">Back to top</A></P><P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (56K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/fl_26.pdf">Download</A></P>               </TD>            </TR></table><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/fl/fl_26.html%3Fid%3DDTS10002452-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/fl/fl_26.html%3Fid%3DDTS10002452-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/fl/fl_26.html%3Fid%3DDTS10002452-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --><hr width=500 align=center></BODY></HTML>