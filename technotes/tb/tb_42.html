<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><meta name="keywords" content="Finder Icon Position locate file FInfo DInfo"><meta name="Description" content="Technical Note TB42: This Technical Note discusses how yourapplication can tell the Finder where to position a newlycreated file or folder."><title>Technical Note TB42: Finder Icon Positioning and File Initialization</title><meta name="categories" content="Human Interface Toolbox"><meta name="week-posted" content="May 29, 1995 - Jun 2, 1995"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002793" title="Finder Icon Positioning and File Initialization"></a><a name="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxCarbon-date.html">Carbon</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Carbon/idxUserExperience-date.html" target="_blank">Carbon > User Experience</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TB42</div>
<div id="pageheadsub">Finder Icon Positioning and File Initialization</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Section1">The Original Positioning Mechanism <BR>(or what happens if you do nothing)</A><BR><BR><A HREF="#Section2">Why Some Applications Try to Go Behind the Finder's Back</A><BR><BR><A HREF="#Section3">The Magic Icon Placement Solution</A><BR><BR><A HREF="#Section4">The Scriptable Finder</A><BR><BR><A HREF="#Section5">Conclusion</A><BR><BR><A HREF="#References">References</A><BR><BR><A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">This Technical Note discusses how your application can tell the Finder where toposition a newly created file or folder.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Jun 01 1995]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content --><a name=Section1></A><h2>The Original Positioning Mechanism (or what happens if you do nothing)</h2><p>The Finder uses the File Manager records reserved for the Finder's use,<code>FInfo</code> and <code>DInfo</code>, to keep track of the position (location) offiles and folders appearing in windows displayed in view "by icon" or in view"by small icon." Whenever the File Manager creates a new file or directory, the<code>FInfo</code> or <code>DInfo</code> records are cleared. That sets the position to(0, 0) and clears the <code>hasBeenInited</code> Finder flag.</p><p>Whenever the Finder sees a file or directory with a cleared<code>hasBeenInited</code> Finder flag, it positions the file or directory in thefirst empty space in the window or on the desktop, and sets the<code>hasBeenInited</code> Finder flag. At that time, if a file's<code>hasBundle</code> Finder flag is set, the Finder also installs the bundleinformation from the file's bundle resource and all of its bundled resourcesinto either the volume's desktop database or Desktop file, and installs theinformation needed by the Translation Manager, including the file's 'open' and'kind' resource data.</p><P><A HREF="#top">Back to top</A></p><a name="Section2"></a><h2>Why Some Applications Try to Go Behind the Finder's Back</h2><p>Some applications want to set the position of new files or folders themselves.For example, an archiver might want extracted files to have the same positionthat the original file did before it was placed into the archive. In order todo this with a file, they must put the position in the <code>fdLocation</code>field of the <code>FInfo</code> record. They must also set the<code>hasBeenInited</code> Finder flag in the <code>fdFlags</code> field of the<code>FInfo</code> record; otherwise, the Finder will just reposition the file thenext time it sees it, no matter what value is stored in the <code>fdLocation</code>field.</p><b>The problem With Setting the hasBeenInited Finder Flag</b><p>The problem with setting the <code>hasBeenInited</code> Finder flag is that itprevents the Finder from installing bundle and Translation Manager informationinto the desktop database. To fix this problem, some applications have beenknown to try to add information to the desktop database themselves, and wind upmaking a mess of the disk. That's why the Desktop Manager of <i>InsideMacintosh: More Macintosh Toolbox</i> includes the following warning:</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Warning:</B><BR>Although routines that set information in and get informationfrom the desktop database are described in this section, you should never usethese routines to change, add to, or remove any information from the desktopdatabase. Manipulating the desktop database is likely to wreak havoc on yourusers' systems.</P></TD></TR></TABLE></CENTER><BR><P><A HREF="#top">Back to top</A></p><a name="Section3"></a><h2>The Magic Icon Placement Solution</h2><p>Starting with System 7 Pro (System 7.1.1), the Finder supports magic iconplacement. Magic icon placement allows an application to specify where a newlycreated file or folder with a cleared <code>hasBeenInited</code> Finder flag willbe placed when the Finder initializes it. If the <code>hasBeenInited</code> Finderflag is clear, and the file or folder's position is somewhere inside the "magicrectangle" centered at (-20,000, -20,000), then the Finder will add 20,000 tothe file or folder's horizontal and vertical position, and place it there. Themagic rectangle is (-24,000, -24,000, -16,000, -16,000).</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Warning:</B><BR>Don't put files whose <code>hasBeenInited</code> Finder flag is setinto the "magic rectangle" or the Finder really will position them there!</p></TD></TR></TABLE></CENTER><BR><p>The following functions show how to create a file or folder, and position itusing the magic icon positioning technique.</P><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    OSErr   SetIconLocation(short vRefNum, long dirID, ConstStr255Param name,                            Point location)    {        /* (-20,000, -20,000) is the origin of the magic rectangle */        enum { magicNumber = 20000 };        OSErr        result;        CInfoPBRec    pb;        pb.hFileInfo.ioNamePtr = (StringPtr)name;        pb.hFileInfo.ioVRefNum = vRefNum;        pb.hFileInfo.ioDirID = dirID;        pb.hFileInfo.ioFDirIndex = 0; /* use ioNamePtr and ioDirID */        result = PBGetCatInfoSync(&amp;pb);        if ( result == noErr )        {            /* set the magic location */            location.v -= magicNumber;            location.h -= magicNumber;            pb.hFileInfo.ioFlFndrInfo.fdLocation = location;            /* make sure the kHasBeenInited flag is clear */            pb.hFileInfo.ioFlFndrInfo.fdFlags &amp;= ~kHasBeenInited;            /* save the new information back to disk */            pb.hFileInfo.ioDirID = dirID;            result = PBSetCatInfoSync(&amp;pb);        }        return ( result );    }    OSErr   HCreateLocate(short vRefNum, long dirID, ConstStr255Param fileName,                          OSType creator, OSType fileType, Point location)    {        OSErr    result;        result = HCreate(vRefNum, dirID, fileName, creator, fileType);        if ( result == noErr )            result = SetIconLocation(vRefNum, dirID, fileName, location);        return ( result );    }    OSErr   HDirCreateLocate(short vRefNum, long parentDirID,                             ConstStr255Param directoryName, Point location,                             long *createdDirID)    {        OSErr    result;        result = DirCreate(vRefNum, parentDirID, directoryName, createdDirID);        if ( result == noErr )            result = SetIconLocation(vRefNum, parentDirID, directoryName, location);        return ( result );</pre>	</TD></TR></TABLE></CENTER><h3>Determining if Magic Icon Placement Exists</h3><p>It doesn't hurt anything to use the magic icon placement technique on a machinerunning a Finder that doesn't support it. Since the <code>hasBeenInited</code>Finder flag is cleared, older Finders will just reposition the file or folderin the ordinary manner. Some programs may wish to set both the<code>hasBeenInited</code> Finder flag and the position of the file if magic iconplacement is not available. Programs can determine if magic icon placementexists by calling <code>Gestalt</code> with the Finder's gestalt selector,<code>gestaltFinderAttr</code>. If the <code>gestaltFinderAttr</code> selector does notexist, or if the attribute bit <code>gestaltFinderMagicPlacement</code> is clear,then magic icon placement is not available. The following code shows how tocheck for magic icon placement:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>Boolean HasMagicPosition(void){    long  attrib;    if ( (Gestalt(gestaltFinderAttr, &amp;attrib) == noErr) &amp;&amp;         ((attrib &amp; gestaltFinderMagicPlacement) != 0) )        return ( true );    else        return ( false );</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></p><a name="Section4"></a><h2>The Scriptable Finder</h2><p>This still leaves a couple of problems that magic icon positioning doesn'tsolve.</p><p>The first problem is the Finder does not initialize files until it sees them,and it does not go looking for them. A file created inside a new folder willnot be seen by the Finder until that folder is opened by a user. This meansthat any bundle information in the file will not be added to the desktopdatabase until some later time. This is a problem for some applications,because the Finder will not be able to launch documents of an application untilit has seen the application file.</p><p>The second problem is magic icon positioning doesn't let you change theposition of files once the Finder has seen them. When the Finder opens afolder, it gets (and sets if needed) the position of all file or folder iconsin that folder's window. If you change the position of a file or folder usingmagic icon positioning, the Finder won't notice your changes until the windowis closed and then reopened.</p><p>The solution to both of these problems is the scriptable Finder. With thescriptable Finder, you can force the Finder to notice new files, even if theyare not in a visible window, and you can tell the Finder to move a file orfolder's icon. "Scripting the Finder From Your Application" by Greg Anderson in<i>develop</i> issue 20 and the <i>AppleScript Finder Guide </i>both containdetailed information describing how you can use the scriptable Finder toperform these tasks and many others.</p><P><A HREF="#top">Back to top</A></p><a name="Section5"></a><h2>Conclusion</h2><p>For programs such as an archiver, the magic positioning technique provides aneasy-to- implement solution for positioning newly created or recreated filesand folders. However, the scriptable Finder, when available, provides a muchwider range of services for manipulating the way files and folders arepresented to an user.</p><P><A HREF="#top">Back to top</A></p><a name = "References"></a><h2>References</h2><p><i>Inside Macintosh: Macintosh Toolbox Essentials</i>, Chapter 7, "FinderInterface"</p><p><i>Inside Macintosh: More Macintosh Toolbox</i>, Chapter 9, "DesktopManager"</p><p>"Scripting the Finder From Your Application" by Greg Anderson,<i>develop</i> issue 20</p><p><i>AppleScript Finder Guide</i></p><p><i>Apple Event Registry: Standard Suites</i>, on the Reference Libraryedition of Developer CD Series</p>         <a name="Downloads"></a>       <P><A HREF="#top">Back to top</A></p><h2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (56K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tb_42.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tb/tb_42.html%3Fid%3DDTS10002793-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tb/tb_42.html%3Fid%3DDTS10002793-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tb/tb_42.html%3Fid%3DDTS10002793-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>