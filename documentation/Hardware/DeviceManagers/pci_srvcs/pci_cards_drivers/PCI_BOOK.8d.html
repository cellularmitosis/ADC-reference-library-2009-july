<HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><script language="JavaScript" src="frametest.js"></script><TITLE> Driver Replacement</TITLE></HEAD><BODY BGCOLOR="#ffffff"><DIV><a name="top"></a><!-- start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!-- start of path --><font face="Geneva,Helvetica,Arial" size="1"><b><br>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Documentation</a> &gt; <!-- a href="" target="_top" -->Hardware<!-- /a -->  <b>&gt; </b><a href="../../devicemgrs.html" target="_top">Device Managers and Drivers</a> <b>&gt; </b><a href="../pci_srvcs.html" target="_top">PCI Card Services</a> <b>&gt; </b>Designing PCI Cards and Drivers for Power Macintosh Computers</font><br><br><!-- end of path --><A HREF="PCI_BOOK.86.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.8c.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.8e.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><HR></DIV><H1 CLASS="H1.Heading1"><A NAME="pgfId=3489"> </A><A NAME="25819"> </A>Driver Replacement</H1><P CLASS="T1.Text1"><A NAME="pgfId=3491"> </A><A NAME="marker=3490"> </A>Suppose you are shipping your PCI card and have discovered an obscure bug in your expansion ROM driver. This section describes the mechanism that Apple supplies to allow you to update your ROM-based driver with a newer disk-based version.</P><P CLASS="T1.Text1"><A NAME="pgfId=3492"> </A>As described earlier in this chapter, the Name Registry is populated with device nodes that have <TT CLASS="cv">driver,AAPL,MacOS,PowerPC</TT> properties and <TT CLASS="cv">driver-descriptor</TT> properties. These properties are loaded from the expansion ROM and configuration space, installed by the Open Firmware code, and pruned by the Expansion Manager. </P><P CLASS="T1.Text1"><A NAME="pgfId=3493"> </A>After the Registry is populated with device nodes, the Macintosh startup sequence initializes the devices. For every device node in the Registry there are two questions that require answers before the system can complete a client request to use the device. The client may be the system itself or an application. The questions are</P><UL><LI CLASS="B1.Bullet1"><A NAME="pgfId=3494"> </A>Is there a driver for this node?</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3495"> </A>Where is the most current version of the driver for this node?</LI></UL><P CLASS="T1.Text1"><A NAME="pgfId=3496"> </A>If there is a driver in ROM for a device, the <TT CLASS="cv">driver,AAPL,MacOS,PowerPC</TT> property is available in the Name Registry whenever a client request is made to use that device. However, after the operating system is running and the file system is available, the ROM driver may not be the driver of choice. In this case, the ROM-based driver is replaced with a newer version of the driver on disk by the following means.</P><P CLASS="T1.Text1"><A NAME="pgfId=3497"> </A>In the system startup sequence, as soon as the file system is available Mac&nbsp;OS searches the Extensions folder and matches drivers in that folder with device nodes in the Name Registry. For a discussion of driver matching, see <A HREF="PCI_BOOK.89.html#28331" CLASS="XRef">Matching Drivers With Devices</A>. The <TT CLASS="cv">driverInfoStr</TT> and <TT CLASS="cv">version</TT> fields of the <TT CLASS="cv">DriverType</TT> fields of the two driver description structures are compared, and the newer version of the driver is installed in the tree. When the driver is updated, the <TT CLASS="cv">driver-descriptor</TT> property and all other properties associated with the node whose names begin with <TT CLASS="cv">Driver</TT> are updated in the Name Registry.</P><P CLASS="T1.Text1"><A NAME="pgfId=3501"> </A>If the driver associated with a node is open (that is, if it was used in the system startup sequence) and if the driver is to be replaced, the system must first close the open driver, using the <TT CLASS="cv">driver-ref</TT> property in the Name Registry to locate it. The system must then update the Registry and reinstall and reopen the driver. If the close or finalize action fails, the driver will not be replaced.<A NAME="marker=3502"> </A></P><P CLASS="T1.Text1"><A NAME="pgfId=3503"> </A>The native driver model does not provide automatic replacement of 68K drivers. It is possible to replace a 68K driver, but it requires some work on your part. If you want to replace a 68K driver with a native driver dynamically, you must close the open 68K driver, extract its state information, and load and install the native driver using the Driver Loader Library. The native driver must occupy the same DCE slot as the 68K driver and use the same reference number. After being opened, it must start running with the state information that was extracted from the 68K driver.</P><P CLASS="T1.Text1"><A NAME="pgfId=3504"> </A>Applications and other software can use the <TT CLASS="cv">ReplaceDriverWithFragment</TT> function to replace one driver with another and <TT CLASS="cv">RenameDriver</TT> to change a driver's name. These routines are described next.</P><H2 CLASS="RoH.RoutineHeadingTOC"><A HREF="PCI_BOOK.8e.html#pgfId=3506" CLASS="Hypertext">ReplaceDriverWithFragment</A></H2><H2 CLASS="RoH.RoutineHeadingTOC"><A HREF="PCI_BOOK.8f.html#pgfId=3540" CLASS="Hypertext">RenameDriver</A></H2><HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 26 March 99)<P><A HREF="PCI_BOOK.86.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.8c.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.8e.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>