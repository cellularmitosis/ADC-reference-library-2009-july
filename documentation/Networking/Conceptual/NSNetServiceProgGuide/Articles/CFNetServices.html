<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>NSNetServices and CFNetServices Programming Guide: CFNetServices</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="CFNetServices"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/30001276" title="CFNetServices"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000429" target="_top">Networking</a> &gt; <a href="../../../Bonjour-date.html#//apple_ref/doc/uid/TP30000440-TP30000429-TP30000566" target="_top">Bonjour</a> &gt; <a href="../index.html" target="_top">NSNetServices and CFNetServices Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="ResolvingServices.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../RevisionHistory.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>
        
        
        <a name="//apple_ref/doc/uid/30001276-SW3" title="CFNetServices"></a><hr /><H1>CFNetServices</H1><p>CFNetServices is a Core Services API that allows you to register a network service, such as a printer or file server. By registering a service, it can be found by name or browsed for by service type and domain. Applications can use the CFNetServices API to discover the services that are available on the network and to find all access information — such as name, IP address, and port number — needed to use each service.</p><p>The CFNetServices API uses the Core Services framework to provide access to Bonjour. It should be used when programming in C or C++ to write applications that need to discover services. If your C or C++ program uses a run loop, use this API.</p>
<!-- This template is being used for both PDF and HTML. -->

    
    <!-- TopicBook.pm uses this template for its miniTOCs, but needs a different title. -->
    <h4>Contents:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<!--a  -->Requirements<!--/a-->
				
			<br/>
			
        
			
			
				<a href="CFNetServices.html#//apple_ref/doc/uid/30001276-SW7">Using the CFNetServices API</a>
				
			<br/>
			
        
			
			
				<a href="CFNetServices.html#//apple_ref/doc/uid/30001276-SW8">Publishing a Service</a>
				
			<br/>
			
        
			
			
				<!--a  -->Browsing for Services<!--/a-->
				
			<br/>
			
        
			
			
				<a href="CFNetServices.html#//apple_ref/doc/uid/30001276-SW13">Resolving a Service</a>
				
			<br/>
			
        
			
			
				<a href="CFNetServices.html#//apple_ref/doc/uid/30001276-SW14">Monitoring a Service</a>
				
			<br/>
			
        
			
			
				<!--a  -->Asynchronous and Synchronous Modes<!--/a-->
				
			<br/>
			
        
			
			
				<!--a  -->Shutting Down Services and Searches<!--/a-->
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP30000229-66373" title="Requirements"></a><h2>Requirements</h2><p>Version 10.2 or later of Mac OS X is required.</p><a name="//apple_ref/doc/uid/30001276-SW7" title="Using the CFNetServices API"></a><h2>Using the CFNetServices API</h2><p>The CFNetServices API provides access to Bonjour through three objects:</p><ul class="ul"><li class="li"><p><code>CFNetService</code> - An object that represents a single service on the network. A CFNetService has a name, a type, a domain, and a port number. Service types used by CFNetServices are maintained at <span class="content_text"><a href="http://www.dns-sd.org/servicetypes.html" target="_blank">http://www.dns-sd.org/servicetypes.html</a></span>.</p></li><li class="li"><p><code>CFNetServiceBrowser</code> - An object used to discover domains and discover network services within domains.</p></li><li class="li"><p><code>CFNetServiceMonitor</code> - An object used to monitor services for changes to their TXT records.</p></li></ul><a name="//apple_ref/doc/uid/30001276-SW8" title="Publishing a Service"></a><h2>Publishing a Service</h2><p>Publishing a service on the network involves two tasks: creating a service, and registering a service. The next two sections will describe what is required to perform these two tasks.</p><a name="//apple_ref/doc/uid/30001276-SW9" title="Creating a CFNetService"></a><h3>Creating a CFNetService</h3><p>The function that creates a CFNetService (<code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceCreate" target="_top">CFNetServiceCreate</a></code>) requires you to provide the following parameters that describe the service:</p><ul class="spaceabove"><li class="li"><p>Name — human-readable name of the service (such as “<code>Sales Laser Printer</code>”)</p></li><li class="li"><p>Service Type — the type of service, such as “<code>_printer._tcp</code>“; </p></li><li class="li"><p>Domain — the domain for the service, typically the empty string (<code>CFSTR("")</code>)for default domain(s), or <code>local.</code> for the local domain only</p></li><li class="li"><p>Port — the port number the service listens on</p></li></ul><div class="notebox"><a name="//apple_ref/doc/uid/30001276-SW10" title="Note"></a><p><strong>Note:</strong>&nbsp;The dot in “<code>local.</code>“ is part of the domain name. It signifies that the domain is fully qualified, which prevents anything from being added to the end of the domain (for example, <code>local.com</code>).</p></div><p>If you are implementing a protocol that relies on data stored in DNS text records, you can associate that information with a CFNetService by calling a separate CFNetServices function (<code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceSetTXTData" target="_top">CFNetServiceSetTXTData</a></code>). Prior to Mac OS X v10.4, use the deprecated function <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceSetProtocolSpecificInformation" target="_top">CFNetServiceSetProtocolSpecificInformation</a></code> instead.</p><p>Associate a callback function with your CFNetService by calling CFNetServices function <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceSetClient" target="_top">CFNetServiceSetClient</a></code> . Your callback function will be called to report errors that occur while your service is running.</p><p>If you want the service to run asynchronously, you must also schedule the CFNetService on a run loop by calling <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceScheduleWithRunLoop" target="_top">CFNetServiceScheduleWithRunLoop</a></code>; otherwise, the service will run synchronously. For more information about the modes in which a service can run, see<span class="content_text"><a href="CFNetServices.html#//apple_ref/doc/uid/TP30000229-66670">“Asynchronous and Synchronous Modes.”</a></span></p><p>Below is some example code for how to create a CFNetService.</p><a name="//apple_ref/doc/uid/30001276-SW11" title="Listing 1Creating a CFNetService"></a><p class="codesample"><strong>Listing 1&nbsp;&nbsp;</strong>Creating a CFNetService</p><div class="codesample"><table><tr><td scope="row"><pre>CFNetService netService = CFNetServiceCreate(NULL, CFSTR(""), serviceType, serviceName, chosenPort);<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/30001276-SW12" title="Registering a CFNetService"></a><h3>Registering a CFNetService</h3><p>To make a service available on the network, call the CFNetServices function <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceRegisterWithOptions" target="_top">CFNetServiceRegisterWithOptions</a></code> that registers a CFNetService. (This process is also known as “publishing” a service.) A CFNetServiceBrowser will be able to find the service until the service is stopped by the CFNetServices function <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceCancel" target="_top">CFNetServiceCancel</a></code> that terminates services.</p><p>Please see <span class="content_text"><a href="CFNetServices.html#//apple_ref/doc/uid/30001276-SW1">Listing 2</a></span> for sample code on this subject.</p><a name="//apple_ref/doc/uid/30001276-SW1" title="Listing 2Registering an Asynchronous Service"></a><p class="codesample"><strong>Listing 2&nbsp;&nbsp;</strong>Registering an Asynchronous Service</p><div class="codesample"><table><tr><td scope="row"><pre>void startBonjour (CFNetServiceRef netService) {<span></span></pre></td></tr><tr><td scope="row"><pre>   CFStreamError error;<span></span></pre></td></tr><tr><td scope="row"><pre>   CFNetServiceClientContext clientContext = { 0, NULL, NULL, NULL, NULL };<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>   CFNetServiceSetClient(netService, registerCallback, &amp;clientContext);<span></span></pre></td></tr><tr><td scope="row"><pre>   CFNetServiceScheduleWithRunLoop(netService, CFRunLoopGetCurrent(), kCFRunLoopCommonModes);<span></span></pre></td></tr><tr><td scope="row"><pre>   CFNetServiceRegister(netService, NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>   if (CFNetServiceRegister(netService, &amp;error) == false) {<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceUnscheduleFromRunLoop(netService, CFRunLoopGetCurrent(),kCFRunLoopCommonModes);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceSetClient(netService, NULL, NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFRelease(netService);<span></span></pre></td></tr><tr><td scope="row"><pre>     fprintf(stderr, "could not register Bonjour service");<span></span></pre></td></tr><tr><td scope="row"><pre>   }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000229-66600" title="Browsing for Services"></a><h2>Browsing for Services</h2><p>To browse for services represented by a CFNetService, call the CFNetServices function that creates CFNetServiceBrowsers, <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceBrowserCreate" target="_top">CFNetServiceBrowserCreate</a></code>. When you create a CFNetServiceBrowser, you need to provide a pointer to your callback function, which will be called when services are found.</p><p>If you want searches to be conducted asynchronously, you must also schedule the CFNetServiceBrowser on a run loop with<code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceBrowserScheduleWithRunLoop" target="_top">CFNetServiceBrowserScheduleWithRunLoop</a></code>.</p><p>To browse for services you can call the CFNetServices function <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceBrowserSearchForServices" target="_top">CFNetServiceBrowserSearchForServices</a></code> and specify the services to search for. For the domain parameter, you have two options. It is recommended that you pass the empty string (<code>CFSTR("")</code>) as the domain, allowing you to discover services in any domain on which your system is registered. Alternatively, you can specifying a domain to search in. Your callback function will be called and passed a CFNetService representing a matching service. The CFNetServiceBrowser will continue searching until your application stops the search by calling <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceBrowserStopSearch" target="_top">CFNetServiceBrowserStopSearch</a></code>.</p><p>For each CFNetService that your callback function receives, you can call a CFNetServices function <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceResolveWithTimeout" target="_top">CFNetServiceResolveWithTimeout</a></code> to update the CFNetService with the IP address for the service. Prior to Mac OS X v10.4, use the deprecated function <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceResolve" target="_top">CFNetServiceResolve</a></code> instead of <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceResolveWithTimeout" target="_top">CFNetServiceResolveWithTimeout</a></code>. Then call the CFNetService function <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceGetAddressing" target="_top">CFNetServiceGetAddressing</a></code> to get a CFArray containing a CFDataRef for each IP address associated with the service. Each CFDataRef consists of a <code>sockaddr</code> structure containing an IP address.</p><p>A good example of how to browse for services can be seen in <span class="content_text"><a href="CFNetServices.html#//apple_ref/doc/uid/30001276-SW2">Listing 3</a></span>.</p><a name="//apple_ref/doc/uid/30001276-SW2" title="Listing 3Browsing Asynchronously for Services"></a><p class="codesample"><strong>Listing 3&nbsp;&nbsp;</strong>Browsing Asynchronously for Services</p><div class="codesample"><table><tr><td scope="row"><pre>static Boolean MyStartBrowsingForServices(CFStringRef type, CFStringRef domain) {<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceClientContext clientContext = { 0, NULL, NULL, NULL, NULL };<span></span></pre></td></tr><tr><td scope="row"><pre>     CFStreamError error;<span></span></pre></td></tr><tr><td scope="row"><pre>     Boolean result;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     assert(type != NULL);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     gServiceBrowserRef = CFNetServiceBrowserCreate(kCFAllocatorDefault, MyBrowseCallBack, &amp;clientContext);<span></span></pre></td></tr><tr><td scope="row"><pre>     assert(gServiceBrowserRef != NULL);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceBrowserScheduleWithRunLoop(gServiceBrowserRef, CFRunLoopGetCurrent(), kCFRunLoopCommonModes);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     result = CFNetServiceBrowserSearchForServices(gServiceBrowserRef, domain, type, &amp;error);<span></span></pre></td></tr><tr><td scope="row"><pre>     if (result == false) {<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>         // Something went wrong so lets clean up.<span></span></pre></td></tr><tr><td scope="row"><pre>         CFNetServiceBrowserUnscheduleFromRunLoop(gServiceBrowserRef, CFRunLoopGetCurrent(), kCFRunLoopCommonModes);         CFRelease(gServiceBrowserRef);<span></span></pre></td></tr><tr><td scope="row"><pre>         gServiceBrowserRef = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>         fprintf(stderr, "CFNetServiceBrowserSearchForServices returned (domain = %d, error = %ld)\n", error.domain, error.error);<span></span></pre></td></tr><tr><td scope="row"><pre>     }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/30001276-SW13" title="Resolving a Service"></a><h2>Resolving a Service</h2><p>Once you have a name, type and domain, you can resolve the service to retrieve its host name and port. Like registering a service, resolving a service also needs to create a CFNetService reference by calling <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceCreate" target="_top">CFNetServiceCreate</a></code>. Beginning in Mac OS X v10.4, When you call <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceCreate" target="_top">CFNetServiceCreate</a></code> it is important to pass a valid domain that was obtained when the service was first detected. Starting with Mac OS X v10.4, if you pass an empty CFString for the domain argument, Bonjour will not equate it with the domain <code>local.</code> as it did in releases of Mac OS X prior to v10.4.</p><p>If you plan to resolve a service asynchronously, you should then associate the newly created <code>CFNetServiceRef</code> with a callback function, which will receive a <code>CFNetServiceRef</code>, and a pointer to a <code>CFStreamError</code>. The callback association is performed by calling <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceSetClient" target="_top">CFNetServiceSetClient</a></code> and following it with <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceScheduleWithRunLoop" target="_top">CFNetServiceScheduleWithRunLoop</a></code> to add the service to a run loop. To use the current run loop, pass <code><!--a-->CFRunLoopGetCurrent()<!--/a--></code> as a parameter.</p><p>After setting up the run loop, call the function <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceResolve" target="_top">CFNetServiceResolve</a></code>, ensuring that it does not return an error. If an error is returned, then you should clean up all the references you created. Otherwise just wait for your callback functions to be called.</p><p>An example of resolving a service with CFNetService is in <span class="content_text"><a href="CFNetServices.html#//apple_ref/doc/uid/30001276-SW5">Listing 4</a></span>.</p><a name="//apple_ref/doc/uid/30001276-SW5" title="Listing 4Resolving a Service Asynchronously"></a><p class="codesample"><strong>Listing 4&nbsp;&nbsp;</strong>Resolving a Service Asynchronously</p><div class="codesample"><table><tr><td scope="row"><pre>static void MyResolveService(CFStringRef name, CFStringRef type, CFStringRef domain)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CFNetServiceClientContext context = { 0, NULL, NULL, NULL, NULL };<span></span></pre></td></tr><tr><td scope="row"><pre>    CFTimeInterval duration = 0; // use infinite timeout<span></span></pre></td></tr><tr><td scope="row"><pre>    CFStreamError error;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    gServiceBeingResolved = CFNetServiceCreate(kCFAllocatorDefault, domain, type, name, 0);<span></span></pre></td></tr><tr><td scope="row"><pre>    assert(gServiceBeingResolved != NULL);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    CFNetServiceSetClient(gServiceBeingResolved, MyResolveCallback, &amp;context);<span></span></pre></td></tr><tr><td scope="row"><pre>    CFNetServiceScheduleWithRunLoop(gServiceBeingResolved, CFRunLoopGetCurrent(), kCFRunLoopCommonModes);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (CFNetServiceResolveWithTimeout(gServiceBeingResolved, duration, &amp;error) == false) {<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>         // Something went wrong so lets clean up.<span></span></pre></td></tr><tr><td scope="row"><pre>         CFNetServiceUnscheduleFromRunLoop(gServiceBeingResolved, CFRunLoopGetCurrent(), kCFRunLoopCommonModes);<span></span></pre></td></tr><tr><td scope="row"><pre>         CFNetServiceSetClient(gServiceBeingResolved, NULL, NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>         CFRelease(gServiceBeingResolved);<span></span></pre></td></tr><tr><td scope="row"><pre>         gServiceBeingResolved = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>         fprintf(stderr, "CFNetServiceResolve returned (domain = %d, error = %ld)\n", error.domain, error.error);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/30001276-SW14" title="Monitoring a Service"></a><h2>Monitoring a Service</h2><p><code>CFNetServiceMonitor</code>, which debuted in Mac OS X v10.4, gives developers the ability to watch services for changes to their TXT records. In order to monitor a service asynchronously, you need to follow the same general formula that is used for resolving a service.</p><p>Once you have a <code>CFNetServiceRef</code> for a service, you need to create a monitor reference (<code>CFNetServiceMonitorRef</code> using the function <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceMonitorCreate" target="_top">CFNetServiceMonitorCreate</a></code>. Like resolving a service, the next step is to schedule the monitor reference on a run loop with <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceMonitorScheduleWithRunLoop" target="_top">CFNetServiceMonitorScheduleWithRunLoop</a></code>. The default run loop can be obtained by calling <code><!--a-->CFRunLoopGetCurrent()<!--/a--></code>.</p><p>After the monitor reference has been added to a run loop, you can start the monitor with the function <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceMonitorStart" target="_top">CFNetServiceMonitorStart</a></code> passing it the monitor reference. Make sure to check the return value to ensure that the monitor has started.</p><p>When you have finished monitoring a service, call <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceMonitorStop" target="_top">CFNetServiceMonitorStop</a></code> to stop the monitoring, <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceMonitorUnscheduleFromRunLoop" target="_top">CFNetServiceMonitorUnscheduleFromRunLoop</a></code> to unschedule your monitor from its run loop and <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceMonitorInvalidate" target="_top">CFNetServiceMonitorInvalidate</a></code> to destroy the monitor reference.</p><a name="//apple_ref/doc/uid/TP30000229-66670" title="Asynchronous and Synchronous Modes"></a><h2>Asynchronous and Synchronous Modes</h2><p>Several CFNetServices functions can operate in asynchronous or synchronous mode. Scheduling a CFNetService or a CFNetServiceBrowser on a run loop causes the service or browser to operate in asynchronous mode. If a CFNetService or a CFNetServiceBrowser is not scheduled on a run loop, it operates in synchronous mode. Operating in asynchronous mode changes the behavior of functions.</p><p>While it is possible to use the synchronous modes of these functions, please keep in mind that it is unacceptable to block the user interface or other functions of your program while you wait for synchronous functions to return. Due to the arbitrary amount of time network operations may last, it is highly recommended that you use the asynchronous modes of each function.</p><a name="//apple_ref/doc/uid/TP30001132-//apple_ref/doc/uid/TP30000229-66685-BGBBFHAH" title="Table 1Behavior of certain CFNetServices functions in asynchronous and synchronous mode "></a><div class="tableholder"><table class="graybox" border = "0" cellspacing="0" cellpadding="5"><caption class="tablecaption"><a name="//apple_ref/doc/uid/TP30000229-66685" title="Table 1Behavior of certain CFNetServices functions in asynchronous and synchronous mode "></a><strong>Table 1&nbsp;&nbsp;</strong>Behavior of certain CFNetServices functions in asynchronous and synchronous mode </caption><tr><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Function</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Asynchronous mode</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Synchronous mode</p></th></tr><tr><td  scope="row"><p><code><!--a-->CFNetServiceRegisterWithTimeout<!--/a--></code>  (Mac OS X v10.4 only)</p></td><td ><p>Starts the registration and returns. The callback function for the CFNetService will be called to report any errors that occur while the service is running. The service is available on the network until your application cancels the registration.</p></td><td ><p>Blocks until your application cancels the service from another thread or until an error occurs, at which point the function returns. The error is returned in an error structure pointed to by a parameter of the <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceRegisterWithOptions" target="_top">CFNetServiceRegisterWithOptions</a></code> function. The service is available on the network until your application cancels the registration or an error occurs.</p></td></tr><tr><td  scope="row"><p><code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceResolveWithTimeout" target="_top">CFNetServiceResolveWithTimeout</a></code>  (Mac OS X v10.4 only)</p></td><td ><p>Starts the resolution and returns. The callback function for the CFNetService will be called to report any errors that occur during resolution. The resolution process runs until the specified timeout is reached, or, if the timeout was specified as zero, until it is canceled.</p></td><td ><p>Blocks until at least one IP address is found for the service, an error occurs, the time specified as the timeout parameter is reached or your application cancels the resolution, at which point the function returns. If an error occurs, the error is returned in an error structure pointed to by a parameter to the <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceResolveWithTimeout" target="_top">CFNetServiceResolveWithTimeout</a></code> function. The resolution process continues to run until your application cancels it or an error occurs.</p></td></tr><tr><td  scope="row"><p><code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceBrowserSearchForDomains" target="_top">CFNetServiceBrowserSearchForDomains</a></code></p></td><td ><p>Starts the search and returns. The callback function for the CFNetServiceBrowser will be called for each domain that is found and to report any errors that occur while browsing. Browsing continues to run until your application stops the browsing.</p></td><td ><p>Blocks until an error occurs or your application calls <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceBrowserStopSearch" target="_top">CFNetServiceBrowserStopSearch</a></code> at which time, the callback function for the CFNetServiceBrowser will be called for each domain that was found. Any error is returned in an error structure pointed to by a parameter to the <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceBrowserSearchForDomains" target="_top">CFNetServiceBrowserSearchForDomains</a></code> function. Browsing continues until your application stops the browsing.</p></td></tr><tr><td  scope="row"><p><code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceBrowserSearchForServices" target="_top">CFNetServiceBrowserSearchForServices</a></code></p></td><td ><p>Starts the search and returns. The callback function for the CFNetServiceBrowser will be called for each CFNetService that is found and to report any errors that occur while browsing. Browsing continues to run until your application stops the browsing.</p></td><td ><p>Blocks until an error occurs or until your application calls <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceBrowserStopSearch" target="_top">CFNetServiceBrowserStopSearch</a></code> at which time, the callback function for the CFNetServiceBrowser will be called for each CFNetService that was found. Any error is returned in an error structure pointed to by a parameter to the <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceBrowserSearchForServices" target="_top">CFNetServiceBrowserSearchForServices</a></code> function. Browsing continues until your application stops the browsing.</p></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000229-66788" title="Shutting Down Services and Searches"></a><h2>Shutting Down Services and Searches</h2><p>To shut down a service that is running in asynchronous mode, your application unschedules the service from all run loops it may be scheduled on and then calls <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceSetClient" target="_top">CFNetServiceSetClient</a></code> with the <code>clientCB</code> parameter set to <code>NULL</code> to disassociate your callback function from the CFNetService. Then call <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceCancel" target="_top">CFNetServiceCancel</a></code> to stop the service. If the service is running in synchronous mode, you only need to call <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceCancel" target="_top">CFNetServiceCancel</a></code> from another thread.</p><p><span class="content_text"><a href="CFNetServices.html#//apple_ref/doc/uid/30001276-SW4">Listing 5</a></span> shows a good example of how to shut down an asynchronous CFNetService Resolve process which has not timed out.</p><a name="//apple_ref/doc/uid/30001276-SW4" title="Listing 5Canceling an Asynchronous CFNetService Resolve Process"></a><p class="codesample"><strong>Listing 5&nbsp;&nbsp;</strong>Canceling an Asynchronous CFNetService Resolve Process</p><div class="codesample"><table><tr><td scope="row"><pre>void MyCancelResolve()<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>     assert(gServiceBeingResolved != NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceUnscheduleFromRunLoop(gServiceBeingResolved, CFRunLoopGetCurrent(), kCFRunLoopCommonModes);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceSetClient(gServiceBeingResolved, NULL, NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceCancel(gServiceBeingResolved);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFRelease(gServiceBeingResolved);<span></span></pre></td></tr><tr><td scope="row"><pre>     gServiceBeingResolved = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>     return;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>To shut down a browser that is running in asynchronous mode, your application unschedules the browser from all run loops it may be scheduled on and then calls <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceBrowserInvalidate" target="_top">CFNetServiceBrowserInvalidate</a></code>. Then your application calls <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceBrowserStopSearch" target="_top">CFNetServiceBrowserStopSearch</a></code>. If the browser is running in synchronous mode, you only need to call <code><a href="../../../../CoreFoundation/Reference/CFNetServiceRef/Reference/reference.html#//apple_ref/doc/c_ref/CFNetServiceBrowserStopSearch" target="_top">CFNetServiceBrowserStopSearch</a></code>. An example of these functions can be seen in <span class="content_text"><a href="CFNetServices.html#//apple_ref/doc/uid/30001276-SW6">Listing 6</a></span>.</p><a name="//apple_ref/doc/uid/30001276-SW6" title="Listing 6Stop Browsing for Services"></a><p class="codesample"><strong>Listing 6&nbsp;&nbsp;</strong>Stop Browsing for Services</p><div class="codesample"><table><tr><td scope="row"><pre>static void MyStopBrowsingForServices()<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>     assert(gServiceBrowserRef != NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceBrowserStopSearch(gServiceBrowserRef, &amp;streamerror);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceBrowserUnscheduleFromRunLoop(gServiceBrowserRef, CFRunLoopGetCurrent(), kCFRunLoopCommonModes);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceBrowserInvalidate(gServiceBrowserRef);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFRelease(gServiceBrowserRef);<span></span></pre></td></tr><tr><td scope="row"><pre>     gServiceBrowserRef = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>     return;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>

        <br/><br/> 

        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="ResolvingServices.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../RevisionHistory.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2008 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2008-10-15<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Networking/Conceptual/NSNetServiceProgGuide/Articles/CFNetServices.html%3Fid%3DTP40002736-1.2&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Networking/Conceptual/NSNetServiceProgGuide/Articles/CFNetServices.html%3Fid%3DTP40002736-1.2&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Networking/Conceptual/NSNetServiceProgGuide/Articles/CFNetServices.html%3Fid%3DTP40002736-1.2&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>
