<HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><script language="JavaScript" src="frametest.js"></script><TITLE> Explicit IST Extension</TITLE></HEAD><BODY BGCOLOR="#ffffff"><DIV><a name="top"></a><!-- start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!-- start of path --><font face="Geneva,Helvetica,Arial" size="1"><b><br>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Documentation</a> &gt; <!-- a href="" target="_top" -->Hardware<!-- /a -->  <b>&gt; </b><a href="../../devicemgrs.html" target="_top">Device Managers and Drivers</a> <b>&gt; </b><a href="../pci_srvcs.html" target="_top">PCI Card Services</a> <b>&gt; </b>Designing PCI Cards and Drivers for Power Macintosh Computers</font><br><br><!-- end of path --><A HREF="PCI_BOOK.177.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.179.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.17b.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><HR></DIV><H1 CLASS="H3.Heading3"><A NAME="pgfId=4304"> </A><A NAME="28789"> </A>Explicit IST Extension</H1><P CLASS="T1.Text1"><A NAME="pgfId=4306"> </A>By the time the PCI devices built into the Macintosh system are initialized, an <A NAME="marker=4305"> </A>IST has been constructed and populated with nodes for every interrupt source within the system, including all PCI expansion cards and PCI-to-PCI bridges that use the default PCI bridge IST extensions. </P><P CLASS="T1.Text1"><A NAME="pgfId=4307"> </A>However, PCI expansion devices that cannot use the default PCI bridge IST extensions or that have special requirements will not automatically receive nodes in the IST. Examples of such devices are multifunction cards with non-PCI controller devices and PCI-to-NuBus expansion chassis. Because these devices still represent additions to the system hardware, the third-party driver writer needs to provide software that extends both the Name Registry and the Apple-provided IST. </P><DIV><blockquote><H4 CLASS="NoteHead"><A NAME="pgfId=19149"> </A>Note</H4><P CLASS="Note"><A NAME="pgfId=4308"> </A>PCI-to-NuBus expansion bus cards are a special case. NuBus devices are controlled by 68K drivers and so require the Macintosh facilities normally provided for NuBus devices. The interrupt handler for the PCI-to-NuBus bridge must use or provide Slot Manager dispatching and interrupt registration for NuBus device drivers. The initialization of a PCI-to-NuBus bridge does not need to extend the Registry or the IST. </P></blockquote><P CLASS="T1.Text1"><A NAME="pgfId=4312"> </A>If you are extending the system by means of PCI bus slots or a multifunction device, the work to be done includes several basic steps: </P><UL><LI CLASS="B1.Bullet1"><A NAME="pgfId=4313"> </A>When the device initialization code is first invoked, it will be passed the <TT CLASS="cv">RegEntryID</TT> value of the Registry node that represents the PCI expansion slot that the device occupies. Use the <TT CLASS="cv">RegistryPropertyGet</TT> function to get the <TT CLASS="cv">driver-ist</TT> property for the PCI expansion slot, which will have the <TT CLASS="cv">InterruptSetMember</TT> value for the slot's interrupts.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=4314"> </A>Pay particular attention to the fact that the parent (or bridge or multifunction) initialization code must be marked as initialize and open upon discovery. This is a requirement because extension devices must be available in the Name Registry before family experts are run. If this requirement is not met, extension devices may not be made available to the system because their child devices will not be found. Initialize and open upon discovery is described in <A HREF="PCI_BOOK.ba.html#25315" CLASS="XRef">Driver Run-Time Structure</A>.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=4318"> </A>Use the <TT CLASS="cv">GetInterruptFunctions</TT> function with the slot's <TT CLASS="cv">InterruptSetMember</TT> value to get the default IDR registered with the parent member. Call the IDR to disable the parent member's interrupt propagation. This keeps spurious interrupts from occurring before the IST extension is complete.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=4319"> </A>The device initialization code must extend the IST. Use the <TT CLASS="cv">CreateInterruptSet</TT> function to create a new interrupt set with the slot's <TT CLASS="cv">InterruptSetMember</TT> value as the parent member. Make the interrupt set size the same as the number of new PCI bus slots or the number of functions (in a multifunction device). </LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=4320"> </A>Register a transversal ISR with the parent member, using the slot's <TT CLASS="cv">InterruptSetMember</TT> value. When invoked, this transversal ISR should further route the slot interrupt to one of the interrupt members in the newly created interrupt set.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=4321"> </A>If the device's interrupt controller hardware can enable and disable interrupts for each of the interrupt members in the new interrupt set, register tailored IERs and IDRs with each of the interrupt members. Otherwise, the IER and IDR that the interrupt members inherited from the parent member will moderate interrupts transparently to the caller.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=4322"> </A>For each additional device or function, a node must also be added to the Name Registry. Adding nodes to the Registry is described in <A HREF="PCI_BOOK.113.html#27191" CLASS="XRef">Name Creation and Deletion</A>. </LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=4326"> </A>Each new child entry in the Registry requires a complete set of properties to allow the device to be located by its family experts. A complete set of properties is the set of properties described by and installed by Open Firmware. For details, see the Open Firmware standard and <A HREF="PCI_BOOK.12e.html#17372" CLASS="XRef">Table&nbsp;10-1</A>. </LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=4330"> </A>In addition to the Open Firmware requirements, each new child entry in the Registry must also have a <TT CLASS="cv">driver-ist</TT> property installed. This lets subsequent drivers that want to register an ISR with one of the newly created interrupt members find the correct <TT CLASS="cv">InterruptSetMember</TT> value.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=4333"> </A>Create properties using the rules described in the previous section and in <A HREF="PCI_BOOK.122.html#13991" CLASS="XRef">Property Management</A>. For each new child entry in the Registry, create a <TT CLASS="cv">driver-ist</TT> property with the corresponding new interrupt members that were used to extend the IST.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=4335"> </A>Call the IDR for each of the newly created interrupt members to keep spurious interrupts from occurring.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=4336"> </A>Call the IER for the parent member to enable interrupts for the system extension as a whole.</LI></UL></DIV><DIV><blockquote><H4 CLASS="NoteHead"><A NAME="pgfId=19151"> </A>Note</H4><P CLASS="Note"><A NAME="pgfId=4337"> </A>There will always be at least one new interrupt member created for each new child entry in the Name Registry. However, keep in mind that the <TT CLASS="cv">driver-ist</TT> property is a logical grouping of interrupt members for a device or function. Because of this grouping, you might end up creating more interrupt members than child entries in the Registry. </P></blockquote><P CLASS="T1.Text1"><A NAME="pgfId=4341"> </A>Native drivers can now be loaded against any of the new devices, as created by the extension to the IST and the Name Registry, just like other native drivers.</P></DIV><HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 26 March 99)<P><A HREF="PCI_BOOK.177.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.179.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.17b.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>