<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Summary of AFP(IM:N)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING234></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Networking-233.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-235.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Networking-2.html"><B>Networking</B></A> / <BR><DD><A HREF="Networking-223.html"><B>Chapter 9 - AppleTalk Filing Protocol (AFP)</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING234-0></A>
<H1>Summary of AFP</H1>
<A NAME=HEADING234-1></A>
<H2>Pascal Summary</H2>
<A NAME=HEADING234-2></A>
<H3>Constants</H3>
<PRE>
CONST
   {.XPP Driver unit and reference numbers}
   xppUnitNum      =    40;         {XPP unit number}
   xppRefNum       =    -41;        {XPP reference number}
   afpCall         =    250;        {AFP call command. Command buffer }
                                    { contains code for the command to be }
                                    { executed}
   {AFP command codes}
   afpByteRangeLock  =  1;                   
   afpVolClose       =  2;
   afpDirClose       =  3;
   afpForkClose      =  4;
   afpCopyFile       =  5; 
   afpDirCreate      =  6;
   afpFileCreate     =  7;
   afpDelete         =  8;
   afpEnumerate      =  9;
   afpFlush          =  10;
   afpForkFlush      =  11;
   afpGetDirParms    =  12;
   afpGetFileParms   =  13;
   afpGetForkParms   =  14;
   afpGetSInfo       =  15;
   afpGetSParms      =  16;
   afpGetVolParms    =  17;
   afpLogin          =  18;
   afpContLogin      =  19;
   afpLogout         =  20;
   afpMapID          =  21;
   afpMapName        =  22;
   afpMove           =  23;
   afpOpenVol        =  24;
   afpOpenDir        =  25;
   afpOpenFork       =  26;
   afpRead           =  27;
   afpRename         =  28;
   afpSetDirParms    =  29;
   afpSetFileParms   =  30;
   afpSetForkParms   =  31;
   afpSetVolParms    =  32;
   afpWrite          =  33;
   afpGetFlDrParms   =  34;
   afpSetFlDrParms   =  35;
   afpDTOpen         =  48;
   afpDTClose        =  49;
   afpGetIcon        =  51;
   afpGtIcnInfo      =  52;
   afpAddAPPL        =  53;
   afpRmvAPPL        =  54;
   afpGetAPPL        =  55;
   afpAddCmt         =  56;
   afpRmvCmt         =  57;
   afpGetCmt         =  58;
   afpAddIcon        =  192;     {special code for ASP write commands}

   {miscellaneous}
   xppLoadedBit      =  5;       {XPP bit in PortBUse}
   scbMemSize        =  192;     {size of memory for SCB}
   
   {constants for AFP command block startEndFlag &amp; newLineFlag fields}
   xppFlagClr        =  0;       
   xppFlagSet        =  128;        
</PRE>
<A NAME=HEADING234-4></A>
<H3>Data Types</H3>
<A NAME=HEADING234-5></A>
<H4>Command Block for AFP Read and AFP Write Commands</H4>
<PRE>
TYPE AFPCommandBlock = 
   PACKED RECORD
      cmdByte:          Byte;       {AFP command}
      startEndFlag:     Byte;       {flag identifying offset relative }
                                    { to fork}
      forkRefNum:       Integer;    {reserved}
      rwOffset:         LongInt;    {offset within fork to begin }
                                    { reading or writing}
      reqCount:         LongInt;    {on input, size of the data buffer; }
                                    { on return, size of the data actually }
                                    { written or read}
      newLineFlag:      Byte;       {for read, a flag indicating whether }
                                    { the read is to be terminated at }
                                    { a specific character; not used by }
                                    { write}
      newLineChar:      Char;       {character used to determine where }
                                    { the read is to be terminated; not }
                                    { used by write}
   END;
</PRE>
<A NAME=HEADING234-7></A>
<H4>XPP Parameter Block for AFP</H4>
<PRE>
XPPPrmBlkType = (XPPPrmBlk...);
XPPSubPrmType = (ASPOpenPrm,ASPSubPrm);
XPPEndPrmType = (AFPLoginPrm,ASPEndPrm);
TYPE XPPParamBlock = 
   PACKED RECORD
      qLink:               QElemPtr;      {reserved}
      qType:               Integer;       {reserved}
      ioTrap:              Integer;       {reserved}
      ioCmdAddr:           Ptr;           {reserved}
      ioCompletion:        ProcPtr;       {completion routine}
      ioResult:            OSErr;         {result code}
      cmdResult:           LongInt;       {command result (ATP user bytes)}
      ioVRefNum:           Integer;       {reserved}
      ioRefNum:            Integer;       {driver reference number}
      csCode:              Integer;       {command code}
   CASE XPPPrmBlkType OF
      XPPPrmBlk:
         (sessRefnum:      Integer;       {offset to session refnum}
         aspTimeout:       Byte;          {timeout for ATP}
         aspRetry:         Byte;          {retry count for ATP}
   CASE XPPSubPrmType OF
      ASPOpenPrm:
         (serverAddr:      AddrBlock;     {server address block}
         scbPointer:       Ptr;           {SCB pointer}
         attnRoutine:      Ptr);          {attention routine pointer}
      ASPSubPrm:
         (cbSize:          Integer;       {command block size}
         cbPtr:            Ptr;           {command block pointer}
         rbSize:           Integer;       {reply buffer size}
         rbPtr:            Ptr;           {reply buffer pointer}
   CASE XPPEndPrmType OF
      AFPLoginPrm:
         (afpAddrBlock:    AddrBlock;     {address block in AFP login}
         afPSCBPtr:        Ptr;           {SCB pointer in AFP login}
         afpAttnRoutine:   Ptr);          {attn routine pointer in AFP login}
      ASPEndPrm:
         (wdSize:          Integer;       {write data size}
         wdPtr:            Ptr;           {write data pointer}
         ccbStart:         ARRAY[0..295] OF Byte)));              
                                          {command control block}
   END;
XPPParmBlkPtr = ^XPPParamBlock;

XPPPrmBlkType = (XPPPrmBlk...);
XPPSubPrmType = (ASPOpenPrm,ASPSubPrm);
XPPEndPrmType = (AFPLoginPrm,ASPEndPrm);
</PRE>
<A NAME=HEADING234-11></A>
<H3>Routines</H3>
<PRE>
FUNCTION AFPCommand(thePBptr: XPPParmBlkPtr; async: Boolean): OSErr;
</PRE>
<A NAME=HEADING234-13></A>
<H2>C Summary</H2>
<A NAME=HEADING234-14></A>
<H3>Constants</H3>
<PRE>
enum {
   afpCall     = 250             /*AFP command (buffer has command code)*/
};

enum {                           /*AFPCall command codes*/
   afpFlush          = 10,
   afpForkFlush      = 11,       
   afpGetDirParms    = 12,       
   afpGetFileParms   = 13,       
   afpGetForkParms   = 14,       
   afpGetSInfo       = 15,       
   afpGetSParms      = 16,       
   afpGetVolParms    = 17,       
   afpLogin          = 18,       
   afpContLogin      = 19,       
   afpLogout         = 20,       
   afpMapID          = 21,          
   afpMapName        = 22,       
   afpMove           = 23,       
   afpOpenVol        = 24,       
   afpOpenDir        = 25,       
   afpOpenFork       = 26,       
   afpRead           = 27,       
   afpRename         = 28,       
   afpSetDirParms    = 29        
};
enum {                           /*AFPCall command codes*/
   afpSetFileParms   = 30,       
   afpSetForkParms   = 31,       
   afpSetVolParms    = 32,       
   afpWrite          = 33,       
   afpGetFlDrParms   = 34,       
   afpSetFlDrParms   = 35,       
   afpDTOpen         = 48,       
   afpDTClose        = 49,       
   afpGetIcon        = 51,       
   afpGtIcnInfo      = 52,       
   afpAddAPPL        = 53,       
   afpRmvAPPL        = 54,       
   afpGetAPPL        = 55,       
   afpAddCmt         = 56,
   afpRmvCmt         = 57,       
   afpGetCmt         = 58,       
   afpAddIcon        = 192       /*special code for ASP write commands*/
};
enum {
   xppLoadedBit      = 5,        /*XPP bit in PortBUse*/
   scbMemSize        = 192,      /*size of memory for SCB*/
   xppFlagClr        = 0         /*cs for AFPCommandBlock*/
};

enum {
xppFlagSet           = 128}      /*startEndFlag &amp; NewLineFlag fields*/
};    
</PRE>
<A NAME=HEADING234-18></A>
<H3>Data Types</H3>
<A NAME=HEADING234-19></A>
<H4>Command Block for AFP Read and AFP Write Commands</H4>
<PRE>
typedef struct {
   char  cmdByte;             /*AFP command*/
   char  startEndFlag;        /*flag identifying offset relative to fork*/
   short forkRefNum;          /*reserved*/
   long  rwOffset;            /*offset within fork to begin reading */
                              /* or writing*/
   long  reqCount;            /*on input, size of the data buffer; */
                              /* on return, size of the data actually */
                              /* written or read*/
   char  newLineFlag;         /*for read, a flag indicating whether the */
                              /* read is to be terminated at a specific */
                              /* character; not used by write*/
   char  newLineChar;         /*character used to determine where the read */
                              /* is to be terminated; not used by write*/
} AFPCommandBlock;
</PRE>
<A NAME=HEADING234-21></A>
<H4>XPP Parameter Block for AFP</H4>
<PRE>
#define  XPPPBHeader\
   QElem    *qLink;           /*reserved*/\
   short    qType;            /*reserved*/\
   short    ioTrap;           /*reserved*/\
   Ptr      ioCmdAddr;        /*reserved*/\
   ProcPtr  ioCompletion;     /*completion routine*/\
   OSErr    ioResult;         /*result code*/\
   long     cmdResult;        /*command result*/\
   short    ioVRefNum;        /*reserved*/\
   short    ioRefNum;         /*.XPP driver reference number*/\
   short    csCode;           /*function code*/

typedef struct {
   XPPPBHeader 
   short    sessRefnum;       /*offset to session refnum*/
   char     aspTimeout;       /*timeout for ATP*/
   char     aspRetry;         /*retry count for ATP*/
   short    cbSize;           /*command block size*/
   Ptr      cbPtr;            /*command block pointer*/
   short    rbSize;           /*reply buffer size*/
   Ptr      rbPtr;            /*reply buffer pointer*/
   short    wdSize;           /*write data size*/
   Ptr      wdPtr;            /*write data pointer*/
   char     ccbStart[296];    /*beginning of command control block */
                              /* (CCB)*/
}XPPPrmBlk;
typedef struct {
   XPPPBHeader
   short       sessRefnum;       /*offset to session refnum*/
   char        aspTimeout;       /*timeout for ATP*/
   char        aspRetry;         /*retry count for ATP*/
   short       cbSize;           /*command block size*/
   Ptr         cbPtr;            /*command block pointer*/
   short       rbSize;           /*reply buffer size*/
   Ptr         rbPtr;            /*reply buffer pointer*/
   AddrBlock   afpAddrBlock;     /*block in AFP login*/
   Ptr         afpSCBPtr;        /*SCB pointer in AFP login*/
   Ptr         afpAttnRoutine;   /*attn routine pointer in AFP login*/
   char        ccbFill[144];     /*beginning of command control block*/
}AFPLoginPrm;                                         
typedef struct {
   XPPPBHeader
   short       sessRefnum;       /*offset to session refnum*/
   char        aspTimeout;       /*timeout for ATP*/
   char        aspRetry;         /*retry count for ATP*/
   AddrBlock   serverAddr;       /*server address block*/
   Ptr         scbPointer;       /*SCB pointer*/
   Ptr         attnRoutine;      /*attention routine pointer*/
} ASPOpenPrm;

typedef ASPOpenPrm *ASPOpenPrmPtr;
</PRE>
<A NAME=HEADING234-25></A>
<H3>Routines</H3>
<PRE>
pascal OSErr AFPCommand(XPPParmBlkPtr thePBptr, Boolean async); 
</PRE>
<A NAME=HEADING234-27></A>
<H2><A NAME=MARKER-9-85></A>Assembly-Language Summary</H2>
<A NAME=HEADING234-28></A>
<H3>Constants</H3>
<A NAME=HEADING234-29></A>
<H4>XPP Driver Unit Number</H4>
<PRE>
xppUnitNum           EQU         40                ;XPP unit number
xppLoadedBit         EQU         atpLoadedBit+1    ;XPP loaded bit number in
                                                   ; PortBUse
</PRE>
<A NAME=HEADING234-31></A>
<H4>AFP Control Code</H4>
<PRE>
afpCall              EQU         250               ;AFP csCode
</PRE>
<A NAME=HEADING234-33></A>
<H4>AFP Command Codes</H4>
<PRE>
afpByteRangeLock     EQU      1
afpVolClose          EQU      2
afpDirClose          EQU      3
afpForkClose         EQU      4
afpCopyFile          EQU      5
afpDirCreate         EQU      6
afpFileCreate        EQU      7
afpDelete            EQU      8
afpEnumerate         EQU      9
afpFlush             EQU      10
afpForkFlush         EQU      11
afpGetDirParms       EQU      12
afpGetFileParms      EQU      13
afpGetForkParms      EQU      14
afpGetSInfo          EQU      15
afpGetSParms         EQU      16
afpGetVolParms       EQU      17
afpLogin             EQU      18
afpContLogin         EQU      19
afpLogout            EQU      20
afpMapID             EQU      21
afpMapName           EQU      22
afpMove              EQU      23
afpOpenVol           EQU      24
afpOpenDir           EQU      25
afpOpenFork          EQU      26
afpRead              EQU      27
afpRename            EQU      28
afpSetDirParms       EQU      29
afpSetFileParms      EQU      30
afpSetForkParms      EQU      31
afpSetVolParms       EQU      32
afpWrite             EQU      33
afpGetFlDrParms      EQU      34
afpSetFlDrParms      EQU      35

afpDTOpen            EQU      48
afpDTClose           EQU      49
afpGetIcon           EQU      51
afpGtIcnInfo         EQU      52
afpAddAPPL           EQU      53
afpRmvAPPL           EQU      54
afpGetAPPL           EQU      55
afpAddCmt            EQU      56
afpRmvCmt            EQU      57
afpGetCmt            EQU      58

afpAddIcon           EQU   192      ;special code for ASP write commands
</PRE>
<A NAME=HEADING234-35></A>
<H4>Miscellaneous</H4>
<PRE>
afpUseWrite    EQU   $C0            ;first call in range that maps to an
                                    ; ASPWrite
</PRE>
<A NAME=HEADING234-37></A>
<H3>Data Structures</H3>
<A NAME=HEADING234-38></A>
<H4>Parameter Block for General Command Format
<TABLE BORDER="0" CELLPADDING=3><TD>18<TD>cmdResult<TD>long<TD>AFP command result<TR>
<TD>26<TD>csCode<TD>word <TD>command code; always <CODE>afpCall</CODE><TR>
<TD>28<TD>sessRefnum<TD>word <TD>session reference number<TR>
<TD>30<TD>aspTimeout<TD>byte<TD>retry interval in seconds<TR>
<TD>32<TD>cbSize<TD>word <TD>command buffer size<TR>
<TD>34<TD>cbPtr<TD>pointer<TD>command buffer<TR>
<TD>38<TD>rbSize<TD>word<TD>reply buffer size and actual reply size<TR>
<TD>40<TD>rbPtr<TD>pointer<TD>reply buffer pointer<TR>
<TD>44<TD>wdSize<TD>word<TD>write data size<TR>
<TD>46<TD>wdPtr<TD>pointer<TD>write data pointer<TR>
<TD>50<TD>ccbStart<TD>record<TD>beginning of memory for CCB</TABLE>
</H4>
<A NAME=HEADING234-39></A>
<H4>Parameter Block for Login Command Format
<TABLE BORDER="0" CELLPADDING=3><TD>18<TD>cmdResult<TD>long<TD>AFP command result<TR>
<TD>26<TD>csCode<TD>word <TD>command code; always<CODE>afpCall</CODE><TR>
<TD>28<TD>sessRefnum<TD>word <TD>session reference number<TR>
<TD>30<TD>aspTimeout<TD>byte<TD>retry interval in seconds<TR>
<TD>31<TD>aspRetry<TD>byte<TD>number of retries<TR>
<TD>32<TD>cbSize<TD>word <TD>command buffer size<TR>
<TD>34<TD>cbPtr<TD>pointer<TD>command buffer<TR>
<TD>38<TD>rbSize<TD>word<TD>reply buffer size and actual reply size<TR>
<TD>40<TD>rbPtr<TD>pointer<TD>reply buffer pointer<TR>
<TD>44<TD>afpAddrBlock<TD>long<TD>server address block<TR>
<TD>48<TD>afpSCBPtr<TD>pointer<TD>SCB pointer<TR>
<TD>52<TD>afpAttnRoutine<TD>pointer<TD>attention routine pointer<TR>
<TD>50<TD>ccbStart<TD>record<TD>beginning of memory for CCB</TABLE>
</H4>
<A NAME=HEADING234-40></A>
<H4>Parameter Block for AFP Write Command Format
<TABLE BORDER="0" CELLPADDING=3><TD>18<TD>cmdResult<TD>long<TD>AFP command result<TR>
<TD>26<TD>csCode<TD>word <TD>command code; always <CODE>afpCall</CODE><TR>
<TD>28<TD>sessRefnum<TD>word <TD>session reference number<TR>
<TD>30<TD>aspTimeout<TD>byte<TD>retry interval in seconds<TR>
<TD>32<TD>cbSize<TD>word <TD>command buffer size<TR>
<TD>34<TD>cbPtr<TD>pointer<TD>command buffer<TR>
<TD>38<TD>rbSize<TD>word<TD>reply buffer size and actual reply size<TR>
<TD>40<TD>rbPtr<TD>pointer<TD>reply buffer pointer<TR>
<TD>44<TD>wdSize<TD>word<TD>used internally<TR>
<TD>46<TD>wdPtr<TD>pointer<TD>write data pointer, updated<TR>
<TD>50<TD>ccbStart<TD>record<TD>beginning of memory for CCB</TABLE>
</H4>
<A NAME=HEADING234-41></A>
<H4>Command Block for the AFP Write Command
<TABLE BORDER="0" CELLPADDING=3><TD>0<TD>cmdByte<TD>byte<TD>AFP command code<TR>
<TD>1<TD>startEndFlag<TD>byte<TD>start/end flag<TR>
<TD>4<TD>rwOffset<TD>long<TD>offset within fork to begin writing<TR>
<TD>8<TD>reqCount<TD>long<TD>on input, requested size of data; on return, <BR>size of data actually written<TR>
<TD>12<TD>newLineFlag<TD>byte<TD>new line flag<TR>
<TD>13<TD>newLineChar<TD>byte<TD>new line character</TABLE>
</H4>
<A NAME=HEADING234-42></A>
<H4>Parameter Block for AFP Read Command Format
<TABLE BORDER="0" CELLPADDING=3><TD>18<TD>cmdResult<TD>long<TD>AFP command result<TR>
<TD>26<TD>csCode<TD>word <TD>command code; always <CODE>afpCall</CODE><TR>
<TD>28<TD>sessRefnum<TD>word <TD>session reference number<TR>
<TD>30<TD>aspTimeout<TD>byte<TD>retry interval in seconds<TR>
<TD>32<TD>cbSize<TD>word <TD>command buffer size<TR>
<TD>34<TD>cbPtr<TD>pointer<TD>command buffer<TR>
<TD>38<TD>rbSize<TD>word<TD>used internally<TR>
<TD>40<TD>rbPtr<TD>pointer<TD>reply buffer pointer (updated)<TR>
<TD>50<TD>ccbStart<TD>record<TD>beginning of memory for CCB</TABLE>
</H4>
<A NAME=HEADING234-43></A>
<H4>Command Block for the AFP Read Command
<TABLE BORDER="0" CELLPADDING=3><TD>0<TD>cmdByte<TD>byte<TD>AFP command code<TR>
<TD>1<TD>startEndFlag<TD>byte<TD>flag identifying offset relative to fork<TR>
<TD>4<TD>rwOffset<TD>long<TD>offset within fork to begin reading<TR>
<TD>8<TD>reqCount<TD>long<TD>on input, requested size of data; on return, size of data actually read into the buffer</TABLE>
</H4>
<A NAME=HEADING234-44></A>
<H2>Result Codes
<TABLE BORDER="0" CELLPADDING=3><TD>aspBadVersNum<TD>-1066<TD>The server cannot support the ASP version number<TR>
<TD>aspBufTooSmall<TD>-1067<TD>The command reply from the server is larger than the response buffer (ASP will fill the buffer and truncate the reply data)<TR>
<TD>aspNoMoreSess<TD>-1068<TD>The .XPP driver cannot support another ASP session<TR>
<TD>aspNoServers<TD>-1069<TD>There is not a server at the specified server address, or the server <BR>did not respond to the request<TR>
<TD>aspParamErr<TD>-1070<TD>You specified an invalid session reference number, or the session <BR>has been closed<TR>
<TD>aspServerBusy<TD>-1071<TD>The server cannot open another session<TR>
<TD>aspSessClosed<TD>-1072<TD>The .XPP driver is in the process of closing the session<TR>
<TD>aspSizeErr<TD>-1073<TD>The size of the command block exceeds the maximum size <BR>of <CODE>aspMaxCmdSize<A NAME=MARKER-9-37></A></CODE><TR>
<TD>afpParmError<TD>-5019<TD>The AFP command block size is equal to 0 (this error is also <BR>returned when the command block is equal to 0 or $FF [255] or <CODE>GetSrvrStatus</CODE> [15])</TABLE>
</H2>
 <P>
</BLOCKQUOTE><P>

</BLOCKQUOTE>
<HR>
<center>
<A HREF="Networking-233.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-235.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Networking-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
