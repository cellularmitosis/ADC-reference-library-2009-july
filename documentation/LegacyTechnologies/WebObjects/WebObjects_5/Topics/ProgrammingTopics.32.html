<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML EXPERIMENTAL 970324//EN"><HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><TITLE> Executing Arbitrary SQL Statements</TITLE></HEAD><BODY bgcolor="#ffffff">		<!-- start of header -->		<!--#include virtual="/includes/framesetheader" -->		<!-- end of header --><!-- start of path --><table cellspacing=0 border=0 width=600 valign="left"><tr><td scope="row"><font face="Geneva,Helvetica,Arial" size="1"><b>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="../../index.html" target="_top">Documentation</a> <b>></b> <a href="../webobjects.html" target="_top">WebObjects</a></font></td></tr></table><br><!-- end of path --><DIV><a name="top"></a><A HREF="TopicsTOC.html"><img src="up.gif" border="0" alt="Up"></A><nobr>&nbsp;</nobr><A HREF="ProgrammingTopics.31.html"><img src="previous.gif" border="0" alt="Previous"></A><nobr>&nbsp;</nobr><A HREF="ProgrammingTopics.33.html"><img src="next.gif" border="0" alt="Next"></A></DIV><H1 CLASS="TopictTitle"><A NAME="pgfId=606100"> </A><A NAME="35319"> </A>Executing Arbitrary SQL Statements</H1><DIV><H2 CLASS="Synopsis"><A NAME="pgfId=608846"> </A>Synopsis</H2><P CLASS="Body"><A NAME="pgfId=608847"> </A>Describes how to execute arbitrary SQL statements, including statements with <TT CLASS="Code">GROUP BY</TT> and <TT CLASS="Code">HAVING</TT>.</P></DIV><DIV><H2 CLASS="Heading1"><A NAME="pgfId=606103"> </A>Description</H2><P CLASS="Body"><A NAME="pgfId=606104"> </A>Enterprise Objects Framework (EOF) allows you to send arbitrary SQL statements using the adaptor sublayer. This topic presents two methods for sending arbitrary SQL: sending it with the EOAdaptorChannel or using the EOUtilities abstract class convenience API. EOUtilities is a category on EOEditingContext in Objective-C.</P><DIV><H3 CLASS="Heading2"><A NAME="pgfId=617079"> </A><A NAME="10792"> </A>Executing Arbitrary SQL Using the Adaptor Sublayer</H3><P CLASS="Body"><A NAME="pgfId=617080"> </A>The EOAdaptorChannel <TT CLASS="Code">evaluateExpression</TT> method is used to send the SQL to the database server. Thus, you need access or create an adaptor channel. See the programming topics <A HREF="ProgrammingTopics.30.html#27044" CLASS="XRef">Accessing Adaptor Sublayer Objects</A>, <A HREF="ProgrammingTopics.31.html#17565" CLASS="XRef">Creating Adaptor Sublayer Objects and Connecting Them to the Server</A>, and <A HREF="ProgrammingTopics.33.html#24267" CLASS="XRef">Accessing Schema Information from the Database Server</A> for more information about getting the adaptor channel.</P><P CLASS="Body"><A NAME="pgfId=617101"> </A>The sample Java code below shows how to use the <TT CLASS="Code">evaluateExpression</TT> method for a SQL statement that returns rows. If the statement doesn't return rows, omit the <TT CLASS="Code">do...while</TT> loop.</P><PRE CLASS="Code"><A NAME="pgfId=617105"> </A>EOAdaptorChannel myChannel; // assume this exists<A NAME="pgfId=617111"> </A>String sqlString;           // assume exists<A NAME="pgfId=617112"> </A>NSDictionary row;<A NAME="pgfId=617113"> </A><A NAME="pgfId=617114"> </A>EOSQLExpression expression = EOSQLExpression.expressionForString(sqlString);<A NAME="pgfId=617115"> </A><A NAME="pgfId=617207"> </A>myChannel.openChannel();<A NAME="pgfId=617120"> </A>try {<A NAME="pgfId=617121"> </A>    myChannel.evaluateExpression(expression);<A NAME="pgfId=617122"> </A>    do {<A NAME="pgfId=617126"> </A>        myChannel.setAttributesToFetch(myChannel.describeResults());<A NAME="pgfId=617127"> </A>        while ((row = myChannel.fetchRow()) != null) {<A NAME="pgfId=617128"> </A>            // Process the row<A NAME="pgfId=617129"> </A>        }<A NAME="pgfId=617130"> </A>    } while (myChannel.isFetchInProgress()); // Process next result set<A NAME="pgfId=617131"> </A>} catch (Exception exception) {<A NAME="pgfId=617135"> </A>    // Handle the exception<A NAME="pgfId=617136"> </A>}</PRE><P CLASS="Body"><A NAME="pgfId=617268"> </A>The code first converts the SQL string to an EOSQLExpression object needed by the <TT CLASS="Code">evaluateExpression</TT> method. Note that the SQL expression must be valid on the database server. EOF performs no substitution or formatting on the SQL expression.</P><P CLASS="Body"><A NAME="pgfId=617171"> </A>The code invokes <TT CLASS="Code">openChannel</TT> method to establish a connection to the database. You must open the adaptor channel before you perform any database operations with it. The <TT CLASS="Code">evaluateExpression</TT> invocation sends the SQL expression to the server. The outer <TT CLASS="Code">do</TT> loop iterates over result sets (what?). In order to form raw row dictionaries, the channel sets the attributes that it will fetch using the <TT CLASS="Code">setAttributesToFetch</TT> method. The <TT CLASS="Code">describeResults</TT> method determines these attributes from the <TT CLASS="Code">evaluteExpression</TT> results. the inner <TT CLASS="Code">while</TT> loop iterates over the raw rows returned from the database server.</P><P CLASS="Body"><A NAME="pgfId=617246"> </A>Each row returned is an NSDictionary whose keys are Strings (NSStrings in Objective-C) containing adaptor-dependent attribute names. For example, in Oracle, the keys are generated sequentially starting with &quot;Attribute0&quot; corresponding to the first value that is returned in your SQL <TT CLASS="Code">SELECT</TT> statement, &quot;Attribute1&quot; corresponding to the second, and so on. The types of the values depend on the corresponding database types and the adaptor's default type mapping. For example, VARCHAR types are mapped to Strings (NSStrings in Objective-C). For more information about type mapping, see the documentation about the specific adaptor you are using.</P></DIV><DIV><H3 CLASS="Heading2"><A NAME="pgfId=606106"> </A>Executing Arbitrary SQL Using EOUtilities</H3><P CLASS="Body"><A NAME="pgfId=606108"> </A>EOUtilities allows you to execute raw SQL when you are working with the control layer. To use EOUtilities, you need to have an EOEditingContext and an EOModel. The following code uses EOUtilities to send raw SQL to the database server.</P><PRE CLASS="Code"><A NAME="pgfId=614225"> </A>String sqlString; // Assume exists<A NAME="pgfId=617140"> </A>String modelName; // Assume exists<A NAME="pgfId=614231"> </A>NSArray results;<A NAME="pgfId=614233"> </A>try {<A NAME="pgfId=617159"> </A>    results = EOUtilities.rawRowsForSQL<A NAME="pgfId=617160"> </A>        (this.session().defaultEditingContext(),sqlString,modelName);<A NAME="pgfId=614239"> </A>} catch (Exception exception) {<A NAME="pgfId=614245"> </A>    // Handle exception<A NAME="pgfId=617166"> </A>}<A NAME="pgfId=614247"> </A>return results;</PRE><P CLASS="Body"><A NAME="pgfId=617182"> </A>The results array is an array of NSDictionary objects. Each NSDictionary has the same form as the raw row when you fetch using the EOAdaptorChannel. See <A HREF="ProgrammingTopics.32.html#10792" CLASS="XRef">Executing Arbitrary SQL Using the Adaptor Sublayer</A> above.</P></DIV><DIV><H3 CLASS="Heading2"><A NAME="pgfId=606112"> </A>SQL Topics</H3><P CLASS="Body"><A NAME="pgfId=606113"> </A>The following are some SQL statements that are useful to send directly to the database server:</P><P CLASS="Body"><A NAME="pgfId=607062"> </A>	<TT CLASS="Code">GROUP BY</TT> allows the user to group several rows sharing a particular pattern and compute some statistics on the aggregate (such as the total number of rows, the average, or the variance). For example, the following statement selects the number of movies produced by a given studio:</P><PRE CLASS="Code"><A NAME="pgfId=606115"> </A>Select count(*), t1.name from movie t0, studio t1 where t0.studio_id=t1.studio_id GROUP BY t1.name</PRE><P CLASS="Body"><A NAME="pgfId=607070"> </A>You can also compute the average and variance of a particular column. The following returns the list of the averages of revenue for each studio_id:</P><PRE CLASS="Code"><A NAME="pgfId=606118"> </A>Select avg(revenue), studio_id from movie GROUP BY studio_id</PRE><P CLASS="Body"><A NAME="pgfId=606120"> </A>	<TT CLASS="Code">HAVING</TT> allows you to select rows based on the result of an aggregate function such as <TT CLASS="Code">count</TT> or <TT CLASS="Code">avg</TT>. This example selects only the number of movies from studios that have produced more than three movies.</P><PRE CLASS="Code"><A NAME="pgfId=606121"> </A>Select count(*), t1.name from movie t0, studio t1 where t0.studio_id=t1.studio_id GROUP BY t1.name HAVING count(*)&gt;=3</PRE><P CLASS="Body"><A NAME="pgfId=606122"> </A>	Oracle has a feature called sequences. Suppose movie_seq is a name of a sequence. To get the value of a sequence, you send the following statement:</P><PRE CLASS="Code"><A NAME="pgfId=607079"> </A>Select movie_seq.nextval from dual</PRE></DIV></DIV><DIV><H2 CLASS="Heading1"><A NAME="pgfId=606126"> </A>See Also</H2><UL><LI CLASS="Bulleted"><A NAME="pgfId=608890"> </A><A HREF="ProgrammingTopics.1a.html#15933" CLASS="XRef">Fetching with an Editing Context</A></LI><LI CLASS="Bulleted"><A NAME="pgfId=614310"> </A><A HREF="ProgrammingTopics.24.html#36344" CLASS="XRef">Inserting with the Adaptor Sublayer</A></LI><LI CLASS="Bulleted"><A NAME="pgfId=614315"> </A><A HREF="ProgrammingTopics.27.html#10154" CLASS="XRef">Updating with the Adaptor Sublayer</A></LI><LI CLASS="Bulleted"><A NAME="pgfId=614320"> </A><A HREF="ProgrammingTopics.25.html#24751" CLASS="XRef">Deleting with the Adaptor Sublayer</A></LI><LI CLASS="Bulleted"><A NAME="pgfId=616999"> </A><A HREF="ProgrammingTopics.30.html#27044" CLASS="XRef">Accessing Adaptor Sublayer Objects</A></LI><LI CLASS="Bulleted"><A NAME="pgfId=617003"> </A><A HREF="ProgrammingTopics.31.html#17565" CLASS="XRef">Creating Adaptor Sublayer Objects and Connecting Them to the Server</A></LI><LI CLASS="Bulleted"><A NAME="pgfId=617007"> </A><A HREF="ProgrammingTopics.33.html#24267" CLASS="XRef">Accessing Schema Information from the Database Server</A></LI><LI CLASS="Bulleted"><A NAME="pgfId=614324"> </A>EOAdaptor class specification in the <EM CLASS="Emphasis">Enterprise Objects Framework Reference</EM></LI></UL></DIV><DIV><H2 CLASS="Heading1"><A NAME="pgfId=608879"> </A>Questions</H2><UL><LI CLASS="Bulleted"><A NAME="pgfId=606130"> </A>	How do I compute statistics on my data?</LI><LI CLASS="Bulleted"><A NAME="pgfId=606131"> </A>	How do I use <TT CLASS="Code">GROUP BY</TT> statement?</LI><LI CLASS="Bulleted"><A NAME="pgfId=606132"> </A>	How do I use the <TT CLASS="Code">HAVING</TT> statement?</LI><LI CLASS="Bulleted"><A NAME="pgfId=606133"> </A>	How do I fetch a sequence value?</LI><LI CLASS="Bulleted"><A NAME="pgfId=614327"> </A>How do I execute raw SQL statements using EOF?</LI></UL></DIV><DIV><H2 CLASS="Heading1"><A NAME="pgfId=606134"> </A>Keywords</H2><UL><LI CLASS="Bulleted"><A NAME="pgfId=606135"> </A>SQL</LI><LI CLASS="Bulleted"><A NAME="pgfId=606136"> </A>Grouping</LI></UL></DIV><DIV><H2 CLASS="Heading1"><A NAME="pgfId=606137"> </A>Revision History</H2><P CLASS="Body"><A NAME="pgfId=606138"> </A>21 July, 1998. Jean-Luc Marsolier. First Draft.<BR>12 November, 1998. Clif Liu. Second Draft.</P></DIV><hr alt="">&#169 1999 Apple Computer, Inc.<P><A HREF="TopicsTOC.html"><img src="up.gif" border="0" alt="Up"></A><nobr>&nbsp;</nobr><A HREF="ProgrammingTopics.31.html"><img src="previous.gif" border="0" alt="Previous"></A><nobr>&nbsp;</nobr><A HREF="ProgrammingTopics.33.html"><img src="next.gif" border="0" alt="Next"></A><!-- start of footer --><!--#include file="footer" --><!-- end of footer --><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>