<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Writing a SCSI Interface Module(IM: D)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING155></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->




<!-- Main Body -->

<CENTER>
<P>
<A HREF="Devices-154.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Devices-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Devices-328.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Devices-156.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Devices-2.html"><B>Devices</B></A> / <BR><DD><A HREF="Devices-151.html"><B>Chapter 4 - SCSI Manager 4.3</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING155-0></A>
<H1><A NAME=MARKER-9-56></A>Writing a SCSI Interface Module</H1>
 This section provides additional information that HBA developers need to write a SCSI interface module.<A NAME=MARKER-2-57></A><P>
<A NAME=HEADING155-2></A>
<H2>SIM Initialization and Operation</H2>
 When SCSI Manager 4.3 is present in ROM, the Start Manager loads any SIM drivers it finds in the declaration ROM of all installed expansion cards. A SIM driver may contain the actual SIM, or it may contain code to load the SIM from some other location (such as a device attached to the expansion card). The Start Manager searches for SIM drivers using the Slot Manager <CODE>SNextTypeSRsrc</CODE> function, and loads all drivers matching the following criteria:
<TABLE BORDER="0" CELLPADDING=3><TH ALIGN=LEFT>sResource type<TH>Constant<TH>Value<TR>
<TD><CODE>spCatagory</CODE><TD>CatIntBus<TD>12<TR>
<TD>spCType<TD>TypSIM<TD>12<TR>
<TD>spDrvrSW<TD>DrvrSwScsi43<TD>1</TABLE>
<P>
 After loading a SIM driver, the Start Manager calls the driver's open routine. If the SIM is contained in the driver, it should register itself with the XPT at this time. If the registration is successful, the open routine should return <CODE>noErr</CODE>. If the open routine returns an error result, the Start Manager removes the driver from the unit table and releases it from memory. A SIM loader can use this technique to remove itself after loading and registering the actual SIM. Because no other driver entry points are used, you do not need to implement the close, prime, status, or control routines, but they should return appropriate errors.<P>
 For Macintosh models that do not include SCSI Manager 4.3 in ROM, your SIM can either provide its own temporary XPT or wait until SCSI Manager 4.3 is installed by the system before registering with the XPT. If you wait for SCSI Manager 4.3 to load, devices on your bus cannot be used as the boot device or as the paging device for virtual memory but can be mounted after SCSI Manager 4.3 is running and your bus is registered.<P>
 If your SIM supplies its own XPT, your SIM and XPT must be prepared for the possibility that a system patch will install a new XPT later. To provide a consistent environment for driver clients of your SIM when the XPT is replaced, your XPT must maintain information about any virtual ID numbers it assigns (including a driver registration table) and correctly fill in the XPT fields of the bus inquiry record. When the SCSI Manager4.3 XPT loads, it uses the <CODE>SCSIGetVirtualIDInfo</CODE>, <CODE>SCSILookupRefNumXref</CODE>, and <CODE>SCSIBusInquiry</CODE> functions to query your XPT, then calls the <CODE>SetTrapAddress</CODE> function to install itself. Next, it uses your XPT to send a <CODE>SCSIRegisterWithNewXPT</CODE> command to each registered SIM. A SIM must respond by using the <CODE>SCSIReregisterBus</CODE> function to export its assigned bus number, entry points, and static data storage pointer to the new XPT. Finally, the SCSI Manager 4.3 XPT calls your XPT with a <CODE>SCSIKillXPT</CODE> command. Your XPT should then release any memory it has allocated and remove or disable any patches it may have installed.<P>
 Your XPT must reserve bus number 0 for the built-in SCSI bus. For Macintosh computers with dual SCSI buses, you must reserve bus numbers 0 and 1. If the SCSI Manager 4.3 XPT is installed after your XPT, it will assign these bus numbers to the built-in buses.<P>
 After determining the presence of the XPT, a SIM should register itself using the <CODE>SCSIRegisterBus</CODE> function. The SIM initialization record for this request contains the SIM's function entry points, required static data storage size, and the <CODE>oldCallCapable</CODE> status of the SIM. The SIM initialization record, defined by the <CODE>SIMInitInfo</CODE> data type, is shown on <A HREF=Devices-170.html#MARKER-9-173>page 4-36</A>. The XPT allocates the requested number of bytes for the SIM's static storage, fills in the appropriate fields of the SIM initialization record, and then calls the SIM's <CODE>SIMInit</CODE> function. If the <CODE>SIMInit</CODE> function returns <CODE>noErr</CODE>, the XPT completes the registration process, making the SIM available to the system. If <CODE>SIMInit</CODE> returns an error, the registration request fails.<P>
 Once the registration is complete, the XPT makes calls to the <CODE>SIMAction</CODE> entry point whenever a <CODE>SCSIAction</CODE> request is received that is destined for this bus. The XPT passes a pointer to the parameter block and a pointer to the SIM's static storage to the <CODE>SIMAction</CODE> function. The SIM should parse the parameter block for illegal or unsupported parameters and return an error result if necessary. After queuing the request, the <CODE>SIMAction</CODE> function should return to the XPT. When the request completes, the SIM calls the XPT's <CODE>MakeCallback</CODE> function with the appropriate parameter block. The XPT then calls the client's completion routine.<P>
 Other types of requests should be implemented to conform to the function descriptions provided in this chapter. Functions or features not implemented by the SIM should return appropriate errors (for example, <CODE>scsiFunctionNotAvailable</CODE> or <CODE>scsiProvideFail</CODE>). <P>
 The <CODE>SIMInteruptPoll</CODE> function is called during the Device Manager's synchronous wait loop to give time to the SIM when interrupts are masked. The sole parameter is a pointer to the SIM's static data, which is passed on the stack. Because this call does not imply the presence of an interrupt, the SIM should check for interrupts before proceeding.<P>
 The <CODE>EnteringSIM</CODE> and <CODE>ExitingSIM</CODE> functions provide compatibility with the Virtual Memory Manager and should be called every time the SIM is entered and exited, respectively. In other words, these two function calls should surround all SIM entry and exit points, including interrupt handlers and callbacks to client code made through the <CODE>MakeCallback</CODE> function.<P>
 Parameter blocks must appear to the client to be queued on a per-LUN basis, because queue freezing and unfreezing are performed one LUN at a time. The actual implementation may vary as long as this appearance is maintained. <P>
<A NAME=HEADING155-14></A>
<H2>Supporting the Original SCSI Manager</H2>
 If your SIM indicates that it is capable of supporting original SCSI Manager functions, the XPT adds it to the list of buses that are searched when a <CODE>SCSISelect</CODE> request is received.<P>
 The XPT is responsible for converting original SCSI Manager functions into the proper format and submitting them to the SIM. It also receives the results for each of the functions from the SIM and returns them to the client.<P>
 When it receives a <CODE>SCSIGet</CODE> request, the XPT simply notes that the call was made by setting an internal flag, then returns to the caller. In response to a <CODE>SCSISelect</CODE> request, the XPT generates a <CODE>SCSIOldCall</CODE> request and submits it to the SIM's <CODE>SIMAction</CODE> entry point. The <CODE>scsiDevice</CODE> field of the parameter block contains the bus number of the SIM, the target ID specified in the <CODE>SCSISelect</CODE> request, and a LUN of 0. This parameter block should be queued like any other.<P>
 When your SIM receives a <CODE>SCSIOldCall</CODE> request, it should attempt to select the device and return a result code to the XPT in the <CODE>scsiOldCallResult</CODE> field of the parameter block (<CODE>scsiRequestComplete</CODE> if successful and <CODE>scsiSelectTimeout</CODE> if not). Intermediate function results are not communicated through the <CODE>scsiResult</CODE> field because this would be interpreted as completion of the entire transaction rather than only the portion of the transaction resulting from a single original function. As subsequent original function calls are made, the XPT fills in the appropriate fields of the parameter block and calls the SIM's <CODE>NewOldCall</CODE> entry point. <A HREF=#MARKER-9-1>Table 4-1</A> shows the original function parameters and the fields that are filled in by the XPT.
<TABLE BORDER="0" CELLPADDING=3>
<CAPTION><A NAME=MARKER-9-1></A><B>Table 4-1 Original SCSI Manager parameter conversion</B> </CAPTION>
<TH>Function<TH>Parameter<TH>Direction<TH>Parameter block field<TH>Notes<TR>
<TD>SCSIGet<TD>&nbsp;<TD>&nbsp;<TD>&nbsp;<TD>XPT handles internally.<TR>
<TD>SCSISelect<TD>targetID<TD><symbol>--><Default \xB6 Font><EM></EM><TD>scsiDevice<TD><CODE>bus</CODE> set by XPT, <CODE>LUN</CODE> = 0.<TR>
<TD>SCSICmd<TD>buffer<BR>count<TD><EM>--><BR>--></EM><TD>scsiCDB<BR>scsiCDBLength<TD>Field is a pointer.<TR>
<TD>SCSIRead, SCSIWrite, SCSIRBlind,<BR>SCSIWBlind<TD>tibPtr<TD><EM>--></EM><TD>scsiDataPtr<TD>Field is a pointer.<TR>
<TD>SCSIComplete<TD>stat<BR>message<BR>wait<TD><EM><--<BR><--<BR>--></EM><TD>scsiSCSIstatus<BR>scsiSCSImessage<BR>scsiTimeout<TD>Field contains status.<BR>Field contains message.<BR>Time in Time Manager format.<TR>
<TD>SCSIMsgIn<TD>message<TD><EM><--</EM><TD>scsiSCSImessage<TD>Field contains message.<TR>
<TD>SCSIMsgOut<TD>message<TD><EM>--></EM><TD>scsiSCSImessage<TD>Field contains message.<TR>
<TD>SCSIReset<TD>&nbsp;<TD><EM></EM><TD>&nbsp;<TD><CODE>Translated to SCSIResetBus</CODE>.<TR>
<TD>SCSIStat<TD>&nbsp;<TD><EM></EM><TD>&nbsp;<TD>XPT handles internally.</TABLE>
<P>
 To provide the highest level of compatibility with the original SCSI Manager, a SIM should be able to perform a SCSI arbitration and select process independently of a SCSI message-out or command phase. A SIM that requires the CDB or message-out bytes in order to perform a select operation will be unable to execute the <CODE>SCSISelect</CODE> function properly, and must always return <CODE>noErr</CODE> to a <CODE>SCSISelect</CODE> request. This can create a false indication of the presence of a device at a SCSI ID, causing all future <CODE>SCSISelect</CODE> requests to that SCSI ID to be directed only to that bus. Devices installed on buses that registered after that bus would not be accessible through the original interface.<P>
<A NAME=HEADING155-20></A>
<H2>Handshaking of Blind Transfers</H2>
 Handshaking instructions are used to prevent bus errors when a target fails to deliver the next byte within the processor bus error timeout period. This timeout is 250 milliseconds for the Macintosh SE and 16 microseconds for all Macintosh models since the Macintosh II.<P>
 The SCSI Manager 4.3 SIM requires this handshaking information for <A NAME=MARKER-2-58></A>blind transfers when DMA is not available. Your SIM does not need to pay attention to the <CODE>scsiHandshake</CODE> field unless your hardware requires it.<P>
<A NAME=HEADING155-23></A>
<H2>Supporting DMA</H2>
 DMA typically requires that the data buffer affected by the transfer be locked (so that the physical address does not change) and that it be non-cacheable. SCSI Manager 4.3 provides an improved version of the <CODE>LockMemory</CODE> function, which you can call at interrupt time as long as the affected pages are already held in real memory. You can also call the <CODE>GetPhysical</CODE> function at interrupt time, but only on pages that are locked.<A NAME=MARKER-2-59></A><P>
<A NAME=HEADING155-25></A>
<H2>Loading Drivers</H2>
 The Start Manager is normally responsible for loading SCSI drivers. However, if the startup device specified in PRAM is on a third-party HBA and the SIM is a Slot Manager device, the Start Manager will call the boot record of the card's declaration ROM. The boot record code should examine the <CODE>dCtlExtDev</CODE> field to determine which SCSI device is the startup device and then load a driver from that device (and only that device).<P>
 All other drivers are loaded by the Start Manager, but SIMs are given the opportunity to override this if necessary. Before the Start Manager attempts to load a driver from a device, it calls the SIM with a <CODE>SCSILoadDriver</CODE> request. If the function succeeds, the Start Manager does nothing further with that device. If the function fails (the normal case), the Start Manager reads the partition map on the device and loads a driver from it. If this fails, the Start Manager calls the SIM again with a <CODE>SCSILoadDriver</CODE> request, this time with the <CODE>scsiDiskLoadFailed</CODE> parameter set to indicate that no driver was available on the media.<P>
 This facility allows a SIM to provide a default driver to be used instead of any driver that may be on the device. For example, if a SIM does support the original SCSI Manager, it can use the second <CODE>SCSILoadDriver</CODE> request to load a SCSI Manager 4.3-compatible driver if none is present on the device.<P>

<HR>
<center>
<A HREF="Devices-154.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Devices-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Devices-328.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Devices-156.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Devices-3.html">&copy; Apple Computer, Inc.</A><br>3 JUL 1996</center></font><P>
<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->
</BODY>
</HTML>  
