<HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><script language="JavaScript" src="frametest.js"></script><TITLE> Register Actions</TITLE></HEAD><BODY BGCOLOR="#ffffff"><DIV><a name="top"></a><!-- start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!-- start of path --><font face="Geneva,Helvetica,Arial" size="1"><b><br>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Documentation</a> &gt; <!-- a href="" target="_top" -->Hardware<!-- /a -->  <b>&gt; </b><a href="../../devicemgrs.html" target="_top">Device Managers and Drivers</a> <b>&gt; </b><a href="../pci_srvcs.html" target="_top">PCI Card Services</a> <b>&gt; </b>Designing PCI Cards and Drivers for Power Macintosh Computers</font><br><br><!-- end of path --><A HREF="PCI_BOOK.52.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.54.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.56.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><HR></DIV><H1 CLASS="H2.Heading2"><A NAME="pgfId=3580"> </A>Register Actions</H1><P CLASS="T1.Text1"><A NAME="pgfId=3581"> </A>This section describes the actions that the Macintosh Open Firmware performs on the PCI configuration registers listed in <A HREF="PCI_BOOK.54.html#22004" CLASS="XRef">Figure&nbsp;4-1</A> during startup.</P><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=3586"> </A><A NAME="11581"> </A>Vendor ID</H2><P CLASS="T1.Text1"><A NAME="pgfId=3588"> </A>The <A NAME="marker=3587"> </A>Vendor ID register is read and its value stored in the property <TT CLASS="cv">vendor-id</TT>. If the card has no FCode, the Vendor ID value makes up the <I CLASS="italics">xxxx</I> portion of the <TT CLASS="cv">&quot;pci</TT><I CLASS="italics">xxxx,yyyy</I><TT CLASS="cv">&quot;</TT> default name property for the node.</P></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=3589"> </A>Device ID</H2><P CLASS="T1.Text1"><A NAME="pgfId=3591"> </A>The <A NAME="marker=3590"> </A>Device ID register is read and its value stored in the property <TT CLASS="cv">device-id</TT>. If the card has no FCode and no subsystem ID, the Device ID value makes up the <I CLASS="italics">yyyy</I> portion of the <TT CLASS="cv">&quot;pci</TT><I CLASS="italics">xxxx,yyyy</I><TT CLASS="cv">&quot;</TT> default name property for the node.</P></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=3592"> </A>Command</H2><P CLASS="T1.Text1"><A NAME="pgfId=3594"> </A>The following bits in the <A NAME="marker=3593"> </A>Command register are set with the meanings shown:</P><UL><LI CLASS="B1.Bullet1"><A NAME="pgfId=3595"> </A>Bit 9, Fast Back-to-Back Enable, is set to 1 if all PCI devices are fast back-to-back capable (if all devices have a fast-back-to-back property stored in their device node); otherwise, it is cleared to 0.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3596"> </A>Bit 8, SERR Enable, is cleared to 0 for all devices because the Power Macintosh system doesn't respond to SERRs.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3597"> </A>Bit 7, Wait Cycle Control, is cleared to 0 for all devices.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3598"> </A>Bit 6, Parity Error Response, is cleared to 0 for all devices.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3599"> </A>Bit 5, VGA Palette Snoop, is cleared to 0 for all devices.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3600"> </A>Bit 4, Memory Write and Invalidate Enable, is set to 1 for all devices because the Power Macintosh system fully supports this command type and optimizes for it.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3601"> </A>Bit 3, Special Cycle Enable, is set to 1 for all devices because the Power Macintosh system can generate special cycles.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3602"> </A>Bit 2, Bus Master Enable, is set to 1 for all devices because the Power Macintosh system supports masters in all PCI locations.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3603"> </A>Bit 1, Memory Space Enable, is cleared to 0 for all devices before an operating system is loaded. Hence, the initialization routines of all run-time drivers must set this bit to 1 if they wish to access their device in memory space. However, the decision to write a 1 in this location must be made after checking that the memory resources required for correct operation appear in the device's <TT CLASS="cv">assigned-addresses</TT> property; otherwise, the driver should leave this bit to cleared to 0.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3604"> </A>Bit 0, I/O Space Enable, is cleared to 0 for all devices before an operating system is loaded. Hence, the initialization routines of all run-time drivers must set this bit to 1 if they wish to access their device in I/O space. However, the decision to write a 1 in this location must be made after checking that the I/O space resources required for correct operation appear in the device's <TT CLASS="cv">assigned-addresses</TT> property; otherwise, the driver should leave this bit to cleared to 0.</LI></UL></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=3605"> </A>Status</H2><P CLASS="T1.Text1"><A NAME="pgfId=3607"> </A>The following bits are read in the <A NAME="marker=3606"> </A>Status register:</P><P CLASS="T1.Text1"><A NAME="pgfId=3608"> </A>The value of bits 10-9, DEVSEL Speed, is stored in the node's <TT CLASS="cv">devsel-speed</TT> property.</P><P CLASS="T1.Text1"><A NAME="pgfId=3609"> </A>The value of bit 7, Fast Back-to-Back Capable, is noted for each PCI device. If the value is nonzero, the property <TT CLASS="cv">fast-back-to-back</TT> is created for the node. See the previous section for information about the Fast Back-to-Back Enable bit.</P><P CLASS="T1.Text1"><A NAME="pgfId=3610"> </A>No specific action is taken for the remaining bits in the Status register.</P></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=3611"> </A>Revision ID</H2><P CLASS="T1.Text1"><A NAME="pgfId=3613"> </A>The <A NAME="marker=3612"> </A>Revision ID register is read and its value stored in the property <TT CLASS="cv">revision-id</TT>.</P></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=3614"> </A>Class Code</H2><P CLASS="T1.Text1"><A NAME="pgfId=3616"> </A>The <A NAME="marker=3615"> </A>Class Code register is read and its value stored in the property <TT CLASS="cv">class-code</TT>.</P></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=3617"> </A>Cache Line Size</H2><P CLASS="T1.Text1"><A NAME="pgfId=3619"> </A>The <A NAME="marker=3618"> </A>Cache Line Size register is set for all devices as specified in the PCI Specification 2.1. This value may change from Macintosh platform to Macintosh platform for various performance reasons. </P></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=4329"> </A>Latency Timer</H2><P CLASS="T1.Text1"><A NAME="pgfId=4331"> </A>The <A NAME="marker=4330"> </A>Latency Timer register is set for all devices as specified in the PCI Specification 2.1. This value may change from Macintosh platform to Macintosh platform for various performance reasons. </P></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=4332"> </A>Header Type</H2><P CLASS="T1.Text1"><A NAME="pgfId=3625"> </A>The <A NAME="marker=3624"> </A>Header Type register is read, starting with bits 6-0. If the value of bits 6-0 is  0x00, the configuration space has a standard header layout for configuration addresses 0x10 through 0x3F; if the value is 0x01, it has a PCI-to-PCI bridge header layout for that section.</P><DIV><blockquote><p CLASS="NoteHead"><b><A NAME="pgfId=14553"> </A>Note</b></p><P CLASS="Note"><A NAME="pgfId=3626"> </A>The PCI bus behavior described in this section is that corresponding to a standard header. </P></blockquote><P CLASS="T1.Text1"><A NAME="pgfId=3630"> </A>If bit 7 of the Header Type register is set to 1, the system Open Firmware probes for multiple functions; otherwise, it assumes the device is a single-function device.</P></DIV></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=3631"> </A>BIST</H2><P CLASS="T1.Text1"><A NAME="pgfId=3633"> </A>No action is taken on the <A NAME="marker=3632"> </A>BIST register.</P></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=3634"> </A>Base Registers</H2><P CLASS="T1.Text1"><A NAME="pgfId=3635"> </A>If FCode is present in the card's expansion ROM, the system Open Firmware creates an <TT CLASS="cv">assigned-addresses</TT> property for the node, provided the card's FCode presents a <TT CLASS="cv">reg</TT> property with entries referencing at least one <A NAME="marker=3636"> </A>base register and the system was able to provide the resources requested in the <TT CLASS="cv">reg</TT> property corresponding to the base registers referenced. For each base register that has a corresponding entry in the <TT CLASS="cv">assigned-addresses</TT> property, the system Open Firmware programs that base register with the address value stored in the <TT CLASS="cv">assigned-addresses</TT> property. </P><P CLASS="T1.Text1"><A NAME="pgfId=3637"> </A>If FCode is not present for the node, the system Open Firmware creates a <TT CLASS="cv">reg</TT> property for the device. To create a <TT CLASS="cv">reg</TT> entry for each base register that is implemented, the system Open Firmware writes all 1s to each base register location. It then reads the locations to see how many of the 1s are still there. If the register reads back as all 0s, then the register is not implemented and a <TT CLASS="cv">reg</TT> entry is not made for it. If the register contains a value other than 0, the system Open Firmware notes which bits are 1s and thereby determines whether the register is of type memory or I/O, the amount of address space required, whether it is a 64-bit address, whether it is prefetchable, and whether it must be located below 1 MB. This information is then encoded appropriately into the <TT CLASS="cv">reg</TT> entry for the base register. After all base registers are queried in this manner, the full <TT CLASS="cv">reg</TT> property is stored in the device's node. Refer to the PCI specification and <I CLASS="italics">PCI Bus Binding to IEEE 1275-1994 </I>(described in <A HREF="PCI_BOOK.25e.html#37104" CLASS="XRef">Other Publications</A>) for more details. Once the <TT CLASS="cv">reg</TT> property is stored in the node, Open Firmware clears the Base registers to all 0s. It then follows the process of writing the registers with <TT CLASS="cv">assigned-addresses</TT> values, as described above for devices that have FCode.</P></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=3641"> </A>Subsystem Vendor ID</H2><P CLASS="T1.Text1"><A NAME="pgfId=3643"> </A>If the value of the <A NAME="marker=3642"> </A>Subsystem Vendor ID register is nonzero, a <TT CLASS="cv">subsystem-vendor-id</TT> property is created with the register's value. If the property is created and no FCode is present on the card, the Subsystem Vendor ID value makes up the <I CLASS="italics">xxxx</I> portion of the <TT CLASS="cv">&quot;pci</TT><I CLASS="italics">xxxx,yyyy</I><TT CLASS="cv">&quot;</TT> default name property for the node.</P><P CLASS="T1.Text1"><A NAME="pgfId=3644"> </A>The Subsystem Vendor ID register is described in Revision 2.1 of the PCI Specification.</P></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=3645"> </A>Subsystem ID</H2><P CLASS="T1.Text1"><A NAME="pgfId=3647"> </A>If the value of the <A NAME="marker=3646"> </A>Subsystem ID register is nonzero and a <TT CLASS="cv">subsystem-vendor-id</TT> property exists for the device, a <TT CLASS="cv">subsystem-id</TT> property is created with the register's value. If the property is created and no FCode is present on the card, the Subsystem Vendor ID value makes up the <I CLASS="italics">yyyy</I> portion of the <TT CLASS="cv">&quot;pci</TT><I CLASS="italics">xxxx,yyyy</I><TT CLASS="cv">&quot;</TT> default name property for the node.</P><P CLASS="T1.Text1"><A NAME="pgfId=3648"> </A>The Subsystem ID register is described in Revision 2.1 of the PCI Specification.</P></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=3649"> </A>Expansion ROM Base</H2><P CLASS="T1.Text1"><A NAME="pgfId=3651"> </A>The system Open Firmware uses the <A NAME="marker=3650"> </A>Expansion ROM Base register at probe time to determine whether a card has FCode present. It queries the register to see whether the register is implemented, following the procedure described above for other base registers. If the register is implemented, Open Firmware temporarily maps in an amount of memory space equal to the requirement found from the base register query and then programs that value into the base register. It also enables the expansion ROM by an OR operation with 1 on bit 0 of the register and enables the card's memory space by writing a 1 to the correct bit in the Command register. It then reads the expansion ROM's first locations, by accessing the space temporarily mapped in, looking for the PCI signature (0x55AA). If it finds the signature, it continues to look for an Open Firmware ROM image signature. If it finds that signature, it locates the FCode, copies it to RAM, and executes it. After the card's FCode has finished executing, or if it was determined that there was no FCode, the system Open Firmware disables the card's memory space and expansion ROM and clears the Expansion ROM Base register to 0s.</P><P CLASS="T1.Text1"><A NAME="pgfId=3652"> </A>If FCode was present in the card's expansion ROM and the FCode presented a <TT CLASS="cv">reg</TT> property with an entry for the Expansion ROM Base register, and if the system was able to provide the resources for this entry, then the system Open Firmware creates a corresponding entry in the <TT CLASS="cv">assigned-addresses</TT> property and writes the address value to the Expansion ROM Base register. </P><P CLASS="T1.Text1"><A NAME="pgfId=3653"> </A>If FCode is not present for the node, the system Open Firmware creates a <TT CLASS="cv">reg</TT> property for the device and determines whether to create an entry for the Expansion ROM Base register following the procedure for other base registers described above. The procedure for writing the register if FCode is present is the same as that in the preceding paragraph.</P><DIV><blockquote><p CLASS="ImportantHead"><b><A NAME="pgfId=14555"> </A>IMPORTANT</b></p><P CLASS="I.Important"><A NAME="pgfId=3654"> </A>Bit 0 of the Expansion ROM Base register, which is defined as the Expansion ROM Enable bit, is left as 0 (disabled) by the system Open Firmware. If the run-time driver is interested in accessing the PCI Expansion ROM, it must first check that it has received an <TT CLASS="cv">assigned-addresses</TT> entry, and then it must enable both its memory space (Memory Space Enable bit of the Command register) and its ROM (Expansion ROM Enable bit of the Expansion ROM Base register). As with all writable configuration registers, such operations must be performed with read-modify-write code sequences so as not to disturb the existing values of other bits in the registers. </P></blockquote></DIV></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=3658"> </A>Interrupt Line</H2><P CLASS="T1.Text1"><A NAME="pgfId=3660"> </A>No action is taken on the <A NAME="marker=3659"> </A>Interrupt Line register. It has no meaning for Power Macintosh computers because interrupts are OR-combined per slot in hardware, creating a unique interrupt for each PCI card accessible to the system interrupt controller. This register contains no useful information for drivers.</P></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=3661"> </A>Interrupt Pin</H2><P CLASS="T1.Text1"><A NAME="pgfId=3663"> </A>The <A NAME="marker=3662"> </A>Interrupt Pin register is read. If its value is nonzero, the value appears in the property <TT CLASS="cv">interrupts</TT>. This register contains no useful information for drivers for the reasons explained in the previous section.</P></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=3664"> </A>Min_Gnt</H2><P CLASS="T1.Text1"><A NAME="pgfId=3666"> </A>The <A NAME="marker=3665"> </A>Min_Gnt register is read and its value stored in the property <TT CLASS="cv">min-grant</TT>.</P></DIV><DIV><H2 CLASS="H4.Heading4"><A NAME="pgfId=3667"> </A>Max_Lat</H2><P CLASS="T1.Text1"><A NAME="pgfId=3669"> </A>The <A NAME="marker=3668"> </A>Max_Lat register is read and its value stored in the property <TT CLASS="cv">max-latency</TT>.</P></DIV><HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 26 March 99)<P><A HREF="PCI_BOOK.52.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.54.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.56.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>