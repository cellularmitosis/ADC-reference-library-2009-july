<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-05-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TN2002: Compatibility between JDirect 2 and JDirect 3</title><meta name="keywords" content="JDirect,Java,Mac OS X"><meta name="Description" content="Technical Note TN2002: This Technote describes    changes
in JDirect between MRJ 2.2 on Mac OS 8/9 and the Java   
1.3.1 runtime on Mac OS X."><meta name="categories" content="Java"><meta name="week-posted" content="Jul 30, 2001 - Aug 3, 2001"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10003041" title="Compatibility between JDirect 2 and JDirect 3"></a><a name="top"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxJava-date.html">Java</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/Java/idxPorting-date.html" target="_blank">Java > Porting</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN2002</div>
<div id="pageheadsub">Compatibility between JDirect 2 and JDirect 3</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left">         <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">  <td background="images/tnmenubody.gif" width=300 align=left>      <span id="menutitle">          CONTENTS           <BR>          <br>      </span>  </td>                </tr>                <tr bgcolor="#e6e6e6">  <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->					<p id="menutext"><a href="#JDirect2">JDirect 2</a><br>  <br>  <a href="#JDirect3">JDirect 3</a><br>  <br>  <a href="#JDirect2and3">Running on JDirect 2 &amp; 3</a><br>  <br>  <a href="#CarbonizedToolbox">Carbonized Toolbox</a><br>  <br>  <a href="#Debugging">Debugging JDirect</a><br>  <br>				<A HREF="#references">References</A><BR><BR>				<A HREF="#Downloads">Downloadables</A></P> <!-- end_toc -->                  </td>                </tr>                 <tr>  <td width=300 align=left scope="row">      <img src="images/tnmenubottom.gif" alt="" width=300 height=16>  </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left>            <!-- begin_intro_text --><P id = "introtext">This Technote describes changes in JDirect between MRJ 2.2 on Mac OS 8/9 and the Java runtime on Mac OS X.</P><P id = "introtext">JDirect is an Apple technology for calling native code from Java.</p><P id = "introtext">All developers interested in creating products in Java using JDirect and making them compatible with Mac OS 8/9 and X will want to review this document.</p><!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Aug 3 2001]</h3><!-- end_date -->                </TD>             </TR>          </TABLE><!-- end_header_box --> <BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><p><a name=JDirect2></a></p><h2>JDirect 2</h2><p>JDirect 2 was released with MRJ 2.1. Please see the <a href="http://developer.apple.com/java/text/download.html#sdk">MRJ 2.2 SDK</a> for more details on JDirect 2.</p><p>With JDirect 2 you are required to have a static Object field named <CODE>libraryInstance</CODE> in each class (or in an interface the class implements) that specifies which shared library(s) to search for native methods. For instance:</p><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>   // JDirect 2 example   import com.apple.mrj.jdirect.JDirectLinker;   import com.apple.jdirect.SharedLibrary;   public class Prime implements SharedLibrary {     // libraryInstance tells JDirect where to find the     // native method ComputePrime     static Object libraryInstance = JDirectLinker.loadLibrary("PrimeLib");     public static native long ComputePrime(short n);   }</pre></TD></TR></TABLE></CENTER><BR><BR><P><a href="#top">Back to top</a></p><BR>                <a name=JDirect3></a>                <h2>JDirect 3</h2><P>JDirect 3 is part of Apple's Java VM on Mac OS X. The main   design goal of JDirect 3 was to make it portable to any  JNI-compliant VM. It does not require changes to the VM.   It is layered on top of JNI.</p>               <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>Java code written to use JDirect 2 will not run as-is on OS X.</P></TD></TR></TABLE></CENTER><BR><BR><p>In general, all the features of JDirect 2 are also available in JDirect 3: Native method parameters are marshaled the same, <CODE>MethodClosures</CODE> are implemented, and the Accessor and Array utility classes are implemented. What is different is the way a class specifies that its native methods use JDirect.</p>                <h3>Class initializer</h3><P>Because JDirect 3 is not integrated into the VM, it does not have a chance to hook up native methods when a class is loaded. Instead, the class needs a static initializer that runs at class load time and tells JDirect to install native method thunks. For example:</p><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>  // JDirect 3 example for Mac OS X   import com.apple.mrj.jdirect.Linker;   public class Prime {      // The call to new Linker() installs the native methods      static Object linkage = new Linker(Prime.class);      // This string tells JDirect where to find the native code      static final String JDirect_MacOSX = "prime.dylib";      public static native long ComputePrime(short n);   }</pre></TD></TR></TABLE></CENTER><BR><BR><P>The call to <code>new Linker</code> registers JNI functions for all native methods in the class. The object returned holds a reference to the memory allocated by the functions installed. By storing the returned Object in a class variable - if the classes are ever garbage collected - the object will be GC'ed.  When its finalizer is run, the thunks will be deallocated.</p>                <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>      The client must retain a reference to the returned Object;       otherwise, the functions could be free'ed yet still be       registered as JNI-native methods!</P></TD></TR></TABLE></CENTER><BR><BR>                <h3>Library Strings</h3><P>Because the libraries that implement the native functions have platform-specific names, JDirect 3 uses a system for managing different library names for each platform. JDirect 3 uses reflection to find the platform-specific string in the class with the native methods or in interfaces it implements.</p><P>On Mac OS X, JDirect 3 looks for a String named <code>JDirect_MacOSX</code>. If JDirect 3 is ported to other VM's, it would look for other specific String names that begin with <code>JDirect_</code>.</p><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>  // sample library path  static final String     JDirect_MacOSX = "/Applications/Foo.dylib";</pre></TD></TR></TABLE></CENTER><BR><BR><P>JDirect can be instructed to look in multiple libraries for the native methods of a class by defining multiple <code>JDirect_MacOSX</code> Strings each in a different <code>interface</code> implemented by the class with native methods. For example:</p> <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>  public interface Foo {      static final String         JDirect_MacOSX = "/Applications/Foo.dylib";  }  public interface Bar {      static final String         JDirect_MacOSX = "/Applications/Bar.dylib";  }  // JDirect will search for these methods in Foo.dylib and Bar.dylib  public class Stuff implements Foo,Bar {      static Object linkage = new Linker(Stuff.class);      public native static void NewFoo(int size);      public native static void NewBar(int size);  }</pre></TD></TR></TABLE></CENTER><BR><BR><BR><BR><P><a href="#top">Back to top</a></p><BR><a name=JDirect2and3></a>                <h2>Writing code to run on JDirect 2 &amp; 3</h2><P>It is possible to write Java code that uses JDirect 2 when running on MRJ 2.2 and uses JDirect 3 when running on OS X. The Java VM on Mac OS X contains stubs for all the JDirect 2 classes, but MRJ 2.2 does not contain JDirect 3 classes, which means you can get <CODE>ClassNotFoundExceptions</CODE> or verifier errors when trying to run code on MRJ 2.2 (which is JDirect 3 aware). The solution is to write your own utility class that uses reflection to find the JDirect 3 Linker class. For example:</p><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>// utility class that runs on VM's that may or may not have JDirect3import java.lang.reflect.Constructor;public class MyJDirectUtil {  public static Object Link(Class targetClass) {    try {      Class linker = Class.forName("com.apple.mrj.jdirect.Linker");     Constructor constructor            = linker.getConstructor(new Class[]{Class.class});      Object jDirectLinkage            = constructor.newInstance(new Object[]{targetClass});     return jDirectLinkage;    }    catch (Throwable t) {    }    return null;  }}</pre></TD></TR></TABLE></CENTER><BR><BR><P>With the utility class above, you can write classes that mix together JDirect 2 and 3. For example:</p><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre> // interface that works with JDirect 2 &amp; 3 public interface FooLib {   // for JDirect 2   static Object     libraryInstance = JDirectLinker.loadLibrary("FooLib");   // for JDirect 3   static final String     JDirect_MacOSX = "/Applications/Foo.dylib"; } // class that works with JDirect 2 &amp; 3 public class FooFuncs implements FooLib {   // links on JDirect 3, but does nothing on JDirect 2   static Object linkage = MyJDirectUtil.Link(FooFuncs.class);   public native static void NewFoo(int size); }</pre></TD></TR></TABLE></CENTER><BR><BR>             <P><a href="#top">Back to top</a></p><BR>                <a name=CarbonizedToolbox></a>                <h2>Carbonized Toolbox</h2><P>Another big change between MRJ 2.2 and Mac OS X is that the toolbox on OS X is carbonized. That is, only functions and data structures available to <a href="../../documentation/carbon/CarbonOverview/index.html">Carbon applications</a> are available to Java code via JDirect. For example:</p><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>  import com.apple.mrj.macos.libraries.InterfaceLib;  public class MemFunctions implements InterfaceLib {     static Object linkage = MyJDirectUtil.Link(MemFunctions.class);     // will work on MRJ 2.2 and Mac OS X     public native static int NewHandle(int size);     // will work on MRJ 2.2     // will throw exception on Mac OS X because     //   NewHandleSys is not in Carbon.     public native static int NewHandleSys(int size);  }</pre></TD></TR></TABLE></CENTER><BR><BR>               <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>Mac OS X contains a set of compatibilty interfaces in <CODE>com.apple.mrj.macos.libraries</CODE> which contain a <CODE>JDirect_MacOSX</CODE> String pointing to the Carbon framework.  As in theabove sample, this allows code which uses these standard interfaces to work onboth Mac OS 8/9 and Mac OS X.</TD></TR></TABLE></CENTER><BR><BR><P>The difference between the toolbox on Mac OS X and Mac OS 9 is not simply that some functions are missing, but some data structures became opaque under Carbon or OS X. If you are using <CODE>GrafPorts</CODE>, <CODE>WindowRecords</CODE>, <CODE>DialogRecords</CODE>, <CODE>ControlRecords</CODE>, etc., you will need to rework your code to use the new accessor functions (e.g., <CODE>GetPortTextFont</CODE> instead of <CODE>GrafPort.txFont</CODE>). With a little more work, you can make your code run on MRJ 2.2 or Mac OS X. Here is an example of how a <CODE>Grafport</CODE> class could be rewritten to be usable under MRJ 2.2 or Mac OS X:</p><P>&nbsp;</P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>  // Option #1: keep GrafPortStruct interface the same  // but change getter/setter methods to use accessor functions  public class GrafPortStruct extends PointerStruct {     ...     public final short getTxFont() {         if (opaqueToolbox)            return QuickdrawFunctions.GetPortTextFont(this);         else           return getShortAt(68);    }     ...  }  // Option #2: change all GrafPortStruct clients to use accessors  // style methods which  public class QuickdrawFunctions {     ...     public static short GetPortTextFont(GrafPortStruct port) {        if (opaqueToolbox)           return GetPortTextFont(port.getPointer());        else          return port.getTxFont();      }     private static native short GetPortTextFont(int port);     ...  }</pre></TD></TR></TABLE></CENTER><BR><BR><P><a href="#top">Back to top</a></p><BR>                             <a name=MethodClosures></a>                <h2>Method Closures</h2><P>The class MethodClosureUPP was created for use on Mac OS 8/9 and is not supported on Mac OS X (the design of that class assumes the existence of MixedMode). On Mac OS X, the class exists, but throws an exception if you try to create an instance.  If you are using UPP based Toolbox callbacks and want code that will run on Mac OS 9 or Mac OS X, you will need to havetwo method closure classes - one for JDirect2 that extends MethodClosureUPP and one for JDirect3 that extendsMethodClosure.  In addition, the MethodClosure for Mac OS X will need to be carbonized whichmeans it uses the appropriate NewXxxUPP and DisposeXxxUPP functions.  Please see the sampleJDirect code on Mac OS 8/9 and Mac OS X for examples of MethodClosures.</p><P><a href="#top">Back to top</a></p><BR>                             <a name=Debugging></a>                <h2>Debugging JDirect</h2><P>The most common problem encountered with JDirect is  setting up your classes properly so that JDirect knows which native libraries to search. In both JDirect 2 &amp; 3, JDirect will throw an exception if itcannot find a native method. The exception message will contain a list of the libraries that were searched.</p>                <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>      With JDirect 3, if you forget to call <code>new Linker</code>       on the class with native methods, you will get the standard       <CODE>java.lang.UnsatisfiedLinkError</CODE> exception that JNI issues,       instead of the JDirect exception.</P></TD></TR></TABLE></CENTER><BR><BR><P>On Mac OS X, you can switch JDirect into verbose mode to aid in debugging. There are two ways to turn on verbose JDirect:</p>                <ul><li>Set shell variable <CODE>JDIRECT_VERBOSE</CODE>. This only works if you   are starting Java from the command line.</li>                </ul><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre> &gt; setenv JDIRECT_VERBOSE &gt; java -cp foo.jar Foo</pre></TD></TR></TABLE></CENTER><BR><BR><ul><li>From your Java code, set <CODE>Linker.verbose</CODE> to <CODE>true</CODE>. You will   need to open <CODE>Console.app</CODE> to view output if you do not launch   Java from the command line.</li></ul><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>    com.apple.mrj.jdirect.Linker.verbose = true;    </pre></TD></TR></TABLE></CENTER><BR><BR><P>When JDirect is in verbose mode, it will write information to <CODE>stderr</CODE>:</p>                <ul><li>each time <code>new Linker</code> is called, including   the libraries that JDirect will search to for native methods   in that class and the number of native methods in that class.</li><li>the first time each JDirect native method is called</li><li>each time a <CODE>MethodClosure</CODE> object is allocated</li>                </ul><P>On Mac OS X, Apple's AWT makes extensive use of JDirect. That means in verbose mode you may see lots of other JDirect usage information besides your own classes.</p>             <P>&nbsp;<A NAME=references></A></P><H2>References</H2>                  <P>Apple. <a href="http://developer.apple.com/java/text/download.html#sdk">JDirect Note.pdf</A>.</P>         <P>Apple. <a href="../../documentation/carbon/pdf/CarbonPortingGuide.pdf">Carbon Porting Guide</A>.</P><A NAME="Downloads"></A><H2>Downloadables</H2><TABLE BORDER=0 CELLPADDING=3 WIDTH="100%"> <TR> <td width=50 align=left> <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat"></P></TD> <td align="left"> <P>Acrobat version of this Note (100K)</P> </TD><td width=60 align=left> <P><A HREF="pdf/tn2002.pdf">Download</A></P></TD> </TR> </TABLE><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn2002.html%3Fid%3DDTS10003041-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn2002.html%3Fid%3DDTS10003041-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn2002.html%3Fid%3DDTS10003041-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>