<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>NoPowerOffKey - /ShowIcon7.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; <A HREF="javascript:location.replace('index.html');">NoPowerOffKey</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/idxHumanInterfaceDeviceForceFeedback-date.html" target="_blank">Hardware & Drivers > Human Interface Device & Force Feedback</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">NoPowerOffKey</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/ShowIcon7.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/PatchPowerOff.c</option>
<option value="listing2.html">/PatchPowerOff.h</option>
<option value="listing3.html">/PatchPowerOff.r</option>
<option value="listing4.html">/ShowIcon7.c</option></select>
				</p>
				</form>
				<p><strong><a href="NoPowerOffKey.zip">Download Sample</a></strong> (&#147;NoPowerOffKey.zip&#148;, 11.0K)<BR>
<strong><a href="NoPowerOffKey.dmg">Download Sample</a></strong> (&#147;NoPowerOffKey.dmg&#148;, 70.7K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">#include &lt;Icons.h&gt;#include &lt;OSUtils.h&gt;#include &lt;Resources.h&gt;#include &lt;Memory.h&gt;/*  ShowIcon7.c    ShowINIT compatible routine that shows 'ICN#' and 'iclx' flavor icons.  For use by all INITs in System 7 and beyond.    This code is based on Patrick C. Beard's ShowIconFamily  by Patrick C. Beard, which in turn was derived from the  original ShowInit by Paul Mercer, Darin Adler,  Paul Snively, and Steve Capps.    Modified by James W. Walker for compatibility with IconWrap 1.2,  for use as a separate code resource, and to use the new System 7  icon-drawing routines.  This code is in the public domain.    Addresses for James W. Walker: 76367,2271@compuserve.com or    walkerj@math.scarolina.edu    Instructions for use:      * Create a family of icons with ResEdit 2.1 or later.  This will      include 'ICN#', 'icl4', &amp; 'icl8' icons, all with the      same resource ID.        To use within a larger INIT project:      * #define SEPARATE_CODE 0  below.      * Call ShowIcon7( id, adv ) with the resource id of        the family that you used.  The Boolean parameter adv        indicates whether you want the next use of ShowIcon7        to advance to a new position.  Normally you pass TRUE,        but you can get an animated-icon effect by passing FALSE        all except the last time you call ShowIcon7.        To use as a separate code resource:      * #define SEPARATE_CODE 1  below.      * Set the project type to code resource, set the code type        and resource ID (I use type 'Code', ID -4048 for cdevs),        compile and merge into your INIT or cdev file.        Set the resource type to Locked, so you won't have        to call HLock when you use it.      * In your main INIT code, call ShowIcon7 like so:        pascal void (*ShowIcon7)( short resid, Boolean adv );        Handle  show_init;                show_init = GetResource( 'Code', -4048 );        ShowIcon7 = (pascal void (*)(short, Boolean))              StripAddress( *show_init );        ShowIcon7( iconID, advance ); */#define SEPARATE_CODE  0#if SEPARATE_CODE#define    ShowIcon7    main  /* JWW */#endif#ifndef nil#define nil ((void*)0L)#endif#ifndef topLeft  #define topLeft(r) ((Point*)&amp;r)[0])#endif#ifndef botRight  #define botRight(r) ((Point*)&amp;r)[1])#endiftypedef struct myQDGlobals {  char privates[76];  long randSeed;  BitMap screenBits;  Cursor arrow;  Pattern dkGray;  Pattern ltGray;  Pattern gray;  Pattern black;  Pattern white;  GrafPtr thePort;  long  end;} myQDGlobals;/* prototypes */pascal void ShowIcon7(short iconId, Boolean advance);static void DrawBWIcon( short iconId, Rect *icon_rect, Boolean visible );static void Next_position( void );static void GetIconRect( register Rect* iconRect, Rect *screen_rect );/* this is where it all happens. */pascal void ShowIcon7( short iconId, Boolean advance ){  long  oldA5;  myQDGlobals qd;        /* our QD globals. */  SysEnvRec environment;    /* machine configuration. */  CGrafPort gp;        /* our grafport. */  Rect  icon_rect;  OSErr  err;    /* get a value for A5, a structure that mirrors qd globals. */  oldA5 = SetA5((long)&amp;qd.end);  InitGraf(&amp;qd.thePort);    /* find out what kind of machine this is. */  SysEnvirons(curSysEnvVers, &amp;environment);  GetIconRect( &amp;icon_rect, &amp;qd.screenBits.bounds );  /*    The old IconWrap INIT patches CopyBits but does not know about    CopyMask or IconDispatch.  So in the color case, we draw the    black and white icon with an empty mask region.  */  if ( (environment.systemVersion &gt;= 0x0700) &amp;&amp; environment.hasColorQD )  {    OpenCPort(&amp;gp);    DrawBWIcon( iconId, &amp;icon_rect, false );    err = PlotIconID( &amp;icon_rect, atNone, ttNone, iconId );    CloseCPort(&amp;gp);  }  else  {    OpenPort((GrafPtr)&amp;gp);    DrawBWIcon( iconId, &amp;icon_rect, true );    ClosePort((GrafPtr)&amp;gp);  }    if (advance)    Next_position(); /* JWW */  SetA5(oldA5);}/*  ShowInit's information is nestled at the tail end of CurApName.  It consists of a short which encodes the next horizontal offset,  and another short which is that value checksummed with the function below. */#define CurApName_LM  0x910#define ShowINITTable ((unsigned short*)(CurApName_LM + 32 - 4))#define CheckSumConst 0x1021    /* magic value to check-sum with. */#define InitialXPosition 8      /* initial horizontal offset. */#define YOffset      40      /* constant from bottom to place the icon. */#define XOffset      40      /* amount to change it by. */#define ICON_WIDTH    32#define kDefaultRes 0x00480000 /* Default resolution is 72 DPI; Fixed type *//* CheckSum() computes the magic value to determine if ShowInit's have run already. */static short CheckSum(register unsigned short x){//  asm {//    rol.w  #1, x//  }  if (x &amp; 0x8000)  /* high bit set */    return((x &lt;&lt; 1) ^ CheckSumConst ^ 0x01);  else    return ((x &lt;&lt; 1) ^ CheckSumConst);}/*  GetIconRect() generates an appropriate rectangle to display the  next INIT's icon in.  It is also responsible for updating the horizontal  position in low memory.  This is a departure from  the original ShowInit code, which updates low  memory AFTER displaying the icon. -- changed by JWW  This code won't generate an icon position until it is certain that the icon can be loaded, so the  same behaviour occurs.    This routine also generates a rectangle which is guaranteed to be onscreen.  It  does this by taking the horizontal offset modulo the screen width to generate  the horizontal position of the icon, and the offset divided by the screen  width to generate the proper row. */static void GetIconRect(register Rect* iconRect, Rect *screen_rect ){  register short screenWidth;    screenWidth = screen_rect-&gt;right - screen_rect-&gt;left;  screenWidth -= screenWidth % XOffset;  /* if we are the first INIT to run we need to initialize the horizontal value. */  if (CheckSum(ShowINITTable[0]) != ShowINITTable[1])    ShowINITTable[0] = InitialXPosition;    /* compute top left of icon's rect. */  iconRect-&gt;left = (ShowINITTable[0] % screenWidth);  iconRect-&gt;top = screen_rect-&gt;bottom -    YOffset * (1 + (ShowINITTable[0] / screenWidth));  iconRect-&gt;right = iconRect-&gt;left + 32;  iconRect-&gt;bottom = iconRect-&gt;top + 32;  }/*  JWW: In Beard's original version, this was done at the end of  GetIconRect. That caused incorrect behavior when IconWrap 1.2 was  used to wrap icons.  Namely, if an INIT using that version of  ShowIconFamily was the first in a row, then the second icon in that  row would land on top of it.*/static void Next_position( void ){  /* advance the position for the next icon. */  ShowINITTable[0] += XOffset;    /* recompute the checksum. */  ShowINITTable[1] = CheckSum(ShowINITTable[0]);  }/* DrawBWIcon() draws the 'ICN#' member of the icon family. */void DrawBWIcon( short iconId, Rect *icon_rect, Boolean visible ){  Handle    icon;  BitMap    source, destination;  RgnHandle  empty_mask;  GrafPtr    port;    icon = Get1Resource('ICN#', iconId);  if (!icon)    return;  HLock(icon);    /* prepare the source and destination bitmaps. */  source.baseAddr = *icon + 128;          /* mask address. */  source.rowBytes = 4;  SetRect(&amp;source.bounds, 0, 0, 32, 32);  GetPort( &amp;port );  destination = ((GrafPtr)port)-&gt;portBits;  empty_mask = visible? nil : NewRgn();    /* transfer the mask. */  CopyBits(&amp;source, &amp;destination, &amp;source.bounds, icon_rect,    srcBic, empty_mask);    /* and the icon. */  source.baseAddr = *icon;    CopyBits(&amp;source, &amp;destination, &amp;source.bounds, icon_rect,    srcOr, empty_mask);    if (empty_mask) DisposeRgn( empty_mask );}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/NoPowerOffKey/listing4.html%3Fid%3DDTS10000018-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/NoPowerOffKey/listing4.html%3Fid%3DDTS10000018-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/NoPowerOffKey/listing4.html%3Fid%3DDTS10000018-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>