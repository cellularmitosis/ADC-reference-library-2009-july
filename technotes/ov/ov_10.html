<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note OV10: Setting and Restoring A5</title><meta name="keywords" content="Mac OS 8 SetCurrentA5 SetA5 SetupA5 RestoreA5 glue routines"><meta name="Description" content="Technical Note OV10: This Technical Note describes a pairof in-line glue routines (SetCurrentA5, SetA5) which havemore functionality than SetupA5 and RestoreA5, without makingassumptions about a compiler's stack handling. These routinesare provided as a standard part of the MPW Pascal 3.0 andMPW C 3.0 packages, in the files OSUtils.p and OSUtils.h,respectively.">                                       <meta name="categories" content="Overview"><meta name="week-posted" content="Aug 1, 1988 - Aug 5, 1988"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002608" title="Setting and Restoring A5"></a><A NAME="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/index.html" target="_blank">Reference Library</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note OV10</div>
<div id="pageheadsub">Setting and Restoring A5</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Section1">Introduction</A><br><br><A HREF="#Section2">The Old Way</A><br><br><A HREF="#Section3">The New, Totally Cool Way</A><br><br><A HREF="#Section4">The Interfaces</A><br><br><A HREF="#Section5">A Special Note</A><br><br><A HREF="#References">References</A><br><br>	 <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">The routines <code>SetupA5</code> and <code>RestoreA5</code> do not work properly whenused with some optimizing Pascal and C compilers.  Two new routines, <code>SetCurrentA5</code> and <code>SetA5</code>, are available in MPW 3.0, and they should work with any compiler.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Aug 01 1988]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content -->        <A NAME=Section1></A><h2>Introduction</h2><p>The in-line glue routines <code>SetupA5</code> and <code>RestoreA5</code> are oftenused by completion routines, VBL tasks, and interrupt handlers written in C andPascal to gain access to an application's global variables.  Unfortunately,these routines play fast and loose with the stack pointer.</p><p>Newer, more sophisticated, optimizing compilers (e.g., MPW C 3.0) will oftenleave function parameters on the stack across multiple function calls, removingthe arguments for several functions with a single instruction.  This significantly reduces code size and execution time, at the expense of a small amount of additional stack usage.  As a side effect, this optimization breaks the <code>SetupA5</code> and <code>RestoreA5</code> glue.</p><p>This Technical Note describes a pair of in-line glue routines which have morefunctionality than <code>SetupA5</code> and <code>RestoreA5</code>, without makingassumptions about a compiler's stack handling.  These routines are provided asa standard part of the MPW Pascal 3.0 and MPW C 3.0 packages, in the filesOSUtils.p and OSUtils.h, respectively.</p> <P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>The Old Way</h2><p>The in-line code for <code>SetupA5</code> was:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    MOVE.L    A5,-(A7)    ; leave old A5 on stack: Danger Will Robinson!    MOVE.L    CurrentA5,A5    ; set current A5</pre>	</TD></TR></TABLE></CENTER><p>The in-line code for <code>RestoreA5</code> was:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre></pre>	</TD></TR></TABLE></CENTER><p>The problem is that <code>SetupA5</code> leaves the old value of <code>A5</code> on thestack, and <code>RestoreA5</code> assumes that the stack pointer is still valid. If the programmer mistakenly calls <code>RestoreA5</code> within a called subroutine, the value that is popped off the stack and stored in <code>A5</code> will be garbage.  Of course, the "garbage" could be something moderately useful, like a return address.</p> <P><A HREF="#top">Back to top</A></P> <a name="Section3"></a><h2>The New, Totally Cool Way</h2><p>The solution to this distressing problem is provided by two new functions inthe MPW 3.0 libraries, <code>SetCurrentA5</code> and <code>SetA5</code>.  The idea behind using these two routines is to get the application's <code>A5</code>, pass it to some interrupt routine, which will use some globals, and then restore it to the original <code>A5</code>.  Before you can call <code>SetA5</code>, you'll have to have the application's real <code>A5</code>.  This is obtained by calling <code>SetCurrentA5</code> at non-interrupt time.  Here's how it should work.</p><p>An application is about to create an interrupt routine such as a VBL task, or acompletion routine to be called from some asynchronous operation.  To get thecurrent <code>A5</code>, the application will use:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre></pre>	</TD></TR></TABLE></CENTER><p>This call performs two functions.  It will get the application's <code>A5</code>,save it in a variable, and set <code>A5</code> to the application's low memory global, <code>CurrentA5</code>. The application will pass the result of <code>SetCurrentA5</code> to the interrupt routine.</p><p>The first instruction that the interrupt routine executes is to set <code>A5</code> to the application's <code>A5</code>.  To do this the interrupt routine calls:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    oldA5:= SetA5(ourA5);        {set A5 to the app's real A5}                        {perform the interrupt task}    ignoreResult:= SetA5(oldA5);    {restore A5 to the original A5}</pre>	</TD></TR></TABLE></CENTER><p>The call to <code>SetA5</code> performs two tasks.  It will set <code>A5</code> to theaddress specified and return the actual address in <code>A5</code>.  You'll use the original <code>A5</code> address to call <code>SetA5</code> when the interrupt routine is about to exit. This action will restore <code>A5</code>.  It's also a good idea to read M.TB.MultifinderMisc, which demonstrates this technique in detail.</p> <P><A HREF="#top">Back to top</A></P> <a name="Section4"></a><h2>The Interfaces</h2><p>The interfaces for <code>SetCurrentA5</code> and <code>SetA5</code>, along with theircorresponding implementation as subroutine calls is:</p><h3>MPW Pascal</h3><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    FUNCTION SetCurrentA5 : LongInt;        INLINE $2E8D, $2A78, $0904;</pre>	</TD></TR></TABLE></CENTER><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    FUNCTION SetA5 (newA5 : LongInt) : LongInt;        INLINE $2F4D, $0004, $2A5F;</pre>	</TD></TR></TABLE></CENTER><h3>MPW C</h3><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    pascal long SetCurrentA5(void);        { 0x2E8D, 0x2A78, 0x0904 };</pre>	</TD></TR></TABLE></CENTER><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    pascal long SetA5 (long newA5) =        { 0x2F4D, 0x0004, 0x2A5F };</pre>	</TD></TR></TABLE></CENTER><h3>Assembly Language</h3><p>The following assembly-language version is for those of you who are not using acompiler capable of handling multiple word in-line functions, such as MPW C 2.0.2.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>SetCurrentA5    MOVE.L    A5,4(A7)    ; store old A5 as function result    MOVE.L    currentA5,A5    ; set A5 to low memory global    RTS</pre>	</TD></TR></TABLE></CENTER><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>SetA5    MOVE.L    (A7)+,A0    ; save return address    MOVE.L    A5,4(A7)    ; store old A5 as function result    MOVE.L    (A7)+,A5    ; set A5 to passed value    JMP    (A0)</pre>	</TD></TR></TABLE></CENTER> <P><A HREF="#top">Back to top</A></P> <a name="Section5"></a><h2>A Special Note</h2><p>Many optimizing compilers, including the MPW C and Pascal compilers, may put the address of a global variable (i.e., a large array or record) into a register <b>before</b> your call to <code>SetCurrentA5</code> or <code>SetA5</code>. If this happens, incorrect references to your global data may be generated. To avoid this problem, you can divide your completion routine into two separate routines:  one to set up and restore <code>A5</code> and one to do the actualcompletion work.  Refer to M.TB.MultifinderMisc and the following code sample for getting the application's <code>A5</code> while in an interrupt routine. The routines below will be called at interrupt time and must all be in the same code segment; otherwise, jump table references, which use <code>A5,</code> are required.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    void DoCompletionRoutine(ParmBlkPtr pb, OSErr result)    {        aGlobal = -1;                    /* do some work        */    }    pascal void MyCompletionRoutine    /* This is the actual completion routine that will be called.            */    /* There are two assembly routines not shown, GetOurA5 and            */    /* GetPBPtr.  The application's A5 had been saved in front of            */    /* the ParmBlk, which is pointed to in A0.  The assembly                */    /* routine GetOurA5 obtains A5 that was stored in front of the pb        */    /* by the application.  This technique is used in M.TB.MultifinderMisc.        */    /* All of these routines must be within the same code segment.            */    {        long oldA5;        oldA5 = SetA5(GetOurA5);            /* set to our A5         */        DoCompletionRoutine(GetPBPtr,result);    /* pbPtr is in A0        */        (void) SetA5(oldA5);                /* restore previous A5    */    }</pre>	</TD></TR></TABLE></CENTER><p>We recommend that you switch over to the new routines as soon as possible, nomatter what development system you use.</p> <P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><p><i>Inside Macintosh</i>, Volume V-1, Compatibility Guidelines</p><p><A HREF = "../pt/pt_13.html">M.PT.Customs</a></p><p><A HREF = "../tb/tb_35.html">M.TB.MultifinderMisc</a></p> <P><A HREF="#top">Back to top</A></P>         <P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (48K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/ov_10.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/ov/ov_10.html%3Fid%3DDTS10002608-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/ov/ov_10.html%3Fid%3DDTS10002608-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/ov/ov_10.html%3Fid%3DDTS10002608-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>