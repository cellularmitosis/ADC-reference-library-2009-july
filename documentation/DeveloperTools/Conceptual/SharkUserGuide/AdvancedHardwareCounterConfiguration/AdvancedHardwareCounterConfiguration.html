<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Shark User Guide: Hardware Counter Configuration</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Hardware Counter Configuration"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP40005233-CH10" title="Hardware Counter Configuration"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000436" target="_top">Tools</a> &gt; <a href="../../../Performance-date.html#//apple_ref/doc/uid/TP30000440-TP30000436-TP30000901" target="_top">Performance</a> &gt; <a href="../Introduction/Introduction.html#//apple_ref/doc/uid/TP40005233-CH1-DontLinkElementID_6">Shark User Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../CustomConfigurations/CustomConfigurations.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../CommandReference/CommandReference.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP40005233-CH10-SW1" title="Hardware Counter Configuration"></a><h1>Hardware Counter Configuration</h1><p>The different CPUs and North bridge chipsets available in Macintosh systems have widely varying performance monitoring capabilities. Because there are such a wide variety of counters and ways in which they can be combined to get useful information, the default configurations supplied with each version of Shark can only scratch the surface of the immense variety of possible configurations. As a result, this is one of the main areas where building custom Shark configurations can be helpful — but for the same reason it is also one of the most complex aspects of Shark configuration.</p><p>Above and beyond its basic, system-wide sampling functionality, Shark’s main “Timed Samples and Counters” data source offers access to this rich selection of performance counters. Its basic sampling configuration options were already covered briefly in <span class="content_text"><a href="../CustomConfigurations/CustomConfigurations.html#//apple_ref/doc/uid/TP40005233-CH8-SW12">“Simple Timed Samples and Counters Config Editor.”</a></span> However, there are many more options available in <em>Advanced</em> mode of the configuration editor (see <span class="content_text"><a href="../CustomConfigurations/CustomConfigurations.html#//apple_ref/doc/uid/TP40005233-CH8-SW13">“The Config Editor”</a></span> for how to get here), where multiple separate tabs provide access to <em>all</em> of the settings that the PlugIn has. Depending upon factors such as the underlying hardware capabilities, the number of tabs can vary. In general, Shark will present the advanced <strong>Sampling</strong> tab, one to four processor and/or North bridge tab(s), and the <strong>MacOS</strong> performance counter tab. The “processor” tab(s) allow configuration of processor performance counters, and are titled with the make and model of the processor. For most processors, all counter configuration fits in a single tab, but in the case of the PowerPC 970 CPU there are so many settings that a second <strong>IMC</strong> tab is also added. Finally, if the North bridge chipset in the system has hardware performance counters, then there will be one or two tab(s) titled with the model of the chipset. </p><p>This chapter describes how you can configure the wide variety of hardware counters using the customized controls available in these configuration editor panes. It will start by describing the advanced data source PlugIn settings available on the most modern Macs and work through describing the PlugIn tabs supporting the older systems’ CPUs and North bridge performance monitor counters (PMCs), in detail.</p>
<!-- This template is being used for both PDF and HTML. -->

    
    <h4>In this section:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW23">Configuring the Sampling Technique: The Sampling Tab</a>
				
			<br/>
			
        
			
			
				<a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW24">Common Elements in Performance Counter Configuration Tabs</a>
				
			<br/>
			
        
			
			
				<a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW27">MacOS X OS-Level Counters Configuration</a>
				
			<br/>
			
        
			
			
				<a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW17">Intel CPU Performance Counter Configuration</a>
				
			<br/>
			
        
			
			
				<a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW18">PowerPC G3/G4/G4+ CPU Performance Counter Configuration</a>
				
			<br/>
			
        
			
			
				<a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW19">PowerPC G5 (970) Performance Counter Configuration</a>
				
			<br/>
			
        
			
			
				<a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW28">PowerPC North Bridge Counter Configuration</a>
				
			<br/>
			
        
			
			
				<a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW30">ARM11 CPU Performance Counter Configuration</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP40005233-CH10-SW23" title="Configuring the Sampling Technique: The Sampling Tab"></a><h2>Configuring the Sampling Technique: The Sampling Tab</h2><p>The <em>Sampling</em> tab is always the <strong>first</strong> tab presented when one chooses to edit the “Timed Samples and Counters” data source in “Advanced” mode. This tab controls how to start and stop sampling, and when samples are taken. The remainder of this section discusses the various features of the tab.</p><p>Once you have decided which counters you want to measure, and thought a bit about how you might want to control sampling, there are several configuration steps that must be performed using the controls on the <em>Sampling</em> tab, illustrated in <span class="content_text">Figure 8-1</span>.</p><br/><div><a name="//apple_ref/doc/uid/TP40005233-CH10-SW2" title="Figure 8-1Timed Samples &amp;amp; Counters Data Source - Advanced Sampling Tab"></a><p><strong>Figure 8-1&nbsp;&nbsp;</strong>Timed Samples &amp; Counters Data Source - Advanced Sampling Tab</p><img src = "../Art/AdvancedSamplingTab.jpg" alt = "Timed Samples &amp; Counters Data Source - Advanced Sampling Tab" ></div><br/><ol class="ol"><li class="li"><p><strong>Sampling Control</strong>— First, you must choose ways to start and stop sampling using the options at the top of the configuration controls. These options are essentially identical to the basic options used to control “Timed Samples and Counters.”</p><ul class="ul"><li class="li"><p><em>WTF Mode</em>— If enabled, Shark will collect samples until you explicitly stop it. However, it will only store the last N samples, where N is the number entered into the sample history field (10,000 by default). This mode is also described in <span class="content_text"><a href="../SelectingExecutiontoSampleorTrace/SelectingExecutiontoSampleorTrace.html#//apple_ref/doc/uid/TP40005233-CH13-SW1">“Windowed Time Facility (WTF).”</a></span></p></li><li class="li"><p><em>Time Limit</em>— The maximum amount of time to record samples. This is ignored if WTF mode is enabled.</p></li><li class="li"><p><em>Start Delay</em>— Amount of time to wait after the user selects “Start” before data collection actually begins. This helps prevent Shark from sampling itself.</p></li><li class="li"><p><em>Sample Limit</em>— Sets the maximum number of samples to record. Specifying a maximum of <em>N</em> samples will result in at most <em>N</em> samples being taken on a uniprocessor machine or <em>C</em>*<em>N</em> samples taken on a multiprocessor system with <em>C</em> processors. This prevents the sample buffers from growing too large in case you happen to choose a combination of a large time limit and high sampling rate.</p></li></ul></li><li class="li"><p><strong>Sample Trigger</strong>— Next, choose when you want samples to be taken between the “start” and “stop” events using the options in the middle of the configuration controls. There are a variety of ways, one of which is unique to performance monitor work.</p><ul class="ul"><li class="li"><p><em>Timed Sampling</em>— The most common way to use counters is to record the values of all counters periodically, when a timer fires. This produces a distribution of events over time, much like a Time Profile. Because the events are counted for the entire time between sample points, and not just <em>at</em> the sample points, they are only approximately correlated with the program counter information sampled by Shark.</p></li><li class="li"><p><em>Event-Triggered Sampling</em>— An alternative is to let performance events trigger sampling themselves. As a result, this is only possible when performance monitoring counters are used. One counter at a time can be set to a special <em>Trigger</em> mode which initiates sampling when the event count reaches a preset <em>Sample Interval</em>. If the event occurs frequently, many samples will be taken, while if it occurs infrequently then only a few samples will be taken. There are pros and cons to this mode. First, you can only trigger on one event type at a time. However, each sample point will be taken <em>immediately</em> after the event occurs, so you can accurately determine which lines of code from your program are causing the events. Hence, this mode is most helpful when you are trying to determine which code is triggering a particular event.</p></li><li class="li"><p><em>Programmatic Sampling</em>— A third alternative is to let your program determine when to take a sample. Your program can link to the CHUD framework and call chudRecordUserSample, which will force a performance counter sample to be taken. In this way, you will be able to see events at a rate that is precisely controlled by you. This is useful when you want to examine issues such as how your program’s behavior varies over time, from one loop iteration to another.</p></li></ul><p>Once you have chosen a technique for controlling the sampling, just check the appropriate box in this section of the tab and fill out any necessary parameters.</p><ul class="ul"><li class="li"><p><em>Time</em>— A sample is taken every <em>T</em> time units (1 millisecond, by default). This is the same control used ot vary the sampling frequency of a standard time profile.</p></li><li class="li"><p><em>CPU PMC Events</em>— A sample is taken every <em>N</em> CPU PMC events from the selected CPU PMC. Only one trigger PMC can be selected at a time. In a multi-processor system, any CPU can trigger the collection for all CPUs.</p></li><li class="li"><p><em>OS PMC Events</em>— A sample is taken every <em>N</em> OS performance monitor counter (PMC) events from a selected OS PMC. Only one trigger PMC can be selected at a time. </p></li><li class="li"><p><em>chudRecordUserSample</em>— A sample is recorded for every call to the <code>CHUD.framework</code><code>chudRecordUserSample()</code> function. This is analogous to using signposts (<span class="content_text"><a href="../SystemTracing/SystemTracing.html#//apple_ref/doc/uid/TP40005233-CH4-SW27">“Sign Posts ”</a></span>) with system trace.</p></li></ul><p>Finally, once you have chosen a sampling mode, there is one additional variation that can be applied to the nominal sampling rate. The <strong>Fuzz</strong> feature, when enabled, randomizes the sampling interval by ±N% around the specified nominal value. For example, if timer sampling is selected, the sampling period is 1ms and <em>Fuzz</em> is set to 5%, the actual sampling period will vary randomly between 0.95ms and 1.05ms. <em>Fuzz</em> helps prevent harmonic relationships between the sampling interval and execution behavior. You should use this if your code performs the same work repeatedly, with very little variation in its patterns.</p></li><li class="li"><p><strong>Samples</strong>—Down at the bottom of the tab are a couple of “miscellaneous” options.</p><ul class="ul"><li class="li"><p><em>Record Callstacks</em>— When enabled, Shark will collect the function backtrace along with the program counter value for each sample. This is used by default, but can be disabled if you need to record an extremely large number of samples into Shark’s kernel buffers or if the callstack recording is impacting performance (a possibility if sample rates are very high).</p></li><li class="li"><p><em>Record Final Sample</em>— By default, when sampling is stopped all collection is terminated <em>immediately</em>. In a multiprocessor system, this can cause the last sample from some processors to be dropped if they are a little bit behind the “main” processor and therefore have not quite completed a time interval or reached an interrupt state when Shark is stopped. This setting will force collection of the last sample from all processors, even if it is not a “full” sample.</p></li></ul></li><li class="li"><p><strong>Device Selection</strong>— Finally, below the tab itself are menus that let you choose a device to target. While this will often simply be the processor and/or North bridge on your own machine, Shark also allows you to choose other processors that aren’t even installed on your machine. This latter option is quite useful if you are making measurements of a different machine over a network <span class="content_text"><a href="../SelectingExecutiontoSampleorTrace/SelectingExecutiontoSampleorTrace.html#//apple_ref/doc/uid/TP40005233-CH13-SW19">“Network/iPhone Profiling.”</a></span></p><ul class="ul"><li class="li"><p><em>CPU PopUp Menu</em>— This selects the processor type to configure. By default, the CPU in the running system is selected. If <em>any</em> CPU performance counters are enabled (in either Counter or Trigger mode, as described in <span class="content_text"><a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW3">“Counter Control”</a></span>), then the configuration will only be compatible with machines that have the specified CPU. </p></li><li class="li"><p><em>North Bridge PopUp Menu</em>— This selects the memory controller type to configure. By default, the North bridge in the running system is selected, or “none” if no North bridge counters are available in the system. If <em>any</em> memory controller performance counters are enabled (in Counter mode, as described in <span class="content_text"><a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW3">“Counter Control”</a></span>), then the configuration will only be compatible with machines that have the specified memory controller. Please note that currently there are no supported North bridge performance counters in Intel-based Macs. </p></li></ul><p>Changing either of these settings will not have a visible effect on the “Sampling” tab. However, both will change the contents of the relevant hardware tab(s), the name of those tab(s) will update immediately, and the controls for setting up events will change if one of the hardware tabs is visible.</p></li></ol><a name="//apple_ref/doc/uid/TP40005233-CH10-SW24" title="Common Elements in Performance Counter Configuration Tabs"></a><h2>Common Elements in Performance Counter Configuration Tabs</h2><p>All of the various performance counter configuration tabs have many unique elements, as the various processors and North bridges supported by MacOS X are significantly different from each other in many ways. However, Shark uses several common interfaces throughout these various tabs in order to make it reasonably easy for you to work with more than one variety of Macintosh. To avoid repeating these descriptions for every tab, they are discussed here.</p><a name="//apple_ref/doc/uid/TP40005233-CH10-SW3" title="Counter Control"></a><h3>Counter Control</h3><p>Every performance counter is controlled with a consistent set of three controls, like those illustrated below in <span class="content_text">Figure 8-2</span>. This section describes how they work, for any variety of hardware.</p><br/><div><a name="//apple_ref/doc/uid/TP40005233-CH10-SW4" title="Figure 8-2A typical set of performance counter controls"></a><p><strong>Figure 8-2&nbsp;&nbsp;</strong>A typical set of performance counter controls</p><img src = "../Art/CounterControl.jpg" alt = "A typical set of performance counter controls" ></div><br/><p>There are three controls associated with every performance counter</p><ol class="ol"><li class="li"><p><strong>Enable Button</strong>— This button turns the counter on and off. If it is on, then it further controls whether the counter is used as the event trigger source or not. As a result, every time it is pressed it will toggle among three different states:</p><ul class="ul"><li class="li"><p><em>Unused</em>— The counter will not count, and is ignored by Shark.</p></li><li class="li"><p><em>Counter</em>— The counter counts the event selected using the <em>Event List</em> menu. Its contents will be recorded every time that Shark takes a sample.</p></li><li class="li"><p><em>Trigger</em>— The counter is enabled as the sampling trigger. Whenever it has counted the number of events listed in the <em>Sample Interval</em> box, it will cause Shark to record another sample. Only one counter at a time can be in this mode; you must switch any previous counter to use one of the other two modes before it is possible to select this mode with a second counter. Also, note that this mode is not available on the counters in all types of Macintosh hardware (particularly older processors and North bridges).</p></li></ul></li><li class="li"><p><strong>Event List</strong>— This list displays the names of all events that can be counted by this counter. It may also include some “reserved” event types that can be chosen, but are not actually implemented on the hardware in any useful way. For most types of hardware, these lists are constant. However, in the case of the PowerPC 970, the event lists can change depending upon the settings of the other controls in the tab. See <span class="content_text"><a href="../970PMCTablesAppendix/970PMCTablesAppendix.html#//apple_ref/doc/uid/TP40005233-CH27-SW1">“PPC 970 (G5) Performance Counter Event List”</a></span> for more details.</p></li><li class="li"><p><strong>Sample Interval</strong>— This is the number of events that must occur before this PMC will trigger sampling. It is ignored unless this particular counter has been set to <em>Trigger</em> mode using the <em>Enable Button</em>. If a counter cannot support <em>Trigger</em> mode, then this box will not be present.</p></li></ol><a name="//apple_ref/doc/uid/TP40005233-CH10-SW25" title="Privilege Level Filtering"></a><h3>Privilege Level Filtering</h3><p>With the various performance counters, it is often possible to filter events such that only events from user-level code or only events from privileged (supervisor mode) are counted. Shark disables this option if it is not applicable to the currently selected sampling trigger. </p><ul class="spaceabove"><li class="li"><p><strong>Any </strong>— Record all performance counter events of this type.</p></li><li class="li"><p><strong>User</strong>— Record performance counter events of this type only when running user-level code.</p></li><li class="li"><p><strong>Supervisor</strong>— Record performance counter events of this type only when running supervisor-level code in the OS kernel.</p></li></ul><a name="//apple_ref/doc/uid/TP40005233-CH10-SW26" title="Process Marking"></a><h3>Process Marking</h3><p>With the various performance counters, Shark can filter events such that only events from a user-defined selection of “marked” processes are actually counted. In this way, you could limit counting to events from your own application’s process, for example, while ignoring all others. Alternatively, a user may choose to record events from all “unmarked” processes. This is a good choice when you want to tell Shark to ignore a few processes — probably background ones like daemons or the Finder — while recording events from everything else.</p><ul class="spaceabove"><li class="li"><p><strong>Any</strong>— Record all events, no matter when they occur</p></li><li class="li"><p><strong>Marked</strong>— Record only events that occur in “marked” processes or threads that you have selected.</p></li><li class="li"><p><strong>Unmarked</strong>— Record only events that occur in “unmarked” processes or threads.</p></li></ul><p>You can mark processes with Shark’s <em>Process Marker</em> (<span class="content_text">Figure 8-3</span>). The <em>Process Marker</em> can be opened via the <em>Sampling</em>→<em>Mark Process</em> menu item. Shark disables this menu item for timer sampling, because the marked bit is ignored in that case.</p><br/><div><a name="//apple_ref/doc/uid/TP40005233-CH10-SW16" title="Figure 8-3Process Marker"></a><p><strong>Figure 8-3&nbsp;&nbsp;</strong>Process Marker</p><img src = "../Art/figure5-7.jpg" alt = "Process Marker" ></div><br/><p>It is also possible to enable thread marking programmatically, using the <code>chudMarkPID(pid_t pid, int markflag)</code> call (in the CHUD framework) to set the marked flag to a value of TRUE (<code>markflag</code> = 1) or FALSE (<code>markflag</code> = 0) for any arbitrary process.</p><p>While this mechanism is powerful, it does have some limitations imposed on it by how the OS internally tracks the “marked” state of each thread. New threads created by a process <em>after</em> you have marked it will not be marked; you will need to mark the process again to make sure all of the newly created threads are marked. In addition, the marked bit is not copied to supervisor space during system calls or other supervisor state code done on behalf of the marked process, so if you choose to record “marked” events only you will only see events triggered by your user-level code.</p><a name="//apple_ref/doc/uid/TP40005233-CH10-SW27" title="MacOS X OS-Level Counters Configuration"></a><h2>MacOS X OS-Level Counters Configuration</h2><p>This tab, illustrated in <span class="content_text">Figure 8-4</span>, is always the rightmost tab in the editor. It provides access to a variety of counters for operating system events, such as page faults. These OS counters support trigger mode, privilege level filtering, and marked thread filtering on all Macintosh platforms. However, all OS performance counters must share the same settings for privilege level and marked thread filtering. The events counted by the operating system’s counters can be divided into the following categories:</p><ul class="ul"><li class="li"><p><strong>Virtual Memory:</strong> Events such as page faults, zero fill faults, copy-on-write faults, and page cache hits</p></li><li class="li"><p><strong>System Calls:</strong> Transfers into the kernel requested by user code, divided up into BSD and Mach syscalls</p></li><li class="li"><p><strong>Scheduler Events:</strong> Events such as context switches, “thread ready” events, and stack handoffs</p></li><li class="li"><p><strong>Disk I/O Events:</strong> Disk reads and writes, with optional breakdown by type (data, disk control metadata, VM page-in, and VM page-out) and timing (synchronous and asynchronous)</p></li></ul><p>No unique controls are needed to control these counters; for information on all of the controls, see <span class="content_text"><a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW3">“Counter Control.”</a></span></p><br/><div><a name="//apple_ref/doc/uid/TP40005233-CH10-SW5" title="Figure 8-4MacOS X Performance Counters Configuration"></a><p><strong>Figure 8-4&nbsp;&nbsp;</strong>MacOS X Performance Counters Configuration</p><img src = "../Art/AdvancedMacOSPMCs.jpg" alt = "MacOS X Performance Counters" ></div><br/><a name="//apple_ref/doc/uid/TP40005233-CH10-SW17" title="Intel CPU Performance Counter Configuration"></a><h2>Intel CPU Performance Counter Configuration</h2><p>This section describes how you can make custom configurations for Macs equipped with Intel processors. Macs equipped with Intel Core processors have access to two fully programmable performance counters, and Macs equipped with Intel Core 2 processors have an additional three fixed-purpose counters. The two families can both count a similar but not identical list of events on the programmable processors. Full event listings are provided in <span class="content_text"><a href="../IntelCorePMCTablesAppendix/IntelCorePMCTablesAppendix.html#//apple_ref/doc/uid/TP40005233-CH22-SW1">“Intel Core Performance Counter Event List”</a></span> and <span class="content_text"><a href="../IntelCore2PMCTablesAppendix/IntelCore2PMCTablesAppendix.html#//apple_ref/doc/uid/TP40005233-CH23-SW1">“Intel Core 2 Performance Counter Event List”</a></span> for the Core and Core 2, respectively.</p><p><span class="content_text">Figure 8-5</span> shows the single configuration tab for the Intel Core 2 processor (the one for the Core is virtually identical, but lacks PMCs 3–5). For the most part, it uses the standard controls from <span class="content_text"><a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW3">“Counter Control.”</a></span> A nice feature of these cores is that control over user/supervisor event counting selection is provided <em>independently</em> for each counter on these cores. On the other hand, “marked” threads and processes cannot be used.</p><p>One unique control is necessary with these cores: the <strong>Event Mask Bits</strong> control. This control, which is used more extensively in the Core 2 than in the Core processor, acts to fine-tune the type of events counted. For example, instead of just counting all line fetches from the L2 cache, you can use these bits to only count line fetches of lines in particular states (such as “exclusive,” or only in this L2 cache). The selection of bits available and their behavior varies depending upon the type of event being counted. The description of the effect that mask bits will have on the event counting is described in a tooltip both on the event name, as you are choosing among the various event types, and also in a tooltip that appears if you wave your mouse cursor over each of the bit-names in the mask list. Any bit in the list labeled *Reserved* should not be enabled. A brief summary of which bits are active for any particular event is included in the event lists in <span class="content_text"><a href="../IntelCorePMCTablesAppendix/IntelCorePMCTablesAppendix.html#//apple_ref/doc/uid/TP40005233-CH22-SW1">“Intel Core Performance Counter Event List”</a></span> and <span class="content_text"><a href="../IntelCore2PMCTablesAppendix/IntelCore2PMCTablesAppendix.html#//apple_ref/doc/uid/TP40005233-CH23-SW1">“Intel Core 2 Performance Counter Event List.”</a></span></p><br/><div><a name="//apple_ref/doc/uid/TP40005233-CH10-SW6" title="Figure 8-5Intel Core 2 Configuration Tab"></a><p><strong>Figure 8-5&nbsp;&nbsp;</strong>Intel Core 2 Configuration Tab</p><img src = "../Art/IntelCore2AdvPMC.jpg" alt = "Intel Core 2 Performance Counter Configuration" ></div><br/><a name="//apple_ref/doc/uid/TP40005233-CH10-SW18" title="PowerPC G3/G4/G4+ CPU Performance Counter Configuration"></a><h2>PowerPC G3/G4/G4+ CPU Performance Counter Configuration</h2><p>This section describes how you can make custom configurations for Macs equipped with PowerPC G3, G4, and G4+ processors. Macs equipped with these processors have access to four (G3, G4) or six (G4+) fully programmable performance counters. The list of available events varies significantly from processor to processor, since many new event types were added with each generation of PowerPC chips. Full event listings are provided in <span class="content_text"><a href="../750PMCTablesAppendix/750PMCTablesAppendix.html#//apple_ref/doc/uid/TP40005233-CH24-SW1">“PPC 750 (G3) Performance Counter Event List,”</a></span> <span class="content_text"><a href="../7400PMCTablesAppendix/7400PMCTablesAppendix.html#//apple_ref/doc/uid/TP40005233-CH25-SW1">“PPC 7400 (G4) Performance Counter Event List,”</a></span> and <span class="content_text"><a href="../7450PMCTablesAppendix/7450PMCTablesAppendix.html#//apple_ref/doc/uid/TP40005233-CH26-SW1">“PPC 7450 (G4+) Performance Counter Event List”</a></span> for the G3, G4, and G4+ processor cores, respectively.</p><p><span class="content_text">Figure 8-6</span> shows the single configuration tab for the G4+ processor (the one for the G3 and G4 is virtually identical, but lacks PMCs 5–6). For the most part, it uses the standard controls from <span class="content_text"><a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW3">“Counter Control.”</a></span> Both user/supervisor event counting selection and “marked” threads and processes can be used, but all counters must use the same settings at once.</p><p>Three relatively minor additional controls are provided with all of these cores, to adjust features specific to these processors. The three controls are numbered on <span class="content_text">Figure 8-6</span>, and are:</p><ol class="ol"><li class="li"><p><strong>Threshold:</strong> This sets a lower limit on the number of processor cycles that a wide variety of stall events must take before they are actually recorded, in case you want to filter out short stalls and thereby focus in only on the most lengthy and problematic stalls.</p></li><li class="li"><p><strong>TB Select:</strong> This is the divider used for timebase events that cause processor exceptions, and selects from four different division ratios.</p></li><li class="li"><p><strong>Branch Folding:</strong> PowerPC G3 and G4 CPUs have a feature that allows them to coalesce multiple branch instructions into one instruction, instead of issuing multiple branch instructions. When this feature is enabled (the default) performance events counting branch instructions and predictions can be inaccurate. Hence, for best results when counting performance events dealing with branch instructions, you should usually disable this feature. See your processor’s User Manual for more details.</p><p><em>Warning:</em>If you leave branch folding disabled and exit Shark, branch folding will <em>remain</em> disabled. While this will not cause any correctness problems or crashes, it can adversely affect performance.</p></li></ol><br/><div><a name="//apple_ref/doc/uid/TP40005233-CH10-SW7" title="Figure 8-6PowerPC G4+ Configuration Tab (G3 and G4 are similar)"></a><p><strong>Figure 8-6&nbsp;&nbsp;</strong>PowerPC G4+ Configuration Tab (G3 and G4 are similar)</p><img src = "../Art/PPC7450AdvPMC.jpg" alt = "PowerPC G4+ Configuration Tab (G3 and G4 are similar)" ></div><br/><a name="//apple_ref/doc/uid/TP40005233-CH10-SW19" title="PowerPC G5 (970) Performance Counter Configuration"></a><h2>PowerPC G5 (970) Performance Counter Configuration</h2><p>This section describes how you can make custom configurations for Macs equipped with PowerPC G5 (970) processors. Macs equipped with these processors have access to eight fully programmable performance counters that can count an incredible number of different performance events, as listed in <span class="content_text"><a href="../970PMCTablesAppendix/970PMCTablesAppendix.html#//apple_ref/doc/uid/TP40005233-CH27-SW1">“PPC 970 (G5) Performance Counter Event List.”</a></span> Because there are so many different types of events, the G5 uses a unique system of multiplexers to pre-filter many types of events before they reach the event counters. Depending upon the settings supplied for these various multiplexers, it is possible to enable vastly different selections of events in the performance counter event menus.</p><p><span class="content_text">Figure 8-7</span> shows the first of two configuration tabs used by the G5 processor’s configuration control. The top half and lower left corner just use standard controls from <span class="content_text"><a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW3">“Counter Control.”</a></span> Both user/supervisor event counting selection and “marked” threads and processes can be used, but all counters must use the same settings at once.</p><p>In addition, several additional controls are provided. Most are multiplexer controls to switch the various event pre-filtering multiplexers, but the last two adjust features specific to these processors. These controls are numbered on <span class="content_text">Figure 8-7</span>, and are:</p><ol class="ol"><li class="li"><p><strong>TTM0 Event Selector:</strong> This first-stage mux selects collections of events from different processor functional units for all four second-stage muxes (FPU = floating point unit, ISU = instruction sequencer unit, IFU = instruction fetch unit, and VMX = Altivec processing unit).</p></li><li class="li"><p><strong>TTM1 Event Selector:</strong> This first-stage mux selects collections of events from different processor functional units for all four second-stage muxes (IDU = instruction dispatch unit, ISU = instruction sequencer unit, and GPS = storage subsystem). </p></li><li class="li"><p><strong>TTM3 Event Selector:</strong> This stage 1 mux selects collections of events from load/store unit #1 (LSU1), in four different patterns for second-stage muxes 2 and 3 only (2/3 = lane 2 &amp; 3 both “upper” LSU1 events, 2/7 = lane 2 “upper” &amp; 3 “lower” LSU1 events, 6/3 = lane 2 “lower” &amp; 3 “upper” LSU1 events, 6/7 = lane 2 &amp; 3 both “lower” LSU1 events). </p></li><li class="li"><p><strong>Even Lane Event Selectors:</strong> These two second-stage muxes select inputs for performance counters 1, 2, 5, and 6 from among the different first-stage muxes or directly from the load/store units (LSU0/LSU1).</p></li><li class="li"><p><strong>Odd Lane Event Selectors:</strong> These two second-stage muxes select inputs for performance counters 3, 4, 7, and 8 from among the different first-stage muxes or directly from the load/store units (LSU0/LSU1).</p></li><li class="li"><p><strong>Speculative Event Selector:</strong> This enables speculative event recording and performance counters 5 and/or 7. A full discussion of these counts is beyond the scope of this document. See the <span class="content_text"><a href="http://www.ibm.com/chips/techlib/techlib.nsf/products/PowerPC_970_and_970FX_Microprocessors" target="_blank">PowerPC 970 Documentation</a></span> for more information. </p></li><li class="li"><p><strong>Threshold:</strong> This sets a lower limit on the number of processor cycles that a wide variety of stall events must take before they are actually recorded, in case you want to filter out short stalls and thereby focus in only on the most lengthy and problematic stalls.</p></li><li class="li"><p><strong>TB Select:</strong> This is the divider used for timebase events that cause processor exceptions, and selects from four different division ratios. More information is available in the <span class="content_text"><a href="http://www.ibm.com/chips/techlib/techlib.nsf/products/PowerPC_970_and_970FX_Microprocessors" target="_blank">PowerPC 970 Documentation</a></span>.</p></li></ol><br/><div><a name="//apple_ref/doc/uid/TP40005233-CH10-SW8" title="Figure 8-7PowerPC 970 Processor Performance Counters Configuration"></a><p><strong>Figure 8-7&nbsp;&nbsp;</strong>PowerPC 970 Processor Performance Counters Configuration</p><img src = "../Art/PPC970AdvPMC.jpg" alt = "PowerPC 970 Processor Performance Counters Configuration" ></div><br/><p><span class="content_text">Figure 8-8</span> shows the second tab used to configure the PowerPC 970 performance counters, the <strong>IMC</strong> tab. This tab provides access to the Instruction Fetch Unit's instruction marking and the Instruction Dispatch Unit’s instruction sampling feature, a pair of mechanisms that allow you to count individual instruction types as they are executed on the PowerPC 970.</p><p>The IFU instruction matching facility provides a CAM array to match PowerPC instructions by opcode or extended opcode as they are fetched. When a PowerPC instruction is fetched from memory, the IFU instruction matching facility compares the instruction with the opcode/extended opcode mask values in each of its CAM array rows. If a PowerPC instruction matches one or more IMC array row masks, you may have it “mark” the instruction in the L1 instruction cache. Thereafter, every time it is executed special performance counter events may occur to count it. Please note that as long as an instruction resides in the L1 instruction cache, its match bit will remain unchanged. Hence, if the match condition for an instruction changes, then the L1 instruction cache should be flushed to force the lines to be reloaded and the “match” bits to be recalculated.</p><p>Another level of instruction matching — performed in the IDU — allows you to mark instructions (or their constituent microinstructions, for the more complex PowerPC instructions) on the basis of some categories related to how they interact with the PowerPC 970 pipeline, such as whether or not they are internally broken up into microcode. Because this comes later in the processor’s pipeline, it is possible that it can override previous IFU marking.</p><p>Due to the very flexible and complex nature of these mechanisms, it is highly recommended that you read the pertinent sections of the <span class="content_text"><a href="http://www.ibm.com/chips/techlib/techlib.nsf/products/PowerPC_970_and_970FX_Microprocessors" target="_blank">PowerPC 970 Documentation</a></span>, Sections 10.9 and 10.10 in the main user’s manual.</p><br/><div><a name="//apple_ref/doc/uid/TP40005233-CH10-SW9" title="Figure 8-8PowerPC 970 IMC (IFU) Configuration Tab"></a><p><strong>Figure 8-8&nbsp;&nbsp;</strong>PowerPC 970 IMC (IFU) Configuration Tab</p><img src = "../Art/PPC970IMCAdvanced.jpg" alt = "PowerPC 970 IMC Configuration Tab" ></div><br/><p>In the top part of the IMC pane are some general controls (black numbers on white):</p><ol class="ol"><li class="li"><p><strong>Instruction Matching</strong>— This selects the type of instruction matching to setup and use.</p><ul class="ul"><li class="li"><p><em>None </em> – (default) No instruction matching will take place</p></li><li class="li"><p><em>IFU</em> – Use the Instruction Fetch Unit’s IMC capability.</p></li><li class="li"><p><em>IDU</em> – Use the Instruction Dispatch Unit’s sampling capability.</p></li></ul></li><li class="li"><p><strong>IOP Marking</strong> – This pre-filter will limit the type of internal PowerPC microinstructions (IOPs) that are matched or sampled.</p><ul class="ul"><li class="li"><p><em>All IOPs </em> – (default) Any IOP will pass</p></li><li class="li"><p><em>µCode IOPs</em> –Only IOPs resulting from microcode expansion will pass.</p></li><li class="li"><p><em>One Per Inst</em> – Only pass one IOP per PowerPC instruction.</p></li><li class="li"><p><em>1st IOP of ld/st</em> – Only pass the first IOP to go to an LSU for every PowerPC load/store instruction, a less restrictive form of the previous filter.</p></li></ul></li></ol><p>Below that, a variety of controls (white numbers on black) operate on either the IFU’s instruction matching or IDU’s sampling. In <span class="content_text">Figure 8-8</span>, the IFU instruction matching pane is shown:</p><ol class="ol"><li class="li"><p><strong>IMC Row PopUp</strong>— There are six CAM rows that can be configured to match instructions in the IFU. Use this to select one of the six rows to manage.</p></li><li class="li"><p><strong>IMC Row Enable</strong>— Enable and disable the IMC rows with this check box.</p></li><li class="li"><p><strong>IMC Match None/All Buttons</strong>— Flips the configuration bits to match no PowerPC or all PowerPC instructions with a single button press. If you only want to match a small number of instructions, start with “none” and enable the instructions you want, while if you want to match many then start with “all” and knock off ones you don’t need.</p></li><li class="li"><p><strong>MSR Configuration Bits</strong>— Selects instructions to match on the basis of a few large and coarse categorizations about when they may execute (matching specific bits in the machine status register, or MSR). In general, you will want to leave these set to “any” (asterisk), but you may optionally narrow down the possible list by setting these to 0 or 1.</p><ul class="ul"><li class="li"><p><em>TA </em>— (Target) Leave this set to “any” (asterisk), since it is ignored in all cases.</p></li><li class="li"><p><em>PR</em>— (Privilege) Matches instructions on the basis of their privilege requirements.</p><ul class="nested"><li class="nested li"><p><em>0 </em>— Matches only instructions executable in both user and supervisor mode.</p></li><li class="nested li"><p><em>1</em>— Matches only privileged instructions executable in supervisor mode only.</p></li></ul></li><li class="li"><p><em>FP</em>— (Floating Point Unit Availablity) This matches instructions on the basis of whether or not they need and FPU to be present.</p><ul class="nested"><li class="nested li"><p><em>0 </em>— Matches only non-FPU instructions.</p></li><li class="nested li"><p><em>1</em>— Matches only FPU instructions..</p></li></ul></li><li class="li"><p><em>VMX</em>— (Vector Unit Availability) This matches instructions on the basis of whether or not they need an Altivec vector unit to be present.</p><ul class="nested"><li class="nested li"><p><em>0 </em>— Matches only non-Altivec unit instructions..</p></li><li class="nested li"><p><em>1</em>— Matches only Altivec unit instructions.</p></li></ul></li></ul></li><li class="li"><p><strong>Major Opcode Bits</strong>— This allows you to select marked instructions on the basis of their six major opcode bits (bits 0–5 of each PowerPC instruction). There is a column for each bit, and you can individually control matching on the basis of each bit. </p><ul class="ul"><li class="li"><p><em>X</em>— (default) Ignore the bit</p></li><li class="li"><p><em>0</em>— Only match if this bit is a zero</p></li><li class="li"><p><em>1</em>— Only match if this bit is a one</p></li><li class="li"><p><em>* (any)</em>— Match any state.</p></li></ul></li><li class="li"><p><strong>Minor Opcode Bits</strong>— This allows you to select marked instructions on the basis of their eleven minor opcode bits (bits 21–30 of each PowerPC instruction). There is a column for each bit, and you can individually control matching on the basis of each bit. Note that you should only use these for major opcodes 4 (Altivec instructions), 19 (branch unit operations), 31 (integer instructions), 59 (FP instructions), and 63 (FP instructions); these bits are not used as part of the opcode by other types of instructions.</p><ul class="ul"><li class="li"><p><em>X</em>— (default) Ignore the bit</p></li><li class="li"><p><em>0</em>— Only match if this bit is a zero</p></li><li class="li"><p><em>1</em>— Only match if this bit is a one</p></li><li class="li"><p><em>* (any)</em>— Match any state.</p></li></ul></li><li class="li"><p><strong>Instruction Table</strong>— This allows you to see which instructions are actually being matched on the basis of your various settings.</p><ul class="ul"><li class="li"><p><em>Mnemonic column</em>— This lists the assembly language mnemonic for an instruction.</p></li><li class="li"><p><em>Major opcode column</em>— This shows the actual major opcode for the instruction.</p></li><li class="li"><p><em>Minor opcode column</em>— This shows the actual minor opcode for the instruction, or zero for instructions that do not use the minor opcode.</p></li><li class="li"><p><em>Match Rows column</em>— This shows which row(s) in the IMC are the cause of any match(es), so you can see which ones need to be turned on or off as a result.</p></li></ul></li><li class="li"><p><strong>All Rows</strong>— If checked, the <em>Instruction Table</em> shows instructions that are matched by any of the IMC rows, all combined together. This is usually the most useful view since it shows all instructions that will be marked. Otherwise, only instructions that match the row currently selected in the <em>IMC Row PopUp</em> are displayed.</p></li><li class="li"><p><strong>All Instructions</strong>— If checked, the <em>Instruction Table</em> shows non-selected instructions in a grayed-out form. Otherwise, they are completely omitted from the table.</p></li></ol><p>Finally, in <span class="content_text">Figure 8-9</span>, the IDU instruction filtering pane is shown:</p><ol class="ol"><li class="li"><p><strong>Microinstruction Table</strong>— This allows you to see which classes of instructions are actually being matched on the basis of your various settings.</p><ul class="ul"><li class="li"><p><em>BSFL column</em>— This lists the <strong>BSFL</strong> (<strong>B</strong>ranch instruction, instruction that will be <strong>S</strong>plit, <strong>F</strong>irst instruction in a dispatch group, and <strong>L</strong>ast instruction in a dispatch group) bits associated with every instruction in the L1 cache.</p></li><li class="li"><p><em>Classification column</em>— This gives the name of every microinstruction class.</p></li></ul></li><li class="li"><p><strong>IMRMASK bits</strong>— These bits mask off an instruction’s <em>BSFL</em> bits before matching.</p><ul class="ul"><li class="li"><p><em>0</em>— AND this bit position with 0, requiring an IMRMATCH of 0 here.</p></li><li class="li"><p><em>1</em>— AND this bit position with 1, enabling full matching with the IMRMATCH bits here.</p></li></ul></li><li class="li"><p><strong>IMRMATCH bits</strong>— These bits select the value to match for any corresponding IMRMASK bits set to 1.</p><ul class="ul"><li class="li"><p><em>0</em>— Match this bit position with 0. Note that this <em>must</em> be 0 for any IMRMASK bit positions that equal 0, or no matches will ever occur.</p></li><li class="li"><p><em>1</em>— Match this bit position with 1. Normally only desired if the corresponding IMRMASK bit is 1, or if you want to intentionally match nothing.</p></li></ul></li></ol><br/><div><a name="//apple_ref/doc/uid/TP40005233-CH10-SW10" title="Figure 8-9PowerPC 970 IMC (IDU) Configuration Tab"></a><p><strong>Figure 8-9&nbsp;&nbsp;</strong>PowerPC 970 IMC (IDU) Configuration Tab</p><img src = "../Art/PPC970APITabIDU.jpg" alt = "PowerPC 970 IMC (IDU) Configuration Tab" ></div><br/><a name="//apple_ref/doc/uid/TP40005233-CH10-SW28" title="PowerPC North Bridge Counter Configuration"></a><h2>PowerPC North Bridge Counter Configuration</h2><p>This section describes how you can make custom configurations to examine counters in some of the North Bridge (memory interface) chips of Macs equipped with PowerPC processors, using the “Advanced” configuration interface. Because some of the “useful” options for these counters require fairly complex combinations of settings, we strongly suggest that you start using the “Simple” settings at first, as described in <span class="content_text"><a href="../CustomConfigurations/CustomConfigurations.html#//apple_ref/doc/uid/TP40005233-CH8-SW12">“Simple Timed Samples and Counters Config Editor,”</a></span> at least until you learn which combinations of settings are best at producing useful information.</p><p>Memory controller counters are available on PowerPC machines with UniNorth v1.5 and later memory controllers. Unfortunately, no equivalent exists for Intel processors. These counters do not support event-triggered interrupts (PMI, or “trigger” mode), privilege level filtering, or marked thread/process filtering. However, on most of the chips they do support filtering on the basis of which interface generated the performance event (see the description of each chipset for details). </p><a name="//apple_ref/doc/uid/TP40005233-CH10-SW20" title="U1.5/U2 North Bridges"></a><h3>U1.5/U2 North Bridges</h3><p>This section describes how you can make custom configurations for Macs equipped with the U1.5/U2 North bridge chipset used in some PowerPC G4 Macs. Macs equipped with these North bridge chipsets have access to four fully programmable performance counters that can record various memory system event types, as listed in <span class="content_text"><a href="../U2PMCTablesAppendix/U2PMCTablesAppendix.html#//apple_ref/doc/uid/TP40005233-CH28-SW1">“UniNorth-2 (U1.5/2) Performance Counter Event List.”</a></span></p><p><span class="content_text">Figure 8-10</span> shows the configuration tab for the U1.5/2’s configuration control. All controls for each of the PMC are just standard controls from <span class="content_text"><a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW3">“Counter Control,”</a></span> except for the <em>Event Sources</em> checkboxes along the bottom. These allow filtering of events based on which North bridge interface is involved. These sources are chosen via checkbox, so you can selectively look at events from all sources or only a specific subset of sources that you choose. You may choose to enable or disable events from any of the following interfaces:</p><ol class="ol"><li class="li"><p><em>CPU1–CPU2</em>— Processor interface(s)</p></li><li class="li"><p><em>AGP</em>— The AGP interface</p></li><li class="li"><p><em>PCI</em>— The PCI interface</p></li><li class="li"><p><em>FireWire/Enet</em>— The dedicated FireWire and Ethernet I/O ports</p></li></ol><br/><div><a name="//apple_ref/doc/uid/TP40005233-CH10-SW11" title="Figure 8-10U1.5/U2 Configuration Tab"></a><p><strong>Figure 8-10&nbsp;&nbsp;</strong>U1.5/U2 Configuration Tab</p><img src = "../Art/UniNorthAdvanced.jpg" alt = "U1.5/U2 Configuration Tab" ></div><br/><a name="//apple_ref/doc/uid/TP40005233-CH10-SW21" title="U3 North Bridge"></a><h3>U3 North Bridge</h3><p>This section describes how you can make custom configurations for Macs equipped with the U3 North bridge chipset used in some PowerPC G5 Macs. Macs equipped with these North bridge chipsets have access to two sets of six fully programmable performance counters, on both the memory interface controller and the Apple processor interface (API) controller. These can count a wide variety of different event types, as listed in <span class="content_text"><a href="../U3PMCTablesAppendix/U3PMCTablesAppendix.html#//apple_ref/doc/uid/TP40005233-CH29-SW1">“UniNorth-3 (U3) Performance Counter Event List,”</a></span> and also filter events on the basis of their source interface and type of access.</p><p><span class="content_text">Figure 8-11</span> shows the first of two configuration tabs used by the U3’s configuration control, the memory interface configuration panel. The first line of each PMC’s controls are just standard controls from <span class="content_text"><a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW3">“Counter Control.”</a></span> Below this are four custom controls that may be set independently for each of the different PMCs:</p><ol class="ol"><li class="li"><p><strong>Access PopUp</strong>— This popup menu lets you restrict the event counting to only certain types of memory accesses, either reads or writes.</p><ol class="ol"><li class="ol ol"><p><em>None</em>— Disables the counter. </p></li><li class="ol ol"><p><em>Write</em>— Only store requests to memory can increment the counter.</p></li><li class="ol ol"><p><em>Read</em>— Only load requests from memory can increment the counter.</p></li><li class="ol ol"><p><em>Any </em>— All memory requests cause a counter increment, read or write.</p></li></ol></li><li class="li"><p><strong>Divider PopUp</strong>— Because U3 PMCs are 32-bit, you may overflow a counter if you are counting high-frequency events or are counting continuously for a long time. You can use this popup to set up a division factor that will slow the rate of incoming events by a fixed power of 2 in order to make it more difficult to overflow the main counter. Choices of every even power of 2 from 1 (no division) to 128 (effectively adds 7 bits to the counter) are available using this menu.</p></li><li class="li"><p><strong>Page State</strong>— U3’s events involving DRAM access can be filtered on the basis of the current SDRAM page state for the accessed DIMM. This allows you to monitor the effectiveness of different memory paging policies, such as how long to keep a page open before closing it.</p><ol class="ol"><li class="ol ol"><p><em>Open Hit</em>— DRAM access events are counted if they hit on an open page in the addressed DIMM. This is the most desirable case, and will generate the minimum latency because the data can be returned immediately from the DRAM’s page cache.</p></li><li class="ol ol"><p><em>Open Miss</em>— DRAM access events are counted if they miss on a currently open page in the addressed DIMM. This is the least desirable case, because it will generate the maximum latency when the old DRAM page is closed and then the new one is opened before data can be returned.</p></li><li class="ol ol"><p><em>Closed</em>— DRAM access events are counted if the addressed DIMM does not have an open page. This is an intermediate case, because while a new page must be opened before data can be returned, at least we do not have to wait for a previously-accessed page to be closed first.</p></li></ol></li><li class="li"><p><strong>Source Filter</strong>— Events can be filtered before they reach U3’s PMCs on the basis of the interface where they originate. These sources are chosen via checkbox, so you can selectively look at events from all sources or only a specific subset of sources that you choose. You may choose to enable or disable events from any of the following interfaces:</p><ol class="ol"><li class="ol ol"><p><em>CPU1–CPU4</em>— Processor interface(s)</p></li><li class="ol ol"><p><em>HT</em>— The Hypertransport interface</p></li><li class="ol ol"><p><em>CV</em>, <em>NCV</em>— Obsolete interfaces, do not use</p></li><li class="ol ol"><p><em>PCI</em>— The PCI interface</p></li><li class="ol ol"><p><em>AGP</em>— The AGP interface</p></li></ol></li></ol><br/><div><a name="//apple_ref/doc/uid/TP40005233-CH10-SW12" title="Figure 8-11U3 Memory Configuration Tab"></a><p><strong>Figure 8-11&nbsp;&nbsp;</strong>U3 Memory Configuration Tab</p><img src = "../Art/U3AdvMem.jpg" alt = "U3 Memory Configuration Tab" ></div><br/><p><span class="content_text">Figure 8-12</span> shows the second of U3’s two configuration tabs, the API configuration panel. As with the memory tab, the first line of each PMC’s controls are just standard controls from <span class="content_text"><a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW3">“Counter Control.”</a></span> Below this is a pair of custom controls that may be set independently for each of the different PMCs:</p><ol class="ol"><li class="li"><p><strong>Source PopUp</strong>— The API controller chip has 51 different selectable event sources, mostly different types of request queues within the chip. You must select one of these sources in order to count its events. To count events from multiple sources simultaneously, you will have to use different PMCs for each source. A full list of these sources is listed in <span class="content_text"><a href="../U3PMCTablesAppendix/U3PMCTablesAppendix.html#//apple_ref/doc/uid/TP40005233-CH29-SW1">“UniNorth-3 (U3) Performance Counter Event List.”</a></span></p></li><li class="li"><p><strong>Divider PopUp</strong>— This is the same as the Divider PopUp on the memory tab.</p></li></ol><br/><div><a name="//apple_ref/doc/uid/TP40005233-CH10-SW13" title="Figure 8-12U3 API Configuration Tab"></a><p><strong>Figure 8-12&nbsp;&nbsp;</strong>U3 API Configuration Tab</p><img src = "../Art/U3AdvAPI.jpg" alt = "U3 API Configuration Tab" ></div><br/><a name="//apple_ref/doc/uid/TP40005233-CH10-SW22" title="U4 (Kodiak) North Bridge"></a><h3>U4 (Kodiak) North Bridge</h3><p>This section describes how you can make custom configurations for Macs equipped with the U4 (Kodiak) North bridge chipset used in some PowerPC G5 Macs. Macs equipped with these North bridge chipsets have access to two sets of six fully programmable performance counters, on both the memory interface controller and the Apple processor interface (API) controller. These can count a wide variety of different event types, as listed in <span class="content_text"><a href="../U4PMCTablesAppendix/U4PMCTablesAppendix.html#//apple_ref/doc/uid/TP40005233-CH30-SW1">“Kodiak (U4) Performance Counter Event List,”</a></span> and also filter events on the basis of their source interface and type of access.</p><p><span class="content_text">Figure 8-13</span> shows the first of two configuration tabs used by the U4’s configuration control, the memory interface configuration panel. The first line of each PMC’s controls are just standard controls from <span class="content_text"><a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW3">“Counter Control.”</a></span> Below this are three custom controls that may be set independently for each of the different PMCs:</p><ol class="ol"><li class="li"><p><strong>Access PopUp</strong>— This popup menu lets you restrict the event counting to only certain types of memory accesses, either reads or writes.</p><ol class="ol"><li class="ol ol"><p><em>None</em>— Disables the counter. </p></li><li class="ol ol"><p><em>Write</em>— Only store requests to memory can increment the counter.</p></li><li class="ol ol"><p><em>Read</em>— Only load requests from memory can increment the counter.</p></li><li class="ol ol"><p><em>Any </em>— All memory requests cause a counter increment, read or write.</p></li></ol></li><li class="li"><p><strong>Divider PopUp</strong>— Because Kodiak PMCs are 32-bit, you may overflow a counter if you are counting high-frequency events or are counting continuously for a long time. You can use this popup to set up a division factor that will slow the rate of incoming events by a fixed power of 2 in order to make it more difficult to overflow the main counter. Choices of every even power of 2 from 1 (no division) to 128 (effectively adds 7 bits to the counter) are available using this menu.</p></li><li class="li"><p><strong>Source Filter</strong>— Events can be filtered before they reach Kodiak’s PMCs on the basis of the interface where they originate. These sources are chosen via checkbox, so you can selectively look at events from all sources or only a specific subset of sources that you choose. You may choose to enable or disable events from any of the following interfaces:</p><ol class="ol"><li class="ol ol"><p><em>CPU1–CPU4</em>— Processor interface(s)</p></li><li class="ol ol"><p><em>HT</em>— The Hypertransport interface</p></li><li class="ol ol"><p><em>CPCIE</em>— The PCIE interface (for coherent requests)</p></li><li class="ol ol"><p><em>NCPCIE</em>— The PCIE interface (for non-coherent requests)</p></li></ol></li></ol><br/><div><a name="//apple_ref/doc/uid/TP40005233-CH10-SW14" title="Figure 8-13U4 (Kodiak) Memory Configuration Tab"></a><p><strong>Figure 8-13&nbsp;&nbsp;</strong>U4 (Kodiak) Memory Configuration Tab</p><img src = "../Art/U4AdvMem.jpg" alt = "U4 (Kodiak) Memory Configuration Tab" ></div><br/><p><span class="content_text">Figure 8-14</span> shows the second of U4’s two configuration tabs, the API configuration panel. As with the memory tab, the first line of each PMC’s controls are just standard controls from <span class="content_text"><a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW3">“Counter Control.”</a></span> Below this are four custom controls that may be set independently for each of the different PMCs:</p><ol class="ol"><li class="li"><p><strong>Source PopUp</strong>— The API controller chip has 33 different selectable event sources, mostly different types of request queues within the chip. You must select one of these sources in order to count its events. To count events from multiple sources simultaneously, you will have to use different PMCs for each source. A full list of these sources is listed in <span class="content_text"><a href="../U4PMCTablesAppendix/U4PMCTablesAppendix.html#//apple_ref/doc/uid/TP40005233-CH30-SW1">“Kodiak (U4) Performance Counter Event List.”</a></span></p></li><li class="li"><p><strong>Access PopUp</strong>— This is the same as the Access PopUp on the memory tab.</p></li><li class="li"><p><strong>Divider PopUp</strong>— This is the same as the Divider PopUp on the memory tab.</p></li><li class="li"><p><strong>Source Filter</strong>— This is the same as the filter on the memory tab, except that all PCIE events are grouped together into a single source, whether or not they are coherent.</p></li></ol><br/><div><a name="//apple_ref/doc/uid/TP40005233-CH10-SW15" title="Figure 8-14U4 (Kodiak) API Configuration Tab"></a><p><strong>Figure 8-14&nbsp;&nbsp;</strong>U4 (Kodiak) API Configuration Tab</p><img src = "../Art/U4AdvAPI.jpg" alt = "U4 (Kodiak) API Configuration Tab" ></div><br/><a name="//apple_ref/doc/uid/TP40005233-CH10-SW30" title="ARM11 CPU Performance Counter Configuration"></a><h2>ARM11 CPU Performance Counter Configuration</h2><p>This section describes how you can make custom configurations for iPhone OS devices with ARM11 processors. These devices have two identical, fully programmable performance counters plus one counter (#1) that can record cycle counts only. Full event listings are provided in <span class="content_text"><a href="../ARM11PerformanceCounterEventList/ARM11PerformanceCounterEventList.html#//apple_ref/doc/uid/TP40005233-CH31-SW1">“ARM11 Performance Counter Event List.”</a></span></p><p><span class="content_text">Figure 8-15</span> shows the configuration tab for the ARM11 processor. It just uses three sets of the standard PMC controls from <span class="content_text"><a href="AdvancedHardwareCounterConfiguration.html#//apple_ref/doc/uid/TP40005233-CH10-SW3">“Counter Control,”</a></span> although each PMC also includes a “help” field that describes what the currently-selected counter actually counts with some additional text.</p><div class="importantbox"><a name="//apple_ref/doc/uid/TP40005233-CH10-DontLinkElementID_3" title="Important:"></a><p><strong>Important:</strong>&nbsp;Currently, while you can make custom ARM counter configurations with Shark, there is no way to load customized configuration files onto your iPhone OS device using the iPhone OS SDK. This restriction may be relaxed in future versions of the SDK. In the meantime, send suggestions for useful configurations to perftools-feedback@group.apple.com and we may include them in future iPhone OS SDK releases.</p><p></p></div><br/><div><a name="//apple_ref/doc/uid/TP40005233-CH10-SW29" title="Figure 8-15ARM11 Counter Configuration Tab"></a><p><strong>Figure 8-15&nbsp;&nbsp;</strong>ARM11 Counter Configuration Tab</p><img src = "../Art/ARM11_PMCs.jpg" alt = "ARM11 Counter Configuration Tab" ></div><br/>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../CustomConfigurations/CustomConfigurations.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../CommandReference/CommandReference.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2008 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2008-04-14<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/DeveloperTools/Conceptual/SharkUserGuide/AdvancedHardwareCounterConfiguration/AdvancedHardwareCounterConfiguration.html%3Fid%3DTP40005233-2.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/DeveloperTools/Conceptual/SharkUserGuide/AdvancedHardwareCounterConfiguration/AdvancedHardwareCounterConfiguration.html%3Fid%3DTP40005233-2.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/DeveloperTools/Conceptual/SharkUserGuide/AdvancedHardwareCounterConfiguration/AdvancedHardwareCounterConfiguration.html%3Fid%3DTP40005233-2.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>