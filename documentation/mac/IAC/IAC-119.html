<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Handling the Required Apple Events(IM:IC)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING119></A>


<!-- Top of Header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- Bottom of Header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="IAC-118.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="IAC-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="IAC-529.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="IAC-120.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="IAC-2.html"><B>Interapplication Communication</B></A> / <BR><DD><A HREF="IAC-115.html"><B>Chapter 4 - Responding to Apple Events</B></A> / <A HREF="IAC-116.html"><B>Handling Apple Events</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING119-0></A>
<H2><A NAME=MARKER-9-262></A><A NAME=MARKER-21-263></A>Handling the Required Apple Events</H2>
 <A NAME=MARKER-2-69></A><A NAME=MARKER-2-71></A>This section describes the required Apple events--the Apple events your application must support to be compatible with System 7 and later versions of system software--and the descriptor types for all parameters of the required Apple events. It also describes how to write the handlers for these events, and it provides sample code.<P>
 To support the required Apple events, you must set the necessary flags in the <CODE>'SIZE'</CODE> resource of your application, install entries in your application's Apple event dispatch table, add code to the event loop of your application to recognize high-level events, and call the <CODE>AEProcessAppleEvent</CODE> function, as described in <A HREF=IAC-117.html#MARKER-9-210>"Accepting an Apple Event,"</A> which begins on <A HREF=IAC-117.html#MARKER-9-210>page 4-5</A>, and <A HREF=IAC-118.html#MARKER-9-233>"Installing Entries in the Apple Event Dispatch Tables,"</A> which begins on <A HREF=IAC-118.html#MARKER-9-233>page 4-7</A>. You must also write handlers for each Apple event; this section describes how to write these handlers.<P>
<A NAME=HEADING119-3></A>
<H3><A NAME=MARKER-9-266></A><A NAME=MARKER-21-267></A>Required Apple Events</H3>
 When a user opens or prints a file from the Finder, the Finder sets up the information your application uses to determine which files to open or print. In System 7 and later versions, if your application supports high-level events, the Finder communicates this information to your application through the required Apple events. <P>
 The Finder sends these required Apple events to your application to request the corresponding actions:
<TABLE BORDER="0" CELLPADDING=3><TH ALIGN=LEFT>Apple event<TH>Requested action<TR>
<TD>Open Application<TD>Perform tasks your application normally performs when a user opens your application without opening or printing any documents<TR>
<TD>Open Documents<TD>Open the specified documents <TR>
<TD>Print Documents<TD>Print the specified documents<TR>
<TD>Quit Application<TD>Perform tasks--such as releasing memory, requesting the user to save documents, and so on--associated with quitting before the Finder terminates your application</TABLE>
<P>
 In System 7 and later versions, the Finder uses these events as part of the mechanisms for launching and terminating applications. When the Finder launches your application, the application receives the Open Application, Open Documents, or Print Documents event. When the Finder terminates your application, the application receives the Quit Application event. This method of communicating Finder information to your application replaces the mechanisms used in earlier versions of system software.<P>
 Applications that do not support high-level events can still use the <CODE>CountAppFiles</CODE>, <CODE>GetAppFiles</CODE>, and <CODE>ClrAppFiles</CODE> procedures (or the <CODE>GetAppParms</CODE> procedure) to get the Finder information. See the chapter "Introduction to File Management" in <I><A HREF="../Files/Files-2.html">Inside Macintosh: Files</A></I> for information on these routines. To make your application compatible with System 7 and with earlier and later versions, you must support both the old and new mechanisms.<P>
 Use the <CODE>Gestalt</CODE> function to determine whether the Apple Event Manager is present. If it is and the <CODE>isHighLevelEventAware</CODE> flag is set in your application's <CODE>'SIZE'</CODE> resource, your application receives the Finder information through the required Apple events. <P>
 If your application accepts high-level events, it must be able to process the four required Apple events. Your application receives the required Apple events from the Finder in these situations:<P>
<UL>
<LI>If your application is not open and the user opens your application from the Finder without opening or printing any documents, the Finder launches your application and sends it the Open Application event.
<LI>If your application is not open and the user opens one of your application's documents from the Finder, the Finder launches your application and sends it the Open Documents event.
<LI>If your application is not open and the user prints one of your application's documents from the Finder, the Finder launches your application and sends it the Print Documents event. Your application should print the selected documents and remain open until it receives a Quit Application event from the Finder.
<LI>If your application is open and the user opens or prints any of your application's documents from the Finder, the Finder sends your application the Open Documents or Print Documents event.
<LI>If your application is open and the user chooses Restart or Shut Down from the Finder's Special menu, the Finder sends your application the Quit Application event.<P>
</UL>
 Upon receiving any of the required Apple events, your application should perform the action requested by the event. Here is a summary of the contents of the required events and the actions they request applications to perform:
<TABLE BORDER="0" CELLPADDING=3><TH colspan=2>Open Application--perform tasks associated with opening an application <A NAME=MARKER-2-34></A><TR>
<TD>Event class<TD>kCoreEventClass<TR>
<TD>Event ID<TD>kAEOpenApplication<TR>
<TD>Parameters<TD>None<TR>
<TD>Requested action<TD>Perform any tasks--such as opening an untitled document window--that you would normally perform when a user opens your application without opening or printing any documents.</TABLE>

<TABLE BORDER="0" CELLPADDING=3><TH colspan=3>Open Documents--open the specified documents<A NAME=MARKER-2-76></A><TR>
<TD colspan=2>Event class<TD>kCoreEventClass<TR>
<TD colspan=2>Event ID<TD>kAEOpenDocuments<TR>
<TD colspan=2>Required parameter<TD>&nbsp;<TR>
<TD>&nbsp;<TD>Keyword:<TD>keyDirectObject<TR>
<TD>&nbsp;<TD>Descriptor type:<TD>typeAEList<TR>
<TD>&nbsp;<TD>Data:<TD>A list of alias records for the documents to be opened<TR>
<TD colspan=2>Requested action<TD>Open the documents specified in the <CODE>keyDirectObject </CODE>parameter.</TABLE>

<TABLE BORDER="0" CELLPADDING=3><TH colspan=3>Print Documents--print the specified documents<A NAME=MARKER-21-152></A><A NAME=MARKER-2-115></A><TR>
<TD colspan=2>Event class<TD>kCoreEventClass<TR>
<TD colspan=2>Event ID<TD>kAEPrintDocuments<TR>
<TD colspan=2>Required parameter<TD>&nbsp;<TR>
<TD>&nbsp;<TD>Keyword:<TD>keyDirectObject<TR>
<TD>&nbsp;<TD>Descriptor type:<TD>typeAEList<TR>
<TD>&nbsp;<TD>Data:<TD>A list of alias records for the documents to be printed<TR>
<TD colspan=2>Requested action<TD>Print the documents specified in the <CODE>keyDirectObject</CODE> parameter without opening windows for the documents. </TABLE>

<TABLE BORDER="0" CELLPADDING=3><TH colspan=2>Quit Application--perform tasks associated with quitting<A NAME=MARKER-21-79></A> <TR>
<TD>Event class<TD>kCoreEventClass<TR>
<TD>Event ID<TD>kAEQuitApplication<TR>
<TD>Parameters<TD>None<TR>
<TD>Requested action<TD>Perform any tasks that your application would normally perform when the user chooses Quit. Such tasks typically include asking the user whether to save documents that have been changed. When appropriate, the Finder sends this event to an application immediately after sending it a Print Documents event (unless the application was already open) or if the user chooses Restart or Shut Down from the Finder's Special menu.<A NAME=MARKER-21-80></A><A NAME=MARKER-2-90></A><A NAME=MARKER-21-83></A><A NAME=MARKER-2-84></A></TABLE>
<P>
 Your application needs to recognize only two descriptor types to handle the required Apple events: descriptor lists and alias records. The Open Documents event and Print Documents event use descriptor lists to store a list of documents to open. Each document is specified as an alias record in the descriptor list. <P>
 You can retrieve the data that specifies the document to open as an alias record, or you can request that the Apple Event Manager coerce the alias record to a file system specification (<CODE>FSSpec</CODE>) record. The file system specification record provides a standard method of identifying files in System 7 and later versions. See <I><A HREF="../Files/Files-2.html">Inside Macintosh: Files</A></I> for a complete description of how to specify files using file system specification records.<P>
<A NAME=HEADING119-18></A>
<H3><A NAME=MARKER-21-268></A>Handling the Open Application Event</H3>
 When the user opens your application, the Finder uses the Process Manager to launch your application. On startup, your application typically performs any needed initialization, and then begins to process events. If your application supports high-level events, and if the user opens your application without selecting any documents to open or print, your application receives the Open Application event.<P>
 <A NAME=MARKER-2-35></A>To handle the Open Application event, your application should do just what the user expects it to do when it is opened. For example, your application might open a new untitled window in response to an Open Application event.<P>
 <A HREF=#MARKER-9-270>Listing 4-5</A> shows a handler that processes the Open Application event. This handler first calls an application-defined function called <CODE>MyGotRequiredParams</CODE>, which checks whether the Apple event contains any required parameters. If so, the handler returns an error, because by definition, the Open Application event should not contain any required parameters. Otherwise, the handler opens a new document window.<P>
<B>Listing 4-5  <A NAME=MARKER-9-270></A><A NAME=MARKER-21-271></A>A handler for the Open Application event</B><P>
<PRE>
FUNCTION MyHandleOApp (theAppleEvent, reply: AppleEvent; 
                       handlerRefcon: LongInt): OSErr;
VAR
   myErr: OSErr;
BEGIN
   myErr := MyGotRequiredParams(theAppleEvent);
   IF myErr = noErr THEN 
      DoNew;
   MyHandleOApp := myErr;
END;
</PRE>
 For a description of the <CODE>MyGotRequiredParams</CODE> function, see <A HREF=IAC-122.html#MARKER-9-353>Listing 4-11</A> on <A HREF=IAC-122.html#MARKER-9-353>page 4-35</A>. For information about the <CODE>reply</CODE> and <CODE>handlerRefcon</CODE> parameters for an Apple event handler, see <A HREF=IAC-122.html#MARKER-9-341>"Writing Apple Event Handlers" on page 4-33</A>. <A NAME=MARKER-2-272></A><P>
<A NAME=HEADING119-25></A>
<H3><A NAME=MARKER-21-273></A>Handling the Open Documents Event</H3>
 <A NAME=MARKER-21-93></A>To handle the Open Documents event, your application should open the documents that the Open Documents event specifies in its direct parameter. Your application extracts this information and then opens the specified documents. <A HREF=#MARKER-9-275>Listing 4-6</A> shows a handler for the Open Documents event. <P>
<B>Listing 4-6  <A NAME=MARKER-9-275></A><A NAME=MARKER-21-276></A>A handler for the Open Documents event<A NAME=MARKER-2-235></A></B><P>
<PRE>
FUNCTION MyHandleODoc (theAppleEvent, reply: AppleEvent;
                        handlerRefcon: LongInt): OSErr;
VAR
   myFSS:               FSSpec;
   docList:             AEDescList;
   myErr, ignoreErr:    OSErr;
   index, itemsInList:  LongInt;
   actualSize:          Size;
   keywd:               AEKeyword;
   returnedType:        DescType;
BEGIN
   {get the direct parameter--a descriptor list--and put it }
   { into docList}
   myErr := AEGetParamDesc(theAppleEvent, keyDirectObject,
                           typeAEList, docList);



   IF myErr = noErr THEN 
   BEGIN
      {check for missing required parameters}
      myErr := MyGotRequiredParams(theAppleEvent);
      IF myErr = noErr THEN 
      BEGIN
         {count the number of descriptor records in the list}
         myErr := AECountItems (docList, itemsInList);
         IF myErr = noErr THEN
            {now get each descriptor record from the list, }
            { coerce the returned data to an FSSpec record, and }
            { open the associated file}
            FOR index := 1 TO itemsInList DO
            BEGIN
               myErr := AEGetNthPtr(docList, index, typeFSS, 
                                    keywd, returnedType, @myFSS, 
                                    Sizeof(myFSS),actualSize);
               IF myErr = noErr THEN
               BEGIN
                  myErr := MyOpenFile(@myFSS);
                  IF myErr &lt;&gt; noErr THEN 
                     ; {handle error from MyOpenFile}
               END
               ELSE
                  ; {handle error from AEGetNthPtr}
            END; {of For index Do}
      END
      ELSE
         ; {handle error from MyGotRequiredParams}
      ignoreErr := AEDisposeDesc(docList);
   END
   ELSE
      ; {failed to get direct parameter, handle error}
   MyHandleODoc := myErr;
END;
</PRE>
 The handler in <A HREF=#MARKER-9-275>Listing 4-6</A> first uses the <CODE>AEGetParamDesc</CODE> function to get the direct parameter (specified by the <CODE>keyDirectObject</CODE> keyword) out of the Apple event. The handler requests that <CODE>AEGetParamDesc</CODE> return a descriptor list in the <CODE>docList</CODE> variable. The handler then checks that it has retrieved all of the required parameters by calling the <CODE>MyGotRequiredParams</CODE> function. (See <A HREF=IAC-122.html#MARKER-9-353>Listing 4-11 on page 4-35</A> for a description of this function.)<P>
 Once the handler has retrieved the descriptor list from the Apple event, it uses <CODE>AECountItems</CODE> to count the number of descriptors in the list. Using the returned number as an index, the handler can get the data of each descriptor record in the list. This handler requests that the <CODE>AEGetNthPtr</CODE> function coerce the data in the descriptor record to a file system specification record. The handler can then use the file system specification record as a parameter to its own routine for opening files.<P>
 For more information on the <CODE>AEGetParamDesc</CODE> function, see <A HREF=IAC-143.html#MARKER-9-492>page 4-70</A>. For more information on the <CODE>AEGetNthPtr</CODE> and <CODE>AECountItems</CODE> functions, see <A HREF=IAC-121.html#MARKER-9-334>"Getting Data Out of a Descriptor List" on page 4-31</A>.<P>
 After extracting the file system specification record that describes the document to open, your application can use this record to open the file. For example, in <A HREF=#MARKER-9-275>Listing 4-6</A>, the code passes the file system specification record to its routine for opening files, the <CODE>MyOpenFile</CODE> function. <P>
 The <CODE>MyOpenFile</CODE> function should be designed so that it can be called in response to both the Open Documents event and to events generated by the user. For example, when the user chooses Open from the File menu, the code that handles the mouse-down event uses the <CODE>StandardGetFile</CODE> procedure to let the user choose a file; it then calls <CODE>MyOpenFile</CODE>, passing the file system specification record returned by <CODE>StandardGetFile</CODE>. By isolating code that performs a requested action from code that interacts with the user, you can easily adapt your application to handle Apple events that request the same action. <P>
 Note the use of the <CODE>AEDisposeDesc</CODE> function to dispose of the descriptor list when your handler no longer requires the data in it. Your handler should also return a result code.<A NAME=MARKER-6-174></A><P>
<A NAME=HEADING119-35></A>
<H3><A NAME=MARKER-21-279></A>Handling the Print Documents Event</H3>
 <A NAME=MARKER-2-100></A>To handle the Print Documents event, your application should extract information about the documents to be printed from the direct parameter, then print the specified documents. <P>
 If your application can interact with the user, it should open windows for the documents, display a Print dialog box for the first document, and use the settings entered by the user for the first document to print all the documents. If user interaction is not allowed, your application may either return the error <CODE>errAENoUserInteraction</CODE> or print the documents using default settings. See <A HREF=IAC-126.html#MARKER-9-408>"Interacting With the User,"</A> which begins on <A HREF=IAC-126.html#MARKER-9-408>page 4-47</A>, for information about using the <CODE>AEInteractWithUser</CODE> function to interact with the user. <P>
 Note that your application can remain open after processing the Print Documents event; when appropriate, the Finder sends your application a Quit Application event immediately after sending it a Print Documents event.<P>
 The handler for the Print Documents event shown in <A HREF=#MARKER-9-281>Listing 4-7</A> is similar to the handler for the Open Documents event, except that it prints the documents referred to in the direct parameter.<P>
<B>Listing 4-7  <A NAME=MARKER-9-281></A><A NAME=MARKER-21-282></A>A handler for the Print Documents event<A NAME=MARKER-2-241></A></B><P>
<PRE>
FUNCTION MyHandlePDoc (theAppleEvent, reply: AppleEvent;
                       handlerRefcon: LongInt): OSErr;
VAR
   myFSS:               FSSpec;
   docList:             AEDescList;
   myErr, ignoreErr:    OSErr;
   index, itemsInList:  LongInt;
   actualSize:          Size;
   keywd:               AEKeyword;
   returnedType:        DescType;
BEGIN
   {get the direct parameter--a descriptor list--and put it }
   { into docList}
   myErr := AEGetParamDesc(theAppleEvent, keyDirectObject,
                           typeAEList, docList);
   IF myErr = noErr THEN 
   BEGIN
      {check for missing required parameters}
      myErr := MyGotRequiredParams(theAppleEvent);
      IF myErr = noErr THEN 
      BEGIN
         {count the number of descriptor records in the list}
         myErr := AECountItems (docList, itemsInList);
         IF myErr = noErr THEN
            {now get each descriptor record from the list, }
            { coerce the returned data to an FSSpec record, and }
            { print the associated file}
            FOR index := 1 TO itemsInList DO
            BEGIN
               myErr := AEGetNthPtr(docList, index, typeFSS, 
                                    keywd, returnedType, @myFSS, 
                                    Sizeof(myFSS), actualSize);
               IF myErr = noErr THEN
               BEGIN
                  myErr := MyPrintFile(@myFSS);
                  IF myErr &lt;&gt; noErr THEN 
                     ; {handle error from MyOpenFile}
               END
               ELSE
                  ; {handle error from AEGetNthPtr}
            END; {of For index Do}
      END
      ELSE
         ; {handle error from MyGotRequiredParams}
      ignoreErr := AEDisposeDesc(docList);
   END
   ELSE
      ; {failed to get direct parameter, handle error}
   MyHandlePDoc := myErr;
END;
</PRE>
<A NAME=HEADING119-42></A>
<H3><A NAME=MARKER-21-284></A>Handling the Quit Application Event</H3>
 <A NAME=MARKER-21-104></A>To handle the Quit Application event, your application should take any actions that are necessary before it is terminated (such as saving any open documents). <A HREF=#MARKER-9-286>Listing 4-8</A> shows an example of a handler for the Quit Application event.<P>
 When appropriate, the Finder sends your application a Quit Application event immediately after a Print Documents event. The Finder also sends your application a Quit Application event if the user chooses Restart or Shut Down from the Finder's Special menu. <P>
<B>Listing 4-8  <A NAME=MARKER-9-286></A><A NAME=MARKER-21-287></A>A handler for the Quit Application event<A NAME=MARKER-2-240></A></B><P>
<PRE>
FUNCTION MyHandleQuit (theAppleEvent, reply: AppleEvent;
                       handlerRefcon: LongInt): OSErr;
VAR
   myErr:         OSErr;
   userCanceled:  Boolean;
BEGIN
   {check for missing required parameters}
   myErr := MyGotRequiredParams(theAppleEvent);
   IF myErr = noErr THEN 
   BEGIN
      userCanceled := MyPrepareToTerminate;
      IF userCanceled THEN
         MyHandleQuit := kUserCanceled
      ELSE
         MyHandleQuit := noErr;
   END
   ELSE
      MyHandleQuit := myErr;
END;
</PRE>
 <A NAME=MARKER-2-148></A><A NAME=MARKER-2-81></A><A NAME=MARKER-21-83></A>The handler in <A HREF=#MARKER-9-286>Listing 4-8</A> calls another function supplied by the application, the <CODE>MyPrepareToTerminate</CODE> function. This function saves the documents for any open windows and returns a Boolean value that indicates whether the user canceled the Quit operation. This is another example of isolating code for interacting with the user from the code that performs the requested action. By structuring your application in this way, you can use the same routine to respond to a user action (such as choosing the Quit command from the File menu) or to the corresponding Apple event. (For a description of the <CODE>MyGotRequiredParams</CODE> function, see <A HREF=IAC-122.html#MARKER-9-341>"Writing Apple Event Handlers" on page 4-33</A>.)<P>
<DL>
<DT><B>IMPORTANT</B>
<DD>When your application is ready to quit, it should call the <CODE>ExitToShell</CODE> procedure from the main event loop, not from your handler for the Quit Application event. Your application should quit only after the handler returns <CODE>noErr</CODE> as its function result.<EM></EM><A NAME=MARKER-2-84></A><A NAME=MARKER-21-109></A><A NAME=MARKER-2-110></A>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="IAC-118.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="IAC-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="IAC-529.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="IAC-120.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="IAC-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
