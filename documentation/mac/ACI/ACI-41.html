<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Initializing Your Color Picker</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING41></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->




<!-- Main Body -->

<CENTER>
<P>
<A HREF="ACI-40.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="ACI-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="ACI-122.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="ACI-42.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="ACI-2.html"><B>Advanced Color Imaging on the Mac OS</B></A> / <BR><DD><A HREF="ACI-29.html"><B>Chapter 2 - Color Picker Manager</B></A> / <A HREF="ACI-38.html"><B>Writing Your Own Color Pickers</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING41-0></A>
<H2>Initializing Your Color Picker</H2>
 <A NAME=MARKER-2-121></A>The Color Picker Manager sends the <A NAME=MARKER-2-122></A><CODE>kInitPicker</CODE> request code after your color picker has set up all of its external data. (If the Color Picker Manager opens a color picker only to obtain a list of color pickers for the More Choices list in a dialog box, your color picker will not receive this message unless the user actually chooses the color picker.)<P>
 Your color picker code should use the <CODE>CallComponentFunctionWithStorage</CODE> function, which invokes a specified function of your color picker with the parameters originally provided by the Color Picker Manager. Your color picker passes these parameters by specifying the same component parameters structure that was received by your color picker's main entry point. The <CODE>CallComponentFunctionWithStorage</CODE> function also provides a handle to the memory associated with the current connection. Your color picker uses this memory to store private data that it initializes in response to the <CODE>kInitPicker</CODE> request code.<P>
 To access resources that are stored in your color picker, you can use the Component Manager functions <CODE>OpenComponentResFile</CODE> and <CODE>CloseComponentResFile</CODE>. <A HREF=#MARKER-9-123>Listing 2-17</A> illustrates how a color picker uses these functions to gain access to its private data, which it initializes in response to the <CODE>kInitPicker</CODE> request code.<P>
<B>Listing 2-17  <A NAME=MARKER-9-123></A>Initializing private data for a color picker</B><P>
<PRE>
pascal ComponentResult MyInitPicker(PickerStorageHndl storage,
                           PickerInitData *data)
{
   GrafPtr     thePort;
   OSErr       error = noErr;
   PMColorPtr  theColor;
   RGBColor    rgb;
   short       resFile;

   /* open resource file */
   resFile = OpenComponentResFile((Component) (*storage)-&gt;myself);
   GetPort(&amp;thePort);
   (*storage)-&gt;port = thePort;
   (*storage)-&gt;flags = data-&gt;flags;
   (*storage)-&gt;realPicker = true;
   /* always open an invisible picker */
   (*storage)-&gt;visible = false;
   (*storage)-&gt;active = true;
   /* initalize internal colors */
   theColor = &amp;(*storage)-&gt;color;
   theColor-&gt;profile = 0;
   theColor-&gt;color.rgb.red = 0;
   theColor-&gt;color.rgb.green = 0;
   theColor-&gt;color.rgb.blue = 0;
   (*storage)-&gt;origColor = (*storage)-&gt;color;
   (*storage)-&gt;lastRGB = (*storage)-&gt;color.color.rgb;
   MyInitNumerics(storage);
   /* allocate patterns for the color rectangles */
   (*storage)-&gt;newColorPat = NewPixPat();
   (*storage)-&gt;origColorPat = NewPixPat();
   /* initialize rectangles to the correct colors */
   rgb = (*storage)-&gt;color.color.rgb;
   MakeRGBPat((*storage)-&gt;newColorPat,&amp;rgb);
   rgb = (*storage)-&gt;origColor.color.rgb;
   MakeRGBPat((*storage)-&gt;origColorPat,&amp;rgb);
   (*storage)-&gt;profile = 0L;
   finish:
   CloseComponentResFile(resFile);
   return error;
}
</PRE>
<DL>
<DT><B>WARNING</B>
<DD>Do not leave any resource files open when your color picker is closed. Their maps will be left in the subheap when the subheap is freed, causing the Resource Manager to crash. <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 Before handling the <CODE>kInitPicker</CODE> request code, your color picker must be able to handle the <CODE>kTestGraphicsWorld</CODE>, <CODE>kGetDialog</CODE>, and <CODE>kGetItemList</CODE> request codes.<P>
 In response to the <A NAME=MARKER-2-124></A><CODE>kTestGraphicsWorld</CODE> request code, you should test whether your color picker can operate under existing conditions and return <CODE>noErr</CODE> if it can, as illustrated in <A HREF=#MARKER-9-125>Listing 2-18</A>.<P>
<B>Listing 2-18  <A NAME=MARKER-9-125></A>Testing whether an environment can support your color picker</B><P>
<PRE>
pascal ComponentResult MyTestGraphicsWorld(PickerStorageHndl storage,
                                 PickerInitData *data)
{
   #pragma unused(storage,data)
   OSErr err = noErr;
   long gLong;
   /* color picker requires Color QuickDraw */
   Gestalt(gestaltQuickdrawVersion,&amp;gLong);
   return gLong &gt;= gestalt8BitQD ? noErr : pickerCantLive;
}
</PRE>
 If your color picker uses its own dialog box, it should return a pointer to this dialog box in response to the <A NAME=MARKER-2-126></A><CODE>kGetDialog</CODE> request code. If your color picker uses the default dialog box, it should return <CODE>nil</CODE>, as illustrated here.<P>
<PRE>
   pascal ComponentResult MyGetDialog(PickerStorageHndl storage)
   {
      #pragma unused (storage)
      return 0L;
   }
</PRE>
 In response to the <A NAME=MARKER-2-127></A><CODE>kGetItemList</CODE> request code, your color picker should return its dialog box items, as illustrated in <A HREF=#MARKER-9-128>Listing 2-19</A>. The Color Picker Manager adds these items to the color picker dialog box. <P>
<B>Listing 2-19  <A NAME=MARKER-9-128></A>Returning the dialog box items for a color picker</B><P>
<PRE>
pascal long MyGetItemList(PickerStorageHndl storage)
{
   #pragma unused (storage)
   Handle theItems;
   short resFile;

   /* open resource file to get DITL */
   resFile = OpenComponentResFile((Component) (*storage)-&gt;myself);
   /* get the DITL and detach it so it won't go away after 
      closing the file */
   theItems = GetResource ('DITL', kPickerDITL);
   if(theItems)
      DetachResource(theItems);
   CloseComponentResFile(resFile);  /* close the file */
   return (long) theItems;
}
</PRE>
 A color picker must respond to the <A NAME=MARKER-13-129></A><CODE>kSetVisibility</CODE> request code by making itself either visible or invisible, as requested by the Color Picker Manager.<A NAME=MARKER-2-130></A><A NAME=MARKER-2-131></A><A NAME=MARKER-2-132></A><P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="ACI-40.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="ACI-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="ACI-122.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="ACI-42.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="ACI-3.html">&copy; Apple Computer, Inc.</A><br>13 NOV 1996<P>
<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->
</BODY>
</HTML> 
