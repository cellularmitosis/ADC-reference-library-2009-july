<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Replacing a Script Utility or QuickDraw Patch(IM: Tx)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING526></A>



<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Text-525.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Text-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Text-594.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Text-527.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Text-2.html"><B>Text</B></A> / <BR><DD><A HREF="Text-514.html"><B>Appendix A - Built-in Script Support</B></A> / <A HREF="Text-521.html"><B>WorldScript I</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING526-0></A>
<H2>Replacing a Script Utility or QuickDraw Patch</H2>
 Developers of 1-byte complex script systems should be able to specify most of their script system's behavior in tables in the script system's encoding/rendering (<CODE>'itl5'</CODE>) resource. In cases where the WorldScript I routines are insufficient to handle the script's specific needs, the developers may create patches and install them as described here. The patches may be installed by an extensions file that is executed at system startup.<P>
 Application developers who need specific script-based behavior for their programs should not alter the tables in a 1-byte script's encoding/rendering (<CODE>'itl5'</CODE>) resource. However, they can replace one or more 1-byte script utilities or QuickDraw patches for their target script system, as described here.<P>
<DL>
<DT><B>IMPORTANT</B>
<DD>When you patch a script system's script utility or QuickDraw call, you alter that script's behavior for as long as it remains enabled. Therefore, be sure to restore the patches to their original state whenever your application quits or is switched out by the Process Manager.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 <A NAME=MARKER-2-231></A>The script-based dispatch table design gives you a simple, flexible way to replace individual routines without having to patch out all of the <CODE>_ScriptUtil</CODE> trap or any of the QuickDraw low-level routines in their entirety. Furthermore, in a multiscript environment each patch of this type applies only to its own script system. A developer might, for example, patch <CODE>StdText</CODE> for the Thai script system only, leaving all the other scripts unchanged.<P>
 In addition, you can choose the point at which your patched routine executes: either before (which also means <I>in place of</I> if your routine does not call the WorldScript I routine at all) or after the WorldScript I routine executes. For example, the WorldScript I version of <CODE>StdText</CODE> works by first performing contextual analysis and reordering of characters on the supplied text, and then calling the original version of <CODE>StdText</CODE>. Suppose you want to keep the WorldScript I contextual analysis and reordering of characters, but you want to do some additional processing before calling the original <CODE>StdText</CODE>. To do that, just patch out the WorldScript I routine's call to the original <CODE>StdText</CODE>, instead of patching out the entire WorldScript I routine. Then do your own processing and call <CODE>StdText</CODE> yourself.<P>
 Because you can patch at two points, and because you can perform your own processing either before or after a patch, your flexibility is great. To replace only the WorldScript I routine, replace its pointer in the dispatch table; to keep the WorldScript I routine while replacing or patching the original routine, replace the original-routine pointer in the dispatch table. The four Script Manager routines that allow you to make those patches are <A NAME=MARKER-9-101></A><CODE>GetScriptUtilityAddress</CODE>, <A NAME=MARKER-2-134></A><CODE>SetScriptUtilityAddress</CODE>, <CODE><A NAME=MARKER-2-135></A>GetScriptQDPatchAddress</CODE>, and <A NAME=MARKER-2-136></A><CODE>SetScriptQDPatchAddress</CODE>. Either pointer in the dispatch table may be <CODE>NIL</CODE>, meaning that WorldScript I either doesn't patch the original routine or doesn't call the original routine.<P>
<A NAME=HEADING526-7></A>
<H3>Patching Script Utilities</H3>
 <A NAME=MARKER-2-137></A>In terms of how to patch them, the script utilities can be divided into different groups, depending on whether or not WorldScript I performs contextual formatting and whether or not it subsequently calls the original Roman version of the utility. See <A HREF=#MARKER-9-41>Table A-13</A>. For utilities that perform contextual formatting, keep in mind that if you replace them you will have to handle formatting yourself. For utilities that subsequently call their original Roman version, you can replace either the WorldScript I version of the call or the Roman version or both, depending on what your needs are.<CODE>
<TABLE BORDER="0" CELLPADDING=3>
<CAPTION><A NAME=MARKER-9-41></A><B>Table A-13 Classification of 1-byte script utilities by function</B></CAPTION>
<TH>No formatting, <BR>do not call original <BR>Roman routine<TH>No formatting, <BR>do call original <BR>Roman routine<TH>May do formatting, <BR>do not call original <BR>Roman routine<TR>
<TD>CharacterByteType<TD>CharacterType<TD>HiliteText<TR>
<TD>GetScriptVariable<TD>TransliterateText<TD>VisibleLength<TR>
<TD>SetScriptVariable<TD>FindWordBreaks<TD>PixelToChar<TR>
<TD>FillParseTable<TD>FindScriptRun<TD>CharToPixel<TR>
<TD>PortionLine<TD>&nbsp;<TD>DrawJustified<TR>
<TD>&nbsp;<TD>&nbsp;<TD>MeasureJustified</TABLE>
</CODE><P>
 Note that those script utilities that do not call their equivalent Roman routine nevertheless call QuickDraw <CODE>StdText</CODE> or <CODE>StdTxMeas</CODE> if the grafProcs field in the graphics port has been changed. Thus, if you have changed (patched) either of those QuickDraw routines, your patch will still be called. Conversely, if the grafProcs field is NIL, The WorldScript I script utilities do not necessarily call StdText or StdTxMeas.</CODE></B><P>
 If you are replacing a script utility, remember that its interface is similar to that of its equivalent high-level call as described in <I>Inside Macintosh</I>. The utility takes the same parameters in the same order, except that it gets one additional last parameter on the stack: a pointer to the script record. For example, if you are replacing <CODE>VisibleLength</CODE>, whose high-level interface is<P>
<PRE>
FUNCTION VisibleLength (textPtr: Ptr; 
                        textLen: LongInt): LongInt;
</PRE>
 your patch to the equivalent script utility should expect to receive parameters as if the high-level interface were<P>
<PRE>
FUNCTION VisibleLength (textPtr: Ptr; 
                        textLen: LongInt;
                        scriptRecord: Ptr): LongInt;
</PRE>
 Also, if your replacement calls the original routine, don't forget to pass the extra parameter to it.<P>
<A NAME=HEADING526-15></A>
<H3>Patching QuickDraw Routines</H3>
 <A NAME=MARKER-2-138></A>WorldScript I patches the low-level QuickDraw text-handling routines <CODE>StdText</CODE> and <CODE>StdTxMeas</CODE>, the high-level QuickDraw routine <CODE>MeasureText</CODE>, and the Font Manager routine <CODE>FontMetrics</CODE>.<P>
 The QuickDraw patches lay out lines of text according to the context and line-direction rules for a script system. In each case (except for <CODE>MeasureText</CODE>) the patch calls the original QuickDraw routine after performing the contextual formatting. The contextual formatting routines are called only for contextual scripts.<P>
 <A HREF=#MARKER-9-42>Table A-14</A> lists the patches and what they do. For those patches that perform contextual formatting, if you replace them you will have to handle formatting for line layout yourself. For all of them, you can replace either the WorldScript I patch or the standard QuickDraw call or both, depending on your needs.
<TABLE BORDER="0" CELLPADDING=3>
<CAPTION><A NAME=MARKER-9-42></A><B>Table A-14 Classification of 1-byte QuickDraw patches by function</B></CAPTION>
<TH>Call<TH>Function<TR>
<TD>FontMetrics<TD>Returns font measurements<TR>
<TD>MeasureText<TD>Calls <CODE>MeasureJustified</CODE> (with slop = 0)<TR>
<TD>StdText<TD>Does formatting, then calls original routine<TR>
<TD>StdTxMeas<TD>Does formatting, then calls original routine</TABLE>
<P>
<A NAME=HEADING526-19></A>
<H3>Issues in Designing a Script Utility or QuickDraw Patch</H3>
 Keep the following points in mind if you plan to replace one or more script utilities or QuickDraw patches in WorldScript I:<P>
<UL>
<LI>In script systems compatible with WorldScript I, text handling typically involves WorldScript I contextual analysis followed by a call to the original Roman version of the routine. You need to know whether it is the WorldScript I functionality or the original functionality that you want your routine to replace, and you need to be sure that your routine is called only at the correct points in the process. More detailed information on text layout is found in the chapter "QuickDraw Text" in this book.
<LI><A NAME=MARKER-2-139></A>Script utilities process text in individual style runs, whose boundaries are defined by the application. If your application supports styled text, each script utility will need to handle only individual style runs. But if your application supports unstyled text only, there may be mixed Roman and non-Roman characters in a single font. Before performing text layout, your script utility will have to separate the Roman characters into their own style runs, and assign them to an associated font, if your script system uses associated fonts.
<LI><A NAME=MARKER-2-225></A>If you provide your own script utility, you need to be sure that text is not formatted more than once. Because script utilities might be called reentrantly during printing, you may want to save the port for each contextual analysis. Check this port against the current port for each possible contextual analysis request, so you can prevent the text from being formatted twice.
<LI><A NAME=MARKER-9-105></A>Printing adds another level of complexity to the WorldScript I QuickDraw <BR>patches and your ability to patch out those patches. The QuickDraw dispatch <BR>table has special entries to support developer patching of routines in printing as well as for display. See the descriptions of the routines <CODE>GetScriptQDPatchAddress</CODE> <BR>and <CODE>SetScriptQDPatchAddress</CODE> in the chapter "Script Manager" in this book <BR>for more information. See also Macintosh Technical Note #174 for additional information on printing. <A NAME=MARKER-2-142></A>  <A NAME=MARKER-2-106></A><P>
</UL>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Text-525.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Text-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Text-594.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Text-527.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Text-3.html">&copy; Apple Computer, Inc.</A><br>6 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
