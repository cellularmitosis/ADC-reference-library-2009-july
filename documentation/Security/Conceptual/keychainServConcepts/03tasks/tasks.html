<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Keychain Services Programming Guide: Keychain Services Tasks for Mac OS X</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Keychain Services Tasks for Mac OS X"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30000897-CH205" title="Keychain Services Tasks for Mac OS X"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000434" target="_top">Security</a> &gt; <a href="../../../Authentication-date.html#//apple_ref/doc/uid/TP30000440-TP30000434-TP30000487" target="_top">Authentication</a> &gt; <a href="../01introduction/introduction.html#//apple_ref/doc/uid/TP30000897-CH203-TP1">Keychain Services Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../02concepts/concepts.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../iPhoneTasks/iPhoneTasks.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30000897-CH205-TP9" title="Keychain Services Tasks for Mac OS X"></a><h1>Keychain Services Tasks for Mac OS X</h1><p>This chapter describes and illustrates the use of basic Keychain Services functions in Mac OS X. For the use of Keychain Services in iPhone OS, see <span class="content_text"><a href="../iPhoneTasks/iPhoneTasks.html#//apple_ref/doc/uid/TP30000897-CH208-SW1">“iPhone OS Keychain Services Tasks.”</a></span></p><p>The functions described in this chapter enable you to:</p><ul class="ul"><li class="li"><p>Add a password to a keychain</p></li><li class="li"><p>Find a password in a keychain</p></li><li class="li"><p>Get the attributes and data in a keychain item</p></li><li class="li"><p>Change the attributes and data in a keychain item</p></li><li class="li"><p>Unlock a keychain</p></li><li class="li"><p>Lock a keychain</p></li><li class="li"><p>Suppress the automatic display of the create keychain or open keychain dialogs</p></li><li class="li"><p>Add trusted applications to a keychain item’s access control list</p></li></ul><p><span class="content_text"><a href="../02concepts/concepts.html#//apple_ref/doc/uid/TP30000897-CH204-TP9">“Keychain Services Concepts”</a></span> provides an introduction to the concepts and terminology of Keychain Services. For detailed information about all Keychain Services functions, see <em><a href="../../../Reference/keychainservices/index.html#//apple_ref/doc/uid/TP30000898" target="_top">Keychain Services Reference</a></em>.</p>
<!-- This template is being used for both PDF and HTML. -->

    
    <h4>In this section:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="tasks.html#//apple_ref/doc/uid/TP30000897-CH205-BCIHAAGG">Adding Simple Keychain Services to Your Application</a>
				
			<br/>
			
        
			
			
				<a href="tasks.html#//apple_ref/doc/uid/TP30000897-CH205-BBCEAAFC">Advanced Topics</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP30000897-CH205-BCIHAAGG" title="Adding Simple Keychain Services to Your Application"></a><h2>Adding Simple Keychain Services to Your Application</h2><p>Most applications need to use Keychain Services only to add a new password to a keychain or retrieve a password when needed. Keychain Services provides the following pairs of functions for accomplishing these tasks:</p><ul class="ul"><li class="li"><p><code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainAddInternetPassword" target="_top">SecKeychainAddInternetPassword</a></code> and <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainFindInternetPassword" target="_top">SecKeychainFindInternetPassword</a></code> (for Internet passwords)</p></li><li class="li"><p><code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainAddGenericPassword" target="_top">SecKeychainAddGenericPassword</a></code> and <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainFindGenericPassword" target="_top">SecKeychainFindGenericPassword</a></code> (for generic passwords</p></li></ul><p>You use Internet passwords for accessing servers and websites over the Internet, and generic passwords for any other password-protected service (such as a database or scheduling application). AppleShare passwords (that is, keychain items with a class code of <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/kSecAppleSharePasswordItemClass" target="_top">kSecAppleSharePasswordItemClass</a></code>) are stored as generic passwords. </p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000897-CH205-SW2" title="Note"></a><p><strong>Note:</strong>&nbsp;AppleShare passwords created with the <strong>Keychain Manager</strong> function <code><a href="../../../../Carbon/Reference/Keychain_Manager/Reference/reference.html#//apple_ref/doc/c_ref/KCAddAppleSharePassword" target="_top">KCAddAppleSharePassword</a></code> are stored as Internet password items. You can use the <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainAddInternetPassword" target="_top">SecKeychainAddInternetPassword</a></code> function to store an AppleShare password, but it will appear in the Keychain Access utility as an Internet password. To create a keychain item with a class code of <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/kSecAppleSharePasswordItemClass" target="_top">kSecAppleSharePasswordItemClass</a></code>, you must use the lower-level API described in <em><a href="../../../Reference/keychainservices/index.html#//apple_ref/doc/uid/TP30000898" target="_top">Keychain Services Reference</a></em>.</p></div><p>The “find” functions retrieve information (attributes or secure data) from an item in the keychain. The “add” functions add an item to a keychain. These functions call other Keychain Services functions to accomplish their tasks. Because Keychain Services allocates the buffers in which the item data and attributes are returned, you must call <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainItemFreeContent" target="_top">SecKeychainItemFreeContent</a></code> to free these buffers after using one of the find functions to retrieve attributes or secure data from a keychain item. (If Keychain Services does not find the item or fails to return any data for some other reason, it does not allocate any buffers and you should not call the <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainItemFreeContent" target="_top">SecKeychainItemFreeContent</a></code> function.)</p><p><span class="content_text">Figure 2-1</span> shows a flowchart of how an application might use these functions to gain access to an Internet FTP server.</p><br/><div><a name="//apple_ref/doc/uid/TP30000897-CH205-BBCDHDJA" title="Figure 2-1Accessing an Internet server using Mac OS X Keychain Services"></a><p><strong>Figure 2-1&nbsp;&nbsp;</strong>Accessing an Internet server using Mac OS X Keychain Services</p><img src = "../art/keychain_flowchart.gif" alt = "Accessing an Internet server using Keychain Services" width="308" height="578"></div><br/><p>The user of the application starts by selecting a File Transfer Protocol (FTP) server. The application calls <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainFindInternetPassword" target="_top">SecKeychainFindInternetPassword</a></code>, passing it attributes that identify the service and the user to seek. If the password is on the keychain, the function returns the password to the application, which sends it to the FTP server to authenticate the user. The application then calls <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainItemFreeContent" target="_top">SecKeychainItemFreeContent</a></code> to free the data buffer allocated for the password (note that you should not call this function if no data is returned). If the authentication succeeds, the routine is finished. If the authentication fails, the application displays a dialog to request the user name and password.</p><p>If the password is not on the keychain, then <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainFindInternetPassword" target="_top">SecKeychainFindInternetPassword</a></code> returns the <code><a href="../../../Reference/CryptoMessageRef/Reference/reference.html#//apple_ref/doc/c_ref/errSecItemNotFound" target="_top">errSecItemNotFound</a></code> result code. In this case as well, the application displays a dialog to request the user name and password. (This dialog should also include a Cancel button, but that choice was omitted from the figure to keep the flowchart from becoming overly complex.)</p><p>Having obtained the password from the user, the application proceeds to authenticate the user to the FTP server. When the authentication has succeeded, the application can assume that the information entered by the user was valid. The application then displays another dialog asking the user whether to save the password on the keychain. If the user selects No, then the routine is finished. If the user selects Yes, then the application calls the <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainAddInternetPassword" target="_top">SecKeychainAddInternetPassword</a></code> function (if this is a new keychain item), or the <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainItemModifyAttributesAndData" target="_top">SecKeychainItemModifyAttributesAndData</a></code> function (to update an existing keychain item) before ending the routine.</p><p>If there is no keychain, the <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainFindInternetPassword" target="_top">SecKeychainFindInternetPassword</a></code> or <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainAddInternetPassword" target="_top">SecKeychainAddInternetPassword</a></code> function displays a dialog allowing the user to “reset to defaults” (see <span class="content_text"><a href="../02concepts/concepts.html#//apple_ref/doc/uid/TP30000897-CH204-CJBIEGBF">Figure 1-5</a></span>), which creates a new keychain named <code>login.keychain</code> with the user’s login account password. If the keychain is locked, the function displays a dialog requesting the user to enter a password to unlock the keychain (<span class="content_text"><a href="../02concepts/concepts.html#//apple_ref/doc/uid/TP30000897-CH204-CJBBHHEE">Figure 1-6</a></span>). The user can cancel the operation at this time as well.</p><p><span class="content_text">“Getting and setting passwords in Mac OS X Keychain Services”</span> shows how a typical application might use Keychain Services functions to get and set passwords for generic items. You can get and set keychain item attributes (such as user name or service name) using these same functions; see <span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP30000897-CH205-BCIHBDFB">Listing 2-2</a></span> for an example.</p><a name="//apple_ref/doc/uid/TP30000897-CH205-SW1" title="Listing 2-1Getting and setting passwords in Mac OS X Keychain Services"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30000897-CH205-BBCJACDI" title="Listing 2-1Getting and setting passwords in Mac OS X Keychain Services"></a><strong>Listing 2-1&nbsp;&nbsp;</strong>Getting and setting passwords in Mac OS X Keychain Services</p><div class="codesample"><table><tr><td scope="row"><pre>#include &lt;CoreFoundation/CoreFoundation.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;Security/Security.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;CoreServices/CoreServices.h><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>//Call SecKeychainAddGenericPassword to add a new password to the keychain:<span></span></pre></td></tr><tr><td scope="row"><pre>OSStatus StorePasswordKeychain (void* password,UInt32 passwordLength)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre> OSStatus status;<span></span></pre></td></tr><tr><td scope="row"><pre> status = SecKeychainAddGenericPassword (<span></span></pre></td></tr><tr><td scope="row"><pre>                NULL,            // default keychain<span></span></pre></td></tr><tr><td scope="row"><pre>                10,              // length of service name<span></span></pre></td></tr><tr><td scope="row"><pre>                "SurfWriter",    // service name<span></span></pre></td></tr><tr><td scope="row"><pre>                10,              // length of account name<span></span></pre></td></tr><tr><td scope="row"><pre>                "MyUserAcct",    // account name<span></span></pre></td></tr><tr><td scope="row"><pre>                passwordLength,  // length of password<span></span></pre></td></tr><tr><td scope="row"><pre>                password,        // pointer to password data<span></span></pre></td></tr><tr><td scope="row"><pre>                NULL             // the item reference<span></span></pre></td></tr><tr><td scope="row"><pre>    );<span></span></pre></td></tr><tr><td scope="row"><pre>    return (status);<span></span></pre></td></tr><tr><td scope="row"><pre> }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>//Call SecKeychainFindGenericPassword to get a password from the keychain:<span></span></pre></td></tr><tr><td scope="row"><pre>OSStatus GetPasswordKeychain (void *passwordData,UInt32 *passwordLength,<span></span></pre></td></tr><tr><td scope="row"><pre>                                                SecKeychainItemRef *itemRef)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre> OSStatus status1 ;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> status1 = SecKeychainFindGenericPassword (<span></span></pre></td></tr><tr><td scope="row"><pre>                 NULL,           // default keychain<span></span></pre></td></tr><tr><td scope="row"><pre>                 10,             // length of service name<span></span></pre></td></tr><tr><td scope="row"><pre>                 "SurfWriter",   // service name<span></span></pre></td></tr><tr><td scope="row"><pre>                 10,             // length of account name<span></span></pre></td></tr><tr><td scope="row"><pre>                 "MyUserAcct",   // account name<span></span></pre></td></tr><tr><td scope="row"><pre>                 passwordLength,  // length of password<span></span></pre></td></tr><tr><td scope="row"><pre>                 passwordData,   // pointer to password data<span></span></pre></td></tr><tr><td scope="row"><pre>                 itemRef         // the item reference<span></span></pre></td></tr><tr><td scope="row"><pre>    );<span></span></pre></td></tr><tr><td scope="row"><pre>     return (status1);<span></span></pre></td></tr><tr><td scope="row"><pre> }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>//Call SecKeychainItemModifyAttributesAndData to change the password for<span></span></pre></td></tr><tr><td scope="row"><pre>// an item already in the keychain:<span></span></pre></td></tr><tr><td scope="row"><pre>OSStatus ChangePasswordKeychain (SecKeychainItemRef itemRef)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status;<span></span></pre></td></tr><tr><td scope="row"><pre>    void * password = "myNewP4sSw0rD";<span></span></pre></td></tr><tr><td scope="row"><pre>    UInt32 passwordLength = strlen(password);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> status = SecKeychainItemModifyAttributesAndData (<span></span></pre></td></tr><tr><td scope="row"><pre>                 itemRef,         // the item reference<span></span></pre></td></tr><tr><td scope="row"><pre>                 NULL,            // no change to attributes<span></span></pre></td></tr><tr><td scope="row"><pre>                 passwordLength,  // length of password<span></span></pre></td></tr><tr><td scope="row"><pre>                 password         // pointer to password data<span></span></pre></td></tr><tr><td scope="row"><pre>    );<span></span></pre></td></tr><tr><td scope="row"><pre>     return (status);<span></span></pre></td></tr><tr><td scope="row"><pre> }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/* ********************************************************************** */<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>int main (int argc, const char * argv[]) {<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status1;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     void * myPassword = "myP4sSw0rD";<span></span></pre></td></tr><tr><td scope="row"><pre>     UInt32 myPasswordLength = strlen(myPassword);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     void *passwordData = nil; // will be allocated and filled in by<span></span></pre></td></tr><tr><td scope="row"><pre>                               //SecKeychainFindGenericPassword<span></span></pre></td></tr><tr><td scope="row"><pre>     SecKeychainItemRef itemRef = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>     UInt32 passwordLength = nil;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status1 = GetPasswordKeychain (&amp;passwordData,&amp;passwordLength,&amp;itemRef);  //Call<span></span></pre></td></tr><tr><td scope="row"><pre>                                                //SecKeychainFindGenericPassword<span></span></pre></td></tr><tr><td scope="row"><pre>        if (status1 == noErr)       //If call was successful, authenticate user<span></span></pre></td></tr><tr><td scope="row"><pre>                                    //and continue.<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>        //Free the data allocated by SecKeychainFindGenericPassword:<span></span></pre></td></tr><tr><td scope="row"><pre>    status = SecKeychainItemFreeContent (<span></span></pre></td></tr><tr><td scope="row"><pre>                 NULL,           //No attribute data to release<span></span></pre></td></tr><tr><td scope="row"><pre>                 passwordData    //Release data buffer allocated by<span></span></pre></td></tr><tr><td scope="row"><pre>                 //SecKeychainFindGenericPassword<span></span></pre></td></tr><tr><td scope="row"><pre>    );<span></span></pre></td></tr><tr><td scope="row"><pre> }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (status1 == errSecItemNotFound) { //Is password on keychain?<span></span></pre></td></tr><tr><td scope="row"><pre>    /*<span></span></pre></td></tr><tr><td scope="row"><pre>    If password is not on keychain, display dialog to prompt user for<span></span></pre></td></tr><tr><td scope="row"><pre>    name and password.<span></span></pre></td></tr><tr><td scope="row"><pre>    Authenticate user.  If unsuccessful, prompt user again for name and password.<span></span></pre></td></tr><tr><td scope="row"><pre>    If successful, ask user whether to store new password on keychain; if no, return.<span></span></pre></td></tr><tr><td scope="row"><pre>    If yes, store password:<span></span></pre></td></tr><tr><td scope="row"><pre>    */<span></span></pre></td></tr><tr><td scope="row"><pre>    status = StorePasswordKeychain (myPassword,myPasswordLength); //Call<span></span></pre></td></tr><tr><td scope="row"><pre>                                                      // SecKeychainAddGenericPassword<span></span></pre></td></tr><tr><td scope="row"><pre>    return (status);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    /*<span></span></pre></td></tr><tr><td scope="row"><pre>    If password is on keychain, authenticate user.<span></span></pre></td></tr><tr><td scope="row"><pre>    If authentication succeeds, return.<span></span></pre></td></tr><tr><td scope="row"><pre>    If authentication fails, prompt user for new user name and password and<span></span></pre></td></tr><tr><td scope="row"><pre>     authenticate again.<span></span></pre></td></tr><tr><td scope="row"><pre>    If unsuccessful, prompt again.<span></span></pre></td></tr><tr><td scope="row"><pre>    If successful, ask whether to update keychain with new information.  If no, return.<span></span></pre></td></tr><tr><td scope="row"><pre>    If yes, store new information:<span></span></pre></td></tr><tr><td scope="row"><pre>    */<span></span></pre></td></tr><tr><td scope="row"><pre>    status = ChangePasswordKeychain (itemRef);  //Call<span></span></pre></td></tr><tr><td scope="row"><pre>                                            // SecKeychainItemModifyAttributesAndData<span></span></pre></td></tr><tr><td scope="row"><pre>    if (itemRef) CFRelease(itemRef);<span></span></pre></td></tr><tr><td scope="row"><pre>    return (status);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> }<span></span></pre></td></tr></table></div>	<p>This example follows the same general sequence that was shown in <span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP30000897-CH205-BBCDHDJA">Figure 2-1</a></span>; however, unlike the figure, the example illustrates the use of generic passwords rather than Internet passwords. </p><div class="importantbox"><a name="//apple_ref/doc/uid/TP30000897-CH205-DontLinkElementID_4" title="Important:"></a><p><strong>Important:</strong>&nbsp;You should not cache passwords, because the user can change them using Keychain Access or another program and the data may no longer be valid. In addition, the long-term storage of passwords by applications negates the value of the keychain.</p><p></p></div><p>Although the example in <span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP30000897-CH205-BBCJACDI">“Getting and setting passwords in Mac OS X Keychain Services”</a></span> is written in procedural C, you can call these same functions using Objective C. <span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP30000897-CH205-BCIHBDFB">Listing 2-2</a></span> shows how you might create an Internet password item if you wanted some custom attribute values. Note that attribute strings should all be encoded in UTF-8 format.</p><a name="//apple_ref/doc/uid/TP30000897-CH205-BBCEAAFC" title="Advanced Topics"></a><h2>Advanced Topics</h2><p>Most applications need only the Keychain Services functions described in <span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP30000897-CH205-BCIHAAGG">“Adding Simple Keychain Services to Your Application.”</a></span> However, in certain circumstances you might want to use some of the other functions provided by Keychain Services. For example, you might want to display a custom label for your application in the Keychain Access utility. Or, if you are writing a server, you might want to disable the automatic display of dialogs and instead take care of unlocking the keychain within your application.</p><a name="//apple_ref/doc/uid/TP30000897-CH205-TPXREF7" title="Creating a Custom Keychain Item"></a><h3>Creating a Custom Keychain Item</h3><p>This section discusses how to create a keychain item if you want lower-level control than is provided by <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainAddInternetPassword" target="_top">SecKeychainAddInternetPassword</a></code> or <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainAddGenericPassword" target="_top">SecKeychainAddGenericPassword</a></code>. For example, you might want to have the Keychain Access application display a custom label for your keychain item or you might want to specify more than one trusted application that can access the item. Specifically, this section illustrates the use of the <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainItemCreateFromContent" target="_top">SecKeychainItemCreateFromContent</a></code> function to create a keychain item and the <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecAccessCreate" target="_top">SecAccessCreate</a></code> function to set up an access list. For more details about these and other low-level functions, see <em><a href="../../../Reference/keychainservices/index.html#//apple_ref/doc/uid/TP30000898" target="_top">Keychain Services Reference</a></em>. </p><p>When you use <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainAddInternetPassword" target="_top">SecKeychainAddInternetPassword</a></code> or <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainAddGenericPassword" target="_top">SecKeychainAddGenericPassword</a></code>, the function creates a label for the keychain item automatically. For an Internet password, it uses the URL, minus the scheme name, colon, and leading slashes. For example, the label (displayed in the Name field in Keychain Access) for a new Internet password for the URL http://www.apple.com becomes www.apple.com. For a generic password, the function uses the service attribute for the label. In both cases, the Name and Where fields in Keychain access are identical. If you want a unique name for the keychain item that is different from the URL or service name, you can specify the label (<code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/kSecLabelItemAttr" target="_top">kSecLabelItemAttr</a></code>) attribute when you call <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainItemCreateFromContent" target="_top">SecKeychainItemCreateFromContent</a></code>. </p><p>The <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainAddInternetPassword" target="_top">SecKeychainAddInternetPassword</a></code> and <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainAddGenericPassword" target="_top">SecKeychainAddGenericPassword</a></code> functions create an initial access list for you. This default access list includes only one trusted application (that is, one application that can access the keychain item whenever the keychain is unlocked), namely the application that created the keychain item. The <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainItemCreateFromContent" target="_top">SecKeychainItemCreateFromContent</a></code> function accepts an access list as input. However, if you pass <code>NULL</code>, this function creates an access list consisting of the single application calling the function. Therefore, you must call the <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecAccessCreate" target="_top">SecAccessCreate</a></code> function before calling the <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainItemCreateFromContent" target="_top">SecKeychainItemCreateFromContent</a></code> function if you want an access list with more than one trusted application. Alternatively, you can alter the access list of an existing keychain item; see <span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP30000897-CH205-BBCHEABI">“Modifying the Access List of an Existing Keychain Item.”</a></span></p><p><span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP30000897-CH205-BCIHBDFB">Listing 2-2</a></span> illustrates the creation of an Internet keychain item with a custom label and an access list that includes two trusted applications. This listing also illustrates the use of the Keychain Services API from an Objective-C application.</p><a name="//apple_ref/doc/uid/TP30000897-CH205-BCIHBDFB" title="Listing 2-2Creating a keychain item with custom attributes"></a><p class="codesample"><strong>Listing 2-2&nbsp;&nbsp;</strong>Creating a keychain item with custom attributes</p><div class="codesample"><table><tr><td scope="row"><pre>#import &lt;Cocoa/Cocoa.h><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;Security/SecKeychain.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;Security/SecKeychainItem.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;Security/SecAccess.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;Security/SecTrustedApplication.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;Security/SecACL.h><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>SecAccessRef createAccess(NSString *accessLabel)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus err;<span></span></pre></td></tr><tr><td scope="row"><pre>    SecAccessRef access=nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSArray *trustedApplications=nil;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    //Make an exception list of trusted applications; that is,<span></span></pre></td></tr><tr><td scope="row"><pre>    // applications that are allowed to access the item without<span></span></pre></td></tr><tr><td scope="row"><pre>    // requiring user confirmation:<span></span></pre></td></tr><tr><td scope="row"><pre>    SecTrustedApplicationRef myself, someOther;<span></span></pre></td></tr><tr><td scope="row"><pre>//Create trusted application references; see SecTrustedApplications.h:<span></span></pre></td></tr><tr><td scope="row"><pre>    err = SecTrustedApplicationCreateFromPath(NULL, &amp;myself);<span></span></pre></td></tr><tr><td scope="row"><pre>    err = SecTrustedApplicationCreateFromPath("/Applications/Mail.app",<span></span></pre></td></tr><tr><td scope="row"><pre>                                                            &amp;someOther);<span></span></pre></td></tr><tr><td scope="row"><pre>    trustedApplications = [NSArray arrayWithObjects:(id)myself,<span></span></pre></td></tr><tr><td scope="row"><pre>                                                    (id)someOther, nil];<span></span></pre></td></tr><tr><td scope="row"><pre>//Create an access object:<span></span></pre></td></tr><tr><td scope="row"><pre>    err = SecAccessCreate((CFStringRef)accessLabel,<span></span></pre></td></tr><tr><td scope="row"><pre>                            (CFArrayRef)trustedApplications, &amp;access);<span></span></pre></td></tr><tr><td scope="row"><pre>    if (err) return nil;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return access;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>void addInternetPassword(NSString *password, NSString *account,<span></span></pre></td></tr><tr><td scope="row"><pre>                    NSString *server, NSString *itemLabel, NSString *path,<span></span></pre></td></tr><tr><td scope="row"><pre>                    SecProtocolType protocol, int port)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus err;<span></span></pre></td></tr><tr><td scope="row"><pre>    SecKeychainItemRef item = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    const char *pathUTF8 = [path UTF8String];<span></span></pre></td></tr><tr><td scope="row"><pre>    const char *serverUTF8 = [server UTF8String];<span></span></pre></td></tr><tr><td scope="row"><pre>    const char *accountUTF8 = [account UTF8String];<span></span></pre></td></tr><tr><td scope="row"><pre>    const char *passwordUTF8 = [password UTF8String];<span></span></pre></td></tr><tr><td scope="row"><pre>    const char *itemLabelUTF8 = [itemLabel UTF8String];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    //Create initial access control settings for the item:<span></span></pre></td></tr><tr><td scope="row"><pre>    SecAccessRef access = createAccess(itemLabel);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    //Following is the lower-level equivalent to the<span></span></pre></td></tr><tr><td scope="row"><pre>    // SecKeychainAddInternetPassword function:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    //Set up the attribute vector (each attribute consists<span></span></pre></td></tr><tr><td scope="row"><pre>    // of {tag, length, pointer}):<span></span></pre></td></tr><tr><td scope="row"><pre>    SecKeychainAttribute attrs[] = {<span></span></pre></td></tr><tr><td scope="row"><pre>        { kSecLabelItemAttr, strlen(itemLabelUTF8), (char *)itemLabelUTF8 },<span></span></pre></td></tr><tr><td scope="row"><pre>        { kSecAccountItemAttr, strlen(accountUTF8), (char *)accountUTF8 },<span></span></pre></td></tr><tr><td scope="row"><pre>        { kSecServerItemAttr, strlen(serverUTF8), (char *)serverUTF8 },<span></span></pre></td></tr><tr><td scope="row"><pre>        { kSecPortItemAttr, sizeof(int), (int *)&amp;port },<span></span></pre></td></tr><tr><td scope="row"><pre>        { kSecProtocolItemAttr, sizeof(SecProtocolType),<span></span></pre></td></tr><tr><td scope="row"><pre>                                        (SecProtocolType *)&amp;protocol },<span></span></pre></td></tr><tr><td scope="row"><pre>        { kSecPathItemAttr, strlen(pathUTF8), (char *)pathUTF8 }<span></span></pre></td></tr><tr><td scope="row"><pre>    };<span></span></pre></td></tr><tr><td scope="row"><pre>    SecKeychainAttributeList attributes = { sizeof(attrs) / sizeof(attrs[0]),<span></span></pre></td></tr><tr><td scope="row"><pre>                                                                attrs };<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    err = SecKeychainItemCreateFromContent(<span></span></pre></td></tr><tr><td scope="row"><pre>        kSecInternetPasswordItemClass,<span></span></pre></td></tr><tr><td scope="row"><pre>        &amp;attributes,<span></span></pre></td></tr><tr><td scope="row"><pre>        strlen(passwordUTF8),<span></span></pre></td></tr><tr><td scope="row"><pre>        passwordUTF8,<span></span></pre></td></tr><tr><td scope="row"><pre>        NULL, // use the default keychain<span></span></pre></td></tr><tr><td scope="row"><pre>        access,<span></span></pre></td></tr><tr><td scope="row"><pre>        &amp;item);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (access) CFRelease(access);<span></span></pre></td></tr><tr><td scope="row"><pre>    if (item) CFRelease(item);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>int main(int argc, const char *argv[])<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    //Add an example password to the keychain:<span></span></pre></td></tr><tr><td scope="row"><pre>    addInternetPassword(@"sample password", @"sample account",<span></span></pre></td></tr><tr><td scope="row"><pre>        @"samplehost.apple.com", @"sampleName", @"cgi-bin/bogus/testpath",<span></span></pre></td></tr><tr><td scope="row"><pre>                                            kSecProtocolTypeHTTP, 8080);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    [pool release];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return 0;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000897-CH205-BBCHEABI" title="Modifying the Access List of an Existing Keychain Item"></a><h3>Modifying the Access List of an Existing Keychain Item</h3><p>By default, a keychain item’s access list contains only the application that created the keychain item. <span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP30000897-CH205-BCIHBDFB">Listing 2-2</a></span> illustrates the creation of an Internet keychain item with an access list that includes two trusted applications. <span class="content_text">Listing 2-3</span> illustrates how to modify an existing keychain item. The listing finds a specific keychain item, extracts the access object, including the list of trusted applications, authorization tags, and other information (see <span class="content_text"><a href="../02concepts/concepts.html#//apple_ref/doc/uid/TP30000897-CH204-CJBJJHGD">“ACL Entries”</a></span>), adds a trusted application to the list, reconstitutes the access object, and writes the new access object back to the keychain item. Although this sample illustrates modifying the list of trusted applications, you can use a similar sequence to modify any of the information in the access object—for example, to add or remove an authorization tag.</p><p><span class="content_text">Listing 2-3</span> starts by calling the <code>SecKeychainSearchCreateFromAttributes</code> function to create a search reference. In this example, the code looks for a keychain item by its label (as seen in the Keychain Access application); you can search for other attributes, however, such as modification date. Using this search reference, the sample calls <code>SecKeychainSearchCopyNext</code> to find the keychain item. </p><p>The listing next calls <code>SecKeychainItemCopyAccess</code> to retrieve the keychain item’s access object. As discussed in <span class="content_text"><a href="../02concepts/concepts.html#//apple_ref/doc/uid/TP30000897-CH204-CJBIBIBC">“Keychain Access Controls,”</a></span> the access object includes one or more ACL entries. The listing calls the <code>SecAccessCopySelectedACLList</code> function and passes it an authorization tag value of <code>CSSM_ACL_AUTHORIZATION_DECRYPT</code>. This authorization tag is one of the tags normally associated with the access list used for sensitive operations and is the list displayed by the Keychain Access application. To retrieve all the ACL entries for an access object, use the <code>SecAccessCopyACLList</code> function instead.</p><p>The <code>SecAccessCopySelectedACLList</code> function returns a CFArrayRef object containing all of the ACL entries that meet the selection criteria. In this case, the code is assuming that there should be only one ACL entry that employs the <code>CSSM_ACL_AUTHORIZATION_DECRYPT</code> tag. The listing calls the <code>CFArrayGetValues</code> function to create a C array of <code>SecACLRef</code> objects from the CFArrayRef and then calls the <code>SecACLCopySimpleContents</code> function, passing it the first (and presumably only) item in the array. The <code>SecACLCopySimpleContents</code> function also retrieves a CFArrayRef containing the list of trusted applications, the keychain item description string, and the prompt selector flag. These values are needed in order to reconstitute the ACL entry after adding a trusted application to the list.</p><p>Next, the listing uses the <code>CFArrayGetValues</code> function again, this time to extract the array of trusted applications from the CFArrayRef. The listing calls the <code>SecTrustedApplicationCreateFromPath</code> function to create a new trusted application object, appends the new application to the list, and calls <code>CFArrayCreate</code> to create a new CFArrayRef. </p><p> Before adding a new ACL entry to the access object, the listing calls the <code>SecACLGetAuthorizations</code> function to get the list of authorization tags from the old access object. Then, having extracted all the information from the old ACL entry, the code calls the <code>SecACLRemove</code> function to remove the old ACL entry from the access object. The listing then calls the <code>SecACLCreateFromSimpleContents</code> function to create a new ACL entry for the access object. This function automatically adds the entry to the access object; there is no separate call for that purpose. The new ACL entry has only the default authorization list, however, so the listing calls the <code>SecACLSetAuthorizations</code> function, passing in the authorization list extracted from the old ACL entry.</p><p>The access object is now complete, with the new ACL entry containing all of the trusted applications in the old entry plus the new one added here. Only two steps remain: First, the listing calls the <code>SecKeychainItemSetAccess</code> function to replace the access object in the keychain item with the new access object; then the listing calls the <code>CFRelease</code> function for each core foundation object that is no longer needed, in order to release the memory.</p><p>Note that this sample routine causes the user to be prompted twice for permission: once when the old ACL entry is deleted from the access object, and once when the new access object is written to the keychain item.</p><a name="//apple_ref/doc/uid/TP30000897-CH205-BBCJJHFH" title="Listing 2-3Modifying a keychain item access list"></a><p class="codesample"><strong>Listing 2-3&nbsp;&nbsp;</strong>Modifying a keychain item access list</p><div class="codesample"><table><tr><td scope="row"><pre>#include &lt;CoreFoundation/CoreFoundation.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;Security/Security.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;CoreServices/CoreServices.h><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>//Call SecKeychainSearchCreateFromAttributes to get a search reference:<span></span></pre></td></tr><tr><td scope="row"><pre>OSStatus GetSearchRef (SecKeychainAttributeList *attrList,<span></span></pre></td></tr><tr><td scope="row"><pre>                         SecKeychainSearchRef *searchReference)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status = SecKeychainSearchCreateFromAttributes (<span></span></pre></td></tr><tr><td scope="row"><pre>        NULL,                           // default keychain search list<span></span></pre></td></tr><tr><td scope="row"><pre>        kSecInternetPasswordItemClass,  // search for an Internet password<span></span></pre></td></tr><tr><td scope="row"><pre>        attrList,                       // match attributes<span></span></pre></td></tr><tr><td scope="row"><pre>        searchReference                 // search reference to return<span></span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return (status);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>//Call SecKeychainSearchCopyNext to find an item on the keychain:<span></span></pre></td></tr><tr><td scope="row"><pre>OSStatus FindItem (SecKeychainSearchRef searchReference,<span></span></pre></td></tr><tr><td scope="row"><pre>                                SecKeychainItemRef *itemRef)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status1 ;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status1 = SecKeychainSearchCopyNext (<span></span></pre></td></tr><tr><td scope="row"><pre>        searchReference,                    // search reference<span></span></pre></td></tr><tr><td scope="row"><pre>        itemRef                             // the item reference<span></span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return (status1);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>//Get an ACL out of a CFArray:<span></span></pre></td></tr><tr><td scope="row"><pre>SecACLRef GetACL (CFIndex numACLs, CFArrayRef ACLList,<span></span></pre></td></tr><tr><td scope="row"><pre>                CFArrayRef *applicationList, CFStringRef *description,<span></span></pre></td></tr><tr><td scope="row"><pre>                CSSM_ACL_KEYCHAIN_PROMPT_SELECTOR *promptSelector)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status;<span></span></pre></td></tr><tr><td scope="row"><pre>    SecACLRef aclArray[numACLs];<span></span></pre></td></tr><tr><td scope="row"><pre>    CFRange aclRange;<span></span></pre></td></tr><tr><td scope="row"><pre>    aclRange.location = (CFIndex) 0;<span></span></pre></td></tr><tr><td scope="row"><pre>    aclRange.length = numACLs;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    CFArrayGetValues (<span></span></pre></td></tr><tr><td scope="row"><pre>        ACLList,            // the CFArrayRef we got from the keychain item<span></span></pre></td></tr><tr><td scope="row"><pre>        aclRange,           // the size of the array<span></span></pre></td></tr><tr><td scope="row"><pre>        (void *) aclArray   // a SecACLRef containing the values from the<span></span></pre></td></tr><tr><td scope="row"><pre>                            // CFArrayRef<span></span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre>    //Extract the application list from the ACL.<span></span></pre></td></tr><tr><td scope="row"><pre>    //Because we limited our search to ACLs used for decryption, we<span></span></pre></td></tr><tr><td scope="row"><pre>    // expect only one ACL for this item. Therefore, we extract the<span></span></pre></td></tr><tr><td scope="row"><pre>    // application list from the first ACL in the array.<span></span></pre></td></tr><tr><td scope="row"><pre>    status = SecACLCopySimpleContents (<span></span></pre></td></tr><tr><td scope="row"><pre>        aclArray[0],            // the ACL from which to extract<span></span></pre></td></tr><tr><td scope="row"><pre>                                //  the list of trusted apps<span></span></pre></td></tr><tr><td scope="row"><pre>        applicationList,        // the list of trusted apps<span></span></pre></td></tr><tr><td scope="row"><pre>        description,            // the description string<span></span></pre></td></tr><tr><td scope="row"><pre>        promptSelector          // the value of the prompt selector flag<span></span></pre></td></tr><tr><td scope="row"><pre>                                        );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return aclArray[0];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>int main (int argc, const char * argv[]) {<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status1;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status2;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status3;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    SecKeychainSearchRef searchReference = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    SecKeychainItemRef itemRef = nil;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     SecAccessRef itemAccess = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>     SecACLRef oldACL, newACL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     CFIndex arrayCount;<span></span></pre></td></tr><tr><td scope="row"><pre>     CFRange arrayRange;<span></span></pre></td></tr><tr><td scope="row"><pre>     SecTrustedApplicationRef trustedAppArray[10];<span></span></pre></td></tr><tr><td scope="row"><pre>     CSSM_ACL_KEYCHAIN_PROMPT_SELECTOR promptSelector;<span></span></pre></td></tr><tr><td scope="row"><pre>     CFStringRef description;<span></span></pre></td></tr><tr><td scope="row"><pre>     CFArrayRef newTrustedAppArray;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>      CSSM_ACL_AUTHORIZATION_TAG tags[20];<span></span></pre></td></tr><tr><td scope="row"><pre>      uint32 tagCount;<span></span></pre></td></tr><tr><td scope="row"><pre>      tagCount = 20;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     const char *path = "/Applications/Mail.app";       //path to<span></span></pre></td></tr><tr><td scope="row"><pre>                                        // trusted app to add to ACL<span></span></pre></td></tr><tr><td scope="row"><pre>     SecTrustedApplicationRef trustedApp;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     SecKeychainAttributeList attrList;<span></span></pre></td></tr><tr><td scope="row"><pre>     SecKeychainAttribute attrib;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     attrList.count = 1;<span></span></pre></td></tr><tr><td scope="row"><pre>     attrib.tag = kSecLabelItemAttr;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     attrib.data = "www.TestItem.com";              //label of keychain item<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     attrib.length = strlen(attrib.data);<span></span></pre></td></tr><tr><td scope="row"><pre>     attrList.attr  = &amp;attrib;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     CFArrayRef aclList;<span></span></pre></td></tr><tr><td scope="row"><pre>     CFIndex numACLs;<span></span></pre></td></tr><tr><td scope="row"><pre>     CFArrayRef applicationList;<span></span></pre></td></tr><tr><td scope="row"><pre>     CSSM_ACL_AUTHORIZATION_TAG authorizationTag =<span></span></pre></td></tr><tr><td scope="row"><pre>        CSSM_ACL_AUTHORIZATION_DECRYPT;  // the authorization tag<span></span></pre></td></tr><tr><td scope="row"><pre>                                        //  to search for.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Obtain a search reference object to use for finding the item<span></span></pre></td></tr><tr><td scope="row"><pre>    //  in the keychain.<span></span></pre></td></tr><tr><td scope="row"><pre>    // This returns a SecKeychainSearchRef, which we must release when<span></span></pre></td></tr><tr><td scope="row"><pre>    //  we're finished using it.<span></span></pre></td></tr><tr><td scope="row"><pre>    status = GetSearchRef (&amp;attrList, &amp;searchReference);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Find the keychain item and obtain a keychain item reference object.<span></span></pre></td></tr><tr><td scope="row"><pre>    // This returns a SecKeychainItemRef, which we must release when<span></span></pre></td></tr><tr><td scope="row"><pre>    //  we're finished using it.<span></span></pre></td></tr><tr><td scope="row"><pre>    status1 = FindItem (searchReference, &amp;itemRef);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (status1 == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>        // Obtain the access reference object for the keychain item.<span></span></pre></td></tr><tr><td scope="row"><pre>        // This returns a SecAccessRef, which we must release when<span></span></pre></td></tr><tr><td scope="row"><pre>        //  we're finished using it.<span></span></pre></td></tr><tr><td scope="row"><pre>        status2 = SecKeychainItemCopyAccess (itemRef, &amp;itemAccess);<span></span></pre></td></tr><tr><td scope="row"><pre>        // Obtain an array of ACL entry objects for the access object.<span></span></pre></td></tr><tr><td scope="row"><pre>        // Limit the search to ACL entries with the specified<span></span></pre></td></tr><tr><td scope="row"><pre>        //  authorization tag.<span></span></pre></td></tr><tr><td scope="row"><pre>        status3 = SecAccessCopySelectedACLList (itemAccess,<span></span></pre></td></tr><tr><td scope="row"><pre>                                     authorizationTag, &amp;aclList);<span></span></pre></td></tr><tr><td scope="row"><pre>        numACLs = CFArrayGetCount (aclList);<span></span></pre></td></tr><tr><td scope="row"><pre>        // Extract the ACL entry object from the array of ACL entries,<span></span></pre></td></tr><tr><td scope="row"><pre>        //  along with the ACL entry's list of trusted applications,<span></span></pre></td></tr><tr><td scope="row"><pre>        //  its description, and its prompt selector flag setting.<span></span></pre></td></tr><tr><td scope="row"><pre>        // This returns a SecACLRef and a CFArrayRef, which we must<span></span></pre></td></tr><tr><td scope="row"><pre>        //  release we're finished using them.<span></span></pre></td></tr><tr><td scope="row"><pre>        oldACL = GetACL (numACLs, aclList, &amp;applicationList,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    &amp;description, &amp;promptSelector);<span></span></pre></td></tr><tr><td scope="row"><pre>        arrayCount = CFArrayGetCount (applicationList);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        //  The application list is a CFArray.  Extract the list of<span></span></pre></td></tr><tr><td scope="row"><pre>        //  applications from the CFArray.<span></span></pre></td></tr><tr><td scope="row"><pre>        arrayRange.location = (CFIndex) 0;<span></span></pre></td></tr><tr><td scope="row"><pre>        arrayRange.length = arrayCount;<span></span></pre></td></tr><tr><td scope="row"><pre>        CFArrayGetValues (applicationList, arrayRange,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            (void *) trustedAppArray);<span></span></pre></td></tr><tr><td scope="row"><pre>        // Create a new trusted application reference object for<span></span></pre></td></tr><tr><td scope="row"><pre>        //  the application to be added to the list.<span></span></pre></td></tr><tr><td scope="row"><pre>        status2 = SecTrustedApplicationCreateFromPath (path, &amp;trustedApp);<span></span></pre></td></tr><tr><td scope="row"><pre>        if (status2 == noErr)   // the function fails if the application is<span></span></pre></td></tr><tr><td scope="row"><pre>                                // not found.<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            // Append the new application to the array and create a<span></span></pre></td></tr><tr><td scope="row"><pre>            //  new CFArray.<span></span></pre></td></tr><tr><td scope="row"><pre>            trustedAppArray[arrayCount] = trustedApp;<span></span></pre></td></tr><tr><td scope="row"><pre>            newTrustedAppArray = CFArrayCreate (NULL,<span></span></pre></td></tr><tr><td scope="row"><pre>                                (void *)trustedAppArray, arrayCount+1,<span></span></pre></td></tr><tr><td scope="row"><pre>                                                &amp;kCFTypeArrayCallBacks);<span></span></pre></td></tr><tr><td scope="row"><pre>            // Get the authorizations from the old ACL.<span></span></pre></td></tr><tr><td scope="row"><pre>            status3 = SecACLGetAuthorizations (oldACL, tags, &amp;tagCount);<span></span></pre></td></tr><tr><td scope="row"><pre>            // Delete the old ACL from the access object. The user is<span></span></pre></td></tr><tr><td scope="row"><pre>            // prompted for permission to alter the keychain item.<span></span></pre></td></tr><tr><td scope="row"><pre>            status3 = SecACLRemove (oldACL);<span></span></pre></td></tr><tr><td scope="row"><pre>            // Create a new ACL with the same attributes as the old<span></span></pre></td></tr><tr><td scope="row"><pre>            //  one, except use the new CFArray of trusted applications.<span></span></pre></td></tr><tr><td scope="row"><pre>            status3 = SecACLCreateFromSimpleContents (itemAccess,<span></span></pre></td></tr><tr><td scope="row"><pre>                        newTrustedAppArray, description, &amp;promptSelector,<span></span></pre></td></tr><tr><td scope="row"><pre>                                                            &amp;newACL);<span></span></pre></td></tr><tr><td scope="row"><pre>            // Set the authorizations for the new ACL to be the same as<span></span></pre></td></tr><tr><td scope="row"><pre>            //  those for the old ACL.<span></span></pre></td></tr><tr><td scope="row"><pre>            status3 = SecACLSetAuthorizations (newACL, tags, tagCount);<span></span></pre></td></tr><tr><td scope="row"><pre>            // Replace the access object in the keychain item with the<span></span></pre></td></tr><tr><td scope="row"><pre>            //  new access object. The user is prompted for permission<span></span></pre></td></tr><tr><td scope="row"><pre>            //  to alter the keychain item.<span></span></pre></td></tr><tr><td scope="row"><pre>            status3 = SecKeychainItemSetAccess (itemRef, itemAccess);<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        else<span></span></pre></td></tr><tr><td scope="row"><pre>            ...; //Handle the error if the application was not found.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Release the objects we allocated or retrieved<span></span></pre></td></tr><tr><td scope="row"><pre>    if (searchReference)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(searchReference);     //SecKeychainSearchRef<span></span></pre></td></tr><tr><td scope="row"><pre>    if (itemRef)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(itemRef);             //SecKeychainItemRef<span></span></pre></td></tr><tr><td scope="row"><pre>    if (itemAccess)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(itemAccess);          //SecAccessRef<span></span></pre></td></tr><tr><td scope="row"><pre>    if (oldACL)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(oldACL);              //SecACLRef<span></span></pre></td></tr><tr><td scope="row"><pre>    if (newACL)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(newACL);              //SecACLRef<span></span></pre></td></tr><tr><td scope="row"><pre>    if (description)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(description);         //CFStringRef<span></span></pre></td></tr><tr><td scope="row"><pre>    if (newTrustedAppArray)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(newTrustedAppArray);  //CFArrayRef<span></span></pre></td></tr><tr><td scope="row"><pre>    if (trustedApp)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(trustedApp);          //SecTrustedApplicationRef<span></span></pre></td></tr><tr><td scope="row"><pre>    if (aclList)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(aclList);             //CFArrayRef<span></span></pre></td></tr><tr><td scope="row"><pre>    if (applicationList)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(applicationList);     //CFArrayRef<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    return (status3);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000897-CH205-TPXREF8" title="Servers and the Keychain"></a><h3>Servers and the Keychain</h3><p>Several Keychain Services functions automatically display a dialog requesting that the user unlock the keychain or create a new keychain when necessary. Keychain Services also displays dialogs to confirm that the user wants the application to access the keychain (<span class="content_text">Figure 2-2</span>) and for other reasons. If you are writing a server application that must run unattended, you might want to disable the automatic display of dialogs and programatically unlock or create keychains.</p><br/><div><a name="//apple_ref/doc/uid/TP30000897-CH205-BBCCJCEC" title="Figure 2-2Confirm access dialog"></a><p><strong>Figure 2-2&nbsp;&nbsp;</strong>Confirm access dialog</p><img src = "../art/confirm_access_nopw_dlg.gif" alt = "Confirm access dialog" width="399" height="163"></div><br/><p>Use the <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainSetUserInteractionAllowed" target="_top">SecKeychainSetUserInteractionAllowed</a></code> function to enable or disable the automatic display of dialogs. When you call this function with a value of <code><!--a  -->FALSE<!--/a--></code> for the <code>state</code> parameter, any Keychain Services functions that ordinarily open dialogs instead return immediately with the result <code><a href="../../../Reference/CryptoMessageRef/Reference/reference.html#//apple_ref/doc/c_ref/errSecInteractionRequired" target="_top">errSecInteractionRequired</a></code>. You can use the <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainGetStatus" target="_top">SecKeychainGetStatus</a></code> function to find out whether the keychain exists and is unlocked. You can then use the <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainUnlock" target="_top">SecKeychainUnlock</a></code> function to unlock the keychain, or the <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainCreate" target="_top">SecKeychainCreate</a></code> function to create a new keychain, as necessary.</p><div class="importantbox"><a name="//apple_ref/doc/uid/TP30000897-CH205-DontLinkElementID_5" title="Important:"></a><p><strong>Important:</strong>&nbsp;After you have disabled the automatic display of dialogs, no Keychain Services function called by any application displays dialogs until someone calls the <code><a href="../../../Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainSetUserInteractionAllowed" target="_top">SecKeychainSetUserInteractionAllowed</a></code> function to reenable dialogs, or until the system is restarted. Therefore, if there might be other applications operating on the same computer, you should be careful to reenable this feature once you are finished opening or creating a keychain.</p><p></p></div>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../02concepts/concepts.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../iPhoneTasks/iPhoneTasks.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2003, 2009 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2009-03-12<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Security/Conceptual/keychainServConcepts/03tasks/tasks.html%3Fid%3DTP30000897-3.2&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Security/Conceptual/keychainServConcepts/03tasks/tasks.html%3Fid%3DTP30000897-3.2&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Security/Conceptual/keychainServConcepts/03tasks/tasks.html%3Fid%3DTP30000897-3.2&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>