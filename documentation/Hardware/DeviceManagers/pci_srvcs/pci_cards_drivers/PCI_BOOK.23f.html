<HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><script language="JavaScript" src="frametest.js"></script><TITLE> SIMs for Current Versions of Mac&nbsp;OS</TITLE></HEAD><BODY BGCOLOR="#ffffff"><DIV><a name="top"></a><!-- start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!-- start of path --><font face="Geneva,Helvetica,Arial" size="1"><b><br>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Documentation</a> &gt; <!-- a href="" target="_top" -->Hardware<!-- /a -->  <b>&gt; </b><a href="../../devicemgrs.html" target="_top">Device Managers and Drivers</a> <b>&gt; </b><a href="../pci_srvcs.html" target="_top">PCI Card Services</a> <b>&gt; </b>Designing PCI Cards and Drivers for Power Macintosh Computers</font><br><br><!-- end of path --><A HREF="PCI_BOOK.23d.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.23e.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.240.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><HR></DIV><H1 CLASS="H1.Heading1"><A NAME="pgfId=3310"> </A><A NAME="17094"> </A>SIMs for Current Versions of Mac&nbsp;OS</H1><P CLASS="T1.Text1"><A NAME="pgfId=3311"> </A>With current versions of Mac&nbsp;OS, you can write a native SIM by using the Mixed Mode Manager and passing universal procedure pointers to the transport (XPT) layer when registering the SIM. Native SIMs should also use <TT CLASS="cv">CallUniversalProc</TT> when calling XPT routines.</P><P CLASS="T1.Text1"><A NAME="pgfId=3312"> </A>PCI native SIMs are implemented similarly to other native drivers. The SIM installs a driver in the device tree with a <TT CLASS="cv">driver,AAPL,MacOS,PowerPC</TT> property. Like other native drivers, SIMs export a driver description structure. The SCSI expert identifies a SIM by examining the service categories supported in the driver descriptor. SIMs have a <TT CLASS="cv">serviceCategory</TT> of type <TT CLASS="cv">kServiceCategoryScsiSIM</TT>. A driver supporting this service category should export a function named <TT CLASS="cv">LoadSIM</TT> with the following interface:</P><CODE CLASS="RD.RoutineDeclare"><A NAME="pgfId=13588"> </A>OSErr LoadSIM (RegEntryIDPtr entry);</CODE><P CLASS="T1.Text1"><A NAME="pgfId=3314"> </A>The SCSIexpert  prepares the code fragment and calls this function after the SCSI transport layer is initialized. In response, the SIM should initialize itself the same way a NuBus SIM would by calling <TT CLASS="cv">SCSIRegisterBus</TT>, as described in <I CLASS="italics">Inside Macintosh: Devices.</I> Any nonzero result returned from <TT CLASS="cv">LoadSIM</TT> causes the code fragment to be unloaded. Note that this is a <TT CLASS="cv">ProcPtr</TT>-based interface, so you must pass <TT CLASS="cv">UniversalProcPtr</TT> structures for all entry points. Those passed back by the XPT will also be <TT CLASS="cv">UniversalProcPtr</TT> structures so native code should use <TT CLASS="cv">CallUniversalProc</TT> when calling XPT layer procedures from the <TT CLASS="cv">SIMInitRecord</TT>. </P><P CLASS="T1.Text1"><A NAME="pgfId=3318"> </A>An typical PCI-based SIM descriptor is shown in <A HREF="PCI_BOOK.23f.html#32485" CLASS="XRef">Listing&nbsp;15-1</A>.</P><P CLASS="L.Listing"><B><A NAME="pgfId=3320"> </A>Listing&nbsp;15-1	<A NAME="32485"> </A>SIM descriptor</B></P><CODE CLASS="Cv.Code"><A NAME="pgfId=13604"> </A>DriverDescription TheDriverDescription =<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;// signature information<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kTheDescriptionSignature,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kInitialDriverDescriptor,<BR>&nbsp;&nbsp;&nbsp;&nbsp;// type info<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\pFor Rent&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1,0,0,0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// major, minor, stage, rev<BR>&nbsp;&nbsp;&nbsp;&nbsp;// OS runtime info<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kDriverIsUnderExpertControl,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;\p.MySCSISIM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,0,0,0,0,0,0,0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// reserve 8 longs<BR>&nbsp;&nbsp;&nbsp;&nbsp;// OS service info<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// number of service categories<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kServiceCategoryScsiSIM,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1,0,0,0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// major, minor, stage, rev<BR>};</CODE><P CLASS="T1.Text1"><A NAME="pgfId=3322"> </A>For the Startup Disk control panel to be able to select a boot device from a SIM correctly, the <TT CLASS="cv">SCSIBusInquiry</TT> fields <TT CLASS="cv">scsiHBAslotNumber</TT> and <TT CLASS="cv">scsiSIMsRsrcID</TT> must uniquely identify the SIM from other SIMs and PCI cards. Each SIM should identify itself when registering with the system by placing a <TT CLASS="cv">RegEntryID</TT> value in the <TT CLASS="cv">SIMInitInfo</TT> parameter block. The XPT layer will calculate unique values for the <TT CLASS="cv">SCSIBusInquiry</TT> fields and supply them to the <TT CLASS="cv">SIMInit</TT> routine. From then on  the SIM must return these values from <TT CLASS="cv">SCSIBusInquiry</TT>. Three new fields--<TT CLASS="cv">simSlotNumber</TT>, <TT CLASS="cv">simSRsrcID</TT>, and <TT CLASS="cv">simRegEntry</TT>--have been defined in the <TT CLASS="cv">SIMInitInfo</TT> parameter block to hold these values. The new parameter block is defined as follows:</P><CODE CLASS="Cv.Code"><A NAME="pgfId=13599"> </A>&nbsp;&nbsp;&nbsp;&nbsp;UInt8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*SIMstaticPtr;<BR>&nbsp;&nbsp;&nbsp;&nbsp;long&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;staticSize;<BR>&nbsp;&nbsp;&nbsp;&nbsp;SIMInitUPP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SIMInit;<BR>&nbsp;&nbsp;&nbsp;&nbsp;SIMActionUPP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SIMAction;<BR>&nbsp;&nbsp;&nbsp;&nbsp;SCSIInterruptUPP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SIM_ISR;<BR>&nbsp;&nbsp;&nbsp;&nbsp;SCSIInterruptUPP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SIMInterruptPoll;<BR>&nbsp;&nbsp;&nbsp;&nbsp;SIMActionUPP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NewOldCall;<BR>&nbsp;&nbsp;&nbsp;&nbsp;UInt16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ioPBSize;<BR>&nbsp;&nbsp;&nbsp;&nbsp;Boolean&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;oldCallCapable;<BR>&nbsp;&nbsp;&nbsp;&nbsp;UInt8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;simInfoUnused1;<BR>&nbsp;&nbsp;&nbsp;&nbsp;long&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;simInternalUse;<BR>&nbsp;&nbsp;&nbsp;&nbsp;SCSIUPP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XPT_ISR;<BR>&nbsp;&nbsp;&nbsp;&nbsp;SCSIUPP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EnteringSIM;<BR>&nbsp;&nbsp;&nbsp;&nbsp;SCSIUPP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExitingSIM;<BR>&nbsp;&nbsp;&nbsp;&nbsp;SCSIMakeCallbackUPP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MakeCallback;<BR>&nbsp;&nbsp;&nbsp;&nbsp;UInt16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;busID;<BR>&nbsp;&nbsp;&nbsp;&nbsp;UInt8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;simSlotNumber;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// output<BR>&nbsp;&nbsp;&nbsp;&nbsp;UInt8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;simSRsrcID;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// output<BR>&nbsp;&nbsp;&nbsp;&nbsp;RegEntryIDPtr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;simRegEntry;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// input</CODE><HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 26 March 99)<P><A HREF="PCI_BOOK.23d.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.23e.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.240.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>