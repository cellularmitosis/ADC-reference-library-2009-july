<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-05-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TN1135: Dealing with PCI Expansion Chassis Problems</title>     <meta name="keywords" content="PowerPC PCI Card Expansion chassis compatibility KIsrIsNotComplete problems interrupt latency">    <meta name="Description" content="Technical Note TN1135: This Technical Note provides informationon compatibility issues between PCI cards and the expansionchassis they are plugged into. It also details techniquesfor coping with these compatibility issues."><meta name="categories" content="Hardware"><meta name="week-posted" content="Jul 27, 1998 - Aug 7, 1998"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002974" title="Dealing with PCI Expansion Chassis Problems"></a><A NAME="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/HardwareDrivers/index.html">Hardware & Drivers</a> &gt; <a href="../../technicalnotes/HardwareDrivers/idxPCIandPCCard-date.html">PCI and PC Card</a> &gt; </p><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1135</div>
<div id="pageheadsub">Dealing with PCI Expansion Chassis Problems</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><!-- begin_header_box --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><table width="600" cellpadding="0" cellspacing="0" border="0">     <tr><td width=300 valign="top" align=left scope="row">    <table border="0" width="300" cellpadding="0" cellspacing="0">        <tr>    <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>        </tr>        <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left>       <span id="menutitle">  CONTENTS  <br>  <br>       </span>   </td>        </tr>        <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left>       <!-- begin_toc -->       <p id="menutext"><A HREF = "#Intro">Defining the Problem</A><BR><BR><A HREF = "#Section2">Problem Scenario</A><BR><BR><A HREF = "#Section3">Why This Hasn't Been a Problem Before</A><BR><BR><A HREF = "#Section4">Coping with Expansion Chassis Issues</A><BR><BR><A HREF = "#Section5">Additional Notes &amp; Comments</A><BR><BR><A HREF = "#Summary">Summary</A><BR><BR><A HREF = "#References">References</A><BR><BR><A HREF = "#Downloads">Downloadables</A></p><!-- end_toc --></td>        </tr>        <tr>   <td width=300 align=left scope="row">       <img src="images/tnmenubottom.gif" alt="" width=300 height=16>   </td>        </tr>    </table></td><td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">When designing PCI cards, it's easy to overlook the fact that the card may be plugged into an expansion chassis. Therefore, it is possible for compatibility issues to arise if you do not allow for certain conditions. This note provides information on many of these conditions, and explains how you might avoid some problems.</P><P id = "introtext">A PCI expansion chassis can present several problems to the PCI card designer.  Variations of interrupt latency, propagation delays, intercard compatibility, and other problems can be introduced by the sub-bridge architecture inherent to this design.</P><P id = "introtext">This note is directed at developers of PCI cards so that they will understand the compatibility issues that might arise if their product is used in a PCI expansion chassis.  There are both hardware and software issues that need to be considered.</p><!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Aug 17 1998]</h3><!-- end_date -->                </TD>             </TR>          </TABLE> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR>          <!-- begin_content --><a name="Intro"></a><H2>Defining the Problem</H2><P>You may experience system crashes and/or the inability to access memory or I/O space on PCI cards that are plugged into a PCI expansion chassis. The same cards may work fine plugged into a direct PCI host slot.</P> <BR><A NAME="Section2"></A><H2>Problem Scenario</H2><P>The following lists possible causes for PCI expansion chassis problems:</P><UL>    <LI>Interrupt hardware sharing: all interrupts funnel into a single hardware interrupt line for an entire PCI expansion chassis;</li>    <LI>Multiple vendors producing simultaneous interrupts;</li>    <LI>Multiple interrupts from single multifunction cards;</li>    <LI>Initialization problems; or</li>    <LI>Interrupt propagation delays.</li></UL><BR><P><A HREF="#top">Back to top</A></P><A NAME="Section3"></A><H2>Why This Hasn't Been a Problem Before</H2><P>Previously, Apple manufactured 6-slot systems (i.e., 95xx/96xx Macs); thus, the need for an external expansion chassis was diminished because 6 slots were already available for PCI expansion in the host system. The Power Macintosh G3 provides only 3 slots; therefore, some applications have migrated to using PCI expansion chassis to contain the hardware configuration.</P><BR><P><A HREF="#top">Back to top</A></P><A NAME="Section4"></A><H2>Coping with Expansion Chassis Issues</H2><P>It's not always easy to resolve problems associated with a PCI expansion chassis, and a limited number of developers have need of such an implementation. Although cards plugged into the expansion chassis should, in theory, experience only minimal effect on overall transaction timing, the reality is that there are subtle design issues introduced by the architecture itself that must be addressed.</p><img src="images/tn1135_001.gif" align=top alt="Expansion Chassis" width=477 height=440><P>First, additional propagation delay for the sub-bridge levels is introduced by the expansion chassis.  A typical implementation is two sub-bridge levels deep, requiring extra PCI clock cycles for each level.  Further delays are experienced if the cards themselves possess additional PCI sub-bridges. These delays are a combination of posting operations and actual propagation delays introduced by the hardware itself.</p><P>When cards are plugged into a host expansion slot, hardware exists in the host that provides information about which device slot is interrupting. On the other hand, all interrupts from an expansion chassis are funneled into a single interrupt slot line.  This concept is known as "interrupt sharing."  With interrupt sharing, the driver needs to ensure it does not depend solely on the hardware slot indicator for interrupt association. Instead, a well-behaved driver should follow the rules set forth in Designing Cards and Drivers for Power Macintosh Computers:</p><UL><LI>Poll its own hardware to determine whether it is to provide service or not.</li><LI>If it is not to provide service, quickly return with <CODE>KIsrIsNotComplete</CODE>.</li><LI>If it is, service the routine then return with <CODE>KIsrIsComplete</CODE>.</li></UL><P>Interrupts should, of course, only be enabled when the card's hardware is ready to be serviced. The expansion chassis will likely have more than one developer's card inserted; thus, if the driver enables interrupts prematurely, and another interrupt is already pending from a neighboring slot, the driver could end up attempting to service the wrong interrupt. Again, following the rules will prevent this. The Power Macintosh does not employ a vectored-interrupt architecture: the interrupt source tree must be traversed for each pending interrupt.  This has the advantage of abstracting the interrupt handler from the hardware source, but makes it extremely important to return control immediately if your handler is not the intended service routine in order to minimize interrupt response time.</p><P>Extra time should be allowed for the hardware to properly reset interrupt flags that have been asserted, because latencies could make the interrupt look as though it is still asserted for a brief time. This is due to the accumulative full-turn delays of propagating down to the source hardware itself, then back to the host motherboard. The condition may cause the handler to be re-invoked after returning to its caller; however, when the handler regains control, the hardware interrupt has been cleared and the handler will return a <CODE>KIsrIsNotComplete</CODE> status.  This ultimately will cause a spurious interrupt because no proper handler will not be found. The complication in all this is that it is not easy to tell when a device is plugged into a local bus versus an expansion chassis (and sharing interrupts). The device tree could be analyzed to make such a determination, although a good general practice for a handler might be to clear the interrupt before attempting to read the hardware back to ensure it has actually been cleared prior to returning to the caller.</p><P>Attempting to make a hypothetical determination as to which cards will work together and in what slot order is extremely difficult due to potential card interaction.  This is due in part to loading characteristics and probing order as the cards are initialized.  The bottom line is that any given configuration should be empirically tested to see if any problems arise. If problems are encountered, try switching the order of the cards in the slots. At the time of this writing, no known expansion chassis problems are being encountered in <CODE>OpenFirmware</CODE>, as opposed to the more rigorous thrashing that the cards receive once the system is booted.  This could be because of relative slow access rates of <CODE>OpenFirmware</CODE>. More importantly, this emphasizes that these problems tend to be dynamic-speed related.</p><P>Lastly, spurious interrupts are symptomatic of the problems associated with expansion chassis operation, so be on the lookout for them as an indication of a potential interrupt timing problem.</P><BR><P><A HREF="#top">Back to top</A></P><A NAME="Section5"></A><H2>Additional Notes &amp; Comments</H2><P>The following are some important items that you may need to consider whenworking through the problem of using a PCI expansion chassis:</P><UL> <LI> The ordering of cards in the slots could affect operation;</li><LI> Verify interrupt hardware is properly reset in spite of any delays encountered;</li><LI> Interrupt sharing issues; i.e., dependence upon the slot-interrupt hardware as the sole means of determining handler validity;</li><LI> Ensure the hardware is ready to produce interrupts prior to enabling; and</li><LI> Sub-bridge delays may affect intercard operation and interrupt sharing.</li></UL><BR><P><A HREF="#top">Back to top</A></P><A NAME="Summary"></A><H2>Summary</H2><P>Problems introduced by PCI expansion hardware can be difficult to solve, because the issues involved were generally not a concern prior to the absence of 6-slot systems. Many of the problems can be avoided, however, by strict adherence to the ordering rules laid out in the PCI specification, and re-thinking the methods used in single-card-per-slot implementations.</P><BR><P><A HREF="#top">Back to top</A></P><a name="References"></a><H2>References</H2><P><A HREF = "http://www.pcisig.com"> PCI Local Bus Specification, revision 2.1</A></p><p> <A HREF = "ftp://ftp.apple.com/devworld/Development_Kits/PCI_Driver_SDK.sit.hqx"> Designing PCI Cards and Drivers for Power Macintosh Computers </A></p><p><A HREF = "tn1104.html"> Technote 1104: Interrupt-Safe Routines</A></p><p><A HREF = "tn1001.html"> Technote 1001: On Power Macintosh Interrupt Management</A></p><BR><P><A HREF="#top">Back to top</A></P>        <A NAME="Downloads"></A>         <h2>Downloadables</h2>        <center><TABLE BORDER=0 CELLPADDING=3 WIDTH="600">         <TR>             <td width=50 align=left>               <P ALIGN=center><img src="images/acrobatsmall.gif" align=middle alt="Acrobat" width=22 height=23></P>            </TD>            <td align="left">               <p>Acrobat version of this Note (164K).</P>            </TD>            <td width=60 align=left>               <p><A HREF="pdf/tn1135.pdf">Download</A></P>            </TD>          </TR>              </table></center><BR><BR><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1135.html%3Fid%3DDTS10002974-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1135.html%3Fid%3DDTS10002974-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1135.html%3Fid%3DDTS10002974-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>