<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Preparing a Closure</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING20></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="RTArch-19.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="RTArch-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="RTArch-147.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="RTArch-21.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="RTArch-2.html"><B>Mac OS Runtime Architectures</B></A> / <BR><DD><A HREF="RTArch-14.html"><B>Chapter 1 - CFM-Based Runtime Architecture</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING20-0></A>
<H1>Preparing a Closure</H1>
 <A NAME=MARKER-2-52></A>When the Code Fragment Manager is called to prepare a fragment, it prepares the closure associated with the fragment to ensure that the fragment can access all its imported symbols during execution. This preparation process involves the following steps:<P>
<OL>
<LI>Determine the closure associated with the root fragment (an application or a plug-in, for example). The Code Fragment Manager does the following to determine the closure: <P>
<UL>
<LI>Finds compatible versions of all the import libraries the root fragment requires. Note that some import libraries may themselves depend on other import libraries. 
<LI>Brings into memory any fragments that do not currently have connections to them. 
<LI>Assigns connection IDs to any new connections and assigns a closure ID to the new closure.<P>
See <A HREF=RTArch-21.html#MARKER-9-55>"Searching for Import Libraries," beginning on page 1-16</A>, for information about the library search procedure and <A HREF=RTArch-22.html#MARKER-9-58>"Checking for Compatible Import Libraries," beginning on page 1-19</A>, for information about how the Code Fragment Manager checks version compatibility.<P>
</UL>
<LI>Instantiate (or locate, if already present) code and data sections for each connection in the closure. This procedure assigns actual addresses to the sections and, consequently, assigns addresses to all exported symbols. 
<LI>Resolve all imported symbols. For every imported symbol required by the new connections in the closure, the Code Fragment Manager finds the corresponding exported symbol address and stores it in an internal lookup table.
<LI>Do relocations. Using the lookup table compiled in step 3 and the section addresses determined in step 2, the Code Fragment Manager replaces all references to imported symbols (and any other pointer-based symbol references) in the closure with actual addresses. See <A HREF=RTArch-27.html#MARKER-9-19>Chapter 2, "Indirect Addressing in the CFM-Based Architecture,"</A> and the section <A HREF=RTArch-98.html#MARKER-9-75>"Relocations," beginning on page 8-21</A>, for more details. 
<LI>Execute initialization functions (if any exist). 
<LI>Return the closure ID and main symbol to the caller. <P>
</OL>
<DL>
<DT><B>IMPORTANT</B>
<DD>These steps apply for any fragment the Code Fragment Manager is called to prepare (including plug-ins ).<EM></EM><EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 <A NAME=MARKER-2-53></A>In general, if the Code Fragment Manager cannot complete any step, then the preparation fails and an error is returned. The only special case is when certain libraries or symbols have been declared weak. A weak library or symbol is one that is marked as being optional; the preparation process can continue even if the library or symbol is not available. However, once a weak library or symbol is determined to be present, it is handled normally for the rest of the preparation process. For example, if a weak library is available but cannot be prepared properly for some reason, the whole closure preparation fails. See <A HREF=RTArch-43.html#MARKER-9-41>"Weak Libraries and Symbols," beginning on page 3-11</A>, for more information.<P>
<DL>
<DT><B>Note</B>
<DD>A weak library is determined to be present or not present in step 1 of the preparation process. Weak symbols are determined in step 3.<EM></EM><A NAME=MARKER-2-54></A>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
<HR>
<B>Subtopics</B>
<B><!-- TOC --><DL>
<DL>
<DT><A HREF="RTArch-21.html#HEADING21-0">Searching for Import Libraries</A>
<DD>
<DT><A HREF="RTArch-22.html#HEADING22-0">Checking for Compatible Import Libraries </A>
<DD>
</DL>
</DL>
</B>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="RTArch-19.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="RTArch-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="RTArch-147.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="RTArch-21.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="RTArch-3.html">&copy; Apple Computer, Inc.</A><br>11 MARCH 1997<P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML> 
