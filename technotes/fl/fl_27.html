<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-August-01 --><!-- Includes revisions to graphics tags --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note FL27: Mixing HFS and C File I/O</title><meta name="keywords" content="Mac OS 8 HFS C file I/O mixing fopen FSOpen"><meta name="Description" content="Technical Note FL27: This Technical Note discusses the problemof mixing calls to the Macintosh file system with calls toMPW C library file I/O routines. Although this technote stronglywarns against mixing HFS and C file I/O, an example routine,which shows how to use fopen() with standard file, is provided.">                                       <meta name="categories" content="Files"><meta name="week-posted" content="Jul 31, 1989 - Aug 4, 1989"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002453" title="Mixing HFS and C File I/O"></a><A NAME="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p> A primary category has yet to be selected for this document. </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/index.html" target="_blank">Reference Library</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note FL27</div>
<div id="pageheadsub">Mixing HFS and C File I/O</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext">					<A HREF="#Section1">Problems with Communication Between HFS and C</A><BR><BR> <A HREF="#Section2">You Were Warned</A><BR><BR>   					<A HREF="#References">References</A><BR><BR>   <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><p id = "introtext">This Technical Note discusses the problem of mixing calls to the Macintosh filesystem with calls to MPW C library file I/O routines.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Aug 01 1989]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR><!-- begin_content --><a name="Section1"></a><h2>Problems with Communication Between HFS and C</h2><p>Frequently, developers want to use both Macintosh file I/O and C file I/O.Developers who do this must keep in mind that they are combining two distinctfile representations (the Macintosh and ANSI C).  The only limitation on mixingHFS and C I/O functions is that they cannot be mixed on the same open file.There are three reasons why this cannot be done.</p><p>First, there is no routine that maps between a C <code>FILE</code> struct (returnedby <code>fopen()</code>) to an HFS <code>fRefNum</code> (needed to call HFS functions).Similarly, there is no call to create a <code>FILE</code> struct given an <code>fRefNum</code>returned by <code>FSOpen()</code>.  Thus, there is no way that the information from an <code>fopen()</code> call could be used to do a <code>fsread()</code>.</p><p>Second, even if the first problem were solved, the C libraries eventually callthe HFS file system, but keep some internal state information.  So, if you callHFS directly (say, <code>SetFPos()</code>), the C file system has no way of knowinga call was made and, therefore, doesn't update its state information.</p><p>Similarly, there is no mechanism for synchronizing the C library's buffers.For example, you perform an <code>fwrite() </code>with some number of characterswhich get put into a buffer without flushing it.  Then you perform an<code>FSWrite()</code> with something else.  Neither the C library nor HFS areaware that the other has written to the file.</p><p>Simply put, you cannot make HFS calls on a file opened with <code>fopen()</code> or<code>fdopen()</code>; you cannot use C library I/O on a file opened under HFS.However, here are some points to consider when manipulating the same file usingboth C and HFS.  Keep in mind this isn't frequently done; there may be problemsof which we are unaware.</p><p>One obvious problem is keeping track of the working directory.  Be sure to saveand restore the current working directory when moving between HFS and C I/O calls.</p><p>Following is an example routine, which mixes HFS and C I/O.  Notice that itdoesn't really solve the problem of mixing the two file systems, but rather itshows how to use <code>fopen()</code> with standard file (working directories ordirectory IDs) in general.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>HardRockCocoJoe(){    Point            where;    char            *prompt = &quot;\pWe Are Here&quot;;    char            *fname = &quot;\pHardRockCocoJoe&quot;;    FileFilterProcPtr    fileFilter = NULL;    short            numTypes = 1;    SFTypeList        typeList;    DlgHookProcPtr    dlgHook = NULL;    SFReply        reply;    OSErr            result;    FILE            *TheFile;    short            fileNum;    long            numofChars = 10;    short            currentVRefNum;    (void) GetVol(NULL, &amp;currentVRefNum);    result = FSOpen(fname, currentVRefNum, &amp;fileNum);    if (result != 0) {        /* error checking */    }    else {        result = FSWrite(fileNum, &amp;numofChars, &quot;from MacIO&quot;);        if (result != 0) {            /* error checking */        }    }    (void) FSClose(fileNum);    where.h = 80;    where.v = 90;    typeList[0] = 'TEXT';    SFGetFile (where, prompt, fileFilter, numTypes, typeList, dlgHook, &amp;reply);    result = SetVol(reply.fName, reply.vRefNum /* from sfgetfile */);    if (result != 0){        /* error check */    }    p2cstr(reply.fName);    TheFile = fopen (reply.fName, &quot;a+&quot;);    fprintf (TheFile, &quot;\nfromC\n&quot;);    fclose (TheFile);    result = SetVol(NULL, currentVRefNum);    if (result != 0){        /* error check */    }    result = FSOpen(fname, currentVRefNum, &amp;fileNum);    if (result != 0){        /* error check */    }    else {        numofChars = 12;        SetFPos(fileNum, fsFromLEOF, 0);        result = FSWrite (fileNum, &amp;numofChars, &quot;from MacIO 2&quot;);        if (result != 0) {            /* error check */        }    }}</pre>	</TD></TR></TABLE></CENTER><p>Assuming the user chooses HardRockCocoJoe from the Standard File dialog box,the result of this routine is a file called HardRockCocoJoe, which contains thefollowing data:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>from MacIOfromCfrom MacIO 2</pre>	</TD></TR></TABLE></CENTER><p>By keeping track of the working directory, you can work with HFS file I/O and CI/O.  Of course, if you are working with many files, it could be a problem keeping track of the correct <code>paramBlock</code> and expensive to open and close the fileseach time you switch.</p><p>Another approach would be to construct a pathname from the Macintosh file system that could be passed to the C I/O functions.  Technical Note #238, <u><A HREF = "fl_04.html">Getting a Full Pathname</a></u>, goes into complete detail as to how this is done using either a working directory or <code>vRefNum</code> and <code>DirID</code>.  But, this solution hasserious drawbacks and is not recommended.  One problem is that you have to manually create the pathname as a string and stuff the needed folderseparators into that string.  The current separator, the colon (:), may change in the future.  A bigger problem is the length of the pathname.  Currently, it can only be 256 characters, and that maybe hard for you to guarantee.  Lastly, there could be a problem if the user should change the directory or rename a file.</p><P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>You Were Warned</h2><p>Be aware that you are responsible for any file problems you may have mixing HFSand C file I/O.  If it  can be avoided, by all means, avoid it.</p><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><p><i>Inside Macintosh</i>, Volume I, The Standard File Package</p><p><i>Inside Macintosh</i>, Volume IV, The File Manager</p><p>Technical Note M.FL.FullPathName - <u><A HREF = "fl_04.html">Getting a Full Pathname</a></u></p><P><A HREF="#top">Back to top</A></P><P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (48K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/fl_27.pdf">Download</A></P>               </TD>            </TR></table><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/fl/fl_27.html%3Fid%3DDTS10002453-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/fl/fl_27.html%3Fid%3DDTS10002453-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/fl/fl_27.html%3Fid%3DDTS10002453-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --><hr width=500 align=center></BODY></HTML>