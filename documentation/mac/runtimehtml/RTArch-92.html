<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>PEF Sections</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING92></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="RTArch-91.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="RTArch-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="RTArch-147.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="RTArch-93.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="RTArch-2.html"><B>Mac OS Runtime Architectures</B></A> / <BR><DD><A HREF="RTArch-89.html"><B>Chapter 8 - PEF Structure</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING92-0></A>
<H1>PEF Sections</H1>
 <A NAME=MARKER-2-40></A>A PEF container can contain any number of sections. A section usually contains code or data. A special case is the loader section, which is discussed separately in <A HREF=RTArch-95.html#MARKER-9-56>"The Loader Section" (page 8-15)</A>. For each section there is a header, which includes information such as the type of section, its presumed runtime address, its size, and so on, and a corresponding section contents area. <P>
 <A NAME=MARKER-2-41></A>Sections are numbered from 0, based on the position of their header, and the sections are identified by these numbers. However, the corresponding section contents do not have to be in the same order as the section headers. The only requirement is that instantiated section headers (that is, headers for sections containing code or data) must precede noninstantiated ones in the section header array. <P>
 The section header data structure is of fixed size (28 bytes) and has the form shown in <A HREF=#MARKER-9-42>Listing 8-2</A>.<P>
<B>Listing 8-2  <A NAME=MARKER-9-42></A>Section header data structure</B><P>
<PRE>
struct PEFSectionHeader {
   SInt32nameOffset;  
   UInt32defaultAddress; 
   UInt32totalSize;   
   UInt32unpackedSize; 
   UInt32packedSize;  
   UInt32containerOffset; 
   UInt8 sectionKind; 
   UInt8 shareKind;   
   UInt8 alignment;   
   UInt8 reservedA;   
};
</PRE>
 The fields in the section header are as follows:<P>
<UL>
<LI>The <CODE>nameOffset</CODE> field (4 bytes) holds the offset from the start of the section name table to the location of the section name. The name of the section is stored as a C-style null-terminated character string. <P>
If the section has no name, the <CODE>nameOffset</CODE> field contains <CODE>-1</CODE>.
<LI>The <CODE>defaultAddress</CODE> field (4 bytes) indicates the preferred address (as designated by the linker) at which to place the section's instance. If the Code Fragment Manager can place the instance in the preferred memory location, the load-time and link-time addresses are identical and no internal relocations need to be performed. 
<LI>The <CODE>totalSize</CODE> field (4 bytes) indicates the size, in bytes, required by the section's contents at execution time. For a code section, this size is merely the size of the executable code. For a data section, this size indicates the sum of the size of the initialized data plus the size of any zero-initialized data. Zero-initialized data appears at the end of a section's contents and its length is exactly the difference of the <CODE>totalSize</CODE> and <CODE>unpackedSize</CODE> values. <P>
For noninstantiated sections, this field is ignored. 
<LI>The <CODE>unpackedSize</CODE> (4 bytes) is the size of the section's contents that is explicitly initialized from the container.  For code sections, this field is the size of the executable code. For an unpacked data section, this field indicates only the size of the initialized data. For packed data this is the size to which the compressed contents expand.  The <CODE>unpackedSize</CODE> value also defines the boundary between the explicitly initialized portion and the zero-initialized portion.<P>
For noninstantiated sections, this field is ignored. 
<LI>The <CODE>packedSize</CODE> field (4 bytes) indicates the size, in bytes, of a section's contents in the container. For code sections, this field is the size of the executable code. For an unpacked data section, this field indicates only the size of the initialized data. For a packed data section (see <A HREF=#MARKER-9-1>Table 8-1 (page 8-8)</A>) this field is the size of the pattern description contained in the section. 
<LI>The <CODE>containerOffset</CODE> field (4 bytes) contains the offset from the beginning of the container to the start of the section's contents. Packed data sections and the loader section should be 4-byte aligned. Code sections and data sections that are not packed should be at least 16-byte aligned. 
<LI>The <CODE>sectionKind</CODE> field (1 byte) indicates the type of section as well as any special attributes. <A HREF=#MARKER-9-1>Table 8-1 (page 8-8)</A> shows the currently supported section types. Note that instantiated read-only sections cannot have zero-initialized extensions. 
<LI>The <CODE>shareKind</CODE> field (1 byte) controls how the section information is shared among processes by the Code Fragment Manager. You can specify any of the sharing options shown in <A HREF=#MARKER-9-5>Table 8-2 (page 8-9)</A>. 
<LI>The <CODE>alignment</CODE> field (1 byte) indicates the desired alignment for instantiated sections in memory as a power of 2. A value of <CODE>0</CODE> indicates 1-byte alignment, <CODE>1</CODE> indicates 2-byte (halfword) alignment, <CODE>2</CODE> indicates 4-byte (word) alignment, and so on. Note that this field does not indicate the alignment of raw data relative to a container. The Code Fragment Manager does not support this field under System 7.<P>
In System 7, the Code Fragment Manager gives 16-byte alignment to all writable sections. The alignment of read-only sections, which are used directly from the container, is dependent on the alignment of the section's contents within the container and the overall alignment of the container itself.  When the container is not file-mapped, the overall container alignment is 16 bytes.  When the container is file-mapped, the entire data fork is mapped and aligned to a 4KB boundary.  The overall alignment of a file-mapped container thus depends on the container's alignment within the data fork.  Note that file-mapping is currently supported only on PowerPC machines, and only when virtual memory is enabled.
<LI>The <CODE>reservedA</CODE> field (1 byte) is currently reserved and must be set to <CODE>0</CODE>.<P>
</UL>
 <A HREF=#MARKER-9-1>Table 8-1</A> shows the various types of sections that can appear in PEF containers and the corresponding value in the <CODE>sectionKind</CODE> field.
<TABLE BORDER="0" CELLPADDING=3>
<CAPTION><A NAME=MARKER-9-1></A><B>Table 8-1 Section types</B><A NAME=MARKER-2-2></A> </CAPTION>
<TH>Value<TH>Type<TH>Instantiated?<TH>Description<TR>
<TD><CODE>0</CODE><TD>Code<TD>Yes<TD>Contains read-only executable code in an uncompressed binary format. A container can have any number of code sections. <P>Code sections are always shared.<TR>
<TD><CODE>1</CODE><TD>Unpacked data<TD>Yes<TD>Contains uncompressed, initialized, read/write data followed by zero-initialized read/write data. <P>A container can have any number of data sections, each with a different sharing option. <TR>
<TD><CODE>2</CODE><TD>Pattern- initialized data<TD>Yes<TD><A NAME=MARKER-2-3></A>Contains read/write data initialized by a pattern specification contained in the section's contents. The contents essentially contain a small program that tells the Code Fragment Manager how to initialize the raw data in memory. <P>A container can have any number of pattern-initialized data sections, each with its own sharing option.<P>See <A HREF=RTArch-94.html#MARKER-9-46>"Pattern-Initialized Data" (page 8-10)</A> for more information about creating pattern specifications. <TR>
<TD><CODE>3</CODE><TD>Constant<TD>Yes<TD>Contains uncompressed, initialized, read-only data. <P>A container can have any number of constant sections, and they are implicitly shared.<TR>
<TD colspan=4>&nbsp;<TR>
<TD><CODE>4</CODE><TD>Loader<TD>No<TD>Contains information about imports, exports, and entry points. See <A HREF=RTArch-95.html#MARKER-9-56>"The Loader Section" (page 8-15)</A> for more details. <P>A container can have only one loader section. <TR>
<TD><CODE>5</CODE><TD>Debug<TD>N/A<TD>Reserved for future use. <TR>
<TD><CODE>6</CODE><TD>Executable<BR>data<TD>Yes<TD>Contains information that is both executable and modifiable. For example, this section can store code that contains embedded data. <P>A container can have any number of executable data sections, each with a different sharing option. <TR>
<TD><CODE>7</CODE><TD>Exception<TD>N/A<TD>Reserved for future use.<TR>
<TD><CODE>8</CODE><TD>Traceback<TD>N/A<TD>Reserved for future use.<A NAME=MARKER-2-4></A></TABLE>
<P>
 <A HREF=#MARKER-9-5>Table 8-2</A> shows the sharing options available for PEF sections and the corresponding value in the <CODE>shareKind</CODE> field.
<TABLE BORDER="0" CELLPADDING=3>
<CAPTION><A NAME=MARKER-9-5></A><B>Table 8-2 Sharing options</B></CAPTION>
<TH>Type<TH>Value<TH>Description<TR>
<TD>Process share<TD><CODE>1</CODE><TD>Indicates that the section is shared within a process, but a fresh copy is created for different processes.<TR>
<TD>Global share<TD><CODE>4</CODE><TD>Indicates that the section is shared between all processes in the system.<TR>
<TD>Protected share<TD><CODE>5</CODE><TD>Indicates that the section is shared between all processes, but is protected. Protected sections are read/write in privileged mode and read-only in user mode.<P>This option is not available in System 7.<A NAME=MARKER-2-6></A></TABLE>
<P>
<HR>
<B>Subtopics</B>
<B><!-- TOC --><DL>
<DL>
<DT><A HREF="RTArch-93.html#HEADING93-0">The Section Name Table</A>
<DD>
<DT><A HREF="RTArch-94.html#HEADING94-0">Section Contents </A>
<DD>
</DL>
</DL>
</B>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="RTArch-91.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="RTArch-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="RTArch-147.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="RTArch-93.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="RTArch-3.html">&copy; Apple Computer, Inc.</A><br>11 MARCH 1997<P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML> 
