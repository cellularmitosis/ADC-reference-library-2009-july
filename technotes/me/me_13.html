<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"            "http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note ME13: Memory Manager Compatibility</title><meta name="keywords" content="Macintosh OS 8 PowerPc native Memory Manager MoveHHi compatibility"><meta name="Description" content="Technical Note ME13: This Technical Note details some ofthe things a developer should never do when using the MemoryManager which was rewritten to run on PowerPC Macintosh computers.No-nos include: Disposing of blocks twice, using fake handlesor pointers, Memory Manager Calls at Interrupt time, etc.">                                       <meta name="categories" content="Memory"><meta name="week-posted" content="May 31, 1993 - Jun 4, 1993"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"><a name="//apple_ref/doc/uid/DTS10002538" title="Memory Manager Compatibility"></a><a name="top"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxCarbon-date.html">Carbon</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Carbon/index.html" target="_blank">Reference Library > Carbon</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note ME13</div>
<div id="pageheadsub">Memory Manager Compatibility</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Section1">Introduction</a><BR><BR> <A HREF="#Section2">Things Not to Do</a><BR><BR> <A HREF="#Section3">New Rules to Live By</a><BR><BR> <A HREF="#Section4">Things It's Still OK to Do</a><BR><BR> <A HREF="#Section5">Conclusion</a><BR><BR>  <A HREF="#References">References</A><BR><BR> <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">The Memory Manager has been rewritten for the PowerPC Macintosh computers. Thisnew Memory Manager runs native PowerPC code and uses better algorithms. Withthis new Memory Manager, there are both old and new restrictions on it use.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Jan 01 1991]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><a name="Section1"></a><h2>Introduction</h2><p>The Memory Manager has been rewritten for Apple's PowerPC Macintosh computers. The new Memory Manager uses native PowerPC code and better algorithms for faster performance. It is also not as forgiving to ruthless programmers who break the rules defined in <i>Inside Macintosh</i> and Macintosh Technical Notes.</p><p>First a conceptual clarification. The Memory Manager as documented in InsideMacintosh is a storage allocator. It organizes memory into "heaps" or "heapzones." Its architecture was not designed to support address space mapping,protection, or interrupt time allocation.</p><p>The new Memory Manager uses the existing API that is documented in <i>InsideMacintosh.</i> If you code to the Macintosh API, you will inherit benefits ofthe new high-performance Memory Manager.</p><P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>Things Not to Do</h2><p>Here is a list of no-nos that may have appeared to work in the old Memory Manager, but may not with the new Memory Manager.</p><h3>Don't Dispose Blocks Twice</h3><p>Never dispose of a memory block twice, and don't attempt to operate on adisposed memory block. Although many traps return <code>memWZErr</code> (block isfree), it was never a reliable feature and it will be less reliable in thefuture. When a client disposes of a memory block, the Memory Managerimmediately takes control of its data. This is true for both relocatable andnonrelocatable blocks.</p><p>There are many subtle ways that a memory block can be disposed of twice.Consider the following example. Joe Ruthless Programmer calls <code>GetPicture</code> to display a picture. When he is done he calls <code>KillPicture</code> to get rid of it. However, since Joe did not read <i>Inside Macintosh </i>carefully, the '<code>PICT</code>' resource is still left in the resource map. When the application quits, the System calls <code>CloseResFile</code> on the file, which in turn disposes of the resource (again). Pow! You have a handle that was disposed of twice.</p><h3>Stay Out of Free Blocks</h3><p>Do not modify data that exists in a free block, and don't attempt to read data or execute code out of a disposed memory block.</p><h3>Don't Use Fake Handles or Fake Pointers</h3><p>Call Memory Manager routines only on memory blocks that were created by theMemory Manager. Any call that operates on a pointer block must operate on apointer block created by the Memory Manager. Do not call <code>DisposePtr</code> ondata that is on your stack or in your global space. Similarly, any call thattakes a handle as a parameter must be a valid handle that was recreated by theMemory Manager. Do not manually create a pointer to a pointer and pass it tothe Memory Manager as a handle. It will fail catastrophically--or worse, itwill fail subtly.</p><h3>Don't Make Calls at Interrupt Time</h3><p>Since all calls either move memory or set low memory global variables (except<code>BlockMove</code>), don't even think of calling them at interrupt time orasychronously. In particular, do not call <code>StackSpace</code> at interrupttime. The Memory Manager is not an interrupt time storage allocator. Don't useit as such. Doing so will cause many subtle bugs that are difficult to track down.</p><h3>Don't Touch the Data Structures</h3><p>Do not access or modify Memory Manager data structures directly. This includesrelocatable and nonrelocatable block headers, the heap header, and unusedmaster pointers. If there is an API available, use it. For example, there is anAPI for locking and unlocking a handle. If you don't use it, you will break inthe future. Similarly, don't touch low memory global variables that aremaintained by the Memory Manager. Use <code>SetApplLimit</code> and <code>SetGrowZone</code>.</p><h3>Keep Your Caches Coherent</h3><p>Be careful with processors that have dual instruction and data caches, such asthe Motorola 68040. Since many clients manipulate code as data, the old MemoryManager flushes caches frequently for compatibility. The new Memory Managerflushes caches only when it moves blocks around. When in doubt, call<code>FlushInstructionCache</code> just to make sure.</p><P><A HREF="#top">Back to top</A></P><a name="Section3"></a><h2>New Rules to Live By</h2><p>The new Memory Manager uses larger size block headers and a larger zone header.Clients must leave some slop space for future versions of the Memory Manager.When calculating how large to make a heap, use the following sizes:</p><p>Overhead for heap header and trailer 256 bytes</p><p>Overhead for each Memory Manager block 32 bytes</p><h3>Don't Assume Any Stack/Heap Relationships</h3><p>Don't assume that memory blocks cannot be above your stack. In the future, yourstack may be some other place than it is now. However, do call<code>SetApplLimit</code> followed by <code>MaxApplZone</code> as early as possible inyour program to extend your heap to its maximum size.</p><h3>Create Dynamic Heaps Inside Other Memory Manager Memory Blocks</h3><p>To create subheaps, allocate a Memory Manager block and call <code>InitZone</code>on the beginning of it. When you are done with the subheap, call the Memory Manager to dispose of the block that contains the heap. Do not create heaps on the stack.</p><P><A HREF="#top">Back to top</A></P><a name="Section4"></a><h2>Things It's Still OK to Do</h2><h3>Use MoveHHi</h3><p>It is recommended that you call <code>MoveHHi</code> to prevent fragmentation ofyour heap. For handles created in the system heap you should still call<code>MoveHHi</code>, even though this call does nothing today.</p><h3>Use Existing Tools to Your Advantage</h3><p>Most popular debuggers for the Macintosh have a heap scramble feature. Use itto debug your code. This feature will ensure that subtle bugs are caught beforeshipping products to your customers. Similarly, use Zap Handles, Even BetterBus Error, and Double Trouble to ensure compatibility in the future. Althoughthese utilities might not work with the new Memory Manager, you can test withthem today using the old one.</p><P><A HREF="#top">Back to top</A></P><a name="Section5"></a><h2>Conclusion</h2><p>With the new high-performance Memory Manager, your applications will runfaster. However, you need to follow the rules to be compatible in the future.</p><a name="References"></a><h2>References</h2><p><i>Inside Macintosh: Memory</i></p><p>Macintosh Technical Note: <u><A HREF = "../ov/ov_04.html">"OV 04 - Compatibility Why and How"</a></u></p><p>Macintosh Technical Note: <u><A HREF = "../ov/ov_11.html">"OV 11 - The Joy of Being 32-Bit Clean"</a></u></p><p>Macintosh Technical Note: <u><A HREF = "../hw/hw_06.html">"HW 06 - Cache as Cache Can"</a></u></p> <P><A HREF="#top">Back to top</A></P>                           <P><A NAME=Downloads></A></P>                  <h2>Downloadables</h2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (42K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/me_13.pdf">Download</A></P>               </TD>            </TR>                     </TABLE>         <BR>                  <P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/me/me_13.html%3Fid%3DDTS10002538-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/me/me_13.html%3Fid%3DDTS10002538-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/me/me_13.html%3Fid%3DDTS10002538-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>