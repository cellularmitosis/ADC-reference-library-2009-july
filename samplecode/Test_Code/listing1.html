<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>Test Code - /Test Code/TinselMipMap.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxGraphicsImaging-date.html">Graphics & Imaging</a> &gt; <A HREF="javascript:location.replace('index.html');">Test Code</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/GraphicsImaging/index.html" target="_blank">Reference Library > Graphics & Imaging</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">Test Code</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/Test Code/TinselMipMap.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/Test Code/TinselMipMap.c</option>
<option value="listing2.html">/Test Code/TinselTest.c</option>
<option value="listing3.html">/Test Code/TinselTest.h</option>
<option value="listing4.html">/Test Code/TinselWindow.c</option>
<option value="listing5.html">/TestLinked.prefix.h</option>
<option value="listing6.html">/TestShared.prefix.h</option></select>
				</p>
				</form>
				<p><strong><a href="Test_Code.zip">Download Sample</a></strong> (&#147;Test_Code.zip&#148;, 24.1K)<BR>
<strong><a href="Test_Code.dmg">Download Sample</a></strong> (&#147;Test_Code.dmg&#148;, 78.1K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/****************************************************************************** **                                       ** **   Module:    TinselMipMap.c                       ** **                                      ** **   Purpose:   Support file for mipmapping                ** **                                      ** **   Author:    Mike W. Kelley                       ** **                                       ** **          2/3/95  Revised for 0.9 SDK release             ** **                                      ** **   Copyright (C) 1994-95 Apple Computer, Inc.  All rights reserved.   ** **                                      ** *****************************************************************************/#include &lt;stdlib.h&gt;#include &lt;math.h&gt;#include &lt;string.h&gt;#include &lt;stdio.h&gt;/* Macintosh */#include &lt;Types.h&gt;#include &lt;Resources.h&gt;#include &lt;QuickDraw.h&gt;#include &lt;Fonts.h&gt;#include &lt;Events.h&gt;#include &lt;Windows.h&gt;#include &lt;Menus.h&gt;#include &lt;TextEdit.h&gt;#include &lt;Dialogs.h&gt;#include &lt;Desk.h&gt;#include &lt;ToolUtils.h&gt;#include &lt;Memory.h&gt;#include &lt;SegLoad.h&gt;#include &lt;Files.h&gt;#include &lt;OSUtils.h&gt;#include &lt;OSEvents.h&gt;#include &lt;DiskInit.h&gt;#include &lt;Packages.h&gt;/* Project */#include &quot;RAVE.h&quot;#include &quot;TinselTest.h&quot;/******************************************************************************************* * * Create the mipmap for 'pixmap', and load it into 'texture'. Returns NULL on error. * ******************************************************************************************/TQATexture *CreateMipMapTexture (  TQAEngine    *engine,  TexturePixel  *pixmap,  long      rowBytes,  long      widthNBits,  long      heightNBits){  long      nImages;  long      width, height;  long      nPixels;  TexturePixel  *mipmap;  TQAImage    images [20];    /* Maximum conceivable number of TQAImages! */  long      i;  long      x, y;  long      oneHalf;  TQATexture    *texture;  TQAError    status;    /*   * Allocate working space for the mip map images (starting with the   * 2^(widthNBits-1) x 2^(heightNBits-1) map), and for the array of   * TQAImages that describe the mip map and the parent map.   */    nImages = ((widthNBits &gt; heightNBits) ? widthNBits : heightNBits) + 1;    width = 1 &lt;&lt; (widthNBits - 1);    /* ??? Doesn't work for nBits == 0 */  height = 1 &lt;&lt; (heightNBits - 1);  /* ??? Doesn't work for nBits == 0 */    for (i = nImages - 1, nPixels = 0; i-- &gt; 0; /* Nothing */)  {    nPixels += width * height;        width &gt;&gt;= 1;    height &gt;&gt;= 1;        if (width == 0)    {      width = 1;    }    if (height == 0)    {      height = 1;    }  }  if ( ! (mipmap = malloc (sizeof (*pixmap) * nPixels)))  {    return (NULL);  }    /*   * Fill in the TQAImage info.   */    images[0].width = 1 &lt;&lt; widthNBits;  images[0].height = 1 &lt;&lt; heightNBits;  images[0].pixmap = pixmap;  images[0].rowBytes = rowBytes;    width = 1 &lt;&lt; (widthNBits - 1);    /* ??? Doesn't work for nBits == 0 */  height = 1 &lt;&lt; (heightNBits - 1);  /* ??? Doesn't work for nBits == 0 */    for (i = 1; i &lt; nImages; ++i)  {    images[i].width = width;    images[i].height = height;    images[i].pixmap = mipmap;    images[i].rowBytes = width * sizeof (*mipmap);        mipmap += width * height;        width &gt;&gt;= 1;    height &gt;&gt;= 1;        if (width == 0)    {      width = 1;    }    if (height == 0)    {      height = 1;    }  }  /*   * oneHalf is used to round off the box filter of four pixels.   */    oneHalf = 4 / 2;  /*   * Create the mipmapped images.   */    for (i = 1; i &lt; nImages; ++i)  {    TQAImage      *prevImage, *image;    long      sourceRowBytes, targetRowBytes;    unsigned char  *sourceLine0, *sourceLine1;    unsigned char  *targetLine;        prevImage = &amp;images [i - 1];    image = &amp;images [i];        sourceLine0 = prevImage-&gt;pixmap;        if (prevImage-&gt;height == 1)    {      /*       * Source image is height 1 (widthNBits must be greater than heightNBits).       * Make sourceLine1 duplicate sourceLine0, and set sourceRowBytes to 0 so we       * just keep re-reading the single source line.       */            sourceRowBytes = 0;      sourceLine1 = sourceLine0;    }    else    {      /*       * Normal case. sourceLine1 points one scanline above sourceLine0.       */            sourceRowBytes = prevImage-&gt;rowBytes;      sourceLine1 = sourceLine0 + sourceRowBytes;    }        targetRowBytes = image-&gt;rowBytes;    targetLine = image-&gt;pixmap;    for (y = image-&gt;height; y-- &gt; 0; /* Nothing */)    {      unsigned char  *sourcePixel0, *sourcePixel1;      unsigned char  *targetPixel;            sourcePixel0 = sourceLine0;      sourcePixel1 = sourceLine1;      targetPixel = targetLine;            if (prevImage-&gt;width == 1)      {        /*         * Source image has width 1 (heightNBits must be greater than widthNBits).         * Use a special inner loop that doesn't advance past the first pixel of         * the source lines.         */                for (x = image-&gt;width; x-- &gt; 0; /* Nothing */)        {          long  a, r, g, b;                    /*           * Read and average two pixels from source into target.           */                    a = sourcePixel0 [0] + (oneHalf &gt;&gt; 1);          r = sourcePixel0 [1] + (oneHalf &gt;&gt; 1);          g = sourcePixel0 [2] + (oneHalf &gt;&gt; 1);          b = sourcePixel0 [3] + (oneHalf &gt;&gt; 1);                    a += sourcePixel1 [0];          r += sourcePixel1 [1];          g += sourcePixel1 [2];          b += sourcePixel1 [3];                    *targetPixel++ = a &gt;&gt; 1;          *targetPixel++ = r &gt;&gt; 1;          *targetPixel++ = g &gt;&gt; 1;          *targetPixel++ = b &gt;&gt; 1;        }      }      else      {        /*         * Source image has at least width 2. This is the normal case.         */                for (x = image-&gt;width; x-- &gt; 0; /* Nothing */)        {          long  a, r, g, b;                    /*           * Read and average four pixels from source into target.           */                    a = *sourcePixel0++ + oneHalf;          r = *sourcePixel0++ + oneHalf;          g = *sourcePixel0++ + oneHalf;          b = *sourcePixel0++ + oneHalf;                    a += *sourcePixel1++;          r += *sourcePixel1++;          g += *sourcePixel1++;          b += *sourcePixel1++;                    a += *sourcePixel0++;          r += *sourcePixel0++;          g += *sourcePixel0++;          b += *sourcePixel0++;                    a += *sourcePixel1++;          r += *sourcePixel1++;          g += *sourcePixel1++;          b += *sourcePixel1++;                    *targetPixel++ = a &gt;&gt; 2;          *targetPixel++ = r &gt;&gt; 2;          *targetPixel++ = g &gt;&gt; 2;          *targetPixel++ = b &gt;&gt; 2;        }      }      sourceLine0 += (sourceRowBytes &lt;&lt; 1);      sourceLine1 += (sourceRowBytes &lt;&lt; 1);      targetLine += targetRowBytes;    }  }    status = QATextureNew (engine, kQATexture_Mipmap, kQAPixel_RGB32, images, &amp;texture);  if (status != kQANoErr)  {    return (NULL);  }    return (texture);}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/Test_Code/listing1.html%3Fid%3DDTS10000154-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/Test_Code/listing1.html%3Fid%3DDTS10000154-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/Test_Code/listing1.html%3Fid%3DDTS10000154-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>