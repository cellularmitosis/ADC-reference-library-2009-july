<HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><script language="JavaScript" src="frametest.js"></script><TITLE> LookupDrivers9</TITLE></HEAD><BODY BGCOLOR="#ffffff"><DIV><a name="top"></a><!-- start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!-- start of path --><font face="Geneva,Helvetica,Arial" size="1"><b><br>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Documentation</a> &gt; <!-- a href="" target="_top" -->Hardware<!-- /a -->  <b>&gt; </b><a href="../../devicemgrs.html" target="_top">Device Managers and Drivers</a> <b>&gt; </b><a href="../pci_srvcs.html" target="_top">PCI Card Services</a> <b>&gt; </b>Designing PCI Cards and Drivers for Power Macintosh Computers</font><br><br><!-- end of path --><A HREF="PCI_BOOK.f5.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.f6.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.f8.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><HR></DIV><H2 CLASS="RoH.RoutineHeading"><A NAME="pgfId=4064"> </A><A NAME="25154"> </A>LookupDrivers</H2><P CLASS="T1.Text1"><A NAME="pgfId=4066"> </A><TT CLASS="cv">LookupDrivers</TT><A NAME="marker=4065"> </A> is used to iterate through the contents of the unit table.</P><CODE CLASS="RD.RoutineDeclare"><A NAME="pgfId=15956"> </A>OSErr LookupDrivers(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UnitNumber beginningUnit,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UnitNumber endingUnit,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Boolean emptyUnits,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ItemCount *returnedRefNums,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DriverRefNum *refNums);</CODE><DL COMPACT><DT CLASS="DT.DefinitionTerm"><A NAME="pgfId=15960"> </A><TT CLASS="cv">beginningUnit</TT><A NAME="37963"> </A></DT><DD CLASS="DD.DefinitionDef"><A NAME="pgfId=4069"> </A>First unit in range of units to scan.</DD><DT CLASS="DT.DefinitionTerm"><A NAME="pgfId=15970"> </A><TT CLASS="cv">endingUnit</TT></DT><DD CLASS="DD.DefinitionDef"><A NAME="pgfId=4070"> </A>Last unit in range of units to scan.</DD><DT CLASS="DT.DefinitionTerm"><A NAME="pgfId=15979"> </A><TT CLASS="cv">emptyUnits</TT></DT><DD CLASS="DD.DefinitionDef"><A NAME="pgfId=4071"> </A>A value of <TT CLASS="cv">true</TT> means return available units; a value of <TT CLASS="cv">false</TT> means return allocated units.</DD><DT CLASS="DT.DefinitionTerm"><A NAME="pgfId=15988"> </A><TT CLASS="cv">returnedRefNums</TT></DT><DD CLASS="DD.DefinitionDef"><A NAME="pgfId=4072"> </A> Maximum number of reference numbers to return; on completion, contains actual number of reference numbers returned.</DD><DT CLASS="DT.DefinitionTerm"><A NAME="pgfId=15998"> </A><TT CLASS="cv">refNums</TT></DT><DD CLASS="DD.DefinitionDef"><A NAME="pgfId=4073"> </A>Resulting array of returned reference numbers.</DD></DL COMPACT><DIV><H6 CLASS="RSb.RoutineSbhd"><A NAME="pgfId=4074"> </A>DESCRIPTION</H6><P CLASS="T1.Text1"><A NAME="pgfId=4075"> </A>Given the first and last unit numbers to scan, <TT CLASS="cv">LookupDrivers</TT> returns the reference numbers of both native and 68K drivers. The <TT CLASS="cv">emptyUnits</TT> parameter tells it to return either available or allocated units, and <TT CLASS="cv">returnedRefNums</TT> tells it the maximum number of reference numbers to return. When <TT CLASS="cv">LookupDrivers</TT> finishes, <TT CLASS="cv">returnedRefNums</TT> contains the actual number of reference numbers returned.</P><P CLASS="T1.Text1"><A NAME="pgfId=4079"> </A>The sample code shown in <A HREF="PCI_BOOK.f7.html#25016" CLASS="XRef">Listing&nbsp;9-3</A> uses <TT CLASS="cv">HighestUnitNumber</TT> and <TT CLASS="cv">LookupDrivers</TT> to print out the reference numbers of all installed drivers and obtain driver information.</P></DIV><DIV><H6 CLASS="RSb.RoutineSbhd"><A NAME="pgfId=4099"> </A>RESULT CODES</H6><TABLE border=1 cellpadding=3><TR><TD ROWSPAN="1" COLSPAN="1"><CODE CLASS="TbCv.TblCode"><A NAME="pgfId=4082"> </A>noErr</CODE></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4084"> </A>0</FONT></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4086"> </A>No error</FONT></TD></TR><TR><TD ROWSPAN="1" COLSPAN="1"><CODE CLASS="TbCv.TblCode"><A NAME="pgfId=4088"> </A>badUnitErr</CODE></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4090"> </A>-21</FONT></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4092"> </A>Bad unit number</FONT></TD></TR><TR><TD ROWSPAN="1" COLSPAN="1"><CODE CLASS="TbCv.TblCode"><A NAME="pgfId=4094"> </A>paramErr</CODE></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4096"> </A>-50</FONT></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4098"> </A>Bad parameter</FONT></TD></TR></TABLE><P CLASS="L.Listing"><B><A NAME="pgfId=4101"> </A>Listing&nbsp;9-3	<A NAME="25016"> </A>Using the <TT CLASS="cv">LookupDrivers</TT> function</B></P><CODE CLASS="CvF.CodeFull"><A NAME="pgfId=16065"> </A>OSStatus FindAllDrivers (void)<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;ItemCount&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;theCount&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 1;<BR>&nbsp;&nbsp;&nbsp;&nbsp;UnitNumber&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;theUnit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 0;<BR>&nbsp;&nbsp;&nbsp;&nbsp;DriverRefNum&nbsp;&nbsp;&nbsp;&nbsp;theRefNum,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*fullSizedRefNumBuffer;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;/* method #1: iterate with a small output buffer */<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;while ( (theUnit &lt;= HighestUnitNumber()) &amp;&amp;<BR>&nbsp;&nbsp;&nbsp;&nbsp; (LookupDrivers (theUnit, theUnit, false, &amp;theCount, &amp;theRefNum) ==noErr))<BR>&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (theCount == 1) printf (&quot;Refnum #%d is allocated.\n&quot;,theRefNum);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;theCount = 1;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;theUnit++;<BR>&nbsp;&nbsp;&nbsp;&nbsp;}<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;/* method #2: get all refnums with one call */<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;fullSizedRefNumBuffer = NewPtr ((HighestUnitNumber() + 1) *<BR>&nbsp;&nbsp;&nbsp;&nbsp; sizeof(DriverRefNum));<BR>&nbsp;&nbsp;&nbsp;&nbsp;theCount = (HighestUnitNumber() + 1);<BR>&nbsp;&nbsp;&nbsp;&nbsp;LookupDrivers (0, HighestUnitNumber(), false, &amp;theCount,<BR>&nbsp;&nbsp;&nbsp;&nbsp; fullSizedRefNumBuffer);<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;for(theUnit=0,theUnit &lt;theCount;theUnit++)<BR>&nbsp;&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Refnum #%d is allocated.\n&quot;, fullSizedRefNumBuffer [theUnit]);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ShowDriverInfo (fullSizedRefNumBuffer [theUnit]);<BR>&nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp;&nbsp;DisposePtr(fullSizedRefNumBuffer);<BR>&nbsp;&nbsp;&nbsp;&nbsp;return noErr;<BR>}<BR><BR>ShowDriverInfo (DriverRefNum *refNum)<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;UnitNumber&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;theUnit;<BR>&nbsp;&nbsp;&nbsp;&nbsp;DriverRefNum&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;aRefNum;<BR>&nbsp;&nbsp;&nbsp;&nbsp;DriverFlags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;theFlags;<BR>&nbsp;&nbsp;&nbsp;&nbsp;FSSpec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;driverFileSpec;<BR>&nbsp;&nbsp;&nbsp;&nbsp;RegEntryID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;theDevice;<BR>&nbsp;&nbsp;&nbsp;&nbsp;CFragHFSLocator&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;theLoc;<BR>&nbsp;&nbsp;&nbsp;&nbsp;Str255&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;theName;<BR>&nbsp;&nbsp;&nbsp;&nbsp;CFragConnectionID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fragmentConnID;<BR>&nbsp;&nbsp;&nbsp;&nbsp;DriverOpenCount&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;theOpenCount;<BR>&nbsp;&nbsp;&nbsp;&nbsp;DriverEntryPointPtr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fragmentMain;<BR>&nbsp;&nbsp;&nbsp;&nbsp;DriverDescription&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;theDriverDescription;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;theLoc.u.onDisk.fileSpec = &amp;driverFileSpec; /* See note below */<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;GetDriverInformation (&nbsp;&nbsp;aRefNum,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;theUnit,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;theFlags,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;theOpenCount,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;theName,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;theDevice,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;theLoc,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;fragmentConnID,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;fragmentMain,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;theDriverDescription);<BR>&nbsp;&nbsp;&nbsp;&nbsp;printf (&quot;Driver's flags are:  %x\n&quot;, theFlags);<BR>}</CODE><br><br><blockquote><p><b><A NAME="pgfId=16033"> </A>IMPORTANT</b></p><P CLASS="I.Important"><A NAME="pgfId=4111"> </A>When calling <TT CLASS="cv">GetDriverInformation</TT>, always supply an <TT CLASS="cv">FSSpec</TT> file specification as shown in the preceding sample. Failure to do so may cause the DLL or the CFM to crash the system or overwrite the system heap. </P></blockquote></DIV><DIV><blockquote><p CLASS="NoteHead"><b><A NAME="pgfId=16045"> </A>Note</b></p><P CLASS="Note"><A NAME="pgfId=4115"> </A>You can also use the DLL to load a native driver without any associated hardware device. Just pass <TT CLASS="cv">nil</TT> in <TT CLASS="cv">RegEntryIDPtr</TT> to the DLL installation service. </P> </blockquote></DIV><HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 26 March 99)<P><A HREF="PCI_BOOK.f5.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.f6.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.f8.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>