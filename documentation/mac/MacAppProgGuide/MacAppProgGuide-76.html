<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Performing a Drop Operation (MacApp PG)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING76></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="MacAppProgGuide-75.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="MacAppProgGuide-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="MacAppProgGuide-158.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="MacAppProgGuide-77.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="MacAppProgGuide-2.html"><B>Programmer's Guide to MacApp</B></A> / <A HREF="MacAppProgGuide-21.html"><B>Part 1 - MacApp Theory and Architecture</B></A><BR><DD><A HREF="MacAppProgGuide-72.html"><B>Chapter 9 - Drag and Drop</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING76-0></A>
<H1><A NAME=MARKER-2-67></A>Performing a Drop Operation</H1>
 This section describes how the objects in a MacApp application work together with the Macintosh Drag Manager to perform a drop operation. The discussion refers to the steps of a drop operation--those steps are shown in <A HREF=MacAppProgGuide-75.html#MARKER-9-54>Figure 9-3</A>.<P>
<A NAME=HEADING76-2></A>
<H2><A NAME=MARKER-2-68></A>Registering to Receive a Drop</H2>
 Objects in the application register with other objects and with the Drag Manager to indicate that they can receive dropped data. A droppable view registers with its window object, and the window registers with the global drag session object. The drag session object installs any callback routines needed by the Drag Manager to let the application handle drag tracking and receive dropped data.<P>
 There is no need for a view to register the fact that it can initiate a drag.<P>
 The following routines perform drop registration and install Drag Manager callback routines:<P>
<UL>
<LI>For a view that adds a <CODE>TDragDropBehavior</CODE> definition to its view resource definition to specify that the view accepts drops, the view's <CODE>DoPostCreate</CODE> method automatically calls the window object's <CODE><A NAME=MARKER-2-69></A>RegisterDroppableViews</CODE> method to register the view. <P>
To programmatically register a view with its window, you call the view's <CODE>SetDroppable</CODE> method.
<LI>A window object's <CODE>RegisterDroppableViews</CODE> method adds the passed view to its list of droppable views, then calls the global drag session object's <CODE><A NAME=MARKER-2-36></A>RegisterDroppableWindow</CODE> method. That method calls the Drag Manager routines <CODE><A NAME=MARKER-2-37></A>InstallTrackingHandler</CODE> and <CODE><A NAME=MARKER-2-38></A>InstallReceiveHandler</CODE> to install callback routines.<A NAME=MARKER-2-73></A><P>
</UL>
<A NAME=HEADING76-9></A>
<H2><A NAME=MARKER-2-74></A>Reacting to Drag Manager Callbacks</H2>
 While a user continues a drag operation, the Drag Manager makes periodic calls to <CODE>TDragDropSession::<A NAME=MARKER-2-75></A>DragTrackingHandlerGlue</CODE>, the application's callback routine for tracking a drag. The Drag Manager passes a message that indicates the state of the drag--that is, whether it's entering or leaving the drag handler or whether it's entering, leaving, or tracking in a drag window.<P>
 The <CODE>DragTrackingHandlerGlue</CODE> method passes the message on in a call to the <CODE>TDragDropSession::<A NAME=MARKER-2-76></A>DragTrackingHandler</CODE> method, which calls an appropriate method of the drag session object, based on the message.<P>
<A NAME=HEADING76-12></A>
<H2>Determining the Target of a Drop</H2>
 When a user drags over an application window, the Drag Manager calls on the application to determine whether the drag is above a droppable view. The Drag Manager passes the message for tracking in a window, causing the <CODE>DragTrackingHandler</CODE> method to call the drag session object's <CODE><A NAME=MARKER-2-77></A>HandleTrackInWindow</CODE> method. That method calls the window to supply from its list of droppable views a target view that can accept the current dragged data. <P>
 For each of its droppable views, the window's <CODE><A NAME=MARKER-2-78></A>MouseToDropTarget</CODE> method calls the <CODE><A NAME=MARKER-2-79></A>WillAcceptDrop</CODE> method, which iterates over the drag items in the current drag. A view normally accepts a drop only if it can accept at least one flavor for each drag item in the drag data. For efficiency, the window caches information about whether a specific view can accept the current drag, so it doesn't have to be recalculated if the user drags off a view and back over it again. For more information about accepting a drop, see <A HREF=MacAppProgGuide-77.html#MARKER-9-107>"When a View Should Accept a Drop"</A> and <A HREF=MacAppProgGuide-77.html#MARKER-9-102>"CDragItemIterator" on page 266</A>.<P>
 If the window contains a view that can accept the drop, the drag session's tracking handler calls methods of the view to provide visual feedback, as described in the next section.<P>
<A NAME=HEADING76-16></A>
<H2><A NAME=MARKER-9-80></A>Providing Visual Feedback for a Drop</H2>
 Depending on the type of view, visual feedback may include highlighting a region of the view and indicating the current insertion point for the data to be dropped. Step 5 in <A HREF=MacAppProgGuide-75.html#MARKER-9-54>Figure 9-3</A> <A HREF=MacAppProgGuide-75.html#MARKER-9-54>(page 259)</A> shows the highlighted drop-target view and the insertion point for a dragged text selection.<P>
 When the window returns a target view willing to accept the drag, the drag session object, in response to callbacks from the Drag Manager, calls the following <CODE>TView</CODE> methods to provide visual feedback and track the drag operation:<P>
<DL>
<DT><CODE><A NAME=MARKER-2-81></A>DoDragEnter</CODE>
<DD> Notifies the view that it has been entered by a drag. The view can set up any internal data it uses to track a drag. This may involve initializing variables that track the drop insertion location.
<DT><CODE><A NAME=MARKER-2-39></A>DoMakeDropHiliteRegion</CODE>
<DD> Creates and returns a highlight region to represent the target of the drag. Unlike other drag-and-drop methods that supply regions, <CODE>DoMakeDropHiliteRegion</CODE> returns the region in global screen coordinates. The <CODE>TView</CODE> method <CODE><A NAME=MARKER-2-83></A>LocalToGlobalRegion</CODE> is provided to convert a region from local to global coordinates.
<DT><CODE><A NAME=MARKER-2-40></A>DoDragWithin</CODE>
<DD> Called repeatedly as the user drags within the view. Allows view to update any visual tracking indicators it provides. This may involve blinking and relocating an insertion point, highlighting a grid cell, or providing other feedback.
<DT><CODE><A NAME=MARKER-2-85></A>DoDragLeave</CODE>
<DD> Called when the drag exits the view, it erases any visual tracking information that has been drawn and frees any memory allocated during tracking. If the user releases the mouse while over a view that is tracking, <CODE>DoDragLeave</CODE> is not called until after the view has been given a chance to extract data from the drag operation, as described in <A HREF=#MARKER-9-92>"Creating Drag-and-Drop Commands"</A> below.
</DL>
<A NAME=HEADING76-23></A>
<H2>Performing a Drop</H2>
 When the user releases the mouse while dragging over a view that has agreed to accept a drag, the Drag Manager calls the drag session object's <CODE>DragReceiveHandlerGlue</CODE> method, which in turns calls the <CODE>DragReceiveHandler</CODE> method. The <CODE><A NAME=MARKER-2-45></A>DragReceiveHandler</CODE> method determines whether the dragged data should be moved or copied. The logic used to determine whether to treat the drag as a move or copy is described in the section <A HREF=MacAppProgGuide-77.html#MARKER-9-122>"Drag Copy Versus Drag Move" on page 268</A>.<P>
 Once the <CODE>DragReceiveHandler</CODE> method has determined whether the drag is a copy or move, it calls the <CODE>TView</CODE> method <CODE><A NAME=MARKER-2-87></A>DoMakeDragDropCommand</CODE>, passing a command number of <CODE><A NAME=MARKER-2-88></A>cDrag</CODE>, <CODE><A NAME=MARKER-2-42></A>cDrop</CODE>, or <CODE><A NAME=MARKER-2-41></A>cDragMove</CODE>:<P>
<UL>
<LI>If the operation is a drag copy, <CODE>DragReceiveHandler</CODE> calls the <CODE>DoMakeDragDropCommand</CODE> method of the destination view, passing the command number <CODE>cDrop</CODE> ("drop the data into this view").
<LI>If the operation is a drag move between views within the application, <CODE>DragReceiveHandler</CODE> calls the <CODE>DoMakeDragDropCommand</CODE> method for the destination view, passing the command number <CODE>cDrop</CODE>, and for the source view, passing <CODE>cDrag</CODE> ("drag the data out of this view"). The commands are linked and, as a result, performing or undoing the command changes both the source and target view. 
<LI>If the operation is a drag move to another application (including a drag to the Trash), <CODE>DragReceiveHandler</CODE> calls the <CODE>DoMakeDragDropCommand</CODE> method for the source view only, passing the command number <CODE>cDrag</CODE>. 
<LI>If the source and target are the same view and the operation is a move, <CODE>DragReceiveHandler</CODE> calls the <CODE>DoMakeDragDropCommand</CODE> method for the view, passing the command number <CODE>cDragMove</CODE> ("move the dragged data within this view").<P>
</UL>
<A NAME=HEADING76-30></A>
<H3><A NAME=MARKER-2-91></A><A NAME=MARKER-9-92></A>Creating Drag-and-Drop Commands</H3>
 The previous section describes how a view's <CODE><A NAME=MARKER-2-47></A>DoMakeDragDropCommand</CODE> method is asked to create a drag-and-drop command based on the command number passed to it.<CODE> </CODE>When a view is asked to create a <CODE>cDrag</CODE> command, it creates and returns a command whose <CODE>DoIt</CODE> method removes the dragged data from the view. The command's <CODE>UndoIt</CODE> method reinserts the data, and its <CODE>RedoIt</CODE> method removes the data again.<P>
 When a view is asked to create a <CODE>cDrop</CODE> command, it creates and returns a command whose <CODE>DoIt</CODE> method inserts the dropped data into the view. The command's <CODE>UndoIt</CODE> method removes the inserted data, and its <CODE>RedoIt</CODE> method inserts the data again.<P>
<DL>
<DT><B>IMPORTANT</B>
<DD>A view's <CODE>DoMakeDragDropCommand</CODE> method must pull all the necessary data out of the current drag before returning, because drag item data becomes invalid as soon as a drag operation is complete.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 When a view is asked to create a <CODE>cDragMove</CODE> command, it creates and returns a command whose <CODE>DoIt</CODE> method moves the selected data from its current location in the view to the location specified by the drop. The <CODE>UndoIt</CODE> method reverses the move and the <CODE>RedoIt</CODE> method restores it.<P>
 Many current MacApp applications already implement commands that perform data insertion or removal. It should be possible to reuse these existing commands, with little modification, to perform the actual work of a drag, drop, or move operation.<A NAME=MARKER-2-94></A><P>
<A NAME=HEADING76-36></A>
<H3>Posting the Command</H3>
 A view is not responsible for posting a command it creates. The <CODE><A NAME=MARKER-2-91></A>DragReceiveHandler</CODE> method posts commands as necessary.<P>
<A NAME=HEADING76-38></A>
<H3><A NAME=MARKER-9-96></A>Linked Commands</H3>
 <A NAME=MARKER-2-97></A>A drag move operation that causes data to be moved between views has the effect of causing both the source view and the destination view to create a command. The <CODE>DragReceiveHandler</CODE> method then links the two commands together. MacApp's <CODE>TCommandHandler</CODE> class automatically manages operations on linked commands. Doing, undoing, redoing, or committing either command causes the linked command to be done, undone, redone, or committed as well.<P>
 When MacApp performs a command, it checks the command's <CODE><A NAME=MARKER-2-98></A>fValidationFailed</CODE> field. If either command of a linked pair of commands fails to complete execution because of a validation error, MacApp ensures that both commands are left undone and that the Clipboard is also left in its <BR>previous state.<A NAME=MARKER-2-99></A><A NAME=MARKER-2-100></A><P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="MacAppProgGuide-75.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="MacAppProgGuide-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="MacAppProgGuide-158.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="MacAppProgGuide-77.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="MacAppProgGuide-3.html">&copy; Apple Computer, Inc.</A><br>25 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
