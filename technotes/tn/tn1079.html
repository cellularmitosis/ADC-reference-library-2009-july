<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1079: Power Management &amp; Servers: Auto Restart From Power Failure</title><meta name="keywords" content="Mac OS 8 power soft management restarting computer cuda manager"><meta name="Description" content="Technical Note TN1079: This Technical Note discusses howto communicate with the Macintosh's                                         internal power management microcontrollerand configure the                                         Macintosh hardware so that the system will power itselfup any                                          time primaryAC is available. Included is a discussion of the Cuda Manager,how to detect its presence and how to utilize it."><meta name="categories" content="Hardware"><meta name="week-posted" content="Oct 28, 1996 - Nov 1, 1996"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002920" title="Power Management & Servers: Auto Restart From Power Failure"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/index.html" target="_blank">Reference Library > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --> <!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1079</div>
<div id="pageheadsub">Power Management &amp; Servers: Auto Restart From Power Failure</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"> <!-- begin_header_box --> <table width="600" cellpadding="0" cellspacing="0" border="0">	<tr>		<td width=300 valign="top" align=left scope="row">			<table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>				</tr>				<tr bgcolor="#e6e6e6">					<td background="images/tnmenubody.gif" width=300 align=left>						<span id="menutitle">							CONTENTS                             <br>                            <br>						</span>					</td>				</tr>				<tr bgcolor="#e6e6e6">					<td background="images/tnmenubody.gif" width=300 align=left><!-- begin_toc -->    <P id = "menutext"><A HREF="#C1">The Process of                  Turning On YourMacintosh</A><BR><BR><A HREF="#C2">IntroducingThe Cuda Manager</A><BR><BR><A HREF="#C3">Determining IfYour Mac Supports theCuda</A><BR><BR><A HREF="#C4">Calling theCuda Manager</A><BR><BR><A HREF="#C5">Cuda ManagerParameter BlockStructure</A><BR><BR><A HREF="#C6">Enable /Disable File ServerMode</A><BR><BR><A HREF="#C7">Working with aUPS</A><BR><BR><A HREF="#C8">Power FailTime Clock</A><BR><BR><A HREF = "#Summary">Summary</a><BR><BR>    <A HREF = "#References">References</a><BR><BR><A HREF="#Downloads">Downloadables</A></p>                  <!-- end_toc --> 								</td>				</tr>				<tr>					<td width=300 align=left scope="row">						<img src="images/tnmenubottom.gif" alt="" width=300 height=16>					</td>				</tr>			</table>		</td>		<td width=300 valign="top" align=left>			<!-- begin_intro_text -->                              <P id = "introtext">Automatically restarting                  from a power failure is an important feature for                  any server.</P>                                   <P id = "introtext">Normally, powering up a Macintosh computer                  requires manual intervention by the user. It is                  possible, however, to configure the Macintosh                  hardware so that the system will power itself up                  any time primary AC is available.</P>                                    <P id = "introtext">This Note discusses how to communicate with the                  Macintosh's internal power management                  microcontroller and is important for developers who                  design software that must run in an environment                  where little or no human intervention is                  available.</P><!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Nov 7 1996]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_header_box --><BR><BR><hr width=500 align=center>          <BR><BR><!-- begin_content --><A NAME=C1></A>                  <H2>The Process of Turning On Your         Macintosh</H2>                  <P>Most server software is designed to run in an environment         where you're not guaranteed human supervision. A remote         server, for example, ought to be able to restart itself         after a power failure without any manual interaction.</P>                  <P>By default, Macintosh computers are designed to be used         in a desktop environment, where the user must power up by         manually pressing the power-on key. However, in most cases         it is possible to configure the Macintosh firmware, so that         the system will power itself up the next time that primary         AC is available.</P>                  <P>Most Macintosh computers are equipped with an internal         microcontroller that, among other things, manages the         Macintosh power providing <B>Soft Power Control</B>. This         microcontroller, a custom ASIC designed specifically for         Apple, dictates the circumstances under which the Macintosh         will initiate a power up cycle. Typical power-on options         include: <BR>         </P>                  <UL>            <LI>Manual depression of the Power-key on the            keyboard.</LI>                        <LI>Manual depression of a momentary contact switch,            usually mounted on the rear chassis of the system.</LI>                        <LI>External power up, such as occurs when a NuBus card            asserts the PFW signal directly.</LI>                        <LI>The internal power up alarm specified by the Power            Manager command <CODE>SetStartupTimer</CODE> becomes            active.</LI>                        <LI>On Macintosh units that support this feature, there            is a Wakeup line connected to the serial ports GPI pin. A            typical application of this feature is to power up the            Macintosh when it is used as an answering machine or            modem server.</LI>                        <LI>When the system is configured in <B>Server Mode</B>            and AC power is restored.</LI>         </UL>                  <P>This Note only concentrates on the last two options,         Server Mode and Wakeup Mode, and how to enable/disable         them.</P>           <P><A HREF="#top">Back to top</A></P>                <A NAME=C2></A>                  <H2>Introducing The Cuda Manager</H2>                  <P>Server Mode is enabled by accessing an internal piece of         Macintosh system software known as the <B>Cuda Manager         </B>(also known as Egret). The Cuda is the firmware that         communicates to the microcontroller responsible for managing         the Macintosh power.</P>                  <P>Keep in mind that not all Macintosh models have the Cuda         Manager or <B>Soft Power Control</B>. Soft Power Control         exists only on systems where AC voltage is always available         to the power supply, and the power supply is controlled by         the state of the power fail warning (PFW) signal.</P>                  <P>On the other hand, <B>Passive Power Control</B> exists in         systems where the power supply is turned off or on by a         switch directly in line with the primary AC voltage to the         supply.</P>                  <P>For example, Macintosh Classic and Macintosh II LC employ         Passive power control, while the Macintosh II and most Power         Macs use Soft Power.</P>                  <P>There are also certain Macintosh models, such as the         Color Classic, LC475 and LC575 CPUs, that implement a         <B>Pseudo Soft Power</B> supply control. In those cases, the         keyboard power key can be used to initiate a power-up of the         system, but the chassis switch is wired directly to the         power supply and is not utilized by Cuda.</P>         <P><A HREF="#top">Back to top</A></P>         <A NAME=C3></A>                  <H2>Determining If Your Mac Supports the Cuda</H2>                  <P>The proper way to determine if a particular Macintosh         model supports the Cuda Manager is as follows: </P>                  <OL>            <LI>Use the Gestalt function to check for the            <CODE>gestaltHardwareAttr 'hdwr'</CODE> selector. Then            check the response for            <CODE>gestaltHasSoftPowerOff</CODE> (bit 19). This will            indicate if the Macintosh supports Soft Power</LI>                        <LI>Use the <CODE>GetOSTrapAddress</CODE> to check for            the existence of the Cuda Manager dispatch trap known as            <CODE>_EgretDispatch ( $A092 )</CODE></LI>         </OL><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>long unknownTrapAddr;unknownTrapAddr = GetOSTrapAddress( _Unimplemented );if( unknownTrapAddr  == GetOSTrapAddress( _EgretDispatch ))</pre>	</TD></TR></TABLE></CENTER>                  <P>In addition to checking the <CODE>_EgretDispatch</CODE>         trap vector, you also need to ensure that the Cuda Manager         software is loaded. There are a few Macintosh ROMs that,         even though they implement the Cuda trap, do not have         appropriate Cuda hardware. On these machines, invoking the         <CODE>_EgretDispatch</CODE> trap call <STRONG>will result in         a bus error.</STRONG> In order to verify that the Cuda         software was loaded, you need to check that the internal low         memory global at location 0xDE0 does not equal -1.</P><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>#define CudaBase 0x00000DE0typedef Ptr  *CudaGlobalsPtr;Boolean CheckForCuda( void ){  long   unknownTrapAddr;  unknownTrapAddr  = GetOSTrapAddress( _Unimplemented )  if( unknownTrapAddr == GetOSTrapAddress( _EgretDispatch ) )        return FALSE;  if( CudaBase == (CudaGlobalsPtr) -1 )         return FALSE;  return TRUE; }</pre>	</TD></TR></TABLE></CENTER>              <P><A HREF="#top">Back to top</A></P>                  <A NAME=C4></A>                  <H2>Calling the Cuda Manager</H2>                  <P>Only after you have established the existence of the Cuda         Manager should you then pass commands to it. You can do this         by issuing a trap dispatch call to the Cuda Manager through         the <CODE>$A092</CODE> trap.</P>                  <P>On entry, register <CODE>A0</CODE> must contain a pointer         to a parameter block which describes the type of function to         be executed by Cuda and how a response to execution of that         function is to be returned.</P>                  <P>When issuing a Cuda dispatch trap from C, it is necessary         to pass a pointer to the Cuda parameter block to the trap         using register A0 as a pointer to the parameter block. The         following function prototype can be used to interface to the         Cuda Manager: </P>         <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    #pragma parameter Cuda( __A0 )    void Cuda( CudaPB* myPB ) = 0xA092;</pre>	</TD></TR></TABLE></CENTER>              <P><A HREF="#top">Back to top</A></P>                  <A NAME=C5></A>                  <H2>Cuda Manager Parameter Block Structure</H2>                  <P>The Cuda Manager parameter block structure used by all         the Cuda Management functions is defined as follows: </P>         <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>#define pseudoPkt       0x01    /* Cuda Pseudo Packet               */#define EnDisFileS      0x13    /* enable/disable file server flag  */#define WakeupMode      0x23    /* Enable/Disable WakeUp Mode       */#define GetPwrFailTime  0x27    /* read time of last power failure  */typedef struct {    unsigned char       pbCmdType;      // Command Type,  always  'pseudoPkt'    unsigned char       pbCmd;          // Command    union{                              // parameter to pass        unsigned char   pByte[4];        unsigned short  pWord[2];        unsigned long   pLong;        }pbParam;    unsigned short      pbByteCnt;      // Number of bytes passed in buffer    unsigned char       *pbBufPtr;      // Pointer to a buffer.    unsigned char       pbFlags;        // Flags returned by Cuda    unsigned char       pbSpare;        // reserved    short               pbResult;       // Result code returned by Cuda    ProcPtr             pbCompletion;   // Routine to be called on completion}CudaPB, *CudaPbPtr;</pre>	</TD></TR></TABLE></CENTER>                                <P>The Cuda Manager functions that you need to use are         classified as Pseudo Device functions. Typically, parameters         of four bytes or less can be passed to or from the Cuda in         the parameter block. An error code may also be returned in         the event of an unsuccessful completion of a function.</P>                           <P><A HREF="#top">Back to top</A></P>        <A NAME=C6></A>                  <H2>Enable / Disable File Server Mode</H2>                  <P>This call is used to inform Cuda whether the system         should be configured as a standard personal computer or as a         file server. When configured as a file server, the system         will power itself up any time primary AC is available. When         configured as a standard personal computer, the system must         be powered up either by manual intervention of the user or         the power up timer. A value of zero passed to pbParam will         configure the system as a standard personal computer while a         non zero value will configure the system as a file         server.</P>                <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>short Enable_FS_Mode(){    CudaPB          thePB;    if(!CheckForCuda() ) return( kNoCudaError);    thePB.pbCmdType         = pseudoPkt;    thePB.pbCmd             = EnDisFiles;    thePB.pbParam.pByte[0]  = 1;    //enable or disable    thePB.pbParam.pByte[1]  = 0;    thePB.pbParam.pByte[2]  = 0;    thePB.pbParam.pByte[3]  = 0;    thePB.pbByteCnt         = 0    thePB.pbBufPtr          = nil;    thePB.pbResult          = 0;    thePB.pbCompletion      = nil;    Cuda( &amp;thePB  );    return  thePB.pbResult}</pre>	</TD></TR></TABLE></CENTER><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>The mode will revert to a standard personal computer if the Shutdown command is issued.</P></TD></TR></TABLE></CENTER><BR>                                                       <A NAME=C7></A>                  <H3>Working with a UPS</H3>                  <P>File Server Mode can be used in conjunction with an         external Uninterruptible Power Supply (UPS). But it requires         that you programatically shut down the Macintosh before the         UPS powers off. Since the File Server Mode state is only         valid until the next shutdown, you must "force" the shutdown         into not reverting the Cuda into personal computer mode.</P>                  <P>One way to accomplish this is to interact with the         shutdown process, as follows: </P>                  <P>Near the end of the shutdown process the ShutDownMgr will         check the <CODE>gestaltHardwareAttr 'hdwr'</CODE> selector's         response for <CODE>gestaltHasSoftPowerOff</CODE> (bit 19).         If this machine does not have soft power, it puts up the         <STRONG>Safe to Shut Off Your Computer</STRONG> alert.</P>                  <P>As part of your UPS Manager's setup, you can use the         ShutDwnInstall procedure to install a custom shutdown proc         that will run before the computer powers down. For         example: </P>         <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>ErrNo = ShutDwnInstall (myShutdownProc, sdOnPowerOff);</pre>	</TD></TR></TABLE></CENTER>                  <P>Then in your Shutdown proc, you can use the         <CODE>ReplaceGestalt</CODE> function to intercept the         ShutDownMgr's Gestalt lookup, so that it returns a response         that has the <CODE>gestaltHasSoftPowerOff</CODE> bit reset.         </P>               <BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR> Be sure that you read the <a href="../../documentation/mac/Processes/Processes-146#HEADING146-0">                  Shutdown Manager chapter of <CITE>Inside Macintosh:                   Processes</CITE></A> to understand exactly what                  happens in the shutdown process and the correct way                  to shut down a Macintosh computer.</P></TD></TR></TABLE></CENTER><BR><P><A HREF="#top">Back to top</A></P>                  <A NAME=C8></A>                  <H2>Power Fail Time Clock</H2>                  <P>The <CODE>GetPwrFailTime</CODE> call is used to read the         32 bit integer that represents the last time the system was         powered down. The Cuda maintains this in the number of         elapsed seconds since January 1, 1904.</P>                           <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>Word Get_PwrFail_Time(){    myCudaPB.pbCmdType      = pseudoPkt;    myCudaPB.pbCmd          = GetPwrFailTime;  //  ($27)    myCudaPB.pbParam.pLong  = Time;    myCudaPB.pbResult       = noErr;    myCudaPB.pbCompletion   = NIL;    Cuda( &amp;myCudaPB  );    return myCudaPB.pbResult; }</pre>	</TD></TR></TABLE></CENTER><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>This function is only available in Cuda Manager 3.0                  or greater. The Cuda Manager can be tested by                  checking the 'cuda' Gestalt selector.</P></TD></TR></TABLE></CENTER><BR><P><A HREF="#top">Back to top</A></P><a name="Summary"></a>         <H2>Summary</H2>                  <P>Although this Technote describes how to configure your         Macintosh to automatically restart from a power failure, not         all Macintoshes support this feature. This is because there         are other ways for Macintosh computers to implement soft         power control. For instance, PowerBooks utilize a         completely different system. This is why your code should         follow the steps outlined in this Note to check if the         Cuda/Egret trap is implemented.</P>                  <P>Since accessing the Cuda Manager requires intimate         knowledge of low memory globals, it may not work in later         Mac OS releases.</P>         <P><A HREF="#top">Back to top</A></P>        <a name="References"></a>          <H2>References</H2>                              <p><a href="../../documentation/mac/Devices/Devices-230#HEADING230-0">Inside                     Macintosh: Devices, Chapter 6, Power Manager                     Reference</A></p>                                          <p><a href="tn1046.html">Technote                     1046: Inside Macintosh: Devices, Power Manager                     Addenda</A></p>                    <P><A HREF="#top">Back to top</A></P>          <a name="Downloads"></a> <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="500">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (60K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tn1079.pdf">Download</A></P>               </TD>            </TR></table>            <BR><P><A HREF="#top">Back to top</A></P></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1079.html%3Fid%3DDTS10002920-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1079.html%3Fid%3DDTS10002920-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1079.html%3Fid%3DDTS10002920-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>