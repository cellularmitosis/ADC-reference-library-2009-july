<HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><script language="JavaScript" src="frametest.js"></script><TITLE> Timer Services</TITLE></HEAD><BODY BGCOLOR="#ffffff"><DIV><a name="top"></a><!-- start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!-- start of path --><font face="Geneva,Helvetica,Arial" size="1"><b><br>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Documentation</a> &gt; <!-- a href="" target="_top" -->Hardware<!-- /a -->  <b>&gt; </b><a href="../../devicemgrs.html" target="_top">Device Managers and Drivers</a> <b>&gt; </b><a href="../pci_srvcs.html" target="_top">PCI Card Services</a> <b>&gt; </b>Designing PCI Cards and Drivers for Power Macintosh Computers</font><br><br><!-- end of path --><A HREF="PCI_BOOK.220.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.222.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.224.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><HR></DIV><H1 CLASS="H2.Heading2"><A NAME="pgfId=3469"> </A>Timer Services</H1><P CLASS="T1.Text1"><A NAME="pgfId=3471"> </A>Open Transport supplies robust <A NAME="marker=3470"> </A>timer services that are synchronized with the STREAMS environment and are supported by using special STREAMS messages. The function <TT CLASS="cv">mi_timer_alloc</TT> creates one of these special STREAMS messages:</P><CODE CLASS="RD.RoutineDeclare"><A NAME="pgfId=14468"> </A>mblk_t* mi_timer_alloc(queue_t* targetQueue, size_t size);</CODE><P CLASS="T1.Text1"><A NAME="pgfId=3473"> </A>Calling this function creates a STREAMS timer message of the requested size that is targeted to the specified STREAMS queue. Upper queues must be used as the targets of timer messages because timer messages enter target queues as <TT CLASS="cv">M_PCSIG</TT> messages, which can never legitimately arrive from an upper queue but might legitimately arrive from a lower queue.</P><CODE CLASS="RD.RoutineDeclare"><A NAME="pgfId=14472"> </A>void mi_timer(mblk_t* timerMsg, unsigned long milliSeconds);</CODE><P CLASS="T1.Text1"><A NAME="pgfId=3475"> </A>This function schedules the <TT CLASS="cv">timerMsg</TT> (created using <TT CLASS="cv">mi_timer_alloc</TT>) to be placed on the target STREAMS queue at a specified future time.</P><DIV><blockquote><p CLASS="NoteHead"><b><A NAME="pgfId=14474"> </A>Note</b></p><P CLASS="Note"><A NAME="pgfId=3476"> </A>To reset a timer, you need only call <TT CLASS="cv">mi_timer</TT> with the new time. There is no need to call <TT CLASS="cv">mi_timer_cancel</TT>. </P></blockquote><CODE CLASS="RD.RoutineDeclare"><A NAME="pgfId=14478"> </A>void mi_timer_cancel(mbk_t* timerMsg);</CODE><P CLASS="T1.Text1"><A NAME="pgfId=3481"> </A>This function cancels an outstanding timer message. The <TT CLASS="cv">timerMsg</TT> message is not destroyed but will no longer be delivered to the target queue. It may be rescheduled by using <TT CLASS="cv">mi_timer</TT> at a later time.</P><CODE CLASS="Cv.Code"><A NAME="pgfId=14482"> </A>void mi_timer_free (mblk_t* timerMsg);</CODE><P CLASS="T1.Text1"><A NAME="pgfId=3483"> </A>This function cancels and frees the specified timer message (<TT CLASS="cv">mi_timer_cancel</TT> does not free the message). Never call <TT CLASS="cv">freeb</TT> or <TT CLASS="cv">freemsg</TT> for a timer message.</P><CODE CLASS="Cv.Code"><A NAME="pgfId=14486"> </A>Boolean mi_timer_valid (mblk_t* timerMsg);</CODE><P CLASS="T1.Text1"><A NAME="pgfId=3485"> </A>Timer messages enter the target queue as <TT CLASS="cv">M_PCSIG</TT> messages. Whenever a queue that can receive a timer message receives an <TT CLASS="cv">M_PCSIG</TT> message, it should call <TT CLASS="cv">mi_timer_valid</TT>, passing the <TT CLASS="cv">M_PCSIG</TT> message as a parameter. If the function returns <TT CLASS="cv">true</TT>, then the timer message is valid and should be processed. If the function returns <TT CLASS="cv">false</TT>, then the timer message was either deleted or canceled. In this case, ignore the message and don't free it. </P></DIV><DIV><blockquote><p CLASS="WarningHead"><b><A NAME="pgfId=14488"> </A>WARNING</b></p><P CLASS="W.Warning"><A NAME="pgfId=3489"> </A>The <TT CLASS="cv">mi_timer_valid</TT> function may not be called at interrupt time. </P> </blockquote><CODE CLASS="Cv.Code"><A NAME="pgfId=14492"> </A>mblk_t* mi_timer_qswitch <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(mblk_t* timerMsg, queue_t* q, mblk_t* newTimerMsg);</CODE><P CLASS="T1.Text1"><A NAME="pgfId=3491"> </A>This function is called to change the target queue of a timer message. The caller must be in a context that blocks delivery of the timer message to the target queue's put or service routine during the call. For example, the caller must already be in a put or service routine and won't be processing a timer message reentrantly. </P><P CLASS="T1.Text1"><A NAME="pgfId=3492"> </A>The <TT CLASS="cv">timerMsg</TT> parameter is the timer message that is to be moved to the new queue. The <TT CLASS="cv">q</TT> parameter is the new target queue for the timer message. The <TT CLASS="cv">newTimerMsg</TT> parameter is a copy of the timer message that is pointed to by <TT CLASS="cv">timerMsg</TT>. The routine returns a pointer to the timer message that lives on--either <TT CLASS="cv">timerMsg</TT> or <TT CLASS="cv">newTimerMsg</TT>. The other message is freed. If no new message is provided (<TT CLASS="cv">newTimerMsg</TT> is <TT CLASS="cv">null</TT>), but a message is required to do the switch successfully, a <TT CLASS="cv">null</TT> pointer is returned. Both <TT CLASS="cv">timerMsg</TT> and <TT CLASS="cv">newTimerMsg</TT> are copies of the same message. On return, these pointers must be treated as invalid pointers and only the function return pointer can be considered valid.</P></DIV><HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 26 March 99)<P><A HREF="PCI_BOOK.220.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.222.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.224.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>