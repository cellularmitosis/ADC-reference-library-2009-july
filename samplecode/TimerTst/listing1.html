<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>TimerTst - /TimerTst.a</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; <A HREF="javascript:location.replace('index.html');">TimerTst</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/idxAppleHardware-date.html" target="_blank">Hardware & Drivers > Apple Hardware</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">TimerTst</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/TimerTst.a</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/TimerTst.a</option></select>
				</p>
				</form>
				<p><strong><a href="TimerTst.zip">Download Sample</a></strong> (&#147;TimerTst.zip&#148;, 3.4K)<BR>
<strong><a href="TimerTst.dmg">Download Sample</a></strong> (&#147;TimerTst.dmg&#148;, 61.9K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">*****************************************************************************    TimerTst***    **************************************************************************          STRING  ASIS          INCLUDE 'Traps.a'          INCLUDE 'QuickEqu.a'          INCLUDE 'SysEqu.a'          PRINT  ON          BLANKS      OFF   ; allow comments without semicolonsT1Arbitrate EQU    $B3F     ; (byte) $FF if Timer T1 up for grabs.  ; VIA OffsetsvBufB      EQU    0      ; BUFFER BvBufAH      EQU    $200    ; buffer a (with handshake) [ Dont use! ]vDIRB      EQU    $400    ; DIRECTION BvDIRA      EQU    $600    ; DIRECTION AvT1C      EQU    $800    ; TIMER 1 COUNTER (L.O.)vT1CH      EQU    $A00    ; timer 1 counter (high order)vT1L      EQU    $C00    ; TIMER 1 LATCH (L.O.)vT1LH      EQU    $E00    ; timer 1 latch (high order)vT2C      EQU    $1000    ; TIMER 2 LATCH (L.O.)vT2CH      EQU    $1200    ; timer 2 counter (high order)vSR       EQU    $1400    ; SHIFT REGISTERvACR      EQU    $1600    ; AUX. CONTROL REG.vPCR      EQU    $1800    ; PERIPH. CONTROL REG.vIFR      EQU    $1A00    ; INT. FLAG REG.vIER      EQU    $1C00    ; INT. ENABLE REG.vBufA      EQU    $1E00    ; BUFFER AvBufD      EQU    $1E00    ; disk head select buffer********** Types *********** To illustrate how the template type feature works the following templates are* declared and used instead of the simple offsets defined in the equate files.* By using these, the Assember source appromixates very closely the Pascal* source for referencing the corresponding information.  Perhaps someday we will* have a set of &quot;equate&quot; files that define types just like Pascal USES units do!Point      RECORD      0      Point = RECORD CASE INTEGER OFv        DS.W      1            1: (v: INTEGER;h        DS.W      1              h: INTEGER);        ORG       v            2: (vh: ARRAY[1..2]vh        DS.W      h                 OF INTEGER)        ENDR                END;Rect      RECORD      0      Rect  = RECORD CASE INTEGER OFtop       DS.W      1            1: (top:    INTEGER;left      DS.W      1              left:   INTEGER;bottom      DS.W      1              bottom: INTEGER;right      DS.W      1              right:  INTEGER);        ORG       toptopLeft     DS.L      Point          2:  (topLeft:  Point;botRight    DS.L      Point          3:  (botRight: Point)        ENDR                END;BitMap      RECORD      0      BitMap = RECORDbaseAddr    DS.L      1            baseAddr: QDPtr;rowBytes    DS.W      1            rowBytes: INTEGER;bounds      DS.L      Rect          bounds:   Rect        ENDR                END;EventRecord   RECORD      0      EventRecord = RECORDwhat      DS.W      1            what:    INTEGER;message     DS.L      1            message:   LONGINT;when      DS.L      1            when:    LONGINT;where      DS.L      Point          where:     Point;modifiers    DS.W      1            modifiers: INTEGER        ENDR                END;        EJECT************************ QuickDraw's Globals ************************* The following data module is used to define the QuickDraw global data area.*        -----------QuickDraw    RECORD      ,DECREMENTthePort     DS.L      1white      DS.B      8black      DS.B      8gray      DS.B      8ltGray      DS.B      8dkGray      DS.B      8arrow      DS.B      cursRecscreenBits    DS.B      BitMaprandSeed    DS.L      1        ORG       -grafSize        ENDR******************************** Entry *******************************Entry  MAIN    ALIGN 2    WITH      QuickDraw    bra.s    real              ;jump around handler and globals    ******************************* Globals ******************************oldVector  DC.L  0                ;old timer 1 vectorvalid    DC.B  0                ;validity check for apppad      DC.B  0                ;pad for even addressesWhere    DC.W  0counter    DC.L  0WndPtr    DC.L  0                ;my window pointerWhichWnd  DC.L  0clrRect    DC.L  0      DC.L  0theStr    DC.L  0                ;this'll be a string when it grows up      DC.L  0      DC.L  0      DC.L  0      DC.L  0                ;that oughta be enough (19 chars + count)******************************* Handler ******************************myHandler      movem.l    a0/d0,-(a7)    lea      valid,a0    clr.b    (a0)              ;mark counter invalid    lea      counter,a0    addq.l    #1,(a0)              ;bump our counter    lea      valid,a0    st.b    (a0)              ;mark count valid    MOVE.L    VIA,A0              ; get VIA base address    MOVE.B    vT1C(A0),D0           ;clear interrupt flag    movem.l    (a7)+,a0/d0    rts    ****************************** Main Code *****************************real      btst.b    #7,T1Arbitrate          ;see if time one is free    beq      outtahere            ;hi bit clear means timer in use        move.b    #1,T1Arbitrate          ;claim it        PEA     thePort             ;Initialize QuickDraw    _InitGraf    _InitFonts                  ;Initialize Font Manager    MOVE.L    #$0000FFFF,D0          ;Discard any previous events    _FlushEvents                ;FlushEvents(EventEvent, 0);    _InitWindows                ;Initialize Window Manager    clr.l    -(a7)              ;room for pointer (result)    move.w    #256,-(a7)            ;push resource ID    clr.l    -(a7)              ;wStorage is nil, let WMgr handle storage    move.l    #-1,-(a7)            ;make it the top window    _GetNewWindow    lea      WndPtr,a0    move.l    (a7)+,(a0)            ;get our pointer    tst.l    (a0)              ;make sure it's not nil    beq      outtahere            ;nil pointer, so give up        move.l    WndPtr,-(a7)    _SetPort        lea      oldVector,a0    move.l    LVL1DT+$18,(a0)          ;keep the old vector around    lea      myHandler,a0    move.l    a0,LVL1DT+$18        lea      clrRect,a0    move.l    #$00200000,(a0)    move.l    #$004000FF,4(a0)        MOVE.L    VIA,A0              ; get VIA base address    OR.B    #$40,VACR(A0)          ; turn on continous interrupts    MOVE.W    #100,D0              ; ticks per half-cycle (&lt;C541 18dec86 mgl&gt; corrected value)    MOVE.B    D0,vT1C(A0)           ; Load low byte into counter/latch.    ROR.W    #8,D0              ; Get high byte.    MOVE.B    D0,vT1CH(A0)          ; Load high byte and off we go!    or.b    #$C0,vIER(a0)          ; enable timer 1 interrupts    theLoop    move.w    #5,-(a7)            ;horizontal point    move.w    #25,-(a7)            ;vertival point    _MoveTo        lea      theStr,a0    lea      valid,a1validLoop    tst.b    (a1)    beq.s    validLoop    move.l    counter,d0    move.w    #0,-(a7)    _Pack7                    ;do a NumToString        move.l    WndPtr,a0    pea      PortRect(a0)    _EraseRect    pea      theStr    _DrawString        clr.w    -(a7)    _button                    ;see if mouse is down    tst.b    (a7)+    beq.s    theLoop            quit      move.l    WndPtr,-(a7)    _CloseWindow      MOVE.L    VIA,A0              ; get VIA base address    move.b    #$40,vIER(a0)          ; disable timer 1 interrupts    MOVE.b    #0,D0              ;kill de timers?    MOVE.B    D0,vT1C(A0)           ; Load low byte into counter/latch.    MOVE.B    D0,vT1CH(A0)          ; Load high byte and off we go!        move.l    ticks,d0            ;give any interrupts laying around a chance\xC9delayLoop                      ;call me paraniod    move.l    ticks,d1    sub.l    d0,d1    cmp.l    #10,d1    ble.s    delayLoop    move.l    oldVector,LVL1DT+$18      ;restore the old timer 1 vector    move.b    #$FF,T1Arbitrate        ;mark timer free    outtahere      _exitToShell    END</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/TimerTst/listing1.html%3Fid%3DDTS10000029-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/TimerTst/listing1.html%3Fid%3DDTS10000029-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/TimerTst/listing1.html%3Fid%3DDTS10000029-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>