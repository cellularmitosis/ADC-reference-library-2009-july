<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>PreLoginAgents - /Read Me About PreLoginAgents.txt</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/Cocoa/index.html">Cocoa</a> &gt; <a href="../../samplecode/Cocoa/idxProcessManagement-date.html">Process Management</a> &gt; <A HREF="javascript:location.replace('index.html');">PreLoginAgents</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->


	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">PreLoginAgents</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/Read Me About PreLoginAgents.txt</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/PreLoginAgentCarbon/main.c</option>
<option value="listing2.html">/PreLoginAgentCocoa/main.m</option>
<option value="listing3.html">/Read Me About PreLoginAgents.txt</option></select>
				</p>
				</form>
				<p><strong><a href="PreLoginAgents.zip">Download Sample</a></strong> (&#147;PreLoginAgents.zip&#148;, 24.2K)<BR>
<strong><a href="PreLoginAgents.dmg">Download Sample</a></strong> (&#147;PreLoginAgents.dmg&#148;, 75.9K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">Read Me About PreLoginAgents
============================
1.0

Mac OS X 10.5 introduced the ability to run a launchd agent while the login
screen is showing.  Such pre-login launchd agents are the best solution to a
small but important class of problems.  For example, if you're developing
assistive technology for Mac OS X &lt;http://www.apple.com/accessibility/&gt; and you
want to provide assistance at login time, you will probably need a pre-login
launchd agent.

Creating a pre-login launchd agent is trivial.  However, displaying UI from
such an agent does present some unique challenges.  This sample includes example
pre-login launchd agents that display UI using both AppKit and HIToolbox.

Pre-login launchd agents were introduced in Mac OS X 10.5, and these samples
require that release.  If you need to support earlier systems, you will have to
use a system login item.  Please contain &lt;dts@apple.com&gt; for the details.

Packing List
------------
The sample contains the following items:

o Read Me About PreLoginAgents.txt -- This file.

o PreLoginAgentCocoa -- A pre-login launchd agent that uses AppKit to display a
window.
o PreLoginAgentCarbon -- A pre-login launchd agent that uses HIToolbox to
display a window.

Each sample includes the following files (where &quot;Xxx&quot; is either &quot;Cocoa&quot; or
&quot;Carbon&quot;):

o com.apple.dts.PreLoginAgentXxx.plist -- The launchd property list file for
the agent.

o main.[cm] -- The core code for the agent.

o main.nib and Info.plist  -- Resources for the agent.

o PreLoginAgentXxx.xcodeproj -- An Xcode 3.0 project for the agent.

o build -- Pre-built binaries.

Using the Sample
----------------
The following instructions explain how to install one of these samples.  Some
steps show different commands for the &quot;Cocoa&quot; and &quot;Carbon&quot; flavours of the
sample; you should run just one of these commands depending on what flavour you
want to install.

1. Download and unpack the sample on your desktop.

2. Change into the sample directory.

$ cd Desktop/PreLoginAgents

3. Make a secure &quot;/Library/PrivilegedHelperTools&quot; directory.

$ sudo mkdir -p /Library/PrivilegedHelperTools
Password:********
$ sudo chown root:wheel /Library/PrivilegedHelperTools

Pre-login launchd agents are run as root and it is not appropriate to place
them in any directory that an admin user can modify without authenticating.

3. Copy the agent to &quot;/Library/PrivilegedHelperTools&quot;.

$ sudo cp -R PreLoginAgentCocoa/build/Debug/PreLoginAgentCocoa.app \
/Library/PrivilegedHelperTools/

$ sudo cp -R PreLoginAgentCarbon/build/Debug/PreLoginAgentCarbon.app \
/Library/PrivilegedHelperTools/

4. Copy the property list file to &quot;/Library/LaunchAgents&quot;.

$ sudo cp PreLoginAgentCocoa/com.apple.dts.PreLoginAgentCocoa.plist \
/Library/LaunchAgents/

$ sudo cp PreLoginAgentCarbon/com.apple.dts.PreLoginAgentCarbon.plist \
/Library/LaunchAgents/

5. Log out.

At the login screen you will see a window displaying the name of the sample. 
When you log in, the agent will quit and the window will go away.

Building the Sample
-------------------
Each sample was built using Xcode 3.0 on Mac OS X 10.5.  You should be able to
just open a project and choose Build from the Build menu.  This will build the
agent in the &quot;build&quot; directory.

Security
--------
IMPORTANT: Pre-login launchd agents are privileged programs; you must code
carefully to maintain system security.

A pre-login launchd agent is run as root.  This makes a certain kind of sense
in that the agent executes before any user has logged in.  However, it does
present some security issues.  These are exacerbated by the fact that it's
likely that your agent will want to use GUI frameworks, and using GUI frameworks
from a root process is a serious security concern.

There really is no over-arching solution to this problem.  Rather, there are a
number of things that you can do to minimise the risk.

o Your agent must not display a menu bar.  Rather, your agent should either be
background-only program or a UI element.  You can achieve this by setting either
the &quot;LSBackgroundOnly&quot; or &quot;LSUIElement&quot; property in your &quot;Info.plist&quot;.

o You should try to keep your agent's user interface as simple as possible to
reduce the likelihood of security problems.  For example, if you display a text
field, you have to worry about whether contextual menu items can be used in that
field.  OTOH, if you don't display a text field, you don't have to worry.

WARNING:
Mac OS X's security infrastructure gets around this problem by running its GUI
code as a special user, &quot;_securityagent&quot;.  It's hard for third party code to
replicate this behaviour because there is no mechanism or policy to create
specialist users like this on Mac OS X.  It is /vital/, however, that you not
run your agent as &quot;_securityagent&quot;.  Doing so could potentially compromise
system security.

Similarly, you should not reuse other specialist users on the system (for
example, &quot;nobody&quot; or &quot;_mdnsresponder&quot;).

Note:
launchd does not currently honour the &quot;UserName&quot; and &quot;GroupName&quot; properties in
the launchd property list file for a pre-login launchd agent
&lt;rdar://problem/5337257&gt;.

Logging
-------
The samples log using the Apple System Log &lt;x-man-page://3/asl&gt; API.  Do the
following to see the log entries.

1. SSH into the machine.

2. Enable 'info' level logging with the following command:

$ sudo syslog -c syslogd -i
Password:********

3. Wait and print new log messages use:

$ syslog -w
[...]

Quit and Relaunch
-----------------
A launchd agent is not quite like a typical application (that is, by way of the
'quit' Apple event).  Rather, when the system wants your agent to quit, it will
send it a SIGTERM.  The code shows a simple technique for catching SIGTERM in a
run-loop friendly fashion (see the routine InstallHandleSIGTERMFromRunLoop,
present in both samples).

Also, if your agent quits, launchd will, by default, relaunch it.  You can
control this behaviour using various properties in your launchd property list
file &lt;x-man-page://5/launchd.plist&gt;.

Window Visibility
-----------------
Because of its unique execution environment, a pre-login launchd agent must do
some special things to ensure that its windows are visible.  Specifically:

o To prevent windows accidentally showing up at login time, Mac OS X 10.5 and
later require that you specifically bless such a window before it can appear on
the screen.  For an NSWindow, you must call -[NSWindow
setCanBecomeVisibleWithoutLogin:].  For a HIToolbox window, you must set the
kHIWindowBitCanBeVisibleWithoutLogin attribute.

o Finally, due to an artefact of the relationship between the UI frameworks and
the window server &lt;rdar://problem/5136400&gt;, you must take extra-ordinary steps
to show your window:

- For an NSWindow window, calling -[NSWindow orderFront:] is not sufficient;
you must call -[NSWindow orderFrontRegardless].

- For an HIToolbox window, calling ShowWindow is not sufficient.  For the
window to actually appear on screen, you must call BringToFront.

Other Gotchas
-------------
Your pre-login launchd agent will be run redundantly when the user switches
directly from user A to user B via the fast user switching menu
&lt;rdar://problem/5136392&gt;.

Credits and Version History
---------------------------
If you find any problems with this sample, mail &lt;dts@apple.com&gt; and I'll try to
fix them up.

1.0 (Oct 2007) was the first shipping version.

Share and Enjoy.

Apple Developer Technical Support
Core OS/Hardware

22 Oct 2007
</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/PreLoginAgents/listing3.html%3Fid%3DDTS10004414-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/PreLoginAgents/listing3.html%3Fid%3DDTS10004414-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/PreLoginAgents/listing3.html%3Fid%3DDTS10004414-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>