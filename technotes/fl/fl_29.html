<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-August-01 --><!-- Includes revisions to graphics tags --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note FL29: Problem with GetVInfo</title><meta name="keywords" content="Mac OS 8 GetVInfo HFS free bytes volume PBGetVInfo"><meta name="Description" content="Technical Note FL29: This Technical Note explains why thevalue returned by GetVInfo may be less than the actual numberof free bytes on a volume. Technote provides code snippets,in Pascal and C, of functions that return the actual numberof free bytes on a volume.">                                       <meta name="categories" content="Files"><meta name="week-posted" content="Aug 31, 1987 - Sep 4, 1987"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002455" title="Problem with GetVInfo"></a><A NAME="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxCarbon-date.html">Carbon</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Carbon/idxFileManagement-date.html" target="_blank">Carbon > File Management</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note FL29</div>
<div id="pageheadsub">Problem with GetVInfo</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext">					<A HREF="#Section1">GetVInfo</a><BR><BR> <A HREF="#References">References</A><BR><BR>   <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><p id = "introtext">The high-level call <code>GetVInfo</code> (and its low-level counterpart <code>PBGetVInfo</code>) may return inaccurate results for <code>freeBytes</code> when running HFS.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Sep 01 1987]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR><!-- begin_content --><a name="Section1"></a><h2>GetVInfo</h2><P>The high-level File Manager call <code>GetVInfo</code> returns the number of free bytes on a volume as one of its parameters. Since <code>GetVInfo</code> is really only glue that fills in a parameter block for you and then calls <code>PBGetVInfo</code>, the values returned from it are subject to the limitations (imposed for MFS) discussed in the File Manager chapter of <i>Inside Macintosh Volume IV</i>(p. 130): "<b>Warning</b>: <code>IOVNmAlBlks</code> and <code>ioVFrBlks</code>, which are actually unsigned integers, are clipped to 31744 (<code>$7C00</code>) regardless of the size of the volume." This will be fixed in future versions of the glue (newer than MPW 2.0.2), but for now, you need to call <code>PBHGetVInfo</code> yourself instead, as shown below.</p><p>The value that <code>GetVInfo</code> returns in <code>freeBytes</code>(<code>ioVFrBlks</code> <code>*</code> <code>ioVAlBlkSize</code>) will thus be <b>less thanor equal to</b> the actual number of free bytes on a volume. This isn'tcatastrophic, but can be highly inconvenient if you really need to know howmuch free space is on a given volume.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR><code>IOVNmAlBlks</code> returned from <code>PB[H]GetVInfo</code> does not reflect the actual total number of blocks on an HFS disk, but rather only the blocks that are "available" for program use (it doesn't count blocks used for catalog information).</P></TD></TR></TABLE></CENTER><BR><p>Here are two functions (one in MPW Pascal, one in MPW C) that return the actualnumber of free bytes on a volume, regardless of File System (if MFS is running,the <code>PBHGetVInfo</code> call will actually generate a <code>PBGetVInfo</code> callwhich will return the proper values for MFS volumes):</p><p>In MPW Pascal:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>FUNCTION FreeSpaceOnVol(vRef:Integer; VAR freeBytes:Longint): OSErr;TYPE    {we need this to convert an unsigned integer to an unsigned    longint}    TwoIntsMakesALong    = RECORD CASE Integer OF 1:    (long: LongInt);    2: (ints: ARRAY [0..1] OF Integer);            END; {TwoIntsMakesALong}VAR    HPB        : HParamBlockRec;    convert    : TwoIntsMakesALong;    err        : OSErr;BEGIN {FreeSpaceOnVol}    WITH HPB DO BEGIN {set up parameter block for the PBGetVInfo call}    ioNamePtr := NIL; {we don't care about the name}    ioVRefNum := vRef;    {this was passed in as a parameter}    ioVolIndex := 0;       {use ioVRefNum only}    END;                 {WITH}    err := PBHGetVInfo(@HPB,false);    FreeSpaceOnVol:= err; {return error from HGetVInfo}{This next section needs some explanation.  ioVFrBlk is an unsigned integer.If we were to assign it(or coerce it) to a longint, it would get sign extendedby MPW Pascal and would thus be negative.  Since we don't want that, we use avariant record that maps two integers into the space of one longint.  The highword (convert.ints[0]) is cleared in the first line, then the low word isassigned the value of HPB.ioVFrBlk.  The resulting longint (convert.long)is now a correctly signed (positive) long integer representing the numberof free blocks.  NOTE:  this is only necessary if the number of free blockson a disk exceeds 32767 ($7FFF).}    IF err = 0 THEN BEGIN        convert.ints[0] := 0;        convert.ints[1] := HPB.ioVFrBlk;            freeBytes:= convert.long * HPB.ioVAlBlkSiz;    END ELSE BEGIN        {PBHGetVInfo failed}        freeBytes:= 0; {return this if the routine failed}    END;END;  {FreeSpaceOnVol}</pre>    </TD></TR></TABLE></CENTER><p>In MPW C:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>    <td bgcolor="#E6E6E6" align=left><pre>OSErr freeSpaceOnVol(vRef,pfreeBytes)short int vRef;unsigned long int *pfreeBytes; /* C does this correctly!! */{    /* freeSpaceOnVol */    HVolumeParam HPB;    OSErr err;    HPB.ioNamePtr = 0L;        /* we don't care about the name */    HPB.ioVRefNum = vRef;     /* this was passed in as a parameter */    HPB.ioVolIndex = 0;        /* use ioVRefNum only */    err = PBHGetVInfo(&amp;HPB,false);    if (err == noErr)        *pfreeBytes = (unsigned long int)HPB.ioVFrBlk * HPB.ioVAlBlkSiz;    else        *pfreeBytes = 0L;    /* return this if the routine failed */    return(err);            /* function result */}    /* freeSpaceOnVol */</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><p>File Manager</p><P><A HREF="#top">Back to top</A></P><P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (48K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/fl_29.pdf">Download</A></P>               </TD>            </TR></table><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/fl/fl_29.html%3Fid%3DDTS10002455-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/fl/fl_29.html%3Fid%3DDTS10002455-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/fl/fl_29.html%3Fid%3DDTS10002455-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --><hr width=500 align=center></BODY></HTML>