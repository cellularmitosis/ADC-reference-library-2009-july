<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1044: Fundamentals of Open Firmware, Part III: Understanding PCI Expansion ROM Choices for Mac OS</title>   <meta name="Description" content="Technical Note TN1044:      [Textual description of documentas you want it to appear in the text     sections of searchengines supporting this field]    "><META NAME="Identifier-URL"Content="http://www.apple.com/metadata/sample.html">    <meta name="keywords" content="Mac OS 8 PCI expansion ROM guidelines Open firmware nodes">    <meta name="Description" content="Technical Note TN1044: This Technical Note addresses PCIexpansion ROM contents for Mac OS 8. The information herealso applies to all Macintosh computers with PCI expansioncapability, such as the Power Macintosh 9500, 8500, and 7500.The Note looks at the basic device types as defined in theIEEE 1275-1994 Open Firmware standard. It defines the recommendedcontents common for all ROMs, as well as the specific recommendedcontents for the various standard device types, excludingbridge devices. Also included is a table of Standard devices,properties and methods."><meta name="categories" content="Hardware"><meta name="week-posted" content="Jun 25, 2001 - Jun 29, 2001"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002886" title="Fundamentals of Open Firmware, Part III: Understanding PCI Expansion ROM Choices for Mac OS"></a><A NAME="top"></A> <!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/HardwareDrivers/index.html">Hardware & Drivers</a> &gt; <a href="../../technicalnotes/HardwareDrivers/idxOpenFirmware-date.html">Open Firmware</a> &gt; </p><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1044</div>
<div id="pageheadsub">Fundamentals of Open Firmware, Part III: Understanding PCI Expansion ROM Choices for Mac OS</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"> <!-- begin_header_box --> <table width="600" cellpadding="0" cellspacing="0" border="0">	<tr>		<td width=300 valign="top" align=left scope="row">			<table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>				</tr>				<tr bgcolor="#e6e6e6">					<td background="images/tnmenubody.gif" width=300 align=left>						<span id="menutitle">							CONTENTS     <BR>    <BR>						</span>					</td>				</tr>				<tr bgcolor="#e6e6e6">					<td background="images/tnmenubody.gif" width=300 align=left>						<p id="menutext">							<A HREF="#Section1">		 Providing Open Firmware Support</A><BR><BR>							<A HREF="#RTFToC2">		 Properties Common To All Device Types</A><BR><BR>							<A HREF="#RTFToC3">		 Standard Device Nodes and Their Properties</A><BR><BR><A HREF="#RTFToC4">Summary</A><BR><BR><A HREF="#references">References</A><BR><BR><A HREF="#Downloads">Downloadables</A><BR></p>											</td>				</tr>				<tr>					<td width=300 align=left scope="row">						<img src="images/tnmenubottom.gif" alt="" width=300 height=16>					</td>				</tr>			</table>		</td>		<td width=300 valign="top" align=left>			<p id="introtext">This Technote addresses PCI expansion ROM contents for Mac OS. Theinformation here also applies to all Macintosh computers with PCIexpansion capability, such as the Power Macintosh 9500, 8500, and7500. The Note looks at the basic device types as defined in the IEEE1275-1994 Open Firmware standard. It defines the recommended contentscommon for all ROMs, as well as the specific recommended contents forthe various standard device types, excluding bridge devices.</p>			<P id = "introtext">This Note is intended for PCI expansion device driver writers. Itcan also be of value to board designers because it discusses thevarious ROM contents that can supersede the values that arehard-coded into PCI Configuration Space. It also addresses why theboard designer might want to constrain the design based on thevarious ROM contents, such as specifying maximum memory requirementsin Configuration Space and particular requirements in the "reg"property -- that is, using the Configuration Space register to definememory requirements for one OS and using properties for another OS.</P><P id = "introtext">This Technote assumes you understand the Open Firmware processintegral to the newer Macintosh computers that use the PCI-I/Oexpansion model. It also assumes you understand "properties" and knowhow to create and use them.</P><!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Jun 26 2001]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR> <!-- begin_content --><P><A HREF="#top">Back to top</A></P><A NAME="Section1"></A><H2>Providing Open Firmware Support</H2><P>Since the ROM contents is ultimately decided by third-partydevelopers, the first issue to address is what level of Open Firmwaresupport the device will provide. This can be divided into thefollowing categories: </P><UL>   <LI>no support</li>      <LI>minimum support</li>      <LI>full support</li></UL><P>For each level of support, this Note addresses what can and cannotbe accomplished by the device for Mac OS or other operating systemsthe device may target.</P><H3>Defining "Boot" and "Runtime" Drivers</H3><P>At this point, before explaining the different levels of OpenFirmware support provided by the device, we need to distinguishbetween "boot" and "runtime" drivers.</P>	<CENTER><TABLE BORDER=0 CELLPADDING=4 WIDTH=525> <TR> <td bgcolor="#e6e6e6" align=left><P><B>Important: </B><BR>      Boot drivers are programmed in FCode, a byte-encoded OS   (Operating System) and ISA (Instruction Set Architecture)   independent form of software. They are used before control has   been passed to the main operating system by Open Firmware and its   client. <BR><BR>      Runtime drivers are OS-dependent and are, in the context of   this Note, Macintosh drivers.</P>	</TD> </TR>	</TABLE></CENTER><H3>No Support of Open Firmware</H3><P>The first type of Open Firmware support is that of no support.This lack of support does not require an expansion ROM at all,although an expansion ROM with no FCode is also contained in thiscategory. However, placing an expansion ROM on a device costs money,and it makes little sense to provide an empty ROM.</P><H4>Problems With This Approach</H4><P>There are problems that you should consider with this type ofsupport: 1) not being plug-and-play, 2) having an ambiguous devicedriver name, 3) wasting memory space, since using base registers onlyallow memory sizes to be multiples of powers of two, and 4) not beingable to define sub-apertures. Sub-apertures are defined using theConfiguration Space base registers. A typical example is a displaydevice with a frame buffer, video controller, and RAMDAC. By definingthree base registers, one for each function on the device, familiescan write memory differently than they do registers. This is usefulfor caching.</P><H4>No Plug-and-Play</H4><P>Without an expansion ROM, the device won't be plug and play. Norwill it be available to the user until the file system is initializedbecause the driver container must be placed on a hard disk and loadedfrom there. Note that the driver container does not necessarily haveto be place on a hard disk: it could, for example, be located on anetwork. However, the device and driver will be matched and loaded.</P><H4>Ambiguous Device Driver Name</H4><P>Another issue to consider is that a distinct device "name"property cannot be provided when there is no expansion ROM. Thismakes unique device/driver matching ambiguous. For example, twomanufacturers may supply a similar driver for a particular device, ora chip vendor may rev a PCI interface chip used on your device. OpenFirmware during its probing process first looks for a name propertyin the Expansion ROM. It then looks for the Subsystem ID andSubsystem Vendor ID. And finally, it will choose the Device ID andVendor ID if the name property is not defined and the Subsystem IDand Subsystem Vendor ID are zero.</P><P>Runtime drivers may fall into the no-support category but bootdrivers cannot exist without an expansion ROM and therefore do notbelong in this category.</P><P>The no-support category is populated mostly by applicationscontrolling a device via a private driver. The device is notavailable to other applications. Since the name may not be unique,the driver should provide additional software to make sure that thedevice it has been matched with by the operating system is indeed itsdevice. This could be some sort of a signature diagnostic. Forinstance, all drivers have a validateHardware interface that iscalled by the family that instantiates the driver to validate thatthe match is correct and the device is functional.</P><H3>Minimum Support of Open Firmware</H3><P>To achieve minimum support requires an expansion ROM. Minimumsupport or Run Time Support requires a driverproperty. It should also include a "name" property. This willeliminate ambiguous driver/devices matching and provideplug-and-play.</P><H3>Full Support of Open Firmware</H3><P>The last category -- full support -- includes but is not limitedto unambiguous driver/device matching, plug-and-play support, andboot support. The presence of a "name" property in the ROM guaranteesmatching, the presence of a runtime driver in the ROM guaranteesplug-and-play, and the presence of a boot driver guarantees OpenFirmware driver support such as display and network devices.</P><P><A HREF="#top">Back to top</A></P><P><A NAME="RTFToC2"></A></P><H2>Properties Common To All Device Types</H2><P>Given that your device has an expansion ROM, there are propertiescommon to all devices as well as device-specific properties. Whatfollows is an introduction to those properties that are defined bythe IEEE 1275-1994 Specification, the PCI Binding Specification, andApple Computer.</P><H3>The "name" Property</H3><P>The "name" property is uniquely used to define the name of yournode in the Open Firmware device tree. This is also the name of yourdevice. This is the only required property. If you do not supply thisproperty, the Open Firmware is obliged to construct one on yourbehalf because it is required. This is the algorithm. The OpenFirmware probing process first looks for FCode to define thisproperty in the device tree. If it is not present, it then uses theSubsystem ID and SystemVendor ID that is hard-wired in ConfigurationSpace on your device. If those fields are zero, it then uses theVendor ID and Device ID also in the Configuration Space. It willconstruct a "name" property of the form pcixxxx,yyyy. The yyyy fieldcan be the System ID or Device ID while the xxxx field can be aSubsystemVendor ID or Vendor ID.</P><H3>The "reg" Property</H3><P>The "reg" property is used to define your device's PCImemory-mapped areas including I/O space. If a "reg" property iscontained in your expansion ROM, it will be used. If not, the OpenFirmware probing process constructs one for you. It does so bywriting all 1's to the Base Address Registers. (0x10 through 0x24) inConfiguration Space. It then reads back the values. These registersare hardwired in powers of two to define your memory needs. Bitsreturning a zero effectively define the memory requirements. See thePCI Local Bus Specification Revision 2.1 Section 6.2.5 Base Addressesfor details. A word about the "assigned-addresses" property. Thisproperty is also generated during the probing process from the "reg"property. It is not, however, contained in the expansion ROM but isplaced in the device tree.</P><H3>The "device-type" Property</H3><P>The "device-type" property defines the device by function such asdisplay, network, block, and so on. A word of caution is required.All device types except type PCI to PCI bridges use a PCIConfiguration Register Map. Bridges use a PCI-to-PCI Bridge RegisterMap. See <I>Designing PCI Cards and Drivers for Power MacintoshComputers</I>, Chapter 4, "Startup &amp; System Configuration,"Figures 4-1 and 4-2 for details.</P><H3>The "interrupts" Property</H3><P>Use this property to define whether your device can generateinterrupts. Its absence defines no interrupt needs. Since allinterrupt pins on the PCI bridge chip are "ORed" together, there canbe only one interrupt source on your device. Your device will berequired to supply, in the case of multiple sources, a method for thedriver to determine which source is the one requiring service.</P><H3>The "model" Property</H3><P>The model number or name of your device.</P><H3>The "address" Property</H3><P>Used to define large virtual address regions. Currently unused byOpen Firmware.</P><H3>The "compatible" Property</H3><P>Used to define alternate "name" property values. You wouldtypically use this property to tell the Open Firmware that there areother device choices that can be matched with a driver, given theoriginal "name" property could not be matched. The compatibleproperty allows other drivers to match against your device. Forexample, consider an XYZ networking card that is register-compatiblewith an Apple networking card. In this case, the name property wouldbe "XYZ,xxx,yyy" and, correspondingly, the compatible property wouldbe AAPL,xxx,yyy".</P><H3>The "status" Property</H3><P>The status of your device. Use this when you run diagnostics onyour device during the Open Firmware boot process and you wish toreport the results to Open Firmware. Currently unused by OpenFirmware.</P><P><A HREF="#top">Back to top</A></P><P><A NAME="RTFToC3"></A></P><H2>Standard Device Nodes and Their Properties</H2><P>That concludes our discussion of the properties that are common toall device nodes. Now let's look at some standard device nodes andtheir properties. The most common five are: "block", "byte","display", "network", and "serial".</P>	<CENTER><TABLE BORDER=1 CELLPADDING=4 WIDTH=525>	<TR> <td colspan=3 align=left>	<P><B>Table 1: </B> Standard devices, properties and methods</P>	</TD></TR>	<TR>	  <td align="left"><P><B>Device</B></P></TD>	  <td align="left"><P><B>Property</B></P></TD>	  <td align="left"><P><B>Function</B></P></TD>	</TR>		<TR> <td colspan=3 align=left>	<hr width=500 align=center>	</TD></TR>	<TR>	  <td align="left"><P>block</P></TD>	  <td align="left"><P>open</P></TD>	  <td align="left"><P>Prepares device for use</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>close</P></TD>	  <td align="left"><P>Closes previously opened device</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>read</P></TD>	  <td align="left"><P>Moves device memory contents to main                                     memory</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>write</P></TD>	  <td align="left"><P>Moves main memory contents to device                                     memory</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>seek</P></TD>	  <td align="left"><P>Sets device position</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>load</P></TD>	  <td align="left"><P>Loads a client program from device to      			main memory<BR>			<B>Note: </B> To be bootable, block devices must   			support disk-label and deblocker packages and			implement associated methods, such as read-blocks.</P>	  </TD>	</TR>	<TR>	  <td align="left"><P>byte</P></TD>	  <td align="left"><P>open</P></TD>	  <td align="left"><P>Prepares device for use</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>close</P></TD>	  <td align="left"><P>Closes previously opened device</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>read</P></TD>	  <td align="left"><P>Moves device memory contents to main                                     memory</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>write</P></TD>	  <td align="left"><P>Moves main memory contents to device                                     memory</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>seek</P></TD>	  <td align="left"><P>Sets device position</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>load</P></TD>	  <td align="left"><P>Loads a client program from device to                                    main memory</P></TD>	</TR>	<TR>	  <td align="left"><P>display</P></TD>	  <td align="left"><P>open</P></TD>	  <td align="left"><P>Prepares device for use</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>close</P></TD>	  <td align="left"><P>Closes previously opened device</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>write</P></TD>	  <td align="left"><P>Puts characters on boot screen</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>draw-logo</P></TD>	  <td align="left"><P>Calls the FCode function to draw                                         caller's bit-mapped logo</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>restore</P></TD>	  <td align="left"><P>Resets your device</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>character-set</P></TD>	  <td align="left"><P>Defines which standard set of characters                your device supports, such as ISO8859-1</P></TD>	</TR>	<TR>	  <td align="left"><P>network</P></TD>	  <td align="left"><P>open</P></TD>	  <td align="left"><P>Prepares device for use</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>close</P></TD>	  <td align="left"><P>Closes previously opened device</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>read</P></TD>	  <td align="left"><P>Moves device memory contents to main                                     memory</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>write</P></TD>	  <td align="left"><P>Moves main memory contents to device                                     memory</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>load</P></TD>	  <td align="left"><P>Loads a client program from device to                                    main memory</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>local-mac-address</P></TD>	  <td align="left"><P>The preassigned network address. The mac                                 stands for Media Access Control and                                      should not be confused with the                                          Macintosh.</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>mac-address</P></TD>	  <td align="left"><P>Contains the last used network address</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>address-bits</P></TD>	  <td align="left"><P>Contains the length of the network                                       address</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>max-frame-size</P></TD>	  <td align="left"><P>Contains the maximum packet size</P></TD>	</TR>	<TR>	  <td align="left"><P>serial</P></TD>	  <td align="left"><P>open</P></TD>	  <td align="left"><P>Prepares device for use</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>close</P></TD>	  <td align="left"><P>Closes previously opened device</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>read</P></TD>	  <td align="left"><P>Moves device memory contents to main                                     memory, i.e., character</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>write</P></TD>	  <td align="left"><P>Moves main memory contents to device                                     memory, i.e., character</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>restore</P></TD>	  <td align="left"><P>Resets your device</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>install-abort</P></TD>	  <td align="left"><P>When used, polls for a console abort                                     sequence</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>remove-abort</P></TD>	  <td align="left"><P>Reverses the effect of install-abort</P></TD>	</TR>	<TR>	  <td align="left"><P></P></TD>	  <td align="left"><P>ring-bell</P></TD>	  <td align="left"><P>Need no further comment</P></TD>	</TR>		<TR> <td colspan=3 align=left>	<hr width=500 align=center>	</TD></TR>	</TABLE></CENTER>    <BR><BR>	<P><A HREF="#top">Back to top</A></P><P><A NAME="RTFToC4"></A></P><H2>Summary</H2><P>This Technote introduces you to the possible expansion ROMcontents for all PCI Macintosh computers. The least riskychoice between no ROM, minimum ROM, and full ROM is, of course, fullsupport, but the actual decision is constrained by how the board willbe used. This Note is intended to make you aware of your ROM-contentchoices.</P><P>A closing caveat is that devices of type 'ndrv' or IOKit were not discussed inthis Note. These Apple-derived types allow developers tomove to PCI before certain families are introduced into the OS. Withtime, all device types should use families. However, 'ndrv' is avalid type and can be used. Having an expansion ROM on a 'ndrv' or IOKitdevice can allow the driver writer to at least generate a "name"property with its unambiguous value. This alone will prevent athird-party manufacturer from having to recall its drivers to reviseits DriverDescription data structure.</P><P><A HREF="#top">Back to top</A></P><BR><A NAME=references></A>                  <H2>References</H2>   <p>Starting FORTH; Brody</p>      <p>Writing FCode Program for PCI</p>      <p>PCI Local Bus Specification Revision 2.1</p>            <p><A HREF = "tn1061.html">Technote   1061 - Fundamentals of Open Firmware, Part I: The User   Interface</A>,&nbsp; provides an overview of using Forth   and the Open Firmware user interface.</p>                        <p><A HREF = "tn1062.html">Technote   1062 - Fundamentals of Open Firmware, Part II: The Device   Tree</A>,&nbsp; is intended to get you started with the   device tree.</p>            <P><A HREF="#top">Back to top</A></P>         <P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (72K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tn1044.pdf">Download</A></P>               </TD>            </TR></TABLE><P><A HREF="#top">Back to top</A></P></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1044.html%3Fid%3DDTS10002886-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1044.html%3Fid%3DDTS10002886-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1044.html%3Fid%3DDTS10002886-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>