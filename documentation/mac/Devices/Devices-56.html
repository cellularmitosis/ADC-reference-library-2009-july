<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Using the Slot Manager(IM: D)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>

<A NAME="HEADING56"></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->




<!-- Main Body -->

<CENTER>
<P>
<A HREF="Devices-55.html"><IMG ALIGN="BOTTOM" SRC="prev.gif" BORDER="none" HSPACE="20" ALT="Previous"></A> <A HREF="Devices-2.html"><IMG ALIGN="BOTTOM" SRC="content.gif" BORDER="none" HSPACE="20" ALT="Book Contents"></A> <A HREF="Devices-328.html"><IMG ALIGN="BOTTOM" SRC="index.gif" BORDER="none" HSPACE="20" ALT="Book Index"></A> <A HREF="Devices-57.html"><IMG ALIGN="BOTTOM" SRC="next.gif" BORDER="none" HSPACE="20" ALT="Next"></A> </CENTER><P>
<FONT SIZE="-1"><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Devices-2.html"><B>Devices</B></A> / <BR><DD><A HREF="Devices-53.html"><B>Chapter 2 - Slot Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME="HEADING56-0"></A>
<H1><A NAME="MARKER-9-121"></A>Using the Slot Manager</H1>
 The Slot Manager allows you to enable and disable NuBus cards, manipulate the slot resource table, get information from slot information records, get status information, and read and change expansion cards' parameter RAM. However, the majority of Slot Manager routines search for sResources in the slot resource table or provide information from these structures.<P>
 The Slot Manager provides a variety of methods to find an sResource. These methods include searching for an sResource with a particular sResource ID, searching for an sResource with a particular sResource type, searching through all sResources, searching through only the enabled sResources, and so on.<P>
 The Slot Manager also provides a number of routines that return information from sResources. Some of these routines, like the <A NAME="MARKER-2-348"></A><CODE>SReadByte</CODE> and <A NAME="MARKER-2-349"></A><CODE>SGetCString</CODE> functions, return one particular type of data structure. Others, like the <A NAME="MARKER-2-350"></A><CODE>SFindStruct</CODE> function, can return information about any data structure. Functions such as <CODE><A NAME="MARKER-2-351"></A>SGetDriver</CODE> and <A NAME="MARKER-2-352"></A><CODE>SExec</CODE> not only return information from an sResource, they also perform additional operations like loading the sResource's driver or executing the code of an <CODE>sExecBlock</CODE> data structure.<P>
 You can use the <CODE>SVersion</CODE> function, described on <A HREF="Devices-67.html#MARKER-9-273">page 2-30</A>, to determine if the Slot Manager is version 1, version 2, or a version that predates System 7.<A NAME="MARKER-2-33"></A><P>
<A NAME="HEADING56-5"></A>
<H2><A NAME="MARKER-9-128"></A><A NAME="MARKER-2-129"></A><A NAME="MARKER-2-130"></A>Enabling and Disabling NuBus Cards</H2>
 Version 1 and later of the Slot Manager allows you to temporarily disable your NuBus card. You might want to do this if, for example, you are designing a NuBus card that must be addressed in 32-bit mode or that requires RAM-based system software patches to be loaded into memory before the card is initialized. Your <CODE>PrimaryInit</CODE> code can disable the card temporarily and the <CODE>SecondaryInit</CODE> code can reenable it. <P>
 To disable a NuBus card temporarily, the initialization routine in your <CODE>PrimaryInit</CODE> record should return in the <CODE>seStatus</CODE> field of the <CODE>SEBlock</CODE> data structure (described in <A HREF="Devices-63.html#MARKER-9-251">"Slot Execution Parameter Block" on page 2-27</A>) an error code with a value in the range <CODE>svTempDisable</CODE> ($8000) through <CODE>svDisabled</CODE> ($8080). The Slot Manager places this code in the <CODE>siInitStatusV</CODE> field of the slot information record for the slot, and places the fatal error <CODE>smInitStatVErr</CODE> (-316) in the <CODE>siInitStatusA</CODE> field of the slot information record. The card and its sResources are then unavailable for use by the Operating System.<P>
 After the Operating System loads RAM patches, the Slot Manager checks the value of the <CODE>siInitStatusA</CODE> field of each slot information record. If this value is greater than or equal to 0, indicating no error, the Slot Manager executes the <CODE>SecondaryInit</CODE> code for the slot, if any. If the value in the <CODE>siInitStatusA</CODE> field is <CODE>smInitStatVErr</CODE>, the Slot Manager checks the <CODE>siInitStatusV</CODE> field. If the value of the <CODE>siInitStatusV</CODE> field is in the range <CODE>svTempDisable</CODE> through <CODE>svDisabled</CODE>, the Slot Manager sets the <CODE>siInitStatusA</CODE> field to 0 and runs the <CODE>SecondaryInit</CODE> code.<P>
 For examples of <CODE>PrimaryInit</CODE> and <CODE>SecondaryInit</CODE> code, see <I>Designing Cards and Drivers for the Macintosh Family, </I>third edition.<P>
<A NAME="HEADING56-10"></A>
<H2><A NAME="MARKER-9-131"></A><A NAME="MARKER-2-358"></A><A NAME="MARKER-2-133"></A>Deleting and Restoring sResources</H2>
 Some NuBus cards have sResources to support a variety of system configurations or modes. The Slot Manager loads all of the sResources during system initialization, and then the card's <CODE>PrimaryInit</CODE> code can delete from the slot resource table any sResources that are not appropriate for the system as configured. If the user changes the system configuration or selects a different mode of operation, your card can reinstall a deleted sResource. The <CODE><A NAME="MARKER-8-55"></A>SDeleteSRTRec</CODE> function deletes sResources; the <CODE>InsertSRTRec</CODE> function reinstalls them.<P>
 Because none of the Slot Manager functions can search for sResources that have been deleted from the slot resource table, you must keep a record of all sResources you delete so that you will have the appropriate parameter values when you want to reinstall one.<P>
 <A NAME="MARKER-4-136"></A><A NAME="MARKER-4-137"></A>When you reinstall an sResource, it may be necessary to update the <CODE>dCtlSlotId</CODE> and <CODE>dCtlDevBase</CODE> fields in the slot device driver's device control entry. You need to update the <CODE>dCtlSlotId</CODE> field if you change the sResource ID. The <CODE>dCtlDevBase</CODE> field holds the base address of the slot device. For a video card this is the base address for the pixel map in the card's <CODE>GDevice</CODE> record (which is described in <I><A HREF="../QuickDraw/QuickDraw-2.html">Inside Macintosh: Imaging With QuickDraw</A></I>). The <A NAME="MARKER-2-337"></A><CODE>InsertSRTRec</CODE> function updates the <CODE>dCtlDevBase</CODE> field automatically if you supply a valid driver reference number. <A NAME="MARKER-2-359"></A><P>
<A NAME="HEADING56-14"></A>
<H2><A NAME="MARKER-9-140"></A><A NAME="MARKER-2-361"></A><A NAME="MARKER-2-362"></A>Enabling and Disabling sResources</H2>
 Under certain circumstances, you might want to disable an sResource while it remains listed in the slot resource table. For example, a NuBus card might provide several modes of operation, only one of which can be active at a given time. Your application might want to disable the sResources associated with all but the active mode, but still list all available modes in a menu. When the user selects a new mode, your application can then disable the currently active sResource and enable the one the user selected.<P>
 You use the <A NAME="MARKER-2-363"></A><CODE>SetSRsrcState</CODE> function to enable or disable an sResource. <A HREF="#MARKER-9-144">Listing 2-1</A> disables the sResource in slot $A with an sResource ID of 128 and enables the sResource in the same slot with an sResource ID of 131.<P>
<B>Listing 2-1  <A NAME="MARKER-9-144"></A>Disabling and enabling an sResource</B><P>
<PRE>
PROCEDURE MyDisableAndEnableSResource;
VAR
   mySpBlk:    SpBlock;
   myErr:      OSErr;
BEGIN
   WITH mySpBlk DO      {set required values in parameter block}
   BEGIN
      spParamData := 1;       {disable}
      spSlot := $A;           {slot number}
      spID := 128;            {sResource ID}
      spExtDev := 0;          {ID of external device}
   END;
   myErr := SetSRsrcState(@mySpBlk);
   IF myErr = noErr THEN 
   BEGIN
      WITH mySpBlk DO 
      BEGIN
         spParamData := 0;    {enable}
         spSlot := $A;        {slot number}
         spID := 131;         {sResource ID}
         spExtDev := 0;       {ID of external device}
      END;
      myErr := SetSRsrcState(@mySpBlk);
   END;
END;
</PRE>
<A NAME="HEADING56-19"></A>
<H2><A NAME="MARKER-2-32"></A>Searching for sResources</H2>
 The Slot Manager provides several functions that search for sResources in the slot resource table. These functions allow you to specify which sResources to search, but each function provides slightly different options.<P>
 The <A NAME="MARKER-2-55"></A><CODE>SNextSRsrc</CODE> and <A NAME="MARKER-2-364"></A><CODE>SNextTypeSRsrc</CODE> functions allow you to search for enabled sResources by slot. The <A NAME="MARKER-2-365"></A><CODE>SGetSRsrc</CODE> and <A NAME="MARKER-2-30"></A><CODE>SGetTypeSRsrc</CODE> functions, available only with the System 7 Slot Manager (that is, version 1 and version 2 of the Slot Manager), allow you to search for disabled sResources as well as enabled ones. <A HREF="#MARKER-9-4">Table 2-3</A> summarizes the Slot Manager search routines and the options available for each.
<TABLE BORDER="0" CELLPADDING="3">
<CAPTION><A NAME="MARKER-9-4"></A><B>Table 2-3 The Slot Manager search routines</B> </CAPTION>
<TH><BR><BR>Function<TH>State of sResources for which it searches<TH><BR>Slots it<BR>searches<TH>Which sResources it searches for<TH>Type of sResource it searches for<TR>
<TD><CODE>SNextSRsrc</CODE><TD>Enabled only<TD>Specified slot and higher slots<TD>Next sResource only<TD>Any type<TR>
<TD><CODE>SGetSRsrc<A HREF="#FOOTNOTE-1">[1]</A></CODE><TD>Your choice of enabled only or both enabled and disabled<TD>Your choice of one slot only or specified slot and higher slots<TD>Your choice of specified sResource or next sResource<TD>Any type<TR>
<TD><CODE>SNextTypeSRsrc</CODE><TD>Enabled only<TD>Specified slot and higher slots<TD>Next sResource only<TD>Specified type only<TR>
<TD><CODE>SGetTypeSRsrc<A HREF="Devices-71.html"><EM>*</A></EM></CODE><TD>Your choice of enabled only or both enabled and disabled<TD>Your choice of one slot only or specified slot and higher slots<TD>Next sResource only<TD>Specified type only</TABLE>
<P>
 <A HREF="#MARKER-9-151">Listing 2-2</A> shows how to use the <A NAME="MARKER-8-68"></A><CODE>SGetTypeSRsrc</CODE> function to search all slots for both enabled and disabled sResources with an sResource type category of <CODE>catDisplay</CODE> and an sResource type subcategory of <CODE>typeVideo</CODE>.<P>
<B>Listing 2-2  <A NAME="MARKER-9-151"></A>Searching for a specified type of sResource</B><P>
<PRE>
PROCEDURE MySResourceSearch;

VAR
   mySpBlk:    SpBlock;
   myErr:      OSErr;


BEGIN
   WITH mySpBlk DO                  {set required values in parameter block}
   BEGIN
      spParamData := fAll;          {fAll flag = 1: search all sResources}
      spCategory  := catDisplay;    {search for Category catDisplay}
      spCType     := typeVideo;     {search for cType typeVideo}
      spDrvrSW    := 0;             {this field not being matched}
      spDrvrHW    := 0;             {this field not being matched}
      spTBMask    := 3;             {match only Category and cType fields}
      spSlot      := 1;             {start search from slot 1}
      spID        := 1;             {start search from sResource ID 1}
      spExtDev    := 0;             {external device ID (card-specific)}
   END;
   myErr := noErr;
   WHILE myErr = noErr DO           {loop to search sResources}
   BEGIN
      myErr := SGetTypeSRsrc(@mySpBlk);
      MySRsrcProcess(mySpBlk);      {routine to process results}
   END;
   IF myErr &lt;&gt; smNoMoresRsrcs THEN  {all search functions return this value }
      MyHandleError(myErr);         { when search is complete}
END;
</PRE>
<A NAME="HEADING56-25"></A>
<H2><A NAME="MARKER-9-152"></A>Obtaining Information From sResources</H2>
 If you are writing a driver for a card device, you will most likely want access to the information in an sResource.<P>
 The Slot Manager provides many functions that return information from the entries of an sResource. The <A NAME="MARKER-2-41"></A><CODE>SOffsetData</CODE>, <A NAME="MARKER-2-42"></A><CODE>SReadByte</CODE>, and <CODE>SReadWord</CODE> functions return information from the offset field of an sResource entry. The <A NAME="MARKER-2-371"></A><CODE>SReadLong</CODE>, <CODE><A NAME="MARKER-9-372"></A>SGetCString</CODE>, and <A NAME="MARKER-9-373"></A><CODE>SGetBlock</CODE> functions return copies of the standard data structures pointed to by the offset field of an sResource entry. The <A NAME="MARKER-2-51"></A><CODE>SFindStruct</CODE> and <CODE><A NAME="MARKER-2-83"></A>SReadStruct</CODE> functions allow access to other data structures pointed to by sResource entries.<P>
 <A HREF="#MARKER-9-161">Listing 2-3</A> shows an example of searching for a board sResource and obtaining its name. This example starts at a particular slot number and then searches for the board sResource in that slot or, if necessary, in higher slots. Once it finds the board sResource, <A HREF="#MARKER-9-161">Listing 2-3</A> calls the <CODE>SGetCString</CODE> function, which returns a pointer to a buffer containing the name string for the card.<P>
<B>Listing 2-3  <A NAME="MARKER-9-161"></A>Searching for the name of a board sResource</B><P>
<PRE>
PROCEDURE FindBoardsResource  (VAR slotNumber: Integer;
                               VAR finished: Boolean);
VAR
   mySpBlk: SpBlock;
   myErr: OSErr;
BEGIN
   {First, get a pointer to the board sResource for the slot.}
   WITH mySpBlk DO BEGIN
      spSlot      := slotNumber;  {start searching in this slot, }
                                  { and continue until found}
      spID        := 0;
      spCategory  := 1;           {sRsrcType values for a board sResource}
      spCType     := 0;
      spDrvrSw    := 0;
      spDrvrHw    := 0;
   END;
   myErr := SNextTypeSRsrc(@mySpBlk);
   IF myErr &lt;&gt; noErr THEN
      MyHandleError(myErr)        {quit searching if no more sResources}
   ELSE
      gTheSlot := mySpBlk.spSlot; {the slot in which the sResource was found}

   {The spsPointer field of mySpBlock now contains a pointer to the }
   { board sResource list. The SGetCString function uses this field }
   { as one of two input fields.}
   mySpBlk.spID := 2;             {sRsrcName entry}
   myErr := SGetCString(@mySpBlk);
   IF myErr &lt;&gt; noErr THEN
      MyHandleError(myErr)
   ELSE BEGIN
      {The spResult field now points to a copy of the cString.}
      MyProcessCardName(gTheSlot, Ptr(mySpBlk.spResult));
      {Free memory allocated by SGetCString.}
      DisposePtr(Ptr(mySpBlk.spResult));
   END;
END;
</PRE>
 Because the <CODE>SGetCString</CODE> function allocates memory for a buffer, your application must dispose of the buffer afterward, using the Memory Manager procedure <CODE>DisposePtr</CODE> (which is described in <I><A HREF="../Memory/Memory-2.html">Inside Macintosh: Memory</A></I>).<A NAME="MARKER-9-374"></A><P>
<A NAME="HEADING56-32"></A>
<H2>Installing and Removing Slot Interrupt Handlers</H2>
 <A NAME="MARKER-2-163"></A><A NAME="MARKER-2-164"></A>If your card generates hardware interrupts, you can install a slot interrupt handler to process interrupts from the card. The Slot Manager maintains an interrupt queue for each slot. You use the <CODE>SIntInstall</CODE> function, described on <A HREF="Devices-101.html#MARKER-9-407">page 2-70</A>, to install an interrupt handler in the slot interrupt queue. The <CODE>SIntRemove</CODE> function, described on <A HREF="Devices-102.html#MARKER-9-411">page 2-71</A>, removes an interrupt handler from the slot interrupt queue.<A NAME="MARKER-2-375"></A><A NAME="MARKER-2-61"></A><A NAME="MARKER-2-116"></A><P>
 The <CODE>SlotIntQElement</CODE> data type, described on <A HREF="Devices-64.html#MARKER-9-259">page 2-28</A>, defines a slot interrupt queue element. The queue elements are ordered by priority and contain pointers to interrupt handlers. When a slot interrupt occurs, the Slot Manager calls the <BR>highest-priority interrupt handler in the slot's interrupt queue. If the interrupt handler returns without servicing the interrupt, the Slot Manager calls the next interrupt handler in the queue, in order of priority, until the interrupt is serviced. If the interrupt is not serviced by any interrupt handler, a system error dialog box is displayed.<P>
 Before returning to the Slot Manager, your interrupt handler should set a result code in register D0 to indicate whether the interrupt was serviced. If the interrupt was not serviced, your interrupt handler must return 0. Any value other than 0 indicates that the interrupt was serviced.<P>
 The Slot Manager returns to the interrupted task when your interrupt handler indicates that the interrupt was serviced; otherwise, it calls the next lower-priority interrupt handler for that slot. A system error is generated if the last interrupt handler returns to the Slot Manager without servicing the interrupt.<P>
<HR>

<A NAME="FOOTNOTE-1">[1] Available only with the System 7 Slot Manager (that is, version 1 and version 2 of the Slot Manager)
<HR>
<B>Subtopics</B>
<B><!-- TOC --><DL>
<DT><A HREF="Devices-56.html#HEADING56-5">Enabling and Disabling NuBus Cards</A>
<DD>
<DT><A HREF="Devices-56.html#HEADING56-10">Deleting and Restoring sResources</A>
<DD>
<DT><A HREF="Devices-56.html#HEADING56-14">Enabling and Disabling sResources</A>
<DD>
<DT><A HREF="Devices-56.html#HEADING56-19">Searching for sResources</A>
<DD>
<DT><A HREF="Devices-56.html#HEADING56-25">Obtaining Information From sResources</A>
<DD>
<DT><A HREF="Devices-56.html#HEADING56-32">Installing and Removing Slot Interrupt Handlers</A>
<DD>
</DL>
</B>
</BLOCKQUOTE>
<HR>
<CENTER>
<A HREF="Devices-55.html"><IMG ALIGN="BOTTOM" SRC="prev.gif" BORDER="none" HSPACE="20" ALT="Previous"></A> <A HREF="Devices-2.html"><IMG ALIGN="BOTTOM" SRC="content.gif" BORDER="none" HSPACE="20" ALT="Book Contents"></A> <A HREF="Devices-328.html"><IMG ALIGN="BOTTOM" SRC="index.gif" BORDER="none" HSPACE="20" ALT="Book Index"></A> <A HREF="Devices-57.html"><IMG ALIGN="BOTTOM" SRC="next.gif" BORDER="none" HSPACE="20" ALT="Next"></A> </CENTER><P>
<CENTER><FONT SIZE="-1"><A HREF="Devices-3.html">&copy; Apple Computer, Inc.</A><BR>3 JUL 1996</CENTER></FONT><P>
<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->
</BODY>
</HTML>  
