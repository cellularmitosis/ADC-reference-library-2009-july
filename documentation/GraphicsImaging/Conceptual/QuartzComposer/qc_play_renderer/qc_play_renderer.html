<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Quartz Composer Programming Guide: Using the QCRenderer Class to Play a Composition</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Using the QCRenderer Class to Play a Composition"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP40001357-CH209" title="Using the QCRenderer Class to Play a Composition"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000424" target="_top">Graphics &amp; Imaging</a> &gt; <a href="../../../Quartz-date.html#//apple_ref/doc/uid/TP30000440-TP30000424-TP30000559" target="_top">Quartz</a> &gt; <a href="../qc_intro/qc_intro.html#//apple_ref/doc/uid/TP40001357-CH201-TPXREF101">Quartz Composer Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../qc_play_ib_input/qc_play_ib_input.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../qc_webkit/qc_webkit.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP40001357-CH209-TPXREF101" title="Using the QCRenderer Class to Play a Composition"></a><h1>Using the QCRenderer Class to Play a Composition</h1><p>The <code><a href="../../../Reference/QuartzFramework/Classes/QCRenderer_Class/Reference/Reference.html#//apple_ref/occ/cl/QCRenderer" target="_top">QCRenderer</a></code> class is a simplified runtime object that can load and play a composition to an arbitrary OpenGL context. <code>QCRenderer</code> also provides an interface to pass data to the input ports or retrieve data from the output ports of the root macro patch of a composition.</p><p>This chapter shows how to create a <code>QCRenderer</code> object for a full screen OpenGL context and then load and render a Quartz Composer composition to that context. The sample code is part of a Cocoa application created using Xcode. Before reading this chapter, you may want to look at <em><a href="../../../Reference/QuartzFramework/Classes/QCRenderer_Class/index.html#//apple_ref/doc/uid/TP40003971" target="_top">QCRenderer Class Reference</a></em>.</p><p>Each section in this chapter provides a code fragment and an explanation of the essential parts of the code fragment. To see how to put all the code together into a complete, working application, you will need to open, build, and run the Player sample application that’s provided with the Mac OS X v10.5 developer tools. See <span class="content_text"><a href="qc_play_renderer.html#//apple_ref/doc/uid/TP40001357-CH209-BAJCHDIC">“Building and Running the Player Sample Project.”</a></span></p><p>The following tasks are essential to creating a sample application that plays a full-screen composition using a <code>QCRenderer</code> object. Each is described in more detail in the rest of the chapter.</p><ol class="ol"><li class="li"><p><span class="content_text"><a href="qc_play_renderer.html#//apple_ref/doc/uid/TP40001357-CH209-BAJDJHEE">“Declaring the Application Interface”</a></span></p></li><li class="li"><p><span class="content_text"><a href="qc_play_renderer.html#//apple_ref/doc/uid/TP40001357-CH209-BAJFFBJF">“Getting a Composition File”</a></span></p></li><li class="li"><p><span class="content_text"><a href="qc_play_renderer.html#//apple_ref/doc/uid/TP40001357-CH209-BAJIDAHB">“Capturing the Main Display”</a></span></p></li><li class="li"><p><span class="content_text"><a href="qc_play_renderer.html#//apple_ref/doc/uid/TP40001357-CH209-BAJHJDIA">“Setting Up the OpenGL Context”</a></span></p></li><li class="li"><p><span class="content_text"><a href="qc_play_renderer.html#//apple_ref/doc/uid/TP40001357-CH209-BAJGHDHF">“Setting Up Full Screen Display and Syncing”</a></span></p></li><li class="li"><p><span class="content_text"><a href="qc_play_renderer.html#//apple_ref/doc/uid/TP40001357-CH209-BAJCHADF">“Creating a QCRenderer Object”</a></span></p></li><li class="li"><p><span class="content_text"><a href="qc_play_renderer.html#//apple_ref/doc/uid/TP40001357-CH209-BAJIDIAF">“Creating a Timer”</a></span></p></li><li class="li"><p><span class="content_text"><a href="qc_play_renderer.html#//apple_ref/doc/uid/TP40001357-CH209-BAJDHEJI">“Writing the Rendering Routine”</a></span></p></li><li class="li"><p><span class="content_text"><a href="qc_play_renderer.html#//apple_ref/doc/uid/TP40001357-CH209-BAJFAGFC">“Overriding the sendEvent Method”</a></span></p></li></ol><a name="//apple_ref/doc/uid/TP40001357-CH209-BAJDJHEE" title="Declaring the Application Interface"></a><h2>Declaring the Application Interface</h2><p>This application is one of the rare ones that requires you to subclass <code>NSApplication</code>. You need to create a subclass so that you can override the <code>sendEvent:</code> method to catch user events while the application is displaying a full-screen OpenGL context, and also to set the <code>NSApplication</code> instance as its own delegate. See <em><a href="../../../../Cocoa/Reference/ApplicationKit/Classes/NSApplication_Class/index.html#//apple_ref/doc/uid/TP40004004" target="_top">NSApplication Class Reference</a></em> for more information.</p><p>You need to replace the principal class (<code>NSApplication</code>) by your custom subclass of <code>NSApplication</code> (in this example, PlayerApplication) in the <code>Info.plist</code> file. Open the <code>Info.plist</code> file from within Xcode, then find the following key-value pair:</p><div class="codesample"><table><tr><td scope="row"><pre>&lt;key>NSPrincipalClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;string>NSApplication&lt;/string><span></span></pre></td></tr></table></div><p>Then replace <code>NSApplication</code> with the name of the subclass. For this example, the revised key-value pair would look as follows:</p><div class="codesample"><table><tr><td scope="row"><pre>&lt;key>NSPrincipalClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;string>PlayerApplication&lt;/string><span></span></pre></td></tr></table></div><p><span class="content_text"><a href="qc_play_renderer.html#//apple_ref/doc/uid/TP40001357-CH209-BAJFDFFC">Listing 3-1</a></span> shows the interface for PlayerApplication, which requires variables to create the OpenGL context, <code>QCRenderer</code>, and other objects that support rendering a composition.</p><a name="//apple_ref/doc/uid/TP40001357-CH209-BAJFDFFC" title="Listing 3-1The interface for PlayerApplication"></a><p class="codesample"><strong>Listing 3-1&nbsp;&nbsp;</strong>The interface for PlayerApplication</p><div class="codesample"><table><tr><td scope="row"><pre>@interface PlayerApplication : NSApplication<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    NSOpenGLContext* _openGLContext;<span></span></pre></td></tr><tr><td scope="row"><pre>    QCRenderer*      _renderer;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSString*        _filePath;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSTimer*         _renderTimer;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSTimeInterval   _startTime;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSSize           _screenSize;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre>@end<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001357-CH209-BAJFFBJF" title="Getting a Composition File"></a><h2>Getting a Composition File</h2><p>A <code><a href="../../../Reference/QuartzFramework/Classes/QCRenderer_Class/Reference/Reference.html#//apple_ref/occ/cl/QCRenderer" target="_top">QCRenderer</a></code> object requires an OpenGL context and a Quartz Composer file for its creation. If the user drags a composition to your application icon, implement this <code>NSApplication</code> delegate method to retain the file pathname for later use when you create the <code>QCRenderer</code> object.</p><div class="codesample"><table><tr><td scope="row"><pre>- (BOOL) application:(NSApplication*)theApplication<span></span></pre></td></tr><tr><td scope="row"><pre>                    openFile:(NSString*)filename<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    _filePath = [filename retain];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return YES;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>If the user opens your application by double-clicking its icon, ask the user to specify a composition and then retain the file pathname by including the following code in the <code>applicationDidFinishLaunching:</code> delegate method.</p><div class="codesample"><table><tr><td scope="row"><pre>NSOpenPanel *openPanel;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>if(_filePath == nil)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        openPanel = [NSOpenPanel openPanel];<span></span></pre></td></tr><tr><td scope="row"><pre>        [openPanel setAllowsMultipleSelection:NO];<span></span></pre></td></tr><tr><td scope="row"><pre>        [openPanel setCanChooseDirectories:NO];<span></span></pre></td></tr><tr><td scope="row"><pre>        [openPanel setCanChooseFiles:YES];<span></span></pre></td></tr><tr><td scope="row"><pre>        if([openPanel runModalForDirectory:nil<span></span></pre></td></tr><tr><td scope="row"><pre>                    file:nil<span></span></pre></td></tr><tr><td scope="row"><pre>                    types:[NSArray arrayWithObject:@"qtz"]] != NSOKButton)<span></span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                NSLog(@"No composition file specified");<span></span></pre></td></tr><tr><td scope="row"><pre>                [NSApp terminate:nil];<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>        _filePath = [[[openPanel filenames] objectAtIndex:0] retain];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001357-CH209-BAJIDAHB" title="Capturing the Main Display"></a><h2>Capturing the Main Display</h2><p>The Quartz Services programming interface provides functions that configure and control displays. Use its functions to capture the main screen and cache its dimensions. See <em><a href="../../../Reference/Quartz_Services_Ref/index.html#//apple_ref/doc/uid/TP30001070" target="_top">Quartz Display Services Reference</a></em> for more information on these functions. </p><p>You can capture the main display  by using the code in <span class="content_text">Listing 3-2</span>. A detailed explanation for each numbered line of code follows the listing.</p><a name="//apple_ref/doc/uid/TP40001357-CH209-BAJJJADB" title="Listing 3-2Code that captures the main display"></a><p class="codesample"><strong>Listing 3-2&nbsp;&nbsp;</strong>Code that captures the main display</p><div class="codesample"><table><tr><td scope="row"><pre>CGDisplayCapture (kCGDirectMainDisplay);<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>CGDisplayHideCursor (kCGDirectMainDisplay);<span></span></pre></td></tr><tr><td scope="row"><pre>_screenSize.width = CGDisplayPixelsWide(kCGDirectMainDisplay);<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>_screenSize.height = CGDisplayPixelsHigh(kCGDirectMainDisplay);<span></span></pre></td></tr></table></div><p>Here what the code does:</p><ol class="ol"><li class="li"><p>Captures the main display. Capturing the screen is important because later you’ll set the receiver of the OpenGL context to full screen mode. A captured display prevents contention from other applications and system services. In addition, applications are not notified of display changes, preventing them from repositioning their windows and the Finder from repositioning desktop icons.</p></li><li class="li"><p>Caches the screen dimensions. The rendering method uses the screen dimensions to normalize the mouse coordinates. See <span class="content_text"><a href="qc_play_renderer.html#//apple_ref/doc/uid/TP40001357-CH209-BAJDHEJI">“Writing the Rendering Routine.”</a></span></p></li></ol><a name="//apple_ref/doc/uid/TP40001357-CH209-BAJHJDIA" title="Setting Up the OpenGL Context"></a><h2>Setting Up the OpenGL Context</h2><p>An OpenGL context  pixel format requires a pixel format that specifies the buffers (depth buffer, alpha buffer, stencil buffer, and accumulation buffer) as well as other attributes of a context. <span class="content_text">Listing 3-3</span> shows how to set up an OpenGL context. A detailed explanation for each numbered line of code follows the listing.</p><a name="//apple_ref/doc/uid/TP40001357-CH209-BAJGDCDI" title="Listing 3-3Setting up an OpenGL context"></a><p class="codesample"><strong>Listing 3-3&nbsp;&nbsp;</strong>Setting up an OpenGL context</p><div class="codesample"><table><tr><td scope="row"><pre>NSOpenGLPixelFormat *format;<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>NSOpenGLPixelFormatAttribute attributes[] = {<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>                    NSOpenGLPFAFullScreen,<span></span></pre></td></tr><tr><td scope="row"><pre>                    NSOpenGLPFAScreenMask,<span></span></pre></td></tr><tr><td scope="row"><pre>                    CGDisplayIDToOpenGLDisplayMask(kCGDirectMainDisplay),<span></span></pre></td></tr><tr><td scope="row"><pre>                    NSOpenGLPFANoRecovery,<span></span></pre></td></tr><tr><td scope="row"><pre>                    NSOpenGLPFADoubleBuffer,<span></span></pre></td></tr><tr><td scope="row"><pre>                    NSOpenGLPFAAccelerated,<span></span></pre></td></tr><tr><td scope="row"><pre>                    NSOpenGLPFADepthSize,<span></span></pre></td></tr><tr><td scope="row"><pre>                    24,<span></span></pre></td></tr><tr><td scope="row"><pre>                    (NSOpenGLPixelFormatAttribute) 0<span></span></pre></td></tr><tr><td scope="row"><pre>                };<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>format = [[[NSOpenGLPixelFormat alloc] initWithAttributes:attributes]<span></span></pre></td></tr><tr><td scope="row"><pre>                                         autorelease];<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>_openGLContext = [[NSOpenGLContext alloc] <span>// 4</span></pre></td></tr><tr><td scope="row"><pre>                    initWithFormat:format<span></span></pre></td></tr><tr><td scope="row"><pre>                    shareContext:nil];<span></span></pre></td></tr><tr><td scope="row"><pre>if(_openGLContext == nil) <span>// 5</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        NSLog(@"Cannot create OpenGL context");<span></span></pre></td></tr><tr><td scope="row"><pre>        [NSApp terminate:nil];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Declares storage for an <code><a href="../../../../Cocoa/Reference/ApplicationKit/Classes/NSOpenGLPixelFormat_Class/Reference/Reference.html#//apple_ref/occ/cl/NSOpenGLPixelFormat" target="_top">NSOpenGLPixelFormat</a></code> object. You specify a format when you create an OpenGL context.</p></li><li class="li"><p>Sets up the attributes for the pixel format. These attributes specify, among other things, a full-screen context and a depth buffer. <em><a href="../../../../Cocoa/Reference/ApplicationKit/Classes/NSOpenGLPixelFormat_Class/index.html#//apple_ref/doc/uid/TP40004076" target="_top">NSOpenGLPixelFormat Class Reference</a></em> provides a complete description of the available format attributes. At the very least, you must provide a color buffer and a depth buffer for the <code>QCRenderer</code> object.</p></li><li class="li"><p>Allocates a pixel format object and initializes it with the pixel format attributes.</p></li><li class="li"><p>Allocates an OpenGL context and initializes it with the pixel format object.</p></li><li class="li"><p>Checks to make sure the OpenGL context is not nil. If it is, the application must terminate.</p></li></ol><a name="//apple_ref/doc/uid/TP40001357-CH209-BAJGHDHF" title="Setting Up Full Screen Display and Syncing"></a><h2>Setting Up Full Screen Display and Syncing</h2><p>You need to set the OpenGL context to full-screen mode  and then set the swap interval to <code>1</code> to ensure that the buffers are swapped only during the vertical retrace of the monitor. If the buffers aren’t synchronized with the retrace, the composition could render with tearing artifacts. (For more information on swap intervals, see <em><a href="../../OpenGL-MacProgGuide/index.html#//apple_ref/doc/uid/TP40001987" target="_top">OpenGL Programming Guide for Mac OS X</a></em>.)</p><div class="codesample"><table><tr><td scope="row"><pre>long    value = 1;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>[_openGLContext setFullScreen];<span></span></pre></td></tr><tr><td scope="row"><pre>[_openGLContext setValues:&amp;value forParameter:kCGLCPSwapInterval];<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001357-CH209-BAJCHADF" title="Creating a QCRenderer Object"></a><h2>Creating a QCRenderer Object</h2><p>A <code><a href="../../../Reference/QuartzFramework/Classes/QCRenderer_Class/Reference/Reference.html#//apple_ref/occ/cl/QCRenderer" target="_top">QCRenderer</a></code> object requires an OpenGL context, the OpenGL pixel format, and a file pathname. If for some reason the renderer can’t be created, the application must terminate. Use the following code to create the renderer and check for its creation.</p><div class="codesample"><table><tr><td scope="row"><pre>_renderer = [[QCRenderer alloc]<span></span></pre></td></tr><tr><td scope="row"><pre>            initWithOpenGLContext:_openGLContext<span></span></pre></td></tr><tr><td scope="row"><pre>            pixelFormat:format<span></span></pre></td></tr><tr><td scope="row"><pre>            file:_filePath];<span></span></pre></td></tr><tr><td scope="row"><pre>if(_renderer == nil)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        NSLog(@"Cannot create QCRenderer");<span></span></pre></td></tr><tr><td scope="row"><pre>        [NSApp terminate:nil];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001357-CH209-BAJIDIAF" title="Creating a Timer"></a><h2>Creating a Timer</h2><p>You need to set up a timer  to regularly render the composition. This timer set up in the following code is scheduled to fire 60 times per second. Each time it fires, it invokes the render routine that’s created in the next section. If the timer can’t be created, the application must terminate, so make sure you include code to check for the existence of the timer. For more information on times, see <em><a href="../../../../Cocoa/Reference/Foundation/Classes/NSTimer_Class/index.html#//apple_ref/doc/uid/TP40003747" target="_top">NSTimer Class Reference</a></em>.</p><div class="codesample"><table><tr><td scope="row"><pre>#define kRendererFPS 60.0<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>_renderTimer = [[NSTimer scheduledTimerWithTimeInterval:(1.0 /<span></span></pre></td></tr><tr><td scope="row"><pre>                                (NSTimeInterval)kRendererFPS)<span></span></pre></td></tr><tr><td scope="row"><pre>                        target:self<span></span></pre></td></tr><tr><td scope="row"><pre>                        selector:@selector(_render:)<span></span></pre></td></tr><tr><td scope="row"><pre>                        userInfo:nil<span></span></pre></td></tr><tr><td scope="row"><pre>                        repeats:YES]<span></span></pre></td></tr><tr><td scope="row"><pre>                        retain];<span></span></pre></td></tr><tr><td scope="row"><pre>if(_renderTimer == nil)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        NSLog(@"Cannot create NSTimer");<span></span></pre></td></tr><tr><td scope="row"><pre>        [NSApp terminate:nil];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001357-CH209-BAJDHEJI" title="Writing the Rendering Routine"></a><h2>Writing the Rendering Routine</h2> <p>When the timer fires or when a user event needs to be processed, the <code>renderWithEvent:</code> method is invoked. Recall that for this application the timer is set to fire 60 times per second. <span class="content_text">Listing 3-4</span> shows the <code>_render</code> and <code>renderWithEvent:</code> methods. A detailed explanation for each numbered line of code follows the listing.</p><a name="//apple_ref/doc/uid/TP40001357-CH209-BAJECGCC" title="Listing 3-4The rendering methods"></a><p class="codesample"><strong>Listing 3-4&nbsp;&nbsp;</strong>The rendering methods</p><div class="codesample"><table><tr><td scope="row"><pre>- (void) _render:(NSTimer*)timer<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [self renderWithEvent:nil];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void) renderWithEvent:(NSEvent*)event<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    NSTimeInterval  time = [NSDate timeIntervalSinceReferenceDate];<span></span></pre></td></tr><tr><td scope="row"><pre>    NSPoint             mouseLocation;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSMutableDictionary  *arguments;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if(_startTime == 0)<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        _startTime = time;<span></span></pre></td></tr><tr><td scope="row"><pre>        time = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else<span></span></pre></td></tr><tr><td scope="row"><pre>        time -= _startTime;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    mouseLocation = [NSEvent mouseLocation];<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    mouseLocation.x /= _screenSize.width;<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    mouseLocation.y /= _screenSize.height;<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    arguments = [NSMutableDictionary dictionaryWithObject:[NSValue <span>// 5</span></pre></td></tr><tr><td scope="row"><pre>                    valueWithPoint:mouseLocation]<span></span></pre></td></tr><tr><td scope="row"><pre>                    forKey:QCRendererMouseLocationKey];<span></span></pre></td></tr><tr><td scope="row"><pre>    if(event)<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>        [arguments setObject:event forKey:QCRendererEventKey];<span></span></pre></td></tr><tr><td scope="row"><pre>    // Your code to set input port values <span>// 7</span></pre></td></tr><tr><td scope="row"><pre>    if(![_renderer renderAtTime:time arguments:arguments])<span>// 8</span></pre></td></tr><tr><td scope="row"><pre>                NSLog(@"Rendering failed at time %.3fs", time);<span></span></pre></td></tr><tr><td scope="row"><pre>    // Your code to get output port values<span>// 9</span></pre></td></tr><tr><td scope="row"><pre>    [_openGLContext flushBuffer];<span>// 10</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Computes the composition time as the difference between the current time and the time at which rendering started.</p></li><li class="li"><p>Gets the current mouse position, in screen coordinates. Mouse coordinates need to be normalized relative to the OpenGL context viewport (<code>[0,1],x[0,1]</code>) with the origin <code>(0,0)</code> at the lower-left corner. </p></li><li class="li"><p>Normalizes the x mouse coordinate.</p></li><li class="li"><p>Normalizes the y mouse coordinate.</p></li><li class="li"><p>Creates a dictionary and writes the normalized mouse coordinates to it. Coordinates are specified as an <code><a href="../../../../Cocoa/Reference/Foundation/Miscellaneous/Foundation_DataTypes/Reference/reference.html#//apple_ref/c/tdef/NSPoint" target="_top">NSPoint</a></code> object stored in an <code><a href="../../../../Cocoa/Reference/Foundation/Classes/NSValue_Class/Reference/Reference.html#//apple_ref/occ/cl/NSValue" target="_top">NSValue</a></code> object.</p></li><li class="li"><p>If there is a user event, adds it to the arguments dictionary.</p></li><li class="li"><p>This is where you could add code to set the value for an input parameter that’s published to the root macro patch of a composition. You use the method <code>setValue:forInputKey:</code>, making sure to pass a valid key.</p></li><li class="li"><p>Renders a frame at the specified time, passing the arguments dictionary. </p></li><li class="li"><p>This is where you could add code to retrieve the value of a published output parameter. You use the method <code>valueForOutputKey:</code>, making sure to pass a valid key.</p></li><li class="li"><p>Flushes the OpenGL context to display the rendered frame onscreen.</p></li></ol><a name="//apple_ref/doc/uid/TP40001357-CH209-BAJFAGFC" title="Overriding the sendEvent Method"></a><h2>Overriding the sendEvent Method</h2> <p>Recall that this example subclasses <code>NSApplication</code> so that it could override the <code>sendEvent:</code> method to ensure that user events are processed while there is a full screen OpenGL context on screen. The <code>sendEvent:</code> method in <span class="content_text">Listing 3-5</span> checks for:</p><ul class="ul"><li class="li"><p>An Escape key press, and terminates the application if there is one.</p></li><li class="li"><p>A meaningful event for the composition, and invokes the renderer immediately with such an event.</p></li></ul><div class="notebox"><a name="//apple_ref/doc/uid/TP40001357-CH209-DontLinkElementID_11" title="Note"></a><p><strong>Note:</strong>&nbsp; Don’t copy and paste the <code>#define</code> statement from <span class="content_text">Listing 3-5</span> to an Xcode project; the formatting used in the listing prevents the code from compiling. Instead, use the complete Player Xcode project that’s provided with the Max OS X v10.5 developer tools. For more information, see <span class="content_text"><a href="qc_play_renderer.html#//apple_ref/doc/uid/TP40001357-CH209-BAJCHDIC">“Building and Running the Player Sample Project.”</a></span></p></div><a name="//apple_ref/doc/uid/TP40001357-CH209-BAJEBIHC" title="Listing 3-5The overridden event-sending method"></a><p class="codesample"><strong>Listing 3-5&nbsp;&nbsp;</strong>The overridden event-sending method</p><div class="codesample"><table><tr><td scope="row"><pre>#define kRendererEventMask (NSLeftMouseDownMask|NSLeftMouseDraggedMask |<span></span></pre></td></tr><tr><td scope="row"><pre>                    NSLeftMouseUpMask | NSRightMouseDownMask |<span></span></pre></td></tr><tr><td scope="row"><pre>                    NSRightMouseDraggedMask | NSRightMouseUpMask |<span></span></pre></td></tr><tr><td scope="row"><pre>                    NSOtherMouseDownMask | NSOtherMouseUpMask |<span></span></pre></td></tr><tr><td scope="row"><pre>                    NSOtherMouseDraggedMask | NSKeyDownMask |<span></span></pre></td></tr><tr><td scope="row"><pre>                    NSKeyUpMask | NSFlagsChangedMask |<span></span></pre></td></tr><tr><td scope="row"><pre>                    NSScrollWheelMask)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void) sendEvent:(NSEvent*)event<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    if(([event type] == NSKeyDown) &amp;&amp; ([event keyCode] == 0x35))<span></span></pre></td></tr><tr><td scope="row"><pre>            [NSApp terminate:nil];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if(_renderer &amp;&amp; (NSEventMaskFromType ([event type]) &amp;<span></span></pre></td></tr><tr><td scope="row"><pre>                 kRendererEventMask))<span></span></pre></td></tr><tr><td scope="row"><pre>            [self renderWithEvent:event];<span></span></pre></td></tr><tr><td scope="row"><pre>    else<span></span></pre></td></tr><tr><td scope="row"><pre>    [       super sendEvent:event];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001357-CH209-BAJCHDIC" title="Building and Running the Player Sample Project"></a><h2>Building and Running the Player Sample Project</h2><p>The best way to experiment with using the <code><a href="../../../Reference/QuartzFramework/Classes/QCRenderer_Class/Reference/Reference.html#//apple_ref/occ/cl/QCRenderer" target="_top">QCRenderer</a></code> class is to build and run the Player sample application that’s supplied with the Mac OS X v10.5 developer tools. After installing the developer tools, you can find the Player Xcode project in the following location:</p><p><code>/Developer/Examples/Quartz Composer Sample Code</code></p><p>After you compile the Player application, you can open a composition in two ways. Either launch the application and specify a composition to play or drag a composition onto the Player application icon. To support opening a composition by dragging it to the application icon, you need to change the Info.plist file. <span class="content_text">Listing 3-6</span> shows the Info.plist file for the Player sample project. You can view this file from within Xcode by double-clicking Info.plist in the file list. Note that the listing has a <code>CFBundleTypeExtensions</code> key followed by the <code>qtz</code> extension.</p><a name="//apple_ref/doc/uid/TP40001357-CH209-BAJEAGDJ" title="Listing 3-6Specifying the qtz extension in the Info.plist file "></a><p class="codesample"><strong>Listing 3-6&nbsp;&nbsp;</strong>Specifying the qtz extension in the Info.plist file </p><div class="codesample"><table><tr><td scope="row"><pre>&lt;key>CFBundleDocumentTypes&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>    &lt;array><span></span></pre></td></tr><tr><td scope="row"><pre>        &lt;dict><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>CFBundleTypeExtensions&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;array><span></span></pre></td></tr><tr><td scope="row"><pre>                &lt;string>qtz&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;/array><span></span></pre></td></tr><tr><td scope="row"><pre>        &lt;/dict><span></span></pre></td></tr><tr><td scope="row"><pre>    &lt;/array><span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001357-CH209-DontLinkElementID_6" title="See Also"></a><h2>See Also</h2><p><em><a href="../../../../Cocoa/Reference/ApplicationKit/Classes/NSApplication_Class/index.html#//apple_ref/doc/uid/TP40004004" target="_top">NSApplication Class Reference</a></em> discusses the class, its methods, and the cases for which you might want to subclass <code>NSApplication</code>.</p>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../qc_play_ib_input/qc_play_ib_input.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../qc_webkit/qc_webkit.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2004, 2008 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2008-10-15<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/GraphicsImaging/Conceptual/QuartzComposer/qc_play_renderer/qc_play_renderer.html%3Fid%3DTP40001357-4.2&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/GraphicsImaging/Conceptual/QuartzComposer/qc_play_renderer/qc_play_renderer.html%3Fid%3DTP40001357-4.2&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/GraphicsImaging/Conceptual/QuartzComposer/qc_play_renderer/qc_play_renderer.html%3Fid%3DTP40001357-4.2&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>