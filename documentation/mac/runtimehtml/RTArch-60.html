<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Prologs and Epilogs</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING60></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="RTArch-59.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="RTArch-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="RTArch-147.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="RTArch-61.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="RTArch-2.html"><B>Mac OS Runtime Architectures</B></A> / <BR><DD><A HREF="RTArch-56.html"><B>Chapter 4 - PowerPC Runtime Conventions</B></A> / <A HREF="RTArch-59.html"><B>PowerPC Stack Structure</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING60-0></A>
<H2>Prologs and Epilogs</H2>
 <A NAME=MARKER-2-32></A>T<A NAME=MARKER-2-33></A>he called routine is responsible for allocating its own stack frame, making sure to preserve 16-byte alignment on the stack. This action is accomplished by the prolog before entering the actual routine. The compiler-generated prolog code does the following:<P>
<UL>
<LI>Decrements the stack pointer to account for the new stack frame.
<LI>Writes the previous value of the stack pointer to its own linkage area. This procedure ensures that the stack can be restored to its original state after returning from the call. 
<LI>Saves all nonvolatile general-purpose and floating-point registers into the saved-registers area. Note that if the called routine does not change a particular nonvolatile register, it does not save it. 
<LI>Saves the Link Register and Condition Register values in the caller's linkage area, if needed. <P>
</UL>
<DL>
<DT><B>Note</B>
<DD>The order in which the prolog executes these actions is determined by convention, not by any requirements of the PowerPC runtime architecture.<EM></EM><EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
 <A HREF=#MARKER-9-34>Listing 4-1</A> shows some sample prolog code. Note that the order of these actions differs from the order previously described. <P>
<B>Listing 4-1  <A NAME=MARKER-9-34></A>Sample prolog code</B><P>
<PRE>
linkageArea: set 24     ; size in PowerPC environment
params: set 32          ; callee parameter area
localVars: set 0        ; callee local variables
numGPRs: set 0          ; volatile GPRs used by callee
numFPRs: set 0          ; volatile FPRs used by callee)

spaceToSave: set linkageArea + params + localVars
spaceToSave: set spaceToSave + 4*numGPRs + 8*numFPRs

.moo:                   ; PROLOG
   mflr  r0,            ; extract return address 
   stw   r0,8(SP)       ; save the return address
   stwu  SP, -spaceToSave(SP); skip over caller save area
</PRE>
 <A NAME=MARKER-2-35></A>After the called routine exits, the epilog code executes, which does the following:<P>
<UL>
<LI>Restores the nonvolatile general-purpose and floating-point registers that were saved in the stack frame. 
<LI>Restores the Condition Register and Link Register values that were stored in the linkage area.
<LI>Restores the stack pointer to its previous value.
<LI>Returns to the calling routine using the address stored in the Link Register.<P>
</UL>
 <A HREF=#MARKER-9-36>Listing 4-2</A> shows some sample epilog code.<P>
<B>Listing 4-2  <A NAME=MARKER-9-36></A>Sample epilog code</B><P>
<PRE>
                           ; EPILOG
   lwz   r0,spaceToSave(SP)+8; get the return address
   mtlr  R0                ; reset Link Register
   addic SP,SP,spaceToSave ; restore stack pointer
   blr                     ; return
</PRE>
 The calling routine is responsible for restoring its GPR2 value immediately after returning from the called routine. <A NAME=MARKER-2-37></A><P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="RTArch-59.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="RTArch-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="RTArch-147.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="RTArch-61.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="RTArch-3.html">&copy; Apple Computer, Inc.</A><br>11 MARCH 1997<P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML> 
