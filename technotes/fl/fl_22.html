<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-August-01 --><!-- Includes revisions to graphics tags --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note FL22: HFS Ruminations</title><meta name="keywords" content="Mac OS 8 HFS WDRefNum BootDrive PMSP ioDirID ioFlNum PBHGetVInfo"><meta name="Description" content="Technical Note FL22: This Technical Note contains descriptionsof topics that concern HFS. These topics include HFS numbers,Working Directories (creating WDs etc.,), when to use HFScalls, WDRefNum, sample code to get the WDRefNum of the blessedfolder, the Poor Man's Search Path, the ioDirID and ioFlNum,PBHGetVInfo, and PBGetWDInfo.">                                       <meta name="categories" content="Files"><meta name="week-posted" content="May 26, 1986 - Jun 6, 1986"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002448" title="HFS Ruminations"></a><A NAME="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxCarbon-date.html">Carbon</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/Carbon/idxFileManagement-date.html" target="_blank">Carbon > File Management</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note FL22</div>
<div id="pageheadsub">HFS Ruminations</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext">					<A HREF="#Section1">HFS numbers</A><BR><BR>  <A HREF="#Section2">Working Directories</A><BR><BR><A HREF="#Section3">When you can use HFS calls</A><BR><BR><A HREF="#Section4">ioDirId and ioFlNum</A><BR><BR><A HREF="#Section5">PBHGetVInfo</A><BR><BR><A HREF="#Section6">PBGetWDInfo and Register D1</A><BR><BR><A HREF="#References">References</A><BR><BR>          <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><p  id = "introtext">This technical note contains some thoughts concerning HFS.</p> <!-- end_intro_text --><!-- begin_date --><h3 align=center>[Jun 01 1986]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR><!-- begin_content --><a name="Section1"></a><h2>HFS numbers</h2><p>A drive number is a small positive word (e.g., 3).</p><p>A <code>VRefNum</code> (as opposed to a <code>WDRefNum</code>) is a small negative word (e.g. <code>$FFFE</code>).</p><p>A <code>WDRefNum</code> is a large negative word (e.g. <code>$8033</code>).</p><p>A <code>DirID</code> is a long word (e.g. 38). The root directory of an HFS volume always has a <code>dirID</code> of 2.</p><P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>Working Directories</h2><p>Normally an application doesn't need to open working directories (henceforth<code>WDs</code>) using <code>PBOpenWD</code>, since <code>SFGetFile</code> returns a<code>WDRefnum</code> if the selected file is in a directory on a hierarchicalvolume and you are running HFS. There are times, however, when opening a<code>WD</code> is desirable (see the discussion about <code>BootDrive</code> below).</p><p>If you do open a <code>WD</code>, it should be created with an <code>ioWDProcID</code> of `ERIK' (<code>$4552494B</code>) and it will be deallocated by the Finder. Note that under MultiFinder, ioWDProcID will be ignored, so you should only use `ERIK'.</p><p><code>SFGetFile</code> also creates <code>WDs</code> with an <code>ioWDProcID</code> of `ERIK'.If <code>SFGetFile</code> opens two files from the same directory (during the sameapplication), it will only create one working directory.</p><p>There are no <code>WDRefnums</code> that refer to the root--the root directory of avolume is always referred to by a <code>vRefNum</code>.</p><P><A HREF="#top">Back to top</A></P><a name="Section3"></a><h2>When you can use HFS calls</h2><p>All of the HFS `H' calls, except for <code>PBHSetVInfo</code>, can be made withoutregard to file system as long as you pass in a pointer to an HFS parameter block. <code>PBHGetVol</code>,<code> PBHSetVol</code> (see the warnings in the File Manager chapter of <i>Inside Macintosh</i>), <code>PBHOpen</code>, <code>PBHOpenRF</code>, <code>PBHCreate</code>, <code>PBHDelete</code>, <code>PBHGetFInfo</code>, <code>PBHSetFInfo</code>, <code>PBHSetFLock</code>,<code>PBHRstFLock</code> and <code>PBHRename</code> differ from their MFS counterpartsonly in that a <code>dirID</code> can be passed in at offset <code>$30</code>.</p><p>The only difference between, for example, <code>PBOpen</code> and <code>PBHOpen</code>is that bit 9 of the trap word is set, which tells HFS to use a larger parameter block. MFS ignores this bit, so it will use the smaller parameter block (not including the <code>dirID</code>). Remember that all of these calls will accept a <code>WDRefNum</code> inthe <code>ioVRefNum</code> field of the parameter block.</p><p><code>PBHGetVInfo</code> returns more information than <code>PBGetVInfo</code>, so, ifyou're counting on getting information that is returned in the HFS parameterblock, but not in the MFS parameter block, you should check to see which filesystem is active.</p><p>HFS-specific calls can only be made if HFS is active. These calls are:<code>PBGetCatInfo</code>, <code>PBSetCatInfo</code>, <code>PBOpenWD</code>, <code>PBCloseWD</code>, <code>PBGetFCBInfo</code>,<code>PBGetWDInfo</code>, <code>PBCatMove</code> and <code>PBDirCreate</code>. <code>PBHSetVInfo</code> has no MFS equivalent. If any of these calls are made when MFS is running, a system error will be generated. If <code>PBCatMove</code> or <code>PBDirCreate</code> are called for an MFS volume, the function willreturn the error code -123 (wrong volume type). If <code>PBGetCatInfo</code> or <code>PBSetCatInfo</code> are called on MFS volumes, it's just as if <code>PBGetFInfo</code> and <code>PBSetFInfo</code> were called.</p><h3>Default volume</h3><p>If HFS is running, a call to <code>GetVol</code> (before you've made any<code>SetVol</code> calls) will return the <code>WDRefNum</code> of your application'sparent directory in the <code>vRefNum</code> parameter. If your application waslaunched by the user clicking on one or more documents, the <code>WDRefNums</code>of those documents' parent directories are available in the <code>vRefNum</code>field of the <code>AppFile</code> record returned from <code>GetAppFiles</code>.</p><p>If MFS is running, a call to <code>GetVol</code> (before you've made any<code>SetVol</code> calls) will return the <code>vRefNum</code> of the volume yourapplication is on in the <code>vRefNum</code> parameter. If your application waslaunched by the user clicking on one or more documents, the <code>vRefNum</code> ofthose documents' volume are available in the <code>vRefNum</code> field of the<code>AppFile</code> record returned from <code>GetAppFiles</code>.</p><h3>BootDrive</h3><p>If your application or desk accessory needs to get the <code>WDRefNum</code> of the"blessed folder" of the boot drive (for example, you might want to store a configuration file there), it can not rely on the low-memory global <code>BootDrive</code> (a word at <code>$210</code>) to contain the correct value. If your application is the startup application, <code>BootDrive</code> will contain the <code>WDRefNum</code> of the directory/volume that your application is in (notthe <code>WDRefNum</code> of the "blessed folder"); Your application could have been <code>_Launched</code>from an application that has modified <code>BootDrive</code>; if you are a desk accessory, you might findthat some applications alter <code>BootDrive</code>.</p><p>To get the "real" <code>WDRefNum</code> of the "blessed folder" that contains the currently open System file,you should call SysEnvirons (discussed in <u><A HREF = "../ov/ov_16.html">Technical Note #129</a></u>). If that is impossible, you can do something like this (Note: if you are running under MFS, <code>BootDrive</code> always contains the <code>vRefNum</code> of the volume on which the currently open System file is located):</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    ...    CONST        SysWDProcID = $4552494B; {&quot;ERIK&quot;}        BootDrive = $210; {address of Low-Mem global BootDrive}        FSFCBLen = $3F6; {address of Low-Mem global to                          distinguish file systems }        SysMap = $A58; {address of Low-Mem global that                        contains system map reference number}    TYPE        WordPtr = ^Integer; {Pointer to a word(2 bytes)}    ...    FUNCTION HFSExists: BOOLEAN;    Begin {HFSExists}        HFSExists := WordPtr(FSFCBLen)^ &gt; 0;    End;  {HFSExists}    FUNCTION GetRealBootDrive: INTEGER;    VAR         MyHPB        : HParamBlockRec;         MyWDPB        : WDPBRec;         err        : OSErr;        sysVRef    : integer; {will be the vRefNum of open system's vol}    Begin {GetRealBootDrive}        if HFSExists then Begin    {If we're running under HFS... }            {get the VRefNum of the volume that }            {contains the open System File      }            err:= GetVRefNum(WordPtr(SysMap)^,sysVRef);            with MyHPB do Begin            {Get the &quot;System&quot; vRefNum and &quot;Blessed&quot; dirID}                ioNamePtr    := NIL;                ioVRefNum    := sysVRef; {from the GetVrefNum call}                ioVolIndex    := 0;            End; {with}            err := PBHGetVInfo(@MyHPB, FALSE);            with myWDPB do Begin      {Open a working directory there}                ioNamePtr   := NIL;                ioVRefNum   := sysVRef;                ioWDProcID  := SysWDProcID; {Using the system proc ID}                ioWDDirID  := myHPB.ioVFndrInfo[1];{ see Technote 67}            End; {with}            err := PBOpenWD(@myWDPB, FALSE);            GetRealBootDrive := myWDPB.ioVRefNum;            {We've got the real WD}        End Else {we're running MFS}            GetRealBootDrive := WordPtr(BootDrive)^;            {BootDrive is valid under MFS}    End;  {GetRealBootDrive}</pre>	</TD></TR></TABLE></CENTER><BR><h3>From MPW C:</h3><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>/*&quot;ERIK&quot;*/#define    SysWDProcID    0x4552494B#define    BootDrive    0x210/*address of Low-Mem global that contains system map reference number*/#define    SysMap    0xA58#define     FSFCBLen     0x3F6#define    HFSIsRunning ((*(short int *)(FSFCBLen)) &gt; 0)OSErr GetRealBootDrive(BDrive)short int *BDrive;{ /*GetRealBootDrive*/    /*three different parameter blocks are used here for clarity*/    HVolumeParam    myHPB;    FCBPBRec        myFCBRec;    WDPBRec        myWDPB;    OSErr            err;    short int        sysVRef; /*will be the vRefNum of open system's vol*/    if (HFSIsRunning)    { /*if we're running under HFS... */    /*get the vRefNum of the volume that contains the open System File*/        myFCBRec.ioNamePtr= nil;        myFCBRec.ioVRefNum = 0;        myFCBRec.ioRefNum = *(short int *)(SysMap);        myFCBRec.ioFCBIndx = 0;        err = PBGetFCBInfo(&amp;myFCBRec,false);        if (err != noErr) return(err);    /*now we need the dirID of the &quot;Blessed Folder&quot; on this volume*/        myHPB.ioNamePtr = nil;        myHPB.ioVRefNum = myFCBRec.ioFCBVRefNum;        myHPB.ioVolIndex = 0;        err = PBHGetVInfo(&amp;myHPB,false);        if (err != noErr) return(err);    /*we can now open a WD for the directory that      contains the open system file one will most likely      already be open, so PBOpenWD will just return that WDRefNum*/        myWDPB.ioNamePtr = nil;        myWDPB.ioVRefNum = myHPB.ioVRefNum;        myWDPB.ioWDProcID = SysWDProcID; /*'ERIK'*/            /* see Technote # 67 [c has 0-based arrays]*/        myWDPB.ioWDDirID = myHPB.ioVFndrInfo[0];        err = PBOpenWD(&amp;myWDPB,false);        if (err != noErr) return err;        *BDrive = myWDPB.ioVRefNum; /*that's all!*/    } /* if (HFSIsRunning) */    else        *BDrive = *(short int *)(BootDrive);        /*BootDrive is valid under MFS*/    return noErr;} /*GetRealBootDrive*/</pre>	</TD></TR></TABLE></CENTER><h3>The Poor Man's Search Path (PMSP)</h3><p>If HFS is running, the PMSP is used for any file system call that can return afile-not- found error, such as <code>PBOpen</code>, <code>PBClose</code>, <code>PBDelete</code>, <code>PBGetCatInfo</code>, etc. It is not used for indexed calls (that is, where <code>ioFDirIndex</code>is positive) or when a file is created (<code>PBCreate</code>) or when a file is being moved betweendirectories (<code>PBCatMove</code>). The PMSP is also not used when a non-zero <code>dirID</code>is specified.</p><p>Here's a brief description of how the default PMSP works:</p><ol type="1">	<li><p>The directory that you specify (specified by <code>WDRefNum</code> or pathname) is searched; if the specified file is not found, then</p></li>	<li><p>the volume/directory specified by <code>BootDrive</code> (low-memory global at <code>$210</code>) is searched IF it is on the same volume as the directory you specified (see #1 above); if the specified file is not found, or the directory specified by <code>BootDrive</code> is not on the same volume as the directory that you specified, then</p></li>	<li><p>if there is a "blessed folder" on the same volume as the directory you specified (see #1 above),  it is searched. Please note that if #2 above specifies the same directory as #3, then that directory  is not searched twice. If no file is found, then</p></li>	<li><p><code>fnfErr</code> is returned.</p></li></ol><P><A HREF="#top">Back to top</A></P><a name="Section4"></a><h2>ioDirId and ioFlNum</h2><p>Two fields of the <code>HParamBlockRec</code> record share the same location.<code>ioDirID</code> and <code>ioFlNum</code> are both at offset <code>$30</code> from thestart of the parameter block. This causes a problem, since, in some calls (e.g.<code>PBGetCatInfo</code>), a <code>dirID</code> is passed in and a file number isreturned in the same field.</p><p>Future versions of Apple's HFS interfaces will omit the <code>ioFlNum</code>designator, so, if you need to get the file number of a file, it will be in the<code>ioDirID</code> of the parameter block after you have made the call. If youare making successive calls that depend on <code>ioDirID</code> being setcorrectly, you must "reset" the <code>ioDirID</code> field before each call. Theprogram fragment in Technical Note #68 does this.</p><P><A HREF="#top">Back to top</A></P><a name="Section5"></a><h2>PBHGetVInfo</h2><p>Normally, <code>PBHGetVInfo</code> will be called specifying a <code>vRefNum</code>.There are times, however, when you may make the call and only specify a volumename. If this is so, there are a couple of things to look out for.</p><p>Let's say that we have two volumes mounted: "<code>Vol1:</code>" (the defaultvolume) and "<code>Vol2:</code>". We also have a variable of type <code>HParamBlockRec</code>called <code>MyHPB</code>. We want to get information about <code>Vol2:</code>, so we put a pointer to a string (let's call it <code>fName</code>) in <code>MyHPB.ioNamePtr</code>. The string <code>fName</code> is equal to "<code>Vol2</code>" (Please note the missing colon). We also initialize <code>MyHPB.ioVRefNum</code> to 0. Then we make the call. We are very surprised to find out that weare returned an error of 0 (<code>noErr</code>) and that the <code>ioVRefNum</code> that we get back is not the <code>vRefNum</code> of <code>Vol2:</code>, but rather that of <code>Vol1:</code>.</p><p>Here's what's happening: <code>PBHGetVInfo</code> looks at the volume name, andsees that it is improper (it is missing a colon). So, being a forgiving sort ofcall, it goes on to look at the <code>ioVRefNum</code> field that you passed it(see pp. 99 of <i>Inside Macintosh</i>, vol. II). It sees a 0 there, so itreturns information about the default volume.</p><p>If you want to get information about a volume, and you just have its name andyou are not sure that the name is a proper one, you should set <code>MyHPB.ioVRefNum</code>to -32768 (<code>$8000</code>). No <code>vRefNum</code> or <code>WDRefNum</code> can be equal to <code>$8000</code>. By doing this, you are forcing <code>PBHGetVInfo</code> to use the volume name and, if that name is invalid, to return a -35 error (<code>nsvErr</code>), "No such volume."</p><P><A HREF="#top">Back to top</A></P><a name="Section6"></a><h2>PBGetWDInfo and Register D1</h2><p>There was a problem with <code>PBGetWDInfo</code> that sometimes caused the call toinaccurately report the <code>dirID</code> of a directory. It is fixed in System3.2 and later. To be absolutely sure that you won't get stung by this, clearregister <code>D1</code> (<code>CLR.L D1</code>) before a call to <code>PBGetWDInfo</code>.You can do this either with an INLINE (Lisa Pascal and most C's) or with ashort assembly-language routine before the call to <code>PBGetWDInfo</code>.</p><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><p>The File Manager</p><p>Technical Note M.FL.ActiveFS -- <u><A HREF = "fl_35.html">Determining Which File System is Active</a></u></p><p>Technical Note M.FL.BlessedFolder -- <u><A HREF = "fl_15.html">Finding the "Blessed Folder"</a></u></p><p>Technical Note M.FL.SearchingVols -- <u><A HREF = "fl_31.html">Searching Volumes - Solutions and Problems</a></u></p><P><A HREF="#top">Back to top</A></P><P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (56K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/fl_22.pdf">Download</A></P>               </TD>            </TR></table><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/fl/fl_22.html%3Fid%3DDTS10002448-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/fl/fl_22.html%3Fid%3DDTS10002448-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/fl/fl_22.html%3Fid%3DDTS10002448-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --><hr width=500 align=center></BODY></HTML>