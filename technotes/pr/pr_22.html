<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note PR22: pIdle Proc (or how to let users know what's going on during print time...)</title>                                       <meta name="categories" content="Printing"><meta name="week-posted" content="Apr 1, 1991 - Apr 5, 1991"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002643" title="pIdle Proc (or how to let users know what's going on during print time...)"></a><a name="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/index.html" target="_blank">Reference Library</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note PR22</div>
<div id="pageheadsub">pIdle Proc (or how to let users know what's going on during print time...)</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext">					 <A HREF="#Section1">Introduction</A><BR><BR><A HREF="#Section2">Installing The pIdle Proc</A><BR><BR><A HREF="#Section3">Things To Remember About pIdle Procedures</A><BR><BR><A HREF="#Section4">Conclusion</A><BR><BR> <A HREF="#References">References</A><BR><BR> <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><p id="introtext">This Technical Note discusses how to defensively program a <code>pIdle</code> procedure towork with the majority of print drivers in existence today, and how to installit at print time.</p> <!-- end_intro_text --><!-- begin_date --><h3 align=center>[Apr 01 1991]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content --><a name=Section1></A> <H2>Introduction</h2><p>When using a <code>pIdle</code> procedure at print time, there are a few things that oneshould remember to be compatible with the printer drivers that are availabletoday.  This Technical Note discusses installing a <code>pIdle</code> procedure at the righttime and the things to remember when writing one.</p><a name="Section2"></a> <P><A HREF="#top">Back to top</A></P><h2>Installing The pIdle Proc</h2><p>Let's start by installing the <code>pIdle</code> procedure at the right time.  You mustinstall your <code>pIdle</code> procedure into the print record before calling<code>PrOpenDoc</code>.  If you do not install your <code>pIdle</code> procedure before yourcall to <code>PrOpenDoc</code>, the printer driver does not give the application's<code>pIdle</code> procedure any time.  The following code fragments demonstrate installingthe <code>pIdle</code> procedure in the right place:</p><h3>MPW Pascal</h3><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    &lt;&lt; more print loop would appear above, see Technote #161 for details &gt;&gt;    {**  Install a pointer to your pIdle proc into your print record. **}    PrintingStatusDialog := GetNewDialog(257, NIL, POINTER(-1));    thePrRecHdl^^.prJob.pIdleProc := @checkMyPrintDialogButton;    thePrPort := PrOpenDoc(thePrRecHdl, NIL, NIL);</pre>	</TD></TR></TABLE></CENTER><h3>MPW C</h3><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>      &lt;&lt; more print loop would appear above, see Technote #161 for details &gt;&gt;    /**  Install a pointer to your pIdle proc into your print record.  **/    PrintingStatusDialog = GetNewDialog(257, nil, (WindowPtr) -1);    (**thePrRecHdl).prJob.pIdleProc = checkMyPrintDialogButton;    thePrPort = PrOpenDoc(thePrRecHdl, nil, nil);</pre>	</TD></TR></TABLE></CENTER><p>For a complete printing loop that handles errors at print time and makes all ofthe right calls to the Printing Manager, refer to Technical Note #161, <A HREF = "pr_10.html">A PrintLoop That Cares....</a></p><a name="Section3"></a> <P><A HREF="#top">Back to top</A></P><h2>Things To Remember About pIdle Procedures</h2><p>It is extremely important to design and code your <code>pIdle</code> procedure asdefensively as possible,  thereby making sure that it works with as manyprinter drivers as possible.  This section details a few things to rememberwhen creating <code>pIdle</code> procedures.</p><h3>Saving And Restoring The Current Port</h3><p>It is extremely important to save the printer driver's <code>GrafPort,</code> uponentry to your <code>pIdle</code> procedure and restore it upon exit.  Why? If you do not,the printer driver  would draw into the <code>GrafPort</code> of your dialog boxinstead of its <code>GrafPort,</code>which will cause some bad results.  To savethe printer's <code>GrafPort</code>, you should call <code>_GetPort</code> whenentering your procedure.  Before you exit your procedure, you would call<code>_SetPort</code> to set the port from your dialog box back to the printerdriver's <code>GrafPort</code> (i.e., the one you saved with <code>_GetPort</code>).</p><h3>Saving And Restoring The Printer Driver's Resources</h3><p>If the application changes the resource chain within it's <code>pIdle</code> procedure, youwant to save and restore the printer driver's resource chain.  Why?  Someprinter drivers assume that their resource chain does not change, but this maynot be true when the driver calls the <code>pIdle</code> procedure installed by theapplication at print time.  To accomplish this task, call <code>_CurResFile</code>,saving the ID of the printer driver's resource file at the beginning of your<code>pIdle</code> procedure.  When you exit from your <code>pIdle</code> procedure, restore the resourcechain back to the printer driver's resource chain with a call to<code>_UseResFile</code>.</p><P>At this point, you might be wondering what might change the resource chain. Ifyou called <code>_OpenResFile</code> or <code>_UseResFile</code> (anything that would change the value ofthe low memory global <code>TopMapHdl</code>) within the application's <code>pIdle</code> procedure, thechain would be changed.  If you are not changing the resource chain, thesecalls would not be needed.</p><h3>Handling Errors From Within A pIdle Procedure</h3><p>You should avoid calling <code>PrError</code> within your <code>pIdle</code> procedure; errorsthat occur while it is executing are usually temporary, and serve only asinternal flags for communication within the printer driver - they are notintended for the application.  If you absolutely must call <code>PrError</code>within your idle procedure, and an error occurs, never abort printing withinthe idle procedure itself.  Wait until the last called printing procedurereturns, then check to see if the error still remains.  Attempting to abortprinting within an idle procedure is a guarantee of certain death.</p><h3>Canceling Or Pausing The Printing Process</h3><p>If you install a procedure for handling requests to cancel printing, with anoption to pause the printing process, beware of timeout problems when printingto the LaserWriter.  Communication between the Macintosh and the LaserWritermust be maintained to prevent a job or a wait timeout.  If there is not anycommunication for a period of time (over two minutes), the printer times outand the print job terminates due to a wait  timeout.  Or, if the print jobrequires more than three minutes to print, the print job terminates due to ajob timeout.  Since, there is not a good method to determine to what type ofprinter an application is printing, it is probably a good idea to document thepossibility of a LaserWriter timing out for a user who chooses to select"pause" for over two minutes.</p><h3>Some Printer Drivers Do Not Support pIdle Procedures</h3><p>Some printer drivers do not support <code>pIdle</code> procedures, as they prefer to handlethe <code>pIdle</code> procedure in their own manner without giving an application's <code>pIdle</code>procedure any time.  This situation should not be a problem as long as you donot assume that your <code>pIdle</code> procedure is always called at print time.Therefore, you should only create your <code>pIdle</code> procedure to display the dialogbox and respond to a user pausing, continuing, or canceling a print job.</p><a name="Section4"></a> <P><A HREF="#top">Back to top</A></P><h2>Conclusion</h2><p>When installing your <code>pIdle</code> proc, it must be installed before the applicationcalls <code>PrOpenDoc</code>.  You want to make sure that you save and restore the <code>GrafPort</code>, upon entry and exit of your <code>pIdle</code> procedure, to make sure that the printerdriver will image into the correct port during the print job.  Finally, if youare changing the resource chain by calling <code>_OpenResFile</code> or <code>_UseResFIle</code>, youwant to make sure that you save and restore the resource chain.</p><a name="References"></a> <P><A HREF="#top">Back to top</A></P><h2>References</h2><P><i>Inside Macintosh</i>, Volume II, The Printing Manager</p><P>Technical Note M.IM.PrintLoop -- <A HREF = "pr_10.html">A Print Loop That Cares...</a></p>         <P><A HREF="#top">Back to top</A></P>         <a name=Downloads></A>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (60K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/pr_22.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/pr/pr_22.html%3Fid%3DDTS10002643-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/pr/pr_22.html%3Fid%3DDTS10002643-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/pr/pr_22.html%3Fid%3DDTS10002643-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>