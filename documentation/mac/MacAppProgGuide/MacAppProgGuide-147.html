<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Recipes--The Edition Manager (MacApp PG)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING147></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="MacAppProgGuide-146.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="MacAppProgGuide-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="MacAppProgGuide-158.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="MacAppProgGuide-148.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="MacAppProgGuide-2.html"><B>Programmer's Guide to MacApp</B></A> / <A HREF="MacAppProgGuide-78.html"><B>Part 2 - Working With MacApp</B></A><BR><DD><A HREF="MacAppProgGuide-145.html"><B>Chapter 31 - Working With the Edition Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING147-0></A>
<H1><A NAME=MARKER-2-27></A>Recipes--The Edition Manager</H1>
 The recipe and sample code in this section demonstrate how to add publish and subscribe support to your application. Classes and methods that supply Edition Manager support are shown in <A HREF=MacAppProgGuide-146.html#MARKER-9-21>Figure 31-1</A>.<P>
<A NAME=HEADING147-2></A>
<H2><A NAME=MARKER-9-28></A>Recipe--Adding Publish and Subscribe Support to Your Application</H2>
 MacApp handles much of the work of interacting with the Edition Manager, including handling section Apple events and displaying and responding to Edition Manager menu commands. To add publish and subscribe support to your application, you perform these additional steps:<P>
<OL>
<LI>Include MacApp header files for the Edition Manager in your source code.
<LI>Include Edition Manager resources in your resource definition file.
<LI>Base your document class on <CODE>TEditionDocument</CODE>.
<LI>Provide a document initialization method. Your method should do the following:<P>
<UL>
<LI>Call the <CODE>IEditionDocument</CODE> method of its parent class.
<LI>Create a selection designator for the document and call <CODE>SetUserSelection</CODE> to set it.<P>
</UL>
<LI>Specify the data format for your subscriber sections.
<LI>Override the <CODE>DoWriteData</CODE> method to publish data.
<LI>Override the <CODE>DoReadData</CODE> method to subscribe to data.
<LI>Notify the Edition Manager when the user selection changes.
<LI>Override the <CODE>DoAddBorder</CODE> method to supply a border adorner.
<LI>Add a dependency to trigger publisher updates (optional).<P>
</OL>
 The sample code shown in this recipe is from the Calc application.<P>
<A NAME=HEADING147-17></A>
<H3>Include MacApp Header Files for the Edition Manager</H3>
 To use MacApp support for the Edition Manager in your source code, you need to include specific MacApp header files. For example, the Calc application includes the following headers in the file <CODE>UCalc.h</CODE>:<P>
<PRE>
#ifndef __EDITIONS__
#include &lt;Editions.h&gt;
#endif

#ifndef __UAPPLEEVENTS__
#include &quot;UAppleEvents.h&quot;
#endif

#ifndef __UDESIGNATOR__
#include &quot;UDesignator.h&quot;
#endif

#ifndef __UEDITIONDOCUMENT__
#include &quot;UEditionDocument.h&quot;
#endif

#ifndef __USECTION__
#include &quot;USection.h&quot;
#endif
</PRE>
 The first file shown, Editions.h, contains  Edition Manager interface definitions. The remaining files contain definitions for MacApp Edition Manager classes and other Edition Manager support.<P>
<A NAME=HEADING147-21></A>
<H3><A NAME=MARKER-9-29></A>Include Edition Manager Resources in Your Resource File</H3>
 To be able to respond to section Apple events from the Event Manager, your application must include MacApp's Edition Manager resources. These resources are in the file <CODE>Editions.rsrc</CODE>. To include them in your application, add the following line to your resource definition file:<P>
<PRE>
include &quot;Editions.rsrc&quot; not 'ckid';
</PRE>
 The words <CODE>not <A NAME=MARKER-2-30></A>'ckid'</CODE> ensure that you will not copy the resource that is used for source-code control.<P>
 Edition Manager menu commands are normally displayed in the Edit menu, so your application should include an Edit menu <CODE>'CMNU'</CODE> resource that contains these commands. MacApp provides a default Edition Manager Edit menu in the file <CODE>Defaults.rsrc</CODE>. You can include this resource in your application by adding the following line to your resource definition file:<P>
<PRE>
include &quot;Defaults.rsrc&quot; 'CMNU' (mEditionMgrEdit);
</PRE>
 If you prefer, you can modify your own Edit menu definition to include the Edition Manager items. The easiest way to do this is to cut the text for the items from the Edit menu <CODE>'CMNU'</CODE> resource in MacApp's <CODE>Defaults.r</CODE> file and paste them into the Edit menu resource in your resource definition file.<P>
 You also need to add the Edition Manager menu to your menu bar, by adding its ID to your <CODE>'MBAR'</CODE> definition. For example, this <CODE>'MBAR'</CODE> definition from the Calc application is defined in the file <CODE>Calc.r</CODE>:<P>
<PRE>
resource 'MBAR' (kMBarDisplayed,
#if qNames
&quot;Calc&quot;,
#endif
   purgeable) {
   {mApple; mFile; mEditionMgrEdit; mFormat; mCalculation}
};
</PRE>
<A NAME=HEADING147-30></A>
<H3>Base Your Document Class on TEditionDocument</H3>
 To take advantage of MacApp's Edition Manager support, your document class should descend from the <CODE>TEditionDocument</CODE> class. For example, the <CODE>TCalcDocument</CODE> class begins its definition as follows:<P>
<PRE>
class TCalcDocument : public TEditionDocument
</PRE>
<A NAME=HEADING147-33></A>
<H3>Provide a Document Initialization Method</H3>
 The initialization method for your document class has two responsibilities for initializing MacApp's Edition Manager support. First, it should call the initialization method of its parent class, <CODE>TEditionDocument</CODE>, with a line like the following (from <CODE>ICalcDocument</CODE>):<P>
<PRE>
this-&gt;IEditionDocument(itsFile, kCalcScrapType, kSignature);
</PRE>
 In this call, the Calc document class passes constants that specify its file, its preferred scrap type (for cutting and pasting), and the application's signature (to identify the application that created the document). The IEditionDocument method calls the <CODE>InitUSectionManager</CODE> method, which initializes the MacApp Section Manager unit. <P>
 The second responsibility of your initialization method is to create a selection designator and use it to set the document's <CODE>fUserSelection</CODE> field. The Calc document does so with the following code, from the <CODE>ICalcDocument</CODE> method:<P>
<PRE>
TRegionDesignator*aRgnDesignator;
RgnHandle      aRgnHandle;

// Create a user selection designator.
aRgnHandle = MakeNewRgn();
aRgnDesignator = new TRegionDesignator;
aRgnDesignator-&gt;IRegionDesignator(aRgnHandle, TRUE);
aRgnDesignator-&gt;SetDesignationRect(CRect(1, 1, 2, 2));
// Set the document's fUserSelection field.
SetUserSelection(aRgnDesignator);
</PRE>
 This code creates a new region and region designator, initializes the region designator, sets the designator to designate the top-left cell in the spreadsheet, and calls SetUserSelection. The <CODE>TCalcDocument::</CODE>SetUserSelection method calls <CODE>Inherited</CODE> to set the <CODE>fUserSelection</CODE> field to the new designator, then performs its own user-selection operations.<P>
<DL>
<DT><B>Note</B>
<DD>In this snippet of sample code, failure handling is left as an exercise for the reader.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
<A NAME=HEADING147-41></A>
<H3>Specify the Data Format for Your Subscriber Sections</H3>
 You can skip this step if your application subscribes only to sections with data in one of the standard formats: <CODE>'PICT'</CODE>, <CODE>'TEXT'</CODE>, or '<CODE>snd '</CODE>.<P>
 If you are <I>not</I> using one of the standard formats, you override two methods in your document class: <CODE>GetPublishPreference</CODE> and <CODE>GetSubscriberFormatsMask</CODE>. These methods are described next.<P>
<A NAME=HEADING147-44></A>
<H4>GetPublishPreference</H4>
 The <CODE>GetPublishPreference</CODE> method returns the document's preferred section type. For the <CODE>TEditionDocument</CODE> class, <CODE>'TEXT'</CODE> is the preferred type. Your version of <CODE>GetPublishPreference</CODE> should look something like the following:<P>
<PRE>
FormatType TYourDocument::GetPublishPreference()
{
   return ((long) kYourSectionPreference);
}
</PRE>
<A NAME=HEADING147-47></A>
<H4>GetSubscriberFormatsMask</H4>
 The <CODE>GetSubscriberFormatsMask</CODE> method calls the <CODE>GetPublishPreference</CODE> method to help it determine which section format mask to use. In the <CODE>TEditionDocument</CODE> class, <CODE>GetSubscriberFormatsMask</CODE> is defined as follows:<P>
<PRE>
SignedByte TEditionDocument::GetSubscriberFormatsMask()
{
   // Return a mask corresponding to the edition format type to display
   // within the subscriber dialog box. This mask may consist of as
   // many types as are supported in the application.
   // Construct the mask as follows:
   //  GetSubscriberFormatsMask =[kPICTformatMask] [+]
   //                      [kTextformatMask [+] [ksndFormatMask]
   if (this-&gt;GetPublishPreference() == 'TEXT')
      return (kTEXTformatMask);
   else if (this-&gt;GetPublishPreference() == 'PICT')
      return (kPICTformatMask);
   else if (this-&gt;GetPublishPreference() == 'snd ')
      return (ksndFormatMask);
   else return 0;
}
</PRE>
 Your version of <CODE>GetSubscriberFormatsMask</CODE> should look something like the following:<P>
<PRE>
SignedByte TYourDocument::GetSubscriberFormatsMask()
{
   if (this-&gt;GetPublishPreference() == kYourSectionPreference)
      return (kYourFormatMask);
   else
      return Inherited::GetSubscriberFormatsMask();
}
</PRE>
<A NAME=HEADING147-52></A>
<H3>Override the DoWriteData Method to Publish Data</H3>
 MacApp calls your document's <CODE>DoWriteData</CODE> method as part of processing a Publish command. You override <CODE>DoWriteData</CODE> to write your data to an edition container file by writing to the passed stream. The kind of data you write depends on the <CODE>aScrapType</CODE> parameter passed to <CODE>DoWriteData</CODE>. In the Calc application, the <CODE>TCalcDocument::DoWriteData</CODE> method can publish three kinds of data: <CODE>'TEXT'</CODE>, <CODE>'PICT'</CODE>, or its own kind of spreadsheet data:<P>
<PRE>
void TCalcDocument::DoWriteData(const OSTypeaScrapType,
                        TDesignator*aDesignator,
                        TStream*    aStream) // Override.
{
   SignedByte savedState;
   Handle textHandle;

   if (aScrapType == 'TEXT')
   {
      textHandle = fCellsView-&gt;DesignatorAsTEXT(aDesignator);
      savedState = LockHandleHigh(textHandle);
      aStream-&gt;WriteBytes((*textHandle), GetHandleSize(textHandle));
      HSetState(textHandle, savedState);
      DisposeHandle(textHandle);
   }
   else if (aScrapType == fScrapType)
      this-&gt;DoWritePrivateTypes(aDesignator, aStream);
}
</PRE>
 This DoWriteData method calls the <CODE>TCellsView::DesignatorAsTEXT</CODE> method to write the data for the selected spreadsheet cells. <CODE>DesignatorAsTEXT</CODE> iterates over the selected cells and asks each cell to write its data, delimited by a tab or a carriage return character, to a handle stream. It then returns the handle containing the text. (For more information on the <CODE>DesignatorAsTEXT</CODE> method, see <A HREF=MacAppProgGuide-135.html#MARKER-9-35>"Recipe--Using a Handle Stream to Write Text to a Handle," beginning on page 601</A>.)<P>
<A NAME=HEADING147-56></A>
<H3>Override the DoReadData Method to Subscribe to Data</H3>
 MacApp calls your document's <CODE>DoReadData</CODE> method as part of processing a Subscribe command. You override <CODE>DoReadData</CODE> to read your data from an edition container file by reading from the passed stream. The kind of data you read depends on the <CODE>aScrapType</CODE> parameter passed to <CODE>DoReadData</CODE>. In the Calc application, the <CODE>TCalcDocument::DoReadData</CODE> method can read either <CODE>'TEXT'</CODE> data or its own kind of spreadsheet data:<P>
<PRE>
void TCalcDocument::DoReadData(const OSTypeaScrapType,
                        TDesignator*aDesignator,
                        TStream* aStream,
                        long     length) // Override.
{
   if (aScrapType == 'TEXT')
      this-&gt;DoReadTEXT(aDesignator, aStream, length);
   else if (aScrapType == fScrapType)
      this-&gt;DoReadPrivateTypes(aDesignator, aStream);
}
</PRE>
 The DoReadTEXT method reads text data, and the DoReadPrivateTypes method reads Calc's private spreadsheet data.<P>
<A NAME=HEADING147-60></A>
<H3>Notify the Edition Manager When the User Selection Changes</H3>
 Whenever the user changes the current selection, your application should call the <CODE>UserSelectionChanged</CODE> method of the view class that displays your document's data. In the <CODE>TView</CODE> class, the <CODE>UserSelectionChanged</CODE> method calls the <CODE>UserSelectionChanged</CODE> method of the view's document.<P>
 If your view class overrides <CODE>UserSelectionChanged</CODE>, your version of <CODE>UserSelectionChanged</CODE> should call <CODE>Inherited</CODE>, as Calc's <CODE>TCellsView</CODE> class does:<P>
<PRE>
void TCellsView::UserSelectionChanged(TView* changedView)
{
   if (!fCalcDocument-&gt;fShowSectionBorders)
   {
      // Invalidate all adorners if not showing borders.
      CAdornerIterator iter(this);
      
      for (TAdorner* theAdorner = iter.FirstAdorner(); iter.More();
                  theAdorner = iter.NextAdorner())
      {
         if ((theAdorner-&gt;fIdentifier == kPublisherAdornerID)
            || (theAdorner-&gt;fIdentifier == kSubscriberAdornerID))
         {
            theAdorner-&gt;InvalidateAdorner(this);
         }
      }
   }
   // Call Inherited to inform the document of the change.
   Inherited::UserSelectionChanged(changedView);

}  // TCellsView::UserSelectionChanged
</PRE>
 The Calc application also overrides the UserSelectionChanged method in the <CODE>TCalcDocument</CODE> class:<P>
<PRE>
void TCalcDocument::UserSelectionChanged(TView* changedView) // Override.
{
   TDesignator * userSelection;

   // Let document's selection designator know designation has changed. 
   userSelection = this-&gt;GetUserSelection();
   if ((userSelection != NULL) &amp;&amp;userSelection-&gt;DescendsFrom(
                        TRegionDesignator::GetClassDescStatic()))
      CopyRgn(fCellsView-&gt;fSelections,((TRegionDesignator *)
                        (userSelection))-&gt;fDesignation);
   Inherited::UserSelectionChanged(changedView);
}
</PRE>
 If the user selection has changed, this method updates the document's user selection designator by copying the view's current selection region.<P>
<A NAME=HEADING147-67></A>
<H3><A NAME=MARKER-9-31></A>Override DoAddBorder to Supply a Border Adorner</H3>
 The <CODE>DoAddBorder</CODE> method does nothing in the <CODE>TEditionDocument</CODE> class. You override this method in your document class to supply an adorner object to draw the border for your publisher or subscriber. The following is the <CODE>DoAddBorder</CODE> method from the Calc document:<P>
<PRE>
void TCalcDocument::DoAddBorder(TSection* aSection)
{
   // Adding a section--give it a section adorner.
   if (fCellsView)
   {
      if (aSection-&gt;GetSectionType() == stSubscriber)
         fCellsView-&gt;CreateSubscriberAdorner((TSubscriber *)aSection);
      else
         fCellsView-&gt;CreatePublisherAdorner((TPublisher *)aSection);

      // Invalidate the borders of publishers/subscribers if we aren't
      // showing all borders.
      if (!fShowSectionBorders)
      {
         CAdornerIterator iter(fCellsView);
   
         for (TAdorner * anAdorner = iter.FirstAdorner(); iter.More();
                     anAdorner = iter.NextAdorner())
            if ((anAdorner-&gt;fIdentifier == kPublisherAdornerID) ||
               (anAdorner-&gt;fIdentifier == kSubscriberAdornerID))

               anAdorner-&gt;InvalidateAdorner(fCellsView);
      }
   }
}
</PRE>
 The CreateSubscriberAdorner method creates an adorner to draw a subscriber border, and the CreatePublisherAdorner method creates an adorner to draw a publisher border. Both methods add the adorner to the view's list of adorners.<P>
<A NAME=HEADING147-71></A>
<H3>Add a Dependency to Trigger Publisher Updates</H3>
 The Calc application uses dependencies to ensure that a publisher is notified whenever a cell within the publisher is changed. This is not a requirement, but it is an approach you may wish to emulate in your application.<P>
 To make a publisher a dependent of each cell in the published selection, the <CODE>TCalcDocument</CODE> class overrides the <CODE>TEditionDocument</CODE> method <CODE>AddSectionAndBorder</CODE> with the following implementation:<P>
<PRE>
void TCalcDocument::AddSectionAndBorder(TSection* aSection)
{
   Inherited::AddSectionAndBorder(aSection);

   this-&gt;AddPublisherDependency(aSection);
}
</PRE>
 This AddSectionAndBorder method first calls <CODE>Inherited</CODE> to add the section and its adorner, then calls AddPublisherDependency, also a method of <CODE>TCalcDocument</CODE>. The AddPublisherDependency method iterates over the cells in the published section, adding the section as a dependent of each cell.<P>
 The <CODE>TCell::Recalculate</CODE> method makes the following call whenever a cell changes:<P>
<PRE>
this-&gt;Changed(mValueChanged, this);
</PRE>
 As a result, the publisher is notified whenever the contents of one of its cells changes.<A NAME=MARKER-2-32></A><P>
Appendixes <P>
 <P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="MacAppProgGuide-146.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="MacAppProgGuide-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="MacAppProgGuide-158.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="MacAppProgGuide-148.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="MacAppProgGuide-3.html">&copy; Apple Computer, Inc.</A><br>25 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
