<HTML><HEAD>   <TITLE>TN 1188: Packages in Mac OS 9</TITLE></HEAD><BODY bgcolor="#ffffff"><A HREF="#top"></a><!--top banner--><table width="550" cellpadding="0" cellspacing="0" border="0">	<tr>		<td>						<H1>Technote 1188</H1>                 <H2>Packages in Mac OS 9</H2>                  <B>By John Montbriand</B><BR>                  <B>Apple Worldwide Developer Technical Support</B><BR>                        </TD></TR></TABLE><hr size="1" noshade color="#000000" width="550" align="left"><TABLE BORDER=0 CELLPADDING=10 WIDTH=500>   <TR>      <TD VALIGN=top bgcolor="cccc99" WIDTH="40%">         <H4>CONTENTS</H4>                  <P id=p1>         <A HREF="#Section1">Overview</A><BR><BR>                  <A HREF="#Section2">The Package Flag</A><BR><BR>                  <A HREF="#Section3">The Top Level Alias File</A><BR><BR>                  <A HREF="#Section4">The Package's Main File</A><BR><BR>                  <A HREF="#Section5">Other Support Files</A><BR><BR>                 <A HREF="#Section6">The Optional Open Document Event Parameter</A><BR><BR>                 <A HREF="#Section7">Package Compatibility Notes</A><BR><BR>         </p>      </TD>      <TD VALIGN=top>      		<P><FONT SIZE="+4" COLOR="#0000AF">T</FONT>his Technote describes		how the Finder implements packages in Mac&nbsp;OS&nbsp;9. Developers		interested in creating packages for use in Mac&nbsp;OS&nbsp;9 can use		this document as a guide for creating packages. Mac&nbsp;OS&nbsp;9		packages offer a simple consolidated experience for the user when		interacting with a package in the Finder's windows, while at the		same time preventing accidental tampering with a package's required		support files.</P>         		<P>For Mac&nbsp;OS&nbsp;X package compatibility, an additional		package specification for Mac&nbsp;OS&nbsp;X will be released		as an adjunct to the Mac&nbsp;OS&nbsp;9 package specification		described in this document. Upon release of this additional		specification, developers will be able to create packages		to be used in either Mac&nbsp;OS&nbsp;9 or Mac&nbsp;OS&nbsp;X.</P>	</TD></TR></TABLE><hr size="1" noshade color="#000000" width="550" align="left"><BR><TABLE BORDER=0 CELLPADDING=1 WIDTH=500> <TR> <TD><A NAME="Section1"></A><H3>Overview</H3>	<P>Packages in Mac&nbsp;OS&nbsp;9 are not complex.  Simply said,	a Package in Mac&nbsp;OS&nbsp;9 is a folder with the 'package&nbsp;bit' set that	contains exactly one alias file at the topmost level.  Normally,	a package will consist of an application and a number of support	files organized into sub-directories.  There is only one requirement	governing the internal organization of packages,	and there are no restrictions on how package sub-directories can	be named, how package sub-directories must be organized, or what package	sub-directories must contain. Figure&nbsp;1 provides an illustration	of a hypothetical package named SimplePlot.</P>	<BR><BR>	<P><IMG SRC="images/packages.jpg"><BR><BR>	<B>Figure 1.</B> Sample package directory layout. </P>	<BR><BR>	<P>Although requirements for packages in Mac&nbsp;OS&nbsp;9	are few, figure&nbsp;1 illustrates the two main requirements for	packages:  the appropriate Finder flag must be set	for the package's folder and exactly one relative alias must be present	in the top level of the package's directory hierarchy.</P><p id=p1> <a href="#top">Back to top</a> </p><BR><BR><A NAME="Section2"></A><H3>The Package Flag</H3>	<P>The folder containing the package has bit 13 (for files, the <CODE>hasBundle</CODE> bit)	set in its Finder flags.  For files, this bit is known as the	'bundle&nbsp;bit' indicating that the file contains a	<CODE>'BNDL'</CODE> resource that is used by the Finder to determine	how the file's icon is displayed.  For more information	about how the Finder <CODE>'BNDL'</CODE> resources see the 	<A HREF="http://developer.apple.com/techpubs/mac/Toolbox/Toolbox-443.html">Finder Interface</A>	chapter of	<A HREF="http://developer.apple.com/techpubs/mac/Toolbox/Toolbox-2.html">Inside Macintosh: Macintosh Toolbox Essentials</A>	.</P>		<P>In Mac&nbsp;OS&nbsp;9, any folder having this bit set is recognized as	a package.  If this bit is set, and the folder contains exactly	one alias at it's top most level, then the Finder will treat	the folder as a package.</P>		<P>In some circumstances, due to a software problem or a crash, a folder may	wind up having the package bit set when infact it is not a package.  In this	case, the Finder will treat such a folder as a 'damaged package' and its icon	will appear as a blank document with the kind string set to 'package'.  To correct	this problem, there is a utility called "Package First Aid" provided on the	Mac&nbsp;OS&nbsp;9 install CD.</P><p id=p1> <a href="#top">Back to top</a> </p><BR><BR><A NAME="Section3"></A><H3>The Top Level Alias File</H3>	<P>The package's folder contains exactly one alias file	at its topmost level.  This alias points to some other file	in the package's directory hierarchy; and, it should be a	relative alias so that it will remain valid if a package	is copied to another volume.  In this discussion,	the file pointed to by that alias is called the 'package's main file'.</P>			<TABLE BORDER=0 CELLPADDING=1 WIDTH=498> <TR> <TD bgcolor="eeeee0">		<B>COMPATIBILITY NOTE</B><BR>		Although the top level alias file refers to an 'application' in the		example shown in Figure 1, there is no requirement that		the main file in a package must be an application.  It is possible to		create many types of packages including document packages, library		packages, et cetera.  However, the primary focus for Mac&nbsp;OS&nbsp;9		is application packages.  	</TD></TR> </TABLE>	<P>The package's main file governs the behavior of the package	in the Finder's windows.  For all intents and purposes, the Finder treats the package	as if it were a file containing the 'BNDL', 'FREF', icon resources,	et cetera found in the package's main file.  </P>		<P>For example, when a file is dragged over a package's icon, the Finder 	will track the drag command exactly as if the file was being dragged over	the package's main file.  Referring to Figure 1, say the application SimplePlot's	<CODE>'BNDL'</CODE> resource indicated it was capable of opening files of type	<CODE>'PLOT'</CODE>, then:</P>		<OL>		<LI>The Finder will allow the user to drop files of type <CODE>'PLOT'</CODE> into the		SimplePlot package and the package's icon will be hilited appropriately		during drag operations,<BR><BR></LI>	   		<LI>If a user drops a file of type <CODE>'PLOT'</CODE> into the SimplePlot package,		the Finder will Launch the SimplePlot application, if it is not		already running, and send an 'open documents' Apple event to the application		asking it to open the file.<BR><BR></LI>			</OL>	<P>There are two ways to create the relative alias file required for a package.	The first is to manually create an alias file in the Finder using the "Make Alias"	command.  The second, is to make the appropriate calls to the resource manager	Alias&nbsp;Manager in software as shown in Listing&nbsp;1.</P>	<BR>	<TABLE BORDER=0 CELLPADDING=1 WIDTH=498> <TR> <TD bgcolor="eeeee0"><PRE>/* MakeRelativeAliasFile creates a new alias file located at    aliasDest referring to the targetFile.  relative path    information is stored in the new file. */    OSErr MakeRelativeAliasFile(<A HREF="http://developer.apple.com/techpubs/mac/Files/Files-115.html">FSSpec</A> *targetFile, <A HREF="http://developer.apple.com/techpubs/mac/Files/Files-115.html">FSSpec</A> *aliasDest) {    <A HREF="http://developer.apple.com/techpubs/mac/Toolbox/Toolbox-464.html">FInfo</A> fndrInfo;    <A HREF="http://developer.apple.com/techpubs/mac/Files/Files-342.html">AliasHandle</A> theAlias;    Boolean fileCreated;    short rsrc;    OSErr err;        /* set up locals */    theAlias = NULL;    fileCreated = false;    rsrc = -1;        /* set up our the alias' file information */    err = <A HREF="http://developer.apple.com/techpubs/mac/Files/Files-195.html">FSpGetFInfo</A>(targetFile, &fndrInfo);    if (err != noErr) goto bail;    if (fndrInfo.fdType == 'APPL')        fndrInfo.fdType = kApplicationAliasType;    fndrInfo.fdFlags = kIsAlias; /* implicitly clear the inited bit */        /* create the new file */    <A HREF="http://developer.apple.com/techpubs/mac/MoreToolbox/MoreToolbox-37.html">FSpCreateResFile</A>(aliasDest, 'TEMP', 'TEMP', smSystemScript);    if ((err = <A HREF="http://developer.apple.com/techpubs/mac/MoreToolbox/MoreToolbox-35.html">ResError</A>()) != noErr) goto bail;    fileCreated = true;        /* set the file information or the new file */    err = <A HREF="http://developer.apple.com/techpubs/mac/Files/Files-196.html">FSpSetFInfo</A>(aliasDest, &fndrInfo);    if (err != noErr) goto bail;        /* create the alias record, relative to the new alias file */    err = <A HREF="http://developer.apple.com/techpubs/mac/Files/Files-355.html">NewAlias</A>(aliasDest, targetFile, &theAlias);    if (err != noErr) goto bail;        /* save the resource */    rsrc = <A HREF="http://developer.apple.com/techpubs/mac/MoreToolbox/MoreToolbox-41.html">FSpOpenResFile</A>(aliasDest, fsRdWrPerm);    if (rsrc == -1) { err = <A HREF="http://developer.apple.com/techpubs/mac/MoreToolbox/MoreToolbox-35.html">ResError</A>(); goto bail; }    <A HREF="http://developer.apple.com/techpubs/mac/MoreToolbox/MoreToolbox-47.html">UseResFile</A>(rsrc);    <A HREF="http://developer.apple.com/techpubs/mac/MoreToolbox/MoreToolbox-64.html">AddResource</A>((Handle) theAlias, rAliasType, 0, aliasDest-&gt;name);    if ((err = <A HREF="http://developer.apple.com/techpubs/mac/MoreToolbox/MoreToolbox-35.html">ResError</A>()) != noErr) goto bail;    theAlias = NULL;    <A HREF="http://developer.apple.com/techpubs/mac/MoreToolbox/MoreToolbox-89.html">CloseResFile</A>(rsrc);    rsrc = -1;    if ((err = <A HREF="http://developer.apple.com/techpubs/mac/MoreToolbox/MoreToolbox-35.html">ResError</A>()) != noErr) goto bail;        /* done */    return noErr;bail:    if (rsrc != -1) <A HREF="http://developer.apple.com/techpubs/mac/MoreToolbox/MoreToolbox-89.html">CloseResFile</A>(rsrc);    if (fileCreated) <A HREF="http://developer.apple.com/techpubs/mac/Files/Files-193.html">FSpDelete</A>(aliasDest);    if (theAlias != NULL) <A HREF="http://developer.apple.com/techpubs/mac/Memory/Memory-73.html">DisposeHandle</A>((Handle) theAlias);    return err;}</PRE>	</TD></TR> </TABLE>	<BR>	<B>Listing 1</B>. Sample routine for creating a relative alias file.</P><BR>	<P>Developers interested in creating an application for automating the creation	of packages will want to employ some method similar to the routine shown	in Figure&nbsp;1.  Other options include using the Finder's 'Make&nbsp;Alias' command	or creating aliases using applescript.  The advantage of calling <CODE>NewAlias</CODE>	directly is that you have more control over how the alias is created and are able	to specify which file is used for constructing relative aliases.</P><BR>	<TABLE BORDER=0 CELLPADDING=1 WIDTH=498> <TR> <TD bgcolor="eeeee0">		<B>COMPATIBILITY NOTE</B><BR>		When creating aliases using either the Finder's "Make&nbsp;Alias" command,		or the method shown in Figure&nbsp;1, be sure that File Sharing is turned		off.  If file sharing is turned on, then full path information such		as the server name, etc is stored in the alias making it unsuitable		for use in packages.  Be sure file sharing is turned off before		creating any aliases used in packages.	</TD></TR> </TABLE><p id=p1> <a href="#top">Back to top</a> </p><BR><BR><A NAME="Section4"></A><H3>The Package's Main File</H3>	<P>In the context of the Finder's windows, a package will behave as if	it were a file or an application.  And, all of the properties of the package's icon are	determined by the package's main file.  As shown in figure&nbsp;2, this is	the file referred to by the package's top level alias file.  </P>			<BR><BR>	<P><IMG SRC="images/mainf.jpg"><BR><BR>	<B>Figure 2.</B> The package's main file. </P>	<BR><BR>					<P>For example, if the package's main file is an application, then the	package will look and feel like an application; and, if the package's	main file is a document, then the package will look and feel like	a document.  The package's main file is used by the Finder to determine	the majority of the external characteristics of the package.  These	characteristics include:</P>		<UL>		<LI>The package's icon,<BR><BR></LI>		<LI>The package's kind (application, document, et&nbsp;cetera),<BR><BR></LI>		<LI>The Get Info data (Excluding the package's size: a package's size		is the total of the sizes of all of the package's contents.  Also, the		package's size is displayed in the Get Info window without reference		to the number of items in the package's folder.),<BR><BR></LI>		<LI>Drag and drop information,<BR><BR></LI>		<LI>The kIsStationery and kHasCustomIcon Finder flags from package's main		file are used when displaying the package.  The other Finder flags, specifically		the invisible, name locked, inited, bundle, and color flags, are taken from		the package folder's flags instead of the main file's flags.<BR><BR></LI>	</UL>		<P>In general, a package will have all the same properties as the	package's main file.  Points where they differ include:</P>		<UL>		<LI>The package's size is the total size of package folder contents,<BR><BR></LI>		<LI>The main file's name and the package's name may differ.  This allows		the user to edit the name of the package without disturbing the name of the		package's main file.<BR><BR></LI>	</UL>		<P>Application packages (package's whose main file is an application) accept drag	and drop operations in Finder windows in the same way application files	accept drag and drop operations in Finder windows.  Here, the acceptance of a	drag and drop is governed by the properties of the package's main file, and if	a drop is allowed, then the Finder will send the appropriate Apple event to the	package's main file. </P><p id=p1> <a href="#top">Back to top</a> </p><BR><BR><A NAME="Section5"></A><H3>Other Support Files</H3><P>One of the key features of packages is the developer's abilityto consolidate many support files together with the main application.  Bytaking advantage of this facility, developers can group the filesused in a product in a way that both simplifies the user's task of dealingwith the product in the Finder's windows and prevents tampering with thearrangement of the support files used in the product.</P>	<TABLE BORDER=0 CELLPADDING=1 WIDTH=498> <TR> <TD bgcolor="eeeee0">		<B>COMPATIBILITY NOTE</B><BR>		Developers currently placing support files for their		applications in the system folder should consider consolidating		their applications and support files into packages for Mac&nbsp;OS&nbsp;9.	</TD></TR> </TABLE><P>A package may contain a complex hierarchy of support files, sharedlibraries, and other types of files used by the application in it'soperation.  Also, it is not unreasonable to suppose that a packagemay contain one or more application files that in some way lendto the overall facility provided by the package.  In Figure 1,the package contains a number of support files including privateshared libraries presumably used by the main application, a numberof AppleScript scripts, and a suite of help files.</P><p id=p1> <a href="#top">Back to top</a> </p><BR><BR><A NAME="Section6"></A><H3>The Optional Open Document Event Parameter</H3><P>Application packages may receive a open document <CODE>'odoc'</CODE> Apple eventscontaining an optional parameter with the key <CODE>'fdpl'</CODE> (Finderpackage document list).  This will be sent to the package when the Finderis asked to open any file inside of a package.  There are a few ways thiscan happen:</P>	<UL>		<LI>While running under a previous version of Mac&nbsp;OS, the user		created an alias referring to an item inside of the package's		folder and put the alias somewhere outside of the package's		folder.  Then, after switching to Mac&nbsp;OS&nbsp;9, they attempted to		open the item by double clicking on the alias.		<BR><BR></LI>				<LI>An open document event targeting one or more items inside of the		package's folder was sent to the Finder by some other application.<BR><BR></LI>				<LI>An alias to an item inside of a package is dropped onto another		application.  In this case, rather than launching the application that		the alias was dropped into, the Finder will launch the package's		application and send it an open document event containing a <CODE>'fdpl'</CODE>		parameter referring to the file.<BR><BR></LI>	</UL><P>In either case, the Finder will not open the items in the way that itusually does.  Instead, the Finder will package the items into an opendocument apple event in a <CODE>'fpdl'</CODE> parameter and send the event to thepackage's application.  The structure of the <CODE>'fpdl'</CODE> parameter is identicalto the structure of the <CODE>keyDirectObject</CODE> open document event parameter -it is a list of file aliases.  The only difference is, the aliases will allrefer to files or folders inside of the application's directory.</P> <P>Your open document event handler should be designed to handleeach of the three different combinations of event parameters itcan receive:</P>		<UL>		<LI>Open document events without the optional <CODE>'fpdl'</CODE> parameter.		<BR><BR></LI>		<LI>Open document events where the <CODE>keyDirectObject</CODE> is an		empty list referring to no documents, but the optional <CODE>'fpdl'</CODE>		parameter contains a list referring to one or more documents.		<BR><BR></LI>		<LI>Open document events where the <CODE>keyDirectObject</CODE> 		contains a list referring to one or more documents and the optional <CODE>'fpdl'</CODE>		parameter contains a list referring to one or more documents.		<BR><BR></LI>	</UL><P>In general, the main application's open document event handler shouldalways look for the optional <CODE>'fpdl'</CODE> parameter and take appropriateactions when it is there.  At the very least, the application shouldprovide appropriate feedback to the user indicating that the requested fileis an internal part of the package and cannot be opened.  Other situationsmay call for different kinds of processing;  for example, say the <CODE>'fpdl'</CODE>parameter contains a reference to a help file inside of the package, then itwould be appropriate for the application to open that help file and displayits contents.</P><p id=p1> <a href="#top">Back to top</a> </p><BR><BR><A NAME="Section7"></A><H3>Package Compatibility Notes</H3><P>Packages cannot be shared in Mac&nbsp;OS&nbsp;9. </P><P>The StandardFile dialogs are not aware of packages.  As a result,it is possible for users to use these windows to navigate into packagefolders and either attempt to open documents inside of them or savedocuments inside of packages.  Navigation Services has been updatedto recognize packages and it does not allow users to navigate intothem (unless specifically directed to do so).</P><p id=p1> <a href="#top">Back to top</a> </p></TD> </TR> </TABLE><BR><BR><BR><H3>Acknowledgments</H3><P>Special thanks to Pat&nbsp;McClaughry and the Finder&nbsp;Team.</P><P>And, thanks to Tim&nbsp;Holmes, Ingrid&nbsp;Kelly, Karl&nbsp;Schlosser&nbsp;(Editor),John&nbsp;C.&nbsp;Signa, and David&nbsp;J.&nbsp;Wright.</P>