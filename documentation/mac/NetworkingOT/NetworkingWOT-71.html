<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Using ADSP</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING71></A>
<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->

<!-- Main Body -->

<CENTER>
<P>
<A HREF="NetworkingWOT-70.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="NetworkingWOT-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="NetworkingWOT-491.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A>  <A HREF="NetworkingWOT-72.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html"><B>Inside Macintosh:</B></A> <A HREF="NetworkingWOT-2.html"><B>Networking With Open Transport </B></A> / <A HREF="NetworkingWOT-10.html"><B>Part 1 - Open Transport Essentials</B></A><BR><DD><A HREF="NetworkingWOT-69.html"><B>Chapter 16 - AppleTalk Data Stream Protocol (ADSP)</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING71-0></A>
<H1>Using ADSP</H1>
 To use Open Transport ADSP, you first open an endpoint as an ADSP endpoint. This causes Open Transport to allocate the memory ADSP needs for data buffers and for storing the variables ADSP uses to maintain the connection between endpoints. After a connection is established, ADSP manages and controls the data flow between two endpoints throughout a session to ensure that data is delivered and received in the order in which it was sent and that duplicate data is not sent. <P>
 As with other connection-oriented protocols, Open Transport ADSP allows you to create a passive endpoint that listens for incoming connection requests rather than initiating such requests. In addition, the implementation of ADSP under Open Transport includes some ADSP-specific features that are specific to the two AppleTalk connection-oriented protocols:<P>
<UL>
<P><LI>an option to enable end-of-message (EOM) indicators that let you break streams of data into logical units
<P><LI>locally implemented orderly disconnects rather than over-the-wire remote disconnects<P>
</UL>
 ADSP also implements a separate data channel for expedited data. This provides an attention-message facility that lets ADSP endpoints signal each other outside the normal exchange of data. <P>
<A NAME=HEADING71-6></A>
<H2>Binding ADSP Endpoints</H2>
 <A NAME=MARKER-13-25></A>You have two choices when you bind an ADSP endpoint: You can create an endpoint that can initiate and accept connections, or you can create an endpoint that can only receive connection requests. <P>
 If the endpoint can initiate connections, you can bind it as a normal Open Transport endpoint and use any of the three AppleTalk address formats for the socket address: DDP, NBP, or the combined DDP-NBP format. If the bind is successful, the endpoint is ready for use in establishing and using a connection. <P>
 The other choice when<A NAME=MARKER-13-26></A> binding an ADSP endpoint is to establish it as a <A NAME=MARKER-13-27></A>passive peer that listens for incoming connection requests. The passive endpoint can accept or deny a connection request based on criteria that you define. The use of a passive peer is typical of a server environment in which a server, such as a file server, is registered with a single NBP name. Endpoints throughout the network can contact the server's passive peer with connection requests. The server can accept or deny a request. It might deny a request, for example, when its resources are exhausted. <P>
 To create a passive peer that listens, you specify a <CODE><A NAME=MARKER-13-28></A>qlen</CODE> field value greater than 0 during the binding process. The number you use determines how many outstanding connection requests the endpoint can support. Once you bind a passive peer, it starts listening for incoming connection requests. When a request arrives, the endpoint retrieves certain information about the request and continues to process it by accepting or rejecting it. <P>
 You can bind multiple ADSP endpoints to the same DDP socket, and ADSP can support as many connections on a socket as you have memory for, but you can only have one passive peer that listens on a given socket. <P>
<A NAME=HEADING71-12></A>
<H2><A NAME=MARKER-13-29></A>Sending and Receiving ADSP Data</H2>
 ADSP supports two separate <A NAME=MARKER-13-30></A>data channels: one for normal data and one for expedited data. You can send a stream of normal data that has no logical boundaries that need to be preserved across the connection, or you can use <A NAME=MARKER-13-31></A>transport service data units (TSDUs) to separate the data stream into discrete logical units when sending and receiving data across a connection. For expedited data, you can use <A NAME=MARKER-13-32></A>expedited transport service data units, or ETSDUs.<P>
 By default, ADSP does not support TSDUs. Instead, ADSP sends and receives a continuous stream of data with no message delimiters. If you do not change this through the use of options, ADSP endpoints act much like other connection-oriented transactionless endpoints, and the bulk of your code would be reusable for other types of protocols (such as TCP). <P>
 Open Transport uses a flag in the send and receive functions to indicate multiple sends and receives. The use of this flag, the <A NAME=MARKER-13-36></A><CODE>T_MORE</CODE> flag, allows you to break up a large data stream without losing its logical boundaries at the other end of the connection. The flag, however, indicates nothing about how the data is packaged for transport on the lower-level protocols below the ADSP endpoint provider. <P>
<A NAME=HEADING71-16></A>
<H3><A NAME=MARKER-9-34></A>The End-of-Message Option</H3>
 <A NAME=MARKER-13-35></A>If transport independence is not crucial for your application, you can use the ADSP enable EOM (<CODE>OPT_ENABLEEOM</CODE>) option that allows infinite length <A NAME=MARKER-13-72></A>TSDUs on the normal data channel. <P>
 If you enable the EOM option, you can send any length TSDU by setting the <CODE>T_MORE</CODE> flag on each send to indicate to the provider that another packet is coming that is part of this same message. When you send data without the <CODE>T_MORE</CODE> flag set, the provider knows this is the end of the message, and it sends an EOM packet to the remote peer. It is possible for the EOM packet to contain no data because ADSP supports the sending of <A NAME=MARKER-13-31></A>zero-length packets. This is useful when you send a packet with the <CODE>T_MORE</CODE> flag set only to discover that you have no more data to send. In this case, ADSP still expects another packet, but you have no data to put into it. You can send a zero-length packet to set the <CODE>T_MORE</CODE> flag correctly. <P>
 You can enable the EOM option for an endpoint in several ways. One way <BR>is to define the option as part of the configuration string you use to open <BR>the endpoint. The following line of code enables the EOM option for an <BR>ADSP endpoint:<P>
<PRE>
<A NAME=MARKER-0-95></A>          OTOpenEndpoint(OTCreateConfiguration(&quot;adsp(EnableEOM=1)&quot;),0, NULL, &amp;err);<P>
</PRE>
 Or you could call a function like that shown in <A HREF=NetworkingWOT-56.html#MARKER-9-65>Listing 7-5 </A> as follows:<P>
<PRE>
<A NAME=MARKER-0-95></A>err=SetFourByteOption(ep, ATK_ADSP, OPT_ENABLEEOM, 1);<P>
</PRE>
 to enable the EOM option for an ADSP endpoint. <A NAME=MARKER-13-73></A><P>
<A NAME=HEADING71-24></A>
<H3><A NAME=MARKER-9-41></A>The <A NAME=MARKER-13-42></A>Checksum Option</H3>
 You can use the <A NAME=MARKER-13-152></A><CODE>OPT_CHECKSUM</CODE> option to force ADSP to send all outgoing packets with the checksum option enabled. By default, outgoing ADSP packets do not use this option, which directs DDP to compute a checksum and include it in each packet that it sends to the remote endpoint provider, since using checksums slows communications slightly. Normally, ADSP and DDP perform enough error checking to ensure safe delivery of all data, so set this option only if the network is highly unreliable. <A NAME=MARKER-13-44></A><P>
<A NAME=HEADING71-26></A>
<H2>Sending <A NAME=MARKER-13-45></A>Expedited Data</H2>
 In addition to the full-duplex data stream that an ADSP session maintains, ADSP allows either end of a connection to send an expedited <A NAME=MARKER-13-46></A>attention message to the other end without interrupting the primary flow of data. Processing expedited data takes precedence over handling normal data, so when an expedited data packet arrives at an endpoint, the endpoint reads this packet before reading the next normal data packet. Both the send and receive functions have a flag, <A NAME=MARKER-13-37></A><CODE>T_EXPEDITED</CODE>, that indicates when a packet has expedited data. <P>
 Expedited transport service data units, ETSDUs, can be up to 572 bytes long, including a 2-byte <A NAME=MARKER-13-48></A>attention code at the beginning of the user data portion. The minimum ETSDU for ADSP is 2 bytes, so if you send less than that, the data is padded to 2 bytes before being transmitted. If you use ETSDUs, you are responsible for ensuring that the code has a value from $0000 to $EFFF and is not in the reserved range of $F000 to $FFFF.<P>
 Note that not every connection-oriented transactionless protocol supports attention messages or expedited data. Therefore, using this option compromises the transport independence of your application. <A NAME=MARKER-13-49></A><P>
<A NAME=HEADING71-30></A>
<H2><A NAME=MARKER-13-50></A>Disconnecting </H2>
 As with all connection-oriented Open Transport protocols, ADSP supports abortive disconnects. In addition, ADSP supports <A NAME=MARKER-13-51></A>orderly disconnects, although it can only implement them locally.<P>
 An <A NAME=MARKER-13-52></A>abortive disconnect directs the endpoint to abruptly tear down its connection without making any accomodation for the data that may be in the transmission pipeline at the time. You can define your own handshake, perhaps using the expedited data channel, to prevent losing data during the disconnection process.<P>
 ADSP implements orderly disconnects locally, not over the wire. This means that immediately after you request the disconnect, ADSP sends all data buffered at the local end and then tears down the connection, breaking communication with the remote end. As a result, no data can be sent from either the local or remote endpoint. The endpoints can continue to process data already in their receive queues, but no new data can go out. <P>
<A NAME=HEADING71-34></A>
<H2><A NAME=MARKER-13-53></A><A NAME=MARKER-9-54></A>Using General Open Transport Functions With ADSP</H2>
 This section describes any special considerations you must take into account for Open Transport functions when you use them with the Open Transport ADSP implementation. <P>
<A NAME=HEADING71-36></A>
<H3><A NAME=MARKER-9-55></A>OTBind</H3>
 The <A NAME=MARKER-13-56></A><CODE>OTBind</CODE> function associates a local protocol address with the endpoint provider specified by the <CODE>ref</CODE> parameter. <P>
 You can bind multiple ADSP endpoints to a single protocol address, but you can bind only one passive peer endpoint that listens on that socket.<P>
 With ADSP, as with other connection-oriented protocols, the <CODE>req-&gt;<A NAME=MARKER-13-57></A>qlen</CODE> parameter specifies the number of outstanding connection requests that an endpoint can support. The endpoint can negotiate a lower final value of <CODE>qlen</CODE> if it cannot handle the requested number of outstanding connection requests. <P>
<A NAME=HEADING71-40></A>
<H3><A NAME=MARKER-9-53></A>OTConnect</H3>
 The <A NAME=MARKER-13-59></A><CODE>OTConnect</CODE> function requests a connection to a specified remote endpoint. <P>
 ADSP does not allow application-specific data to be included when you establish a connection, so you need to set the <CODE>sndcall-&gt;udata.len</CODE> field to 0. ADSP ignores the <CODE>sndcall-&gt;udata.buf</CODE> field.<P>
<A NAME=HEADING71-43></A>
<H3><A NAME=MARKER-9-60></A>OTRcvConnect</H3>
 The <A NAME=MARKER-13-61></A><CODE>OTRcvConnect</CODE> function reads the status of a previously issued connection request. <P>
 Because ADSP does not allow application-specific data to be associated with a connection request, you need to set the <CODE>call-&gt;udata.maxlen</CODE> field to 0. ADSP ignores the <CODE>call-&gt;udata.buf</CODE> field.<P>
<A NAME=HEADING71-46></A>
<H3><A NAME=MARKER-9-62></A>OTListen</H3>
 The <A NAME=MARKER-13-63></A><CODE>OTListen</CODE> function listens for an incoming connection request.<P>
 ADSP does not allow application-specific data to be included when you request a connection, so you need to set the <CODE>call-&gt;udata.maxlen</CODE> field to 0. ADSP ignores the <CODE>call-&gt;udata.buf</CODE> field.<P>
<A NAME=HEADING71-49></A>
<H3>OTAccept</H3>
 The <A NAME=MARKER-13-64></A><CODE>OTAccept</CODE> function accepts a connection request. You can accept a connection either on the same endpoint that received the connection request or on a different endpoint. <P>
 ADSP does not allow application-specific data to be included when you accept a connection, so you need to set the <CODE>call-&gt;udata.len</CODE> field to 0. ADSP ignores the <CODE>call-&gt;udata.buf</CODE> field.<P>
<A NAME=HEADING71-52></A>
<H3><A NAME=MARKER-9-65></A>OTSnd</H3>
 The <A NAME=MARKER-13-66></A><CODE>OTSnd</CODE> function sends normal and expedited data through a connection-<BR>oriented transactionless endpoint. <P>
 ADSP supports <A NAME=MARKER-13-72></A>TSDUs through the <A NAME=MARKER-13-73></A><CODE>OPT_ENABLEEOM</CODE> option. In ADSP, TSDUs can be of infinite length and <A NAME=MARKER-13-69></A>ETSDUs can be up to 572 bytes long. Zero-length packets are supported in ADSP.<P>
<A NAME=HEADING71-55></A>
<H3><A NAME=MARKER-9-70></A>OTRcv</H3>
 The <A NAME=MARKER-13-71></A><CODE>OTRcv</CODE> function receives normal and expedited data through a connection-<BR>oriented transactionless endpoint. <P>
 ADSP supports <A NAME=MARKER-13-72></A>TSDUs through the <A NAME=MARKER-13-73></A><CODE>OPT_ENABLEEOM</CODE> option. <P>
<A NAME=HEADING71-58></A>
<H3><A NAME=MARKER-9-74></A>OTSndDisconnect</H3>
 The <A NAME=MARKER-13-75></A><CODE>OTSndDisconnect</CODE> function initiates an abortive disconnect or rejects a connection request. <P>
 When you call this function with ADSP, you receive a <CODE><A NAME=MARKER-13-76></A>T_ORDREL</CODE> asynchronous event rather than a <CODE><A NAME=MARKER-13-29></A>T_DISCONNECT</CODE> asynchronous event so that you can continue to read in the rest of the data in your receive queue. Otherwise, with a <CODE>T_DISCONNECT</CODE> event, any remaining unread data is discarded. <P>
 In an abortive disconnect, the <CODE>call</CODE> parameter is ignored because ADSP does not allow application-specific data to be associated with a disconnect. You need to set the <CODE>call-&gt;udata.len</CODE> field to 0. ADSP ignores the <CODE>call-&gt;udata.buf</CODE> field.<P>
<A NAME=HEADING71-62></A>
<H3><A NAME=MARKER-9-78></A>OTRcvDisconnect</H3>
 The <A NAME=MARKER-13-79></A><CODE>OTRcvDisconnect</CODE> function returns information about why a connection attempt failed or an established connection was terminated. <P>
 Because ADSP does not allow application-specific data to be associated with a disconnect, you need to set the <CODE>discon-&gt;udata.len</CODE> field to 0. ADSP ignores the <CODE>discon-&gt;udata.buf</CODE> field. The <CODE>discon-&gt;reason</CODE> field contains a positive error code indicating why the connection was rejected.<A NAME=MARKER-13-80></A><P>
 <P>
<HR>
<B>Subtopics</B>
<B><!-- TOC --><DL>
<DT><A HREF="NetworkingWOT-71.html#HEADING71-6">Binding ADSP Endpoints</A>
<DD>
<DT><A HREF="NetworkingWOT-71.html#HEADING71-12">Sending and Receiving ADSP Data</A>
<DD>
<DT><A HREF="NetworkingWOT-71.html#HEADING71-16">The End-of-Message Option</A>
<DD>
<DT><A HREF="NetworkingWOT-71.html#HEADING71-24">The Checksum Option</A>
<DD>
<DT><A HREF="NetworkingWOT-71.html#HEADING71-26">Sending Expedited Data</A>
<DD>
<DT><A HREF="NetworkingWOT-71.html#HEADING71-30">Disconnecting </A>
<DD>
<DT><A HREF="NetworkingWOT-71.html#HEADING71-34">Using General Open Transport Functions With ADSP</A>
<DD>
<DT><A HREF="NetworkingWOT-71.html#HEADING71-36">OTBind</A>
<DD>
<DT><A HREF="NetworkingWOT-71.html#HEADING71-40">OTConnect</A>
<DD>
<DT><A HREF="NetworkingWOT-71.html#HEADING71-43">OTRcvConnect</A>
<DD>
<DT><A HREF="NetworkingWOT-71.html#HEADING71-46">OTListen</A>
<DD>
<DT><A HREF="NetworkingWOT-71.html#HEADING71-49">OTAccept</A>
<DD>
<DT><A HREF="NetworkingWOT-71.html#HEADING71-52">OTSnd</A>
<DD>
<DT><A HREF="NetworkingWOT-71.html#HEADING71-55">OTRcv</A>
<DD>
<DT><A HREF="NetworkingWOT-71.html#HEADING71-58">OTSndDisconnect</A>
<DD>
<DT><A HREF="NetworkingWOT-71.html#HEADING71-62">OTRcvDisconnect</A>
<DD>
</DL>
</B>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="NetworkingWOT-70.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="NetworkingWOT-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="NetworkingWOT-491.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A>  <A HREF="NetworkingWOT-72.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="NetworkingWOT-4.html">&copy; Apple Computer, Inc.</A><br>15 JAN 1998<P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML> 
