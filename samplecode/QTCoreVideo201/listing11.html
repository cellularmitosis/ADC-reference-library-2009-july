<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>QTCoreVideo201 - /Classes/OpenGL/FBO/OpenGLFBOKit.m</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/GraphicsImaging/index.html">Graphics & Imaging</a> &gt; <a href="../../samplecode/GraphicsImaging/idxVideo-date.html">Video</a> &gt; <A HREF="javascript:location.replace('index.html');">QTCoreVideo201</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->


	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">QTCoreVideo201</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/Classes/OpenGL/FBO/OpenGLFBOKit.m</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/Classes/Alert/Alert.c</option>
<option value="listing2.html">/Classes/Alert/Alert.h</option>
<option value="listing3.html">/Classes/Alert/AlertPanelKit.h</option>
<option value="listing4.html">/Classes/Alert/AlertPanelKit.m</option>
<option value="listing5.html">/Classes/MemObject/MemObject.h</option>
<option value="listing6.html">/Classes/MemObject/MemObject.m</option>
<option value="listing7.html">/Classes/MemObject/Memory.c</option>
<option value="listing8.html">/Classes/MemObject/Memory.h</option>
<option value="listing9.html">/Classes/OpenGL/FBO/OpenGLFBOAlertPanelMessages.h</option>
<option value="listing10.html">/Classes/OpenGL/FBO/OpenGLFBOKit.h</option>
<option value="listing11.html">/Classes/OpenGL/FBO/OpenGLFBOKit.m</option>
<option value="listing12.html">/Classes/OpenGL/FBO/OpenGLFBOStatusKit.h</option>
<option value="listing13.html">/Classes/OpenGL/FBO/OpenGLFBOStatusKit.m</option>
<option value="listing14.html">/Classes/OpenGL/Quad/OpenGLQuad.h</option>
<option value="listing15.html">/Classes/OpenGL/Quad/OpenGLQuad.m</option>
<option value="listing16.html">/Classes/OpenGL/Teapot/OpenGLTeapot.h</option>
<option value="listing17.html">/Classes/OpenGL/Teapot/OpenGLTeapot.m</option>
<option value="listing18.html">/Classes/OpenGL/Teapot/OpenGLTeapotList.c</option>
<option value="listing19.html">/Classes/OpenGL/Teapot/OpenGLTeapotList.h</option>
<option value="listing20.html">/Classes/OpenGL/Teapot/OpenGLTeapotTextured.h</option>
<option value="listing21.html">/Classes/OpenGL/Teapot/OpenGLTeapotTextured.m</option>
<option value="listing22.html">/Classes/OpenGL/View/OpenGLViewKit.h</option>
<option value="listing23.html">/Classes/OpenGL/View/OpenGLViewKit.m</option>
<option value="listing24.html">/Classes/QT/CoreVideo/QTCoreVideoController.h</option>
<option value="listing25.html">/Classes/QT/CoreVideo/QTCoreVideoController.m</option>
<option value="listing26.html">/Classes/QT/CoreVideo/QTCoreVideoOpenGLView.h</option>
<option value="listing27.html">/Classes/QT/CoreVideo/QTCoreVideoOpenGLView.m</option>
<option value="listing28.html">/Classes/QT/VisualContext/QTVisualContextKit.h</option>
<option value="listing29.html">/Classes/QT/VisualContext/QTVisualContextKit.m</option>
<option value="listing30.html">/main.m</option></select>
				</p>
				</form>
				<p><strong><a href="QTCoreVideo201.zip">Download Sample</a></strong> (&#147;QTCoreVideo201.zip&#148;, 1.29M)<BR>
<strong><a href="QTCoreVideo201.dmg">Download Sample</a></strong> (&#147;QTCoreVideo201.dmg&#148;, 1.28M)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">//---------------------------------------------------------------------------
//
//    File: OpenGLFBOKit.m
//
//  Abstract: Utility class for managing FBOs
//              
//  Disclaimer: IMPORTANT:  This Apple software is supplied to you by Apple
//  Computer, Inc. (&quot;Apple&quot;) in consideration of your agreement to the
//  following terms, and your use, installation, modification or
//  redistribution of this Apple software constitutes acceptance of these
//  terms.  If you do not agree with these terms, please do not use,
//  install, modify or redistribute this Apple software.
//  
//  In consideration of your agreement to abide by the following terms, and
//  subject to these terms, Apple grants you a personal, non-exclusive
//  license, under Apple's copyrights in this original Apple software (the
//  &quot;Apple Software&quot;), to use, reproduce, modify and redistribute the Apple
//  Software, with or without modifications, in source and/or binary forms;
//  provided that if you redistribute the Apple Software in its entirety and
//  without modifications, you must retain this notice and the following
//  text and disclaimers in all such redistributions of the Apple Software. 
//  Neither the name, trademarks, service marks or logos of Apple Computer,
//  Inc. may be used to endorse or promote products derived from the Apple
//  Software without specific prior written permission from Apple.  Except
//  as expressly stated in this notice, no other rights or licenses, express
//  or implied, are granted by Apple herein, including but not limited to
//  any patent rights that may be infringed by your derivative works or by
//  other works in which the Apple Software may be incorporated.
//  
//  The Apple Software is provided by Apple on an &quot;AS IS&quot; basis.  APPLE
//  MAKES NO WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION
//  THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY AND FITNESS
//  FOR A PARTICULAR PURPOSE, REGARDING THE APPLE SOFTWARE OR ITS USE AND
//  OPERATION ALONE OR IN COMBINATION WITH YOUR PRODUCTS.
//  
//  IN NO EVENT SHALL APPLE BE LIABLE FOR ANY SPECIAL, INDIRECT, INCIDENTAL
//  OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
//  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
//  INTERRUPTION) ARISING IN ANY WAY OUT OF THE USE, REPRODUCTION,
//  MODIFICATION AND/OR DISTRIBUTION OF THE APPLE SOFTWARE, HOWEVER CAUSED
//  AND WHETHER UNDER THEORY OF CONTRACT, TORT (INCLUDING NEGLIGENCE),
//  STRICT LIABILITY OR OTHERWISE, EVEN IF APPLE HAS BEEN ADVISED OF THE
//  POSSIBILITY OF SUCH DAMAGE.
// 
//  Copyright (c) 2008 Apple Inc., All rights reserved.
//
//---------------------------------------------------------------------------

//---------------------------------------------------------------------------

#import &quot;AlertPanelKit.h&quot;
#import &quot;OpenGLFBOStatusKit.h&quot;
#import &quot;OpenGLFBOKit.h&quot;

//---------------------------------------------------------------------------

//---------------------------------------------------------------------------

struct OpenGLImageBuffer
{
    GLubyte  *data;            // Pointer to the top left pixel of the buffer.
    GLuint      height;        // The height (in pixels) of the buffer
    GLuint      width;        // The width (in pixels) of the buffer
    GLuint    rowBytes;        // The number of bytes in a pixel row
};

typedef struct OpenGLImageBuffer  OpenGLImageBuffer;

//---------------------------------------------------------------------------

struct OpenGLTextureAttributes
{
    GLuint             name;                // texture id
    GLuint             samplesPerPixel;        // number of bytes per pixel
    GLuint             size;                // width * height * samples per pixel
    GLint              level;                // level-of-detail    number
    GLint              border;                // width of the border, either 0  or 1
    GLint              xoffset;                // x offset for texture copy
    GLint              yoffset;                // y offset for texture copy
    GLenum             target;                // e.g., texture 2D or texture rectangle
    GLenum             hint;                // type of texture storage
    GLenum             format;                // format
    GLenum             internalFormat;        // internal format
    GLenum             type;                // OpenGL specific type
    OpenGLImageBuffer  buffer;                // An image buffer
};

typedef struct OpenGLTextureAttributes  OpenGLTextureAttributes;

//---------------------------------------------------------------------------

struct OpenGLFramebufferAttributes
{
    GLuint   name;            // Framebuffer object id
    GLenum   target;        // Framebuffer target
    GLenum   attachment;    // Color attachment &quot;n&quot; extension
    BOOL     isValid;        // Framebuffer status
};

typedef struct OpenGLFramebufferAttributes  OpenGLFramebufferAttributes;

//---------------------------------------------------------------------------

struct OpenGLRenderbufferAttributes
{
    GLuint   name;                // Depth renderbuffer id
    GLenum   internalFormat;    // Renderbuffer internal format
    GLenum   target;            // Target type for renderbuffer
    GLenum   attachment;        // Type of frameBufferAttachment for renderbuffer
};

typedef struct OpenGLRenderbufferAttributes  OpenGLRenderbufferAttributes;

//---------------------------------------------------------------------------

struct OpenGLViewportAttributes
{
    GLint    x;            // lower left x coordinate
    GLint    y;            // lower left y coordinate
    GLsizei  width;        // viewport height
    GLsizei  height;    // viewport width
};

typedef struct OpenGLViewportAttributes  OpenGLViewportAttributes;

//---------------------------------------------------------------------------

struct OpenGLOrthoProjAttributes
{
    GLdouble left;        // left vertical clipping plane
    GLdouble right;        // right vertical clipping plane
    GLdouble bottom;    // bottom horizontal clipping plane
    GLdouble top;        // top horizontal clipping plane
    GLdouble zNear;        // nearer depth clipping plane
    GLdouble zFar;        // farther depth clipping plane
};

typedef struct OpenGLOrthoProjAttributes  OpenGLOrthoProjAttributes;

//---------------------------------------------------------------------------

struct OpenGLQuadAttributes
{
    GLuint   name;        // display list id
    GLfloat  width;        // quad width
    GLfloat  height;    // quad height
};

typedef struct OpenGLQuadAttributes  OpenGLQuadAttributes;

//---------------------------------------------------------------------------

struct OpenGLFBOAttributes
{
    OpenGLOrthoProjAttributes     orthographic;        // Attributes for orthographic projection
    OpenGLViewportAttributes      viewport;            // FBO viewport dimensions
    OpenGLTextureAttributes       texture;            // Texture bound to the framebuffer
    OpenGLQuadAttributes          quad;             // Quad attributes for FBO drawing
    OpenGLFramebufferAttributes   framebuffer;        // Framebuffer object attributes
    OpenGLRenderbufferAttributes  renderbuffer;        // Depth render buffer
};

typedef struct OpenGLFBOAttributes  OpenGLFBOAttributes;

//---------------------------------------------------------------------------

//---------------------------------------------------------------------------

#pragma mark -- OpenGL Texture Initializations --

//---------------------------------------------------------------------------
//
// The texture range hints parameters can be either of:
//
//        theAttributes-&gt;texture.hint = GL_STORAGE_SHARED_APPLE;  VRAM
//        theAttributes-&gt;texture.hint = GL_STORAGE_CACHED_APPLE;  AGP
//
// Some other initialization values may come from:
//
//        theAttributes-&gt;texture.target         = GL_TEXTURE_RECTANGLE_EXT;
//        theAttributes-&gt;texture.format         = GL_BGRA_EXT;
//        theAttributes-&gt;texture.internalFormat = GL_RGBA;
//
// For samples-per-pixel with OpenGL type GL_UNSIGNED_INT_8_8_8_8 or 
// GL_UNSIGNED_INT_8_8_8_8_REV:
//
//        theAttributes-&gt;texture.samplesPerPixel = 4;
//
//---------------------------------------------------------------------------

static void InitOpenGLTextureAttributes( const NSSize *theTextureSize, OpenGLFBOAttributesRef theAttributes )
{
    theAttributes-&gt;texture.name            = 0;
    theAttributes-&gt;texture.hint            = GL_STORAGE_PRIVATE_APPLE;
    theAttributes-&gt;texture.level           = 0;
    theAttributes-&gt;texture.border          = 0;
    theAttributes-&gt;texture.xoffset         = 0;
    theAttributes-&gt;texture.yoffset         = 0;
    theAttributes-&gt;texture.target          = GL_TEXTURE_RECTANGLE_ARB;
    theAttributes-&gt;texture.format          = GL_BGRA;
    theAttributes-&gt;texture.type            = GL_UNSIGNED_INT_8_8_8_8_REV;
    theAttributes-&gt;texture.internalFormat  = GL_RGBA8;
    theAttributes-&gt;texture.samplesPerPixel = 4;
    theAttributes-&gt;texture.buffer.width    = (GLuint)theTextureSize-&gt;width;
    theAttributes-&gt;texture.buffer.height   = (GLuint)theTextureSize-&gt;height;
    theAttributes-&gt;texture.buffer.rowBytes = theAttributes-&gt;texture.buffer.width  * theAttributes-&gt;texture.samplesPerPixel;
    theAttributes-&gt;texture.size            = theAttributes-&gt;texture.buffer.height * theAttributes-&gt;texture.buffer.rowBytes;
    theAttributes-&gt;texture.buffer.data     = NULL;
} // InitOpenGLTextureAttributes
 
//---------------------------------------------------------------------------

static void InitOpenGLQuadAttributes( OpenGLFBOAttributesRef theAttributes )
{
    theAttributes-&gt;quad.name   = 0;
    theAttributes-&gt;quad.width  = theAttributes-&gt;texture.buffer.width;
    theAttributes-&gt;quad.height = theAttributes-&gt;texture.buffer.height;
} // InitOpenGLQuadAttributes

//---------------------------------------------------------------------------

static void InitOpenGLFramebufferAttributes( OpenGLFBOAttributesRef theAttributes )
{
    theAttributes-&gt;framebuffer.name       = 0;
    theAttributes-&gt;framebuffer.target     = GL_FRAMEBUFFER_EXT;
    theAttributes-&gt;framebuffer.attachment = GL_COLOR_ATTACHMENT0_EXT;
    theAttributes-&gt;framebuffer.isValid    = NO;
} // InitOpenGLFramebufferAttributes

//---------------------------------------------------------------------------

static void InitOpenGLRenderbufferAttributes( OpenGLFBOAttributesRef theAttributes )
{
    theAttributes-&gt;renderbuffer.name           = 0;
    theAttributes-&gt;renderbuffer.target         = GL_RENDERBUFFER_EXT;
    theAttributes-&gt;renderbuffer.internalFormat = GL_DEPTH_COMPONENT24;
    theAttributes-&gt;renderbuffer.attachment     = GL_DEPTH_ATTACHMENT_EXT;
} // InitOpenGLRenderbufferAttributes

//---------------------------------------------------------------------------

static void InitOpenGLViewportAttributes( OpenGLFBOAttributesRef theAttributes )
{
    theAttributes-&gt;viewport.x      = 0;
    theAttributes-&gt;viewport.y      = 0;
    theAttributes-&gt;viewport.width  = theAttributes-&gt;texture.buffer.width;
    theAttributes-&gt;viewport.height = theAttributes-&gt;texture.buffer.height;
} // InitOpenGLViewportAttributes

//---------------------------------------------------------------------------

static void InitOpenGLOrthoProjAttributes( OpenGLFBOAttributesRef theAttributes )
{
    theAttributes-&gt;orthographic.left   =  0;
    theAttributes-&gt;orthographic.right  =  theAttributes-&gt;texture.buffer.width;
    theAttributes-&gt;orthographic.bottom =  0;
    theAttributes-&gt;orthographic.top    =  theAttributes-&gt;texture.buffer.height;
    theAttributes-&gt;orthographic.zNear  = -10.0;
    theAttributes-&gt;orthographic.zFar   =  10.0;
} // InitOpenGLOrthoProjAttributes

//---------------------------------------------------------------------------

//---------------------------------------------------------------------------

#pragma mark -- Check FBO Status --

//---------------------------------------------------------------------------

//---------------------------------------------------------------------------

#pragma mark

//---------------------------------------------------------------------------

//---------------------------------------------------------------------------

@implementation OpenGLFBOKit

//---------------------------------------------------------------------------

#pragma mark -- Initialize an OpenGL FBO --

//---------------------------------------------------------------------------

- (void) initFBOAttributes:(const NSSize *)theTextureSize
{
    InitOpenGLTextureAttributes( theTextureSize, attributes );
    InitOpenGLQuadAttributes( attributes );
    InitOpenGLViewportAttributes( attributes );
    InitOpenGLOrthoProjAttributes( attributes );
    InitOpenGLRenderbufferAttributes( attributes );
    InitOpenGLFramebufferAttributes( attributes );
} // initFBOAttributes

//---------------------------------------------------------------------------

 - (void) newQuad
 {
    attributes-&gt;quad.name = glGenLists( 1 );

    glNewList( attributes-&gt;quad.name, GL_COMPILE );

        glBegin(GL_QUADS);
        
            glTexCoord2f( 0.0f, 0.0f );
            glVertex2f( 0.0f, 0.0f );
            
            glTexCoord2f( 0.0f, attributes-&gt;texture.buffer.height );
            glVertex2f( 0.0f, attributes-&gt;quad.height );
            
            glTexCoord2f( attributes-&gt;texture.buffer.width, attributes-&gt;texture.buffer.height );
            glVertex2f( attributes-&gt;quad.width, attributes-&gt;quad.height );
            
            glTexCoord2f( attributes-&gt;texture.buffer.width, 0.0f );
            glVertex2f( attributes-&gt;quad.width, 0.0f );

        glEnd();

    glEndList();
} // newQuad
 
//---------------------------------------------------------------------------
//
// Initialize the fbo bound texture
//
//---------------------------------------------------------------------------    

- (void) newTexture
{
    glDisable(GL_TEXTURE_2D);
    glEnable(attributes-&gt;texture.target);
    
    glTextureRangeAPPLE(attributes-&gt;texture.target, 0, NULL);
    glTextureRangeAPPLE(GL_TEXTURE_2D, 0, NULL);
    glPixelStorei(GL_UNPACK_CLIENT_STORAGE_APPLE, GL_FALSE);

    glGenTextures(1, &amp;attributes-&gt;texture.name);
    glBindTexture(attributes-&gt;texture.target, attributes-&gt;texture.name);

    glTexParameteri(attributes-&gt;texture.target, GL_TEXTURE_STORAGE_HINT_APPLE, GL_STORAGE_PRIVATE_APPLE);
    glTexParameteri(attributes-&gt;texture.target, GL_TEXTURE_MIN_FILTER, GL_NEAREST);
    glTexParameteri(attributes-&gt;texture.target, GL_TEXTURE_MAG_FILTER, GL_NEAREST);
    glTexParameteri(attributes-&gt;texture.target, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
    glTexParameteri(attributes-&gt;texture.target, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
    
    glTexImage2D(    attributes-&gt;texture.target, 
                    attributes-&gt;texture.level,
                    attributes-&gt;texture.internalFormat, 
                    attributes-&gt;texture.buffer.width, 
                    attributes-&gt;texture.buffer.height, 
                    attributes-&gt;texture.border, 
                    attributes-&gt;texture.format, 
                    attributes-&gt;texture.type, 
                    attributes-&gt;texture.buffer.data );
} // newTexture

//---------------------------------------------------------------------------
//
// Initialize depth render buffer
//
//---------------------------------------------------------------------------

- (void) newDepthRenderbuffer
{
    glGenRenderbuffersEXT(1, &amp;attributes-&gt;renderbuffer.name);

    glBindRenderbufferEXT(attributes-&gt;renderbuffer.target, attributes-&gt;renderbuffer.name);

    glRenderbufferStorageEXT(    attributes-&gt;renderbuffer.target, 
                                attributes-&gt;renderbuffer.internalFormat, 
                                attributes-&gt;texture.buffer.width, 
                                attributes-&gt;texture.buffer.height );
} // newDepthRenderbuffer

//---------------------------------------------------------------------------
//
// Bind to FBO before checking status
//
//---------------------------------------------------------------------------

- (void) bindToFBO
{    
    glGenFramebuffersEXT(1, &amp;attributes-&gt;framebuffer.name);

    glBindFramebufferEXT(attributes-&gt;framebuffer.target, attributes-&gt;framebuffer.name);
    
    glFramebufferTexture2DEXT(    attributes-&gt;framebuffer.target, 
                                attributes-&gt;framebuffer.attachment, 
                                attributes-&gt;texture.target, 
                                attributes-&gt;texture.name,
                                attributes-&gt;texture.level );
    
    glFramebufferRenderbufferEXT(    attributes-&gt;framebuffer.target, 
                                    attributes-&gt;renderbuffer.attachment, 
                                    attributes-&gt;renderbuffer.target, 
                                    attributes-&gt;renderbuffer.name );
    
    attributes-&gt;framebuffer.isValid = [[OpenGLFBOStatusKit withFBOTarget:attributes-&gt;framebuffer.target 
                                                                    exit:YES] framebufferComplete];

    glBindRenderbufferEXT(attributes-&gt;renderbuffer.target, 0);
    glBindFramebufferEXT(attributes-&gt;framebuffer.target, 0);
} // bindToFBO

//---------------------------------------------------------------------------

- (void) newFBO:(const NSSize *)theTextureSize
{
    [self initFBOAttributes:theTextureSize];
    [self newTexture];
    [self newQuad];
    [self newDepthRenderbuffer];
    [self bindToFBO];
} // newFBO

//---------------------------------------------------------------------------
//
// Initialize on startup
//
//---------------------------------------------------------------------------

- (id) initFBOWithSize:(NSSize)theTextureSize
{
    self = [super initMemoryWithType:kMemAlloc size:sizeof(OpenGLFBOAttributes)];
    
    if ( self )
    {
        attributes = (OpenGLFBOAttributesRef)[self pointer];
        
        if ( [self isPointerValid]  )
        {
            [self newFBO:&amp;theTextureSize];
        } // if
        else
        {
            [[AlertPanelKit withTitle:@&quot;OpenGL FBO Kit&quot; 
                              message:@&quot;Failure Allocating Memory For FBO Attributes&quot;
                                 exit:YES] displayAlertPanel];
        } // else
    } // if
    
    return  self;
} // initFBOWithSize

//---------------------------------------------------------------------------

#pragma mark -- Cleanup all the Resources --

//---------------------------------------------------------------------------

- (void) deleteOpenGLFBO
{
    if ( attributes-&gt;renderbuffer.name )
    {
        glDeleteRenderbuffersEXT( 1, &amp;attributes-&gt;renderbuffer.name );
    } // if
    
    if ( attributes-&gt;framebuffer.name )
    {
        glDeleteFramebuffersEXT( 1, &amp;attributes-&gt;framebuffer.name );
    } // if
    
    if ( attributes-&gt;quad.name )
    {
        glDeleteLists( attributes-&gt;quad.name, 1 );
    } // if
    
    if ( attributes-&gt;texture.name )
    {
        glDeleteTextures( 1, &amp;attributes-&gt;texture.name );
    } // if
} // deleteOpenGLFBO

//---------------------------------------------------------------------------

- (void) dealloc 
{
    [self  deleteOpenGLFBO];
    [super dealloc];
} // dealloc

//---------------------------------------------------------------------------

#pragma mark -- Draw into FBO --

//---------------------------------------------------------------------------
//
// Reset the current viewport
//
//---------------------------------------------------------------------------

- (void) reset
{
    glClear( GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT );

    glViewport(    attributes-&gt;viewport.x, 
                attributes-&gt;viewport.y, 
                attributes-&gt;viewport.width, 
                attributes-&gt;viewport.height );
    
    // select the projection matrix
    
    glMatrixMode(GL_PROJECTION);
    
     // reset it
     
    glLoadIdentity();

    // Orthographic projection
    
    glOrtho(    attributes-&gt;orthographic.left, 
                attributes-&gt;orthographic.right, 
                attributes-&gt;orthographic.bottom, 
                attributes-&gt;orthographic.top, 
                attributes-&gt;orthographic.zNear, 
                attributes-&gt;orthographic.zFar );
    
    glMatrixMode(GL_TEXTURE);
    glLoadIdentity();
    
    glMatrixMode(GL_MODELVIEW);
    glLoadIdentity();
} // reset

//---------------------------------------------------------------------------

- (void) draw:(CVOpenGLTextureRef)theCVOpenGLTexture
{
    // get the texture target
    
    GLenum target = CVOpenGLTextureGetTarget( theCVOpenGLTexture );
    
    // get the texture target name
    
    GLint name = CVOpenGLTextureGetName( theCVOpenGLTexture );
    
    // bind to the CoreVideo texture

    glBindTexture( target, name );
    
    // draw the quad
    
    glCallList( attributes-&gt;quad.name );
} // draw

//---------------------------------------------------------------------------
//
// Render frame provided by Core Video to the Framebuffer Object (FBO)
//
//---------------------------------------------------------------------------

- (void) update:(CVOpenGLTextureRef)theCVOpenGLTexture
{
    // bind buffers and make attachments
    
    glBindFramebufferEXT( attributes-&gt;framebuffer.target, attributes-&gt;framebuffer.name );
    glBindRenderbufferEXT( attributes-&gt;renderbuffer.target, attributes-&gt;renderbuffer.name );

    // we have a video frame so draw to fbo
    
    // reset the current viewport
    
    [self reset];
    
    // draw to FBO

    [self draw:theCVOpenGLTexture];
    
    // unbind buffers
    
    glBindRenderbufferEXT( attributes-&gt;renderbuffer.target, 0 ); 
    glBindFramebufferEXT( attributes-&gt;framebuffer.target, 0 );
} // update

//---------------------------------------------------------------------------

- (void) bind
{
    glBindTexture( attributes-&gt;texture.target, attributes-&gt;texture.name );
} // bind

//---------------------------------------------------------------------------

@end

//---------------------------------------------------------------------------

//---------------------------------------------------------------------------
</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/QTCoreVideo201/listing11.html%3Fid%3DDTS40007784-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/QTCoreVideo201/listing11.html%3Fid%3DDTS40007784-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/QTCoreVideo201/listing11.html%3Fid%3DDTS40007784-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>