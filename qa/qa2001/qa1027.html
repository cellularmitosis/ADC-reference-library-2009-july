<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"            "http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Q&amp;A QA1027: Improving ATSUI Text Drawing Performance</title><meta name="keywords" content="ATSUI text drawing performance"><meta name="Description" content="Technical Q&amp;A QA1027: This Q&amp;A talks about one way of improvingATSUI text drawing performance"><meta name="categories" content="Text, Human Interface Toolbox, QuickDraw and Overview"><meta name="week-posted" content="Apr 16, 2001 - Apr 20, 2001"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10001579" title="Improving ATSUI Text Drawing Performance"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/Carbon/index.html">Carbon</a> &gt; <a href="../../technicalqas/Carbon/idxTextFonts-date.html">Text & Fonts</a> &gt; </p><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A QA1027</div>
<div id="pageheadsub">Improving ATSUI Text Drawing Performance</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600> <TR> <td align="left"><!-- begin_content --><hr width=500 align=center>                  <P id=p2>Q:      Is there any way I can improve text drawing performance when      using the ATSUI APIs?</p>                  <P id=p4>A:      Yes, there is.  By preallocating the <CODE>ATSUStyle</CODE> records used      by your application and reusing them whenever your application      draws some text using ATSUI, your text drawing performance      should improve.  The routine shown in Listing 1 illustrates how      your application can pre-allocate an <CODE>ATSUStyle</CODE> record based on      an Appearance theme font id.  </p><BR><BR><CENTER><TABLE BORDER=0 CELLPADDING=4 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>    /* MakeThemeATSUIStyle creates a simple ATSUI style record    that based on the current theme font ID that can be used in    calls to the ATSUI text drawing routines. */OSStatus MakeThemeATSUIStyle(ThemeFontID themeFontID,        ATSUStyle *theStyle) {    OSStatus err;    ATSUStyle localStyle;    ATSUFontID atsuFont;    Fixed atsuSize;    short atsuOrientation, fontFamily, fontSize;    Str255 fontName;    Style fontStyle;    Boolean trueVar = true, falseVar = false;        /* Three parrallel arrays for setting up attributes. */    ATSUAttributeTag theTags[] = {            kATSUFontTag, kATSUSizeTag, kATSUVerticalCharacterTag,            kATSUQDBoldfaceTag, kATSUQDItalicTag, kATSUQDUnderlineTag,            kATSUQDCondensedTag, kATSUQDExtendedTag        };    ByteCount theSizes[] = {            sizeof(ATSUFontID), sizeof(Fixed), sizeof(UInt16),            sizeof(Boolean), sizeof(Boolean), sizeof(Boolean),            sizeof(Boolean), sizeof(Boolean)        };    ATSUAttributeValuePtr theValues[] = {            NULL, NULL, NULL, NULL,            NULL, NULL, NULL, NULL        };        /* set up locals */    localStyle = NULL;    atsuFont = 0;    atsuSize = 0x00080000;    atsuOrientation = kATSUStronglyHorizontal;    /* or atsuOrientation = kATSUStronglyVertical */        /* calculate the theme font parameters */    err = GetThemeFont( themeFontID, smSystemScript,            fontName,  &amp;fontSize, &amp;fontStyle);    if (err != noErr) goto bail;    atsuSize = FixRatio(fontSize, 1);        /* set the values array to point to our locals */    theValues[0] = &amp;atsuFont;    theValues[1] = &amp;atsuSize;    theValues[2] = &amp;atsuOrientation;    theValues[3] = ((fontStyle &amp; bold) != 0 ? &amp;trueV : &amp;falseV);    theValues[4] = ((fontStyle &amp; italic) != 0 ? &amp;trueV : &amp;falseV);    theValues[5] = ((fontStyle &amp; underline) != 0 ? &amp;trueV : &amp;falseV);    theValues[6] = ((fontStyle &amp; condense) != 0 ? &amp;trueV : &amp;falseV);    theValues[7] = ((fontStyle &amp; extend) != 0 ? &amp;trueV : &amp;falseV);        /* calculate the font ID */    GetFNum( fontName, &amp;fontFamily);    err = ATSUFONDtoFontID( fontFamily, fontStyle, &amp;atsuFont);    if (err != noErr) goto bail;        /* find the font ID */    err = ATSUFindFontFromName((Ptr)fontName+1, (long)fontName[0],        kFontFullName, kFontMacintoshPlatform,        kFontRomanScript, kFontNoLanguage, &amp;atsuFont);    if (err != noErr) goto bail;        /* create a style */    err = ATSUCreateStyle(&amp;localStyle);    if (err != noErr) goto bail;        /* set the style attributes */    err = ATSUSetAttributes( localStyle,        sizeof(theTags)/sizeof(theTags[0]),        theTags, theSizes, theValues );    if (err != noErr) goto bail;        /* store the new style for the caller */    *theStyle = localStyle;    return noErr;bail:    if (localStyle != NULL) ATSUDisposeStyle(localStyle);    return err;}</pre></TD></TR><TR><td align="left"><P><B>Listing 1</B>. Allocating an <CODE>ATSUStyle</CODE> based on an Appearance theme font ID.</P></TD></TR></TABLE></CENTER><BR><BR>         <P id=p4>Once your application has allocated an <CODE>ATSUStyle</CODE> record, it can         be used again and again whenever your application needs to draw some         text using ATSUI.  The routine shown in Listing 2 illustrates how one         would go about using the style record in a routine that draws some         Unicode text.  </p><BR><BR><CENTER><TABLE BORDER=0 CELLPADDING=4 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>    /* RenderUnicodeString renders a CFString at (h, v) in the    current grafport using ATSUI using the style specified in    the atsui style record. */OSStatus RenderUnicodeString(ConstUniCharArrayPtr iText,        UniCharCount iTextLength, ATSUStyle theStyle,        short h, short v)  {    ATSUTextLayout theLayout = NULL;    OSStatus err;        /* set up our locals, verify parameters... */    if (iText == NULL || theStyle == NULL) return paramErr;    theLayout = NULL;    if (iTextLength == 0) return noErr;        /* create the ATSUI layout */    err = ATSUCreateTextLayoutWithTextPtr( iText, 0,        iTextLength, iTextLength, 1,        (unsigned long *) &amp;iTextLength, &amp;theStyle,        &amp;theLayout);    if (err != noErr) goto bail;        /* draw the text */    err = ATSUDrawText(theLayout, 0, iTextLength,            FixRatio(h, 1), FixRatio(v, 1));    if (err != noErr) goto bail;        /* done */    ATSUDisposeTextLayout(theLayout);    return noErr;bail:    if (theLayout != NULL) ATSUDisposeTextLayout(theLayout);    return err;}</pre></TD></TR><TR><td align="left"><P><B>Listing 2</B>. A routine that draws some text using a pre-allocated <CODE>ATSUStyle</CODE> record.</P></TD></TR></TABLE></CENTER><BR><BR>          <P><B>Downloadables</B></P>          <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">             <TR>                <td width=50 align=left>                   <P ALIGN=center>qa1027.hqx</P>                </TD>                <td align="left">                   <P>Source files illustrating techniques described herein.</P>                </TD>                <td width=60 align=left>                   <P><A HREF="downloads/qa1027.hqx">Download</A></P>                </TD>             </TR>               </TABLE>          <BR><hr width=500 align=center> <!-- begin_date --><H4 ALIGN=center>[Apr 17 2001]</H4><!-- end_date --></TD> </TR> </TABLE></CENTER><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/qa2001/qa1027.html%3Fid%3DDTS10001579-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/qa2001/qa1027.html%3Fid%3DDTS10001579-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/qa2001/qa1027.html%3Fid%3DDTS10001579-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>