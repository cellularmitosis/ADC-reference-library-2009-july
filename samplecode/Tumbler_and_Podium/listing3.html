<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>Tumbler and Podium - /TumblerSource/Tumbler_camera.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxGraphicsImaging-date.html">Graphics & Imaging</a> &gt; <A HREF="javascript:location.replace('index.html');">Tumbler and Podium</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/GraphicsImaging/index.html" target="_blank">Reference Library > Graphics & Imaging</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">Tumbler and Podium</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/TumblerSource/Tumbler_camera.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/TumblerSource/Tumbler_AEVT.c</option>
<option value="listing2.html">/TumblerSource/Tumbler_AEVT.h</option>
<option value="listing3.html">/TumblerSource/Tumbler_camera.c</option>
<option value="listing4.html">/TumblerSource/Tumbler_camera.h</option>
<option value="listing5.html">/TumblerSource/Tumbler_cursor.c</option>
<option value="listing6.html">/TumblerSource/Tumbler_cursor.h</option>
<option value="listing7.html">/TumblerSource/Tumbler_document.c</option>
<option value="listing8.html">/TumblerSource/Tumbler_document.h</option>
<option value="listing9.html">/TumblerSource/Tumbler_drag.c</option>
<option value="listing10.html">/TumblerSource/Tumbler_drag.h</option>
<option value="listing11.html">/TumblerSource/Tumbler_ErrorHandler.c</option>
<option value="listing12.html">/TumblerSource/Tumbler_ErrorHandler.h</option>
<option value="listing13.html">/TumblerSource/Tumbler_event.c</option>
<option value="listing14.html">/TumblerSource/Tumbler_event.h</option>
<option value="listing15.html">/TumblerSource/Tumbler_file.c</option>
<option value="listing16.html">/TumblerSource/Tumbler_file.h</option>
<option value="listing17.html">/TumblerSource/Tumbler_globals.h</option>
<option value="listing18.html">/TumblerSource/Tumbler_HideMenuBar.c</option>
<option value="listing19.html">/TumblerSource/Tumbler_HideMenuBar.h</option>
<option value="listing20.html">/TumblerSource/Tumbler_initialize.c</option>
<option value="listing21.html">/TumblerSource/Tumbler_initialize.h</option>
<option value="listing22.html">/TumblerSource/Tumbler_main.c</option>
<option value="listing23.html">/TumblerSource/Tumbler_main.h</option>
<option value="listing24.html">/TumblerSource/Tumbler_menus.c</option>
<option value="listing25.html">/TumblerSource/Tumbler_menus.h</option>
<option value="listing26.html">/TumblerSource/Tumbler_offscreen.c</option>
<option value="listing27.html">/TumblerSource/Tumbler_offscreen.h</option>
<option value="listing28.html">/TumblerSource/Tumbler_PICTImport.c</option>
<option value="listing29.html">/TumblerSource/Tumbler_PICTImport.h</option>
<option value="listing30.html">/TumblerSource/Tumbler_podium.c</option>
<option value="listing31.html">/TumblerSource/Tumbler_podium.h</option>
<option value="listing32.html">/TumblerSource/Tumbler_prototypes.h</option>
<option value="listing33.html">/TumblerSource/Tumbler_resources.h</option>
<option value="listing34.html">/TumblerSource/Tumbler_teutilities.c</option>
<option value="listing35.html">/TumblerSource/Tumbler_teutilities.h</option>
<option value="listing36.html">/TumblerSource/Tumbler_traps.c</option>
<option value="listing37.html">/TumblerSource/Tumbler_traps.h</option>
<option value="listing38.html">/TumblerSource/Tumbler_utility.c</option>
<option value="listing39.html">/TumblerSource/Tumbler_utility.h</option>
<option value="listing40.html">/TumblerSource/Tumbler_windows.c</option>
<option value="listing41.html">/TumblerSource/Tumbler_windows.h</option></select>
				</p>
				</form>
				<p><strong><a href="Tumbler_and_Podium.zip">Download Sample</a></strong> (&#147;Tumbler_and_Podium.zip&#148;, 1.07M)<BR>
<strong><a href="Tumbler_and_Podium.dmg">Download Sample</a></strong> (&#147;Tumbler_and_Podium.dmg&#148;, 1.15M)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">#include &lt;FixMath.h&gt;#include &quot;Tumbler_globals.h&quot;#include &quot;QD3D.h&quot;#include &quot;QD3DDrawContext.h&quot;#include &quot;QD3DDrawContext.h&quot;#include &quot;QD3DCamera.h&quot;#include &quot;QD3DView.h&quot;#include &quot;QD3DRenderer.h&quot;#include &quot;QD3DGroup.h&quot;#include &quot;QD3DMath.h&quot;#include &quot;Tumbler_prototypes.h&quot;#include &quot;QD3DGeometry.h&quot;#include &quot;QD3DLight.h&quot;#include &quot;Tumbler_camera.h&quot;void GetGroupBBox(  TQ3ViewObject    viewObject,  TQ3GroupObject    mainGroup,  TQ3GroupObject    lightGroup,  TQ3BoundingBox     *viewBBox){  TQ3Point3D           from   = { 0.0, 0.0, 1.0 };  TQ3Point3D           to     = { 0.0, 0.0, 0.0 };  TQ3Vector3D           up     = { 0.0, 1.0, 0.0 };    float             fieldOfView = .52359333333;  float             hither     =  0.5;  float             yon     =  1.5;  TQ3Status          status;    Q3View_StartBoundingBox(viewObject, kQ3ComputeBoundsExact);  do {    status = Q3DisplayGroup_Submit(mainGroup, viewObject);  } while (Q3View_EndBoundingBox(viewObject, viewBBox) == kQ3ViewStatusRetraverse);                          //  //  If we have a point model, then the &quot;viewBBox&quot; would end up  //  being a &quot;singularity&quot; at the location of the point.  As  //  this bounding &quot;box&quot; is used in setting up the camera spec,  //  we get bogus input into Escher.    {     float    xSize, ySize, zSize;        xSize = viewBBox-&gt;max.x - viewBBox-&gt;min.x;    ySize = viewBBox-&gt;max.y - viewBBox-&gt;min.y;    zSize = viewBBox-&gt;max.z - viewBBox-&gt;min.z;    if (xSize &lt;= kQ3RealZero &amp;&amp;        ySize &lt;= kQ3RealZero &amp;&amp;      zSize &lt;= kQ3RealZero) {            viewBBox-&gt;max.x += 0.0001;      viewBBox-&gt;max.y += 0.0001;      viewBBox-&gt;max.z += 0.0001;            viewBBox-&gt;min.x -= 0.0001;      viewBBox-&gt;min.y -= 0.0001;      viewBBox-&gt;min.z -= 0.0001;    }  }}#define  SIZESCALE  0.03#define POSSCALE  0.5void AdjustLightsPositions(  DocumentPtr theDocument){#if defined(ESCHER_VER_15) &amp;&amp; ESCHER_VER_15  TQ3BoundingBox     viewBBox;   TQ3Vector3D      diagonalVector, radius;  TQ3GroupPosition    position, lightPosition;  TQ3Object      ellipsoid;  TQ3Point3D      origin;  float        maxDimension;  TQ3GroupObject    lightGroup;  TQ3LightObject    theLight;  float    ratio;    GetGroupBBox(theDocument-&gt;theView, theDocument-&gt;documentGroup, nil, &amp;viewBBox);  Q3Point3D_Subtract(&amp;viewBBox.max,             &amp;viewBBox.min,             &amp;diagonalVector);  maxDimension = Q3Vector3D_Length(&amp;diagonalVector);  maxDimension *= 8.0 / 7.0;    ratio = 6.0 / maxDimension;    /* Adjust the light from the viewer first */    Q3View_GetLightGroup(theDocument-&gt;theView, &amp;lightGroup);      Q3Group_GetFirstPosition(lightGroup, &amp;lightPosition);  Q3Group_GetPositionObject(lightGroup, lightPosition, &amp;theLight);    origin.x = -10.0;  origin.y = 10.0;  origin.z = 30.0;    Q3PointLight_SetLocation(theLight, &amp;origin);  Q3Object_Dispose(theLight);    /* Set the geometry and the light parameters for the red light */  Q3Group_GetFirstPositionOfType(theDocument-&gt;light1,    kQ3ShapeTypeGeometry, &amp;position);  Q3Group_GetPositionObject(theDocument-&gt;light1, position, &amp;ellipsoid);    origin.x = ratio * diagonalVector.x * POSSCALE;  origin.y = ratio *  diagonalVector.y * POSSCALE;  origin.z =  ratio * diagonalVector.z * POSSCALE;  Q3Ellipsoid_SetOrigin( ellipsoid, &amp;origin);    radius.x = radius.z = 0.0;  radius.y = ratio * maxDimension * SIZESCALE;  Q3Ellipsoid_SetOrientation( ellipsoid, &amp;radius);    radius.x = radius.y = 0.0;  radius.z = ratio * maxDimension * SIZESCALE;  Q3Ellipsoid_SetMajorRadius( ellipsoid, &amp;radius);    radius.z = radius.y = 0.0;  radius.x = ratio * maxDimension * SIZESCALE;  Q3Ellipsoid_SetMinorRadius( ellipsoid, &amp;radius);  Q3Group_GetNextPosition(lightGroup, &amp;lightPosition);  Q3Group_GetPositionObject(lightGroup, lightPosition, &amp;theLight);    Q3PointLight_SetLocation(theLight, &amp;origin);    Q3Object_Dispose(theLight);    Q3Object_Dispose(ellipsoid);      /* Set the geometry and the light parameters for the green light */  Q3Group_GetFirstPositionOfType(theDocument-&gt;light2,    kQ3ShapeTypeGeometry, &amp;position);  Q3Group_GetPositionObject(theDocument-&gt;light2, position, &amp;ellipsoid);    origin.x = - ratio * diagonalVector.x * POSSCALE;  origin.y = - ratio *  diagonalVector.y *  POSSCALE;  origin.z = ratio * diagonalVector.z * POSSCALE;  Q3Ellipsoid_SetOrigin( ellipsoid, &amp;origin);    radius.x = radius.z = 0.0;  radius.y = ratio * maxDimension * SIZESCALE;  Q3Ellipsoid_SetOrientation( ellipsoid, &amp;radius);    radius.x = radius.y = 0.0;  radius.z = ratio * maxDimension * SIZESCALE;  Q3Ellipsoid_SetMajorRadius( ellipsoid, &amp;radius);    radius.z = radius.y = 0.0;  radius.x = ratio * maxDimension * SIZESCALE;  Q3Ellipsoid_SetMinorRadius( ellipsoid, &amp;radius);    Q3Group_GetNextPosition(lightGroup, &amp;lightPosition);  Q3Group_GetPositionObject(lightGroup, lightPosition, &amp;theLight);    Q3PointLight_SetLocation(theLight, &amp;origin);    Q3Object_Dispose(theLight);  Q3Object_Dispose(ellipsoid);    /* Set the geometry and the light parameters for the blue light */  Q3Group_GetFirstPositionOfType(theDocument-&gt;light3,    kQ3ShapeTypeGeometry, &amp;position);  Q3Group_GetPositionObject(theDocument-&gt;light3, position, &amp;ellipsoid);    origin.x = 0.0;  origin.y =  ratio * diagonalVector.y * POSSCALE + 1.0;  origin.z =  0.0;  Q3Ellipsoid_SetOrigin( ellipsoid, &amp;origin);    radius.x = radius.z = 0.0;  radius.y = ratio * maxDimension * SIZESCALE;  Q3Ellipsoid_SetOrientation( ellipsoid, &amp;radius);    radius.x = radius.y = 0.0;  radius.z = ratio * maxDimension * SIZESCALE;  Q3Ellipsoid_SetMajorRadius( ellipsoid, &amp;radius);    radius.z = radius.y = 0.0;  radius.x = ratio * maxDimension * SIZESCALE;  Q3Ellipsoid_SetMinorRadius( ellipsoid, &amp;radius);  Q3Group_GetNextPosition(lightGroup, &amp;lightPosition);  Q3Group_GetPositionObject(lightGroup, lightPosition, &amp;theLight);    Q3PointLight_SetLocation(theLight, &amp;origin);    Q3Object_Dispose(theLight);  Q3Object_Dispose(ellipsoid);  Q3Object_Dispose(lightGroup);#endif}//===========================================================================////  Routine:  AdjustCamera()////  Comments:  ////===========================================================================TQ3Point3D AdjustCamera(  DocumentPtr theDocument,  short        winWidth,  short        winHeight){  float             fieldOfView;  float             hither;  float             yon;  TQ3CameraPlacement      placement;  TQ3CameraRange        range;  TQ3BoundingBox         viewBBox;  long             fromAxis;    float             maxDimension;   float            xSize, ySize, zSize;  float            weights[2] = { 0.5, 0.5 };  TQ3Point3D          points[2];  TQ3Vector3D           viewVector;  TQ3Vector3D          normViewVector;  TQ3Vector3D          eyeToFrontClip;  TQ3Vector3D          eyeToBackClip;  float            viewDistance;  TQ3Vector3D          diagonalVector;  float            ratio;  TQ3CameraObject        camera;    Q3View_GetCamera(theDocument-&gt;theView, &amp;camera);    GetGroupBBox(theDocument-&gt;theView, theDocument-&gt;documentGroup,     theDocument-&gt;dynamicLights, &amp;viewBBox);  /*   *  If we have a point model, then the &quot;viewBBox&quot; would end up   *  being a &quot;singularity&quot; at the location of the point.  As   *  this bounding &quot;box&quot; is used in setting up the camera spec,   *  we get bogus input into Escher.   *   *  Therefore, determine if the bounding box is really really small   *  (kQ3RealZero) and increase it so it's just a little small.   */  xSize = viewBBox.max.x - viewBBox.min.x;  ySize = viewBBox.max.y - viewBBox.min.y;  zSize = viewBBox.max.z - viewBBox.min.z;  if (xSize &lt;= kQ3RealZero &amp;&amp;      ySize &lt;= kQ3RealZero &amp;&amp;    zSize &lt;= kQ3RealZero)    {    viewBBox.max.x += 0.0001;    viewBBox.max.y += 0.0001;    viewBBox.max.z += 0.0001;        viewBBox.min.x -= 0.0001;    viewBBox.min.y -= 0.0001;    viewBBox.min.z -= 0.0001;  }  points[0] = viewBBox.min;  points[1] = viewBBox.max;  /*     This sets the &quot;documentGroupCenter&quot; to the center of our bbox.        (point[0] * weight[0] + point[1] * weight[1]) or        (point[0] * 0.5 + point[1] * 0.5) or        point[0] + point[1]    -------------------, essentially, the average of the points.             2  */  Q3Point3D_AffineComb(points, weights, 2, &amp;theDocument-&gt;documentGroupCenter);  /*   *  The &quot;from&quot; point is on a vector perpendicular to the plane   *  in which the bounding box has greatest dimension.  As &quot;up&quot; is   *  always in the positive y direction, look at x and z directions.   */  xSize = viewBBox.max.x - viewBBox.min.x;  zSize = viewBBox.max.z - viewBBox.min.z;    if (xSize &gt; zSize) {    fromAxis = kQ3AxisZ;  } else {    fromAxis = kQ3AxisX;  }  /*   *  Compute the length of the diagonal of the bounding box.   *   *  The hither and yon planes are adjusted so that the    *  diagonal of the bounding box is 7/8 the size of the    *  minimum dimension of the view frustum. The diagonal is used instead    *  of the maximum size (in x, y, or z) so that when you rotate    *  the object, the corners don't get clipped out.    */  Q3Point3D_Subtract(    &amp;viewBBox.max,    &amp;viewBBox.min,    &amp;diagonalVector);  maxDimension  =  Q3Vector3D_Length(&amp;diagonalVector);  maxDimension  *=  8.0 / 7.0;    /*     This scales all objects in the scene so they gets scaled to fit    in the window. We're using the length of the diagonal of the box    to scale. We can now assume the maximum dimension of the model is    1.0.  */  ratio = 1.0 / maxDimension;        theDocument-&gt;documentGroupScale = ratio;    /*    Now, adjust the camera's hither and yon planes.        (We don't edit the camera location, etc. as it will always be in    the same location - we always scale the objects and leave the camera    in the same location.)  */  Q3Camera_GetPlacement(camera, &amp;placement);  /*     Compute the camera vector  */  Q3Point3D_Subtract(    &amp;placement.cameraLocation,    &amp;placement.pointOfInterest,    &amp;viewVector);  viewDistance = Q3Vector3D_Length(&amp;viewVector);  Q3Vector3D_Normalize(&amp;viewVector, &amp;normViewVector);  /*      Essentially, here we are &quot;scaling&quot; the normalized camera vector    to a location in front of the object (half of maxDimension)    and another location in back of the camera.        Assume these three vectors below are co-linear.                      A = ratio * maxDimension/2.0        |------hither-------||----A----|----A-----|    |------------------yon--------------------|        camera location                * -----------------&gt; * eyeToFrontClip    * --------camera vector------&gt; * object center    * --------------------------------------&gt; * eyeToBackClip  */    Q3Vector3D_Scale(&amp;normViewVector,            viewDistance - ratio * maxDimension/2.0,           &amp;eyeToFrontClip);            Q3Vector3D_Scale(&amp;normViewVector,           viewDistance + ratio * maxDimension/2.0,          &amp;eyeToBackClip);  hither   = Q3Vector3D_Length(&amp;eyeToFrontClip);  yon   = Q3Vector3D_Length(&amp;eyeToBackClip);    /*    Set the field of view. This will determine the width of our lens.    Or, (more appropriately), as someone here mentioned,    where the blinders begin in our image.        This is the angle created by the triangle of the camera vector and the    maximum dimension of our object.        We use the hither point because it's closest and convenient.        we know:        atan(opposite/adjacent) = the angle we need        Our angle is at the camera, so our &quot;opposite&quot; leg is &quot;A&quot; (above)    our &quot;adjacent&quot; leg is the hither length.        We double our result because our triangle gets us the half angle    for the entire field of view.   */    fieldOfView = 2 * atan((ratio * maxDimension/2.0)/hither);  range.hither         = hither;  range.yon           = yon;  Q3Camera_SetRange(camera, &amp;range);  Q3ViewAngleAspectCamera_SetFOV(    camera, fieldOfView);  /*     And finally, set up our aspect ratio depending on how big the     window is.  */  Q3ViewAngleAspectCamera_SetAspectRatio(    camera, (float) winWidth / (float) winHeight);  Q3Object_Dispose(camera);    return(theDocument-&gt;documentGroupCenter);}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/Tumbler_and_Podium/listing3.html%3Fid%3DDTS10000127-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/Tumbler_and_Podium/listing3.html%3Fid%3DDTS10000127-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/Tumbler_and_Podium/listing3.html%3Fid%3DDTS10000127-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>