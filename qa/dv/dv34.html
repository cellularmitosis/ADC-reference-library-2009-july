<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!--Template 06-20-02--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Q&amp;A DV34: Secondary Interrupts on the Page Fault Path</title>		<meta name="keywords" content="Mac OS 8 SCSI page fault path secondary interrupts ">	<meta name="Description" content="Technical Q&amp;A DV34: Q&amp;A tells why a SCSI Interface Moduleor any entity on the page fault path shouldn't use secondaryinterrupts. It then goes through a thorough inspection ofsecondary interrupts, and gives a definition to the pagefault path. Q&amp;A also contains short gestalt code snippetthat goes with the newer OS's that have a workaround forsecondary interrupt polling."><meta name="categories" content="Devices"><meta name="week-posted" content="Dec 21, 1998 - Dec 25, 1998"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10001175" title="Secondary Interrupts on the Page Fault Path"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalqas/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/index.html" target="_blank">Reference Library > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A DV34</div>
<div id="pageheadsub">Secondary Interrupts on the Page Fault Path</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><!-- begin_content --> <CENTER><TABLE BORDER=0 CELLPADDING=0 WIDTH=600><TR> <td align="left"><hr width=500 align=center>                  <p id=p2>Q: I'd like to use secondary interrupts in my SCSI         Interface Module (SIM) but doing so causes strange deadlocks.         Is it legal to use secondary interrupts in a SIM?</P>                  <p id=p4>A: In general, using secondary interrupts on the page         fault path is not legal. There are, however, circumstances         under which it works. As with most of my Q&amp;A, this         takes some explanation.</P>                  <BR><TABLE BORDER=0 CELLPADDING=5 WIDTH=550> <TR> <td bgcolor="#e6e6e6" align=left>                  <p id=p4><B>Note:</B><BR>                                    The <STRONG>page fault path</STRONG> is the set                  system of system software and device drivers that                  are required to resolve a virtual memory page                  fault. The page fault path is an interesting                  concept in operating system design, because most                  operating systems require that all entities on the                  page fault path not cause a page fault. Double page                  faults will commonly cause an operating system to                  "panic".</P>                                    <p id=p4>On Mac OS, double page faults are always fatal.                  Mac OS prevents double page faults by disabling                  "user code" while page fault path entities are                  executing. In addition, all entities on the page                  fault path must be capable of performing an I/O                  request with interrupts disabled.</P>                                    <p id=p4>For more information about the virtual memory                  implementation on Mac OS, see Technote 1094                  <a href="../../technotes/tn/tn1094.html">Virtual                  Memory Application Compatibility</A>.</p>               </TD></TR>         </TABLE>         <BR><TABLE BORDER=0 CELLPADDING=5 WIDTH=550> <TR> <td bgcolor="#e6e6e6" align=left>                  <p id=p4><B>IMPORTANT:</B><BR>                                    While this Q&amp;A is couched in terms of SCSI                  Manager SIMs, the same logic applies to any entity                  on the page fault path. Third-party developer                  opportunities on the page fault path currently                  include SIMs, AIMs (ATA Interface Modules), and                  disk drivers. This list will grow as new                  technologies, like FireWire, evolve to support disk                  devices.</p>               </TD></TR>         </TABLE>                  <p id=p4>The two common reasons for using secondary interrupts in         a device driver are:</P>                  <OL>            <LI><p id=p4>Reducing interrupt latency -- By deferring complex            work to a secondary interrupt, you can reduce the amount            of time your driver spends at hardware interrupt time,            and thereby reduce the overall interrupt latency of the            system.</p></li>                        <LI><p id=p4>Concurrency guarantee -- Secondary interrupts are            guaranteed to be serialized; only one secondary interrupt            handler can be running at any point in time. This is a            very useful concurrency control mechanism. If you always            access global data structures from your secondary            interrupt handler, you can be assured that only one            thread of execution is reading or writing those global            data structures at a time.</p></li>         </OL>                  <p id=p4>However, secondary interrupts can cause problems for         devices on the page fault path. Imagine the following         scenario:</P>                  <OL>            <LI><p id=p4>Your SIM takes a hardware interrupt, schedules a            secondary interrupt (SIH A), and then returns from its            hardware interrupt handler. For your SIM to make forward            progress, its secondary interrupt handler must execute to            completion.</p></li>                        <LI><p id=p4>The interrupt systems notices that it is returning to            interrupt level 0 and begins processing secondary            interrupts. It enables interrupts and starts running            secondary interrupt handlers.</p></li>                        <LI><p id=p4>While SIH A is running, a Time Manager interrupt            occurs. The timer task executes, schedules a deferred            task, and then returns.</p></li>                        <LI><p id=p4>The interrupt system notices that it is returning            from the Time Manager interrupt to interrupt level 0.            There are deferred tasks to run, so it enables interrupts            and starts running deferred tasks.</p></li>                        <LI><p id=p4>One of the deferred tasks causes a page fault.</p></li>                        <LI><p id=p4>The Virtual Memory Manager intercepts the page fault,            and makes a synchronous request to the disk device driver            to read the page contents from the backing store.</p></li>                        <LI><p id=p4>The disk device driver calls SCSI Manager to execute            a SCSI command, which in turn calls your SIM. Your SIM            starts the command and returns, expecting a hardware            interrupt to complete the command.</p></li>                        <LI><p id=p4>Your SIM's hardware interrupt fires and schedules a            secondary interrupt (SIH B) to complete the command.</p></li>         </OL>                  <p id=p4>The system is now deadlocked. The SIH B cannot run         because secondary interrupt handlers must be single-threaded         and SIH A is already running. But the SIH A cannot run         because it has been interrupted by a page fault, which is         sitting in a synchronous wait loop waiting for SIH B to run.         </P>                  <p id=p4>The solution is to not use secondary interrupt handlers         in your SIM, or any software entity on the page fault path.         </P>                  <p id=p4>Newer versions of Mac OS provide another workaround for         this problem. On such systems, the OS detects these         potential deadlock cases (waiting for a synchronous device         request with an interrupt mask of 0 and with secondary         interrupt handlers queued) and calls your         <CODE><a href="http://developer.apple.com/documentation/mac/Devices/Devices-198.html">SIMInterruptPoll</A></CODE>         routine. Your interrupt poll routine can detect that it has         queued a secondary interrupt that has not yet run, and         perform the appropriate action directly. Typically this         involves calling your secondary interrupt handler routine         directly.</P>                  <p id=p4>This approach has a number of important caveats:</P>                  <OL>            <LI><p id=p4>It does not work on older systems. You can check for            the presence of secondary interrupt polling using the            code in Listing 1. You should find it available on Mac OS            8.5 and later.</p></li>                        <LI><p id=p4>Secondary interrupt polling may undermine the            concurrency guarantees provided by secondary interrupts.            In the above example, look carefully at what happens during            the deadlock recovery process. The system calls your            interrupt poll routine and your interrupt poll routine            calls SIH B directly. At this point, you have two threads            of execution inside secondary interrupt handlers, SIH A            and SIH B. This could cause problems if you designed your            SIM to rely on the concurrency guarantees provided by            secondary interrupts. If you want to use secondary            interrupts in your SIM, you must take this potential            reentrancy into account.</p></li>                        <LI><p id=p4>Secondary interrupt polling is&nbsp;only useful for            devices with an interrupt poll routine, such as SIMs and            AIMs. Other native drivers, such as disk drivers, do not            have an interrupt poll routine and cannot use secondary            interrupts if they are on the page fault path.</p></li>         </OL>                  <p id=p4>Because of these caveats, it may just be easier to do         everything in your SIMs hardware interrupt handler. SIMs are         mostly I/O bound, so the interrupt latency increase of doing         everything in your hardware interrupt handler is minimal.         </P>                  <p id=p4>You can detect whether secondary interrupt polling is         implemented using <CODE>Gestalt</CODE>, as shown in Listing         1.</P>                  <p id=p4><B>Listing 1</B>. Determining whether secondary interrupt         polling is available</P>                  <BR><TABLE BORDER=0 CELLPADDING=5 WIDTH=550> <TR> <td bgcolor="#e6e6e6" align=left>                  <pre>static Boolean HasSecondaryInterruptPolling(void){    UInt32 response;    return (Gestalt(gestaltSCSI, (SInt32 *) &amp;response) == noErr) &amp;&amp;            ((response &amp; (1 &lt;&lt; gestaltSCSIPollSIH)) != 0);}</pre>               </TD></TR>         </TABLE>                  <p id=p4>In summary:</P>                  <UL>            <LI><p id=p4>Prior to Mac OS 8.5, you must never use secondary            interrupts on the page fault path.</p></li>                        <LI><p id=p4>With Mac OS 8.5 and beyond, SIMs and AIMs may use            secondary interrupts, but they must take special action            in their interrupt poll routine.</p></li>                        <LI><p id=p4>Despite the difficulties using secondary interrupts            in a SIM, DTS recommends that SIM developers seriously            consider adopting this technique. The primary advantage,            lower system interrupt latency, is a significant benefit            to real-time applications such as QuickTime.</p></li>         </UL>                  <p id=p4>For more information about this mind-manglingly complex         part of the Mac OS I/O subsystem, see:</P>                  <UL>            <LI><p id=p4><A HREF="ftp://ftp.apple.com/devworld/Development_Kits/PCI_Driver_SDK.sit.hqx">Designing            PCI Cards and Drivers for Power Macintosh Computers</A></p></li>                        <LI><p id=p4><a href="http://developer.apple.com/documentation/mac/Devices/Devices-2.html">Inside            Macintosh: Devices</A> (especially the            <a href="http://developer.apple.com/documentation/mac/Devices/Devices-151.html">SCSI            Manager 4.3</A> chapter)</p></li>                        <LI><p id=p4>Technote 1094            <a href="../../technotes/tn/tn1094.html">Virtual            Memory Application Compatibility</A></p></li>                        <LI><p id=p4>Technote 1104            <a href="../../technotes/tn/tn1104.html">Interrupt-Safe            Routines</A></p></li>                        <LI><p id=p4>Technote 1137            <a href="../../technotes/tn/tn1137.html">Disabling            Interrupts on the Traditional Mac OS</A></p></li>                        <LI><p id=p4>DTS Q&amp;A DV 32            <a href="dv32.html">PrepareMemoryForIO            and Execution Levels</A></p></li>         </UL>                  </td></tr></table></CENTER><!-- end_content --><!-- begin_date --><H4 ALIGN=center>[Dec 21 1998]</H4><!-- end_date --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/dv/dv34.html%3Fid%3DDTS10001175-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/dv/dv34.html%3Fid%3DDTS10001175-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/dv/dv34.html%3Fid%3DDTS10001175-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --> <hr width=500 align=center> </BODY> </HTML>