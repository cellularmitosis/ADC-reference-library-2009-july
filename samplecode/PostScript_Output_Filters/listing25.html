<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>PostScript Output Filters - /SampleFilter/SampleFilterPanel.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxPrinting-date.html">Printing</a> &gt; <A HREF="javascript:location.replace('index.html');">PostScript Output Filters</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Printing/index.html" target="_blank">Reference Library > Printing</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">PostScript Output Filters</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/SampleFilter/SampleFilterPanel.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/Headers and Stub Libraries/Hints.h</option>
<option value="listing2.html">/Headers and Stub Libraries/PrintingPlugins.h</option>
<option value="listing3.html">/Headers and Stub Libraries/PrintingPlugins.r</option>
<option value="listing4.html">/Headers and Stub Libraries/PSLogFolder.h</option>
<option value="listing5.html">/Headers and Stub Libraries/PSOutputFilters.h</option>
<option value="listing6.html">/Headers and Stub Libraries/PSOutputFilters.r</option>
<option value="listing7.html">/Headers and Stub Libraries/PSSectionInfo.h</option>
<option value="listing8.html">/Headers and Stub Libraries/PSStreams.h</option>
<option value="listing9.html">/SampleFilter/Debug.h</option>
<option value="listing10.html">/SampleFilter/DebugMisc.h</option>
<option value="listing11.html">/SampleFilter/LibraryStuff/Hints.h</option>
<option value="listing12.html">/SampleFilter/LibraryStuff/PrintingPlugins.h</option>
<option value="listing13.html">/SampleFilter/LibraryStuff/PrintingPlugins.r</option>
<option value="listing14.html">/SampleFilter/LibraryStuff/PSOutputFilters.h</option>
<option value="listing15.html">/SampleFilter/LibraryStuff/PSOutputFilters.r</option>
<option value="listing16.html">/SampleFilter/LibraryStuff/PSSectionInfo.h</option>
<option value="listing17.html">/SampleFilter/LibraryStuff/PSStreams.h</option>
<option value="listing18.html">/SampleFilter/Macros.h</option>
<option value="listing19.html">/SampleFilter/NoDebug.h</option>
<option value="listing20.html">/SampleFilter/SampleFilter.r</option>
<option value="listing21.html">/SampleFilter/SampleFilterHints.h</option>
<option value="listing22.html">/SampleFilter/SampleFilterMain.c</option>
<option value="listing23.html">/SampleFilter/SampleFilterMain.h</option>
<option value="listing24.html">/SampleFilter/SampleFilterOutput.c</option>
<option value="listing25.html">/SampleFilter/SampleFilterPanel.c</option>
<option value="listing26.html">/SampleFilter/SampleFilterPanel.h</option>
<option value="listing27.html">/SampleFilter/SampleFilterResources.h</option>
<option value="listing28.html">/SampleFilter/Version.h</option>
<option value="listing29.html">/SectionReport/Debug.h</option>
<option value="listing30.html">/SectionReport/LibraryStuff/Hints.h</option>
<option value="listing31.html">/SectionReport/LibraryStuff/PrintingPlugins.h</option>
<option value="listing32.html">/SectionReport/LibraryStuff/PrintingPlugins.r</option>
<option value="listing33.html">/SectionReport/LibraryStuff/PSLogFolder.h</option>
<option value="listing34.html">/SectionReport/LibraryStuff/PSOutputFilters.h</option>
<option value="listing35.html">/SectionReport/LibraryStuff/PSOutputFilters.r</option>
<option value="listing36.html">/SectionReport/LibraryStuff/PSSectionInfo.h</option>
<option value="listing37.html">/SectionReport/NoDebug.h</option>
<option value="listing38.html">/SectionReport/SectionReport.c</option>
<option value="listing39.html">/SectionReport/SectionReport.r</option>
<option value="listing40.html">/SectionReport/Version.h</option></select>
				</p>
				</form>
				<p><strong><a href="PostScript_Output_Filters.zip">Download Sample</a></strong> (&#147;PostScript_Output_Filters.zip&#148;, 229.2K)<BR>
<strong><a href="PostScript_Output_Filters.dmg">Download Sample</a></strong> (&#147;PostScript_Output_Filters.dmg&#148;, 297.8K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/***  File:      SampleFilterPanel.c****  Description: The functions in this file control the &quot;Sample Filter Settings&quot;**  panel UI for the SampleFilter.  ****  Version:  1.0  ****  Copyright 1999 Apple Computer. All rights reserved.****  You may incorporate this sample code into your applications without**  restriction, though the sample code has been provided &quot;AS IS&quot; and the**  responsibility for its operation is 100% yours.  However, what you are**  not permitted to do is to redistribute the source as &quot;ABC Sample Code&quot;**  after having made changes. If you're going to re-distribute the source,**  we require that you make it clear in the source that the code was**  descended from Apple Sample Code, but that you've made changes.***/#include &lt;Sound.h&gt;#include &lt;Resources.h&gt;#include &lt;string.h&gt;#include &lt;Scrap.h&gt;#include &quot;PSOutputFilters.h&quot;#include &quot;DebugMisc.h&quot;#include &quot;Macros.h&quot;#include &quot;SampleFilterMain.h&quot;#include &quot;SampleFilterPanel.h&quot;#include &quot;SampleFilterResources.h&quot;#include &quot;SampleFilterHints.h&quot;#define DELETEKEY 0x08#define LEFTKEY 0x1c#define RIGHTKEY 0x1d#define UPKEY 0x1e#define DOWNKEY 0x1f#define MAXDIGITS 50enum {  kForTextST = 1,  kForTextET,  kCustomHeaderCheckBox,  kPageCommentST,  kPagesCommentNone,  kPagesCommentFirstOnly,  kPagesCommentAll};typedef struct SampleData{  Collection jobHints;  kHintTextVar text;  Boolean doCustomHeaderComment;  PagesCommentMode pagesComment;  short fRef;}SampleData;const Byte sampleTextDefault[] = &quot;\pSample&quot;;static OSStatus saveCustomData(Collection plugInPrInfo, SampleData *ourData);static OSStatus getSavedCustomData(Collection jobHints, Collection plugInPrInfo, SampleData *ourData);static Boolean isTextShortEnough(DialogPtr dp, short len, short maxLen);static OSStatus getJobHintsOrDefaults(Collection jobHints, Collection plugInDefaults,                     CollectionTag tag, long id, SInt32 *size, void *itemData);static OSStatus saveCustomData(Collection plugInPrInfo, SampleData *ourData){  OSStatus err = noErr;  ckAssert(plugInPrInfo != NULL);  if(plugInPrInfo){    // add our configuration hint data to the collection that is passed in.    err = AddCollectionItem(plugInPrInfo, kHintTextTag, kHintTextId, sizeof(kHintTextVar), ourData-&gt;text);    if(!err)err = AddCollectionItem(plugInPrInfo, kHintCustomHeaderTag, kHintCustomHeaderId,                         sizeof(kHintCustomHeaderVar), &amp;ourData-&gt;doCustomHeaderComment);    if(!err)err = AddCollectionItem(plugInPrInfo, kHintPagesCommentTag, kHintPagesCommentId,                         sizeof(kHintPagesCommentVar), &amp;ourData-&gt;pagesComment);  }    return err;}  static OSStatus getSavedCustomData(Collection jobHints, Collection plugInPrInfo, SampleData *ourData){  OSStatus err = noErr;  long size;  ckAssert(plugInPrInfo != NULL);    size = sizeof(kHintTextVar);    err = getJobHintsOrDefaults(jobHints, plugInPrInfo, kHintTextTag, kHintTextId, &amp;size, ourData-&gt;text);  // if the hint does not exist in the job or prefs collection then we'll use our default  if(err == collectionItemNotFoundErr) {    err = noErr;    memcpy(ourData-&gt;text, sampleTextDefault, sampleTextDefault[0]+1);  }  if(!err){    size = sizeof(kHintCustomHeaderVar);    err = getJobHintsOrDefaults(jobHints, plugInPrInfo, kHintCustomHeaderTag, kHintCustomHeaderId,                     &amp;size, &amp;ourData-&gt;doCustomHeaderComment);    // if the hint does not exist in the job or prefs collection then we'll use our default    if(err == collectionItemNotFoundErr) {      err = noErr;      ourData-&gt;doCustomHeaderComment = kHintCustomHeaderDef;    }  }  if(!err){    size = sizeof(kHintPagesCommentVar);    err = getJobHintsOrDefaults(jobHints, plugInPrInfo, kHintPagesCommentTag, kHintPagesCommentId,                     &amp;size, &amp;ourData-&gt;pagesComment);    // if the hint does not exist in the job or prefs collection then we'll use our default    if(err == collectionItemNotFoundErr) {      err = noErr;      ourData-&gt;pagesComment = kHintPagesCommentDef;    }  }    return(err);}  static OSStatus getJobHintsOrDefaults(Collection jobHints, Collection plugInDefaults,                     CollectionTag tag, long id, SInt32 *size, void *itemData){  OSStatus err = noErr;  ckAssert(jobHints != NULL);  ckAssert(plugInDefaults != NULL);  ckAssert(size != NULL);  ckAssert(itemData != NULL);  // first try in job Collection  err = GetCollectionItem(jobHints, tag, id, size, itemData);  // if the collection item does not exist in the job hints then check the printer's default collection  if(err == collectionItemNotFoundErr){    err = GetCollectionItem(plugInDefaults, tag, id, size, itemData);  }  return err;}                        OSStatus samplePrSpecificInitData(void *dataP, Collection plugInPrInfo){  OSStatus err = noErr;  SampleData *ourDataP = (SampleData *)dataP;    if(ourDataP != nil)        err = getSavedCustomData(ourDataP-&gt;jobHints, plugInPrInfo, ourDataP);  else    ckAssert(false);    // should not happen    return(err);}OSStatus samplePrSpecificCloseData(void *dataP, Boolean doIt){  OSStatus err = noErr;    Unused(dataP);  Unused(doIt);      return(err);}OSStatus sampleCloseData(void *dataP, Boolean doIt){  OSStatus err = noErr;  SampleData *ourDataP = (SampleData *)dataP;    /*   This routine is called when our filter is being unloaded. doIt will    be true if the filter is being unloaded as part of the user selecting    OK or Save in the Print Dialog, otherwise it will be false. If doIt    is true we need to configure our private job collection so that it    reflects the current user settings.    */  if(doIt &amp;&amp; ourDataP){    err = saveCustomData(ourDataP-&gt;jobHints, ourDataP);  }      /*    This is the last panel specific routine that is called before our    filter is unloaded so we need to dispose of our private panel data.  */    if(ourDataP)    DisposePtr((char *)ourDataP);      return(err);}OSStatus sampleInitData(void *dataP, Collection plugInHints){  SampleData *ourDataP = (SampleData *)dataP;    /*    Our filter is being loaded and we need to save off our private hints    collection corresponding to the current print job.  */  ourDataP-&gt;jobHints = plugInHints;  return noErr;}OSStatus samplePrSpecificInit(void *dataP, DialogPtr dp, short offset){  OSStatus err = noErr;    /*    This routine is called when our panel becomes visible or the panel is    visible and the user changes printers. We need to set the controls in    our panel to reflect our current job settings.  */  if(dataP) {    SampleData *ourDataP = (SampleData *)dataP;    setText(dp, kForTextET + offset, ourDataP-&gt;text);    SelectDialogItemText(dp, kForTextET + offset, 0, 0x7f);    setControl(dp, kCustomHeaderCheckBox + offset, ourDataP-&gt;doCustomHeaderComment);    setRadio(dp, kPagesCommentNone + offset, kPagesCommentAll + offset,               kPagesCommentNone + offset + ourDataP-&gt;pagesComment);  }  return(err);}OSStatus samplePrSpecificClose(void *dataP, DialogPtr dp, short offset){  OSStatus err = noErr;    /*    This routine is called when our panel goes away or the user is    switching printers to a new printer. The panel can go away because    the user switches panels or dismisses the Print Dialog. This filter    has no need to do any cleanup or other work at this point.  */  Unused(dataP);  Unused(dp);  Unused(offset);    return(err);}OSStatus sampleInit(void *dataP, DialogPtr dp, short offset){  OSStatus err = noErr;  Unused(dataP);  Unused(dp);  Unused(offset);    return(err);}OSStatus sampleClose(void *dataP, DialogPtr dp, short offset){  OSStatus err = noErr;  Unused(dataP);  Unused(dp);  Unused(offset);  /*     The panel is going away because the user switched panels or    dismissed the dialog. This is the last opportunity to read    any data from the controls in this panel.        This filter has no need to read any data from the panel because    its settings data always reflects the panel UI. That is done in our    sampleItem procedure below.   */  return(err);}OSStatus sampleItem(void *dataP, DialogPtr dp, short item, short offset, short ctlVal){  OSStatus err = noErr;  SampleData *ourDataP = (SampleData *)dataP;  Unused(dp);  Unused(ctlVal);    if(ourDataP) {    /*      We must subtract offset from the item value passed in so that we can      compare to the DITL item numbers in our DITL    */    switch(item - offset) {      case kForTextET:         getText(dp, kForTextET + offset, ourDataP-&gt;text);         if(ourDataP-&gt;text[0] &gt; MAXDIGITS)           ourDataP-&gt;text[0] = MAXDIGITS;        break;            /*  For check boxes the control value passed is the check box state        as long since this filter has a 'desC' resource that corresponds        to the DITL. All we have to do is update our settings        to reflect the control state.      */      case kCustomHeaderCheckBox:        ourDataP-&gt;doCustomHeaderComment = ctlVal;        break;              /*  For grouped radio buttons, LaserWriter 8 worries about setting        the radio control values to be current since since this filter has        a 'desC' resource that corresponds to the DITL. All we have to        do is update our settings to reflect the current radio hit.      */      case kPagesCommentNone:        ourDataP-&gt;pagesComment = kPagesNone;        break;            case kPagesCommentFirstOnly:        ourDataP-&gt;pagesComment = kPagesFirst;        break;      case kPagesCommentAll:        ourDataP-&gt;pagesComment = kPagesAll;        break;              default:        break;    }  }    return(err);}OSStatus sampleFilter(void *dataP, DialogPtr dp, short offset, EventRecord *ep, short *itemP, Boolean *weHandledItP){  OSStatus err = noErr;  SampleData *ourDataP = (SampleData *)dataP;  Boolean result = false;  short len;  long lOffset;    Unused(offset);  Unused(itemP);    if(ourDataP) {    switch(ep-&gt;what) {     case keyDown:     case autoKey:      if(ep-&gt;modifiers &amp; cmdKey){        Handle h;        switch(ep-&gt;message &amp; 0xdf) {         case 'V':          h = NewHandle(0L);          if(h) {            len = GetScrap(h, 'TEXT', &amp;lOffset);            HLock(h);            result = isTextShortEnough(dp, len, MAXDIGITS);            DisposeHandle(h);          }          break;         default:           result = true;           break;        }      } else {                unsigned char charCode = (unsigned char) (ep-&gt;message &amp; charCodeMask);        switch(charCode) {         case DELETEKEY:         case LEFTKEY:         case RIGHTKEY:         case UPKEY:         case DOWNKEY:           result = true;          break;         default:          result = isTextShortEnough(dp, 1, MAXDIGITS);          break;        }      }      if(!result){        *weHandledItP = true;        SysBeep(5);      }      break;    }  }  return(err);}static Boolean isTextShortEnough(DialogPtr dp, short len, short maxLen){  Boolean result = true;  TEHandle textH = ((DialogPeek)dp)-&gt;textH;  TEPtr textP;  short selStart;    textP = *textH; //unlocked  selStart = textP-&gt;selStart;  if( (textP-&gt;teLength + textP-&gt;selStart - textP-&gt;selEnd + len) &gt; maxLen ) {    result = false;  }  return(result);}OSStatus sampleCheckRange(void *dataP, DialogPtr dp, short offset, Boolean *doItP){  OSStatus err = noErr;  SampleData *ourDataP = (SampleData *)dataP;  Str255 text;  getText(dp, kForTextET + offset, text);  // make sure our resource fork is the current resource file before we get any resources  if(ourDataP-&gt;fRef != -1) {    short holdResFile = CurResFile();    UseResFile(ourDataP-&gt;fRef);        // we have an alert if there is no text and we are called    if(text[0] == 0){      StopAlert(kNeedTextALRT, nil);      *doItP = false;    }else{      // we also have an alert if there is too much text and we are called      if(text[0] &gt; MAXDIGITS){        StopAlert(kTooMuchTextALRT, nil);        *doItP = false;      }    }    UseResFile(holdResFile);  }    return(err);}OSStatus sampleSaveButton(void *dataP, Collection plugInPrInfo){  OSStatus err = noErr;  SampleData *ourDataP = (SampleData *)dataP;    if(ourDataP != nil){    // we'll save our current settings into the prefs collection we are passed    err = saveCustomData(plugInPrInfo, ourDataP);  }  return(err);}OSStatus sampleAddMenu(void *dataP, StringPtr menuNameStr, unsigned long bufSize, Boolean *addItP){  OSStatus err = noErr;  SampleData *ourDataP = (SampleData *)dataP;    // make sure our resource fork is at the top of the resource chain  if(ourDataP-&gt;fRef != -1) {    Handle stringResH = NULL;    short holdResFile = CurResFile();        UseResFile(ourDataP-&gt;fRef);    stringResH = Get1Resource('STR ', kPanelMenuName);    if(stringResH) {      short bytesToMove = **stringResH + 1;      if(bytesToMove &gt; bufSize){        bytesToMove = bufSize;        **stringResH = bytesToMove - 1;      }      BlockMove(*stringResH, (Ptr)menuNameStr, bytesToMove);      ReleaseResource(stringResH);    } else {      ckAssert(false);      err = ResError();      if(!err) {        err = resNotFound;      }    }    UseResFile(holdResFile);  }    *addItP = err ? false : true;    return(err);}OSStatus sampleRegisterPanel(short *ditlIDP, void **dataH, void *libDataP){  OSStatus err = noErr;  SampleData *ourDataP;    // allocate and initialize the private data for this panel  ourDataP = (SampleData *)NewPtrClear(sizeof(SampleData));  if(ourDataP) {    *ditlIDP = kFirstPanelDITL;    ourDataP-&gt;fRef = (short)libDataP;    // store the fRef data        *dataH = ourDataP;  } else {    err = MemError();    *dataH = NULL;  }    return(err);}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/PostScript_Output_Filters/listing25.html%3Fid%3DDTS10000297-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/PostScript_Output_Filters/listing25.html%3Fid%3DDTS10000297-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/PostScript_Output_Filters/listing25.html%3Fid%3DDTS10000297-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>