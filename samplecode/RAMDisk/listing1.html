<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>RAMDisk - /RamCDev.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; <A HREF="javascript:location.replace('index.html');">RAMDisk</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/idxMassStorageDevices-date.html" target="_blank">Hardware & Drivers > Storage</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">RAMDisk</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/RamCDev.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/RamCDev.c</option>
<option value="listing2.html">/RamDiskCommon.h</option>
<option value="listing3.html">/RAMDiskDriverMain.c</option>
<option value="listing4.html">/RamDRVR.c</option>
<option value="listing5.html">/RamINIT.c</option>
<option value="listing6.html">/ShowInitIcon/ShowInitIcon.c</option>
<option value="listing7.html">/ShowInitIcon/ShowInitIcon.h</option>
<option value="listing8.html">/TradDriverLoaderLib/TradDriverLoaderLib.c</option>
<option value="listing9.html">/TradDriverLoaderLib/TradDriverLoaderLib.h</option>
<option value="listing10.html">/TradDriverLoaderLib/TradDriverLoaderLib.p</option></select>
				</p>
				</form>
				<p><strong><a href="RAMDisk.zip">Download Sample</a></strong> (&#147;RAMDisk.zip&#148;, 46.2K)<BR>
<strong><a href="RAMDisk.dmg">Download Sample</a></strong> (&#147;RAMDisk.dmg&#148;, 103.7K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">#define __DebugVersion  0/***  Apple Macintosh Developer Technical Support****  RamCDev.c: Ram Disk Control Panel code****  by Gordon Sheridan and Jim Luther**  modified incessantly by Brian Bechtel**  and even more so by Quinn &quot;The Eskimo!&quot;****  File:    RamCDev.c****  Copyright &copy; 1992-1996 Apple Computer, Inc.**  All rights reserved.****  You may incorporate this sample code into your applications without**  restriction, though the sample code has been provided &quot;AS IS&quot; and the**  responsibility for its operation is 100% yours.  However, what you are**  not permitted to do is to redistribute the source as &quot;DTS Sample Code&quot;**  after having made changes. If you're going to re-distribute the source,**  we require that you make it clear in the source that the code was**  descended from Apple Sample Code, but that you've made changes.****  Change History (most recent first):****  Change History (most recent first):****     &lt;1.4&gt;  19970207    Quinn  Reworked to use new file layout and bring generally**                  up-to-date.**     &lt;3&gt;   06/10/94  BL&iexcl;B  Converted to work with Metrowerks &amp; Symantec**     &lt;2&gt;   6/13/93  gs    Additional Cleanup**     &lt;1&gt;   6/13/93  gs    Clean up format.**    &lt;0+&gt;   10/2/92  gs    Clean up format.**/#ifdef __MWERKS__#include &lt;A4Stuff.h&gt;#endif#ifdef THINK_C#include &lt;SetupA4.h&gt;#endif#include &lt;LowMem.h&gt;#include &lt;Resources.h&gt;#include &lt;TextUtils.h&gt;#include &quot;RamDiskCommon.h&quot;///////////////////////////////////////////////////////////////////////////typedef struct{  ConfigRecHandle  config;  DialogPtr    dlgPtr;  short      dlgItems;  long      sizepos;  long      cursize;  long      maxsize;  PicHandle    sizePict;  Str15      curStr;  Str15      maxStr;} RDataStorage, *RDataPtr, **RDataHdl;/////////////////////////////////////////////////////////////////////////////// Resource IDsenum{  // DITL  // cdev's always have the same DITL ID, namely -4064    iCheckBox = 1,     iEditText,     iSizeBar,     iPict,     iMaxSize,     iCurSize,    // PICT  rCDevSizeBarPICT = -4034};/////////////////////////////////////////////////////////////////////////////// Simple dialog utilitesstatic Handle IGetHand(RDataHdl cdevGlobalsHdl, short item){  Handle  itemHand;  Rect  itemRect;  short  itemType;    GetDialogItem( (**cdevGlobalsHdl).dlgPtr, item + (**cdevGlobalsHdl).dlgItems,        &amp;itemType, &amp;itemHand, &amp;itemRect);  return itemHand;}static void IGetRect(RDataHdl cdevGlobalsHdl, short item, Rect *itemRect){  short  itemType;  Handle  itemHand;    GetDialogItem( (**cdevGlobalsHdl).dlgPtr, item + (**cdevGlobalsHdl).dlgItems,        &amp;itemType, &amp;itemHand, itemRect);}///////////////////////////////////////////////////////////////////////////static short UpdateSysz(ConfigRecHandle config){  Handle  sysz;  short  err = 0;    sysz = Get1Resource ('sysz', 0);  if (sysz == nil)  {    err = ResError();    if (err == resNotFound || err == 0)  // then make a new one    {      sysz = NewHandle(sizeof(long));      if (sysz == nil)        return -1;            **(long **)sysz = 0;              AddResource(sysz, 'sysz', 0, &quot;\p&quot;);      err =  ResError();      if (err)        return err;    }    else      DebugStr(&quot;\pGet1Resource('sysz',0) returned nil...&quot;);  }    if ( (**config).install)    **(long **)sysz = (16 + (**config).size) * 1024;  else    **(long **)sysz = 16 * 1024;  ChangedResource(sysz);  WriteResource(sysz);  ReleaseResource(sysz);    return err;}///////////////////////////////////////////////////////////////////////////static RDataHdl  DoInit(DialogPtr CPDialog, short numItems){  short  err;  Rect  r;  short  height;  long  myBufPtr;    RDataHdl  cdevGlobalsHdl = (RDataHdl)NewHandle(sizeof(RDataStorage));  if (cdevGlobalsHdl == nil)  return cdevGlobalsHdl;  HLock((Handle)cdevGlobalsHdl);  (**cdevGlobalsHdl).config  = (ConfigRecHandle)Get1Resource ('RDcf', 0);  err = ResError();  if ((**cdevGlobalsHdl).config == nil)  {    if (err == resNotFound || err == 0)  // then make a new one    {      (**cdevGlobalsHdl).config = (ConfigRecHandle)NewHandle(sizeof(ConfigRec));      // check config      (**(**cdevGlobalsHdl).config).install = false;      (**(**cdevGlobalsHdl).config).size   = 0;      GetIndString((**(**cdevGlobalsHdl).config).volumeName, rStringList, strDefaultNameStr);      if (ResError() != noErr)        BlockMoveData(&quot;\pRamDisk&quot;,(**(**cdevGlobalsHdl).config).volumeName,8);      AddResource((Handle)(**cdevGlobalsHdl).config, 'RDcf', 0, &quot;\p&quot;);      // check ResError();    }    else      DebugStr(&quot;\pGet1Resource('RDcf',0) returned nil...&quot;);  }  HLock((Handle)(**cdevGlobalsHdl).config);  (**cdevGlobalsHdl).dlgPtr  = CPDialog;  (**cdevGlobalsHdl).dlgItems  = numItems;  // initialize with config rsrc  SetControlValue((ControlHandle)IGetHand(cdevGlobalsHdl,iCheckBox),        (**(**cdevGlobalsHdl).config).install);  (**cdevGlobalsHdl).cursize = (**(**cdevGlobalsHdl).config).size;  SetDialogItemText(IGetHand(cdevGlobalsHdl,iEditText),(**(**cdevGlobalsHdl).config).volumeName);  SelectDialogItemText(CPDialog, numItems + iEditText, 0, 999); /* make caret show up */  myBufPtr = (long)LMGetBufPtr();  (**cdevGlobalsHdl).maxsize  = ( myBufPtr / (1024L*1024L)) * 1024L;  if ((**cdevGlobalsHdl).maxsize &lt; 0)  (**cdevGlobalsHdl).maxsize = 0;  NumToString((**cdevGlobalsHdl).maxsize,(**cdevGlobalsHdl).maxStr);  (**cdevGlobalsHdl).maxStr[++(**cdevGlobalsHdl).maxStr[0]] = 'K';    NumToString((**cdevGlobalsHdl).cursize,(**cdevGlobalsHdl).curStr);  (**cdevGlobalsHdl).curStr[++(**cdevGlobalsHdl).curStr[0]] = 'K';  IGetRect(cdevGlobalsHdl, iSizeBar, &amp;r);  height = r.bottom - r.top - 4;  (**cdevGlobalsHdl).sizepos  =     (**cdevGlobalsHdl).cursize/(double)(**cdevGlobalsHdl).maxsize * height;  (**cdevGlobalsHdl).sizePict  = GetPicture (rCDevSizeBarPICT);  if ((**cdevGlobalsHdl).sizePict == nil)    DebugStr(&quot;\pGetPicture returned nil!&quot;);      HUnlock((Handle)(**cdevGlobalsHdl).config);  HUnlock((Handle)cdevGlobalsHdl);    return cdevGlobalsHdl;}///////////////////////////////////////////////////////////////////////////static RDataHdl DoNul(RDataHdl cdevGlobalsHdl){  HLock((Handle)cdevGlobalsHdl);  HLock((Handle)(**cdevGlobalsHdl).config);  (**(**cdevGlobalsHdl).config).install =       GetControlValue((ControlHandle)IGetHand(cdevGlobalsHdl,iCheckBox));    (**(**cdevGlobalsHdl).config).size = (**cdevGlobalsHdl).cursize;  GetDialogItemText( IGetHand(cdevGlobalsHdl,iEditText),      (**(**cdevGlobalsHdl).config).volumeName);  HUnlock((Handle)(**cdevGlobalsHdl).config);  HUnlock((Handle)cdevGlobalsHdl);    return cdevGlobalsHdl;}///////////////////////////////////////////////////////////////////////////static void DrawItem(RDataHdl cdevGlobalsHdl, short item){  Rect    itemRect,r;  long    len;  RgnHandle  rgn = NewRgn();    IGetRect(cdevGlobalsHdl, item, &amp;itemRect);  SetPort( (**cdevGlobalsHdl).dlgPtr);  GetClip(rgn);  TextMode(srcCopy);  switch(item)  {    case iSizeBar:      r = itemRect;      FrameRect(&amp;r);      r.bottom = r.bottom - (**cdevGlobalsHdl).sizepos;      ClipRect(&amp;r);      DrawPicture((**cdevGlobalsHdl).sizePict,&amp;itemRect);      SetClip(rgn);      InsetRect(&amp;itemRect,2,2);      itemRect.top = itemRect.bottom - (**cdevGlobalsHdl).sizepos;      PaintRect(&amp;itemRect);      break;    case iMaxSize:      NumToString((**cdevGlobalsHdl).maxsize,(**cdevGlobalsHdl).maxStr);      (**cdevGlobalsHdl).maxStr[++(**cdevGlobalsHdl).maxStr[0]] = 'K';      len = (**cdevGlobalsHdl).maxStr[0];      TETextBox (&amp;(**cdevGlobalsHdl).maxStr[1], len, &amp;itemRect, teJustRight);                  break;    case iCurSize:        NumToString((**cdevGlobalsHdl).cursize,(**cdevGlobalsHdl).curStr);      (**cdevGlobalsHdl).curStr[++(**cdevGlobalsHdl).curStr[0]] = 'K';      len = (**cdevGlobalsHdl).curStr[0];      TETextBox (&amp;(**cdevGlobalsHdl).curStr[1], len, &amp;itemRect, teJustRight);                  break;  }     TextMode(srcOr);}///////////////////////////////////////////////////////////////////////////static RDataHdl DoHit(RDataHdl cdevGlobalsHdl, short item){  short  value,oldSize,newSize, barHeight;  Point  mouse;  Rect  r;    switch(item)  {    case iCheckBox:      value = GetControlValue((ControlHandle)IGetHand(cdevGlobalsHdl,item));      SetControlValue((ControlHandle)IGetHand(cdevGlobalsHdl,item),!value);      (**(**cdevGlobalsHdl).config).install = !value;      break;    case iSizeBar:      oldSize = (**cdevGlobalsHdl).sizepos;      IGetRect(cdevGlobalsHdl,iSizeBar,&amp;r);      barHeight = r.bottom - r.top - 4;      while(StillDown())      {        GetMouse(&amp;mouse);        IGetRect(cdevGlobalsHdl,iSizeBar,&amp;r);        InsetRect(&amp;r,0,2);        if (PtInRect(mouse,&amp;r))        {          newSize = r.bottom - mouse.v;          if ((newSize &lt; (**cdevGlobalsHdl).sizepos) ||            (newSize &gt; (**cdevGlobalsHdl).sizepos))          {            (**cdevGlobalsHdl).sizepos = newSize;            (**cdevGlobalsHdl).cursize =              newSize/ (double)barHeight *               (**cdevGlobalsHdl).maxsize;            (**cdevGlobalsHdl).cursize =              ((**cdevGlobalsHdl).cursize/32) * 32;            DrawItem(cdevGlobalsHdl,iSizeBar);            DrawItem(cdevGlobalsHdl,iCurSize);          }        }        else        {          if ((**cdevGlobalsHdl).sizepos != oldSize)          {            (**cdevGlobalsHdl).sizepos = oldSize;            (**cdevGlobalsHdl).cursize =              oldSize / (double)barHeight *               (**cdevGlobalsHdl).maxsize;            (**cdevGlobalsHdl).cursize =              ((**cdevGlobalsHdl).cursize/32) * 32;            DrawItem(cdevGlobalsHdl,iSizeBar);            DrawItem(cdevGlobalsHdl,iCurSize);          }        }      }      break;  }  return cdevGlobalsHdl;}///////////////////////////////////////////////////////////////////////////static RDataHdl DoClose(RDataHdl cdevGlobalsHdl){  short  err;    if (cdevGlobalsHdl)  {    if ( (**cdevGlobalsHdl).config)    {      err = UpdateSysz((**cdevGlobalsHdl).config);          HLock((Handle)cdevGlobalsHdl);      ChangedResource((Handle)(**cdevGlobalsHdl).config);      WriteResource((Handle)(**cdevGlobalsHdl).config);      ReleaseResource((Handle)(**cdevGlobalsHdl).config);      // check for ResError()!!!      HUnlock((Handle)cdevGlobalsHdl);    }      DisposeHandle((Handle)cdevGlobalsHdl);    cdevGlobalsHdl = nil;  }  return cdevGlobalsHdl;}///////////////////////////////////////////////////////////////////////////static RDataHdl DoUpdate(RDataHdl cdevGlobalsHdl){  DrawItem(cdevGlobalsHdl, iSizeBar);  DrawItem(cdevGlobalsHdl, iMaxSize);  DrawItem(cdevGlobalsHdl, iCurSize);    return cdevGlobalsHdl;}///////////////////////////////////////////////////////////////////////////static RDataHdl DoActive(RDataHdl cdevGlobalsHdl){  return cdevGlobalsHdl;}static RDataHdl DoDeactive(RDataHdl cdevGlobalsHdl){  return cdevGlobalsHdl;}///////////////////////////////////////////////////////////////////////////static RDataHdl DoKeyEvent(RDataHdl cdevGlobalsHdl,         DialogPtr CPDialog,         EventRecord *event){  char  tempChar;    tempChar = event-&gt;message &amp; charCodeMask;  // get the character, and check  if (event-&gt;modifiers &amp; cmdKey)        //  status of command key  {          event-&gt;what = nullEvent;        // and empty event type        switch (tempChar)            // set appropriate message    {      case 'X':      case 'x':  DialogCut(CPDialog);  break;            case 'C':      case 'c':  DialogCopy(CPDialog);  break;            case 'V':      case 'v':  DialogPaste(CPDialog);  break;    }  }  return cdevGlobalsHdl;}///////////////////////////////////////////////////////////////////////////extern pascal RDataHdl main (short message, short item, short numItems, short CPanelID,             EventRecord *theEvent, RDataHdl cdevGlobalsHdl, DialogPtr CPDialog);extern pascal RDataHdl main (short message, short item, short numItems, short CPanelID,             EventRecord *theEvent, RDataHdl cdevGlobalsHdl, DialogPtr CPDialog){#pragma unused (CPanelID)    /* unused formal parameters */#ifdef THINK_C  RememberA0();  SetUpA4();#endif#ifdef __MWERKS__  long oldA4=SetCurrentA4();#endif  if (message == macDev) return((RDataHdl) 1);        /* we work on every machine */  else if (cdevGlobalsHdl != nil)  {    switch(message)    {      case nulDev:  cdevGlobalsHdl = DoNul(cdevGlobalsHdl);              break;                    case initDev:  cdevGlobalsHdl = DoInit(CPDialog,numItems);              break;                    case closeDev:  cdevGlobalsHdl = DoClose(cdevGlobalsHdl);              break;      case hitDev:  cdevGlobalsHdl = DoHit(cdevGlobalsHdl,item - numItems);              break;                    case updateDev:  cdevGlobalsHdl = DoUpdate(cdevGlobalsHdl);              break;            case activDev:  cdevGlobalsHdl = DoActive(cdevGlobalsHdl);              break;            case deactivDev:                cdevGlobalsHdl = DoDeactive(cdevGlobalsHdl);              break;            case keyEvtDev:              cdevGlobalsHdl = DoKeyEvent(cdevGlobalsHdl,CPDialog,theEvent);              break;                    case undoDev:  /* not supported */    break;      case cutDev:  DialogCut(CPDialog);    break;      case copyDev:  DialogCopy(CPDialog);    break;      case pasteDev:  DialogPaste(CPDialog);    break;      case clearDev:  DialogDelete(CPDialog);  break;            default:    // DebugStr(&quot;\pdefault:&quot;);              break;    }  }#ifdef THINK_C  RestoreA4();#endif#ifdef __MWERKS__  SetA4(oldA4);#endif  return cdevGlobalsHdl;}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/RAMDisk/listing1.html%3Fid%3DDTS10000430-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/RAMDisk/listing1.html%3Fid%3DDTS10000430-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/RAMDisk/listing1.html%3Fid%3DDTS10000430-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>