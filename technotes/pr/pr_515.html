<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note PR515: Printing Manager Q&amp;As</title>                                       <meta name="categories" content="Printing"><meta name="week-posted" content="Oct 1, 1990 - Oct 5, 1990"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002647" title="Printing Manager Q&As"></a><a name="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxCarbon-date.html">Carbon</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/Carbon/idxPrinting-date.html" target="_blank">Carbon > Printing</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note PR515</div>
<div id="pageheadsub">Printing Manager Q&amp;As</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext">					 <A HREF="#Section1">Introduction</A><BR><BR> <A HREF="#References">References</A><BR><BR> <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><p id="introtext">This Technical Note contains a collection of archived Q&amp;As relating to a specifictopic--questions sent the Developer Support Center (DSC) along withanswers from the DSC engineers. Current Q&amp;A's can be found on the <A HREF = "../../qa/index.html">Macintosh Technical Q&amp;A's web site</a>.</p> <!-- end_intro_text --><!-- begin_date --><h3 align=center>[Oct 01 1990]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content --><h2>OK to call WaitNextEvent if modal window is frontmost</h2><P>Date Written:  1/20/93</p><P>Last reviewed:  6/14/93</p><p>I've read in "Print Hints: Top 10 Printing Crimes" that a program shouldn'tcall <code>WaitNextEvent</code> while the Print Manager is open, but I call <code><code>WaitNextEvent</code></code> inmy pIdleProc so my application can detect a user cancellation. Could this causea problem?</p> <P>The reason you shouldn't call <code>WaitNextEvent</code> is to prevent the system fromswitching to another application. If you have a modal dialog-type window infront (the one with the modal window proc ID), the system will never switchapplications and it's safe to call <code>WaitNextEvent</code>. This is why all Apple'sdrivers that call <code>WaitNextEvent</code> put up a modal dialog box. If you have a modalstatus window frontmost when your <code>pIdle</code> procedure is called, you're in nodanger.</p><P><A HREF="#top">Back to top</A></P><h2>Macintosh Printing Manager error -8132</h2><P>Date Written:  1/1/90</p><P>Last reviewed:  6/14/93</p><p>What is Macintosh Printing Manager error -8132?</p> <P>Error -8132 is generated when the selected printer times out. AppleTalkprinters monitor the time between data packets that are sent to them. Thesedevices will wait a maximum of two minutes without data until generating atime-out error. Applications such as database report generators sometimesrequire longer than two minutes to sort or format their data. Theseapplications may receive the -8132 error. One workaround for this problem is tospool the report to a file that can be printed when sorting/formatting iscompleted.</p><p>Another possible solution is to change the amount of time the LaserWriter waitsfor data until it times out. Keep in mind that the time-out in the LaserWriterexists for a reason. Say a user starts printing a large document and leaves forthe day. About halfway through the document, the user's Macintosh crashes,leaving the printer waiting without data. In two minutes, the LaserWriter timesout, and is once again available for other users on the net. However if thetime-out is disabled by the first user's job, the printer is useless untilrebooted. To avoid disabling the time-out, increase the time-out value so thatthe device times-out if the job takes too long to print, but does not time-outfor normal delays. This is done by sending the following Postscript to theLaserWriter with a Postscript downloading utility:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre> serverdict begin 0 exitserver</pre>	</TD></TR></TABLE></CENTER><p>See the Apple's LaserWriter Reference for more information.</p><p>The only other way to handle this problem is to periodically send some data tothe printer. Do this about once a minute or so to prevent the printer fromtiming out. Use the PostScriptHandle <code>PicComment</code> to send this "tickle" data sothat it is only sent to PostScript printers that have the ability to time-out.(Quickdraw printers won't see the data.) Another reason for using thePostScriptHandle <code>PicComment</code> involves the internal buffering of the LaserWriterdriver. The LaserWriter driver maintains a 4K internal buffer for thePostScript that it sends. If you send just a few characters as your tickledata, they are buffered in the driver, and the device still times-out. The onlyway to ensure that your tickle data makes it to the device is to send a 4Kblock via the PostScriptHandle <code>PicComment</code>. Needless to say, sending 4K blocksover AppleTalk once a minute is going to cause some network traffic, but it'sstill another possible workaround.</p><P><A HREF="#top">Back to top</A></P><h2>Macintosh Printing Manager error -8133</h2><P>Date Written:  1/1/90</p><P>Last reviewed:  8/1/92</p><p>What is Macintosh Printing Manager error -8133?</p> <P>Printing Manager error -8133 occurs when the PostScript interpreter of theLaserWriter (or any other PostScript printer) generates a PostScript error. Adescription of the PostScript command that caused the error is displayed in thestatus window. This error often occurs when an application sends PostScriptdirectly to the printer, and that PostScript contains an error. To debug thisproblem, look at the PostScript generated by the driver. Hold down theCommand-F key right after clicking OK in the Print dialog. A file namedPostScript0 will be created in the current directory. With the 7.x LaserWriterdrivers, just select the PostScript File radio button in the Print dialog.</p><P><A HREF="#top">Back to top</A></P><h2>Identifying Macintosh's currently selected printer</h2><P>Date Written:  1/1/90</p><P>Last reviewed:  8/1/92</p><p>How can I find out which printer the user has selected with the MacintoshChooser? How can I change it without going through the Chooser?</p> <P>The type of the currently selected printer is stored in the System file in <code>'STR'</code> resource ID -8192. This will be the name of the driver selected, such asLaserWriter or ImageWriter. The name of the actual printer selected will be inthe driver file (same name as the printer type chosen) in <code>'PAPA'</code> resource ID-8192. Look at this resource with ResEdit to see what is in it.</p><p>You can change the <code>'STR '</code> and <code>'PAPA'</code> resources, but it may not work now or inthe future. <i>DTS does not recommend changing the system file or circumventingthe Chooser!</i> The Chooser is a very complicated piece of software, and ithas many dependencies. Implementing the chooser within your application wouldmake your application dependent on a particular version of the system software.Like the Chooser, your application would then have to be revised each time anew system is released.</p><P><A HREF="#top">Back to top</A></P><h2>How to save Macintosh Page Setup and Print dialog options</h2><P>Date Written:  5/3/89</p><P>Last reviewed:  6/14/93</p><p>How do I save options set in the Macintosh Page Setup and Print dialogs?</p> <P>The only supported method to save the dialog options is to save the PrintRecord that was passed to the <code><code>PrStlDialog</code>/PrJobDialog</code> calls. This print recordcontains the options chosen in the Page Setup and Print dialogs. Although theseoptions are saved in the print record, they cannot be used as defaults for thePrint dialog. For example, say the user chooses landscape printing in the PageSetup dialog, and sets the number of copies to 5 in the Print dialog. If theprint record is passed to <code>PrStlDialog</code>, the dialog shows that landscape printingwas selected in the print record. However, if that print record is passed toPrJobDialog, number of copies is shown as 1, because options in the PrJobDialogare considered to be "job dependent," as opposed to "document dependent."</p><P>The best method for saving the print record is to save it as a resource in yourdocument's resource fork. Since the print record is already pointed to by avalid handle, creating a resource is easy. Here are the required steps:</p><ol type="1">	<li>Save the <code>refNum</code> returned by <code>CurResFile</code>;</li>	<li>Make sure the resource fork of the document file is opened using <code>OpenResFile</code> (IM I:115).</li>	<li>Now that you have a place to put the resource, you must get the resource manager to create it for you. First, pick a type and ID for your resource. You can use the Unique ID function (IM I:121) to generate the ID. Next, call the <code>AddResource</code> procedure (IM I:124). This procedure takes four parameters:</li></ol><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre> Parameter  Type     What to Pass -------------------------- theData    Handle   The handle to the currently valid print record. theType    ResType  The four character resource type you have chosen. theID      INTEGER  The ID returned from the UniqueID function.</pre>	</TD></TR></TABLE></CENTER><ol type="1" start="4">	<li>Call <code>WriteResource</code> (IM I:125), and <code>UpdateResFile</code> (IM I:125) to make sure the new resource gets saved into the file.</li>	<li>Reset the currently selected file back to whatever it was before you began the save using <code>UseResFile</code> (IM I:117).</li></ol><p>The important things to keep in mind when doing this are:</p><ol type="1">	<li>Make your resource type something different than those used by the Print Manager. This prevents the Print Manager from getting confused and grabbing the wrong resource. Types to avoid include <code>'PREC'</code>, <code>'PDEF'</code>, and <code>'POST'</code>.</li>	<li>Don't make any assumptions about the size of the print record. If you really need to know the size, use <code>GetHandleSize</code> so that if the record gets bigger in the future, your code will still work.</li>	<li>Be sure to pass the record that you get from your document to <code>PrValidate</code> before using it. This ensures that the record gets updated if any changes have been made to record structure or contents since the record was saved.</li></ol><P><A HREF="#top">Back to top</A></P><h2>MacApp and SetRsl print driver resolution</h2><P>Date Written:  4/16/92</p><P>Last reviewed:  6/14/93</p><p>We've been trying to use the <code>standardPrint</code> handler from MacApp 2 to print someviews. The problem is that we would like the printout to come out at 300 dpi onthe LaserWriter, and the print handler's device resolution fields (which comefrom the device driver) tell it to draw at 72 dpi. How, can I get a<code>PenSize</code>(1,1); <code>MoveTo</code>(100,100); <code>LineTo</code>(300,300); draw at 300 dpi and make a nicefine line? Please refer me to the needed documentation.</p> <P>The mechanism by which your application can find out the chosen printer's realresolution, and then draw with it, is documented "Meet <code>PrGeneral</code>, the Trap ThatMakes the Most of the Printing Manager," in issue #3 of <i>develop</i> magazine(July 1990). You can find it, along with its accompanying code and application,on the Developer CD, E.T.O., and AppleLink.</p><p>The DTS Sample Code SC.009.FracApp300 on the Developer CD shows how to use<code>PrGeneral</code> in an application built with MacApp 2.</p><b></b><P><A HREF="#top">Back to top</A></P><h2>Printing patterns at higher resolutions with GetRslData &amp; SetRsl</h2><P>Date Written:  11/7/90</p><P>Last reviewed:  6/14/93</p><p>Is there a way that I can make my Macintosh fill patterns print at a higherresolution (more than 72 dpi), but have my patterns still print as patterns?</p> <P>To make your patterns print at the printer's resolution, you need to usePrinting Manager <code>PrGeneral</code>'s <code>GetRslData</code> and <code>SetRsl</code> opcodes to get and set theresolution, and you must scale the pattern to match. Let me explain.</p><p>If we do not scale our patterns up to the printer's resolution before printtime, we would get "big chunky" patterns because the printer driver would needto scale the patterns on the fly from 72 dpi to its resolution. Therefore, weuse the "cookie cutter" approach to "place" the pattern into the object that isbeing filled. The size of the cookie cutter (that is, the destination Rect)depends on the "<code>scaleFactor</code>". For example, a <code>scaleFactor</code> of 2 will have adestination rect of 16 x 16. We will then <code>CopyBits</code> the pattern one square at atime into the object that is being filled.</p><p>XRefs:</p><P><i>Inside Macintosh</i> Volume V, pages 410-416</p><P>"Meet <code>PrGeneral</code>," <i>develop,</i> July 1990</p><P><A HREF="#top">Back to top</A></P><h2>Call Printing Mgr's bottleneck to send StdText to printer driver</h2><P>Date Written:  11/7/90</p><P>Last reviewed:  6/14/93</p><p>We need to use the Macintosh toolbox call <code>StdText</code> instead of <code>DrawChar</code>,DrawString, and DrawText to accomplish horizontal scaling and fractional pointsizes, but <code>StdText</code> does not work on the LaserWriter IISC. Is there anyworkaround?</p> <P>The problem is that you are calling the low-level bottleneck directly, and thePrinting Manager has replaced the bottleneck completely with its own. So whenyou are actually printing, the print driver will not see your call to <code>StdText</code>.The work-around for this is to call the Print Manager's bottleneck itself whenyou are printing. You can do this in the following way:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>/* typedef the function */typedef pascal void (*StdTextProcPtr)( short, Ptr, Point, Point );void tstDrawStuff( pInfo, thePort, pageNum )TPrint pInfo;GrafPtr thePort;unsigned short pageNum;{   StdTextProcPtr Proc;     /* declare a variable here *//* do your clipping etc. *//* TEST -- no good w/o PriMon *//* do your moveto etc. *//* Is there a replacement bottleneck ?*/if ( thePort-&gt;grafProcs )  {    Proc = (StdTextProcPtr)thePort-&gt;grafProcs-&gt;textProc; /* yes, so grab it */    (*Proc)( strlen(&quot;HELLO&quot;) , (Ptr) &quot;HELLO&quot;, numer, denom );}/* else just call standard text */</pre>	</TD></TR></TABLE></CENTER><p>This technique will work in both background and foreground printing. I havetested this solution on the Personal LaserWriter SC and the LaserWriter IINTX,and it prints fine.</p><P><A HREF="#top">Back to top</A></P><h2>Modifying PDEFs to have printer driver jump into dialog code</h2><P>Date Written:  11/9/90</p><P>Last reviewed:  6/14/93</p><p>Could you please point me to the correct section in <A HREF = "downloads/Learning_to_Drive.sea.hqx">"Learning to Drive"</a> (orsend me an example) that we would need to modify the appropriate PDEF resourcein order to have the driver jump to our dialog code?</p> <P>Pages 15-18 discuss the contents of the various PDEFs. You will need patch theappropriate PDEF to get your required functionality. You should also realizethat patching PDEFs is not an easy task, nor will it always survive "new"Macintosh LaserWriter driver releases. I want you to know that before you gotoo far down the PDEF patching road.</p><p>By the way, we do know of a couple of developers that have patched PDEFssuccessfully. The following paragraphs are a "high-level" look at patching aPDEF:</p><p>To patch a PDEF, you must write an installer application that lets users choosethe printer driver they want to modify via Standard File. You can causeStandard File to display only printer drivers by telling it to display onlyfiles of type "PRER". Once the user has selected a driver you need to scan thedriver for the PDEF 0 and 1 resources. When you find one of these you read itin and modify it.</p><p>However, I'll give you a quick overview of what you need to do. PDEF 0 &amp; 1both start with jump tables (a table of JMP instructions followed by the PCrelative address to jump to). The JMP to <code>PrClosePage</code> always begins at offset12. So what your installer needs to do after it loads the resource is grab theeighth word in the resource. That is the offset to the actual start of the<code>PrClosePage</code> code. Then you have to resize the handle so that it is big enoughto hold your patch and then <code>BlockMove</code> {IM II-44} your code into the end of thehandle. The following illustration might help:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>         JMP $0486              &lt;&lt; Note: some PDEF's have multiple JMPs at* - - - - - - - - - - - - - *            the beginning of the code. The*                           *            original offset to PrClosePage was* &gt;&gt; Original PDEF code  &lt;&lt; *            $0386.*                           *$0386 --&gt; PrClosePage           &lt;&lt; Note: most PDEF's have multiple printing*                           *            calls defined.*                           ** - - - - - - - - - - - - - *$0486 --&gt; {{{  Your Code  }}}*                           *   &lt;&lt; You resize the resource handle to this*                           *            and BlockMove your code in here.*                           ** - - - - - - - - - - - - - *         JMP $0386              &lt;&lt; At this point we jump into the printer</pre>	</TD></TR></TABLE></CENTER><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>The previous illustration is not to scale nor completely accurate inregards to the addresses used. Please consult "Learning To drive" for thecorrect offsets for each PDEF.</P></TD></TR></TABLE></CENTER><BR><p>Then replace the original offset to <code>PrClosePage</code> with the offset to your newcode. Remember that this is PC-relative so you would calculate it like this: Ifthe original <code>PrClosePage</code> JMP was JMP 10(SP) and the size of the original PDEFwas 50 bytes, then you need to replace the JMP 10(SP) with JMP 50-16(SP). Inother words, you need to JMP to what was formerly the end of the PDEF resourcebut what is now the beginning of your code (subtract 16 because the offsettable is 16 bytes long. Refer to "Learning to Drive" for more details). Then onthe end of your code, add a JMP ((<code>SizeOfJumpTable</code> + <code>originalOffset</code>) -(<code>sizeofOriginalPDEF</code> + <code>SizeOfYourCode</code>))(SP). Your code will end with a JMP to anegative offset off the PC back to the original <code>PrCloseRoutine</code>.</p><p>If you are willing to support only system software later than version 3.3(basically that means that you won't be supporting Macintosh 512K and 512KEcomputers), you don't have to deal with all the PDEF changing, and you cansimply patch out the $A8FD trap and look for the proper selector on the stack.(Use <code>SysEnvirons</code> to be sure that you are on a system later than version 3.3)This will work because the newer libraries (that is, any library that shippedsince the Macintosh II shipped) first checks for the trap and jumps there ifthe trap exists so even if the application has linked in the printing librarythey still end up calling the trap on systems after 3.3.</p><P><A HREF="#top">Back to top</A></P><h2>Determining if printer supports color and/or grayscale printing</h2><P>Date Written:  3/14/91</p><P>Last reviewed:  8/1/92</p><p>Is there any way to determine whether I'm printing to either a color printer ora printer simulating color, such as the LaserWriter set for Color/Grayscale?</p> <P>Check the <code>grafPort</code> returned by your call to <code>PrOpenDoc</code>. If the rowBytes of the<code>grafPort</code> is less than 0, the Printing Manager has returned a color <code>grafPort</code>.You can then make Color QuickDraw calls into this <code>grafPort</code>. LaserWriter driverversion 6.0 and later returns a color <code>grafPort</code> from the <code>PrOpenDoc</code> call, if theColor/Grayscale button has been set.</p><p>The following code fragment demonstrates this:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>(* This function determines whether the port passed to it is a *)(* color port. If so, it returns TRUE.                         *)FUNCTION IsColorPort(portInQuestion: GrafPtr): BOOLEAN;BEGIN  IF portInQuestion^.portBits.rowBytes &lt; 0 THEN    IsColorPort := TRUE  ELSE    IsColorPort := FALSE;</pre>	</TD></TR></TABLE></CENTER><p>A third-party printer driver should return the type of <code>grafPort</code> that representsthe abilities of its printer. Therefore, if the printer supports color and/orgrayscale, and if Color QuickDraw is present, the application will receive acolor <code>grafPort</code> after calling <code>PrOpenDoc</code>. Otherwise, if the Macintosh you'rerunning on does not support Color QuickDraw, you should return ablack-and-white <code>grafPort</code>.</p><P><A HREF="#top">Back to top</A></P><h2>Using LaserWriter fonts with StyleWriter</h2><P>Date Written:  3/22/91</p><P>Last reviewed:  6/14/93</p><p>Can StyleWriter use all the Adobe fonts for my LaserWriter? Can StyleWriterprint the encapsulated PostScript drawings I've developed? Does TrueTypesoftware come with the StyleWriter?</p> <P>The difference between the StyleWriter and a regular LaserWriter (other thanone's got a laser and the other doesn't) is that the LaserWriter has PostScriptbuilt-in; the StyleWriter does not. The StyleWriter, in fact, has nothingbuilt-in, and only recognizes basic "put this dot here" types of commands. Evensending it pure ASCII accomplishes nothing.</p><p>TrueType software is shipped with the StyleWriter, because it can image fontsat any resolution with excellent quality, much like PostScript. The TrueTypesoftware is intended for users of system versions 6.0.7 and later, but prior toSystem 7. System 7 <i>includes</i> support for TrueType.</p><p>You can use PostScript images and fonts with the StyleWriter, but just as withthe ImageWriter, you'll have to have something that images them in memorybefore sending them to the printer (in other words, a Macintosh-residentPostScript interpreter).</p><P><A HREF="#top">Back to top</A></P><h2>Personal LaserWriter LS 1.1 driver is faster</h2><P>Date Written:  8/9/91</p><P>Last reviewed:  6/14/93</p><p>My LaserWriter LS is very slow when printing from my Macintosh SE. Anysuggestions?</p> <P>Use the new LaserWriter LS driver version 1.1 or later. It was released afterSystem 7.0, and is available on AppleLink or from your dealer.</p><p>If you're printing Word files, Microsoft's TrueType INIT will help. It'savailable from MicroSoft Technical Support or from commercial bulletin boardservices.</p><P><A HREF="#top">Back to top</A></P><h2>ImageWriter II 6.1 &amp; 7.0 driver PrGeneral/PrStlDialog bug</h2><P>Date Written:  9/11/91</p><P>Last reviewed:  6/14/93</p><p>If an application uses <code>PrGeneral</code> to set <code><code>draftBits</code></code> mode on an ImageWriter II(using the 6.1 or 7.0 drivers) and then does a <code>PrStlDialog</code>, a fatal crashoccurs. This happens with both the AppleTalk and non-AppleTalk drivers. Thisonly happens on Macintosh systems with Color QuickDraw.</p><p>The problem is connected to the two <code>'dctb'</code> resources which were added in the6.1 driver. When the landscape icon is being grayed out (since it's unsupportedin <code>draftBits</code> mode), the driver is jamming the gray pen pattern directly intothe <code>grafPort</code>. While this brute-force method works fine with <code>GrafPorts</code>, the<code>'dctb'</code> resources make the Dialog Manager use a <code>CGrafPort</code> now. Jamming thepattern into this CGrafPort as if it were a <code>grafPort</code> makes a mess and causes afatal crash, manifesting itself as a "division by zero" error, for example.</p><p>To work around the problem, check to see if you are printing to a 6.1 or 7.0ImageWriter driver, and if so, do the style dialog before setting <code>draftBits</code>.The disadvantage of this is that setting <code>draftBits</code> before calling <code>PrStlDialog</code>causes the 50% reduction and landscape controls to be disabled, and this methoddoesn't. Therefore, after the style dialog, you should check to see if the userselected landscape printing or 50% reduction by calling <code>PrGeneral</code> (<code>getRotnOp</code>)and checking bit 3 of the wDev field (See "Learning To Drive" on the DeveloperCDs for more about the wDev.) If the user selected either of those options,display a dialog warning them that those features will be ignored. Then, call<code>PrGeneral</code> to set <code>draftBits</code> and continue normally. <code>PrGeneral</code> will adjust theprint record so that options not supported with <code>draftBits</code> are turned off. If anon 6.1/7.0 ImageWriter driver is used, the code should set <code>draftBits</code> as usual,before the <code>PrStlDialog</code> call.</p><p>This workaround is the better alternative to hacking the <code>'dctb'</code>s out of thedriver or patching around the problem, although it doesn't help 7.0 usersrunning applications that already make use of the <code>draftBits</code> option. Thefollowing Pascal snippet demonstrates how to use the workaround:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>(* Sample snippet that demonstrates how to work-around the   'dctb' bug in the ImageWriter II 6.1 and 7.0 drivers.   Bug causes a crash when doing a style dialog   after setting draftBits with PrGeneral. *){  What's what in the code snippet that follows.  thePrRecHdl        : THPrint;  rslData            : TSetRslBlk;  draftData          : TDftBitsBlk;  rotnData           : TGetRotnBlk;  isBadImageWriter   : Boolean;  isLandscape        : Boolean;  isReduced          : Boolean;}      PrOpen;    IF (PrError = noErr) THEN    BEGIN      PrintDefault(thePrRecHdl);      IF (PrError = noErr) THEN      BEGIN{See if we're using a version 6.1 or 7.0 ImageWriter driver.}        IF (thePrRecHdl^^.prStl.wDev DIV 256) = 1 THEN          isBadImageWriter := (PrDrvrVers = 61) OR (PrDrvrVers = 70)        ELSE          isBadImageWriter := FALSE;        IF NOT (isBadImageWriter) THEN        BEGIN{Set draftBits mode now, if not our special case.}          draftData.iOpCode := draftBitsOp;          draftData.hPrint := thePrRecHdl;          PrGeneral(@draftData);        END;{Do the style dialog.}        IF (PrStlDialog(thePrRecHdl)) THEN          IF (isBadImageWriter) THEN          BEGIN{If so, see if they selected rotation or 50% reduction.}            rotnData.iOpCode := getRotnOp;            rotnData.hPrint := thePrRecHdl;            PrGeneral(@rotnData);            isLandscape := rotnData.fLandscape;            isReduced := BTst(thePrRecHdl^^.prStl.wDev, 3);{If so, warn them that those things will be ignored. Preferably use something other than DebugStr...      }            IF (isLandscape) OR (isReduced) THEN              DebugStr('Bad ImageWriter; landscape and/or reduced.');{Now, set draftBits mode, since we didn't before.}            draftData.iOpCode := draftBitsOp;            draftData.hPrint := thePrRecHdl;            PrGeneral(@draftData);          END;          IF (PrJobDialog(thePrRecHdl)) THEN          BEGIN            {Print}          END;      END;    END;</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><h2>How to abort printing while PrPicFile is executing</h2><P>Date Written:  9/27/91</p><P>Last reviewed:  6/14/93</p><p>Can I abort printing from within <code>PrPicFile</code>? My attempts haven't beensuccesful.</p> <P>The following Pascal procedure is <i>roughly</i> the same as the default idleprocedure--the one the system supplies for you when you don't supply one ofyour own:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>procedure MyPIdleProcedure;  var    pIdleEventRecord: EventRecord;  begin    if GetNextEvent(keyDownMask, pIdleEventRecord) then      begin        if ((BitAnd(pIdleEventRecord.message, charCodeMask) =          longint('.')) and        (BitAnd(longint(pIdleEventRecord.modifiers), cmdKey) =          cmdKey)) then            PrSetError(iPrAbort);      end;</pre>	</TD></TR></TABLE></CENTER><p>(This is written in Think Pascal, but it should work fine under MPW Pascal ifyou change the "<code>BitAnd</code>" functions to "BAND".)</p><P>As you can see, the system aborts when you press Command-period by using<code>PrSetError</code> to the constant iPrAbort, which is the same error returned when theuser clicks "Cancel" in the style or job dialogs. If you set the error to<code>iPrAbort</code>, the system will take care of the rest. Your print loop will alsogracefully cancel, provided you follow the guidelines in the MacintoshTechnical Note <A HREF = "pr_10.html">"A Printing Loop That Cares</a>."</p><P><A HREF="#top">Back to top</A></P><h2>Disabling ImageWriter's initial formfeed</h2><P>Date Written:  1/23/92</p><P>Last reviewed:  6/14/93</p><p>When our product-to-be prints to the ImageWriter II there is an automatic (andundesirable in our product) sheet feed before actual printing begins. To makematters worse, it always feeds 11", even though our form is a different length.Is there a way to avoid this?</p> <P>The ImageWriter ejects a page before printing with the "No Gaps" optionselected because it assumes that the page is aligned with a small gap betweenthe perforation and the print head. So the printer ejects the page andre-aligns the print head at the perforation of the next page.</p><p>The sample code below illustrates how to prevent that nasty form feed fromoccurring. The program temporarily disables the "No Gaps" option if it isselected until after <code>PrOpenDoc</code> is called, preventing a formfeed from occurring.After <code>PrOpenDoc</code> is called, the program re-enables the "No Gaps" option.</p><p>Please note that this sample only works with the ImageWriter II and theImageWriter LQ printers--probably the only series that supports the "No Gaps"option. The sample shows how to check for these types of printers, so youshouldn't have any problems.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>PROGRAM NoGapsWA;{$U-}USES PasInOut,Memtypes,QuickDraw,OSIntf,ToolIntf,PackIntf,MacPrint;CONST  bDevLaser = 3;  bDevImageWriter     =   1;  bDevImageWriterLQ   =   5;PROCEDURE DrawStuff(theWorld : Rect);  { Draw whatever you want here. Make sure it fits in the world rectangle. }BEGIN  MoveTo(100, 100);  DrawString('testing...');END;FUNCTION HiByte(word: INTEGER): Byte;BEGIN  HiByte := word DIV 256;END;PROCEDURE PrintStuff;VAR  thePrRec:   THPrint;  thePrPort:  TPPrPort;  theStatus:  TPrStatus;  oldPort:    GrafPtr;  theError:   OSErr;  theVers:    INTEGER;  NoGaps:     BOOLEAN;BEGIN  GetPort(oldPort);  thePrRec := THPrint(NewHandle(SIZEOF(TPrint)));  PrOpen;  IF PrError = noErr THEN BEGIN    PrintDefault(thePrRec);    IF NOT PrStlDialog(thePrRec) THEN      PrSetError(iPrAbort);    IF NOT PrJobDialog(thePrRec) THEN      PrSetError(iPrAbort);    (* First, lock the handle down so we can do a cool with statement. *)    HLock(Handle(thePrRec));    IF PrError = noErr THEN    WITH thePrRec^^ DO BEGIN      (* Okay, now get device dependent.  We only want to do this if we *)      (* know the selected printer driver supports it.                  *)      IF (HiByte(prStl.wDev) = bDevImageWriter) OR      (HiByte(prStl.wDev) = bDevImageWriterLQ) THEN BEGIN        (* Now remember the state of the nogaps option.          *)        NoGaps := BitTst(@prStl.wDev, 11);        (* If NoGaps was selected, then turn it off until we PrOpenDoc.*)        IF (NoGaps) THEN BitClr(@prStl.wDev, 11);        (* If we're on the LQ driver, we need to copy the wDev into the*)        (* PrintX array, or the LQ driver won't notice that it changed.*)        IF (HiByte(prStl.wDev) = bDevImageWriterLQ) THEN          PrintX[2] := prStl.wDev;      END;    END;    HUnlock(Handle(thePrRec));    (* Now open the document. *)    thePrPort := PrOpenDoc(thePrRec, NIL, NIL);    (* Now we need to see if the NoGaps option was selected. If it was *)    (* then we turned it off before calling PrOpenDoc, so we need to   *)    (* turn it back on. If wasn't selected, we won't do anything.      *)    HLock(Handle(thePrRec));    WITH thePrRec^^ DO BEGIN      IF NoGaps AND        (HiByte(prStl.wDev) = bDevImageWriter) OR        (HiByte(prStl.wDev) = bDevImageWriterLQ) THEN BEGIN        (* Turn it on for the ImageWriter. *)        BitSet(@prStl.wDev, 11);        (* Copy it over for the ImageWriter LQ. *)        IF (HiByte(prStl.wDev) = bDevImageWriterLQ) THEN          PrintX[2] := prStl.wDev;      END;    END;    HUnlock(Handle(thePrRec));    IF PrError = noErr THEN BEGIN      PrOpenPage(thePrPort, NIL);      IF PrError = noErr THEN BEGIN        DrawStuff(thePrRec^^.prInfo.rPage);      END;      PrClosePage(thePrPort);    END;    PrCloseDoc(thePrPort);    IF (thePrRec^^.prJob.bJDocLoop = bSpoolLoop) and (PrError = noErr)      THEN PrPicFile(thePrRec, NIL, NIL, NIL, theStatus);  END;  PrClose;  DisposHandle(Handle(thePrRec));  SetPort(oldPort);END;BEGIN  InitGraf(@thePort);                          {initialize QuickDraw}  InitFonts;                                   {initialize Font Manager}  FlushEvents(everyEvent, 0); {call OS Event Mgr to discard}                              {any previous events}  InitWindows;                                 {initialize Window Manager}  InitMenus;                                   {initialize Menu Manager}  TEInit;                                      {initialize TextEdit}  InitDialogs(NIL);                       {initialize Dialog Manager}  InitCursor;            {call QuickDraw to make cursor (pointer) an arrow}  PrintStuff;</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><h2>Update Macintosh color table if printing in color</h2><P>Date Written:  5/3/89</p><P>Last reviewed:  6/14/93</p><p>I'm having trouble printing in color. When I copy a color image from aMacintosh offscreen pixmap to the printer, I get a black piece of paper. If Idraw directly it comes out fine. What am I doing wrong?</p> <P>When you built your offscreen port and copied the color table from a <code>GDevice</code>,did you change the color table to reflect that the color table is now part of apixmap? In a GDevice the color table's value field is zero for all entries, butin a pixmap the value field represents the index value of each color in thetable. If the color table has not been converted, printing won't workproperly.</p><br><br>                  <a name=Downloads></A>                  <P><A HREF="#top">Back to top</A></P><h2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (64K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/pr_515.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/pr/pr_515.html%3Fid%3DDTS10002647-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/pr/pr_515.html%3Fid%3DDTS10002647-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/pr/pr_515.html%3Fid%3DDTS10002647-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>