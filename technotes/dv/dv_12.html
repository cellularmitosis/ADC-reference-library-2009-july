<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><!--Includes revisions to code listings--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note DV12: Our Checksum Bounced</title><meta name="keywords" content="Mac OS 8 checksum _SysEnvirons pmBootChecksum SCSI Manager"><meta name="Description" content="Technical Note DV12: This Technical Note discusses a fixto a SCSI Manager bug which concerns all developers workingwith SCSI and NuBus device drivers. If the partition mapof your device isn't of the correct type or the checksumperformed on your device fails, it may cause the SCSI Managerto not load your device. Technical Note includes the diskdriver checksum algorithm as seen in Inside Macintosh VolumeV, and Technical Note also tells when it is safe to make_SysEnvirons calls."><meta name="categories" content="Devices"><meta name="week-posted" content="Sep 28, 1998 - Oct 2, 1998"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002402" title="Our Checksum Bounced"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/index.html" target="_blank">Reference Library > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note DV12</div>
<div id="pageheadsub">Our Checksum Bounced</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                   <td background="images/tnmenubody.gif" width=300 align=left>                        <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->					<p id="menutext"><a href="#Section1">A Bit of History</a><BR><BR><a href="#Section2">Drivers That Check In, But Don't Check Out</a><BR><BR><a href="#Section3">Just When You Thought It Was Safe To Call _SysEnvirons</a><BR><BR><a href="#Section4">To Sum it Up</a><BR><BR><a href="#references">References</a><BR><BR><a href="#changes">Change History</a><BR><BR><A href="#downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>		<td width=300 valign="top" align=left>	<!-- begin_intro_text --><P id = "introtext">This Technical Note discusses a fix to a SCSI Manager bug that concerns all developers working with SCSI and NuBus device drivers.</P><!-- end_intro_text --><!-- begin_date --><h3>Updated: [October 01 1989]</h3><!-- end_date -->                </TD>             </TR>          </TABLE> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><a name="Section1"></a><H2>A Bit of History</H2><P>The boot code contained in the ROM has a feature used by the StartManager to perform a checksum on the SCSI driver being loaded.<I>Inside Macintosh</I>, Volume V-573, The SCSI Manager, documentsthis being performed on the Macintosh SE and later models for volumesusing the new partitioning method. The truth, however, is thatchecksum verification was never performed due to a bug in the ROM,and because of this, all drivers loaded regardless of validity.</P><P>That was the case until recently. On new Macintosh computers, thechecksum verification works. That's the good news: we've fixed thebug. Now the bad news: this fix causes a number of third-party SCSIdrivers to fail to load.</P><P>Some SCSI drivers improperly implement the new partitioningscheme. If the partition map entry name begins with the four letters"Maci" (case sensitive) and is of type "Apple_Driver", the driver nowhas its checksum verified with the entries in the partition map. Ifthis checksum fails, the driver is not loaded. This checksum algorithm is documented in <I>Inside Macintosh</I>, Volume V-580, The SCSI Manager.</P><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR><a href="../../documentation/mac/Devices/Devices-2.html">Inside         Macintosh: Devices</A> fails to include the disk driver         checksum algorithm.  As it is now quite difficult to obtain         copies of <I>Inside Macintosh</I>, Volume V, the algorithm         is included below:</P></TD></TR></TABLE></CENTER><BR>                                  <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>DoCksum        moveq.l     #0,d0       ; initialize sum register        moveq.l     #0,d7       ; zero extended byte        bra.s       CkDecr      ; handle 0 bytesCkLoop        move.b      (a0)+,d7    ; get a byte        add.w       d7,d0       ; add to checksum        rol.w       #1,d0       ; and rotateCkDecr        dbra        d1,CkLoop   ; next byte        tst.w       d0          ; convert a checksum of 0        bne.s       @1          ; into $FFFF        subq.w      #1,d0       ;@1</pre>	</TD></TR></TABLE></CENTER>                   <P>The following is a C equivalent:</P>                           <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>static UInt32 ChecksumDriver(void *start, UInt32 length){    UInt8  *cursor;    UInt32 result;    cursor = (UInt8 *) start;    result = 0;    while ( length != 0 ) {        result = result + *cursor;        result = ((result &lt;&lt;  1) &amp; 0x0FFFE) |                 ((result &gt;&gt; 15) &amp; 0x00001);        cursor += 1;        length -= 1;    }    if (result == 0) {        result = 0x0FFFF;    }    return result;}</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="Section2"></a><H2>Drivers That Check In, But Don't Check Out</H2><P>The checksum routine tests the number of bytes specified in<CODE>pmBootSize</CODE>, beginning at the start of the driver boot code.Only drivers contained within the new partition map have this testperformed. If you are using the old partition map scheme documentedin <I>Inside Macintosh</I>, Volume IV-283, The SCSI Manager, thedriver does not have its checksum validated. The following is thestartup logic in the new Macintosh ROMs:</P><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>IF<CODE>  pmSig = $504D</CODE>AND<CODE>  pmPartName = Maci</CODE>AND<CODE>  pmPartType = Apple_Driver</CODE>AND<CODE>  pmBootChecksum = </CODE>ChecksumDriver<CODE>(bootCode, pmBootSize)</CODE>THEN  Load the driverELSE  Do not load the driver</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="Section3"></a><H2>Just When You Thought It Was Safe To Call <CODE>_SysEnvirons</CODE></H2><P>The call <CODE>_SysEnvirons</CODE> was created for compatibilityreasons. It allows an application to make a single call to the systemto determine its characteristics. It keeps the application fromreading ROM addresses and low memory. This trap is now in the ROM ofnew machines. But, before you get excited about this addition to ROM,there is something that <I>Inside Macintosh</I>, Volume V-5,Compatibility Guidelines, states that must be understood by thosewriting SCSI drivers:</P><P><I>"All of the Toolbox Managers must be initialized before callingSysEnvirons."  "...SysEnvirons is not intended for use by devicedrivers, but can be called from desk accessories."</I></P><P>This statement means that neither SCSI nor NuBus device driverscan use <CODE>_SysEnvirons</CODE>. The earliest possible moment to call<CODE>_SysEnvirons</CODE> is at INIT time. Some SCSI drivers call <CODE>_SysEnvirons</CODE>, and this causes the Macintosh to crash at boot time.</P><P><A HREF="#top">Back to top</A></P><a name="Section4"></a><H2>To Sum Up</H2><P>Check if your partition map is of the version described in theSCSI Manager chapter of <I>Inside Macintosh</I>, Volume V, andcontains the <CODE>pmPartName</CODE> and <CODE>pmPartType</CODE> as mentionedearlier in this Note. If it does, then verify that the <CODE>pmBootChecksum</CODE> is correct. If the checksum is not correct, the new Macintosh computers will not load your driver. The solution to this problem is to have a valid partition map entry in allcases and to expect the Start Manager to perform the checksum verificationregardless of the <CODE>machineType</CODE>.</P><P><CODE>_SysEnvirons</CODE> is not available until the system has been initialized.</P><P><A HREF="#top">Back to top</A></P><a name="references"></a><h2>References</h2>   <p><I>Inside Macintosh</I>, Volume IV-283, The SCSI Manager</p>      <p><I>Inside Macintosh</I>, Volume V-5, Compatibility Guidelines</p>      <p><I>Inside Macintosh</I>, Volume V-573, The SCSI Manager</p>      <p><a href="../../documentation/mac/Devices/Devices-119.html">Inside Macintosh: Devices, SCSI Manager</A></p>      <p><a href="../../documentation/mac/Devices/Devices-151.html">Inside Macintosh: Devices, SCSI Manager 4.3</A></p>      <p><A HREF = "../ov/ov_16.html">Technote OV 16, "Gestalt and SysEnvirons: A Never Ending Story"</A></p><P>NuBus is a trademark of Texas Instruments, Inc.</P><P><A HREF="#top">Back to top</A></P><a name="changes"></a><h2>Change History</h2><TABLE BORDER=0 CELLPADDING=3 WIDTH=544>   		<TR>               <td width=100 align=left>                  <P ALIGN=center>01-October-1988</P>               </TD>               <td align="left">                  <P>Originally written.</P>               </TD>            </TR><TR>               <td width=100 align=left>                  <P ALIGN=center>01-October-1999</P>               </TD>               <td align="left">                  <P>The Note now includes the driverchecksum algorithm, otherwise only documented in <I>Inside Macintosh</I>, Volume V.</P>               </TD>            </TR></table><P><A HREF="#top">Back to top</A></P>         <a name="downloads"></a>         <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center>                                    <img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (52K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/dv_12.pdf">Download</A></P>               </TD>            </TR>         </TABLE>         <BR>                  <P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/dv/dv_12.html%3Fid%3DDTS10002402-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/dv/dv_12.html%3Fid%3DDTS10002402-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/dv/dv_12.html%3Fid%3DDTS10002402-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>