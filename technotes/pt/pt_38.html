<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note PT38: PowerPC Compatibility and Performance Issues</title>                                       <meta name="categories" content="Platforms and Tools"><meta name="week-posted" content="Oct 31, 1994 - Nov 4, 1994"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002692" title="PowerPC Compatibility and Performance Issues"></a><a name="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/index.html" target="_blank">Reference Library > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note PT38</div>
<div id="pageheadsub">PowerPC Compatibility and Performance Issues</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Section1">Introduction</A><BR><BR><A HREF="#Section2">POWER Instructions</A><BR><BR><A HREF="#Section3">POWER register usage</A><BR><BR><A HREF="#Section4">Load/store string and load/store <BR>multiple word instructions</A><BR><BR><A HREF="#Section5">Cache coherency</A><BR><BR><A HREF="#Section6">Data alignment</A><BR><BR><A HREF="#References">References</A><BR><BR><A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><p id="introtext">This Technical Note discusses differences between the PowerPC 601 chip andfuture 603 and 604 chips, and how these differences affect applicationcompatibility and performance.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Sep 01 1994]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content --><a name=Section1></A> <h2>Introduction</h2>            <P>The PowerPC 601 chip is a transitional CPU, bridging the new PowerPCarchitecture with the old POWER architecture from which it is descended.  Assuch, it implements most of the old POWER instruction set, as well as thePowerPC instruction set.  Subsequent PowerPC CPUs, such as the 603 and 604 onlyimplement the PowerPC architecture. Additionally, implementation differencesbetween the 601 and 603/604 chips can also affect performance.  This notediscusses the implications for compatibility and performance arising from thesedifferences.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>These issues typically affect developers who are actuallygenerating code for the PowerPC.  Most application developers have littlecontrol over the code generated as that is the responsibility of the compiler.However, at the time this is being written, few compilers fully address theseissues, so all developers should check with their tools developers to determinewhich versions of tools do (or will) address these issues.</P></TD></TR></TABLE></CENTER><BR><a name="Section2"></a><P><A HREF="#top">Back to top</A></p><h2>POWER Instructions</h2><p>A variety of instructions which were part of the POWER architecture have beeneliminated from the PowerPC architecture, 34 instructions, in all.  However,most of these instructions are included in the PowerPC 601 implementation aspart of the transition from POWER.  This made it easier to bring up POWER codeon PowerPC, but they have been eliminated in subsequent implementations, suchas the 603 and 604.  A list of this instructions can be found in Table B-3 ofthe <i>PowerPC 601 RISC Microprocessor User's Manual</i>., and for convenienceis reproduced below.</p><p align=center><B>Table 1</b>. POWER Instructions Deleted from PowerPC Architecture</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>abs     absolute                          rrib  rotate right and insert bitclcs    cache line compute size           sle   shift left extendedclf     cache line flush+                 sleq  shift left extended with MQcli     cache line invalidate+            sliq  shift left immediate with MQdclst   data cache line store+            slli  shift left long immediate with MQ                                          qdiv     divide                            sllq  shift left long with MQdivs    divide short                      slq   shift left with MQdoz     difference or zero                srai  shift right algebraic immediate                                          q     with MQdozi    difference or zero immediate      sraq  shift right algebraic with MQlcsbx   load string and compare byte      sre   shift right extended        indexedmaskg   mask generate                     srea  shift right extended algebraicmaskir  mask insert from register         sreq  shift right extended with MQmfsrin  move from segment register        sriq  shift right immediate with MQ        indirectmul     multiply                          srli  shift right long immediate with MQ                                          qnabs    negative absolute                 srlq  shift right long with MQrac     real address compute+             srq   shift right with MQrlmi    rotate left then mask insert      scvx  supervisor call, with SA = 0+</pre>	</TD></TR></TABLE></CENTER><p>+ Instructions <i>not</i> implemented in PowerPC 601</P><P>Most compilers designed for PowerPC do not emit these instructions, however,some compilers originally designed for POWER code generation may.  You shouldcontact your compiler vendor for the latest information.</p><p>The IBM xlc C compiler and xlC C++ compilers have an option to suppress POWERcode generation, -qarch=ppc.  Anyone using these compilers <b><i>must</i></b>use this option to generate code that runs safely on 603/604 CPUs.  Fordevelopers seeded by Apple with these compilers, this option was part of therecommended cmac stanza in the xlc.cfg file.  Developers should verify thatthis option is in effect for all parts of their code.</p><p>The GNU gcc compiler is also a POWER compiler, but currently has no option forPowerPC only code generation.  Developers should beware of code generated bythis compiler.</p><p>Anyone writing PowerPC assembly should also take care not to use theseinstructions.</p><p>The latest Prerelease MPW DumpPEF tool (version 2.0b1 from E.T.O. #15) has anoption, -w601, to scan for PowerPC 601 specific instructions.  It is one way totest if your code is affected.  Be aware, however, that DumpPEF cannot alwaysdistinguish between code and data and may flag POWER opcodes that are reallydata.  You should check all warnings from DumpPEF to be sure they are notspurious.  Even if the tool finds valid POWER opcodes, there is no guaranteethe instructions are part of an executable code path.  You should, of course,test your application on 603/604 hardware as soon as it is available.</p><a name="Section3"> </a><P><A HREF="#top">Back to top</A></p><h2>POWER register usage</h2><p>In addition to the POWER instructions that are only implemented on 601, the 601has internal registers that are unavailable on subsequent PowerPC processors.These are the multiply-quotient (MQ) and the real-time clock (RTC) registers.</p><p>The MQ register is generally accessed using POWER MQ instructions (see tableabove), and is covered in the previous section.</p><p>The RTC register can be useful for timing purposes, but is not accessible fromhigh level languages.  It would only be a problem if assembly language code waswritten to directly access the register.</p><a name="Section4"></a> <P><A HREF="#top">Back to top</A></p><h2>Load/store string and load/store multiple word instructions</h2><p>A variety of instructions can interfere with instruction pipelining.  Mostproblematic for application code are the multicycle load/store string andload/store multiple word instructions because many compilers make use of them.These instructions are referred to as completion serialized instructionsbecause they cause all prior instructions to complete before they execute.This interferes with performance on more heavily pipelined implementations,such as the 604 where this can cause a 6 cycle delay before instructionexecution.</p><p>The possible implementation limitations of these instructions were noted inPowerPC 601 documentation but compilers use them anyway for convenience and toreduce code expansion.  For example, string instructions are often used to copycontiguous data in memory, such as when assigning a struct to a struct.Load/store multiple word instructions are often used for saving and restoringregisters as part of function prolog/epilog code.</p><p>Apple is working with compiler developers to establish guidelines for usingthese instructions appropriately.  Developers should check with compiler vendors for the latestinformation on their tools and their use of these instructions.</p> <a name="Section5"></a><P><A HREF="#top">Back to top</A></p><h2>Cache coherency</h2><p>PowerPC 601 features a unified instruction/data cache, while 603 and 604feature separate instruction and data caches.  This leads to potential cachecoherency problems analogous to those encountered when MC68040 machines werereleased.  Fortunately, the PowerPC runtime architecture reduces this risk asmuch as possible.</p><p>Almost all code for PowerPC is loaded and prepared by the Code FragmentManager.  The CFM ensures that all such code is suitable for execution.  If allyour code is loaded by the Code Fragment Manager, you don't have to worry aboutcache coherency.</p><p>However, if you generate code in memory for execution, you should be concernedabout this issue.  This includes compilers that generate code for immediateexecution and interpreters that compile an interpreted language into memory forexecution.</p><p>You can eliminate the cache coherency problem by notifying the system that datais subject to execution.  Use the call MakeDataExecutable, defined inOSUtils.h:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>extern pascal void MakeDataExecutable(void *baseAddress, unsigned long length);</pre>	</TD></TR></TABLE></CENTER><P>Thiscall is currently only implemented for PowerPC, so you must conditionallycompile it.  It takes an address, which is the start of the data to be flushedand a length, for the amount of data.  Be very careful about flushing the cacheunnecessarily as you will adversely affect performance.</p><a name="Section6"></a> <P><A HREF="#top">Back to top</A></p><h2>Data alignment</h2><P>Modern RISC designs generally prefer <i>natural</i>  alignment for data (forexample, shorts only need be 2-byte aligned, but doubles need to be 8-bytealigned.)  But 680x0 code typically aligns data on 16-bit boundaries, andPowerPC was explicitly designed to support this kind of data access.  The 601does not suffer much of a performance penalty with most misaligned dataaccesses.  This will no longer be true on later PowerPC CPUs, however.Furthermore, as the PowerPC processor family grows, it is likely that theperformance hit for misaligned accesses will grow as well.</p><p>While the 603 and 604 designs support misaligned data access, an alignmentexception is thrown under some conditions.  These exceptions are handledsilently by the nanokernel, and you will see no evidence of the exception otherthan a decrease in performance on 603 and 604 processors.  Because these loadsand stores are handled by the nanokernel instead of the hardware, a significantperformance hit is taken for every misaligned access.  As an example, take thefollowing data structure:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>struct ArrayWithHeader {   short    BlockHeader;   double    Elements[kSomeLargeNumber];};</pre>	</TD></TR></TABLE></CENTER><BR><P>Whencompiled with 68K alignment, an iteration over the array elements (meaning adata access on halfword boundaries for each <code>double</code>) may take up toforty times longer on a 603 or 604 than on a 601.  When compiled with PowerPCalignment (which inserts a halfword pad in the data structure, to guaranteethat accesses to the array will be on word boundaries), an iteration completesin less time than on a 601.</p><p>Note that while this significant performance hit is only present when accessing<code>floats</code> or <code>doubles</code> on non-word boundaries, optimal performancefor iterating over this array takes place when accessing its elements on 8 byteboundaries.  On the PowerPC misaligned access of integer types do not cause analignment exception, but there is still a performance loss when compared toaligned integer accesses.  If speed is important, make sure that access to anyof your data structure fields fall on natural boundaries, or are (minimally)compiled with PowerPC alignment.</p><p>While it is essential that you use 680x0 data alignment for data shared with680x0 code (such as the Toolbox), you should always use PowerPC alignment fordata used internally to your application.  In particular <b>do not turn onglobal 680x0 data alignment for your PowerPC code</b>.  Use alignment pragmasto turn on 680x0 data alignment only when absolutely necessary.</p><a name="References"></a> <P><A HREF="#top">Back to top</A></p><h2>References</h2><p><i>PowerPC(TM) 601 RISC Microprocessor User's Manual</i></p><p><i>PowerPC(TM) 603 RISC Microprocessor User's Manual</i></p><p><i>The PowerPC(TM) Architecture</i></p>         <a name=Downloads></A>                  <P><A HREF="#top">Back to top</A></p> <h2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/pt_38.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/pt/pt_38.html%3Fid%3DDTS10002692-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/pt/pt_38.html%3Fid%3DDTS10002692-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/pt/pt_38.html%3Fid%3DDTS10002692-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>