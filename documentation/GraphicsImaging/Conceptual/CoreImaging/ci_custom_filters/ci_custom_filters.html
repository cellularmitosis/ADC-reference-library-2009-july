<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Core Image Programming Guide: Creating Custom Filters</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Creating Custom Filters"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30001185-CH207" title="Creating Custom Filters"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000424" target="_top">Graphics &amp; Imaging</a> &gt; <a href="../../../Quartz-date.html#//apple_ref/doc/uid/TP30000440-TP30000424-TP30000559" target="_top">Quartz</a> &gt; <a href="../ci_intro/ci_intro.html#//apple_ref/doc/uid/TP30001185-CH201-TPXREF101">Core Image Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../ci_tasks/ci_tasks.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../ci_image_units/ci_image_units.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30001185-CH207-TPXREF101" title="Creating Custom Filters"></a><h1>Creating Custom Filters</h1><p>If the filters provided by Core Image don’t provide the functionality you need, you can write your own filter. You can include a filter as part of an application project, or you can package one or more filters as a standalone <strong>image unit</strong>. Image units use the <code><a href="../../../../Cocoa/Reference/Foundation/Classes/NSBundle_Class/Reference/Reference.html#//apple_ref/occ/cl/NSBundle" target="_top">NSBundle</a></code> class and represent the plug-in architecture for filters.</p><p>The following sections provide detailed information on how to create and use custom filters and image units: </p><ul class="ul"><li class="li"><p><span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-BCIHEJJI">“Expressing Image Processing Operations in Core Image”</a></span></p></li><li class="li"><p><span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-CJBEDHHH">“Creating a Custom Filter”</a></span> describes the methods that you need to implement and other filter requirements.</p></li><li class="li"><p><span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-CJBHDGAA">“Using Your Own Custom Filter”</a></span> tells what’s need for you to use the filter in your own application. (If you want to package it as a standalone image unit, see <span class="content_text"><a href="../ci_image_units/ci_image_units.html#//apple_ref/doc/uid/TP30001185-CH208-SW12">“Packaging Filters as Image Units.”</a></span>)</p></li><li class="li"><p><span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-CJBECAEC">“Supplying an ROI Function”</a></span> provides information about the region of interest and when you must supply a method to calculate this region. (It’s not always needed.)</p></li><li class="li"><p><span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-CJBFHGGC">“Writing Nonexecutable Filters”</a></span> is a must-read section for anyone who plans to write a filter that is CPU nonexecutable, as it lists the requirements for such filters. An image unit can contain both kinds of filters. CPU nonexecutable filters are secure because they cannot harbor viruses and trojan horses. Filter clients who are security conscious may want to use only those filters that are CPU nonexecutable.</p></li><li class="li"><p><span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-SW5">“Kernel Routine Examples”</a></span> provides kernel routines for three sample filters: brightening, multiply, and hole distortion.</p></li></ul><a name="//apple_ref/doc/uid/TP30001185-CH207-BCIHEJJI" title="Expressing Image Processing Operations in Core Image"></a><h2>Expressing Image Processing Operations in Core Image</h2><p>Core Image works such that a kernel (that is, a per-pixel processing routine) is written as a computation where an output pixel is expressed using an inverse mapping back to the corresponding pixels of the kernel’s input images. Although you can express most pixel computations this way—some more naturally than others—there are some image processing operations for which this is difficult, if not impossible. Before you write a filter, you may want to consider whether the image processing operation can be expressed in Core Image. For example, computing a histogram is difficult to describe as an inverse mapping to the source image.</p><a name="//apple_ref/doc/uid/TP30001185-CH207-CJBEDHHH" title="Creating a Custom Filter"></a><h2>Creating a Custom Filter</h2><p>This section shows how to create a Core Image filter that has an Objective-C portion and a kernel portion. By following the steps in this section, you’ll create a filter that is CPU executable. You can package this filter, along with other filters if you’d like, as an image unit by following the instructions in <span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-TPXREF101">“Creating Custom Filters.”</a></span> Or, you can simply use the filter from within your own application. See <span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-CJBHDGAA">“Using Your Own Custom Filter”</a></span> for details.</p><p>The filter in this section assumes that the region of interest (ROI) and the domain of definition coincide. If you want to write a filter for which this assumption isn’t true, make sure you also read <span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-CJBECAEC">“Supplying an ROI Function.”</a></span> Before you create your own custom filter, make sure you understand Core Image coordinate spaces. See <span class="content_text"><a href="../ci_concepts/ci_concepts.html#//apple_ref/doc/uid/TP30001185-CH202-SW1">“Coordinate Spaces .”</a></span></p><p>To create a custom CPU executable filter, perform the following steps:</p><ol class="ol"><li class="li"><p><span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-BCIIICCJ">“Write the Kernel Code”</a></span></p></li><li class="li"><p><span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-BCICGCJF">“Use Quartz Composer to Test the Kernel Routine”</a></span></p></li><li class="li"><p><span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-BCIIHIIA">“Declare an Interface for the Filter”</a></span></p></li><li class="li"><p><span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-SW2">“Write an Init Method for the CIKernel Object”</a></span></p></li><li class="li"><p><span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-SW1">“Write a Custom Attributes Method”</a></span></p></li><li class="li"><p><span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-BCIEDBFC">“Write an Output Image Method”</a></span></p></li><li class="li"><p><span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-BCIBGCGJ">“Register the Filter”</a></span></p></li><li class="li"><p><span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-BCIHDFBG">“Write a Method to Create Instances of the Filter”</a></span></p></li></ol><p>Each step is described in detail in the sections that follow using a haze removal filter as an example. The effect of the haze removal filter is to adjust the brightness and contrast of an image, and to apply sharpening to it. This filter is useful for correcting images taken through light fog or haze, which is typically the case when taking an image from an airplane. <span class="content_text">Figure 3-1</span> shows an image before and after processing with the haze removal filter. The application using the filter provides sliders that allow the user to adjust the input parameters to the filter.</p><br/><div><a name="//apple_ref/doc/uid/TP30001185-CH207-CJBGCCAC" title="Figure 3-1An image before and after processing with the haze removal filter"></a><p><strong>Figure 3-1&nbsp;&nbsp;</strong>An image before and after processing with the haze removal filter</p><img src = "../art/haze_pre_post.gif" alt = "An image before and after processing with the haze removal filter" width="464" height="290"></div><br/><a name="//apple_ref/doc/uid/TP30001185-CH207-BCIIICCJ" title="Write the Kernel Code"></a><h3>Write the Kernel Code</h3><p>The code that performs per-pixel processing resides in a file with the <code>.cikernel</code> extension. You can include more than one kernel routine in this file. You can also include other routines if you want to make your code modular. You specify a kernel using a subset of OpenGL Shading Language and the Core Image extensions to it. See <em><a href="../../../Reference/CIKernelLangRef/index.html#//apple_ref/doc/uid/TP40004397" target="_top">Core Image Kernel Language Reference</a></em> for information on allowable elements of the language.</p><p>A kernel routine signature must return a vector (<code>vec4</code>) that contains the result of mapping the source to the destination. Core Image invokes a kernel routine once for each pixel. Keep in mind that your code can’t accumulate knowledge from pixel to pixel. A good strategy when you write your code is to move as much invariant calculation as possible from the actual kernel and place it in the Objective-C portion of the filter.</p><p><span class="content_text">Listing 3-1</span> shows the kernel routine for a haze removal filter. A detailed explanation for each numbered line of code follows the listing. (There are examples of other pixel-processing routines in <span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-SW5">“Kernel Routine Examples”</a></span> and in <em><a href="../../ImageUnitTutorial/index.html#//apple_ref/doc/uid/TP40004531" target="_top">Image Unit Tutorial</a></em>.) </p><a name="//apple_ref/doc/uid/TP30001185-CH207-BCIHBFFI" title="Listing 3-1A kernel routine for the haze removal filter"></a><p class="codesample"><strong>Listing 3-1&nbsp;&nbsp;</strong>A kernel routine for the haze removal filter</p><div class="codesample"><table><tr><td scope="row"><pre>kernel vec4 myHazeRemovalKernel(sampler src,<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>                     __color color,<span></span></pre></td></tr><tr><td scope="row"><pre>                    float distance,<span></span></pre></td></tr><tr><td scope="row"><pre>                    float slope)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    vec4   t;<span></span></pre></td></tr><tr><td scope="row"><pre>    float  d;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    d = destCoord().y * slope  +  distance; <span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    t = unpremultiply(sample(src, samplerCoord(src))); <span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    t = (t - d*color) / (1.0-d); <span>// 4</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return premultiply(t); <span>// 5</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Takes four input parameters and returns a vector. When you declare the interface for the filter, you must make sure to declare the same number of input parameters as you specify in the kernel. The kernel must return a <code>vec4</code> data type.</p></li><li class="li"><p>Calculates a value based on the <em>y</em>-value of the destination coordinate and the slope and distance input parameters. The <code>destCoord</code> routine (provided by Core Image) returns the position, in working space coordinates, of the pixel currently being computed.</p></li><li class="li"><p>Gets the pixel value, in sampler space, of the sampler <code>src</code> that is associated with the current output pixel after any transformation matrix associated with the <code>src</code> is applied. Recall that Core Image uses color components with premultiplied alpha values. Before processing, you need to unpremultiply the color values you receive from the sampler.</p></li><li class="li"><p>Calculates the output vector by applying the haze removal formula, which incorporates the slope and distance calculations and adjusts for color.</p></li><li class="li"><p>Returns a <code>vec4</code> vector, as required. The kernel performs a premultiplication operation before returning the result because Core Image uses color components with premultiplied alpha values.</p></li></ol><div class="notebox"><a name="//apple_ref/doc/uid/TP30001185-CH207-SW7" title="A few words about samplers and sample coordinate space"></a><p><strong>A few words about samplers and sample coordinate space:</strong>&nbsp; The samplers you set up to provide samples to kernels that you write can contain any values necessary for the filter calculation, not just color values. For example, a sampler can provide values from numerical tables, vector fields in which the <em>x</em> and <em>y</em> values are represented by the red and green components respectively, height fields, and so forth. This means that you can store any vector-value field with up to four components in a sampler. To avoid confusion on the part of the filter client, it’s best to provide documentation that states when a vector is not used for color. When you use a sampler that doesn’t provide color, you can bypass the color correction that Core Image usually performs by providing a <code>nil</code> colorspace.</p></div><a name="//apple_ref/doc/uid/TP30001185-CH207-BCICGCJF" title="Use Quartz Composer to Test the Kernel Routine"></a><h3>Use Quartz Composer to Test the Kernel Routine</h3><p>Quartz Composer is an easy-to-use development tool (provided starting in Mac OS X v10.4) that you can use to test kernel routines. The Quartz Composer application is located in this directory:</p><p><code>/Developer/Applications/</code></p><p><em><a href="../../QuartzComposerUserGuide/index.html#//apple_ref/doc/uid/TP40005381" target="_top">Quartz Composer User Guide</a></em> describes the Quartz Composer user interface and provides details on how to create compositions. You’ll want to read that document before you use Quartz Composer to test your kernel routine.</p><p>Quartz Composer provides a patch into which you can place your kernel routine. (In Mac OS X v10.4 this patch is named Core Image Kernel patch; it’s called Core Image Filter patch in Mac OS X v10.5 and later.) You simply open the Inspector for the Core Image patch, and either paste or type your code into the text field, as shown in <span class="content_text">Figure 3-2</span>.</p><br/><div><a name="//apple_ref/doc/uid/TP30001185-CH207-BCIBEDDJ" title="Figure 3-2The haze removal kernel routine pasted into the Settings pane"></a><p><strong>Figure 3-2&nbsp;&nbsp;</strong>The haze removal kernel routine pasted into the Settings pane</p><img src = "../art/qc_kernel_code.gif" alt = "The haze removal kernel routine pasted into the Settings pane" width="362" height="323"></div><br/><p>After you enter the code, the patch inputs ports are automatically created according to the prototype of the kernel function, as you can see in <span class="content_text">Figure 3-3</span>. The patch always has a single output port, which represents the resulting image produced by the kernel. </p><p>The simple composition shown in the figure imports an image file using the Image Importer patch, processes it through the kernel, then renders the result on screen using the Billboard patch. (See <em><a href="../../QuartzComposerUserGuide/index.html#//apple_ref/doc/uid/TP40005381" target="_top">Quartz Composer User Guide</a></em> for information on the Image Importer and Billboard patches). Your kernel can use more than one image or, if it generates output, it might not require any input images. </p><p>The composition you build to test your kernel can be more complex than that shown in <span class="content_text">Figure 3-3</span>. For example, you might want to chain your kernel routine with other built-in Core Image filters or with other kernel routines. Quartz Composer provides many, many other patches that you can use in the course of testing your kernel routine.</p><br/><div><a name="//apple_ref/doc/uid/TP30001185-CH207-BCIGHFDF" title="Figure 3-3A Quartz Composer composition that tests a kernel routine"></a><p><strong>Figure 3-3&nbsp;&nbsp;</strong>A Quartz Composer composition that tests a kernel routine</p><img src = "../art/qc_kernel_patch.gif" alt = "A Quartz Composer composition that tests a kernel routine" width="325" height="112"></div><br/><a name="//apple_ref/doc/uid/TP30001185-CH207-BCIIHIIA" title="Declare an Interface for the Filter"></a><h3>Declare an Interface for the Filter</h3><p>The <code>.h</code> file for the filter contains the interface that specifies the filter inputs, as shown in <span class="content_text">Listing 3-2</span>. The haze removal kernel has four input parameters: a source, color, distance, and slope. The interface for the filter must also contain these input parameters. The input parameters must be in the same order as specified for the filter, and the data types must be compatible between the two.</p><a name="//apple_ref/doc/uid/TP30001185-CH207-BCIGJDFE" title="Listing 3-2Code that declares the interface for a haze removal filter"></a><p class="codesample"><strong>Listing 3-2&nbsp;&nbsp;</strong>Code that declares the interface for a haze removal filter</p><div class="codesample"><table><tr><td scope="row"><pre>@interface MyHazeFilter: CIFilter<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CIImage   *inputImage;<span></span></pre></td></tr><tr><td scope="row"><pre>    CIColor   *inputColor;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSNumber  *inputDistance;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSNumber  *inputSlope;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@end<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30001185-CH207-SW2" title="Write an Init Method for the CIKernel Object"></a><h3>Write an Init Method for the CIKernel Object</h3><p>The implementation file for the filter contains a method that initializes a Core Image kernel object (<code>CIKernel</code>) with the kernel routine specified in the <code>.cikernel</code> file. A <code>.cikernel</code> file can contain more than one kernel routine. A detailed explanation for each numbered line of code appears following the listing.</p><a name="//apple_ref/doc/uid/TP30001185-CH207-CJBIJACE" title="Listing 3-3An init method that initializes the kernel "></a><p class="codesample"><strong>Listing 3-3&nbsp;&nbsp;</strong>An init method that initializes the kernel </p><div class="codesample"><table><tr><td scope="row"><pre>static CIKernel *hazeRemovalKernel = nil;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (id)init<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    if(hazeRemovalKernel == nil)<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        NSBundle    *bundle = [NSBundle bundleForClass: [self class]];<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>        NSString    *code = [NSString stringWithContentsOfFile: [bundle<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>                                pathForResource: @"MyHazeRemoval"<span></span></pre></td></tr><tr><td scope="row"><pre>                                ofType: @"cikernel"]];<span></span></pre></td></tr><tr><td scope="row"><pre>        NSArray     *kernels = [CIKernel kernelsWithString: code];<span>// 4</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        hazeRemovalKernel = [[kernels objectAtIndex:0] retain];<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return [super init];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Checks whether the <code>CIKernel</code> object is already initialized.</p></li><li class="li"><p>Returns the bundle that dynamically loads the <code>CIFilter</code> class.</p></li><li class="li"><p>Returns a string created from the file name at the specified path, which in this case is the <code>MyHazeRemoval.cikernel</code> file.</p></li><li class="li"><p>Creates a <code>CIKernel</code> object from the string specified by the <code>code</code> argument. Each routine in the <code>.cikernel</code> file that is marked as a kernel is returned in the <code>kernels</code> array. This example has only one kernel in the <code>.cikernel</code> file, so the array contains only one item.</p></li><li class="li"><p>Sets <code>hazeRemovalKernel</code> to the first kernel in the <code>kernels</code> array. If the <code>.cikernel</code> file contains more than one kernel, you would also initialize those kernels in this routine.</p></li></ol><a name="//apple_ref/doc/uid/TP30001185-CH207-SW1" title="Write a Custom Attributes Method"></a><h3>Write a Custom Attributes Method</h3><p>A <code>customAttributes</code> method allows clients of the filter to obtain the filter attributes such as the input parameters, default values, and minimum and maximum values. (See <em><a href="../../../Reference/QuartzCoreFramework/Classes/CIFilter_Class/index.html#//apple_ref/doc/uid/TP40003960" target="_top">CIFilter Class Reference</a></em> for a complete list of attributes.) A filter is not required to provide any information about an attribute other than its class, but a filter must behave in a reasonable manner if attributes are not present.</p><p>Typically, these are the attributes that your <code>customAttributes</code> method would return:</p><ul class="spaceabove"><li class="li"><p>Input and output parameters</p></li><li class="li"><p>Attribute class for each parameter (mandatory)</p></li><li class="li"><p>Minimum, maximum, and default values for each parameter (optional)</p></li><li class="li"><p>Other information as appropriate, such as slider minimum and maximum values (optional)</p></li></ul><p><span class="content_text">Listing 3-4</span> shows the <code>customAttributes</code> method for the Haze filter. The input parameters <code>inputDistance</code> and <code>inputSlope</code> each have minimum, maximum, slider minimum, slider maximum, default and identity values set. The slider minimum and maximum values are used to set up the sliders shown in <span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-CJBGCCAC">Figure 3-1</a></span>. The <code>inputColor</code> parameter has a default value set.</p><a name="//apple_ref/doc/uid/TP30001185-CH207-SW3" title="Listing 3-4The customAttributes method for the Haze filter"></a><p class="codesample"><strong>Listing 3-4&nbsp;&nbsp;</strong>The <code>customAttributes</code> method for the Haze filter</p><div class="codesample"><table><tr><td scope="row"><pre>- (NSDictionary *)customAttributes<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return [NSDictionary dictionaryWithObjectsAndKeys:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        [NSDictionary dictionaryWithObjectsAndKeys:<span></span></pre></td></tr><tr><td scope="row"><pre>            [NSNumber numberWithDouble:  0.0], kCIAttributeMin,<span></span></pre></td></tr><tr><td scope="row"><pre>            [NSNumber numberWithDouble:  1.0], kCIAttributeMax,<span></span></pre></td></tr><tr><td scope="row"><pre>            [NSNumber numberWithDouble:  0.0], kCIAttributeSliderMin,<span></span></pre></td></tr><tr><td scope="row"><pre>            [NSNumber numberWithDouble:  0.7], kCIAttributeSliderMax,<span></span></pre></td></tr><tr><td scope="row"><pre>            [NSNumber numberWithDouble:  0.2], kCIAttributeDefault,<span></span></pre></td></tr><tr><td scope="row"><pre>            [NSNumber numberWithDouble:  0.0], kCIAttributeIdentity,<span></span></pre></td></tr><tr><td scope="row"><pre>            kCIAttributeTypeScalar,            kCIAttributeType,<span></span></pre></td></tr><tr><td scope="row"><pre>            nil],                              @"inputDistance",<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        [NSDictionary dictionaryWithObjectsAndKeys:<span></span></pre></td></tr><tr><td scope="row"><pre>            [NSNumber numberWithDouble: -0.01], kCIAttributeSliderMin,<span></span></pre></td></tr><tr><td scope="row"><pre>            [NSNumber numberWithDouble:  0.01], kCIAttributeSliderMax,<span></span></pre></td></tr><tr><td scope="row"><pre>            [NSNumber numberWithDouble:  0.00], kCIAttributeDefault,<span></span></pre></td></tr><tr><td scope="row"><pre>            [NSNumber numberWithDouble:  0.00], kCIAttributeIdentity,<span></span></pre></td></tr><tr><td scope="row"><pre>            kCIAttributeTypeScalar,             kCIAttributeType,<span></span></pre></td></tr><tr><td scope="row"><pre>            nil],                               @"inputSlope",<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        [NSDictionary dictionaryWithObjectsAndKeys:<span></span></pre></td></tr><tr><td scope="row"><pre>            [CIColor colorWithRed:1.0 green:1.0 blue:1.0 alpha:1.0],<span></span></pre></td></tr><tr><td scope="row"><pre>                                 kCIAttributeDefault,<span></span></pre></td></tr><tr><td scope="row"><pre>            nil],                               @"inputColor",<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        nil];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30001185-CH207-BCIEDBFC" title="Write an Output Image Method"></a><h3>Write an Output Image Method</h3><p>An <code>outputImage</code> method creates a <code>CISampler</code> object for each input image (or image mask), creates a <code>CIFilterShape</code> object (if appropriate), and applies the kernel method. <span class="content_text">Listing 3-5</span> shows an <code>outputImage</code> method for the haze removal filter. The first thing the codes does is to set up a sampler to fetch pixels from the input image. Because this filter uses only one input image, the code sets up only one sampler.</p><p>The code calls the <code><a href="../../../Reference/QuartzCoreFramework/Classes/CIFilter_Class/Reference/Reference.html#//apple_ref/occ/instm/CIFilter/apply:arguments:options:" target="_top">apply:arguments:options:</a></code> method of <code>CIFilter</code> to produce a <code>CIImage</code> object. The first parameter to the apply method is the CIKernel object that contains the haze removal kernel function. (See <span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-BCIIICCJ">“Write the Kernel Code.”</a></span>) Recall that the haze removal kernel function takes four arguments: a sampler, a color, a distance, and the slope. These arguments are passed as the next four parameters to the <code><a href="../../../Reference/QuartzCoreFramework/Classes/CIFilter_Class/Reference/Reference.html#//apple_ref/occ/instm/CIFilter/apply:arguments:options:" target="_top">apply:arguments:options:</a></code> method in the listing. The remaining arguments to the apply method specify options (key-value pairs) that control how Core Image should evaluate the function. You can pass one of three keys: <code><!--a target="_top" -->kCIApplyOptionExtent<!--/a--></code>, <code><!--a target="_top" -->kCIApplyOptionDefinition<!--/a--></code>, or <code><!--a target="_top" -->kCIApplyOptionUserInfo<!--/a--></code>. This example uses the <code><!--a target="_top" -->kCIApplyOptionDefinition<!--/a--></code> key to specify the domain of definition (DOD) of the output image. See <span class="content_text"><a href="../../../Reference/QuartzCoreFramework/Classes/CIFilter_Class/Reference/Reference.html#//apple_ref/doc/uid/TP40003960-RH2" target="_top">CIFilter Class Reference</a></span> for a description of these keys and for more information on using the <code><a href="../../../Reference/QuartzCoreFramework/Classes/CIFilter_Class/Reference/Reference.html#//apple_ref/occ/instm/CIFilter/apply:arguments:options:" target="_top">apply:arguments:options:</a></code> method.</p><p>The final argument <code>nil</code>, specifies the end of the options list.</p><a name="//apple_ref/doc/uid/TP30001185-CH207-BCIBACAF" title="Listing 3-5A method that returns the image output from a haze removal filter"></a><p class="codesample"><strong>Listing 3-5&nbsp;&nbsp;</strong>A method that returns the image output from a haze removal filter</p><div class="codesample"><table><tr><td scope="row"><pre>- (CIImage *)outputImage<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CISampler *src = [CISampler samplerWithImage: inputImage];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return [self apply: hazeRemovalKernel, src, inputColor, inputDistance,<span></span></pre></td></tr><tr><td scope="row"><pre>        inputSlope, kCIApplyOptionDefinition, [src definition], nil];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p><span class="content_text">Listing 3-5</span> is a simple example. The implementation for your <code>outputImage</code> method needs to be tailored to your filter. If your filter requires loop-invariant calculations, you would include them in the <code>outputImage</code> method rather than in the kernel.</p><a name="//apple_ref/doc/uid/TP30001185-CH207-BCIBGCGJ" title="Register the Filter"></a><h3>Register the Filter</h3><p>Ideally, you’ll package the filter as an image unit, regardless of whether you plan to distribute the filter to others or use it only in your own application. If you plan to package this filter as an image unit, you’ll register your filter using the <code>CIPlugInRegistration</code> protocol described in <span class="content_text"><a href="../ci_image_units/ci_image_units.html#//apple_ref/doc/uid/TP30001185-CH208-SW12">“Packaging Filters as Image Units.”</a></span> You can skip the rest of this section.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30001185-CH207-SW8" title="Note"></a><p><strong>Note:</strong>&nbsp;Packaging your custom filter as an image unit promotes modular programming and code maintainability.</p></div><p>If for some reason you do not want to package the filter as an image unit (which is not recommended), you’ll need to register your filter using the registration method of the <code>CIFilter</code> class described shown in <span class="content_text">Listing 3-6</span>. The initialize method calls <code><a href="../../../Reference/QuartzCoreFramework/Classes/CIFilter_Class/Reference/Reference.html#//apple_ref/occ/clm/CIFilter/registerFilterName:constructor:classAttributes:" target="_top">registerFilterName:constructor:classAttributes:</a></code>. You should register only the display name (<code><!--a target="_top" -->kCIAttributeFilterDisplayName<!--/a--></code>) and the filter categories (<code><!--a target="_top" -->kCIAttributeFilterCategories<!--/a--></code>). All other filters attributes should be specified in the <code>customAttributes</code> method. (See <span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-SW1">“Write a Custom Attributes Method”</a></span>).</p><p>The filter name is the string for creating the haze removal filter when you want to use it. The constructor object specified implements the <code>filterWithName:</code> method (see <span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-BCIHDFBG">“Write a Method to Create Instances of the Filter”</a></span>). The filter class attributes are specified as an <code>NSDictionary</code> object. The display name—what you’d show in the user interface—for this filter is Haze Remover. </p><a name="//apple_ref/doc/uid/TP30001185-CH207-BCIBHFDA" title="Listing 3-6Registering a filter that is not part of an image unit"></a><p class="codesample"><strong>Listing 3-6&nbsp;&nbsp;</strong>Registering a filter that is not part of an image unit</p><div class="codesample"><table><tr><td scope="row"><pre>+ (void)initialize<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [CIFilter registerFilterName: @"MyHazeRemover"<span></span></pre></td></tr><tr><td scope="row"><pre>        constructor: self<span></span></pre></td></tr><tr><td scope="row"><pre>        classAttributes: [NSDictionary dictionaryWithObjectsAndKeys:<span></span></pre></td></tr><tr><td scope="row"><pre>             @"Haze Remover", kCIAttributeFilterDisplayName,<span></span></pre></td></tr><tr><td scope="row"><pre>             [NSArray arrayWithObjects:<span></span></pre></td></tr><tr><td scope="row"><pre>                kCICategoryColorAdjustment, kCICategoryVideo,<span></span></pre></td></tr><tr><td scope="row"><pre>                kCICategoryStillImage,kCICategoryInterlaced,<span></span></pre></td></tr><tr><td scope="row"><pre>                kCICategoryNonSquarePixels,nil], kCIAttributeFilterCategories,<span></span></pre></td></tr><tr><td scope="row"><pre>            nil]<span></span></pre></td></tr><tr><td scope="row"><pre>            ];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30001185-CH207-BCIHDFBG" title="Write a Method to Create Instances of the Filter"></a><h3>Write a Method to Create Instances of the Filter</h3><p>If you plan to use this filter only in your own application, then you’ll need to implement a <code>filterWithName:</code> method as described in this section. If you plan to package this filter as an image unit for use by third-party developers, then you can skip this section because your packaged filters can use the <code><a href="../../../Reference/QuartzCoreFramework/Classes/CIFilter_Class/Reference/Reference.html#//apple_ref/occ/clm/CIFilter/filterWithName:" target="_top">filterWithName:</a></code> method provided by the <code>CIFilter</code> class.</p><p>The <code>filterWithName:</code> method shown in <span class="content_text">Listing 3-7</span>  creates instances of the filter when they are requested.</p><a name="//apple_ref/doc/uid/TP30001185-CH207-BCIGHAIE" title="Listing 3-7A method that creates instance of a filter"></a><p class="codesample"><strong>Listing 3-7&nbsp;&nbsp;</strong>A method that creates instance of a filter</p><div class="codesample"><table><tr><td scope="row"><pre>+ (CIFilter *)filterWithName: (NSString *)name<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CIFilter  *filter;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    filter = [[self alloc] init];<span></span></pre></td></tr><tr><td scope="row"><pre>    return [filter autorelease];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>After you follow these steps to create a filter, you can use the filter in your own application. See <span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-CJBHDGAA">“Using Your Own Custom Filter”</a></span> for details. If you want to make a filter or set of filters available as a plug-in for other applications, see <span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-TPXREF101">“Creating Custom Filters.”</a></span></p><a name="//apple_ref/doc/uid/TP30001185-CH207-CJBHDGAA" title="Using Your Own Custom Filter"></a><h2>Using Your Own Custom Filter</h2><p>The procedure for using your own custom filter is the same as the procedure for using any filter provided by Core Image except that you must initialize the filter class. You initialize the haze removal filter class created in the last section with this line of code:</p><div class="codesample"><table><tr><td scope="row"><pre>[MyHazeFilter class];<span></span></pre></td></tr></table></div><p><span class="content_text">Listing 3-8</span> shows how to use the haze removal filter. Note the similarity between this code and the code discussed in <span class="content_text"><a href="../ci_tasks/ci_tasks.html#//apple_ref/doc/uid/TP30001185-CH203-BAJDDCEE">“Processing an Image.”</a></span></p><div class="notebox"><a name="//apple_ref/doc/uid/TP30001185-CH207-SW9" title="Note"></a><p><strong>Note:</strong>&nbsp;If you’ve packaged your filter as an image unit, you need to load it. See <span class="content_text"><a href="../ci_tasks/ci_tasks.html#//apple_ref/doc/uid/TP30001185-CH203-TPXREF101">“Using Core Image Filters”</a></span> for details.</p></div><a name="//apple_ref/doc/uid/TP30001185-CH207-CJBEAAAD" title="Listing 3-8Using your own custom filter"></a><p class="codesample"><strong>Listing 3-8&nbsp;&nbsp;</strong>Using your own custom filter</p><div class="codesample"><table><tr><td scope="row"><pre>- (void)drawRect: (NSRect)rect<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CGRect  cg = CGRectMake(NSMinX(rect), NSMinY(rect),<span></span></pre></td></tr><tr><td scope="row"><pre>                            NSWidth(rect), NSHeight(rect));<span></span></pre></td></tr><tr><td scope="row"><pre>    CIContext *context = [[NSGraphicsContext currentContext] CIContext];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if(filter == nil)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        NSURL       *url;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        [MyHazeFilter class];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        url = [NSURL fileURLWithPath: [[NSBundle mainBundle]<span></span></pre></td></tr><tr><td scope="row"><pre>                    pathForResource: @"CraterLake"  ofType: @"jpg"]];<span></span></pre></td></tr><tr><td scope="row"><pre>        filter   = [CIFilter filterWithName: @"MyHazeRemover"<span></span></pre></td></tr><tr><td scope="row"><pre>                    keysAndValues: @"inputImage",<span></span></pre></td></tr><tr><td scope="row"><pre>                    [CIImage imageWithContentsOfURL: url],<span></span></pre></td></tr><tr><td scope="row"><pre>                     @"inputColor",<span></span></pre></td></tr><tr><td scope="row"><pre>                    [CIColor colorWithRed:0.7 green:0.9 blue:1],<span></span></pre></td></tr><tr><td scope="row"><pre>                    nil];<span></span></pre></td></tr><tr><td scope="row"><pre>        [filter retain];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    [filter setValue: [NSNumber numberWithFloat: distance]<span></span></pre></td></tr><tr><td scope="row"><pre>        forKey: @"inputDistance"];<span></span></pre></td></tr><tr><td scope="row"><pre>    [filter setValue: [NSNumber numberWithFloat: slope]<span></span></pre></td></tr><tr><td scope="row"><pre>        forKey: @"inputSlope"];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    [context drawImage: [filter valueForKey: @"outputImage"]<span></span></pre></td></tr><tr><td scope="row"><pre>        atPoint: cg.origin  fromRect: cg];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30001185-CH207-CJBECAEC" title="Supplying an ROI Function"></a><h2>Supplying an ROI Function</h2><p>The region of interest, or ROI, defines the area in the source from which a sampler takes pixel information to provide to the kernel for processing. Recall from the <span class="content_text"><a href="../ci_concepts/ci_concepts.html#//apple_ref/doc/uid/TP30001185-CH202-BCIGEFIE">“The Region of Interest”</a></span> discussion in <span class="content_text"><a href="../ci_concepts/ci_concepts.html#//apple_ref/doc/uid/TP30001185-CH202-TPXREF101">“Core Image Concepts”</a></span> that the working space coordinates of the ROI and the domain of definition either coincide exactly, are dependent on one another, or not related. Core Image always assumes that the ROI and the domain of definition coincide. If that’s the case for the filter you write, then you don’t need to supply an ROI function. But if this assumption is not true for the filter you write, then you must supply an ROI function. Further, you can supply an ROI function only for CPU executable filters.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30001185-CH207-SW10" title="Note"></a><p><strong>Note:</strong>&nbsp; The ROI and domain of definition for a CPU nonexecutable filter must coincide. You can’t supply an ROI function for this type of filter. See <span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-CJBFHGGC">“Writing Nonexecutable Filters.”</a></span></p></div><p>The ROI function you supply calculates the region of interest for each sampler that is used by the kernel. Core Image invokes your ROI function, passing to it the sampler index, the extent of the region being rendered, and any data that is needed by your routine. The method signature must follow this form:</p><div class="codesample"><table><tr><td scope="row"><pre>- (CGRect) regionOf:(int)samplerIndex<span></span></pre></td></tr><tr><td scope="row"><pre>            destRect:(CGRect)r<span></span></pre></td></tr><tr><td scope="row"><pre>            userInfo:obj;<span></span></pre></td></tr></table></div><p>where </p><ul class="ul"><li class="li"><p><code>samplerIndex</code> specifies the sampler for which the method calculates the ROI</p></li><li class="li"><p><code>r</code> specifies the extent of the region</p></li><li class="li"><p><code>obj</code> specifies any data that’s needed by the routine. You can use the <code>obj</code> parameter to ensure that your ROI function gets the data that it needs, and that the data is correct (the filter’s instance variables might have changed).</p></li></ul><p>Core Image calls your routine for each pass through the filter. Your method calculates the ROI based on the rectangle and user information passed to it, and returns the ROI specified as a <code>CGRect</code> data type. </p><p>You register the ROI function by calling the <code>CIKernel</code> method <code><a href="../../../Reference/QuartzCoreFramework/Classes/CIKernel_Class/Reference/Reference.html#//apple_ref/occ/instm/CIKernel/setROISelector:" target="_top">setROISelector:</a></code>, supplying the ROI function as the <code>aMethod</code> argument. For example:</p><p>[<code>kernel setROISelector:@selector(regionOf:destRect:userInfo:)]</code></p><p>The next sections provide examples of ROI functions. </p><a name="//apple_ref/doc/uid/TP30001185-CH207-SW11" title="A Simple ROI Function "></a><h3>A Simple ROI Function </h3><p>If your ROI function does not require data to be passed to it in the <code>userInfo</code> parameter, then you don’t need to include that argument, as shown in <span class="content_text">Listing 3-9</span>. The code in the listing outsets the sampler by one pixel, which is a calculation used by an edge-finding filter or any 3X3 convolution.</p><a name="//apple_ref/doc/uid/TP30001185-CH207-CJBICHDB" title="Listing 3-9A simple ROI function"></a><p class="codesample"><strong>Listing 3-9&nbsp;&nbsp;</strong>A simple ROI function</p><div class="codesample"><table><tr><td scope="row"><pre>- (CGRect)regionOf:(int)samplerIndex destRect:(CGRect)r<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return CGRectInset(r, -1.0, -1.0);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Note that this function ignores the <code>samplerIndex</code> value. If your kernel uses only one sampler, then you can ignore the index. If your kernel uses more than one sampler, you must make sure that you return the ROI that’s appropriate for the specified sampler. You’ll see how to do that in the sections that follow. </p><a name="//apple_ref/doc/uid/TP30001185-CH207-SW12" title="An ROI Function for a Glass Distortion Filter"></a><h3>An ROI Function for a Glass Distortion Filter</h3><p><span class="content_text">Listing 3-10</span> show an ROI function for a glass distortion filter. This function returns an ROI for two samplers. Sampler <code>0</code> represents the image to distort and sampler <code>1</code> represents the texture used for the glass.</p><p>The function uses the <code>userInfo</code> parameter to supply the input scale that’s needed by sampler <code>0</code>. Notice that the distortion is outset by half of the supplied scale on all sides.</p><p>All of the glass texture (sampler <code>1</code>) needs to be referenced because the filter uses the texture as a rectangular pattern. As a result, the function returns an infinite rectangle as the ROI. An infinite rectangle is a convention that specifies to use all of a sampler. (The constant <code><!--a target="_top" -->CGRectInfinite<!--/a--></code> is defined in the Quartz 2D API.)</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30001185-CH207-SW13" title="Note"></a><p><strong>Note:</strong>&nbsp; If you use an infinite ROI make sure that the sampler’s domain of definition is not also infinite otherwise Core Image will not be able to render the image.</p></div><a name="//apple_ref/doc/uid/TP30001185-CH207-CJBCFECF" title="Listing 3-10An ROI function for a glass distortion filter"></a><p class="codesample"><strong>Listing 3-10&nbsp;&nbsp;</strong>An ROI function for a glass distortion filter</p><div class="codesample"><table><tr><td scope="row"><pre>- (CGRect)regionOf:(int)samplerIndex destRect:(CGRect)r userInfo:obj<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    float  s;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    s = [obj floatValue] * 0.5f;<span></span></pre></td></tr><tr><td scope="row"><pre>    if (samplerIndex == 0)<span></span></pre></td></tr><tr><td scope="row"><pre>        return CGRectInset(r, -s,-s);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return CGRectInfinite;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30001185-CH207-SW14" title="An ROI Function for an Environment Map"></a><h3>An ROI Function for an Environment Map</h3><p><span class="content_text">Listing 3-11</span> shows an ROI function that returns the ROI for a kernel that uses three samplers, one of which is an environment map. The ROI for sampler <code>0</code> and sampler <code>1</code> coincide with the domain of definition. For that reason, the code returns the <code>destination</code> rectangle passed to it for samplers other than sampler <code>2</code>. </p><p>Sampler <code>2</code> uses values passed in the <code>userInfo</code> parameter that specify the height and width of the environment map to create the rectangle that specifies the region of interest.</p><a name="//apple_ref/doc/uid/TP30001185-CH207-CJBDBJJA" title="Listing 3-11Supplying a routine the calculates the region of interest "></a><p class="codesample"><strong>Listing 3-11&nbsp;&nbsp;</strong>Supplying a routine the calculates the region of interest </p><div class="codesample"><table><tr><td scope="row"><pre>- (CGRect)regionOf:(int)samplerIndex<span></span></pre></td></tr><tr><td scope="row"><pre>            forRect:(CGRect)destination<span></span></pre></td></tr><tr><td scope="row"><pre>            userInfo:(NSArray *)myArray<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    if (samplerIndex == 2)<span></span></pre></td></tr><tr><td scope="row"><pre>        return CGRectMake (0, 0,<span></span></pre></td></tr><tr><td scope="row"><pre>                    [[myArray objectAtIndex:0] floatValue],<span></span></pre></td></tr><tr><td scope="row"><pre>                    [[myArray objectAtIndex:1] floatValue]);<span></span></pre></td></tr><tr><td scope="row"><pre>    return destination;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30001185-CH207-SW15" title="Specifying Sampler Order"></a><h3>Specifying Sampler Order</h3><p>As you saw from the previous examples, a sampler has an index associated with it. When you supply an ROI function, Core Image passes a sampler index to you. A sampler index is assigned on the basis of its order when passed to the <code>apply</code> method for the filter. You call <code>apply</code> from within the filter’s <code>outputImage</code> routine, as shown in <span class="content_text">Listing 3-12</span>.</p><p>In this listing, notice especially the numbered lines of code that set up the samplers and show how to provide them to the kernel. A detailed explanation for each of these lines appears following the listing.</p><a name="//apple_ref/doc/uid/TP30001185-CH207-CJBEDGAE" title="Listing 3-12An output image routine for a filter that uses an environment map"></a><p class="codesample"><strong>Listing 3-12&nbsp;&nbsp;</strong>An output image routine for a filter that uses an environment map</p><div class="codesample"><table><tr><td scope="row"><pre>- (CIImage *)outputImage<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    int i;<span></span></pre></td></tr><tr><td scope="row"><pre>    CISampler *src, *blur, *env;<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    CIVector *envscale;<span></span></pre></td></tr><tr><td scope="row"><pre>    CGSize size;<span></span></pre></td></tr><tr><td scope="row"><pre>    CIKernel *kernel;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    src = [CISampler samplerWithImage:inputImage];<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    blur = [CISampler samplerWithImage:inputHeightImage];<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    env = [CISampler samplerWithImage:inputEnvironmentMap];<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    size = [env extent].size;<span></span></pre></td></tr><tr><td scope="row"><pre>    envscale = [CIVector vectorWithX:[inputEMapWidth floatValue]<span></span></pre></td></tr><tr><td scope="row"><pre>                     Y:[inputEMapHeight floatValue]];<span></span></pre></td></tr><tr><td scope="row"><pre>    i = [inputKind intValue];<span></span></pre></td></tr><tr><td scope="row"><pre>    if ([inputHeightInAlpha boolValue])<span></span></pre></td></tr><tr><td scope="row"><pre>        i += 8;<span></span></pre></td></tr><tr><td scope="row"><pre>    kernel = [roundLayerKernels objectAtIndex:i];<span></span></pre></td></tr><tr><td scope="row"><pre>    [kernel setROISelector:@selector(regionOf:forRect:userInfo:)];<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>    NSArray *array  = [NSArray arrayWithObjects: inputEMapWidth,<span></span></pre></td></tr><tr><td scope="row"><pre>                         inputEMapHeight, nil];<span></span></pre></td></tr><tr><td scope="row"><pre>    return [self apply: kernel,src, blur, env, <span>// 6</span></pre></td></tr><tr><td scope="row"><pre>                    [NSNumber numberWithFloat:pow(10.0, [inputSurfaceScale<span></span></pre></td></tr><tr><td scope="row"><pre>                                            floatValue])],<span></span></pre></td></tr><tr><td scope="row"><pre>                    envscale,<span></span></pre></td></tr><tr><td scope="row"><pre>                    inputEMapOpacity,<span></span></pre></td></tr><tr><td scope="row"><pre>                    kCIApplyOptionDefinition,<span></span></pre></td></tr><tr><td scope="row"><pre>                    [src definition],<span></span></pre></td></tr><tr><td scope="row"><pre>                    kCIApplyOptionUserInfo,<span></span></pre></td></tr><tr><td scope="row"><pre>                    array,<span></span></pre></td></tr><tr><td scope="row"><pre>                    nil];<span></span></pre></td></tr><tr><td scope="row"><pre> }<span></span></pre></td></tr></table></div><ol class="ol"><li class="li"><p>Declares variables for each of the three samplers that are needed for the kernel.</p></li><li class="li"><p>Sets up a sampler for the input image. The ROI for this sampler coincides with the domain of definition.</p></li><li class="li"><p>Sets up a sampler for an image used for input height. The ROI for this sampler coincides with the domain of definition.</p></li><li class="li"><p>Sets up a sampler for an environment map. The ROI for this sampler does not coincide with the domain of definition, which means you must supply an ROI function.</p></li><li class="li"><p>Registers the ROI function with the kernel that needs to use it.</p></li><li class="li"><p>Applies arguments to a kernel to produce a Core Image image (<code>CIImage</code> object). The supplied arguments must be type compatible with the function signature of the kernel function (which is not shown here, but assume they are type compatible). The list of arguments is terminated by <code>nil</code>, as required.</p><p>The order of the sampler arguments determine its index. The first sampler supplied to the kernel is index <code>0</code>. In this case, that’s the <code>src</code> sampler. The second sampler supplied to the kernel—<code>blur</code>— is assigned index <code>1</code>. The third sampler—<code>env</code>—is assigned index <code>2</code>. It’s important to check your ROI function to make sure that you provide the appropriate ROI for each sampler.</p></li></ol><a name="//apple_ref/doc/uid/TP30001185-CH207-CJBFHGGC" title="Writing Nonexecutable Filters"></a><h2>Writing Nonexecutable Filters</h2><p>A filter that is CPU nonexecutable is guaranteed to be secure. Because this type of filter runs only on the GPU, it cannot engage in virus or trojan horse activity or other malicious behavior. To guarantee security, CPU nonexecutable filters have these restrictions:</p><ul class="ul"><li class="li"><p>This type of filter is a pure kernel, meaning that it is fully contained in a <code>.cikernel</code> file. As such, it doesn’t have a filter class and is restricted in the types of processing it can provide. Sampling instructions of the following form are the only types of sampling instructions that are valid for a nonexecutable filter:</p><p><code>color = sample (someSrc, samplerCoord(someSrc));</code></p></li><li class="li"><p>CPU nonexecutable filters must be packaged as part of an image unit.</p></li><li class="li"><p>Core Image assumes that the ROI coincides with the domain of definition. This means that nonexecutable filters are not suited for such effects as blur or distortion.</p></li></ul><p>The CIDemoImageUnit sample installed with the developer tools in Developer > Examples > Quartz > Core Image contains a nonexecutable filter in the <code>MyKernelFilter.cikernel</code> file. When the image unit is loaded, the MyKernelFilter filter will get loaded along with the FunHouseMirror filter that’s also in the image unit. FunHouseMirror, however, is an executable filter. It has an Objective-C portion as well as a kernel portion.</p><p>When you write a nonexecutable filter, you need to provide all filter attributes in the <code>Descriptions.plist</code> file for the image unit bundle. <span class="content_text">Listing 3-13</span> shows the attributes for the MyKernelFilter in the CIDemoImageUnit sample. </p><a name="//apple_ref/doc/uid/TP30001185-CH207-SW6" title="Listing 3-13The property list for the MyKernelFilter nonexecutable filter"></a><p class="codesample"><strong>Listing 3-13&nbsp;&nbsp;</strong>The property list for the MyKernelFilter nonexecutable filter</p><div class="codesample"><table><tr><td scope="row"><pre>&lt;key>MyKernelFilter&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>        &lt;dict><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>CIFilterAttributes&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;dict><span></span></pre></td></tr><tr><td scope="row"><pre>                &lt;key>CIAttributeFilterCategories&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                &lt;array><span></span></pre></td></tr><tr><td scope="row"><pre>                    &lt;string>CICategoryStylize&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>                    &lt;string>CICategoryVideo&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>                    &lt;string>CICategoryStillImage&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>                &lt;/array><span></span></pre></td></tr><tr><td scope="row"><pre>                &lt;key>CIAttributeFilterDisplayName&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                &lt;string>MyKernelFilter&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>                &lt;key>CIInputs&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                &lt;array><span></span></pre></td></tr><tr><td scope="row"><pre>                    &lt;dict><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;string>CIImage&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeDisplayName&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;string>inputImage&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeName&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;string>inputImage&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>                    &lt;/dict><span></span></pre></td></tr><tr><td scope="row"><pre>                    &lt;dict><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;string>NSNumber&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeDefault&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;real>8&lt;/real><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeDisplayName&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;string>inputScale&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeIdentity&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;real>8&lt;/real><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeMin&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;real>1&lt;/real><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeName&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;string>inputScale&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeSliderMax&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;real>16&lt;/real><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeSliderMin&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;real>1&lt;/real><span></span></pre></td></tr><tr><td scope="row"><pre>                    &lt;/dict><span></span></pre></td></tr><tr><td scope="row"><pre>                    &lt;dict><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;string>NSNumber&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeDefault&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;real>1.2&lt;/real><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeDisplayName&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;string> inputGreenWeight &lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeIdentity&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;real>1.2&lt;/real><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeMin&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;real>1&lt;/real><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeName&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;string>inputGreenWeight&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeSliderMax&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;real>3.0&lt;/real><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;key>CIAttributeSliderMin&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>                        &lt;real>1&lt;/real><span></span></pre></td></tr><tr><td scope="row"><pre>                    &lt;/dict><span></span></pre></td></tr><tr><td scope="row"><pre>                &lt;/array><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;/dict><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>CIFilterClass&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;string>MyKernelFilter&lt;/string><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>CIHasCustomInterface&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;false/><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;key>CIKernelFile&lt;/key><span></span></pre></td></tr><tr><td scope="row"><pre>            &lt;string>MyKernelFilter&lt;/string><span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30001185-CH207-SW5" title="Kernel Routine Examples"></a><h2>Kernel Routine Examples</h2><p>The essence of any image processing filter is the kernel that performs the pixel calculations. The code listings in this section show some typical kernel routines for these filters: brighten, multiply, and hole distortion. By looking at these you can get an idea of how to write your own kernel routine. Note, however, that these routines are examples. Don’t assume that the code shown here is what Core Image uses for the filters it supplies. </p><p>Before you write your own kernel routine, you may want to read <span class="content_text"><a href="ci_custom_filters.html#//apple_ref/doc/uid/TP30001185-CH207-BCIHEJJI">“Expressing Image Processing Operations in Core Image”</a></span> to see which operations pose a challenge in Core Image. You’ll also want to take a look at <em><a href="../../../Reference/CIKernelLangRef/index.html#//apple_ref/doc/uid/TP40004397" target="_top">Core Image Kernel Language Reference</a></em>.</p><p>You can find in-depth information on writing kernels as well as more examples in <em><a href="../../ImageUnitTutorial/index.html#//apple_ref/doc/uid/TP40004531" target="_top">Image Unit Tutorial</a></em>.</p><a name="//apple_ref/doc/uid/TP30001185-CH207-BCIJEDGE" title="Computing a Brightening Effect"></a><h3>Computing a Brightening Effect</h3><p><span class="content_text">Listing 3-14</span> computes a brightening effect. A detailed explanation for each numbered line of code appears following the listing.</p><a name="//apple_ref/doc/uid/TP30001185-CH207-BAJECFID" title="Listing 3-14A kernel routine that computes a brightening effect"></a><p class="codesample"><strong>Listing 3-14&nbsp;&nbsp;</strong>A kernel routine that computes a brightening effect</p><div class="codesample"><table><tr><td scope="row"><pre>kernel vec4 brightenEffect (sampler src, float k)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>  vec4 currentSource;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>  currentSource = sample (src, samplerCoord (src)); <span>// 1</span></pre></td></tr><tr><td scope="row"><pre>  currentSource.rgb = currentSource.rgb + k * currentSource.a; <span>// 2</span></pre></td></tr><tr><td scope="row"><pre>  return currentSource; <span>// 3</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here what the code does:</p><ol class="ol"><li class="li"><p>Looks up the source pixel in the sampler that is associated with the current output position.</p></li><li class="li"><p>Adds a bias to the pixel value. The bias is <code>k</code> scaled by the alpha value of the pixel to make sure the pixel value is premultiplied.</p></li><li class="li"><p>Returns the changed pixel.</p></li></ol><a name="//apple_ref/doc/uid/TP30001185-CH207-SW16" title="Computing a Multiply Effect"></a><h3>Computing a Multiply Effect</h3><p><span class="content_text">Listing 3-15</span> shows a kernel routine that computes a multiply effect. The code looks up the source pixel in the sampler and then multiplies it by the value passed to the routine.</p><a name="//apple_ref/doc/uid/TP30001185-CH207-BAJGGFAG" title="Listing 3-15A kernel routine that computes a multiply effect"></a><p class="codesample"><strong>Listing 3-15&nbsp;&nbsp;</strong>A kernel routine that computes a multiply effect</p><div class="codesample"><table><tr><td scope="row"><pre>kernel vec4 multiplyEffect (sampler src, __color mul)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>  return sample (src, samplerCoord (src)) * mul;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30001185-CH207-SW4" title="Computing a Hole Distortion"></a><h3>Computing a Hole Distortion</h3><p><span class="content_text">Listing 3-16</span> shows a kernel routine that computes a hole distortion. Note that there are many ways to compute a hole distortion. A detailed explanation for each numbered line of code appears following the listing.</p><a name="//apple_ref/doc/uid/TP30001185-CH207-BAJCFAFE" title="Listing 3-16A kernel routine that computes a hole distortion"></a><p class="codesample"><strong>Listing 3-16&nbsp;&nbsp;</strong>A kernel routine that computes a hole distortion</p><div class="codesample"><table><tr><td scope="row"><pre>kernel vec4 holeDistortion (sampler src, vec2 center, vec2 params) <span>// 1</span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>  vec2 t1;<span></span></pre></td></tr><tr><td scope="row"><pre>  float distance0, distance1;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>  t1 = destCoord () - center; <span>// 2</span></pre></td></tr><tr><td scope="row"><pre>  distance0 = dot (t1, t1); <span>// 3</span></pre></td></tr><tr><td scope="row"><pre>  t1 = t1 * inversesqrt (distance0);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>  distance0 = distance0 * inversesqrt (distance0) * params.x;<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>  distance1 = distance0 - (1.0 / distance0); <span>// 6</span></pre></td></tr><tr><td scope="row"><pre>  distance0 = (distance0 &lt; 1.0 ? 0.0 : distance1) * params.y;<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>  t1 = t1 * distance0 + center; <span>// 8</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>  return sample (src, samplerTransform (src, t1)); <span>// 9</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here what the code does:</p><ol class="ol"><li class="li"><p>Take three parameters—a sampler, a vector that specifies the center of the hole distortion, and the <code>params</code> vector, which contains (<code>1/radius</code>, <code>radius</code>).</p></li><li class="li"><p>Creates the vector <code>t1</code> from the center to the current working coordinates.</p></li><li class="li"><p>Squares the distance from the center and assigns the value to the <code>distance0</code> variable.</p></li><li class="li"><p>Normalizes <code>t1</code>. (Makes <code>t1</code> a unit vector.)</p></li><li class="li"><p>Computes the parametric distance from the center <code>(distance squared * 1/distance) * 1/radius</code>. This value is 0 at the center and 1 where the distance is equal to the radius.</p></li><li class="li"><p>Creates a hole with the appropriate distortion around it. (<code>x – 1/sqrt (x)</code>)</p></li><li class="li"><p>Makes sure that all pixels within the hole map from the pixel at the center, then scales up the distorted distance function by the radius.</p></li><li class="li"><p>Scales the vector to create the distortion and then adds the center back in.</p></li><li class="li"><p>Returns the distorted sample from the source texture.</p></li></ol>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../ci_tasks/ci_tasks.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../ci_image_units/ci_image_units.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2004, 2008 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2008-06-09<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/GraphicsImaging/Conceptual/CoreImaging/ci_custom_filters/ci_custom_filters.html%3Fid%3DTP30001185-4.3&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/GraphicsImaging/Conceptual/CoreImaging/ci_custom_filters/ci_custom_filters.html%3Fid%3DTP30001185-4.3&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/GraphicsImaging/Conceptual/CoreImaging/ci_custom_filters/ci_custom_filters.html%3Fid%3DTP30001185-4.3&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>