<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"            "http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note ME11: Using a PurgeProc</title><meta name="keywords" content="Mac OS 8 Memory Manager purgeProc installing handles"><meta name="Description" content="Technical Note ME11: This Technical Note discusses the useof the purgeProc field of an application's heap zone. Itexplains what a purgeProc is, how to install a purgeProc,and the benefits and dangers of using a purgeProc."><meta name="categories" content="Memory"><meta name="week-posted" content="Jul 29, 1991 - Aug 2, 1991"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"><a name="//apple_ref/doc/uid/DTS10002537" title="Using a PurgeProc"></a><a name="top"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/idxAppleHardware-date.html" target="_blank">Hardware & Drivers > Apple Hardware</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note ME11</div>
<div id="pageheadsub">Using a PurgeProc</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Section1">Introduction</a><BR><BR>  <A HREF="#Section2">Conclusion</a><BR><BR>  <A HREF="#References">References</A><BR><BR> <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">This Technical Note discusses the use of the <code>purgeProc</code> field of an application's heap zone.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Aug 01 1989]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><a name="Section1"></a><h2>Introduction</h2><p>Most applications will never need to use a <code>purgeProc</code>. However, if yourapplication requires the ability to maintain purgeable handles containing data,or you need to have special notification when a certain handle is purged, apurgeProc might help you.</p><h3>What exactly is a purgeProc?</h3><p>The purgeProc, which is documented in very briefly in<i>Inside Macintosh</i>,Volume 2, page 2-23, is the mechanism which allows the Memory Manager to alertyour application that it is getting ready to purge a given purgeable handle.This warning is given so that you can save the data, or note for any specialreason that the data no longer exists. The <code>purgeProc</code> is passed the handle thatis being purged.  It is up to you to determine if any action should be taken onthe handle. The Pascal interface to the <code>purgeProc</code> looks something like this:</p><p><code>PROCEDURE MyPurgeProc ( theHandle:Handle );</code></p><p>In C it would look like this:</p><p><code>pascal void myPurgeProc(Handle theHandle);</code></p><p>Each zone has its own <code>purgeProc</code> pointer in its zone header. Each time theMemory Manager prepares to purge a handle, it checks the zone header of thezone that the handle belongs to, to determine if your application has installeda purgeProc. If this field is not NIL, it calls the routine pointed to with thehandle being purged. This occurs for each handle being purged (not everypurgeable handle necessarily). When your routine is called, test the handlepassed to be sure that it is a handle you care about, and then act on it. Keepin mind that all handles that pass through your <code>purgeProc</code> may not be expected,since your application can create purgeable handles in a few ways, like calling<code>_HPurge</code> on an existing handle, or loading a resource (the resource could havethe purgeable attribute set), or by calling a routine that could load a resource.</p><h3>Installing a purgeProc</h3><p>You install your own <code>purgeProc</code> by setting the field in your zone header. Hereis a sample routine that installs a <code>purgeProc</code>:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>PROCEDURE InstallProc;VAR    myZone:THz;BEGIN    myZone:=GetZone; { recover my applications zone }    gOldProc:=myZone^.purgeProc; { save the old purgeProc }    myZone^.purgeProc:=@myPurgeProc;END;</pre>	</TD></TR></TABLE></CENTER><p>You must be sure to follow these rules regarding what a purge proc must, can, and cannot do.</p><ul type="disc">	<li><p>Do not rely on <code>A5</code> being set properly to your application's globals. (See <u><A HREF = "../ov/ov_10.html">Technical Note #208</a></u>.)</p><BR><BR></li>	<li><p>Do not cause memory to be moved or purged.</p><BR><BR></li>	<li><p>Do not open a file (but you can write to an already open file).</p><BR><BR></li>	<li><p>Do not dispose of or change the purge status of the passed handle.</p><BR><BR></li>	<li><p>Only use <code>purgeProcs</code> when absolutely needed.</p><BR><BR></li>	<li><p>Avoid using <code>purgeProcs</code> if you are also using the <code>SetResPurge(true)</code> feature.</p><BR><BR></li>	<li><p>Do write any data to a data file synchronously.</p><BR><BR></li>	<li><p>Do preserve the contents of all registers except A0-A2/D0/D1.</p><BR><BR></li>	<li><p>Do use the <code>FindFolder</code> feature of System 7 to locate the temporary folder on the user's hard disk if you are creating a temporary file to hold the contents of purged handles.</p><BR><BR></li>	<li><p>Do test the handle state first to determine if the handle belongs to the Resource Manager, to weed out most handle purges you do not care about</p><BR><BR></li>	<li><p>Do not take too long to determine if the passed handle is in need of purge notification (many programmers do not realize just how many purgeable handles come and go, or how often their purgeProc might be called for a single new handle).</p><BR><BR></li></ul><p>Here is a pseudo code sample that illustrates one possible use of the purgewarning procedure: saving the contents of the handle to a file before purging.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>Procedure PurgeWarning(theHandle:myHType);begin  SetUpApplicationA5;     { see Inside Mac and Technotes for how to do this }  IF BAND(hGetState(theHandle),$20)=0 then    BEGIN {If we get here the handle does not belong to a resource}      IF InSaveList(theHandle) then WriteData(theHandle);    END;  RestoreOldA5;END;</pre>	</TD></TR></TABLE></CENTER><p>Remember, the save file should probably be open at this point because opening afile can cause memory to move. You will have to maintain a save list toindicate purgeable handles that need saving.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>If you plan to use the <code>SetResPurge(true)</code> option that allows you to modify purgeable resources (not a normal thing for an application to do), don't patch the <code>purgeProc</code> pointer. If you do, remove your <code>purgeProc</code>, call <code>SetResPurge</code>, then re-install the <code>purgeProc</code>, being sure that it calls through to the Resource Manager's routine after it is finished.</p></TD></TR></TABLE></CENTER><BR><P><A HREF="#top">Back to top</A></P> <a name="Section2"></a><h2>Conclusion</h2><p><code>PurgeProcs</code> can be used when an application needs to better manage low memorysituations, and easily take advantage of large memory conditions. Be verycareful when using them, however, keeping in mind that you are in the middle ofa Memory Manager routine when you are being called, and you may be called often.</p><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><p><i>Inside Macintosh</i>, Volume II, Memory Manager chapter</p><p>Technical Note M.OV.A5 -- <u><A HREF = "../ov/ov_10.html">Setting and Restoring A5</a></u></p><p><i>Inside Macintosh</i>, Volume VI, Finder Interface chapter (FindFolder)</p>  <P><A HREF="#top">Back to top</A></P>                           <P><A NAME=Downloads></A></P>                  <h2>Downloadables</h2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (38K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/me_11.pdf">Download</A></P>               </TD>            </TR>                     </TABLE>         <BR>                  <P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/me/me_11.html%3Fid%3DDTS10002537-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/me/me_11.html%3Fid%3DDTS10002537-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/me/me_11.html%3Fid%3DDTS10002537-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>