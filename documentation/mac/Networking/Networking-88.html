<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Getting a List of Zone Names for Your Local Network  or Its Internet(IM:N)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING88></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Networking-87.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-89.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Networking-2.html"><B>Networking</B></A> / <BR><DD><A HREF="Networking-84.html"><B>Chapter 4 - Zone Information Protocol (ZIP)</B></A> / <A HREF="Networking-86.html"><B>Using ZIP</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING88-0></A>
<H2>Getting a List of Zone Names for Your Local Network <BR>or Its Internet</H2>
 If your <A NAME=MARKER-2-97></A>application is running on a node that belongs to an <A NAME=MARKER-2-147></A>extended network, the <A NAME=MARKER-2-204></A>application can use the <A NAME=MARKER-9-71></A><CODE>GetLocalZones</CODE> function to obtain a list of the names of the zones in its node's local network. An application running on a node that belongs to an extended network can also use the <A NAME=MARKER-2-78></A><CODE>GetZoneList</CODE> function to obtain a list of the names of the zones throughout the <A NAME=MARKER-2-199></A>AppleTalk internet to which its node's local network belongs. These functions behave similarly. <P>
 ZIP returns a single ATP response per request. Because the complete list of zone <BR>names may not fit in a single ATP response, you need to make repeated calls to either <CODE>GetLocalZones</CODE> or <CODE>GetZoneList</CODE> until you receive all of the zone names. You must allocate a buffer to hold the zone names data that the ZIP function returns and point <BR>to that buffer from the function's <CODE>zipBuffPtr</CODE> parameter block field. This buffer must be 578 bytes in size, large enough to hold an entire ATP response. ZIP returns the zone names into this buffer as a packed array of packed Pascal strings.<P>
 The <CODE>zipNumZones</CODE> field returns the actual number of zone names that ZIP placed in the buffer. You must set the <CODE>zipLastFlag</CODE> field to 0 before you execute the <CODE>GetZoneList</CODE> or <CODE>GetLocalZones</CODE> function. If the <CODE>zipLastFlag</CODE> parameter is still 0 when the command has completed execution, then ZIP is waiting to return more zone names. In this case you must empty the buffer, or allocate a new one, and call the <CODE>GetZoneList</CODE> or <CODE>GetLocalZones</CODE> function again immediately. When there are no more zone names to return, ZIP sets the <CODE>zipLastFlag</CODE> field to a nonzero value. The <CODE>zipInfoField</CODE> field is a 70-byte data buffer that you must allocate for use by ZIP. The first time you call any of these functions, you must set the first word of this field to 0. You must not change any values in this field subsequently.<P>
 <A HREF=#MARKER-9-36>Listing 4-2</A> shows the application-defined <CODE>DoGetZoneList</CODE> function, which illustrates how to use the <CODE>GetZoneList</CODE> function. The <CODE>GetLocalZones</CODE> function operates in exactly the same fashion. <P>
 This <CODE>DoGetZoneList</CODE> function allocates a buffer for zone names and repeatedly calls the <CODE>GetZoneList</CODE> function to get a list of zone names. If <CODE>GetZoneList</CODE> returns a function result of <CODE>noErr</CODE>, then the <CODE>DoGetZoneList</CODE> code calls the application-defined <CODE>MyZIPExtract</CODE> function, shown in <A HREF=#MARKER-9-38>Listing 4-3</A>, to remove a zone name from the <CODE>GetZoneList</CODE> buffer and place it in the application's buffer. The <CODE>DoGetZoneList</CODE> code in <A HREF=#MARKER-9-36>Listing 4-2</A> does not show the application-defined <CODE>MyAddToZoneList</CODE> that writes the zone name to the application's buffer.<CODE> </CODE><P>
<B>Listing 4-2  <A NAME=MARKER-9-36></A>Using <CODE>GetZoneList</CODE> to retrieve names of zones throughout the AppleTalk internet</B><P>
<PRE>
FUNCTION DoGetZoneList: OSErr;
CONST
   kZoneBufferSize = 578;              {required size of zone list buffer}
VAR
   xppPB: XPPParamBlock;
   result: OSErr;
   zoneBuffer: Ptr;
   index: Integer;
   zoneName: Str32;
BEGIN
      {Allocate buffer for returned zone names.}
   zoneBuffer := NewPtr(kZoneBufferSize);
   IF zoneBuffer = NIL THEN
      result := MemError
   ELSE
   BEGIN
      WITH xppPB DO
      BEGIN
         xppTimeout := 3;              {timeout interval}
         xppRetry := 4;                {retry count}
         zipBuffPtr := zoneBuffer;     {zone names returned here}
         zipLastFlag := 0;             {set to 0 first time through}
         zipInfoField[1] := 0;         {first word of zipInfoField must be }
         zipInfoField[2] := 0;         { initialized to 0 the first time}
      END;

      {Loop to get all of the zone names.}
      REPEAT
         result := GetZoneList(@xppPB, FALSE);
         IF (result = noErr) THEN
            FOR index := 1 TO xppPB.zipNumZones DO
               IF MyZIPExtract(zoneBuffer, xppPB.zipNumZones, index, 
                            zoneName) = noErr THEN
                  MyAddToZoneList(zoneName);
      UNTIL (xppPB.zipLastFlag &lt;&gt; 0) OR (result &lt;&gt; noErr);
      DisposPtr(zoneBuffer);           {release memory}
   END;
   DoGetZoneList := result;
END;
</PRE>
 When you call the <CODE>GetZoneList</CODE> function or the <CODE>GetLocalZones</CODE> function to obtain a list of zone names, ZIP returns the zone names as a packed array of packed Pascal strings. Your application must include a routine to extract the zone names that you want from the buffer. <P>
 <A HREF=#MARKER-9-38>Listing 4-3</A> shows an application-defined function called <CODE>MyZipExtract</CODE> that extracts <BR>a particular zone name from the buffer of packed zone names returned by either <CODE>GetZoneList</CODE> or <CODE>GetLocalZones</CODE>. <P>
 The <CODE>MyZipExtract</CODE> function takes a <CODE>numInBuf</CODE> input parameter that specifies the number of zone names in the buffer pointed to by the <CODE>theBuffer</CODE> parameter. For the <CODE>numInBuf</CODE> parameter, you specify the value that ZIP returned in the <CODE>zipNumZones</CODE> field of the XPP parameter block used for the <CODE>GetZoneList</CODE> or <CODE>GetLocalZones</CODE> function. <P>
 You use the <CODE>whichOne</CODE> input parameter to identify the zone name to extract. The <CODE>MyZIPExtract</CODE> function returns the zone name in the <CODE>zoneName</CODE> string parameter. <P>
 The <CODE>MyZIPExtract</CODE> function returns a result of <CODE>paramErr</CODE> if <CODE>whichOne</CODE> is 0 or <CODE>whichOn</CODE>e is greater than the number of zones in the buffer. Otherwise, the function returns a function result of <CODE>noErr</CODE>. <A NAME=MARKER-9-148></A><P>
<B>Listing 4-3  <A NAME=MARKER-9-38></A>Extracting a zone name from the list of zone names returned in the buffer</B><P>
<PRE>
FUNCTION MyZIPExtract (theBuffer: Ptr; numInBuf: Integer; whichOne: Integer;
                     VAR zoneName: Str32): OSErr;
VAR
   result: OSErr;
   zonePtr: Ptr;
BEGIN
   {preflight the input parameters}
   IF (whichOne = 0) OR (whichOne &gt; numInBuf) THEN
      result := paramErr
   ELSE
   BEGIN
      zonePtr := theBuffer;
      {Look for whichOne}
      REPEAT
         whichOne := whichOne - 1;
         IF whichOne &lt;&gt; 0 THEN
               {move pointer to next zone name}
            zonePtr := Ptr(ORD4(zonePtr) + 
               Length(StringPtr(zonePtr)^) + 1);
      UNTIL whichOne = 0;
               {return the zone name}
      BlockMove(zonePtr, @zoneName, 
               Length(StringPtr(zonePtr)^) + 1);
      result := noErr;
   END;
   MyZIPExtract := result;
END;
</PRE>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Networking-87.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-89.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Networking-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
