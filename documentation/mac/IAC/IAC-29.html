<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Saving a Document Containing Sections(IM:IC)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING29></A>



<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="IAC-28.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="IAC-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="IAC-529.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="IAC-30.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="IAC-2.html"><B>Interapplication Communication</B></A> / <BR><DD><A HREF="IAC-23.html"><B>Chapter 2 - Edition Manager</B></A> / <A HREF="IAC-26.html"><B>Using the Edition Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING29-0></A>
<H2><A NAME=MARKER-21-108></A>Saving a Document Containing Sections</H2>
 When saving a document that contains sections, you should write out each section record as a resource of type <CODE>'sect'</CODE> and write out each alias record as a resource of type <CODE>'alis'</CODE> with the same ID as the section record. See the chapter "Resource Manager" in <I><A HREF="../MoreToolbox/MoreToolbox-2.html">Inside Macintosh: More Macintosh Toolbox</A></I> for detailed information on resources. <A NAME=MARKER-21-232></A><A NAME=MARKER-2-224></A><A NAME=MARKER-2-235></A><A NAME=MARKER-2-359></A><A NAME=MARKER-21-360></A><P>
 If a user closes a document that contains newly created publishers without attempting to save its contents, you should display an alert box similar to the one shown in <A HREF=#MARKER-9-115>Figure 2-10</A>.<A NAME=MARKER-2-114></A><P>
<B>Figure 2-10  <A NAME=MARKER-9-115></A><A NAME=MARKER-21-116></A>The new publisher alert box</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/ED-S-10.gif"><P>
 If you keep the section records and alias records for each publisher and subscriber as resources, you can use the <CODE>ChangedResource</CODE> or <CODE>WriteResource</CODE> function. If you detach the section records and alias records from each section, you need to clone the handles and use the <CODE>AddResource</CODE> function. See the chapter "Resource Manager" in <I><A HREF="../MoreToolbox/MoreToolbox-2.html">Inside Macintosh: More Macintosh Toolbox</A></I> for detailed information on the <CODE>ChangedResource</CODE>, <CODE>WriteResource</CODE>, and <CODE>AddResource</CODE> functions.<P>
 Use the <CODE>PBExchangeFiles</CODE> function to ensure that the file ID remains the same each time you save a document that contains sections. Saving a file typically involves creating a new file (with a temporary name), writing data to it, closing it, and then deleting the original file that you are replacing. You rename the temporary file with the original filename, which leads to a new file ID. The <CODE>PBExchangeFiles</CODE> function swaps the contents of the two files (even if they are open) by getting both catalog entries and swapping the allocation pointers. If the files are open, the file control block (FCB) is updated so that the reference numbers still access the same contents (under a new name). See <I><A HREF="../Files/Files-2.html">Inside Macintosh: Files</A></I> for detailed information on the <CODE>PBExchangeFiles</CODE> function.<P>
 <A HREF=#MARKER-9-119>Listing 2-2</A> illustrates how to save a file that contains sections. If the contents of a publisher have changed since the last save, the application-defined procedure <CODE>MySaveDocument</CODE> writes the publisher's data to its edition. It then writes out to the saved document the section records and alias records of all publishers and subscribers. <CODE>MySaveDocument</CODE> calls another application-defined routine, <CODE>MyGetSectionAliasPair</CODE>, to return a handle and resource ID to a section. As described earlier, you should write out the eligible section records and alias records as resources to allow for future compatibility. There are several different techniques for saving or adding resources; this listing illustrates one technique. The section handles are still valid after using the <CODE>AddResource</CODE> function because this listing illustrates just saving, not closing, the file.<P>
 Before you write out sections, you need to see if any publisher sections share the same control block. Publishers that share the same control block share the same edition.<P>
 If a user creates an identical copy of a file by choosing Save As from the File menu and does not make any changes to this new file, you simply use the <CODE>AssociateSection</CODE> function to indicate to the Edition Manager which document a section is located in.<A NAME=MARKER-2-554></A><A NAME=MARKER-9-463></A><P>
<B>Listing 2-2  <A NAME=MARKER-9-119></A><A NAME=MARKER-21-120></A>Saving a document containing sections</B><P>
<PRE>
PROCEDURE MySaveDocument(thisDocument: MyDocumentInfoPtr;
                         numberOfSections: Integer);
VAR
   aSectionH:        SectionHandle;
   copiedSectionH:   Handle;
   copiedAliasH:     Handle;
   resID:            Integer;
   thisone:          Integer;
   myErr:            OSErr;
BEGIN
   FOR thisone := 1 TO numberOfSections DO
   BEGIN
      aSectionH := MyGetSectionAliasPair(thisDocument, thisone, 
                                         resID);
      IF (aSectionH^^.kind = stPublisher) &amp;
         (aSectionH^^.mode = pumOnSave) &amp;
         (MyCheckForDataChanged(aSectionH)) THEN
         DoWriteEdition(aSectionH);
   END; {end of for}
   {set the curResFile to the resource fork of thisDocument}
   UseResFile(thisDocument^.resForkRefNum);
   {write all section and alias records to the document}
   FOR thisone := 1 TO numberOfSections DO
   BEGIN
      {given an index, get the next section handle and resID }
      { from your internal list of sections for this file}
      aSectionH := MyGetSectionAliasPair(thisDocument, thisone, 
                                         resID);
      {check for duplication of control block values}
      MyCheckForDupes(thisDocument, numberOfSections);
      {save section record to disk}
      copiedSectionH := Handle(aSectionH);
      myErr := HandToHand(copiedSectionH);
      AddResource(copiedSectionH, rSectionType, resID, '');
      {save alias record to disk}
      copiedAliasH := Handle(aSectionH^^.alias);
      myErr := HandToHand(copiedAliasH);
      AddResource(copiedSectionH, rAliasType, resID, '');
   END; {end of for}
   {write rest of document to disk}
END; 
</PRE>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="IAC-28.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="IAC-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="IAC-529.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="IAC-30.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="IAC-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
