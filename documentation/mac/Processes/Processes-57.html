<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>The Extended Time Manager (IM: Pr)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING57></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Processes-56.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Processes-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Processes-171.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Processes-58.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html"><B>Inside Macintosh:</B></A> <A HREF="Processes-2.html"><B>Processes</B></A><BR><DD><A HREF="Processes-53.html"><B>Chapter 3 - Time Manager</B></A> / <A HREF="Processes-54.html"><B>About the Time Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING57-0></A>
<H2>The Extended Time Manager</H2>
 <A NAME=MARKER-2-52></A>The extended Time Manager (available with system software version 7.0 and later) contains all the features of earlier Time Managers, with several extensions intended primarily to provide <B>drift-free, fixed-frequency</B> timing services. These services, which ensure that a routine is executed promptly after a specified delay, are important for sound and multimedia applications requiring precise timing and real-time synchronization among different events.<A NAME=MARKER-2-24></A><A NAME=MARKER-2-8></A><P>
 In the original and revised Time Managers, the value passed to <CODE>PrimeTime</CODE> indicates a delay that is relative to the current time (that is, the time when you execute <CODE>PrimeTime</CODE>). This presents problems if you attempt to implement a fixed-frequency timing service by having the task call <CODE>PrimeTime</CODE>. The problem is that the time consumed by the Time Manager and by any interrupt latency (which is not predictable) causes the task to be called at a slightly slower and unpredictable frequency, which drifts over time. In <BR><A HREF=#MARKER-9-57>Figure 3-1</A>, the desired fixed frequency of 1000 microseconds cannot be achieved because the Time Manager overhead and interrupt latency cause a small and unpredictable delay each time the task is reactivated.<A NAME=MARKER-2-80></A><A NAME=MARKER-2-153></A><P>
<B>Figure 3-1  <A NAME=MARKER-9-57></A><A NAME=MARKER-21-58></A>Original and revised Time Managers (drifting, unpredictable frequency)</B><P>
<BR>
<BR>
<IMG SRC="graphics/TM-01.jpg"><P>
 The extended Time Manager solves this problem by allowing you to reinstall a task with an execution time that is relative to the time when the task last expired--not relative to the time when the task is reinstalled. The extended Time Manager compensates for the delay between the time when the task last expired and the time at which it was reinstalled, thereby providing a truly drift-free, fixed-frequency timing service.<P>
 <A NAME=MARKER-2-59></A>For example, if your application needs to execute a routine periodically at 1-millisecond intervals, it can reactivate the existing Time Manager queue element by calling <CODE>PrimeTime</CODE> in the task with a specified delay of 1 millisecond. When the Time Manager receives this new execution request, it determines how long ago the previous <CODE>PrimeTime</CODE> task expired and then decrements the specified delay by that amount. For instance, if the previous task expired 100 microseconds ago, then the Time Manager installs the new task with a delay of 900 microseconds. This technique is illustrated in <A HREF=#MARKER-9-60>Figure 3-2</A>.<P>
<B>Figure 3-2  <A NAME=MARKER-9-60></A><A NAME=MARKER-21-61></A>The extended Time Manager (drift-free, fixed frequency)</B><P>
<BR>
<BR>
<IMG SRC="graphics/TM-02.jpg"><P>
 The extended Time Manager implements these features by recognizing an expanded task record and providing a new procedure, <CODE>InsXTime</CODE>. The Time Manager task record for the extended Time Manager looks like this:<A NAME=MARKER-2-92></A><DFN><A NAME=MARKER-2-63></A><A NAME=MARKER-9-97></A></DFN><P>
<PRE>
TYPE TMTask =        {extended Time Manager task record}
   RECORD 
      qLink:         QElemPtr;   {next queue entry}
      qType:         Integer;    {queue type}
      tmAddr:        ProcPtr;    {pointer to task}
      tmCount:       LongInt;    {unused time}
      tmWakeUp:      LongInt;    {wakeup time}
      tmReserved:    LongInt;    {reserved for future use}
   END;
</PRE>
 Once again, your application fills in the <CODE>tmAddr</CODE> field. You should set <CODE>tmWakeUp</CODE> and <CODE>tmReserved</CODE> to 0 when you first install an extended Time Manager task. The remaining fields are used internally by the Time Manager. As in the revised Time Manager, the <CODE>tmCount</CODE> field holds the time remaining until the scheduled execution of the task (this field is set by <CODE>RmvTime</CODE>).<P>
 The <CODE>tmWakeUp</CODE> field contains the time at which the Time Manager task specified by <CODE>tmAddr</CODE> was last executed (or 0 if it has not yet been executed). Its principal intended use is to provide drift-free, fixed-frequency timing services, which are available only when you use the extended Time Manager and only when you install Time Manager tasks by calling the new <CODE>InsXTime</CODE> procedure.<P>
 When your application installs an extended Time Manager task (by calling the <CODE>InsXTime</CODE> procedure), the behavior of the <CODE>PrimeTime</CODE> procedure changes slightly, as described earlier in this section. If the value of the <CODE>tmWakeUp</CODE> field is zero when <CODE>PrimeTime</CODE> is called, the delay parameter to <CODE>PrimeTime</CODE> is interpreted as relative to the current time (just as in the original Time Manager), but the Time Manager sets the <CODE>tmWakeUp</CODE> field to a nonzero value that indicates when the delay time should expire. When your application calls <CODE>PrimeTime</CODE> with a Time Manager task whose <CODE>tmWakeUp</CODE> field contains a nonzero value, the Time Manager interprets the specified delay as relative to the time that the last call to <CODE>PrimeTime</CODE> on this task was supposed to expire.<A NAME=MARKER-2-55></A><A NAME=MARKER-2-5></A><P>
<DL>
<DT><B>Note</B>
<DD>Nonzero values in <CODE>tmWakeUp</CODE> are in a format that is used internally by the Time Manager. This format is subject to change. Your application should never use the value stored in this field and should either set it to 0 or leave it unchanged. When you first create an extended Time Manager task record, make sure that the value of the <CODE>tmWakeUp</CODE> field is 0; otherwise, the Time Manager may interpret it as a prior execution time.<B></B>  <B>&#183;</B>
</DL>
 The extended Time Manager allows for a previously impossible situation that may lead to undesirable results. It is possible to call <CODE>PrimeTime</CODE> with an execution time that is in the past instead of in the future. (In the original and revised Time Managers, only future execution times are possible.) This situation arises when the value of the <CODE>tmWakeUp</CODE> field specifies a time in the past and you issue a new <CODE>PrimeTime</CODE> request with a delay value that is not large enough to cause the execution time to be in the future. This may occur when fixed, high-frequency execution is required and the time needed to process each execution, including the Time Manager overhead, is greater than the delay time between requests.<P>
 When your application issues a <CODE>PrimeTime</CODE> request with a <CODE>tmWakeUp</CODE> value that would result in a negative delay, the actual delay time is set to 0. The Time Manager updates the <CODE>tmWakeUp</CODE> field to indicate the time when the task should have been performed (in the past). Because the actual delay time is set to 0, the task is executed immediately. If your application continually issues <CODE>PrimeTime</CODE> requests for times in the past, the Time Manager and the <CODE>tmAddr</CODE> tasks consume all of the processor cycles. As a result, no time is left for the application to run. Because this situation is a function of processor speed, you should ensure compatibility by using the slowest processors to test applications that use extended Time Manager features. Another solution to this problem is to vary the wakeup frequency according to the processing power of the computer.<A NAME=MARKER-2-47></A><P>
</BLOCKQUOTE><P>
<HR>
<center>
<A HREF="Processes-56.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Processes-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Processes-171.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Processes-58.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Processes-3.html">&copy; Apple Computer, Inc.</A><br>17 JUN 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
