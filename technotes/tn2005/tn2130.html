<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html><head>
<!-- BEGIN META TAG INFO -->
<link rel="home" href="http://developer.apple.com/">
<link rel="find" href="http://developer.apple.com/search/">
<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
<script language="JavaScript" type="text/javascript" src="../../documentation/js/busnav.js"></script>
<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<!-- END META TAG INFO -->
<!-- BEGIN TITLE -->
<title>Technical Note TN2130: Memory Allocation Recommendations on Mac OS X</title>
<!-- END TITLE -->
</head>
<!-- BEGIN BODY OPEN -->
<body bgcolor="#ffffff"><a name="//apple_ref/doc/uid/DTS10003484" title="Memory Allocation Recommendations on Mac OS X"></a>
<!--END BODY OPEN -->
<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->
<a name="top"></a>
<!-- BEGIN LOGO AND SEARCH -->
<!--#include virtual="/includes/adcnavbar"-->
<!-- END LOGO AND SEARCH -->
<!-- START BREADCRUMB -->
<div id="breadcrumb"><table width="680" border="0" cellpadding="0" cellspacing="0"><tr>
<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
<td><img width="340" height="10" src="images/1dot.gif" alt=""></td></tr><tr valign="middle"><td align="left" colspan="2">
<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/Carbon/index.html">Carbon</a> &gt; <a href="../../technicalnotes/Carbon/idxPerformance-date.html">Performance</a> &gt; 
</td></tr><tr><td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td></tr></table></div>
<!-- END BREADCRUMB -->

<!-- START MAIN CONTENT -->
<!-- START TITLE GRAPHIC AND INTRO-->
<table width="680" border="0" cellpadding="0" cellspacing="0"><tr align="left" valign="top">
<td><h1>
<div id="pagehead">Technical Note TN2130</div>
<div id="pageheadsub">Memory Allocation Recommendations on Mac OS X</div>
</h1></td></tr></table>
<!-- END TITLE GRAPHIC AND INTRO -->
<!-- BEGIN WIDE COLUMN -->
<table width="680" border="0" cellpadding="0" cellspacing="0"><tr align="left" valign="top"><td align="left" width="680">
<!-- BEGIN CONTENTS -->
<table width="680" border="0" cellpadding="0" cellspacing="0"><tr align="left" valign="top"><td><p>This Technical Note is aimed at Carbon Application Developers to help them decide which, out of the multiple memory allocation APIs, is the one the most appropriate for the situation.</p></td></tr><tr><td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br><img height="1" width="680" src="images/1dot_919699.gif" alt=""><br><img width="680" height="20" src="images/1dot.gif" alt=""></td></tr></table><table width="680" border="0" cellpadding="0" cellspacing="0"><tr align="left" valign="top"><td width="680"><ul><li><a href="#TNTAG1">Introduction</a></li><li><a href="#TNTAG2">Legacy and Deprecated APIs</a></li><li><a href="#TNTAG3">Current APIs</a><ul><li><a href="#TNTAG4">Core Foundation</a></li><li><a href="#TNTAG5">Macintosh Memory Manager</a></li><li><a href="#TNTAG6">Standard C Library</a></li></ul></li><li><a href="#TNTAG8">Moving and Setting bytes</a></li><li><a href="#TNTAG9">Summary</a></li><li><a href="#TNTAG11">Reference Section</a></li><li><a href="#TNT_HISTORY_TAG">Document Revision History</a></li></ul></td></tr><tr><td colspan="3" scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br><img height="1" width="680" src="images/1dot_919699.gif" alt=""><br><img width="680" height="20" src="images/1dot.gif" alt=""></td></tr></table><A NAME="TNTAG1"></A><H2>Introduction</H2><p>A lot of Carbon APIs allocate memory to create specific items, for example, <code>HIObjectCreate</code>, <code>CreateNewWindow</code>, <code>NewGWorld</code>. Since there is usually only one API to create/allocate a specific item, there is little choice, thus little doubt as to which API is the best to use in each case.</p><p>But when it comes to allocating blocks of memory for general use, for example, pixel data for image processing, arrays of numeric values for number crunching, or character buffers for text processing, there are many Carbon APIs which could be used for that purpose.</p><p>With choice comes confusion and the possibility of choosing a sub-optimal API for a particular job.</p><p>Furthermore, the optimal APIs for Mac OS X are not the same as those which were optimal in Mac OS 9 and earlier releases. Thus, developers who have a lot of legacy code should check this code for possible improvements.</p><p><a href="#top">Back to Top</a>&nbsp;<a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p><A NAME="TNTAG2"></A><H2>Legacy and Deprecated APIs</H2><p>Open Transport provided the memory allocation function <code>OTAllocMem</code> [<code>void * OTAllocMem(OTByteCount size)</code>] in the Universal Interfaces in Mac OS 9 and earlier. When Carbon was introduced, <code>OTAllocMem</code> was replaced by <code>OTAllocMemInContext</code> [<code>void * OTAllocMemInContext(OTByteCount size, OTClientContextPtr clientContext)</code>]. Since Open Transport, as a whole, has been deprecated, there is no reason to use <code>OTAllocMemInContext</code> other than if you still have to support Mac OS 8 or Mac OS 9. Use <code>OTFreeMem</code> to deallocate the allocated memory, you cannot resize the allocated memory.</p><p>Multiprocessing Services provided the memory allocation function <code>MPAllocate</code> [<code>LogicalAddress MPAllocate(ByteCount size)</code>], while this function is still available, it is marked as deprecated and not recommended. Since version 2.0, Multiprocessing Services provides <code>MPAllocateAligned</code> [<code>LogicalAddress MPAllocateAligned(ByteCount size, UInt8 alignment, OptionBits options)</code>] which has always been available in Carbon. Use <code>MPFree</code> to deallocate the allocate memory, you cannot resize the allocated memory.</p><p>Most of the specific alignments provided by <code>MPAllocateAligned</code> have ceased to be useful, except for the 16-byte boundary alignment required by Altivec code.</p><p>Since <code><code>malloc</code></code> aligns all its allocations on 16-byte boundaries more efficiently than <code>MPAllocateAligned</code> does, the memory-related APIs of the Multiprocessing Services have been deprecated, and so you should not use <code>MPAllocateAligned</code>.</p><p>The Macintosh Memory Manager provides six functions related to virtual memory management as it was handled on Mac OS 8 and 9. All those six functions are available but do strictly nothing when called on Mac OS X from version 10.0 to version 10.3. It is unlikely that they will ever be doing anything in a later release since the virtual memory management of Mac OS X is very different from its predecessor. Those six functions are <code>ReleaseMemoryData</code>, <code>MakeMemoryNonResident</code>, <code>MakeMemoryResident</code>, <code>FlushMemory</code>, <code>HoldMemory</code>, and <code>UnholdMemory</code>.</p><p>The Macintosh Memory Manager also provides seven functions which handle memory in the global address space instead of within the application heap on Mac OS 8 and 9. These seven functions are available on Mac OS X but function no differently than their application heap counterparts. Thus <code>TempNewHandle</code> is the same as <code><code>NewHandle</code></code>, <code>TempMaxMem</code> is the same as <code>MaxMem</code>, <code>TempFreeMem</code> is the same as <code>FreeMem</code>, <code>TempHLock</code> is the same as <code>HLock</code>, <code>TempHUnlock</code> is the same as <code>HUnlock</code>, <code>TempDisposeHandle</code> is the same as <code>DisposeHandle</code>, and <code>TempTopMem</code> is the same as <code>TopMem</code>. It is also noteworthy to mention that <code>FreeMem</code> always return a hard-coded value of, currently, 20 * 1024 * 1024, that <code>MaxMem</code> returns the same value, that <code>TopMem</code> always returns <code>NULL</code>, and that <code>CompactMem</code> does nothing else but return the value you passed as its parameter.</p><p><a href="#top">Back to Top</a>&nbsp;<a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p><A NAME="TNTAG3"></A><H2>Current APIs</H2><A NAME="TNTAG4"></A><H3>Core Foundation</H3><p>Core Foundation provides in CFBase.h the memory allocation function <code>CFAllocatorAllocate</code> [<code>void *CFAllocatorAllocate(CFAllocatorRef allocator, CFIndex size, CFOptionFlags hint)</code>]. This function is thread safe.</p><p>The main reason for using <code>CFAllocatorAllocate</code> instead of another memory allocation API is that you can choose the <code>CFAllocatorRef</code> the most appropriate for the situation. It can be just the default <code>CFAllocatorRef</code> (<code>kCFAllocatorDefault</code>), but you can also use any of the other provided <code>CFAllocatorRef</code> (<code>kCFAllocatorSystemDefault</code>, <code>kCFAllocatorMalloc</code>, <code>kCFAllocatorNull</code>, <code>kCFAllocatorUseContext</code>) or create your own with <code>CFAllocatorCreate</code> (in very rare situations).</p><p>You can also, in a library, use <code>kCFAllocatorDefault</code> and then you will work with whatever <code>CFAllocatorRef</code> was set as a default by the main application.</p><p>Use <code>CFAllocatorDeallocate</code> to deallocate the allocate memory, you can use <code>CFAllocatorReallocate</code> to resize the allocated memory.</p><p><a href="#top">Back to Top</a>&nbsp;<a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p><A NAME="TNTAG5"></A><H3>Macintosh Memory Manager</H3><p>The Macintosh Memory Manager provides in MacMemory.h the four memory allocation functions <code>NewPtr</code>, <code>NewPtrClear</code>, <code><code>NewHandle</code></code>, and <code>NewHandleClear</code>. All those functions are thread-safe starting with Mac OS X v10.3 but not in previous versions. On Mac OS X, those four functions eventually call the C library function <code><code>malloc</code></code> with a thin overhead.</p><p>Use <code>DisposePtr</code> to deallocate the memory allocated by <code>NewPtr</code> or <code>NewPtrClear</code> and you can use <code>SetPtrSize</code> to resize the allocated memory (beware, even on Mac OS X, <code>SetPtrSize</code> may fail).</p><p>Use <code>DisposeHandle</code> to deallocate the memory allocated by <code><code>NewHandle</code></code> or <code>NewHandleClear</code> and you can use <code>SetHandleSize</code> to resize the allocated memory.</p><p>There is no performance advantage to calling <code>NewPtr</code> instead of <code><code>malloc</code></code>, or <code>NewPtrClear</code> instead of <code>calloc</code>. This is the reverse of what was true on Mac OS 8 and 9 where <code><code>malloc</code></code> was eventually calling <code>NewPtr</code> in some C runtimes.</p><p>Carbon APIs use specific handles less and less, either because the technology has been or is being deprecated; a better, modern replacement has been introduced; or specific handles have been converted in opaque references. See the tables below for some examples; since Carbon APIs rely on handles less and less as new versions of Mac OS X are released, these table lists are not exhaustive and the best way to know whether you should or should not use a specific handle is to look at the comments of its declaration in its header file.</p><p class="smalltext"><strong>Table 1:</strong> Technologies which are or are being deprecated.</p><table cellspacing="0" class="graybox"><tr><th>Technology</th><th>Types (not exhaustive)</th></tr><tr><td scope="row">QuickDraw</td><td><code>PixMapHandle</code>, <code>CTabHandle</code>, <code>PicHandle</code>, <code>PaletteHandle</code></td></tr><tr><td scope="row">TextEdit</td><td><code>TEHandle</code>, <code>TextStyleHandle</code>, <code>CharsHandle</code>, <code>STHandle</code></td></tr></table><p class="smalltext"><strong>Table 2:</strong> Technologies which have a modern replacement.</p><table cellspacing="0" class="graybox"><tr><th>Technology</th><th>Types (not exhaustive)</th><th>Modern Technology</th></tr><tr><td scope="row">Sound Manager</td><td><code>SndHandle</code>, <code>SndListHandle</code>, <code>Snd2ListHandle</code></td><td>CoreAudio</td></tr><tr><td scope="row">File Translation</td><td><code>FileTranslationSpecArrayHandle</code>, <code>FileTranslationListHandle</code>, <code>ScrapTranslationListHandle</code></td><td>Translation Services</td></tr></table><p class="smalltext"><strong>Table 3:</strong> Specific Handles obsoleted by a modern replacement.</p><table cellspacing="0" class="graybox"><tr><th>Specific Handles</th><th>Modern Replacement</th></tr><tr><td scope="row"><code>ListHandle</code> (using the List control)</td><td>DataBrowser control</td></tr><tr><td scope="row"><code>NavTypeListHandle</code> (Navigation Services)</td><td>Use a filter function, use <code>LSCanRefAcceptItem</code> (Launch Services)</td></tr><tr><td scope="row"><code>CIconHandle</code>, <code>IconFamilyHandle</code></td><td><code>IconRef</code></td></tr><tr><td scope="row"><code>ControlHandle</code></td><td><code>ControlRef</code></td></tr><tr><td scope="row"><code>MenuHandle</code></td><td><code>MenuRef</code></td></tr></table><p class="smalltext"><strong>Table 4:</strong> Specific Handles still in use.</p><table cellspacing="0" class="graybox"><tr><th>Specific Handles</th><th>Note</th></tr><tr><td scope="row"><code>RgnHandle</code></td><td><code>HIShapeRef</code> will replace <code>RgnHandle</code> as the <code>HIShape</code> technology evolves</td></tr><tr><td scope="row"><code>AliasHandle</code></td><td>The Alias Manager is evolving to deal with the type <code>AliasRecord</code> *</td></tr></table><p>It is still inadvisable to fake handles, that is to use a pointer on a pointer to a memory block, and use them as parameters in Carbon APIs. If the Carbon API attempts to call <code>GetHandleSize</code> or <code>SetHandleSize</code>, then unexpected consequences will follow.</p><p><a href="#top">Back to Top</a>&nbsp;<a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p><A NAME="TNTAG6"></A><H3>Standard C Library</H3><p>The Standard C Library provides the memory allocation functions <code><code>malloc</code></code>, <code>calloc</code> (which clears the memory block), and <code>valloc</code> (which aligns the memory block on a virtual memory page boundary).</p><p><code><code>malloc</code></code> and <code>calloc</code> align their allocations on 16-byte boundaries.</p><p>All these functions are thread-safe. Use <code>free</code> to deallocate the allocate memory, you can use <code>realloc</code> to safely resize the allocated memory.</p><p>Apple Engineers spent a long time making <code><code>malloc</code></code> the most efficient memory allocation function. Use <code><code>malloc</code></code> (or <code>calloc</code>) preferably to any other memory allocation function.</p><div class="notebox"><p><strong>Note:</strong> When debugging in Xcode, you may use GuardMalloc. That actually means that you are using libgmalloc which modifies the behavior of <code><code>malloc</code></code> and <code>calloc</code>. libgmalloc alignes the end of the allocated block with the end of a page. Thus, if you need 16-byte aligned allocations, you may need to pad your structures or arrays to a multiple of 16 when debugging with GuardMalloc.</p></div><p><a href="#top">Back to Top</a>&nbsp;<a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p><A NAME="TNTAG8"></A><H2>Moving and Setting bytes</H2><p>After allocating memory, it is common to move bytes around. There are many functions which can do the job. Fortunately, it is easier to determine which API should be used almost exclusively.</p><p>Prefer <code>BlockMoveData</code> or <code>BlockMoveDataUncached</code> to <code>BlockMove</code>, but anyway, these functions eventually call <code>memmove</code>, so...</p><p>For copying bytes from one location to another, use <code>memmove</code> or <code>bcopy</code> which are thread-safe and check for overlaps.</p><p>On shipping releases of Mac OS X, <code>memcpy</code> also checks for overlaps, but the IEEE specification does not require that check, so behavior on other platforms is undefined, so use it with caution.</p><p>In some situations, rather than calling <code>memmove</code>, you can use a tight loop or let the compiler generate the code for moving bytes if the size of the transfer is known at compilation time. In most other situations, use <code>memmove</code>.</p><p>Rather than allocating a new block of memory, you may want to reuse instead previously allocated memory. In that case, it is common to zero that memory before using it. We recommend that you use <code>bzero</code> or <code>memset</code> rather than <code>BlockZero</code> to do so.</p><p><a href="#top">Back to Top</a>&nbsp;<a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p><A NAME="TNTAG9"></A><H2>Summary</H2><p>Do not use <code>OTAllocMem</code> or <code>OTAllocMemInContext</code>.</p><p>Do not use <code>MPAllocate</code> or <code>MPAllocateAligned</code>.</p><p>Do not use <code>TempNewHandle</code>.</p><p>Use <code>NewPtr</code> or <code><code>NewHandle</code></code> only in legacy code that you didn't optimize yet. Do not use them in new code.</p><p><code>CFAllocatorAllocate</code> should be rarely used.</p><div class="notebox"><p><strong>IMPORTANT:</strong> Use <code><code>malloc</code></code> or <code>calloc</code> almost exclusively.</p></div><p><a href="#top">Back to Top</a>&nbsp;<a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p><A NAME="TNTAG11"></A><H2>Reference Section</H2><p><A HREF="../../documentation/Performance/Conceptual/ManagingMemory/Tasks/MemoryAlloc.html">Optimizing Your Memory Allocations</A>.</p><p><A HREF="../tn/tn1174.html">Optimization Strategies for Mac OS</A>.</p><p><A HREF="../../qa/qa2001/qa1259.html">Memory Management Edge Cases</A>.</p><p><A HREF="../../documentation/Performance/Conceptual/ManagingMemory/index.html">Memory Management in Mac OS X</A>.</p><p><A HREF="x-man-page://3/malloc"><code><code>malloc</code></code>(3) and <code>calloc</code>(3) man documentation</A></p><p><a href="#top">Back to Top</a>&nbsp;<a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p><A NAME="TNT_HISTORY_TAG"></A><H2>Document Revision History</H2><table cellspacing="0" class="graybox" width="680"><tr><th width="100">Date</th><th width="580">Notes</th></tr><tr><td scope="row">2005-07-12</td><td>Added a reference to malloc man documentation.</td></tr><tr><td scope="row">2005-05-24</td><td>GuardMalloc information added.</td></tr><tr><td scope="row">2005-04-07</td><td>Recommends the best ways to allocate memory on Mac OS X.</td></tr></table><p><b>Posted:</b> 2005-07-12</p>
<!-- END CONTENTS -->
</td></tr></table>
<!-- END WIDE COLUMN -->
<!-- END MAIN CONTENT -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn2005/tn2130.html%3Fid%3DDTS10003484-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn2005/tn2130.html%3Fid%3DDTS10003484-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn2005/tn2130.html%3Fid%3DDTS10003484-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

<!-- START BOTTOM APPLE NAVIGATION -->
<!--#include virtual="/includes/footer"-->
<!-- END BOTTOM APPLE NAVIGATION -->
<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->
</body></html>