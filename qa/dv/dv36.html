<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!--Template 06-20-02--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Q&amp;A DV36: MemAllocatePhysicallyContiguous</title>			<meta name="keywords" content="Mac OS 8 MemAllocatePhysicallyContiguous">	<meta name="Description" content="Technical Q&amp;A DV36: Q&amp;A describes how to allocate physicallycontiguous memory"><meta name="categories" content="Devices"><meta name="week-posted" content="Aug 23, 1999 - Aug 27, 1999"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10001177" title="MemAllocatePhysicallyContiguous"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalqas/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/index.html" target="_blank">Reference Library > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A DV36</div>
<div id="pageheadsub">MemAllocatePhysicallyContiguous</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><!-- begin_content --> <CENTER><TABLE BORDER=0 CELLPADDING=0 WIDTH=600>  <TR> <td align="left"><hr width=500 align=center> <p id=p2>Q: My driver needs to allocate physically contiguous         memory. I'm calling         <CODE>MemAllocatePhysicallyContiguous</CODE> but it returns         <CODE>nil</CODE>, even though the system has plenty of free         memory. What can I do?</P>                  <P id=p4>A: <CODE>MemAllocatePhysicallyContiguous</CODE> uses a         very naive algorithm to find physically contiguous memory.         The gist of the algorithm is shown below.</P>                 <TABLE BORDER=0 CELLPADDING=5 WIDTH=550>             <TR>               <td bgcolor="#e6e6e6" align=left>                  <pre>on MemAllocatePhysicallyContiguous size    result = NewPtrSys(size)    if result != nil then        if LockMemoryContiguous(result, size) != noErr then            previousResult = result;            result = NewPtrSys(size)            if result != nil then                if LockMemoryContiguous(result, size) != noErr then                    DisposePtr(result)                    result = nil;                end-if            end-if            DisposePtr(previousResult)        end-if    end-if    return resultend MemAllocatePhysicallyContiguous</pre>               </TD></TR>         </TABLE>                  <TABLE BORDER=0 CELLPADDING=5 WIDTH=550> <TR> <td bgcolor="#e6e6e6" align=left>                  <p id=p4><B>Note:</B><BR>                                    The above pseudo-code is a rough description of the                  <CODE>MemAllocatePhysicallyContiguous</CODE>                  algorithm. The actual code is more complex, partly                  because the buffer returned by                  <CODE>MemAllocatePhysicallyContiguous</CODE> is                  always page-aligned.</p>               </TD></TR>         </TABLE><BR>                  <P id=p4>This algorithm is not particularly smart about finding         physically contiguous memory. Specifically, the algorithm         only makes two attempts to find a physically contiguous         block. If both attempts fail,         <CODE>MemAllocatePhysicallyContiguous</CODE> gives up and         returns an error. There may be plenty of memory, there may         even be plenty of physically contiguous memory, but         <CODE>MemAllocatePhysicallyContiguous</CODE> won't find it.         </P>                  <P id=p4>There are a number factors that determine whether the         <CODE><a href="../../documentation/mac/Memory/Memory-164.html">LockMemoryContiguous</A></CODE>         call used by <CODE>MemAllocatePhysicallyContiguous</CODE>         succeeds.</P>                  <UL>            <LI><p id=p4>Before VM loads, the relationship between logical and            physical addresses is relatively simple. Typically there            is a direct map between logical and physical addresses.            However, this is not always true.</p>                        <UL>               <LI><p id=p4><a href="../../technotes/tn/tn1167.html">ROM-in-RAM</A>               computers have a number of discontinuities in the               logical-to-physical mapping because of the way the               system transitions from Open Firmware to Mac OS, and               how the system loads the Mac OS ROM file into memory.               For more background on this issue, see DTS Q&amp;A DV               33 <A HREF="dv33.html"><CODE>PrepareMemoryForIO</CODE> in the NewWorld</A>.</p></li>                              <LI><p id=p4>These discontinuities are not a new thing.               Historically, computers such as the Mac IIci used the               Memory Management Unit to &#147;stitch&#148; together               banks of RAM that are discontiguous in the physical               address space.</p></li>            </UL>                        <P id=p4>Your driver may encounter these discontinuities at            boot time, depending on the hardware platform, the RAM            configuration, the time your driver loads, and the amount            of memory consumed by other drivers that loaded before            you.</P></li>                        <LI><p id=p4>After VM loads, the relationship between logical and            physical addresses quickly becomes scrambled.</p></li>                        <LI><p id=p4>The ROM contains a primitive version of            <CODE>LockMemoryContiguous</CODE> that simply checks            whether the memory is physically contiguous and returns            <CODE>cannotMakeContiguousErr</CODE> if it isn't. If you            try to get physically contiguous memory before VM loads            (or at any time on a system with VM disabled), you will            use this version of <CODE>LockMemoryContiguous</CODE>.</p></li>                        <LI><p id=p4>The Virtual Memory Manager re-implements            <CODE>LockMemoryContiguous</CODE> with a somewhat smarter            algorithm. If VM is enabled and you try to get physically            contiguous memory after VM loads, this new algorithm will            work harder to find a physically contiguous range of            memory. However, a request for a large block of            physically contiguous memory is still likely to fail.</p></li>         </UL>                  <P id=p4>In summary, the ability of the system to provide         physically contiguous memory is extremely limited, and         extremely sensitive to environmental factors.</P>                  <P id=p4>That&#146;s the bad news. The good news is that you can do         things to work around this limitation:</P>                  <UL>            <LI><p id=p4>Smaller Memory Allocations&#151;The smaller the            memory allocation, the greater chance that it will be            physically contiguous. [In the limiting case, it is            always possible to allocate one page of physically            contiguous memory.] Allocating one huge physically            contiguous block is the worst case scenario. You may be            able to restructure your driver to use a number of            smaller blocks.</p></li>                        <LI><p id=p4>Early Memory Allocation&#151;The earlier you load,            the more likely that you can allocate physically            contiguous memory. Some drivers defer memory allocation            until they are opened, and then fail to get physically            contiguous memory at that time. To prevent this, you can            allocate your memory early in the startup process by            marking your driver with the            <CODE>kDriverIsLoadedUponDiscovery</CODE> flag. You can            then use the pre-allocated memory when your driver is            opened.</p></li>                        <LI><p id=p4>Deferred Memory Allocation&#151;When you can't            allocate memory at startup time, you can try again later,            either when your driver is opened, or when it is tickled            by some other service that loads later in the startup            process. This deferred allocation may succeed because of            VM&#146;s improved <CODE>LockMemoryContiguous</CODE>            algorithm.</p></li>                        <LI><p id=p4>Scatter/Gather&#151;Most DMA hardware supports a            scatter/gather mechanism. [Scatter/gather hardware is a            requirement on OS&#146;s which provide no way to allocate            physically contiguous memory.] Many developers are            reticent to enable scatter/gather because it is less            efficient (it typically consumes PCI bus cycles fetching            the descriptors) and harder to program. However,            scatter/gather is the ultimate solution to            <CODE>MemAllocatePhysicallyContiguous</CODE> returning            <CODE>nil</CODE>.</p></li>         </UL>                  <P id=p4>You will get best results by using a combination of these         techniques. If your card gains significant performance         benefits from using physically contiguous memory, you should         try to allocate that memory using the techniques described         above. If all your attempts to allocate physically         contiguous memory fail, you should ultimately be prepared to         enable the scatter/gather mode on your hardware.</P></td></tr></table></CENTER><!-- end_content --><!-- begin_date --><H4 ALIGN=center>[Aug 23 1999]</H4><!-- end_date --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/dv/dv36.html%3Fid%3DDTS10001177-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/dv/dv36.html%3Fid%3DDTS10001177-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/dv/dv36.html%3Fid%3DDTS10001177-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --> <hr width=500 align=center> </BODY> </HTML>