<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Registering Your Entity With NBP(IM:N)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING64></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Networking-63.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-65.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Networking-2.html"><B>Networking</B></A> / <BR><DD><A HREF="Networking-61.html"><B>Chapter 3 - Name-Binding Protocol (NBP)</B></A> / <A HREF="Networking-63.html"><B>Using NBP</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING64-0></A>
<H2><A NAME=MARKER-9-24></A>Registering Your Entity With NBP</H2>
 <A NAME=MARKER-2-50></A>You register your entity with NBP to make its services available to other entities <A NAME=MARKER-2-2></A>through-<BR>out the network. Once the entity is registered, other entities can look up its name and address pair based on its name or a part of that name. <P>
 Your process can register itself with several names all associated with the same socket.<P>
 To register itself, your entity calls two NBP routines:<P>
<UL>
<LI>the set names table entry (<A NAME=MARKER-2-84></A><CODE>NBPSetNTE</CODE>) procedure, which prepares the names <BR>table entry
<LI>the register name <A NAME=MARKER-2-87></A>(<CODE>PRegisterName</CODE>) function, which provides NBP with a pointer to the names table entry so that NBP can register the entry on the node<P>
</UL>
<A NAME=HEADING64-6></A>
<H3>Setting Up a Names Table Entry</H3>
 <A NAME=MARKER-2-31></A>The <CODE>NBPSetNTE</CODE> procedure creates a names table entry in the format that <A HREF=#MARKER-9-36>Figure 3-4 on page 3-8</A> shows. You associate an NBP entity name with the socket number assigned to your entity. <P>
 <A NAME=MARKER-2-157></A>When you create the names table entry, you provide NBP with the socket number that your entity uses. This is the socket ID that was assigned to your entity when it opened <BR>a socket. <A NAME=MARKER-2-156></A><P>
 <A HREF=#MARKER-9-32>Figure 3-3</A> shows a complete internet socket address belonging to an entity and the entity name that is associated with the address. <P>
<B>Figure 3-3  <A NAME=MARKER-9-32></A>The internet socket address and entity name of an application </B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/NBP-L-01.jpg"><P>
 Along with the individual fields of the name and the socket number, you pass<CODE> NBPSetNTE</CODE> a pointer to a <A NAME=MARKER-2-68></A>buffer that is 108 bytes long. You create a record of type <CODE>NamesTableEntry</CODE> as the buffer to be used for the names table entry. When you <BR>register your entity, NBP uses the buffer that you pass it as the actual names table entry for that entity; it does not make a copy of the buffer. NBP links the <CODE>NamesTableEntry</CODE> record that you provide to other names table entries on the node to create a names <BR>table for that node. For this reason, memory that you allocate for the buffer must be nonrelocatable. <P>
 <A HREF=#MARKER-9-36>Figure 3-4</A> shows the structure of the names table entry record. <P>
 Notice <A NAME=MARKER-2-156></A>that the first field in the <CODE>NamesTableEntry</CODE> record is a pointer to the next entry in the linked list. NBP maintains the value of this field. You do not supply this value. However, you can get a pointer to the first entry in the names table on the node <BR>where the entity is running by calling the <CODE>PGetAppleTalkInfo</CODE> function. For informa-<BR>tion about the <CODE>PGetAppleTalkInfo</CODE> function, see the chapter "AppleTalk Utilities" in this book. <P>
<B>Figure 3-4  <A NAME=MARKER-9-36></A>Names table entry record format</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/NBP-L-03.jpg"><P>
<A NAME=HEADING64-17></A>
<H3><A NAME=MARKER-9-37></A>Registering a Names Table Entry</H3>
 <A NAME=MARKER-2-34></A>After you create the names table entry using <CODE>NBPSetNTE</CODE>, you register it by calling the <CODE>PRegisterName</CODE> function. When you call <CODE>PRegisterName</CODE>, NBP fills in the network number and node ID for the names table entry; because these values are the same for all entities on the node, you do not need to supply them. <P>
 Before you call the <CODE>PRegisterName</CODE> function, you must supply values for the function's parameter block input fields. These fields are <CODE>interval</CODE>, <CODE>count</CODE>, <CODE>entityPtr</CODE>, and <CODE>verifyFlag</CODE>. If you execute the function asynchronously, you must also supply a value for the <CODE>ioCompletion</CODE> field. After you call the <CODE>PRegisterName</CODE> function, you must not alter the contents of the parameter block until the function completes execution, and you must not modify or manipulate the names table entry until you remove it from the NBP name and address pair directory. <P>
 You set the parameter block's <CODE>entityPtr</CODE> field to the names table entry's pointer. For released software, you should always set the <CODE>verifyFlag</CODE> field to a nonzero number. This directs NBP to check throughout the network to determine that the name you want to register is unique. Ensuring that a name is unique avoids the occurrence of problems that can arise when two entities are registered with the same name. If the entity name is already registered for another entity, the <CODE>PRegisterName</CODE> function result indicates that the name is a duplicate by returning a function result of <CODE>nbpDuplicate</CODE>.<P>
 <A NAME=MARKER-9-39></A>You can specify how many times NBP should attempt to <A NAME=MARKER-2-77></A>verify the name's uniqueness by assigning a value to the <CODE>count</CODE> field. You can control how long NBP waits between each check by assigning a value to the <CODE>interval</CODE> field.<P>
 The interval and count parameters are both 1 byte long, which limits them to a value within the range of 0 to 255 ($00-$FF). However, you should not specify a value of 0 (which is equivalent to 256) for the retransmit interval; the task will never be executed if you do. <P>
 You measure intervals in 8-tick units. You can use this equation to determine how long in ticks a function will take to complete: <P>
<PRE>
TimeToCompleteInTicks := count * interval * 8;
</PRE>
 A value of 7 for the <CODE>interval</CODE> field is usually sufficient (7 <EM></EM> 8 = 56 ticks equals approxi-<BR>mately 1 second). A retry count of 5 is usually sufficient. However, on a large network, base the interval value on the speed of the network. Base the retry count on how likely it is for a particular kind of device to catch or miss the NBP lookup request and how many devices of this kind are on the network. <P>
 Some kinds of devices are more likely to receive the NBP lookup request than are others. For example, the AppleTalk ImageWriter has a dedicated processor on the LocalTalk option card to handle AppleTalk processing. A dedicated processor is likely to be available to receive an NBP lookup request, so the count for a device of this type can be relatively low. However, most Macintosh computers and LaserWriter printers depend on the system's shared processor to handle all processing, so the count for these kinds of devices should be higher. On a network with slow connections, for example, one that uses a modem bridge, you should increase the interval. <P>
 You can use different values for different types of devices. You can store these values in a preferences resource so that you can easily change them to correspond to changes in the network. For example, you could include values such as the following for these devices:
<TABLE BORDER="0" CELLPADDING=3><TH ALIGN=LEFT>Device <TH>Interval <TH>Count<TR>
<TD>AppleShare<TD>$07<TD>$05<TR>
<TD>AppleTalk ImageWriter<TD>$07<TD>$02<TR>
<TD>LaserWriter<TD>$0B<TD>$05</TABLE>
<P>
 You pass to the <CODE>PRegisterName</CODE> function a pointer to a parameter block and a Boolean value indicating if the function is to be executed asynchronously or synchronously. If you set the <CODE>async</CODE> Boolean parameter to <CODE>TRUE</CODE>, you must either provide a completion routine or set the <CODE>ioCompletion</CODE> field value to <CODE>NIL</CODE>, in which case, your process must poll the parameter block's <CODE>ioResult</CODE> field to determine when the function completes the operation. For a discussion of synchronous and asynchronous execution, see the chapter "Introduction to AppleTalk" in this book.<P>
 <A HREF=#MARKER-9-41>Listing 3-1</A> shows a segment of code that registers an application with NBP. First the code allocates nonrelocatable memory for the names table entry. Then the code calls <CODE>NBPSetNTE</CODE> to set up the names table entry in the format that the <CODE>PRegisterName</CODE> function expects. <P>
 Next, the code assigns values to the input fields of the parameter block to be used for <BR>the <CODE>PRegisterName</CODE> function. The code doesn't assign values to the ioRefNum and csCode fields because these field values are filled in by the PRegisterName function's glue code in the MPW interface.<P>
 Notice that the code assigns to the <CODE>entityPtr</CODE> field the <CODE>ntePtr</CODE> pointer to the buffer that the code passed to the <CODE>NBPSetNTE</CODE> function. After it sets up the parameter block, <BR>the code makes a synchronous call to the <CODE>PRegisterName</CODE> function to register the names table entry. If the <CODE>PRegisterName</CODE> function returns an error, the code releases <BR>the nonrelocatable memory that it allocated for the names table entry.<P>
<B>Listing 3-1  <A NAME=MARKER-9-41></A>Registering an application with NBP</B><P>
<PRE>
FUNCTION MyRegisterName (entityObject: Str32; entityType: Str32;
                         socket: Integer; VAR ntePtr: Ptr): OSErr;
VAR
   mppPB: MPPParamBlock;
   result: OSErr;
BEGIN
   ntePtr := NewPtrSys(sizeof(NamesTableEntry));
   IF ntePtr = NIL THEN
      BEGIN
         result := MemError;                    {return memory error}
         ntePtr := NIL;
      END
   ELSE
      BEGIN
         {Build the names table entity.}
         NBPSetNTE(ntePtr, entityObject, entityType, '*', socket);
         WITH mppPB DO
            BEGIN
               interval := $0F;                 {reasonable values for the }
               count := $03;                    { interval and retry count}
               entityPtr := ntePtr;             {pointer to NamesTableEntry}
               verifyFlag := Byte(TRUE);        {ensure that name is unique}
            END;
         result := PRegisterName(@mppPB, FALSE);{register the name}
         IF (result &lt;&gt; noErr) THEN
            BEGIN
               DisposPtr(ntePtr);               {if error, release memory}
               ntePtr := NIL;
            END;
      END;
   MyRegisterName := result;
END;
</PRE>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Networking-63.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-65.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Networking-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
