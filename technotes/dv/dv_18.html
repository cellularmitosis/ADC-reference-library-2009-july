<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><!--Includes revisions to code listings--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note DV18: CD-ROM Notes (Most Excellent)</title><meta name="keywords" content="Mac OS 8 AppleCD SC CD-ROM Foreign file access sysz"><meta name="Description" content="Technical Note DV18: This Technical Note discusses issuesconcerning the use of the AppleCD SC drive, the Apple CD-ROMdevice driver, and the Foreign File Access software extension.Included in this Technical Note: code that demonstrates howto open any AppleCD SC drive connected to a Macintosh, conversionfrom binary coded decimal to 2's Complement or decimal, andcode that changes the 'sysz' resource to the optimal valuesfor your disc.">                                       <meta name="categories" content="Devices"><meta name="week-posted" content="Jan 28, 1991 - Feb 1, 1991"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002408" title="CD-ROM Notes (Most Excellent)"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/idxMassStorageDevices-date.html" target="_blank">Hardware & Drivers > Storage</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note DV18</div>
<div id="pageheadsub">CD-ROM Notes (Most Excellent)</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                   <td background="images/tnmenubody.gif" width=300 align=left>                        <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->					<p id="menutext"> <a href="#Section1">Multiple CD-ROM Drives</a><BR><BR> <a href="#Section2">Device Manager Routines and Parameter Blocks</a><BR><BR> <a href="#Section3">Binary Coded Decimal</a><BR><BR> <a href="#Section4"> Block Addresses</a><BR><BR>  <a href="#Section5">Foreign File Access And The 'sysz' Resource</a><BR><BR> <a href="#Section6"> Mixing Data and Audio</a><BR><BR> <a href="#references">References</a><BR><BR><A href="#downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>		<td width=300 valign="top" align=left>	<!-- begin_intro_text --><P id = "introtext">This Technical Note discusses issues concerning the use of the AppleCD SCdrive, the Apple CD-ROM device driver, and the Foreign File Access software extension.</p><!-- end_intro_text --><!-- begin_date --><h3>Updated: [Feb 01 1991]</h3><!-- end_date -->                </TD>             </TR>          </TABLE> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><a name="Section1"></a><h2>Multiple CD-ROM Drives</h2><p>Your application can get access to the driver by calling the Device Managerroutine <code>_OpenDriver</code>:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>osErr = OpenDriver("\p.AppleCD", &amp;ioRefNum);</pre>	</TD></TR></TABLE></CENTER><p><code>_OpenDriver</code> returns the driver reference number for the AppleCD SC drivewith the lowest SCSI bus number, and this is okay if you are going to controlonly one AppleCD SC drive.  If you want to control or access more than onedrive, you must compute the driver reference number yourself.  You can use thefollowing formula to compute SCSI driver reference numbers:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>(32 + SCSI ID) - 1</pre>	</TD></TR></TABLE></CENTER><p>The following code demonstrates how to open any AppleCD SC drive connected to aMacintosh.  <code>OpenCD</code> takes a logical CD drive number, not a SCSI ID, asthe input parameter <code>CDDrive</code>.  A logical CD drive number of one refersto the AppleCD SC drive with the lowest SCSI ID connected to the Macintosh.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    typedef struct WhoIsThereRec {        ParamBlockHeader        short        ioRefNum;        short        csCode;        struct {            Byte     fill;            Byte     SCSIMask;        } csParam;    } WhoIsThereRec;    OSErr OpenCD(Byte CDDrive, short *ioRefNum) {        auto    OSErr            osErr;        auto    short            ioRefNumTemp;        auto    short            CDDriveCount;        auto    short            SCSIID;        auto    WhoIsThereRec    *pb;        pb = (WhoIsThereRec *) NewPtrClear(sizeof (*pb));        osErr = MemError();        if (0 != pb &amp;&amp; noErr == osErr) {            osErr = OpenDriver("\p.AppleCD", &amp;ioRefNumTemp);            if (noErr == osErr) {                (*pb).ioRefNum        = ioRefNumTemp;                (*pb).csCode        = csWhoIsThere;                osErr = PBStatus((ParmBlkPtr)pb, false);                if (noErr == osErr) {                    CDDriveCount = 0;                    for (SCSIID = 0; SCSIID &lt; 7; ++SCSIID) {                        if (BitTst(&amp;(*pb).csParam.SCSIMask, 7-SCSIID)) {                            ++CDDriveCount;                            if (CDDrive == CDDriveCount) {                                *ioRefNum = -(32 + SCSIID) - 1;                                DisposPtr((Ptr) pb);                                return noErr;                            }                        }                    }                    osErr = paramErr;                }            }            DisposPtr((Ptr) pb);        }        return osErr;    }    </pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>Device Manager Routines and Parameter Blocks</h2><p>The Apple CD-ROM driver does not conform to the design criteria of the DeviceManager, so do not use high-level Device Manager calls, because they do notwork.  Mistakenly, status calls are used to change control settings of thedevice, and control calls are used to get status information of the drive.  Thehigh-level <code>Control</code> and <code>Status</code> calls do not anticipate thisimplementation and simply do not work; instead, use the low-level <code>_PBControl</code> and <code>_PBStatus</code> calls for all access to the drive.</p><p>Zero parameter blocks before using them.  The unused bytes of the parameterblocks must be set to zero before you can use the parameter block in<code>_PBControl</code> or <code>_PBStatus</code> calls to the driver.  Failure to zerothe blocks results in the Device Manager calls returning an unexpected<code>ioResult</code> of <code>paramErr</code> (-50).</p><P><A HREF="#top">Back to top</A></P><a name="Section3"></a><h2>Binary Coded Decimal</h2><p>The AppleCD SC driver communicates track numbers andabsolute-minutes-seconds-frame addresses in what is known as Binary CodedDecimal (BCD) format.  In BCD, every four bits are used to represent onedecimal digit.  When working with the AppleCD SC, the BCD values are only up totwo digits in length, "99" tops.  Table 1 illustrates some possible values andtheir representation in 2's complement and Binary Coded Decimal form.</p><p><b>BCD Value    2's Complement</b></p><p><b>Hex    Binary Hex    Binary</b></p><p>0x01 00000001    &nbsp;1        0x01    00000001</p><p>0x09 00001001    &nbsp;9        0x09    00001001</p><p>0x10 00010000    10        0x0A    00001010</p><p>0x80 10000000    80        0x50    01010000</p><p>0x99 10011001    99        0x63    01100011</p><p><b>Table 1-BCD and 2' Complement Value Comparison</b></p><p>To convert from a 2's Complement number to a BCD number, take the value of thedigit in the ten's place, store it in the leftmost four bits of a byte, thenadd to it the value of the digit in the one's place.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    Byte Decimal2BCD(Byte n) {        return ((n / 10) &lt;&lt; 4) + (n % 10);    }    </pre>	</TD></TR></TABLE></CENTER><p>Converting from BCD to decimal requires multiplying the value in the leftmostfour bits by 10 and adding the value of rightmost four bits to the result.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    Byte BCD2Decimal(Byte n) {        return ((n &gt;&gt; 4) * 10) + (n &amp; 0x0f);    }</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="Section4"></a><h2>Block Addresses</h2><p>Physical blocks on a Compact Disc are defined as being 2K bytes in size.  Sincethe Macintosh operating system likes to work in 512-byte blocks, it sets thelogical block size to 512 bytes.  If you assume 2K blocks when using blockaddresses, you get into trouble.  If you are going to access the drive usinglogical block addressing, either change the block size back to 2K or be surethe formula you use in conversion from an absolute-minutes-seconds-framesaddress to a logical-block address takes this difference into account.</p><P><A HREF="#top">Back to top</A></P><a name="Section5"></a><h2>Foreign File Access And The 'sysz' Resource</h2><p>Large capacity ISO and High Sierra format discs can overload the default memorylimits of Apple's current external file system software, Foreign File Access.(This is not a problem for HFS-formatted CD-ROM discs, since the File Managerdeals directly with native volumes, bypassing the Foreign File Accesssoftware.)</p><p>Since unused memory reserved by Foreign File Access at INIT time cannot bereclaimed, Apple limited the amount of memory that is available to Foreign FileAccess.  The Foreign File Access file contains a <code>'sysz'</code> resource thatreserves 71, 680 bytes in the system heap.  If the <code>'sysz'</code> is too smalldiscs do not mount, but if it is too big it wastes precious memory.  Using thedefault <code>'sysz'</code> value, Foreign File Access cannot handle a CD-ROM withan extremely large number of files and directories.  In addition, with multipleAppleCD SC drives connected, Foreign File Access may run out of memory ifmultiple ISO or High Sierra CD-ROM discs are mounted.</p><P align=center> <img src="images/dv_18_001.gif" alt="Apple CD-ROM Driver and Foreign File Access Software" width=320 height=110></p><p align=center><b>Figure 1</b> - Apple CD-ROM Driver and Foreign File Access Software</p><p>Using ResEdit, you can experiment by changing the <code>'sysz'</code> resource tofind the optimal value for your disc's requirements.  To avoid wasting valuablespace in the System heap, increase this value incrementally until your discmounts (after you reboot, of course).  Asking your users to understand ResEditor perform this operation is asking a bit much, so following is code upon whichyou could base a simple application to change the <code>'sysz'</code> valueautomatically for them.  Remember that this application would need to beshipped separately (i.e., it is not accessible from the CD-ROM if the CD-ROMcannot be mounted).</p><p>This code assumes the creator and file type of the Foreign File Access file tobe <code>ufox</code> and <code>INIT</code> respectively.  It prompts the user to locateForeign File Access using the Standard File Package routine<code>_SFGetFile</code>.  This example does not allow the <code>'sysz'</code> value tobe made smaller than Apple's default setting.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>You should not assume that Foreign File Access can be found in theSystem Folder; the Foreign File Access software resides in the Extensionsfolder when running System Software 7.0.  Give the user the opportunity to findthe file using a standard file dialog box.</P></TD></TR></TABLE></CENTER><BR><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    char    *prompt    = "Find 'Foreign File Access'";    pascal Boolean FilterProc(HParmBlkPtr paramBlk) {    return 'ufox' == (*paramBlk).fileParam.ioFlFndrInfo.fdCreator ? false : true;    }    OSErr Modify_sysz(long size) {        auto    OSErr      osErr;        auto    SFReply    reply;        auto    Point      where;        auto    OSType     type;        auto    short      resRefNum;        auto    long       **sysz;        osErr = noErr;        SetPt(&amp;where, 100, 100);        type = 'INIT';        SFGetFile(where, prompt, FilterProc, 1, &amp;type, nil, &amp;reply);        if (reply.good) {            resRefNum = OpenRFPerm(reply.fName, reply.vRefNum, fsRdWrPerm);            osErr = ResError();            if  (-1 != resRefNum) {                sysz = (long **) Get1Resource('sysz', 0);                osErr = ResError();                if (nil != sysz) {                    if (0x00011800 &lt; size) {                        **sysz = size;                        ChangedResource((Handle) sysz);                        osErr = ResError();                    }                }                CloseResFile(resRefNum);            }        }        return osErr;    }</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="Section6"></a><h2>Mixing Data and Audio</h2><p>Any time the System, Finder, an application, or another code resource (e.g.,XCMDs) accesses a disc, any sound being played from the disc is interrupted.</p><P><A HREF="#top">Back to top</A></P><a name="references"></a><h2>References</h2><P>AppleCD SC Developers Guide, Revised Edition</p><P><A HREF="#top">Back to top</A></P>         <a name="downloads"></a>         <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center>                                    <img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (48K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/dv_18.pdf">Download</A></P>               </TD>            </TR>         </TABLE>         <BR>                  <P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/dv/dv_18.html%3Fid%3DDTS10002408-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/dv/dv_18.html%3Fid%3DDTS10002408-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/dv/dv_18.html%3Fid%3DDTS10002408-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>