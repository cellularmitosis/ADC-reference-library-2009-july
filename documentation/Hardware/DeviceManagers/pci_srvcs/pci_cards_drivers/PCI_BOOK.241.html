<HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><script language="JavaScript" src="frametest.js"></script><TITLE> SCSI Device Power Management</TITLE></HEAD><BODY BGCOLOR="#ffffff"><DIV><a name="top"></a><!-- start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!-- start of path --><font face="Geneva,Helvetica,Arial" size="1"><b><br>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Documentation</a> &gt; <!-- a href="" target="_top" -->Hardware<!-- /a -->  <b>&gt; </b><a href="../../devicemgrs.html" target="_top">Device Managers and Drivers</a> <b>&gt; </b><a href="../pci_srvcs.html" target="_top">PCI Card Services</a> <b>&gt; </b>Designing PCI Cards and Drivers for Power Macintosh Computers</font><br><br><!-- end of path --><A HREF="PCI_BOOK.23d.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.240.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.242.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><HR></DIV><H1 CLASS="H1.Heading1"><A NAME="pgfId=3340"> </A><A NAME="11821"> </A>SCSI Device Power Management</H1><P CLASS="T1.Text1"><A NAME="pgfId=3341"> </A>Supporting power management in a SCSI driver unavoidably violates some of the guidelines set forth in <A HREF="PCI_BOOK.1d1.html#10599" CLASS="XRef">Card Power Controls</A>. This section discusses some of the issues and potential solutions.</P><P CLASS="T1.Text1"><A NAME="pgfId=3345"> </A>At a minimum, SCSI storage device drivers should support driver gestalt as defined in <A HREF="PCI_BOOK.cb.html#39968" CLASS="XRef">Driver Gestalt</A>. They should respond positively to the <TT CLASS="cv">'lpwr'</TT> gestalt selector. Supporting driver gestalt mandates that the driver support <TT CLASS="cv">csCode=70</TT> for getting and setting the low power state (for spindle motor control, in most cases). The currently defined power modes are Active, Standby, Idle, and Sleep.</P><P CLASS="T1.Text1"><A NAME="pgfId=3349"> </A>If a driver does not have to support multiple platforms (such as both Power Macintosh and PowerBook computers) and chooses to rely on the Power Manager's internal timing semaphores, it should implement the following processes:</P><UL><LI CLASS="B1.Bullet1"><A NAME="pgfId=3350"> </A>Install code in the Power Manager's HD Spindown, Sleep, and State Notification queues.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3351"> </A>Make an <TT CLASS="cv">UpdateSystemActivity</TT> call to notify the Power Manager of activity on the driver's associated device.</LI></UL><P CLASS="T1.Text1"><A NAME="pgfId=3352"> </A>When these processes are implemented, drivers registered with the Power Manager will not be ordered to enter a low power mode until all devices have been idle for a period of time set by the user. However, no individual device control will be available and more work will be required to make the driver compatible with future releases of Mac&nbsp;OS. </P><P CLASS="T1.Text1"><A NAME="pgfId=3353"> </A>To be compatible with both Power Macintosh and PowerBook computers, or to simply provide a more elegant solution to the user, the driver should maintain an internal timer specifically for the device it administers. If multiple devices are managed by a single driver, multiple timers should be managed as well. To provide this level of support, the following must be implemented:</P><UL><LI CLASS="B1.Bullet1"><A NAME="pgfId=3354"> </A>Make an <TT CLASS="cv">UpdateSystemActivity</TT> call to notify the Power Manager of activity on the driver's associated device. This is required by the Power Manager to track idle time for system sleep correctly. </LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3355"> </A>Install code in the Power Manager State Notification queue requesting notification of spindown enable and disable changes, changes to the user-defined timeout period, and changes to the hard disk power state.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3356"> </A>Keep an internal timer in the driver and provide some method to update the timer and invoke low power modes when appropriate. A VBL or Time Manager task may be used.</LI></UL><P CLASS="T1.Text1"><A NAME="pgfId=3357"> </A>Drivers should not install code into the HD Spindown queue in this implementation. However, if the driver supports the main internal storage device on a PowerBook computer and requires device preparation before power is removed, Sleep and Wake and HD Spindown queue elements should be implemented.</P><P CLASS="T1.Text1"><A NAME="pgfId=3358"> </A>With either Power Macintosh or PowerBook platforms, any access to a driver's device or any driver request that requires the device to be at full power should cause the driver to wake the device before servicing that request. A control call to resume full power must be supported, but such a call is not required to wake the device.</P><DIV><blockquote><H4 CLASS="NoteHead"><A NAME="pgfId=13601"> </A>Note</H4><P CLASS="Note"><A NAME="pgfId=3359"> </A>Gestalt checks for the presence of the Power Manager should be made to decide whether to implement a low power solution upon a driver open or acknowledge request and to determine what kind of support is appropriate. </P></blockquote><P CLASS="T1.Text1"><A NAME="pgfId=3363"> </A>The current Power Manager implementation supports a mixed environment where some clients are dependent on the Power Manager's internal timing semaphore and others are self-sufficient. Drives supported by driver-based timers will spin down on a drive-by-drive basis. The internal timer will still trigger a spindown of those drives that rely on the Power Manager's timing facilities. It would be wise in either implementation to respond intelligently to requests to enter a power mode that is already present.</P></DIV><HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 26 March 99)<P><A HREF="PCI_BOOK.23d.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.240.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.242.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>