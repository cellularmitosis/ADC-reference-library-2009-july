<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>ZAM - /GameSource/GameSounds.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxGames-date.html">Games</a> &gt; <A HREF="javascript:location.replace('index.html');">ZAM</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Games/index.html" target="_blank">Reference Library > Games</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">ZAM</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/GameSource/GameSounds.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/CoreHeaders/CoreGlobals.h</option>
<option value="listing2.html">/CoreHeaders/EventLoop.h</option>
<option value="listing3.html">/CoreHeaders/MenuDispatch.h</option>
<option value="listing4.html">/CoreHeaders/WindowDispatch.h</option>
<option value="listing5.html">/CoreSource/AdjustMenus.c</option>
<option value="listing6.html">/CoreSource/AEventCoreDisp.c</option>
<option value="listing7.html">/CoreSource/Document.c</option>
<option value="listing8.html">/CoreSource/ErrMsg.c</option>
<option value="listing9.html">/CoreSource/EventLoop.c</option>
<option value="listing10.html">/CoreSource/GetBackTime.c</option>
<option value="listing11.html">/CoreSource/InitMac.c</option>
<option value="listing12.html">/CoreSource/Main.c</option>
<option value="listing13.html">/CoreSource/MenuDispatch.c</option>
<option value="listing14.html">/CoreSource/WindowDispatch.c</option>
<option value="listing15.html">/Dude #includes.c</option>
<option value="listing16.html">/GameHeaders/Document.h</option>
<option value="listing17.html">/GameHeaders/FixGraf.h</option>
<option value="listing18.html">/GameHeaders/GameAEvents.h</option>
<option value="listing19.html">/GameHeaders/GameDef.h</option>
<option value="listing20.html">/GameHeaders/GameSounds.h</option>
<option value="listing21.html">/GameHeaders/MissileSprite.h</option>
<option value="listing22.html">/GameHeaders/Sprite.h</option>
<option value="listing23.html">/GameHeaders/SpriteFrameRates.h</option>
<option value="listing24.html">/GameHeaders/TankSprite.h</option>
<option value="listing25.html">/GameHeaders/xqueue.h</option>
<option value="listing26.html">/GameHeaders/xthing.h</option>
<option value="listing27.html">/GameHeaders/ZAM.h</option>
<option value="listing28.html">/GameSource/DirectionTable.c</option>
<option value="listing29.html">/GameSource/ExplosionSprites.c</option>
<option value="listing30.html">/GameSource/FixGraf.c</option>
<option value="listing31.html">/GameSource/GameAEvents.c</option>
<option value="listing32.html">/GameSource/GameMenu.c</option>
<option value="listing33.html">/GameSource/GameSounds.c</option>
<option value="listing34.html">/GameSource/IncidentalSounds.c</option>
<option value="listing35.html">/GameSource/InitGame.c</option>
<option value="listing36.html">/GameSource/MissileAEvents.c</option>
<option value="listing37.html">/GameSource/MissileSprite.c</option>
<option value="listing38.html">/GameSource/pixiZAM - direct blitter/pixiZAM.c</option>
<option value="listing39.html">/GameSource/pixiZAM - direct blitter/pixiZAM.h</option>
<option value="listing40.html">/GameSource/SlamPixels.c</option>
<option value="listing41.html">/GameSource/Sprite.c</option>
<option value="listing42.html">/GameSource/Sprite.proto.h</option>
<option value="listing43.html">/GameSource/SpriteColission.c</option>
<option value="listing44.html">/GameSource/SpriteFrameSet.c</option>
<option value="listing45.html">/GameSource/SpriteLayer.c</option>
<option value="listing46.html">/GameSource/TankSprite.c</option>
<option value="listing47.html">/GameSource/xqueue.c</option>
<option value="listing48.html">/GameSource/xthing.c</option>
<option value="listing49.html">/GameSource/ZAMProtos.h</option>
<option value="listing50.html">/UtilCode/CoreAssertion.c</option>
<option value="listing51.html">/UtilCode/CoreAssertion.h</option>
<option value="listing52.html">/UtilCode/DialogUtil.c</option>
<option value="listing53.html">/UtilCode/GrafUtils.c</option>
<option value="listing54.html">/UtilCode/GrafUtils.h</option>
<option value="listing55.html">/UtilCode/GWorldUtils.c</option>
<option value="listing56.html">/UtilCode/GWorldUtils.h</option>
<option value="listing57.html">/UtilCode/IsPressed.c</option>
<option value="listing58.html">/UtilCode/WindowUtil.c</option></select>
				</p>
				</form>
				<p><strong><a href="ZAM.zip">Download Sample</a></strong> (&#147;ZAM.zip&#148;, 73.3K)<BR>
<strong><a href="ZAM.dmg">Download Sample</a></strong> (&#147;ZAM.dmg&#148;, 125.6K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*  This file manages the asynchronous sounds used by the game.  It demonstrates one of the simplest techniques of playing asynch sounds,  using SndPlay with a callback.  Notice this code does NOT depend on register a5  for flagging that a sound is done, instead I stuff a pointer to the flag  in the callback parameters.  I am pointing this out because I think it is a much better  way to do things, and the same technique can apply to any interrupt time code.    This also manages each channel by using a channel priority.  When a sound play request  is received for a specific channel, if the sound has a higher priority it is played,  otherwise it is ignored.    This code is pretty re-usable,  I have used it in a few other programs as well.    Call InitSounds( filename )  to start it up.  The file passed is a resource file  that contains all the snds you need.    Then use PlaySndAsynchChannel to play a sound, specifying the sound resource ID, the channel  number, and the priorty.  Right now this handles kNumChannels of sound.    Call SoundKeeper() from your idle routine to make sure that the sound channels are  disposed of when needed.    Call FreeSounds before your program quits.  Thats really the minimum you need in order  to use this code.  There is more to it, read the code and comments that follow.        A point to mention here.  There are so many different Macintosh sound managers out there,  that it is hard to write good code that runs on all of them.  This code SHOULD work on all  of them.  If not, please let me know.  See the feedback forms.    This code has two forks in it.  If Sound Manager 3.0 is running, then it creates the  sound channels at the start of the program, and keeps using them until the program quits.  Earlier versions of the Sound Manager contained bugs, which caused intermittent failures  unless a fresh sound channel was used for each asynchronous sound.  So, if a sound manager  earlier than 3.0 is installed, then this unit will create and dispose of sound channels  on the fly.    UNDER Sound Manager 3.0 on an AV macintosh with a DSP, it is important to open the channel  once and keep using it until you are done.  This is because every time the channel is opened  (or closed) the disk may be hit as the DSP Synth code is loaded.    Creating and disposing of a sound channel is not the most efficient way to play sounds, because the channel is created and  disposed of for each sound, requiring the memory manager to scam a block from the heap.  It would be better to open a channel, leave it open, and keep jamming bufferCmds in to   play each sound instead.  However - this does not work on all macs, like MacClassics, plusses  and some others.  If Sound Manager 3.0 is installed, then this code will work well.  I have made this the simplest way of playing asynchronous sounds, but it is NOT the best for   each particular Macintosh.  Double buffering is good because it can use less RAM, but it is bad because if you are spooling  the sound in then you are reading the disk or custom un-compressing, or otherwise doing  some amount of processing to fill the buffer, and this can slow the program down, not to mention  increase the complexity of any sound playing code.    */#include &quot;GameSounds.h&quot;#include &quot;ZAMProtos.h&quot;unsigned char  gSoundMgrVersion;SndChanInfo    gChan[kNumChan];short      gSndResFile;Boolean      gSoundEnable;void SoundEnable(void);void InitSounds(Str255  sndFileName)/*  open up the sound resource file, and preserve the resref num and stuff  */{  short  i;  OSErr  err;  short  prevResFile;      SoundEnable();     /* get the version number of the sound manager */  gSoundMgrVersion = SndSoundManagerVersion().majorRev;  for(i = 0; i &lt; kNumChan; i++) {    gChan[i].channel = nil;    gChan[i].priority = 0;    if(gSoundMgrVersion &gt;= 3) {      /* we can pre-allocate the channels and leave them open till we quit */      err = SndNewChannel(&amp;gChan[i].channel, sampledSynth,               initMono + initNoDrop + initNoInterp, SndDoneProc);      if(err) {        ErrMsgCode(&quot;\pError opening sound channel&quot;);        ExitToShell();      }    }  }    /* now open the file with our sounds in it */  prevResFile = CurResFile();    gSndResFile = OpenResFile(sndFileName);  if(gSndResFile == -1) {    ErrMsg(&quot;\pError opening sound resource file&quot;);  }    /* remove the sound file from chain */  UseResFile(prevResFile);}void SoundDisable(void)/*  turn sounds off  */{  gSoundEnable = false;}void SoundEnable(void)/*  turn sounds on  */{  gSoundEnable = true;}void StopAllSounds(void)/*  Stop all sounds from playing by dumping them*/{  short  i;    for(i = 0; i &lt; kNumChan; i++) {    if(gChan[i].priority)      SndDisposeChannel (gChan[i].channel, true);  }}Handle  GetSound(short  sndID)/*  Use this to get sounds from the file  This makes the sound res file current again  and grabs the sound.    Inside Mac is ambiguous about locking down sound handles.    They MUST be locked down before passed to sound play.*/{  short  saveResFile;  Handle  snd;    saveResFile = CurResFile();  UseResFile(gSndResFile);  snd = Get1Resource('snd ',sndID);  HLock(snd);  UseResFile(saveResFile);  return snd;}OSErr PlaySndAsynchChannel(short sndID, short chanNum, short priority)/*  This is the main sampled sound playing routine.  See comments above.  */{  OSErr      err = noErr;  SndCommand    cmd;  Handle      snd;    if (!gSoundEnable)  return;    snd = GetSound(sndID);  if(snd != nil) {    if( (gChan[chanNum].priority != 0)  &amp;&amp; (priority &gt;= gChan[chanNum].priority) ) {      /* if we got the sound and the channel is busy, and our priority is high enough */      /* then we are going to play, otherwise we bail */      if(gChan[chanNum].priority) {        if(gSoundMgrVersion &lt; 0x03) {          SndDisposeChannel (gChan[chanNum].channel, true);        } else {          /* since the good sound manager is around, stop playing the sound */          cmd.cmd = quietCmd;          cmd.param1 = 0;          cmd.param2 = 0;          err = SndDoImmediate(gChan[chanNum].channel, &amp;cmd);          cmd.cmd = flushCmd;          err = SndDoImmediate(gChan[chanNum].channel, &amp;cmd);        }      }    }    if(priority &gt;= gChan[chanNum].priority) {      if( gSoundMgrVersion &lt; 0x03) {        /* old sound manager around, so create a new sound channel */        gChan[chanNum].channel = nil;        err = SndNewChannel(&amp;gChan[chanNum].channel, sampledSynth, initMono + initNoDrop + initNoInterp, SndDoneProc);      }      if(err == noErr) {        err = SndPlay (gChan[chanNum].channel, snd, true);        if (err == noErr) {          gChan[chanNum].sndHandle = snd;          gChan[chanNum].priority = priority;          cmd.cmd = callBackCmd;          cmd.param2 = (long)&amp;gChan[chanNum];          err = SndDoCommand (gChan[chanNum].channel, &amp;cmd, false);        }      }    }  }    return err;}OSErr PlaySndAsynchChannelNow(short sndID, short chanNum, short priority)/*  The same as above, except does not check if sounds are enabled.  This was a hacky way to make sure that you could hear the sorry bub you loose sound.*/{  OSErr      err = noErr;  SndCommand    cmd;  Handle      snd;    snd = GetSound(sndID);  if(snd != nil) {    if( (gChan[chanNum].priority != 0)  &amp;&amp; (priority &gt;= gChan[chanNum].priority) ) {      /* if we got the sound and the channel is busy, and our priority is high enough */      /* then we are going to play, otherwise we bail */      if(gChan[chanNum].priority) {        if(gSoundMgrVersion &lt; 0x03) {          SndDisposeChannel (gChan[chanNum].channel, true);        } else {          /* since the good sound manager is around, stop playing the sound */          cmd.cmd = quietCmd;          cmd.param1 = 0;          cmd.param2 = 0;          err = SndDoImmediate(gChan[chanNum].channel, &amp;cmd);          cmd.cmd = flushCmd;          err = SndDoImmediate(gChan[chanNum].channel, &amp;cmd);        }      }    }    if(priority &gt;= gChan[chanNum].priority) {      if( gSoundMgrVersion &lt; 0x03) {        /* old sound manager around, so create a new sound channel */        gChan[chanNum].channel = nil;        err = SndNewChannel(&amp;gChan[chanNum].channel, sampledSynth, initMono + initNoDrop + initNoInterp, SndDoneProc);      }      if(err == noErr) {        err = SndPlay (gChan[chanNum].channel, snd, true);        if (err == noErr) {          gChan[chanNum].sndHandle = snd;          gChan[chanNum].priority = priority;          cmd.cmd = callBackCmd;          cmd.param2 = (long)&amp;gChan[chanNum];          err = SndDoCommand (gChan[chanNum].channel, &amp;cmd, false);        }      }    }  }    return err;}void SoundKeeper(void)/*  This routine must be called from your idle loop.  It updates the sound channels, getting rid of them and setting the flags correctly.*/{  short  i;    for(i = 0; i &lt; kNumChan; i++) {    if(gChan[i].priority == -1) {      gChan[i].priority = 0;      if(gChan[i].sndHandle)        HUnlock(gChan[i].sndHandle);  /* do you really want to have a big old unlocked block?*/      if(gSoundMgrVersion &lt; 0x03) {        SndDisposeChannel (gChan[i].channel, true);      }          }  }}pascal void SndDoneProc(SndChannelPtr channel, SndCommand *cmd)/*  This is the magical callback routine that flags SoundKeeper to dump this channel.  It is magic because it does not use register a5, like most people suggest.  I think it is lame to use register a5 to access a global from routines like this.  It is much better to just store a pointer to the data you need!*/{  SndChanInfo  *sndChan;  sndChan = (SndChanInfo*)cmd-&gt;param2;  sndChan-&gt;priority = -1;}void FreeSounds(void)/*  Disposes of all the currently allocated sound channels  and stops all sounds from playing.  Also closes the sound file*/{  short  i;    for(i = 0; i &lt; kNumChan; i++) {    SndDisposeChannel (gChan[i].channel, true);    gChan[i].priority = 0;  }    if(gSndResFile != -1) {    CloseResFile(gSndResFile);  }}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/ZAM/listing33.html%3Fid%3DDTS10000063-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/ZAM/listing33.html%3Fid%3DDTS10000063-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/ZAM/listing33.html%3Fid%3DDTS10000063-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>