<!-- legacy work start -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<!-- legacy work end -->


<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)

LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Dispatching to Sound Component-Defined Routines (IM: S)  (deprecated)</Title>

<!-- legacy work start -->
        <META NAME="Generator" CONTENT="manual">
        <META http-equiv="content-type" CONTENT="text/html;charset=utf-8">
        <META NAME = "Copyright" CONTENT="Copyright 2007 Apple Inc. All Rights Reserved.">
        <META NAME="IndexTitle" CONTENT="Inside Macintosh: Sound (Not Recommended)">
        <meta name="xcode-display" content="render">

        <LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css"> <!-- before submitting, globally replace ".." with "developer.apple.com" -->
        <script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
<!-- legacy work end -->

</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<A NAME=HEADING274></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Sound-273.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Sound-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Sound-336.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Sound-275.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Sound-2.html"><B>Sound</B></A> / <BR><DD><A HREF="Sound-266.html"><B>Chapter 5 - Sound Components</B></A> / <A HREF="Sound-271.html"><B>Writing a Sound Component</B></A></DL></FONT><P>
<HR>

<!-- legacy work start -->
<script type="text/javascript"> placeWatermark()</script>
<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
<i>Inside Macintosh: Sound</i> is deprecated as of Mac OS X v10.5. For new audio development in Mac OS X, use Core Audio. See the <a href="../../../referencelibrary/MusicAudio/" target="_top">Audio</a> page in the ADC Reference Library.</p></div></div></div>
<!-- legacy work end -->


<BLOCKQUOTE>
<A NAME=HEADING274-0></A>
<H2>Dispatching to Sound Component-Defined Routines</H2>
 As explained earlier, the code stored in the sound component should be contained in a resource of type <CODE>kSoundComponentCodeType</CODE>. The Component Manager expects the entry point in this resource to be a function with this format:<P>
<PRE>
pascal ComponentResult MySurfDispatch (ComponentParameters *params, 
                                          SoundComponentGlobalsPtr globals);
</PRE>
 The Component Manager calls your sound component by passing <CODE>MySurfDispatch</CODE> a selector in the <CODE>params-&gt;what</CODE> field; <CODE>MySurfDispatch</CODE> must interpret the selector and possibly dispatch to some other routine in the resource. Your sound component must be able to handle the required selectors, defined by these constants:<A NAME=MARKER-2-47></A><P>
<PRE>
#define kComponentOpenSelect           -1
#define kComponentCloseSelect          -2
#define kComponentCanDoSelect          -3
#define kComponentVersionSelect        -4
#define kComponentRegisterSelect       -5
#define kComponentTargetSelect         -6
#define kComponentUnregisterSelect     -7
</PRE>
<DL>
<DT><B>Note</B>
<DD>For complete details on required component selectors, see the chapter "Component Manager" in <I><A HREF="../MoreToolbox/MoreToolbox-2.html">Inside Macintosh: More Macintosh Toolbox</A></I>.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
 In addition, your sound component must be able to respond to component-specific selectors. Some of these selectors must be handled by your component; if your component doesn't implement one of these selectors, it should return the badComponentSelector result code. Other selectors should be delegated up the component chain. This allows the Sound Manager to query a particular component chain by passing a selector to the first component in the chain. If your component does not implement a delegable selector, it should call the Component Manager routine DelegateComponentCall to delegate the selector to its source component. If your sound component does implement a particular delegable selector, it should perform the operation associated with it. The Sound Manager defines a constant to designate the delegable selectors.<P>
<PRE>
/*first selector that can be delegated up the chain*/
#define kDelegatedSoundComponentSelectors       0x0100
</PRE>
 The Sound Manager can pass these selectors to your sound component:<P>
<PRE>
enum {
   /*the following calls cannot be delegated*/
   kSoundComponentInitOutputDeviceSelect     = 1,
   kSoundComponentSetSourceSelect,
   kSoundComponentGetSourceSelect,
   kSoundComponentGetSourceDataSelect,
   kSoundComponentSetOutputSelect,
   /*the following calls can be delegated*/
   kSoundComponentAddSourceSelect = kDelegatedSoundComponentSelectors + 1,
   kSoundComponentRemoveSourceSelect,
   kSoundComponentGetInfoSelect,
   kSoundComponentSetInfoSelect,
   kSoundComponentStartSourceSelect,
   kSoundComponentStopSourceSelect,
   kSoundComponentPauseSourceSelect,
   kSoundComponentPlaySourceBufferSelect
};
</PRE>
 You can respond to these selectors by calling the Component Manager routine <CODE>CallComponentFunctionWithStorage</CODE> or by delegating the selector to your component's source component. <A HREF=#MARKER-9-48>Listing 5-2</A> illustrates how to define a sound component entry point routine.<P>
<B>Listing 5-2  <A NAME=MARKER-9-48></A>Handling Component Manager selectors</B><P>
<PRE>
pascal ComponentResult MySurfDispatch (ComponentParameters *params,
                                           SoundComponentGlobalsPtr globals)
{
   ComponentRoutine     myRoutine;
   ComponentResult      myResult;

   /*Get address of component-defined routine.*/
   myRoutine = MyGetComponentRoutine(params-&gt;what);

   if (myRoutine == nil)                     /*selector not implemented*/
      myResult = badComponentSelector;
   else if (myRoutine == kDelegateCall)      /*selector should be delegated*/
      myResult = DelegateComponentCall(params, globals-&gt;sourceComponent);
   else
      myResult = CallComponentFunctionWithStorage((Handle) globals, params, 
                                             (ComponentRoutine) myRoutine);
   return (myResult);
}
</PRE>
 As you can see, the <CODE>MySurfDispatch</CODE> function defined in <A HREF=#MARKER-9-48>Listing 5-2</A> simply retrieves the address of the appropriate component-defined routine, as determined by the <CODE>params-&gt;what</CODE> field. If the routine <CODE>MyGetComponentRoutine</CODE> returns <CODE>nil</CODE>, then <CODE>MySurfDispatch</CODE> itself returns the <CODE>badComponentSelector</CODE> result code. Otherwise, if the selector should be delegated, <CODE>MySurfDispatch</CODE> calls <CODE>DelegateComponentCall</CODE> to do so. Finally, if the selector hasn't yet been handled, the appropriate component-defined routine is executed via <CODE>CallComponentFunctionWithStorage</CODE>.<A NAME=MARKER-2-49></A><P>
 <A HREF=#MARKER-9-50>Listing 5-3</A> defines the function <CODE>MyGetComponentRoutine</CODE>.<P>
<B>Listing 5-3  Finding the address of a component-defined routine<A NAME=MARKER-9-50></A></B><P>
<PRE>
ComponentRoutine MyGetComponentRoutine (short selector)
{
   void                 *myRoutine;

   if (selector &lt; 0)
      switch (selector)          /*required component selectors*/
      {
         case kComponentRegisterSelect:
            myRoutine = MyRegisterSoundComponent;
            break;
         case kComponentVersionSelect:
            myRoutine = MySoundComponentVersion;
            break;
         case kComponentCanDoSelect:
            myRoutine = MySoundComponentCanDo;
            break;
         case kComponentCloseSelect:
            myRoutine = MyCloseSoundComponent;
            break;
         case kComponentOpenSelect:
            myRoutine = MyOpenSoundComponent;
            break;
         default:
            myRoutine = nil;     /*unknown selector, so fail*/
            break;
      }
   else if (selector &lt; kDelegatedSoundComponentSelectors)
                           /*selectors that can't be delegated*/
      switch (selector)
      {
         case kSoundComponentInitOutputDeviceSelect:
            myRoutine = MySoundComponentInitOutputDevice;
            break;

         case kSoundComponentSetSourceSelect:
         case kSoundComponentGetSourceSelect:
         case kSoundComponentGetSourceDataSelect:
         case kSoundComponentSetOutputSelect:
         default:
            myRoutine = nil;     /*unknown selector, so fail*/
            break;
      }
   else                    /*selectors that can be delegated*/
      switch (selector)
      {
         case kSoundComponentStartSourceSelect:
            myRoutine = MySoundComponentStartSource;
            break;
         case kSoundComponentPlaySourceBufferSelect:
            myRoutine = MySoundComponentPlaySourceBuffer;
            break;
         case kSoundComponentGetInfoSelect:
            myRoutine = MySoundComponentGetInfo;
            break;
         case kSoundComponentSetInfoSelect:
            myRoutine = MySoundComponentSetInfo;
            break;
         case kSoundComponentAddSourceSelect:
         case kSoundComponentRemoveSourceSelect:
         case kSoundComponentStopSourceSelect:
         case kSoundComponentPauseSourceSelect:
         default:
            myRoutine = kDelegateCall;             /*delegate it*/
            break;
      }

   return (myRoutine);
}
</PRE>
 In all likelihood, your component is loaded into the system heap, although it might be loaded into an application heap if memory is low in the system heap. You can call the Component Manager function GetComponentInstanceA5 to determine the A5 value of the current application. If this function returns 0, your component is in the system heap; otherwise, your component is in an application's heap. Its location might affect how you allocate memory. For example, calling the MoveHHi routine on handles in the system heap has no result. Thus, you should either call the ReserveMemSys routine before calling NewHandleSys (so that the handle is allocated as low in the system heap as possible) or else just allocate a nonrelocatable block by calling the <CODE>NewPtrSys</CODE> routine.<A NAME=MARKER-2-47></A><P>
 If you need to access resources that are stored in your sound component, you can use <CODE>OpenComponentResFile</CODE> and <CODE>CloseComponentResFile</CODE>. <CODE>OpenComponentResFile</CODE> requires the <CODE>ComponentInstance</CODE> parameter supplied to your routine. You should not call Resource Manager routines such as <CODE>OpenResFile</CODE> or <CODE>CloseResFile</CODE>.<A NAME=MARKER-2-61></A><P>
<DL>
<DT><B>WARNING</B>
<DD>Do not leave any resource files open when your sound component is closed. Their maps will be left in the subheap when the subheap is freed, causing the Resource Manager to crash.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 The following sections illustrate how to define some of the sound component functions.<P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Sound-273.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Sound-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Sound-336.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Sound-275.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Sound-3.html">&copy; Apple Computer, Inc.</A><br>2 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
