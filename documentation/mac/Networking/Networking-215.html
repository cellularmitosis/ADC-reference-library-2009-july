<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>ASPUserCommand(IM:N)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING215></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Networking-214.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-216.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Networking-2.html"><B>Networking</B></A> / <BR><DD><A HREF="Networking-204.html"><B>Chapter 8 - AppleTalk Session Protocol (ASP)</B></A> / <A HREF="Networking-206.html"><B>ASP Reference</B></A><BR><DL><DD><A HREF="Networking-209.html"><B>Routines</B></A> / <A HREF="Networking-214.html"><B>Sending Commands and Writing Data From the Workstation to the Server</B></A></DL></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING215-0></A>
<H3><A NAME=MARKER-9-68></A>ASPUserCommand</H3>
 <A NAME=MARKER-11-69></A>The <A NAME=MARKER-2-70></A><CODE>ASPUserCommand</CODE> function sends a command that you define from the workstation <A NAME=MARKER-9-16></A>to the server across a session between them. ASP does not interpret the command syntax or execute the command; it simply transfers the command to the ASP server.<P>
<PRE>
FUNCTION ASPUserCommand (thePBptr: XPPParmBlkPtr;
                         async: Boolean): OSErr;
</PRE>
<DL>
<DT><CODE>thePBptr</CODE>
<DD> A pointer to an XPP parameter block.
<DT><CODE>async</CODE>
<DD> A Boolean that specifies whether the function should be executed asynchronously or synchronously. Specify <CODE>TRUE</CODE> for asynchronous execution.
</DL>
<B>
<TABLE BORDER="0" CELLPADDING=3><TD>--><TD>ioCompletion<TD>ProcPtr<TD>A pointer to a completion routine.<TR>
<TD><--<TD>ioResult<TD>OSErr<TD>The function result.<TR>
<TD><--<TD>cmdResult<TD>LongInt<TD>The ASP command result.<TR>
<TD>--><TD>ioRefNum<TD>Integer<TD>The .XPP driver reference number.<TR>
<TD>--><TD>csCode<TD>Integer<TD>Always userCommand for this function.<TR>
<TD>--><TD>sessRefnum<TD>Integer<TD>The session reference number. <TR>
<TD>--><TD>aspTimeout<TD>Byte<TD>The retry interval in seconds.<TR>
<TD>--><TD>cbSize<TD>Integer<TD>The command block size.<TR>
<TD>--><TD>cbPtr<TD>Ptr<TD>A pointer to the command block. <TR>
<TD><-><TD>rbSize<TD>Integer<TD>The reply buffer and reply size.<TR>
<TD>--><TD>rbPointer<TD>Ptr<TD>A pointer to the reply buffer.<TR>
<TD><--<TD>ccbStart<TD>Array<TD>The beginning of memory for the CCB.</TABLE>
</B><P>
<DL>
<H5>Field Description</H5>
<DT><CODE>cmdResult</CODE>
<DD> The ASP command result, consisting of 4 bytes of data returned by the server. The ASP client application defines the contents of the command result field. For example, AFP defines this field to specify the result of the AFP command. This field is valid if no system-level error is returned in the <CODE>ioResult</CODE> field.
<DT><CODE>sessRefnum</CODE>
<DD> The reference number assigned to this session that the <CODE>ASPOpenSession</CODE> function returned when you called it to open <BR>the session. 
<DT><CODE><A NAME=MARKER-2-5></A>aspTimeout</CODE>
<DD> The time in seconds after which ASP is to retry to send the command across the session. You cannot specify the number of retries, just the time between them. ASP will retry to transmit the command until either it succeeds or the session is closed. 
<DT><CODE><A NAME=MARKER-2-8></A>cbSize</CODE>
<DD> The size in bytes of the buffer that contains the command that <BR>ASP is to send to the sever. The command buffer size must not exceed the value of <CODE>aspMaxCmdSize</CODE>, which the <CODE>ASPGetParms</CODE> function returns.   
<DT><CODE><A NAME=MARKER-9-37></A>cbPtr</CODE>
<DD> A pointer to a buffer containing the command that ASP is to send <BR>to the server. 
<DT><CODE><A NAME=MARKER-2-16></A>rbSize</CODE>
<DD> On input, the size in bytes of the buffer that you allocated to contain the command reply that you expect to receive from the server. On return, the size in bytes of the reply data that was actually returned.
<DT><CODE><A NAME=MARKER-2-32></A>rbPointer</CODE>
<DD> A pointer to the buffer for the command reply.
<DT><CODE><A NAME=MARKER-2-11></A>ccbStart</CODE>
<DD> The beginning of the memory for the <A NAME=MARKER-2-44></A>command control block (<A NAME=MARKER-2-33></A>CCB) that the .XPP driver is to use. The memory allocated for the CCB must not exceed the maximum of 150 bytes for this function. The CCB is an array that is part of the .XPP parameter block. 
</DL>
<A NAME=HEADING215-14></A>
<H5>DESCRIPTION</H5>
 You use the <CODE>ASPUserCommand</CODE> function to send a user command across an ASP session. You pass to the <CODE>ASPUserCommand</CODE> function a pointer to a variable-size command block that contains the command data to be sent to the ASP server. The command data must adhere to a format defined by a higher-level protocol that is built on top of the ASP server, such as the AppleTalk Filing Protocol (AFP). The command data requests the server to perform a particular function and return a reply consisting of a variable-size block of data and a command result. Some examples of the types of commands that you can send are<P>
<UL>
<LI>a request to open a particular file on a file server (The server would return a small amount of data for this request.)
<LI>a request to read a range of bytes from a device (The server might send a multiple-<BR>packet reply to this request.)<P>
</UL>
 ASP delivers the commands in the same sequence that you send them. ASP does not interpret the command data or in any way participate in executing the command's function. It simply conveys the command data, included in a higher-level format, to <BR>the server end of the session and returns the command reply to your ASP workstation application. The command reply consists of a 4-byte command result returned in the<CODE> cmdResult</CODE> field and a variable-size command reply returned in the reply buffer that you supply. The higher-level protocol that is the client of ASP defines the content and use of the command result. A command result error is returned in the <CODE>cmdResult</CODE> field. All other types of errors are returned in the function's parameter block <CODE>ioResult</CODE> field. These error codes report the following error conditions:<P>
<UL>
<LI>system-level errors returned by the .XPP driver indicating, for example, that the driver is not open or that a particular system call is not supported
<LI>.XPP driver errors indicating, for example, that the session is not open
<LI>AppleTalk errors returned from the underlying AppleTalk protocols
<LI>an ASP-specific error returned from an ASP server, for example, in response to a failed <CODE>ASPOpenSession</CODE> function<P>
</UL>
 <A HREF=#MARKER-9-83>Figure 8-3 on page 8-18</A> shows how these errors are reported. <P>
 The .XPP driver uses the memory at the end of the XPP parameter block defined as a <CODE>CCBStart</CODE> array as an internal command control block (CCB). To ensure that the function executes successfully, you can specify the maximum size for this array as indicated in particular for the function that uses it. <P>
 <A NAME=MARKER-2-80></A>You can <A NAME=MARKER-9-21></A>minimize the amount of memory that is used for the CCB in the queue element. To do this, you should understand how ASP uses this memory. ASP uses the CCB to build data structures, including parameter blocks and <A NAME=MARKER-2-82></A>buffer data structures (BDS), that it needs in order to make function calls to the .ATP driver. (See the chapter "AppleTalk Transaction Protocol [ATP]" in this book for information on ATP and buffer data structures.) The exact size of the memory that ASP needs for the CCB depends on the size of the replies that you expect from the server, and in the case of the <CODE>ASPUserWrite</CODE> function, the size of the data to be written. For the <CODE>ASPUserCommand</CODE>, <CODE>ASPUserWrite</CODE>, and <CODE>ASPGetStatus</CODE> functions, ASP must set up a BDS to hold the reply information. <BR>The number of entries in the BDS that ASP creates is equal to the size of the reply buffer divided by 578 (the maximum number of data bytes per ATP response packet), rounded up. A BDS cannot exceed eight elements. In addition to a BDS, ASP uses the CCB memory for the queue element to call the .ATP driver.<P>
<B>Figure 8-3  <A NAME=MARKER-9-83></A>Error reporting in ASP </B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/ASP-L-03.jpg"><P>
 You can use the following equations to determine the minimum size of a CCB for a function that includes a reply buffer (<CODE>rbSize</CODE>):<P>
<PRE>
bdsSize = MIN (((rbSize DIV 578) + 1),8) * bdsEntrySz
ccbSize = ioQElSize + 4 + bdsSize 
</PRE>
 For functions, such as <CODE>ASPUserWrite</CODE>, ASP must create an additional BDS and queue element to use in sending the write data to the server. You can use the following equa-<BR>tions to determine the minimum size of a CCB for an <CODE>ASPUserWrite</CODE> function; these equations take into account the reply buffer (<CODE>rbSize</CODE>) and write data size (<CODE>wdSize</CODE>): <P>
<PRE>
wrBDSSize = MIN (((wdSize DIV 578) + 1),8) * bdsEntrySz
wrCCBSz = (2 * ioQElSize) + 4 + bdsSize + wrBDSSize
</PRE>
 Note that <CODE>bdsEntrySz</CODE> is equal to 12 and <CODE>ioQelSize</CODE> is equal to 50. <P>
<A NAME=HEADING215-33></A>
<H5>SPECIAL CONSIDERATIONS</H5>
 Note that you must provide the .XPP driver reference number as an input parameter <BR>to this function. You can obtain the driver reference number by calling the Device Manager's <CODE>OpenDriver</CODE> function. <P>
<A NAME=HEADING215-35></A>
<H5>ASSEMBLY-LANGUAGE INFORMATION</H5>
 To execute the <CODE>ASPUserCommand</CODE> function from assembly language, call the <CODE>_Control</CODE> trap macro with a value of <CODE>userCommand</CODE> in the <CODE>csCode</CODE> field of the parameter <A NAME=MARKER-2-97></A>block. You must also specify the .XPP driver reference number. To execute the <CODE>_Control</CODE> trap asynchronously, include the value <CODE>,ASYNC</CODE> in the operand field.<P>
<A NAME=HEADING215-37></A>
<H5>RESULT CODES
<TABLE BORDER="0" CELLPADDING=3><TD>aspBufTooSmall<TD>-1067<TD>The reply data exceeds the size of the reply buffer; the .XPP driver will fill the buffer and truncate the data<A NAME=MARKER-2-153></A><A NAME=MARKER-9-198></A> <TR>
<TD>aspParamErr<TD>-1070<TD>You specified an invalid session reference number, or the session has been closed <TR>
<TD>aspSessClosed<TD>-1072<TD>The .XPP driver is in the process of closing down <BR>the session <TR>
<TD>aspSizeErr<TD>-1073<TD>The size of the command block exceeds the maximum size of <CODE>aspMaxCmdSize</CODE></TABLE>
</H5>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Networking-214.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-216.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Networking-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
