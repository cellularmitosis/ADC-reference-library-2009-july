<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML EXPERIMENTAL 970324//EN"><HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><TITLE> Using Nested Editing Contexts</TITLE></HEAD><body bgcolor="#ffffff"><!--start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!--start of path --><font face="Geneva,Helvetica,Arial" size="1"><b>PATH<spacer type="horizontal" size="5">&nbsp;</b> <a href="../../../../../../index.html" target="_top">Documentation</a> <b>&gt;</b> <a href="../../../../../webobjects.html" target="_top">WebObjects 4.5</a> <b>&gt;</b>Programming Topics</font><br><br><!--end of path --><DIV><a name="top"></a><A HREF="TopicsTOC.html"><img src="up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="ProgrammingTopics.38.html"><img src="previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="ProgrammingTopics.3a.html"><img src="next.gif" border="0" width="49" height="16"></A></DIV><H1 CLASS="TopictTitle"><A NAME="pgfId=606100"> </A><A NAME="26057"> </A>Using Nested Editing Contexts</H1><DIV><H2 CLASS="Synopsis"><A NAME="pgfId=606101"> </A>Synopsis</H2><P CLASS="Body"><A NAME="pgfId=606102"> </A>Describes how to use nested editing contexts as a working area for complex edit screens.</P></DIV><DIV><H2 CLASS="Heading1"><A NAME="pgfId=606103"> </A>Discussion</H2><P CLASS="Body"><A NAME="pgfId=606104"> </A>EOEditingContexts can be viewed as working areas into which objects are fetched and modified. By default, every session is given its own <TT CLASS="Code">defaultEditingContext</TT> as a means of separating different user's objects. </P><P CLASS="Body"><A NAME="pgfId=606105"> </A>When changes are made to objects within an editing context, the editing context tracks the changes for future saving. When the editing context sends the message <TT CLASS="Code">saveChanges</TT>, it hands off the changes to its parent EOObjectStore. Normally, the parent is the EOObjectStoreCoordinator which in turn hands off the changes to the appropriate EODatabaseContext for each entity. The EODatabaseContext then saves the changes to the database.</P><P CLASS="Body"><A NAME="pgfId=606106"> </A>Since an EOEditingContext is itself an EOObjectStore, you can nest EOEditingContexts, thereby making different levels of working areas that can <TT CLASS="Code">saveChanges</TT> to its parent level. With a little bit of effort, this feature of EOF can be used within WebObjects applications to provide scratch areas where users can make changes, submit forms, update enterprise objects, submit more forms, and then decide if all the changes should be saved to the session's <TT CLASS="Code">defaultEditingContext</TT> or completely forgotten.</P><P CLASS="Body"><A NAME="pgfId=606107"> </A>This more complicated approach to editing is necessary because the Web permits users to edit on a special edit page and, without saving or canceling, hyperlink directly to another page, leaving the <TT CLASS="Code">defaultEditingContext</TT> with incomplete or inconsistent enterprise objects. This action can be disastrous unless care is taken to prevent the partial or undesired changes from being saved by accident.</P><P CLASS="Body"><A NAME="pgfId=606108"> </A>To better illustrate this issue, assume you create a special object edit page that uses multiple Submit buttons to switch between sections of data to be edited. Also, assume that the WOTextfields, WOPopuplists, and so on, are bound directly to the object via key paths. As soon as you edit the data on the first section, and switch to see the data on a different section, the object will be changed to reflect any changes you made in the first section. Assume further that the user clicks a hyperlink in a different frame and jumps to a completely different screen. The user subsequently edits another object and finishes by selecting the Save button. The changes from the first edit screen will also be applied to the database! This is undesirable because the user never acknowledged a save for those changes.</P><P CLASS="Body"><A NAME="pgfId=606109"> </A>There are two possible ways to work around this problem.</P><OL><LI CLASS="Numbered"><A NAME="pgfId=606111"> </A>Create a temporary instance variable for every data element that might be changed. Initialize the temporary variables upon entering the edit page. Update the real variables only during the actual <TT CLASS="Code">saveChanges</TT> action.</LI><LI CLASS="Numbered"><A NAME="pgfId=607203"> </A>Create a nested EOEditingContext and fault in the object to be edited. The relationships will automatically be faulted into this temporary nested work area as needed. Bind the new editing instance of the object directly to the page's components. When <TT CLASS="Code">saveChanges</TT> is invoked on the temporary EOEditingContext, the changes will be applied to the session's <TT CLASS="Code">defaultEditingContext</TT>. To apply them to the database, you can invoke <TT CLASS="Code">saveChanges</TT> to the session's <TT CLASS="Code">defaultEditingContext</TT>, after which you can destroy the object and the temporary EOEditingContext.</LI></OL><P CLASS="Body"><A NAME="pgfId=609225"> </A>We discuss the second approach. The techniques presented here can be used to build a reusable framework that manages the nested editing contexts without doubly-nesting them.</P><DIV><H3 CLASS="Heading2"><A NAME="pgfId=609240"> </A>Creating the Nested EOEditingContext</H3><P CLASS="Body"><A NAME="pgfId=609247"> </A>The following code creates a nested editing context.</P><DIV><H4 CLASS="Code-Listing"><A NAME="pgfId=609228"> </A>Java Code</H4><PRE CLASS="Code"><A NAME="pgfId=609230"> </A>EOEditingContext ec=session().defaultEditingContext();<A NAME="pgfId=609232"> </A>EOEditingContext nestedEditingContext=new EOEditingContext(ec);</PRE></DIV><DIV><H4 CLASS="Code-Listing"><A NAME="pgfId=609235"> </A>Objective-C Code</H4><PRE CLASS="Code"><A NAME="pgfId=609237"> </A>EOEditingContext *ec=[[self session] defaultEditingContext];<A NAME="pgfId=609239"> </A>EOEditingContext *nestedEditingContext=[[EOEditingContext alloc] initWithParentObjectStore:ec];</PRE><P CLASS="Body"><A NAME="pgfId=615768"> </A></P></DIV></DIV><DIV><H3 CLASS="Heading2"><A NAME="pgfId=609241"> </A>Faulting the Original EO into the Nested EOEditingContext</H3><P CLASS="Body"><A NAME="pgfId=606128"> </A>Using the new convenience API from EOUtilities</P><DIV><H4 CLASS="Code-Listing"><A NAME="pgfId=608230"> </A>Java Code</H4><PRE CLASS="Code"><A NAME="pgfId=608232"> </A>EOEnterpriseObject editingObject=(EOEnterpriseObject) EOUtilities.localInstanceOfObject (nestedEditingContext, objectToEdit);</PRE><P CLASS="Body"><A NAME="pgfId=606131"> </A>Using the standard API</P></DIV><DIV><H4 CLASS="Code-Listing"><A NAME="pgfId=608235"> </A>Java Code</H4><PRE CLASS="Code"><A NAME="pgfId=608237"> </A>EOGlobalID gid=objectToEdit.editingContext().globalIDForObject(objectToEdit);<A NAME="pgfId=608239"> </A>EOEnterpriseObject editingObject=nestedEditingContext.faultForGlobalID(gid, nestedEditingContext);</PRE><P CLASS="Body"><A NAME="pgfId=606136"> </A>Using the new convenience API from EOUtilities</P></DIV><DIV><H4 CLASS="Code-Listing"><A NAME="pgfId=608244"> </A>Objective-C Code</H4><PRE CLASS="Code"><A NAME="pgfId=608246"> </A>id editingObject=[nestedEditingContext localInstanceOfObject: objectToEdit];</PRE><P CLASS="Body"><A NAME="pgfId=606139"> </A>Using the standard API</P></DIV><DIV><H4 CLASS="Code-Listing"><A NAME="pgfId=608249"> </A>Objective-C Code</H4><PRE CLASS="Code"><A NAME="pgfId=608251"> </A>gid=[[objectToEdit editingContext] globalIDForObject: objectToEdit];<A NAME="pgfId=608253"> </A>id editingObject=[nestedEditingContext faultForGlobalID: gid editingContext: nestedEditingContext];</PRE></DIV></DIV><DIV><H3 CLASS="Heading2"><A NAME="pgfId=606143"> </A>Saving All the Changes to the Database</H3><P CLASS="Body"><A NAME="pgfId=609248"> </A>The following code saves the changes to a nested editing context.</P><DIV><H4 CLASS="Code-Listing"><A NAME="pgfId=608262"> </A>Java Code</H4><PRE CLASS="Code"><A NAME="pgfId=608264"> </A>try {<A NAME="pgfId=608266"> </A>     nestedEditingContext.saveChanges();<A NAME="pgfId=608268"> </A>     session().defaultEditingContext().saveChanges();<A NAME="pgfId=608270"> </A>}<A NAME="pgfId=608272"> </A>catch (EOValidationException e) { // handle save error<A NAME="pgfId=608276"> </A></PRE></DIV><DIV><H4 CLASS="Code-Listing"><A NAME="pgfId=608284"> </A>Objective-C Code</H4><PRE CLASS="Code"><A NAME="pgfId=608286"> </A>NS_DURING<A NAME="pgfId=608288"> </A>     [ nestedEditingContext saveChanges];<A NAME="pgfId=608290"> </A>     [[[self session] defaultEditingContext] saveChanges];<A NAME="pgfId=608292"> </A>NS_HANDLER // handle save error and the exception in variable localException<A NAME="pgfId=608296"> </A>NS_ENDHANDLER</PRE></DIV><DIV><H4 CLASS="Code-Listing"><A NAME="pgfId=608301"> </A>WebScript Code</H4><PRE CLASS="Code"><A NAME="pgfId=608303"> </A>NSException *e=[nestedEditingContext tryToSaveChanges];<A NAME="pgfId=608305"> </A>     if  (!e)<A NAME="pgfId=608307"> </A>     e=[[[self session] defaultEditingContext] saveChanges];<A NAME="pgfId=608309"> </A>     if (e) {<A NAME="pgfId=608311"> </A>     // handle save error and the exception in variable e<A NAME="pgfId=608313"> </A>}</PRE><P CLASS="Body"><A NAME="pgfId=615776"> </A></P></DIV></DIV><DIV><H3 CLASS="Heading2"><A NAME="pgfId=606172"> </A>Issues to Consider</H3><P CLASS="Body"><A NAME="pgfId=607318"> </A>You should consider the following issues:</P><UL><LI CLASS="Bulleted"><A NAME="pgfId=607321"> </A>You need to ensure that the nested EOEditingContexts are retained.	</LI><LI CLASS="Bulleted"><A NAME="pgfId=614805"> </A>You probably want to keep track of the nested EOEditingContexts so that you can eventually free them. The session might be a good place to store these references.</LI><LI CLASS="Bulleted"><A NAME="pgfId=606174"> </A>	You might want to keep track of the editing page for a given nested EOEditingContext so that you can jump back to that page if the user jumps off the edit page, and then requests to edit the same original object.</LI><LI CLASS="Bulleted"><A NAME="pgfId=606175"> </A>	You might want to restrict the user by only allowing one editable object at a time. You can present the user with an AlertPanel page that asks if the user wants to abort a previous unfinished edit, jump back to an unfinished edit, or cancel attempting to edit a second object.</LI><LI CLASS="Bulleted"><A NAME="pgfId=606176"> </A>	Care must be taken to avoid creating a doubly-nested EOEditingContext. You must ensure that the object you will edit is within the session's <TT CLASS="Code">defaultEditingContext</TT>.</LI><LI CLASS="Bulleted"><A NAME="pgfId=606177"> </A>	Remember that the EOEditingContext does not retain its objects (unless<BR><TT CLASS="Code">instancesRetainAllObjects</TT> is YES, i.e., when you're writing in Java). Instead, it listens for deallocation notifications and automatically removes the object from the editing context. Therefore, it is important to ensure that the object being edited is retained by something for the life of the nested editing context.</LI></UL></DIV></DIV><DIV><H2 CLASS="Heading1"><A NAME="pgfId=606179"> </A>See Also</H2><UL><LI CLASS="Bulleted"><A NAME="pgfId=606180"> </A>EOEditingContext class specification in the <EM CLASS="Emphasis">Enterprise Objects Framework Reference</EM></LI><LI CLASS="Bulleted"><A NAME="pgfId=606181"> </A>EOObjectStore class specification in the <EM CLASS="Emphasis">Enterprise Objects Framework Reference</EM></LI><LI CLASS="Bulleted"><A NAME="pgfId=606182"> </A>EOObjectStoreCoordinator class specification in the <EM CLASS="Emphasis">Enterprise Objects Framework Reference</EM></LI><LI CLASS="Bulleted"><A NAME="pgfId=606183"> </A>EOUtilities class specification (Java) in the <EM CLASS="Emphasis">Enterprise Objects Framework Reference</EM></LI><LI CLASS="Bulleted"><A NAME="pgfId=618511"> </A>EOUtilities category specification on the EOEditingContext class (Objective-C) in the <EM CLASS="Emphasis">Enterprise Objects Framework Reference</EM></LI></UL></DIV><DIV><H2 CLASS="Heading1"><A NAME="pgfId=606185"> </A>Questions</H2><UL><LI CLASS="Bulleted"><A NAME="pgfId=606186"> </A>	How do I safely edit an object and not worry if the user forgets to revert undesired changes?</LI><LI CLASS="Bulleted"><A NAME="pgfId=606187"> </A>	How do I use the nested EOEditingContexts to aid in complex WOF edit screens?</LI><LI CLASS="Bulleted"><A NAME="pgfId=606188"> </A>	How do I copy an object from a parent EOEditingContext into a nested EOEditingContext?</LI></UL></DIV><DIV><H2 CLASS="Heading1"><A NAME="pgfId=606189"> </A>Keywords</H2><UL><LI CLASS="Bulleted"><A NAME="pgfId=606190"> </A>Faulting</LI><LI CLASS="Bulleted"><A NAME="pgfId=606191"> </A>Nested</LI></UL></DIV><DIV><H2 CLASS="Heading1"><A NAME="pgfId=606197"> </A>Revision History</H2><P CLASS="Body"><A NAME="pgfId=606198"> </A>24 July, 1998. David Scheck. First Draft.<BR>18 November, 1998. Clif Liu. Second Draft.</P></DIV><HR>&#169 1999 Apple Computer, Inc.<P><A HREF="TopicsTOC.html"><img src="up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="ProgrammingTopics.38.html"><img src="previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="ProgrammingTopics.3a.html"><img src="next.gif" border="0" width="49" height="16"></A><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></BODY></HTML>