<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>SprocketInvadersOld - /Source/SoundHandler.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxGames-date.html">Games</a> &gt; <A HREF="javascript:location.replace('index.html');">SprocketInvadersOld</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Games/index.html" target="_blank">Reference Library > Games</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">SprocketInvadersOld</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/Source/SoundHandler.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/Resources/Art.r</option>
<option value="listing2.html">/Source/AboutBox.c</option>
<option value="listing3.html">/Source/AboutBox.h</option>
<option value="listing4.html">/Source/Blitter.c</option>
<option value="listing5.html">/Source/Blitter.h</option>
<option value="listing6.html">/Source/CD_Utils.c</option>
<option value="listing7.html">/Source/CD_Utils.h</option>
<option value="listing8.html">/Source/CommonStuff.c</option>
<option value="listing9.html">/Source/CommonStuff.h</option>
<option value="listing10.html">/Source/ErrorHandler.c</option>
<option value="listing11.html">/Source/ErrorHandler.h</option>
<option value="listing12.html">/Source/EventHandler.c</option>
<option value="listing13.html">/Source/EventHandler.h</option>
<option value="listing14.html">/Source/GameObject.c</option>
<option value="listing15.html">/Source/GameObject.h</option>
<option value="listing16.html">/Source/Graphics.c</option>
<option value="listing17.html">/Source/Graphics.h</option>
<option value="listing18.html">/Source/main.c</option>
<option value="listing19.html">/Source/MemoryHandler.c</option>
<option value="listing20.html">/Source/MemoryHandler.h</option>
<option value="listing21.html">/Source/MenuHandler.c</option>
<option value="listing22.html">/Source/MenuHandler.h</option>
<option value="listing23.html">/Source/MoviePlayback.c</option>
<option value="listing24.html">/Source/MoviePlayback.h</option>
<option value="listing25.html">/Source/NetSprocketSupport.c</option>
<option value="listing26.html">/Source/NetSprocketSupport.h</option>
<option value="listing27.html">/Source/ObjectActions.c</option>
<option value="listing28.html">/Source/ObjectActions.h</option>
<option value="listing29.html">/Source/Particles.c</option>
<option value="listing30.html">/Source/Particles.h</option>
<option value="listing31.html">/Source/SIResources.h</option>
<option value="listing32.html">/Source/SIâ€¢Prefix.h</option>
<option value="listing33.html">/Source/SoundHandler.c</option>
<option value="listing34.html">/Source/SoundHandler.h</option>
<option value="listing35.html">/Source/SpaceInvaders.c</option>
<option value="listing36.html">/Source/Sprite.c</option>
<option value="listing37.html">/Source/Sprite.h</option>
<option value="listing38.html">/Source/SprocketInvaders.c</option>
<option value="listing39.html">/Source/SprocketInvaders.h</option></select>
				</p>
				</form>
				<p><strong><a href="SprocketInvadersOld.zip">Download Sample</a></strong> (&#147;SprocketInvadersOld.zip&#148;, 178.4K)<BR>
<strong><a href="SprocketInvadersOld.dmg">Download Sample</a></strong> (&#147;SprocketInvadersOld.dmg&#148;, 235.8K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*  File:    SoundHandler.c  Contains:  xxx put contents here xxx  Version:  xxx put version here xxx  Copyright:  &copy; 1998-1999 by Apple Computer, Inc., all rights reserved.  File Ownership:    DRI:        Chris De Salvo    Other Contact:    xxx put other contact here xxx    Technology:      Apple Game Sprockets  Writers:    (cjd)  Chris De Salvo    (cjd)  Chris DeSalvo  Change History (most recent first):    &lt;SP12&gt;    7/1/99  cjd    The camera and the point of interest were set to the same point.                  Bad. So we now push in the Z of the POI and pull back the Z of                  the camera.    &lt;SP11&gt;   6/30/99  cjd    The camera and the point of interest were set to the same point.                  Bad. So we now push in the Z of the POI and pull back the Z of                  the camera.    &lt;SP10&gt;   1/21/99  cjd    Removing 68K conditional     &lt;9&gt;    7/1/98  cjd    Added SSp CPU load throttling*///*  ------------------------------------------------------------------------------------------  *//*//*  Copyright &copy; 1996 Apple Computer, Inc., All Rights Reserved//*//*//*    You may incorporate this sample code into your applications without//*    restriction, though the sample code has been provided &quot;AS IS&quot; and the//*    responsibility for its operation is 100% yours.  However, what you are//*    not permitted to do is to redistribute the source as &quot;DSC Sample Code&quot;//*    after having made changes. If you're going to re-distribute the source,//*    we require that you make it clear in the source that the code was//*    descended from Apple Sample Code, but that you've made changes.//*//*    Authors://*      Chris De Salvo//*      Tim Carroll//*//*  ------------------------------------------------------------------------------------------  *//*  ------------------------------  Includes#include &lt;Resources.h&gt;#include &lt;Sound.h&gt;#include &lt;SoundSprocket.h&gt;#include &lt;SoundComponents.h&gt;#include &lt;CodeFragments.h&gt;#include &quot;ErrorHandler.h&quot;#include &quot;EventHandler.h&quot;#include &quot;MemoryHandler.h&quot;#include &quot;SIResources.h&quot;#include &quot;SoundHandler.h&quot;//*  ------------------------------  Private Definitions//*  ------------------------------  Private Types//*  ------------------------------  Private Variablesstatic Boolean gSoundHandlerInit = false;static SndChannelPtr gChannels[soundNumSounds];static Handle gSounds[soundNumSounds];static SSpSourceReference gSource[soundNumSounds];static SSpListenerReference gListener;static Boolean gSoundSprocket = false;//*  ------------------------------  Private Functionsstatic void SetListenerLocation(const SInt32 inPOI_X, const SInt32 inPOI_Y);//*  ------------------------------  Public VariablesBoolean gSoundEffects = true;UInt32  gCPULoadModifier = 0;UInt32  gCPULoadMax = 0;UInt32  gCPUCurrentLoad = 0;//*  --------------------  SoundHandlerInitvoidSoundHandlerInit(void){UInt32  i;  gSoundSprocket = false;    //*  Allocate the sound channels for playback  for (i = 0; i &lt; soundNumSounds; i++)  {  OSErr  theErr;    theErr = SndNewChannel(&amp;gChannels[i], sampledSynth, initMono, nil);    if (theErr)      FatalError(&quot;Could not allocate enough sound channels.&quot;);  }  //*  Load the actual sound effects  for (i = 0; i &lt; soundNumSounds; i++)  {    gSounds[i] = GetResource('snd ', kSND_PlayerFire + i);    if (! gSounds[i])      FatalError(&quot;Could not load a required sound effect.&quot;);          DetachResource(gSounds[i]);  }  gSoundHandlerInit = true;  //*  If SoundSprocket is present then create a listener and set things up  if ((Ptr) SSpConfigureSpeakerSetup == (Ptr) kUnresolvedCFragSymbolAddress)  {    return;  // no sound sprocket  }  else    {  OSStatus  theErr = noErr;      theErr = SSpGetCPULoadLimit(&amp;gCPULoadMax);    if (noErr != theErr)    {      //*  If we couldn't figure out the number of steps then we'll      //*  just set the CPU load to zero every time.  This forces maximum quality.      gCPULoadModifier = 0;    }    else    {      gCPULoadModifier = 0xFFFFFFFF / (gCPULoadMax + 1);    }        //*  We have sound sprocket, so now we install the filters and create source and listener objects.      //*  Create the listener    theErr = SSpListener_New(&amp;gListener);    if (theErr)      FatalError(&quot;Could not create a sound sprocket listener.&quot;);      //*  Define our unit of distance measurement    theErr = SSpListener_SetMetersPerUnit(gListener, 0.05);    if (theErr)      FatalError (&quot;Could not set reference distance for listener.&quot;);      //*  Attach the sound localization component to each of the sound    //*  channels that we'll be playing through.    for (i = 0; i &lt; soundNumSounds; i++)    {    SoundComponentLink  myLink;            //*  Create the source      theErr = SSpSource_New(&amp;gSource[i]);      if (theErr)        FatalError(&quot;Could not create a sound sprocket source.&quot;);            //*  Install the filter      myLink.description.componentType = kSoundEffectsType;      myLink.description.componentSubType = kSSpLocalizationSubType;      myLink.description.componentManufacturer = 0;      myLink.description.componentFlags = 0;       myLink.description.componentFlagsMask = 0;      myLink.mixerID = nil;       myLink.linkID = nil;            theErr = SndSetInfo(gChannels[i], siPreMixerSoundComponent, &amp;myLink);       if (theErr)          FatalError(&quot;Could not install the sound sprocket filter into the channel.&quot;);    }        gSoundSprocket = true;    SetListenerLocation(320, 240);  }}//*  --------------------  SoundHandlerResetvoidSoundHandlerReset(void){UInt32  i;  if (! gSoundHandlerInit)    return;  //*  Deallocate the sound channels  for (i = 0; i &lt; soundNumSounds; i++)  {    if (gChannels[i])    {      SndDisposeChannel(gChannels[i], true);      gChannels[i] = nil;    }  }  //*  Unload the actual sound effects  for (i = 0; i &lt; soundNumSounds; i++)  {    if (gSounds[i])      DisposeHandleZ(&amp;gSounds[i]);  }}//*  --------------------  SoundHandlerPlayvoidSoundHandlerPlay(GameSounds theSound, short x, short y){SndCommand  theCommand;OSStatus  theErr = noErr;  //*  Make sure that sound effects are turned on  if (! gSoundEffects)    return;  //*  Make sure we are initialized  if (! gSoundHandlerInit)    return;  //*  Make sure the requested sound is within the range of valid effects  if (theSound &lt; 0 || theSound &gt;= soundNumSounds)    return;  //*  Stop playback of any sound currently playing on this channel  theCommand.cmd = quietCmd;  SndDoImmediate(gChannels[theSound], &amp;theCommand);  //*  Flush out any queued sounds waiting to play on this channel  theCommand.cmd = flushCmd;  SndDoImmediate(gChannels[theSound], &amp;theCommand);  //* If we're using SoundSprocket then set up the location parameters  //*  for the localization filter  if (gSoundSprocket)  {  TQ3CameraPlacement  location;  SSpLocalizationData  localization;      //*  We want all the sounds to be localized, but when we explode we want to hear it    //*  all around us.    if (soundPlayerHit != theSound)      SSpSource_SetMode(gSource[theSound], kSSpSourceMode_Localized);    else      SSpSource_SetMode(gSource[theSound], kSSpSourceMode_Ambient);    //*  Allow the user to dynamically set the CPU usage range for SSp    SSpSource_SetCPULoad(gSource[theSound], gCPUCurrentLoad);    //*  Make sure that the listener is listening at this sound    SetListenerLocation(320 - x, 240 - y);    //*  Position the sound in space.    location.cameraLocation.x = 320 - x;    location.cameraLocation.y = 240 - y;    location.cameraLocation.z = 0;        //*  Orient the sound so that it is down directed down towards the listener    location.pointOfInterest.x = 0;    location.pointOfInterest.y = -1;    location.pointOfInterest.z = -1;      location.upVector.x = 0;    location.upVector.y = 1;    location.upVector.z = 0;      theErr = SSpSource_SetCameraPlacement (gSource[theSound], &amp;location);    if (theErr)      FatalError (&quot;Failed to set the source location&quot;);          theErr = SSpSource_CalcLocalization (gSource[theSound], gListener, &amp;localization);    if (theErr)      FatalError (&quot;Failed to calculate the localization&quot;);        // We don't do doppler, since we only localize the sound at the instant it is played.    localization.currentLocation.sourceVelocity = 0;    localization.currentLocation.listenerVelocity = 0;        // We set the reference distance to a reasonable number that seems to get good results    // We also provide a minimum distance or else we run into really LOUD, really CLIPPED sounds    localization.referenceDistance = 20.0;    if (localization.currentLocation.distance &lt; 5.0)      localization.currentLocation.distance = 5.0;    theErr = SndSetInfo (gChannels[theSound], siSSpLocalization, &amp;localization);    if (theErr)      FatalError(&quot;Failed to localize the channel&quot;);  }  //*  Play the selected sound immediately  theErr = SndPlay(gChannels[theSound], (SndListHandle) gSounds[theSound], true);  if (theErr)    FatalError(&quot;Failed to start sound in SndPlay().&quot;);}//*  --------------------  SetListenerLocationstatic voidSetListenerLocation(const SInt32 inPOI_X, const SInt32 inPOI_Y){OSStatus      theErr = noErr;TQ3CameraPlacement  location;  if (! gSoundSprocket)    return;  //*  Set the listener in the bottom middle of the screen  location.cameraLocation.x = 320;  location.cameraLocation.y = 240;  location.cameraLocation.z = -10;  //*  Focus the listener's attention on the exact middle of the screen  location.pointOfInterest.x = inPOI_X;  location.pointOfInterest.y = inPOI_Y;  location.pointOfInterest.z = 0;    location.upVector.x = 0;  location.upVector.y = 1;  location.upVector.z = 0;    theErr = SSpListener_SetCameraPlacement (gListener, &amp;location);  if (theErr)    FatalError (&quot;Failed to set the listener location&quot;);}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/SprocketInvadersOld/listing33.html%3Fid%3DDTS10000061-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/SprocketInvadersOld/listing33.html%3Fid%3DDTS10000061-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/SprocketInvadersOld/listing33.html%3Fid%3DDTS10000061-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>