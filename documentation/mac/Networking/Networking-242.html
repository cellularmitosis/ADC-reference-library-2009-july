<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>The LAP Manager and 802.2 Protocol Packets(IM:N)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING242></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Networking-241.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-243.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Networking-2.html"><B>Networking</B></A> / <BR><DD><A HREF="Networking-235.html"><B>Chapter 10 - Link-Access Protocol (LAP) Manager</B></A> / <A HREF="Networking-237.html"><B>Using the LAP Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING242-0></A>
<H2><A NAME=MARKER-9-162></A><A NAME=MARKER-21-163></A>The LAP Manager and 802.2 Protocol<A NAME=MARKER-2-31></A> Packets<A NAME=MARKER-2-166></A></H2>
 <A NAME=MARKER-2-88></A>The <A NAME=MARKER-2-89></A>Institute of E<A NAME=MARKER-2-46></A>lectrical and Electronics <A NAME=MARKER-2-91></A>Engineers (IEEE) has defined a series <A NAME=MARKER-2-40></A>of <A NAME=MARKER-2-42></A>communications protocols for use on a variety of networks. At the physical level, these protocols include the<A NAME=MARKER-2-19></A> 802.3 CSMA/CD protocol, the 802.4 token bus protocol, and the <A NAME=MARKER-2-95></A>802.5 token ring protocol. At the data-link level, you access these protocols through the IEEE 802.2 <A NAME=MARKER-2-95></A>Logical Link Control (LLC) protocol. I<A NAME=MARKER-2-97></A>f you write an application that handles 802.2 Type 1 data packets,<A NAME=MARKER-9-24></A> you must include a protocol handler to read the data. You can install your application as a client of the LAP Manager to receive 802.2 packets from an Ethernet, token ring, or FDDI driver.<P>
 The LAP Manager includes two routines that allow you to attach and detach protocol handlers for 802.2 Type 1 data packets: the<A NAME=MARKER-9-148></A> <CODE>L802Attach</CODE> and <A NAME=MARKER-2-172></A><CODE>L802Detach</CODE> routines. The LAP Manager contains a generic protocol handler that receives data from the hardware device drivers and determines for which application the 802.2 packet is meant based <BR>on the protocol type. The LAP Manager's protocol handler then calls the destination application's protocol handler to read in the data. This section uses Ethernet to <BR>illustrate how this process works; however, the same process applies to token ring and <BR>FDDI packets.<A NAME=MARKER-2-101></A><P>
 The ANSI/IEEE standards for the 802 protocols are published by the IEEE. <A NAME=MARKER-2-54></A>The first <BR>14 bytes of a packet sent or received by the .ENET driver constitute the header. The first 12 bytes consist of the destination and source data-link addresses, such as the Ethernet hardware addresses. If the value of the last 2 bytes in the header is greater than 1500, then the .ENET driver treats that field as an Ethernet protocol type discriminator; this indicates that the packet is an Ethernet Phase 1 packet. If the value of the last 2 bytes in the header is less than or equal to 1500, then the field contains the length of the 802.2 packet, not including the 14-byte header, and this indicates that the packet is an Ethernet Phase 2 packet. <A NAME=MARKER-2-103></A>The .ENET driver passes all Phase 2 packets to the LAP Manager.<P>
 The IEEE LLC standard defines the concept of a Service Access Point (SAP). A SAP is a 1-byte value that is used to distinguish the different protocols using 802.2 in a single node. Most SAPs are reserved for use by IEEE standard protocols. IEEE has reserved one SAP, whose value is $AA, for use by protocols other than the standard IEEE protocols. AppleTalk and many other protocol families use SAP $AA. Because other protocol families can also use this SAP, the value of another field that contains the <B>subnetwork access protocol (SNAP)</B> type<B> </B>is used to discriminate for which protocol family a packet with a destination subnetwork access protocol value of $AA is intended.<P>
 At the physical level, a packet contains the 802.3 header, <A NAME=MARKER-2-68></A>the data field of which contains either an Ethernet protocol type discriminator (for Phase 1 packets) or the 802.2 packet length (for Phase 2 packets). For all Phase 2 packets,<A NAME=MARKER-2-121></A><A NAME=MARKER-2-78></A><A NAME=MARKER-2-142></A> the LAP Manager receives the entire 802.3 packet from the .ENET driver. The first 14 bytes of the 802.3 data constitute the frame header, and they are followed by the 802.2 protocol header. <P>
 The first byte of the 802.2 header is the <B>destination service access point (DSAP).</B> If the DSAP value is equal to $AA, then the first 5 bytes of the 802.2 data constitute a SNAP protocol type discriminator. If the SNAP type value is $00000080F3, indicating the AppleTalk Address Resolution Protocol (AARP), then the next 4 bytes of the 802.2 data constitute the AARP packet type field. AARP is not discussed at length in this book; for complete information about AARP, see <I>Inside AppleTalk,</I> second edition.<A NAME=MARKER-2-6></A><A NAME=MARKER-2-59></A><A NAME=MARKER-2-23></A><P>
 <A NAME=MARKER-2-111></A><A HREF=#MARKER-9-112>Figure 10-2</A> shows an Ethernet packet containing AppleTalk Phase 1 data. Phase 1 packets are the original version of Ethernet packets. The last 2 bytes in the header contain a value greater than 1500, indicating that this field is to be treated as a <BR>protocol type discriminator. <P>
<B>Figure 10-2  <A NAME=MARKER-9-112></A>Ethernet Phase 1 packet formats</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/LAP-L-02.jpg"><P>
 <A HREF=#MARKER-9-113>Figure 10-3</A> shows two Phase 2 packets. For Phase 2 packets, the last 2 bytes of the <BR>802.3 header contain the 802.2 packet length, not including the 14-byte header; the <BR>802.2 packet length is a value from 0 through 1500.<P>
 The data frame on the left shows an Ethernet 802.3 packet containing an 802.2 packet that holds AppleTalk Phase 2 data. The Ethernet driver would deliver this entire packet to the LAP Manager; the 802.2 packet is enclosed in the 802.3 packet, which is also referred to as a frame. The data frame on the right shows an Ethernet 802.3 packet containing an 802.2 packet to be delivered to the Phase 2 Ethernet AARP handler; <BR>the SNAP type value is $00000080F3, indicating the AppleTalk Address Resolution <BR>Protocol (AARP).<P>
<B>Figure 10-3  <A NAME=MARKER-9-113></A><A NAME=MARKER-21-114></A>Ethernet Phase 2 packet formats</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/LAP-L-03.jpg"><P>
 When you call the <CODE>L802Attach</CODE> routine, <A NAME=MARKER-2-152></A>you provide a pointer to your protocol handler, the reference number of the .ENET driver, and a pointer to a string containing one or more type fields. The type fields indicate the DSAP value and any other protocol type fields (such as the SNAP type and the AARP type). The LAP Manager delivers to your protocol handler <A NAME=MARKER-2-116></A>any 802.2 data packets that have t<A NAME=MARKER-2-41></A>he protocol type you specify. <A NAME=MARKER-2-7></A><P>
<A NAME=HEADING242-15></A>
<H3><A NAME=MARKER-21-164></A>Attaching and Detaching 802.2 Protocol Handlers</H3>
 You must use the LAP Manager to attach your protocol handler for 802.2 protocols to receive Ethernet Phase 2 packets and all token ring and FDDI packets. <P>
 The LAP Manager is designed to install a generic protocol handler that receives packets from the hardware device drivers for 802.2 protocols and that also serves as a dispatcher. The LAP Manager's protocol handler maintains an index of registered protocol types and pointers to their protocol handlers. When an application calls the LAP Manager to attach a protocol handler, the LAP Manager adds an entry for the application's protocol type and protocol handler to its protocol handler index. <P>
 The LAP Manager's protocol handler determines for which application data is meant. When processing a packet, the LAP Manager reads the destination SAP; if the SAP value is $AA, the LAP Manager then checks the SNAP header for the protocol type, and then it searches for a protocol type match in its protocol handler index. If the LAP Manager finds a protocol type match, it calls the destination application's protocol handler to read in the data. You cannot replace or override the permanent LAP Manager protocol handler. <P>
 The first time that a process or application calls the LAP Manager to attach a protocol handler for 802.2 packets, the LAP Manager calls the specified hardware device driver directly to install its own generic protocol handler. The LAP Manager then registers in its index the protocol handler and the protocol type for the process that initially called it. When a process or application subsequently calls the LAP Manager to attach a protocol handler to receive 802.2 packets from the same type of hardware device driver, the LAP Manager simply adds the protocol handler and protocol type information for that process to its index. <P>
 The LAP Manager allows for the concurrent use of hardware device drivers by more than one application. For example, <A HREF=#MARKER-9-121>Figure 10-4</A> shows three scenarios. In the first instance at the top of the figure, only AppleTalk is using the Ethernet driver to receive data; AppleTalk always uses the LAP Manager, which provides for its link independence. <P>
 In the second instance in the middle of the figure, both AppleTalk and a developer-<BR>written application have attached their protocol handlers to the LAP Manager. AppleTalk is configured to use the Ethernet driver; when the LAP Manager's protocol handler reads a packet, it determines if the data is meant for AppleTalk, and if so, the LAP Manager calls the DDP protocol handler to receive the data. If the data is meant <BR>for the other application, the LAP Manager calls that application's protocol handler. <P>
 In the third instance at the bottom of the figure, both AppleTalk and the developer-<BR>written application have attached their protocol handlers to the LAP Manager to receive data from the token ring driver. The LAP Manager receives the data, determines the destination, then calls the appropriate protocol handler, either the DDP protocol handler or the developer-written application's protocol handler to receive the data.<A NAME=MARKER-2-33></A> <P>
<B>Figure 10-4  <B><A NAME=MARKER-9-121></A></B>Using the LAP Manager to receive data for 802.2 protocols</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/LAP-L-15.jpg"><P>
 There are no high-level interfaces for the LAP Manager 802.2 protocol routines. You call these routines from assembly language by placing a routine selector in the D0 register and executing a JSR instruction to an offset 2 bytes past the start of the LAP Manager. The start of the LAP Manager is contained in the global variable <CODE>LAPMgrPtr</CODE> ($B18). <P>
 Before you call these routines, you must place the reference number of the .ENET driver in the D2 register and a pointer to the protocol type specification in the A1 register. Before you call the <CODE>L802Attach</CODE> routine, you must also place a pointer to your protocol handler in the A0 register. Both routines return a nonzero value in the D0 register if there is an error. <P>
 <A HREF=#MARKER-9-122>Listing 10-7</A> shows how to call either the LAP Manager's <CODE>L802Attach</CODE> or <CODE>L802Detach </CODE>routine from assembly language. To specify either of these routines, you place the routine selector in register D0, as indicated in the sample code.<P>
<B>Listing 10-7  <A NAME=MARKER-9-122></A><A NAME=MARKER-21-123></A>Calling a LAP Manager 802.2 routine from assembly language</B><P>
<PRE>
LAPMgrPtr   EQU      $B18           ;entry point for LAP Manager
LAPMgrCall  EQU      2              ;offset to LAP Manager 
                                    ; routines
L802Entry   EQU      *              ;802 routine entry

            MOVEQ    #RSel,D0       ;place the routine selector 
                                    ; in D0
            MOVEQ    #refNum,D2     ;place the driver reference
                                    ; number in D2
            MOVE.L   PHndlrPtr,A0   ;put pointer to protocol 
                                    ; handler in A0 (L802Attach 
                                    ; only)
            MOVE.L   PSpecPtr,A1    ;put pointer to protocol 
                                    ; specification in A1
            MOVE.L   LAPMgrPtr,An   ;put pointer to LAP Mgr in An
            JSR      LAPMgrCall(An) ;jump to start of LAP Mgr
                                    ; routines
</PRE>
 For information on the protocol type specification whose pointer<A NAME=MARKER-2-181></A> you place in register A1, see <A NAME=MARKER-2-29></A><A HREF=Networking-254.html#MARKER-9-170>"L802Attach" beginning on page 10-33</A>.<A NAME=MARKER-2-83></A><P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Networking-241.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-243.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Networking-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
