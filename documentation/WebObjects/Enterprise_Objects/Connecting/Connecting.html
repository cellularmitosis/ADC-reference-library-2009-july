<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>WebObjects Enterprise Objects Programming Guide: Connecting to a Database</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Connecting to a Database"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30001011-CH210" title="Connecting to a Database"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../InternetWeb/index.html#//apple_ref/doc/uid/TP30000440-TP30000469" target="_top">Internet &amp; Web</a> &gt; <a href="../../../InternetWeb/WebObjects-date.html#//apple_ref/doc/uid/TP30000440-TP30000469-TP30000592" target="_top">WebObjects</a> &gt; <a href="../About/About.html#//apple_ref/doc/uid/TP30001011-CH201-DontLinkElementID_1">WebObjects Enterprise Objects Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../UpdateStrategies/UpdateStrategies.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../Concurrency/Concurrency.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_19" title="Connecting to a Database"></a><h1><a name="//apple_ref/doc/uid/TP30001011-CH210-TP1" title="Connecting to a Database"></a>Connecting to a Database</h1><p><a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_272"></a>This chapter describes how an Enterprise Objects application connects to a database and how you can take control of this process. You may want to manually connect to a database for a few reasons:</p><ul class="ul"><li class="li"><p>Your application has an audit tracking requirement.</p></li><li class="li"><p>Different users have different levels of access to the database.</p></li><li class="li"><p>You need to better secure database login information.</p></li><li class="li"><p>You need to limit the number of open connections to a database.</p></li></ul><p>This chapter is divided into the following sections:</p><ul class="ul"><li class="li"><p><span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-TPXREF139">“Objects Involved in a Database Connection”</a></span> describes the objects involved in connecting to a data source.</p></li><li class="li"><p><span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-TPXREF140">“When Database Connections Are Opened”</a></span> discusses when database connections are opened and how they are reused.</p></li><li class="li"><p><span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-BEDFGDGE">“When Database Connections Are Closed”</a></span> discusses when database connections are closed and how to take control of this mechanism.</p></li><li class="li"><p><span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-TPXREF141">“Connection Dictionary”</a></span> describes the connection dictionary that Enterprise Objects uses to connect to a data source and the different ways to provide it.</p></li><li class="li"><p><span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-BEDGACFF">“Database Channels”</a></span> discusses the default configuration of database channels in Enterprise Objects and how to customize it.</p></li><li class="li"><p><span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-BIECIIHH">“Connecting to Multiple Data Stores”</a></span> discusses Enterprise Object’s support for accessing multiple data sources in an application.</p></li><li class="li"><p><span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-TPXREF144">“Providing a Connection Dictionary in Code”</a></span> tells you how to provide a connection dictionary programmatically.</p></li><li class="li"><p><span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-TPXREF145">“Providing Multiple Database Channels”</a></span> tells you how to provide multiple database channels in an application.</p></li><li class="li"><p><span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-TPXREF146">“Closing Database Channels”</a></span> tells you how to monitor the number of open database channels and close them as needed.</p></li></ul><a name="//apple_ref/doc/uid/TP30001011-CH210-TPXREF139" title="Objects Involved in a Database Connection"></a><h2>Objects Involved in a Database Connection</h2><p>This section provides a high-level overview of the objects involved in an Enterprise Objects database connection. For more specific information, see the API reference for the classes mentioned here.</p><p>The highest-level object in an Enterprise Objects database transaction is an EODatabase object. This object represents a single database server so your application has as many EODatabase objects as the databases to which it connects. An EODatabase object communicates with an EOAdaptor object that is capable of communicating with a database server.</p><p>Each EODatabase contains at least one EODatabaseContext object. Each EODatabaseContext forms a separate transaction scope to a database using an EODatabaseChannel object (which itself uses an EOAdaptorChannel object). Each EODatabaseContext uses one or more EODatabaseChannel objects.</p><p><span class="content_text">Figure 10-1</span> illustrates the scenario in which an EODatabase manages a single EODatabaseContext object and the database context uses a single database channel.</p><br/><div><a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_20" title="Figure 9-1EODatabaseContext managing a single database channel"></a><p><a name="//apple_ref/doc/uid/TP30001011-CH210-BEDDFJFF" title="Figure 9-1EODatabaseContext managing a single database channel"></a><strong>Figure 9-1&nbsp;&nbsp;</strong>EODatabaseContext managing a single database channel</p><img src = "../Art/onedbchannel.gif" alt = "EODatabaseContext managing a single database channel" width="262" height="204"></div><br/><p>By default, an EODatabaseContext uses a single EODatabaseChannel but in <span class="content_text">Figure 10-2</span>, the database context is shown using two database channels. Each database channel is always associated with exactly one set of adaptor<a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_273"></a> objects (an EOAdaptor, an EOAdaptorContext, and an EOAdaptorChannel), as <span class="content_text">Figure 10-2</span> illustrates.</p><br/><div><a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_21" title="Figure 9-2One database context using two database channels"></a><p><a name="//apple_ref/doc/uid/TP30001011-CH210-BEDCBHGH" title="Figure 9-2One database context using two database channels"></a><strong>Figure 9-2&nbsp;&nbsp;</strong>One database context using two database channels</p><img src = "../Art/twodbchannels.gif" alt = "One database context using two database channels" width="464" height="205"></div><br/><p>If the database server an EODatabase object represents supports multiple concurrent transaction sessions, that EODatabase may have several EODatabaseContexts. If the adaptor allows multiple channels per context, then an EODatabaseContext may in turn have several EODatabaseChannels, which handle actual access to the database. </p><p>The rest of this chapter describes how these objects are used by Enterprise Objects to connect to a database and how you can take control of the connection.</p><a name="//apple_ref/doc/uid/TP30001011-CH210-TPXREF140" title="When Database Connections Are Opened"></a><h2>When Database Connections Are Opened</h2><p><a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_274"></a>You usually never have to worry about opening database connections programmatically—Enterprise Objects takes care of it for you. The first time any editing context in your application initiates a database operation, a connection to the database is opened by the access layer<a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_275"></a>. Enterprise Objects reuses that same connection for all subsequent database operations to that particular database. If your application accesses multiple databases, a separate database connection is opened for each database.</p><a name="//apple_ref/doc/uid/TP30001011-CH210-BEDFGDGE" title="When Database Connections Are Closed"></a><h2>When Database Connections Are Closed</h2><p>Enterprise Objects doesn’t close its connections to databases until the application terminates. It reuses open connections so by default it uses a minimum number of connections and you don’t need to limit the number of connections. However, there are situations in which you may want to close connections when they aren’t in use. These situations are rare and usually result when many copies of an application connect to the same database or if you add more database channels as described in <span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-BEDGACFF">“Database Channels”</a></span> and the database can’t handle more than a certain number of database connections. </p><p>If you’re concerned about the number of open database channels in a particular application, it’s probably best to set a timer in your application and attempt to close open database connections at a specified time. Before closing an open database channel, you should make sure that channel isn’t performing an operation. See <span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-TPXREF146">“Closing Database Channels”</a></span> to learn how to close database channels on demand<a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_276"></a>.</p><a name="//apple_ref/doc/uid/TP30001011-CH210-TPXREF141" title="Connection Dictionary"></a><h2>Connection Dictionary</h2><p><a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_277"></a>Enterprise Objects uses an EOAdaptor object to connect and log in to a database. WebObjects 5.2 provide two adaptors: one for JDBC data sources and one for JNDI data sources. An adaptor uses a <strong>connection dictionary</strong> to identify the address of the database and to provide login credentials.</p><p>When you’re developing an Enterprise Objects application, you usually supply the connection dictionary information in the EOModel files the application uses. While this is convenient during development, it may not be adequate for deployed applications. Instead, you may need to provide the connection dictionary programmatically. The following sections describe the two ways to provide connection dictionary information to an application.</p><a name="//apple_ref/doc/uid/TP30001011-CH210-TPXREF142" title="Storing in a Model File"></a><h3>Storing in a Model File</h3><a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_278"></a><p>When you create a new EOModel file, you are prompted to provide login information for the data source to which that model connects. The window that asks for this information is shown in <span class="content_text">Figure 10-3</span>.</p><br/><div><a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_22" title="Figure 9-3Connection dictionary window in EOModeler"></a><p><a name="//apple_ref/doc/uid/TP30001011-CH210-BEDFJEAH" title="Figure 9-3Connection dictionary window in EOModeler"></a><strong>Figure 9-3&nbsp;&nbsp;</strong>Connection dictionary window in EOModeler</p><img src = "../Art/eomjdbcconnectdialog.gif" alt = "Connection dictionary window in EOModeler" width="410" height="259"></div><br/><p>The information you provide in this window becomes the model file’s connection dictionary. The connection dictionary is stored in the model file and doesn’t require you to write any code to use it. This approach is useful when all users of the application log in to the database with the same connection information and when the login information is not regarded as sensitive. </p><p>However, if you need to provide users with different database connection information or if you still want to allow all users to share the same credentials but you want to secure those credentials, you need to provide some of the connection dictionary information programmatically. You can still provide nonsensitive connection information in the model, such as the database URL, driver, and plug-in, and just provide login credentials programmatically. </p><p>Providing the connection dictionary programmatically (or even just part of the connection dictionary) requires more code on your part, so you should do it only if you really need to. <span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-BEDGBJJC">“Storing in Code”</a></span> tells you how to provide the connection dictionary programmatically.</p><p>All EOAdaptor objects that Enterprise Objects creates automatically use the connection dictionary information specified in the model. If you instantiate an adaptor programmatically, however, it doesn’t automatically use the model’s connection dictionary information, so you have to provide it programmatically.</p><a name="//apple_ref/doc/uid/TP30001011-CH210-BEDGBJJC" title="Storing in Code"></a><h3>Storing in Code</h3><a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_279"></a><a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_280"></a><p>For any number of reasons, you may need to provide all or part of an EOAdaptor’s connection dictionary programmatically. To do this, you first need to identify the dictionary’s keys so you can set their values. </p><p>The following code prints the connection dictionary keys of the Real Estate model:</p><div class="codesample"><table><tr><td scope="row"><pre>EOModel model = EOModelGroup.defaultGroup().modelNamed("RealEstate");<span></span></pre></td></tr><tr><td scope="row"><pre>NSLog.out.appendln("connection dictionary keys: " +     model.connectionDictionary().allKeys());<span></span></pre></td></tr></table></div><p>The output of this code is: </p><p><code>connection dictionary keys: ("plugin", "jdbc2Info", "username", "driver", "password", "URL")</code></p><p>Now that you know the names of the connection dictionary’s keys, you need to set the values for some of them. You don’t need to set the values for all of the keys, only for the keys you care about. When you force a model to use a new connection dictionary with the method discussed below, only the keys for which you explicitly set values are overridden. So if, for example, the original connection dictionary in the model specifies the database URL and you don’t provide a value for that key in the dictionary of overrides, the value in the model’s dictionary is still used even after you’ve provided an updated connection dictionary.</p><p>Where in an application’s execution should you set the values? It depends on your application’s requirements. If you provide each user with an independent connection to the database by giving each user a separate stack as described in <span class="content_text"><a href="../Geography/Geography.html#//apple_ref/doc/uid/TP30001011-CH205-TPXREF146">“Providing Separate Stacks,”</a></span> you should first get a user’s database username and password and then set the values of the connection dictionary before instantiating the stack. After you set the values in the connection dictionary but before you instantiate a stack for each user, you need to invoke the method <code>EODatabaseContext.forceConnectionWithModel<a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_281"></a></code>. You pass to this method as arguments an EOModel object, a connection dictionary of keys to override with the values you supply programmatically, and an editing context.</p><p>The code in <span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-TPXREF144">“Providing a Connection Dictionary in Code”</a></span> shows all these steps<a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_282"></a>.</p><a name="//apple_ref/doc/uid/TP30001011-CH210-BIECIIHH" title="Connecting to Multiple Data Stores"></a><h2>Connecting to Multiple Data Stores</h2><p>Enterprise Objects makes it easy to work with multiple data stores in a single application. An application often includes enterprise object instances that represent data from different repositories. </p><p>The EOObjectStoreCoordinator is the object that manages multiple repositories in a single application. When a fetch is performed, it determines which repository can service the fetch. Similarly, when changes are committed, it determines which repository to save the changes to. When a fault is fired, it determines which repository can service the fault. And, Enterprise Objects is smart enough to generate database-specific or database-optimized SQL expressions within a single application that connects to multiple repositories.</p><p>There are, however, a few limitations when using multiple data sources in an application. They include:</p><ul class="ul"><li class="li"><p>Within an EOModelGroup, all entity names must be unique.</p></li><li class="li"><p>You can’t model inheritance hierarchies across different data sources.</p></li><li class="li"><p>You can’t flatten attributes or relationships across data sources.</p></li><li class="li"><p>Enterprise Objects doesn’t support two-phase commit, so you have to be careful when a saving enterprise objects that are constituted from different data sources in a single invocation of <code>EOEditingContext.saveChanges()</code>.</p></li></ul><p>If you understand these limitations, connecting to multiple data stores in an Enterprise Objects application should just work.</p><a name="//apple_ref/doc/uid/TP30001011-CH210-BEDGACFF" title="Database Channels"></a><h2>Database Channels</h2><p>The default configuration of the Enterprise Objects core stack provides only a single database channel<a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_283"></a>, regardless of the number of transactions a particular Enterprise Objects stack makes. The default behavior is usually sufficient but certain applications and configurations may benefit from using multiple database channels.</p><p>Conflicts within Enterprise Objects due to busy database channels may occur when a database context needs to perform an operation and its database channel is already busy with another operation such as fetching. Most of these types of conflicts are the result of inefficient fetching, such as when faults are inadvertently fired while other database operations are in progress, and can be avoided.</p><p>When an EODatabaseContext needs a new channel because all its current channels are busy, it posts an EODatabaseChannelNeededNotification. You can create database channels on demand by registering for this notification and providing an additional channel at that time. In the method you write to create database channels, you should set an upper limit on the number of channels that can be registered with a particular database context. It’s very unusual for an EODatabaseContext to require more than two or three EODatabaseChannels. See <span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-TPXREF145">“Providing Multiple Database Channels”</a></span> to learn how to add additional database channels to an application.</p><a name="//apple_ref/doc/uid/TP30001011-CH210-TPXREF144" title="Providing a Connection Dictionary in Code"></a><h2>Providing a Connection Dictionary in Code</h2><p>The code in <span class="content_text">Listing 10-1</span> provides a connection dictionary programmatically using the procedure discussed in <span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-BEDGBJJC">“Storing in Code.”</a></span></p><a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_23" title="Listing 9-1Setting connection dictionary programmatically"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30001011-CH210-BEDCJCBD" title="Listing 9-1Setting connection dictionary programmatically"></a><strong>Listing 9-1&nbsp;&nbsp;</strong>Setting connection dictionary programmatically</p><div class="codesample"><table><tr><td scope="row"><pre>EOModel model = EOModelGroup.defaultGroup().modelNamed("RealEstate");<span></span></pre></td></tr><tr><td scope="row"><pre>NSLog.out.appendln("connection dictionary keys:" +      model.connectionDictionary().allKeys());<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>NSMutableDictionary overrides = new NSMutableDictionary();<span></span></pre></td></tr><tr><td scope="row"><pre>overrides.takeValueForKey("brent", "username");<span></span></pre></td></tr><tr><td scope="row"><pre>overrides.takeValueForKey("secret", "password");<span></span></pre></td></tr><tr><td scope="row"><pre>EODatabaseContext.forceConnectionWithModel(model, overrides, new EOEditingContext());<span></span></pre></td></tr></table></div>	<a name="//apple_ref/doc/uid/TP30001011-CH210-TPXREF145" title="Providing Multiple Database Channels"></a><h2>Providing Multiple Database Channels</h2><p>To create and register a new database channel with a particular database context, you can use the code in <span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-BEDGDDID">Listing 10-2</a></span>. It’s probably most appropriate to put this code in your Session class, as this listing does. The code listing also shows how to register for the notification that EODatabaseContext posts when it needs another database channel.</p><a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_24" title="Listing 9-2Creating and registering a new database channel"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30001011-CH210-BEDGDDID" title="Listing 9-2Creating and registering a new database channel"></a><strong>Listing 9-2&nbsp;&nbsp;</strong>Creating and registering a new database channel</p><div class="codesample"><table><tr><td scope="row"><pre>import com.webobjects.foundation.*;<span></span></pre></td></tr><tr><td scope="row"><pre>import com.webobjects.appserver.*;<span></span></pre></td></tr><tr><td scope="row"><pre>import com.webobjects.eocontrol.*;<span></span></pre></td></tr><tr><td scope="row"><pre>import com.webobjects.eoaccess.*;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>public class Session extends WOSession {<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    private final int DatabaseChannelCountMax = 3;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    public Session() {<span></span></pre></td></tr><tr><td scope="row"><pre>        super();<span></span></pre></td></tr><tr><td scope="row"><pre>        NSNotificationCenter.defaultCenter().addObserver(this, new<span></span></pre></td></tr><tr><td scope="row"><pre>            NSSelector("registerNewDatabaseChannel",<span></span></pre></td></tr><tr><td scope="row"><pre>            new Class[] { NSNotification.class } ),<span></span></pre></td></tr><tr><td scope="row"><pre>            EODatabaseContext.DatabaseChannelNeededNotification, null);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    public void registerNewDatabaseChannel(NSNotification notification) {<span></span></pre></td></tr><tr><td scope="row"><pre>        EODatabaseContext databaseContext = (EODatabaseContext)notification.object();<span></span></pre></td></tr><tr><td scope="row"><pre>        if (databaseContext.registeredChannels().count() &lt; DatabaseChannelCountMax){<span></span></pre></td></tr><tr><td scope="row"><pre>            EODatabaseChannel channel = new EODatabaseChannel(databaseContext);<span></span></pre></td></tr><tr><td scope="row"><pre>            databaseContext.registerChannel(channel);<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>	<p>If you create database channels programmatically on a per-session basis, you may end up with a large number of database channels per application instance. <span class="content_text"><a href="Connecting.html#//apple_ref/doc/uid/TP30001011-CH210-BEDFGDGE">“When Database Connections Are Closed”</a></span> describes how to check for and close extraneous database connections.</p><a name="//apple_ref/doc/uid/TP30001011-CH210-TPXREF146" title="Closing Database Channels"></a><h2>Closing Database Channels</h2><p>The code in <span class="content_text">Listing 10-3</span> demonstrates how to close an application’s database connections<a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_284"></a> at a recurring interval. The <code>closeDatabaseChannels</code><a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_285"></a> method assumes that the application has only one object store coordinator (per-session object store coordinators are not used) and that all of the cooperating object stores managed by the coordinator are database contexts, which is the usual case<a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_286"></a>.</p><a name="//apple_ref/doc/uid/TP30001011-CH210-DontLinkElementID_25" title="Listing 9-3Close database channels at a specified interval"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30001011-CH210-BEDJAJED" title="Listing 9-3Close database channels at a specified interval"></a><strong>Listing 9-3&nbsp;&nbsp;</strong>Close database channels at a specified interval</p><div class="codesample"><table><tr><td scope="row"><pre>import com.webobjects.foundation.*;<span></span></pre></td></tr><tr><td scope="row"><pre>import com.webobjects.appserver.*;<span></span></pre></td></tr><tr><td scope="row"><pre>import com.webobjects.eocontrol.*;<span></span></pre></td></tr><tr><td scope="row"><pre>import com.webobjects.eoaccess.*;<span></span></pre></td></tr><tr><td scope="row"><pre>import java.util.*;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>public class Application extends WOApplication {<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    public static void main(String argv[]) {<span></span></pre></td></tr><tr><td scope="row"><pre>        WOApplication.main(argv, Application.class);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    public Application() {<span></span></pre></td></tr><tr><td scope="row"><pre>        super();<span></span></pre></td></tr><tr><td scope="row"><pre>        System.out.println("Welcome to " + this.name() + "!");<span></span></pre></td></tr><tr><td scope="row"><pre>        setupDatabaseChannelCloserTimer();<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    public void setupDatabaseChannelCloserTimer() {<span></span></pre></td></tr><tr><td scope="row"><pre>        Timer timer = new Timer(true);<span></span></pre></td></tr><tr><td scope="row"><pre>        //Close open database connections every four hours.<span></span></pre></td></tr><tr><td scope="row"><pre>        timer.scheduleAtFixedRate(new DBChannelCloserTask(), new Date(), 14400);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    class DBChannelCloserTask extends TimerTask {<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     public DBChannelCloserTask() {<span></span></pre></td></tr><tr><td scope="row"><pre>      super();<span></span></pre></td></tr><tr><td scope="row"><pre>     }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>      public void run() {<span></span></pre></td></tr><tr><td scope="row"><pre>       closeDatabaseChannels();<span></span></pre></td></tr><tr><td scope="row"><pre>       NSLog.out.appendln("running timer");<span></span></pre></td></tr><tr><td scope="row"><pre>      }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>      public void closeDatabaseChannels() {<span></span></pre></td></tr><tr><td scope="row"><pre>       int i, contextCount, j, channelCount;<span></span></pre></td></tr><tr><td scope="row"><pre>       NSArray databaseContexts;<span></span></pre></td></tr><tr><td scope="row"><pre>       EOObjectStoreCoordinator coordinator;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>       coordinator =<span></span></pre></td></tr><tr><td scope="row"><pre>       (EOObjectStoreCoordinator)EOObjectStoreCoordinator.defaultCoordinator();<span></span></pre></td></tr><tr><td scope="row"><pre>       databaseContexts = coordinator.cooperatingObjectStores();<span></span></pre></td></tr><tr><td scope="row"><pre>       contextCount = databaseContexts.count();<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>       //Iterate through all an app’s cooperating object stores (database contexts).<span></span></pre></td></tr><tr><td scope="row"><pre>       for (i = 0; i &lt; contextCount; i++) {<span></span></pre></td></tr><tr><td scope="row"><pre>        NSArray channels =<span></span></pre></td></tr><tr><td scope="row"><pre>         ((EODatabaseContext)databaseContexts.objectAtIndex(i)).registeredChannels();<span></span></pre></td></tr><tr><td scope="row"><pre>        channelCount = channels.count();<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>          for (j = 0; j &lt; channelCount; j++) {<span></span></pre></td></tr><tr><td scope="row"><pre>          //Make sure the channel you're trying to close isn't performing a transaction.<span></span></pre></td></tr><tr><td scope="row"><pre>          if (!((EODatabaseChannel)channels.objectAtIndex(j)).adaptorChannel().<span></span></pre></td></tr><tr><td scope="row"><pre>            adaptorContext().hasOpenTransaction()) {<span></span></pre></td></tr><tr><td scope="row"><pre>             ((EODatabaseChannel)channels.objectAtIndex(j)).adaptorChannel().<span></span></pre></td></tr><tr><td scope="row"><pre>              closeChannel();<span></span></pre></td></tr><tr><td scope="row"><pre>           }<span></span></pre></td></tr><tr><td scope="row"><pre>          }<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>      }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>	

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../UpdateStrategies/UpdateStrategies.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../Concurrency/Concurrency.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2002, 2007 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2007-07-11<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/WebObjects/Enterprise_Objects/Connecting/Connecting.html%3Fid%3DTP30001011-3.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/WebObjects/Enterprise_Objects/Connecting/Connecting.html%3Fid%3DTP30001011-3.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/WebObjects/Enterprise_Objects/Connecting/Connecting.html%3Fid%3DTP30001011-3.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>