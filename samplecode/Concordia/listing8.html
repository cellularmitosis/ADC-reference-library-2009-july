<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>Concordia - /PopUpTkl.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; <A HREF="javascript:location.replace('index.html');">Concordia</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Carbon/idxHumanInterfaceToolbox-date.html" target="_blank">Carbon > Human Interface Toolbox</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">Concordia</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/PopUpTkl.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/ChooseTkl.c</option>
<option value="listing2.html">/ChooseTkl.h</option>
<option value="listing3.html">/Concordia.c</option>
<option value="listing4.html">/Concordia.h</option>
<option value="listing5.html">/Concordia.r</option>
<option value="listing6.html">/DrawTkl.c</option>
<option value="listing7.html">/DrawTkl.h</option>
<option value="listing8.html">/PopUpTkl.c</option>
<option value="listing9.html">/PopUpTkl.h</option>
<option value="listing10.html">/SizeTkl.c</option>
<option value="listing11.html">/SizeTkl.h</option></select>
				</p>
				</form>
				<p><strong><a href="Concordia.zip">Download Sample</a></strong> (&#147;Concordia.zip&#148;, 35.8K)<BR>
<strong><a href="Concordia.dmg">Download Sample</a></strong> (&#147;Concordia.dmg&#148;, 94.2K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*  File:    PopUpTkl.c  Contains:  the code to process the mPopUpMsg message from the Menu        Manager.  This involves calculating the rectangle that the popup menu should        appear in.  Written by:     Copyright:  Copyright &copy; 1999 by Apple Computer, Inc., All Rights Reserved.        You may incorporate this Apple sample source code into your program(s) without        restriction. This Apple sample source code has been provided &quot;AS IS&quot; and the        responsibility for its operation is yours. You are not permitted to redistribute        this Apple sample source code as &quot;Apple sample source code&quot; after having made        changes. If you're going to re-distribute the source, we require that you make        it clear in the source that the code was descended from Apple sample source        code, but that you've made changes.  Change History (most recent first):        8/10/1999  Karl Groethe  Updated for Metrowerks Codewarror Pro 2.1        *//******************************************************************************\* Header Files\******************************************************************************/#include &lt;Memory.h&gt;#include &lt;Menus.h&gt;#include &lt;OSUtils.h&gt;#include &lt;Script.h&gt;#include &lt;Types.h&gt;#include &quot;Concordia.h&quot;#include &quot;DrawTkl.h&quot;#include &quot;PopUpTkl.h&quot;#include &quot;SizeTkl.h&quot;/******************************************************************************\* Prototypes\******************************************************************************/void FindScreen (Rect *menuRect,                 Rect *retScreenRect);#pragma segment Main/******************************************************************************\* DoPopUpMsg - Calculate a popup menu's rectangle** DoPopUpMsg calculates the menu rectangle for the popup menu specified by* TheMenu.  This rectangle is returned in MenuRect.  The top-left corner of the* menu item specified by PopUpItem will appear at the coordinates given by* TopPos and LeftPos.  The vertical coordinate of the top of the menu's* rectangle is returned.  If the menu runs off of the screen, its size and* position will be adjusted.** Coding Notes* #A# - This loop calculates the total height of the menu (Height), the width of*       the menu (Width), the height of the tallest item in the menu*       (MaxHeight), and the distance from the top of the menu to the item*       specified by PopUpItem (ItemPos).* #B# - Read this as: if the height of this menu is too small to display the*       tallest menu item and two scroll icons,then. . .* #C# - If the height of the tallest menu item plus two scroll icons is more*       than the height of the entire menu, adjust the menu's position so that*       the entire menu is displayed.  Otherwise, set the height of the menu to*       the height of the tallest item plus two scroll icons.\******************************************************************************/shortDoPopUpMsg (MenuHandle TheMenu,Rect* MenuRect,short TopPos,short LeftPos,short PopUpItem){  Str255      *ItemString; //-&gt; Item's string  ItemInfoPtr ItemInfo;    //-&gt; Item info  short       TestWidth;   //Width of item to test  short       TestHeight;  //Width of menu to test  short       Height;      //Height of menu  short       Width;       //Width of menu  short       MaxHeight;   //Height of tallest menu item  short       ItemInd;     //Item number of item being checked.  short       ItemPos;     //Dist from menu top to PopUpItem in pixels  short       MenuTop;     //Coord of top of menu rect, even if off screen  Rect        ScrnRect;    //Rectangle of screen minus menu bar and margins  short       HeightAdj;   //New coord of menu top/bottom if small menu  Height = Width = MaxHeight = 0;  ItemInd = 1;  ItemPos = 0;  HLock ((Handle) TheMenu);  ItemString = (Str255 *) (**TheMenu).menuData;  ItemString = (Str255 *) ((Byte *) ItemString + strSize (*ItemString));  while ((*ItemString) [0] != (char) 0) //#A#    {    ItemInfo = (ItemInfoPtr) ((Byte *) *ItemString + strSize (*ItemString));    TestHeight = CalcItemHeight (*ItemString, ItemInfo);    TestWidth = CalcItemWidth (*ItemString, ItemInfo);    if (ItemInd == PopUpItem)      ItemPos = Height;    if (TestWidth &gt; Width)      Width = TestWidth;    if (TestHeight &gt; MaxHeight)      MaxHeight = TestHeight;    Height += TestHeight;    ItemInd += 1;    ItemString = (Str255 *) (ItemInfo + 1);    }  HUnlock ((Handle) TheMenu);  MenuTop = TopPos - ItemPos;  MenuRect-&gt;left = LeftPos;  MenuRect-&gt;top = MenuTop;  MenuRect-&gt;right = MenuRect-&gt;left + Width;  MenuRect-&gt;bottom = MenuRect-&gt;top + Height;  FindScreen (MenuRect, &amp;ScrnRect);  InsetRect (&amp;ScrnRect, scrnMargin, scrnMargin);  if (MenuRect-&gt;top &lt; ScrnRect.top)    {    MenuRect-&gt;top = ScrnRect.top;    if (MenuRect-&gt;bottom - MenuRect-&gt;top - (short) (2 * scrlIconHeight) &lt;        MaxHeight) //#B#      {      if (MaxHeight + (short) (2 * scrlIconHeight) &gt;= Height) //#C#        HeightAdj = MenuRect-&gt;top + Height;      else        HeightAdj = MenuRect-&gt;top + MaxHeight + (short) (2 *            scrlIconHeight);      MenuTop += HeightAdj - MenuRect-&gt;bottom;      MenuRect-&gt;bottom = HeightAdj;      }    }  if (MenuRect-&gt;right &gt; ScrnRect.right)    OffsetRect (MenuRect, ScrnRect.right - MenuRect-&gt;right, 0);  if (MenuRect-&gt;left &lt; ScrnRect.left)    OffsetRect (MenuRect, ScrnRect.left - MenuRect-&gt;left, 0);  if (MenuRect-&gt;bottom &gt; ScrnRect.bottom)    {    MenuRect-&gt;bottom = ScrnRect.bottom;    if (MenuRect-&gt;bottom - MenuRect-&gt;top - (short) (2 * scrlIconHeight) &lt;        MaxHeight) //#B#      {      if (MaxHeight + (short) (2 * scrlIconHeight) &gt;= Height) //#C#        HeightAdj = MenuRect-&gt;bottom - Height;      else        HeightAdj = MenuRect-&gt;bottom - MaxHeight - (short) (2 *            scrlIconHeight);      MenuTop -= MenuRect-&gt;top - HeightAdj;      MenuRect-&gt;top = HeightAdj;      }    }  return MenuTop;  }/******************************************************************************\* Private: FindScreen - Find rectangle of the screen containing most of the menu** Color QuickDraw machines can have more than one screen, and pop-up menus* should appear on the screen that contains the most of the menu's area.  This* function returns the rectangle of the screen (in global coordinates) that* contains most of the menu whose rectangle (also in global coordinates) is* passed in the menuRect parameter.  The screen's rectangle is returned in the* retScreenRect parameter.  If the screen that contains the most of the menu is* the main screen (i.e. the screen with the menu bar), then the height of the* menu bar is added to the top of retScreenRect, effectively removing the menu* bar from the rectangle.  When Concordia is used on a machine without Color* QuickDraw, then the rectangle of the main screen is always returned.  Non-* Color QuickDraw machines with more than one screen (available from third-party* manufacturers) patch QuickDraw to support their screens, and it's impossible* to determine the rectangles of the auxiliary screens without using* manufacturer-specific techniques.  Because of this, Concordia does not take* advantage of auxiliary screens on non-Color QuickDraw machines.** The rectangles of all attached screens are determined through the GDevice list* that's maintained by the system.  There's one GDevice in the list for every* screen attached to the system.  GDevice routines only exist on Color QuickDraw* machines, so the first thing that FindScreen does is to determine whether it's* running on a machine that has Color QuickDraw or not.  If it's not, then the* screen rectangle is taken from the screenBits.bounds QuickDraw global.  If* Color QuickDraw is available, then the GDevice list is used to determine the* appropriate screen.** The first GDevice in the GDevice list is retrieved from the GetDeviceList* function.  The next GDevice in the list is retrieved from the GetNextDevice* function.  Through these two functions, every GDevice in the GDevice list can* be retrieved.** For every GDevice in the list, the area of intersection between the menu's* rectangle and the screen's rectangle (found in the gdRect field of the GDevice* structure) is calculated.  If the area of intersection is the greatest found* so far, then it and its GDevice is saved, and the rectangle of that screen is* placed into retScreenRect.** After every GDevice in the GDevice list has been checked, the GDevice for the* screen containing most of the menu's rectangle is checked to see if it' the* GDevice for the main screen.  This is done by comparing the GDevice handle* against the handle for the main screen's GDevice returned by GetMainDevice.* If the GDevice is in fact the main screen's GDevice, then the height of the* menu bar is removed from retScreenRect.\******************************************************************************/static voidFindScreen (menuRect, retScreenRect)  Rect *menuRect;      /* Menu rectangle before processing for screen */  Rect *retScreenRect; /* Returns rectangle of screen appropriate for menu */  {  GDHandle  aGDevice;   /* Handle to each screen's GDevice */  GDHandle  maxGDevice; /* Handle to GDevice containing most of menu */  long      area;       /* Menu rect/screen rect intersection area */  long      maxArea;    /* Max menu rect/screen rect intersect area found */  Rect      commonRect; /* Intersection between menu rect and screen rect */  SysEnvRec environs;   /* Current running environment */  /* Determine whether Color QuickDraw is implemented or not */  (void) SysEnvirons (curSysEnvVers, /*&lt;*/&amp;environs);  /* Use GDevices if Color QuickDraw is implemented, else use screenBits */  if (environs.hasColorQD)    {    /* Assume max intersection area is 0 and get first GDevice in list */    maxArea = 0L;    maxGDevice = nil;    aGDevice = GetDeviceList ();    /* Loop through all screen GDevices */    while (aGDevice != nil)      {      /* Calc area of intersection between menu rect and screen rect */      SectRect (menuRect, &amp;(**aGDevice).gdRect, /*&lt;*/&amp;commonRect);      area = (long) (commonRect.bottom - commonRect.top) * (commonRect.          right - commonRect.left);      /* If max area found so far, get screen's rect and save area */      if (area &gt; maxArea)        {        *retScreenRect = (**aGDevice).gdRect;        maxGDevice = aGDevice;        maxArea = area;        }      /* Go to the next GDevice in the list */      aGDevice = GetNextDevice (aGDevice);      }    /* If GDevice with most of menu is main screen, remove MBar height */    if (maxGDevice == GetMainDevice ())      retScreenRect-&gt;top += GetMBarHeight ();    }  else    {    *retScreenRect = qd.screenBits.bounds;    retScreenRect-&gt;top += GetMBarHeight ();    }  }</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/Concordia/listing8.html%3Fid%3DDTS10000181-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/Concordia/listing8.html%3Fid%3DDTS10000181-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/Concordia/listing8.html%3Fid%3DDTS10000181-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>