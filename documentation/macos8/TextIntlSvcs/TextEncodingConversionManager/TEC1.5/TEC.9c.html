<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML EXPERIMENTAL 970324//EN">
<HTML>
<HEAD>
<META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter">
<script language="JavaScript" src="frametest.js"></script>
<TITLE> MyUnicodeToTextFallbackProc </TITLE><LINK REL="stylesheet" TYPE="text/css" HREF="../../../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../../../Resources/JavaScript/page.js"></script>
</head>
<body bgcolor="#ffffff">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>

<DIV>
<a name="top"></a>
<!-- start of header -->
<!--#include virtual="/includes/framesetheader" -->
<!-- end of header --><A HREF="TEC.9b.html"><img src="images/up.gif" border="0" alt="Up"></A><nobr>&nbsp;</nobr><A HREF="TEC.9b.html"><img src="images/previous.gif" border="0" alt="Previous"></A><nobr>&nbsp;</nobr><A HREF="TEC.9d.html"><img src="images/next.gif" border="0" alt="Next"></A><nobr>&nbsp;</nobr>
<!-- insert Show/Hide frames -->
<a href="javascript:testFrame()">
<script>
<!--
document.write(frameLink);
//	-->
</script><!-- end Show/Hide frames --></A><br>
<font face="Geneva,Helvetica,Arial" size="1"><b><br>
		PATH<spacer type="horizontal" size="5">&nbsp;</b></font><a href="../../../mac8.html"><font face="Geneva,Helvetica,Arial" size="1">Mac OS 8 and 9 Developer Documentation</a>  <b>&gt;</b> Text Encoding Conversion Manager<br>
		<img src="images/im_smblue.gif" width="116" height="8"><img src="images/space.gif" width="6" height="11">Programming With the Text Encoding Conversion Manager</font><br>
		<br>
		<hr>

</DIV>
<H1>
<A NAME="pgfId=13238">
 </A>
<A NAME="16831">
 </A>
MyUnicodeToTextFallbackProc </H1>
<P>
<A NAME="pgfId=13239">
 </A>
Converts a Unicode text element for which there is no destination encoding equivalent in the appropriate mapping table to the fallback character sequence defined by your fallback handler, and returns the converted character sequence to the Unicode Converter.</P>
<TT>
<A NAME="pgfId=27311">
 </A>
pascal OSStatus MyUnicodeToTextFallbackProc(<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UniChar *iSrcUniStr, <BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ByteCount iSrcUniStrLen, <BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ByteCount *oSrcConvLen,<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TextPtr *oDestStr,<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ByteCount iDestStrLen,<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ByteCount *oDestConvLen,<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LogicalAddress *iInfoPtr<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ConstUnicodeMappingPtr iUnicodeMappingPtr);</TT>
<DL COMPACT>
<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=27315">
 </A>
<TT>iSrcUniStr</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=13241">
 </A>
A pointer to a single UTF-16 character to be mapped by the fallback handler. </DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=27325">
 </A>
<TT>iSrcUniStrLen</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=13242">
 </A>
The length in bytes of the UTF-16 character indicated by the <TT>iSrcUniStr</TT> parameter. Usually this is 2 bytes, but it could be 4 bytes for a non-BMP character. </DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=27334">
 </A>
<TT>oSrcConvLen</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=13243">
 </A>
A pointer to a value of type <TT>ByteCount</TT>. On output, the length in bytes of the portion of the Unicode character that was actually processed by your fallback handler. Your fallback handler returns this value. It should set this to 0 if none of the text was handled, or 2 or 4 if the Unicode character was handled. This value is initialized to 0 before the fallback handler is called. </DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=27343">
 </A>
<TT>oDestStr</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=13244">
 </A>
A pointer to the output buffer where your handler should place any converted text. </DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=27352">
 </A>
<TT>iDestStrLen</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=13245">
 </A>
The maximum size in bytes of the buffer provided by the <TT>oDestStr</TT> parameter. </DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=27361">
 </A>
<TT>oDestConvLen</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=13246">
 </A>
A pointer to a value of type <TT>ByteCount</TT>. On output, the length in bytes of the fallback character sequence generated by your fallback handler. Your handler should return this length. It is initialized to 0 (zero) before the fallback handler is called. </DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=27370">
 </A>
<TT>iInfoPtr</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=13247">
 </A>
A pointer to a block of memory allocated by your application, which can be used by your fallback handler in any way that you like. This is the same pointer passed as the last parameter of <TT>SetFallbackUnicodeToText</TT> or <TT>SetFallbackUnicodeToTextRun</TT>. How you use the data passed to you in this memory block is particular to your handler. This is similar in use to a reference constant (refcon). </DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=27379">
 </A>
<TT>iUnicodeMappingPtr</TT></DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=13248">
 </A>
 A constant pointer to a structure of type <A HREF="TEC.72.html" CLASS="XRef"><TT>UnicodeMapping</TT></A>. This structure identifies a Unicode encoding specification and a particular base encoding specification. </DD><P>

<DT CLASS="DT.DefinitionTerm">
<A NAME="pgfId=27389">
 </A>
<I CLASS="italics">
function result</I>
</DT>
<DD CLASS="DD.DefinitionDef">
<A NAME="pgfId=14487">
 </A>
A result code. See <A HREF="TEC.20.html" CLASS="XRef">
Text Encoding Conversion Manager Result Codes</A>
 in the chapter <A HREF="TEC.18.html" CLASS="XRef">
Basic Text Types Reference</A>
</DD><P>

</DL COMPACT>
<DIV>
<H6 CLASS="RSb.RoutineSbhd">
<A NAME="pgfId=13253">
 </A>
DISCUSSION </H6>
<P>
<A NAME="pgfId=13254">
 </A>
The Unicode Converter calls your fallback handler when it cannot convert a text string using the mapping table specified by the Unicode converter object passed to either <TT>ConvertFromUnicodeToText</TT> or <TT>ConvertFromUnicodeToPString</TT>. The control flags you set for the <TT>controlFlags</TT> parameter of the function <A HREF="TEC.99.html" CLASS="XRef"><TT>SetFallbackUnicodeToText</TT></A> or the <A HREF="TEC.9a.html" CLASS="XRef"><TT>SetFallbackUnicodeToTextRun</TT></A> stipulate which fallback handler the Unicode Converter should call and which one to try first if both can be used. <P>


<A NAME="pgfId=13255">
 </A>
When the Unicode Converter calls your handler, it passes to it the Unicode character to be converted and its length, a buffer for the converted string you return and the buffer length, and a pointer to a block of memory containing the data your application supplied to be passed on to your fallback handler. For a description of the function prototype your handler should adhere to, see <A HREF="TEC.77.html" CLASS="XRef"><TT>UnicodeToTextFallbackProcPtr</TT></A>.<P>


<A NAME="pgfId=13259">
 </A>
After you convert the Unicode text segment to fallback characters, you return the fallback character sequence of the converted text in the buffer provided to you and the length in bytes of this fallback character sequence. You also return the length in bytes of the portion of the source Unicode text element that your handler actually processed. <P>


<A NAME="pgfId=13260">
 </A>
You provide a fallback-handler function for use with the function <A HREF="TEC.84.html" CLASS="XRef"><TT>CreateUnicodeToTextInfoByEncoding</TT></A>, <A HREF="TEC.94.html" CLASS="XRef"><TT>ConvertFromUnicodeToPString</TT></A>, <A HREF="TEC.8c.html" CLASS="XRef"><TT>ConvertFromUnicodeToTextRun</TT></A>, or <A HREF="TEC.8d.html" CLASS="XRef"><TT>ConvertFromUnicodeToScriptCodeRun</TT></A>. You associate an application-defined fallback handler with a particular Unicode converter object you intend to pass to the conversion function when you call it. <P>


<A NAME="pgfId=13270">
 </A>
Your handler should return <TT>noErr</TT> if it can handle the fallback, or <TT>kTECUnmappableElementErr</TT> if it cannot. It can return other errors for exceptional conditions, such as when the output buffer is too small. If your handler returns <TT>kTECUnmappableElementErr</TT>, then <TT>oSrcConvLen</TT> and <TT>oDestConvLen</TT> are ignored because either the default handler will be called or the default fallback sequence will be used. <P>


<A NAME="pgfId=13271">
 </A>
Text converted from UTF-8 will already have been converted to UTF-16 before the fallback handler is called to process it. Your fallback handler should do all of its processing on text encoded in UTF-16. <P>


<A NAME="pgfId=19779">
 </A>
Ideally your application-defined fallback handler should not call any Memory Manager function or any toolbox function that would move memory. If it needs memory,  you should allocate it  before the call to <TT>SetFallbackUnicodeToText</TT> or <TT>SetFallbackUnicodeToTextRun</TT>, and pass a reference to the memory either directly in the <TT>iInfoPtr</TT> parameter or in the data referenced by <TT>iInfoPtr</TT>.<P>


<A NAME="pgfId=19781">
 </A>
If your application-defined fallback handler does not move memory, then you should set the bit corresponding to <TT>kUnicodeFallbackInterruptSafeMask</TT> in the <TT>iControlFlags</TT> parameter of either <TT>SetFallbackUnicodeToText</TT> or <TT>SetFallbackUnicodeToTextRun</TT> (depending on whether you want to install the handler in a <TT>UnicodeToTextInfo</TT> object or a <TT>UnicodeToTextRunInfo</TT> object, respectively). If you do this, <TT>ConvertFromUnicodeToText</TT> (or <TT>ConvertFromUnicodeToTextRun</TT>) calls that use that <TT>UnicodeToTextInfo</TT> (or <TT>UnicodeToTextRunInfo</TT>) object will not need to lock relocatable memory items and can therefore operate more efficiently.<P>


<A NAME="pgfId=19852">
 </A>
If your application-defined fallback handler must move memory, you should leave the bit corresponding to <TT>kUnicodeFallbackInterruptSafeMask</TT> unset when installing the callback handler. In such cases, calls to <TT>ConvertFromUnicodeToText</TT> or <TT>ConvertFromUnicodeToTextRun</TT> that use that use that <TT>UnicodeToTextInfo</TT> (or <TT>UnicodeToTextRunInfo</TT>) object will lock the necessary relocatable memory items to ensure that the fallback handlers cannot move them.<P>


<A NAME="pgfId=19786">
 </A>
To associate a fallback-handler function with a Unicode converter object you use the <A HREF="TEC.99.html" CLASS="XRef"><TT>SetFallbackUnicodeToText</TT></A> and<TT> </TT><A HREF="TEC.9a.html" CLASS="XRef"><TT>SetFallbackUnicodeToTextRun</TT></A> functions. For these functions, you must pass a universal procedure pointer (<TT>UniversalProcPtr</TT>). This is derived from a pointer to your function by using the predefined macro <TT>NewUnicodeToTextFallbackProc</TT>. <P>


<A NAME="pgfId=13279">
 </A>
For versions of the Unicode Converter prior to 1.2, the fallback handler may receive a multiple character text element, so the source string length value could be greater than 2 and the fallback handler may set <TT>srcConvLen</TT> to a value greater than 2. In versions earlier than 1.2.1, the <TT>srcConvLen</TT> and <TT>destConvLen</TT> variables are not initialized to 0; both values are ignored unless the fallback handler returns <TT>noErr</TT>. <P>


<A NAME="pgfId=13280">
 </A>
For a complete description of how to use universal procedure pointers, refer to <I>Inside Macintosh: PowerPC System Software.</I><P>


<A NAME="pgfId=4005">
 </A>
</P>
</DIV>
<HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 13 Dec 99)<P><A HREF="TEC.9b.html"><img src="images/up.gif" border="0" alt="Up"></A><nobr>&nbsp;</nobr><A HREF="TEC.9b.html"><img src="images/previous.gif" border="0" alt="Previous"></A><nobr>&nbsp;</nobr><A HREF="TEC.9d.html"><img src="images/next.gif" border="0" alt="Next"></A><nobr>&nbsp;</nobr>
<!-- insert Show/Hide frames -->
<a href="javascript:testFrame()">
<script>
<!--
document.write(frameLink);
//	-->
</script><!-- end Show/Hide frames --></A>

<!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></BODY>
</HTML>
