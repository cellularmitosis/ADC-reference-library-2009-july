<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!--Template 06-20-02--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Q&amp;A NW28: TCP Application Acquires Different Port Address After Relaunch</title>	<meta name="keywords" content="Mac OS 8 Open Transport connection timeout port IP_REUSEADDR"><meta name="Description" content="Technical Q&amp;A NW28: Q&amp;A deals with the problem of an internaltimeout for disconnected connections which prevents portaddresses from being reused immediately after a connectionhas been closed and suggests a way, including a code snippet,for bypassing this timeout."><meta name="categories" content="Networking"><meta name="week-posted" content="May 13, 1996 - May 17, 1996"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10001440" title="TCP Application Acquires Different Port Address After Relaunch"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/Networking/index.html">Networking</a> &gt; <a href="../../technicalqas/Networking/idxCarbon-date.html">Carbon</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Not Recommended Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>The information in this document is <strong>Not Recommended</strong> and should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Networking/idxCarbon-date.html" target="_blank">Networking > Carbon</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A NW28</div>
<div id="pageheadsub">TCP Application Acquires Different Port Address After Relaunch</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment -->						<!-- begin_content --> <CENTER><TABLE BORDER=0 CELLPADDING=0 WIDTH=600><TR> <td align="left"><hr width=500 align=center><p id = p2>Q:  In my Open Transport TCP based server application, I use a specific socketfor receiving incoming connection requests.<p id=p2>If I relaunch the server immediately after quitting, the initialization callscomplete without error, but the server never receives any incoming connectionrequests.  If I wait several minutes before restarting the server, this problemdoesn't occur.  It appears that there is some internal timeout for disconnectedconnections.  Is there a solution to this problem so that the server can belaunched without waiting for the timeout?</p><p id=p4>A:  TCP has a 2-minute timeout on a binding after a connection has closed beforethe same port can be bound to again. This prevents stale data from corrupting anew connection. For this reason, you see a delay before you can successfullybind to the port again.<p id=p4>There is a way around this, using the <code>IP_REUSEADDR</code> option and the<code>OTOptionManagement</code> call. Set this option on all of your listening endpointsbefore you bind, and the problem should disappear.</p><p id=p4>Important - even after using the <code>IP_REUSEADDR</code> option, at most one endpoint thatis in a state less than connected (listening; unbound doesn't count) may bebound to a given port. Any number of connected or closing endpoints may be sobound to other unique ports, however.</p><p id=p4>The following sample will help to show how to set this option. The functiontakes 2 input parameters, the <code>EndpointRef</code> that you want to set the option for,and the state of the option that you want, typically, true.  The functionreturns a result of <code>OSStatus</code>. If the result is less than zero, then it it theresult of making the <code>OTOptionManagement</code> call.  If the result is positive, thenthe call completed successfully, but the status field had a value other than<code>T_SUCCESS</code>.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>#include &lt;OpenTransport.h&gt;            // open transport files#include &lt;OpenTptInternet.h&gt;/* input: noDelayState - true - nodelay//                         false - normal delay state//// output:    if result less that kOTNoError, then the result of//        OTOptionManagement call is returned//        otherwise, the status value is returned as defined in//        OpenTransport.h        T_SUCCESS    = 0x020,        return kOTNoError if SUCCESS        T_FAILURE    = 0x040,        T_PARTSUCCESS    = 0x100,        T_READONLY    = 0x200,        T_NOTSUPPORT    = 0x400*/OSStatus DoNegotiateIPReuseAddrOption(EndpointRef ep, Boolean reuseState){    UInt8        buf[kOTFourByteOptionSize];    // define buffer for fourByte                            // Option size    TOption*    opt;                // option ptr to make items                            // easier to access    TOptMgmt    req;    OSStatus    err;    Boolean        isAsync = false;    opt = (TOption*)buf;                // set option ptr to buffer    req.opt.buf    = buf;    req.opt.len    = sizeof(buf);    req.opt.maxlen = sizeof(buf);            // were using ret for the                            // return result also.    req.flags    = T_NEGOTIATE;            // negotiate for option    opt-&gt;level    = INET_IP;            // dealing with an IP Level                            // function    opt-&gt;name    = IP_REUSEADDR;    opt-&gt;len    = kOTFourByteOptionSize;    *(UInt32*)opt-&gt;value = reuseState;        // set the desired option                            // level, true or false    if (OTIsSynchronous(ep) == false)        // check whether ep sync or                            // not    {        isAsync = true;            // set flag if async        OTSetSynchronous(ep);            // set endpoint to sync    }    err = OTOptionManagement(ep, &amp;req, &amp;req);    if (isAsync == true)                // restore ep state if                            // necessary        OTSetAsynchronous(ep);        // if no error then check the option status value    if (err == kOTNoError)    {        if (opt-&gt;status != T_SUCCESS)     // if not T_SUCCESS, return                            // the status            err = opt-&gt;status;    }    // otherwise return kOTNOError    return err;}</pre>	</TD></TR></TABLE></CENTER></td></tr></table></center><!-- end_content --><!-- begin_date --><H4 ALIGN=center>[May 01 1996]</H4><!-- end_date --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/nw/nw28.html%3Fid%3DDTS10001440-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/nw/nw28.html%3Fid%3DDTS10001440-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/nw/nw28.html%3Fid%3DDTS10001440-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --><hr width=500 align=center> </BODY></HTML>