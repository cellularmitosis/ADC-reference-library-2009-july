<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note OS04: OmegaSANE</title><meta name="keywords" content="Mac OS 7 OmegaSANE binary decimal conversions compatibility backpatching"><meta name="Description" content="Technical Note OS04: This Technical Note discusses the featuresof  OmegaSANE and the associated compatibility risks. OmegaSANEfeatures include   correctly rounded binary &lt;-&gt; decimal conversions,faster   transcendental functions, and backpatching of SANEtraps for faster package entry. ">                                      <meta name="categories" content="Operating System"><meta name="week-posted" content="Apr 27, 1992 - May 1, 1992"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002590" title="OmegaSANE"></a><A NAME="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxCarbon-date.html">Carbon</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Carbon/index.html" target="_blank">Reference Library > Carbon</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note OS04</div>
<div id="pageheadsub">OmegaSANE</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Section1">Introduction</A><BR><br><A HREF="#Section2">[[Omega]]SANE Features</A><BR><br><A HREF="#Section3">Binary &lt;-&gt; Decimal Conversions</A><BR><br><A HREF="#Section4">Performance Improvements</A><BR><br><A HREF="#Section5">Pitfalls</A><BR><br><A HREF="#Section6">MPW C 2.0.2 </A><BR><br><A HREF="#Section7">Other Pitfalls</A><BR><br><A HREF="#References">References     </A><BR><br>                          <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><p id="introtext">System 7.0.1 introduced a new version of SANE (the Standard Apple NumericsEnvironment) known as OmegaSANE.  This Note discusses the features of OmegaSANEand the associated compatibility risks.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>May 01 1992</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content -->          <P><A NAME=Section1></A></P><h2>Introduction</h2><p>System 7.0.1 introduced a new version of the Standard Apple NumericsEnvironment (SANE) package  referred to as OmegaSANE ([[Omega]]SANE). While itimproves the performance of SANE, it is not without compatibility risks, whichare detailed below. New binary &lt;-&gt; decimal conversions have been includedthat are correctly rounded across the entire range of double extended. Thiswill result in incompatibility with previous conversion algorithms for avariety of input values; the results of the [[Omega]]SANE conversions areuniformly more accurate, and will be compatible with future releases of SANE.</p><a name="Section2"></a><P><A HREF="#top">Back to top</A></P><h2>[[Omega]]SANE Features</h2><p>The [[Omega]]SANE release provides a number of performance enhancements whilemaintaining conformance with SANE. The following enhancements have been implemented:</p><ul type="disc">	<li>Correctly rounded binary &lt;-&gt; decimal conversions</li>	<li>Faster transcendental functions</li>	<li>Backpatching of SANE traps for faster package entry</li></ul><p>Tables showing the performance of [[Omega]]SANE are given below. A key aspectof the performance gain is the "backpatching" of SANE traps. This mechanismwill be discussed below under "Pitfalls."</p><p>The version of [[Omega]]SANE supplied with System 7.0.1 installs only onmachines equipped with a Macintosh IIci ROM or later and also equipped with anFPU. For example, it installs on a Macintosh IIsi running System 7.0.1 andequipped with an FPU, but not on one without an FPU. On the Macintosh Quadrasand the PowerBook 140/170 it is in ROM, although it doesn't load on thePowerBook 140 unless it has an optional FPU.  On machines where the FPU isoptional, addition of an FPU may require re-installation of System 7.0.1 beforethe FPU version of [[Omega]]SANE will load.</p><p>Table 1 presents configuration information concerning the versions of SANEwhich may be installed by System 7.0.1. Information in this table is subject tochange. The FPU column states whether the machine has an FPU or if it isoptional. The column labeled "Correctly Rounded Bin &lt;-&gt; Dec" showswhether improved versions of the binary &lt;-&gt; decimal conversion routines(discussed below) are available, and which version (V.1 or V.2) is supplied.The "[[Omega]]SANE FPU Version" column states whether [[Omega]]SANE will loadon a given configuration.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>The information in this table will undoubtedly change in thefuture.  Developers should not assume that any particular machine/systemsoftware combination does or does not have  [[Omega]]SANE.</P></TD></TR></TABLE></CENTER><BR><p align=center><b>Table 1</b>. SANE Configurations</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>Macintosh CPU      FPU        Correctly      [[Omega]]SANE                              Rounded        FPU Version                              Bin&lt;-&gt;DecMac Plus           No         No             NoMac SE             No         No             NoMac Classic        No         No             NoMac Classic II     Optional   V.2 in ROM     w/ 7.0.1 &amp; FPU+Mac LC             Optional   V.1 in ROM     w/ 7.0.1 &amp; FPU+Mac IIsi           Optional   V.1 in ROM     w/ 7.0.1 &amp; FPU+Mac SE/30          Yes        No             NoMac II             Yes        No             NoMac IIx            Yes        No             NoMac IIcx           Yes        No             NoMac IIci           Yes        V.2 with       w/ 7.0.1                              7.0.1Mac IIfx           Yes        V.2 with       w/ 7.0.1                              7.0.1PowerBook 100      Yes        No             NoPowerBook 140      Optional   V.2 in ROM     w/ 7.0.1 &amp; FPU+PowerBook 170      Yes        V.2 in ROM     YesQuadra 700         Yes        V.2 in ROM     YesQuadra 900         Yes        V.2 in ROM     Yes</pre>	</TD></TR></TABLE></CENTER><p>+FPU optional systems may require reinstallation of System 7.0.1 after installation of an FPU before the[[Omega]]SANE FPU version will load.</p><p>There is no way programmatically to disable [[Omega]]SANE in System 7.0.1, noris it a user option.  There is also no way to reliably detect that [[Omega]]SANE is present.</p><a name="Section3"></a><P><A HREF="#top">Back to top</A></P><h2>Binary &lt;-&gt; Decimal Conversions</h2><p>[[Omega]]SANE includes binary &lt;-&gt; decimal conversion routines that mayproduce results that differ from previous versions of SANE. Versions of theseroutines have been in some machine ROMs since the Macintosh IIsi, and animproved version (V.2) is in the newest ROMs, as well as [[Omega]]SANE. Referto Table 1 for current configuration information. As a result of these improvedconversion routines, floating-point constants that are used in the body ofsource code will compile differently in the presence of [[Omega]]SANE than witholder SANE engines. The results are uniformly better, but may cause unexpectedvariances from test suites (for instance). Therefore, care must be given to thearithmetic environment in which compilations are made. One can tell whichversion of the binary&lt;-&gt;decimal conversions is currently in use byperforming the following computation on the Calculator DA:  45/100&nbsp;- 0.45.On older versions of SANE, the result is -2.71051E-20. With [[Omega]]SANE, theresult is 0 as expected.</p><a name="Section4"></a><P><A HREF="#top">Back to top</A></P><h2>Performance Improvements</h2><p>[[Omega]]SANE can significantly improve the performance of many floating-pointSANE operations. It does this by replacing _FP68K trap calls with JSRinstructions directly into the appropriate SANE code. This is discussed in moredetail under "Pitfalls."  7.0.1 [[Omega]]SANE does not alter _Elems68K trapcalls, but internal code improvements are used to increase the performance oftranscendental functions. Finally,<b> </b>[[Omega]]SANE does not affect theperformance of code compiled to use the FPU directly, although some libraryroutines used with such code (such as the CSANELib881.o routines NextAfter,Classify, Scalb, and Remainder) will be backpatched by [[Omega]]SANE becausethey call _FP68K.</p><p>Table 2 shows typical performance improvement using [[Omega]]SANE on aMacintosh IIci. Of course, actual performance depends on how heavily you useSANE and the mixture of SANE operations you use.</p><p  align=center><b>Table 2</b>. SANE Performance</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>Operation        Macintosh    Macintosh    Speedup                 IIci SANE    IIci         Factor                 (in flops)   [[Omega]]SA                              NE (in                              flops)Add/Subtract     18,794       59,259       3.15Multiply         18,182       53,571       2.95Divide           18,476       55,300       2.99Square Root      18,547       65,934       3.55(Exact)Square Root      18,349       59,113       3.22(Inexact)Cosine           902          7,058        7.82Sine             1,290        8,108        6.29Tangent          826          7,185        8.70Logarithm        820          7,643        9.32Exponential      723          7,317        10.12Compound         413          3,324        8.05Annuity          358          3,191        8.91</pre>	</TD></TR></TABLE></CENTER><a name="Section5"></a><P><A HREF="#top">Back to top</A></P><h2>Pitfalls</h2><p>[[Omega]]SANE achieves most of its performance improvement through use of atechnique known as "backpatching." Use of backpatching introduces a number ofcompatibility implications. To implement backpatching, the front end of toolboxSANE has been altered to have multiple entry points corresponding to the mostimportant operations, and <i>your </i> RAM-based application code is modified<i>on the fly</i> replacing traps with speedier <code>JSR</code>s to the appropriate entry point. Subsequent execution causes the code to bypass the trap dispatcher and call SANE directly. For example, an archetypal SANE package call looks like this:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    pea    fooSrc    ; Push address of the source operand    pea    barDst    ; Push the address of the destination operand    move.w    #OpCode,-(sp)    ; Push a SANE opcode word    _FP68K        ; Trap to SANE</pre>	</TD></TR></TABLE></CENTER><p>Notice that the last two instructions occupy three words, just enough for thedesired <code>JSR</code>. [[Omega]]SANE modifies the RAM-image of the applicationresulting in code like the following:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    pea    fooSrc            ; Push address of the source operand    pea    barDst            ; Push the address of the dest. operand</pre>	</TD></TR></TABLE></CENTER>    <p>Herein lies a potential problem. There is nothing to guarantee that theinstruction immediately prior to the <code>_FP68K</code> trap was actuallyexecuted. A program control operation, such as a <code>BRA</code>, could havecaused control to be passed to the <code>_FP68K</code> operation without executingthe preceding <code>move.w</code>. For instance, an execution sequence such as the following:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    pea    subSrc        ; Push source for subtract    pea    subDst        ; Push destination for subtract    move    #$0002,-(sp)    ; Push subtract extended opcode word    bra    @1        ; Branch to _FP68K trap    .    .    .    pea    addSrc2    ; Push source for add    pea    addDst2    ; Push destination for add    move    #$0000,-(sp)    ; Push add extended opcode word@1    _FP68K            ; Trap to SANE</pre>	</TD></TR></TABLE></CENTER><p>would have the unseemly result of "backpatching" a <code>JSR</code> to the extendedadd entry point, and future executions of the subtraction code would branch to the middle of a <code>JSR</code> causing an illegal instruction error (the illegal instruction error might not occur right away). Note, however, that the following similar code sequence works correctly in the presence of backpatching:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    pea    addSrc        ; Push source for add    pea    addDst        ; Push destination for add    bra    @1        ; Branch to _FP68K trap    .    .    .    pea    addSrc2    ; Push source for add    pea    addDst2    ; Push destination for add@1    move    #$0000,-(sp)    ; Push add extended opcode word    _FP68K            ; Trap to SANE</pre>	</TD></TR></TABLE></CENTER><p>The type of code sequence that is problematic for backpatching (as above)cannot be emitted by the current MPW C and Pascal compilers or by currentThink(TM) compilers. It also cannot occur with code generated using the macroscontained in SANEMacs.a.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>Although the current generation of MPW compilers create[[Omega]]SANE-safe code, the earlier, MPW C 2.0.2 compiler may, under limitedcircumstances, generate code that has problems with [[Omega]]SANE. This isdiscussed in more detail below.</P></TD></TR></TABLE></CENTER><BR><p>Additionally, if you have hand coded assembly or code which has been otherwiseoptimized to use common _FP68K trap instructions you may be at risk frombackpatching.  We recommend you adjust your code to conform to the prototypicalsequence above as there is no performance penalty involved.</p><p>Another common programming practice is illustrated in the following example:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    move.w    #$0000,D0    ; Move extended add opcode word to D0    bra    @1        ; Branch to shared backend for SANE trap call    .    .    .    move.w    #$0002,D0    ; Move extended subtract opcode word to D0    bra    @1        ; Branch to shared backend for SANE trap call    .    .    .@1    move.w    D0,-(SP)    ; Push SANE opcode word on stack    _FP68K            ; Trap to SANE</pre>	</TD></TR></TABLE></CENTER><p>This code operates correctly in the presence of [[Omega]]SANE, but is clearlynot backpatchable. If you have code that does this, you might considerrewriting it to obtain the performance increase, but the code will work as is.</p><a name="Section6"></a><P><A HREF="#top">Back to top</A></P><h2>MPW C 2.0.2</h2><p>The MPW C 2.0.2 compiler may, under limited circumstances, generate code thatworks incorrectly under [[Omega]]SANE. Apple recommends that all developers usethe latest development tools, but as conversion of source may be difficult andtime consuming in some cases, below is a description and workaround for theproblem.  Again, this only affects code compiled without the -mc68881 option.</p><p>The following code demonstrates the problem</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    struct foo {        double data;        float num;    };    foobar(f,b)    struct foo *f;    unsigned char b;    {          extended num;          num = 3.14159;          if (b)             f-&gt;data = num; /* FP operation ends block */          else              f-&gt;num = num; /* Another FP operation ends block */         return;    }</pre>	</TD></TR></TABLE></CENTER><p>The critical combination of events occurs when more than one block in anif-else or switch statements ends with a floating-point operation orconversion. The compiler tries to optimize the final floating-point operationby pushing a selector on the stack then branching to a common <code>_FP68K</code>trap. This is a classic example of code, like that cited above, that worksincorrectly under [[Omega]]SANE.</p><p>The workaround is to eliminate the final floating-point operation. Here is one way to do this:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    foobar(f,b)    struct *f;    unsigned char b;    {        extended num;        int idummy;        num = 3.14159;        if (b) {            f-&gt;data = num;            idummy = 1;    /* End if block with a non-FP operation */        } else {            f-&gt;num = num;            idummy = 0;    /* End else block with a non-FP operation */        }        return;    }</pre>	</TD></TR></TABLE></CENTER><p>In this case, each floating-point operation gets its own <code>_FP68K</code> trap so there are no problems.</p><a name="Section7"></a><P><A HREF="#top">Back to top</A></P><h2>Other Pitfalls</h2><p>The backpatching performed by [[Omega]]SANE can have other implications fordevelopers. For example, applications that checksum their code segments(perhaps to check for viruses) will detect that the segment has been modified.Such applications should checksum segments only at application startup or whenthe segments are loaded, not after they have been executed.</p><p>Likewise, an application must not create a situation which will cause theResource Manager to write a code segment out to disk after it has beenexecuted. If such a segment been modified by [[Omega]]SANE, it can fail whensubsequently loaded into memory.  Since <code>CloseResFile</code> is called whenthe application quits it will automatically write out changed resources (i.e.if the <code>resChanged</code> attribute is true) when closing the file.</p> <P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><p>Apple Numerics Manual, Second Edition</p> <P><A HREF="#top">Back to top</A></P>         <P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (56K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/os_04.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/os/os_04.html%3Fid%3DDTS10002590-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/os/os_04.html%3Fid%3DDTS10002590-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/os/os_04.html%3Fid%3DDTS10002590-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>