<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>QuickTime Kit Programming Guide: Adding New Capabilities to the QTKitPlayer Application</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Adding New Capabilities to the QTKitPlayer Application"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP40001245-CH207" title="Adding New Capabilities to the QTKitPlayer Application"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000433" target="_top">QuickTime</a> &gt; <a href="../../../Cocoa-date.html#//apple_ref/doc/uid/TP30000440-TP30000433-TP30000495" target="_top">Cocoa</a> &gt; <a href="../Chapter01/Introduction.html#//apple_ref/doc/uid/TP40001245-CH202-TPXREF101">QuickTime Kit Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../Chapter04/04ExtendingSimpleQTKitApp.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../Chapter06/AddingStreaming.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP40001245-CH207-TPXREF101" title="Adding New Capabilities to the QTKitPlayer Application"></a><h1>Adding New Capabilities to the QTKitPlayer Application</h1><p>In this chapter, you’ll extend the QTKitPlayer application beyond what you have constructed in the previous chapter. You’ll add an NSDrawer object to the QTMovieView window, which toggles open and close with the click of a mouse. The drawer will also have new, enhanced functionality, including the capability of displaying a movie’s current time and duration, its normal and current size, and its source. </p><p>Notably, as you work through the steps outlined in this chapter and add new chunks of code to your Xcode project, you’ll implement a callback mechanism from the QuickTime C API. </p><p>When you’ve completed your Xcode project, you’ll be able to choose File > New in your extended QTKitPlayer and an untitled QuickTime movie with a black screen will open for you. If you click the button in the middle of the frame to the right, as shown in <span class="content_text">Figure 4-1</span>, a Cocoa drawer pops open. </p><br/><div><a name="//apple_ref/doc/uid/TP40001245-CH207-BBCBAEJB" title="Figure 4-1An untitled QuickTime movie with an open Cocoa drawer"></a><p><strong>Figure 4-1&nbsp;&nbsp;</strong>An untitled QuickTime movie with an open Cocoa drawer</p><img src = "../Art/open_drawer_untitled.jpg" alt = "An untitled QuickTime movie with an open Cocoa drawer" ></div><br/><p>The button in the movie frame lets you toggle the drawer open and closed, with fields of useful information about the movie being displayed. The information displayed, however, is not static. </p><p>By implementing a callback mechanism from the QuickTime C API, your QTKitPlayer will be able to synchronize the current time to the playback of the movie itself. </p><p>When a QuickTime movie plays, for example, the current time field is updated synchronously with the movie, as illustrated in <span class="content_text">Figure 4-2</span>. </p><br/><div><a name="//apple_ref/doc/uid/TP40001245-CH207-BBCGCEBE" title="Figure 4-2An mp4 QuickTime movie playing with the current time, duration, movie size, and movie displayed in the open Cocoa drawer"></a><p><strong>Figure 4-2&nbsp;&nbsp;</strong>An mp4 QuickTime movie playing with the current time, duration, movie size, and movie displayed in the open Cocoa drawer</p><img src = "../Art/open_drawer_movie_playing.jpg" alt = "An mp4 QuickTime movie playing with the current time, duration, movie size, and movie displayed in the open Cocoa drawer" ></div><br/>
<!-- This template is being used for both PDF and HTML. -->

    
    <h4>In this section:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="AddingToQTKitPlayer.html#//apple_ref/doc/uid/TP40001245-CH207-SW1">Design Strategy</a>
				
			<br/>
			
        
			
			
				<a href="AddingToQTKitPlayer.html#//apple_ref/doc/uid/TP40001245-CH207-SW2">Tasks to Accomplish</a>
				
			<br/>
			
        
			
			
				<a href="AddingToQTKitPlayer.html#//apple_ref/doc/uid/TP40001245-CH207-SW5">Adding a Cocoa Drawer to the QTKitPlayer</a>
				
			<br/>
			
        
			
			
				<a href="AddingToQTKitPlayer.html#//apple_ref/doc/uid/TP40001245-CH207-SW6">Adding Code To Your QTKitPlayer Project</a>
				
			<br/>
			
        
			
			
				<a href="AddingToQTKitPlayer.html#//apple_ref/doc/uid/TP40001245-CH207-SW8">The Completed Project</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP40001245-CH207-SW1" title="Design Strategy"></a><h2>Design Strategy</h2><p>Building on the existing functionality of your QTKitPlayer application, you’ll add new text fields to your NSDrawer object that provide information about the size of the movie playing, its source path on the user’s computer, as well as the time and duration of play. These new fields may serve to enhance the user’s ability, for example, to edit a QuickTime movie with a specific timeline, or to resize a movie to a particular pixel ratio. The location of the source movie may also be useful.</p><p>Because you are adding to the existing QTKitPlayer application, all the functionality of the player is still intact. All the controls for movie playback are available for starting and stopping, showing and hiding the controller, stepping forward and backward frame by frame, and so on. </p><p>This chapter depends on your having worked through the construction of the QTKitPlayer application in the previous chapter. If you haven’t studied the steps described in that chapter, or simply skimmed over them, it might be a good idea to go back there first and refresh your memory before proceeding. </p><p>In this, as well as in the following chapters, you’ll break down the tasks you need to accomplish into a series of discrete steps. The goal is to work as efficiently as possible by first laying the foundation for your enhanced player application in Interface Builder, and then adding the code you need to make it work.</p><a name="//apple_ref/doc/uid/TP40001245-CH207-SW2" title="Tasks to Accomplish"></a><h2>Tasks to Accomplish</h2><p>The tasks you want to accomplish in adding new functionality to your QTKitPlayer application are straightforward enough if you have already developed projects with Cocoa and Xcode. You’ll do this:</p><ol class="ol"><li class="li"><p>Add a new Cocoa NSDrawer object to your project, using the tools available to you in Interface Builder and Xcode 2.0. The goal is for the user to be able to toggle the drawer open and closed, and for the drawer object to have the necessary logic to display and synchronously update the movie content as it plays.</p></li><li class="li"><p>Add a small chunk of code to the <code>MovieDocument.h</code> class interface to specify the movie attributes of the drawer.</p></li><li class="li"><p>Add a larger chunk of code to your <code>MovieDocument.m</code> implementation file. This will involve working with a callback mechanism from the QuickTime C API. The goal is to learn how you can tap into the rich library of the QuickTime C API, when you want to add specific functionality to your Cocoa project that may not be available, for whatever reason, in the Cocoa API. </p></li></ol><a name="//apple_ref/doc/uid/TP40001245-CH207-SW3" title="Project Complexity"></a><h3>Project Complexity</h3><p>The complexity of the project comes with the addition of a callback mechanism from the QuickTime C API. </p><p>Basically, as the movie is playing, you need a mechanism to update the timer field in the drawer. The movie controller component calls your action filter function each time the component receives an action for its movie controller. In your action filter, you will use the idle action (<code>mcActionIdle</code>) to update your time display. The idle action is sent continuously while the movie is being serviced. </p><p>You could do a similar thing with an <code>NSTimer</code>, but the action filter technique is a bit easier to implement. </p><p>The function prototype for the QuickTime C callback mechanism is defined as follows:</p><div class="codesample"><table><tr><td scope="row"><pre>Boolean MyMCActionFilterWithRefConProc<span></span></pre></td></tr><tr><td scope="row"><pre>        (   MovieController      mc,<span></span></pre></td></tr><tr><td scope="row"><pre>            short               action,<span></span></pre></td></tr><tr><td scope="row"><pre>            void                *params,<span></span></pre></td></tr><tr><td scope="row"><pre>            long                refCon );<span></span></pre></td></tr></table></div><p>The <code><!--a-->MyMCActionFilterWithRefConProc<!--/a--></code> function responds to the actions of a movie controller with a reference constant. The parameters specify the movie controller (<em>mc</em>) for the operation, the movie controller action (<em>action</em>), a pointer to a structure that passes information to the callback, and a reference constant (<em>refCon</em>) that your code supplies to your callback. Your QTKitPlayer application can invoke these actions by calling <code><a href="../../../Reference/QTRef_MovieController/Reference/reference.html#//apple_ref/doc/c_ref/MCDoAction" target="_top">MCDoAction</a></code>. An action filter function will receive any of the controller actions sent to it. </p><p>You’ll add this callback to the code in your <code>MovieDocument.m</code> implementation file. The way to accomplish this is explained in detail in the section <span class="content_text"><a href="AddingToQTKitPlayer.html#//apple_ref/doc/uid/TP40001245-CH207-TPXREF127">“Adding Code To Make the Drawer Work.”</a></span></p><a name="//apple_ref/doc/uid/TP40001245-CH207-SW4" title="Class Model"></a><h3>Class Model</h3><p>When you’ve completed all these tasks, you’ll see the class model of your QTKitPlayer code in Xcode 2.0, as shown in <span class="content_text">Figure 4-3</span>. The class model includes a list of the MovieDocument instance variables you’ll add to your QTKitPlayer project and a visualization of their connections and inheritance paths.</p><br/><div><a name="//apple_ref/doc/uid/TP40001245-CH207-BBCEDFGC" title="Figure 4-3A class model of the MovieDocument class with a list of properties"></a><p><strong>Figure 4-3&nbsp;&nbsp;</strong>A class model of the MovieDocument class with a list of properties</p><img src = "../Art/class_model_moviedoc.jpg" alt = "A class model of the MovieDocument class with a list of properties" ></div><br/><p>Note that this class model diagram is only available using Xcode 2.0. As illustrated in <span class="content_text">Figure 4-3</span>, it also lists the classes you’ll work with in subsequent chapters of this programming tutorial. Just ignore these for the moment, as you focus on the properties you’ll add to the MovieDocument class. </p><a name="//apple_ref/doc/uid/TP40001245-CH207-SW5" title="Adding a Cocoa Drawer to the QTKitPlayer"></a><h2>Adding a Cocoa Drawer to the QTKitPlayer</h2><p>In this sequence of steps, you’ll add a Cocoa drawer to the QTKitPlayer. Adding drawers to a window is relatively easy to accomplish using Interface Builder. </p><p>To extend your QTKitPlayer, follow these steps: </p><ol class="ol"><li class="li"><p>Launch Interface Builder 2.5 and open your MovieDocument.nib. </p></li><li class="li"><p>Drag the drawer object from your Cocoa-Windows palette into your nib, shown in <span class="content_text">Figure 4-4</span>. The drawer object becomes an NSDrawer in your nib.</p><div class="item_figure"><a name="//apple_ref/doc/uid/TP40001245-CH207-BBCCBFEA" title="Figure 4-4The Cocoa-Windows and the NSDrawer object added in MovieDocument.nib"></a><p><strong>Figure 4-4&nbsp;&nbsp;</strong>The Cocoa-Windows and the NSDrawer object added in MovieDocument.nib</p><img src = "../Art/drag_drawer.jpg" alt = "The Cocoa-Windows and the NSDrawer object added in MovieDocument.nib" ></div></li><li class="li"><p>To add the drawer content view, drag a CustomView object from the Cocoa-Containers palette into the nib. Double-click the icon and rename it as “Drawer ContentView”. That gives you the content view, as shown in <span class="content_text">Figure 4-5</span>.</p><div class="item_figure"><a name="//apple_ref/doc/uid/TP40001245-CH207-BBCHADBB" title="Figure 4-5The CustomView object in the Cocoa-Containers palette and in the MovieDocument.nib as Drawer ContentView"></a><p><strong>Figure 4-5&nbsp;&nbsp;</strong>The CustomView object in the Cocoa-Containers palette and in the MovieDocument.nib as Drawer ContentView</p><img src = "../Art/drag_customview.jpg" alt = "The CustomView object in the Cocoa-Containers palette and in the MovieDocument.nib as Drawer ContentView" ></div></li><li class="li"><p>Add the <code>mDrawer</code> outlet to File’s Owner. Double-click the File’s Owner icon. This brings up the Attributes pane for the MovieDocument Info window. Click Add to add an <code>mDrawer</code> outlet. </p></li><li class="li"><p>Wire up the connection from the File’s Owner to the <code>mDrawer</code> outlet. Click File’s Owner, press the Control key, and drag wire to the NSDrawer icon in the MovieDocument.nib. Click connect. </p></li><li class="li"><p>Now you want to select the NSDrawer object in your nib and press Command-2 to open the NSDrawer Info pane. Select the NSDrawer icon and press the Control key. Now Control-drag to the Drawer Content View icon and press the Connect button in the NSDrawerInfo window, as shown in <span class="content_text">Figure 4-6</span>. You want to wire up your connections from the NSDrawer object to the Drawer Content View object.</p><div class="item_figure"><a name="//apple_ref/doc/uid/TP40001245-CH207-BBCFBECG" title="Figure 4-6The NSDrawer wired up and connected to the contentView outlet"></a><p><strong>Figure 4-6&nbsp;&nbsp;</strong>The NSDrawer wired up and connected to the contentView outlet</p><img src = "../Art/nsdrawer_to_contentview.jpg" alt = "The NSDrawer wired up and connected to the contentView outlet" ></div></li><li class="li"><p>Similarly, select the NSDrawer icon and press the Control key. Now control-drag to the window icon to wire up your connections from the NSDrawer object to its parent window.</p></li><li class="li"><p>In the MovieDocument.nib, double-click the window icon to select the QTMovieView window object. You want to leave a portion of the window available for the button that will toggle your NSDrawer object open and closed. </p></li><li class="li"><p>Select the Cocoa-Controls palette and drag an NSButton object from the collections of control object to the right portion of your window.</p></li><li class="li"><p>Press Command-1 to open the Attributes pane, as shown in <span class="content_text">Figure 4-7</span>.</p><div class="item_figure"><a name="//apple_ref/doc/uid/TP40001245-CH207-BBCGDDHE" title="Figure 4-7The NSButton info pane with attributes and the type specified as disclosure"></a><p><strong>Figure 4-7&nbsp;&nbsp;</strong>The NSButton info pane with attributes and the type specified as disclosure</p><img src = "../Art/nsbutton_info.jpg" alt = "The NSButton info pane with attributes and the type specified as disclosure" ></div></li><li class="li"><p>Specify the Type as Disclosure in the attributes pane of NSButton Info (<span class="content_text">Figure 4-7</span>). This enables the button to toggle. The toggle option is available in Cocoa by enabling disclosure. </p></li><li class="li"><p>Set the springs for the disclosure button. </p></li><li class="li"><p>Click the NSDrawer icon, then set the Size attributes in the NSDrawer Info pane, as shown in <span class="content_text">Figure 4-8</span>. </p><div class="item_figure"><a name="//apple_ref/doc/uid/TP40001245-CH207-BBCDDCIE" title="Figure 4-8Size attributes added to the Drawer Content View"></a><p><strong>Figure 4-8&nbsp;&nbsp;</strong>Size attributes added to the Drawer Content View</p><img src = "../Art/drawer_info.jpg" alt = "Size attributes added to the Drawer Content View" ></div></li><li class="li"><p>Now you want to set the springs in the Size attribute pane so that when the user resizes the drawer, the toggle button is not crunched. Set the springs for autosizing, as shown in <span class="content_text">Figure 4-9</span>.</p><div class="item_figure"><a name="//apple_ref/doc/uid/TP40001245-CH207-BBCCGGJH" title="Figure 4-9The Size settings for autosizing of springs in the Drawer Contents object"></a><p><strong>Figure 4-9&nbsp;&nbsp;</strong>The Size settings for autosizing of springs in the Drawer Contents object</p><img src = "../Art/nsbutton_springs.jpg" alt = "The Size settings for autosizing of springs in the Drawer Contents object" ></div></li><li class="li"><p>Add NSTextField objects corresponding to “Current Time,” “Duration,” “Normal Size,” “Current Size,” and “Source” (all static text), as shown in <span class="content_text">Figure 4-10</span>. In the attributes pane of each text field, specify the title, color, alignment, text border, and other information. </p><div class="item_figure"><a name="//apple_ref/doc/uid/TP40001245-CH207-BBCFCCBG" title="Figure 4-10Text fields and their attributes added to the Drawer Content View"></a><p><strong>Figure 4-10&nbsp;&nbsp;</strong>Text fields and their attributes added to the Drawer Content View</p><img src = "../Art/drawer_text_field.jpg" alt = "Text fields and their attributes added to the Drawer Content View" ></div></li><li class="li"><p>You want to be sure that you specify in the NSTextfield Info panes for Current Time and Duration by entering the Title attribute as 00:00:00:00, as shown in <span class="content_text">Figure 4-10</span>.</p></li><li class="li"><p>Now add the outlets to your document subclass. Double-click the File’s Owner icon. This brings up the Info window attributes pane for the MovieDocument class. Use the Add button and add the following outlets: <code>mCurrentSize</code>, <code>mDuration</code>, <code>mNormalSize</code>, <code>mSourceSize</code>, and <code>mTimeDisplay</code>. </p></li><li class="li"><p>Now you are ready to hook up the File’s Owner to the various textfields that you have specified in the Drawer Content View. Select the File’s Owner icon and press the Control key. Connect the wire to each textfield in the Drawer Content View, as shown in <span class="content_text">Figure 4-11</span> and click Connect for each outlet.</p><div class="item_figure"><a name="//apple_ref/doc/uid/TP40001245-CH207-BBCGJBIB" title="Figure 4-11Hooking up the textfields and adding outlets"></a><p><strong>Figure 4-11&nbsp;&nbsp;</strong>Hooking up the textfields and adding outlets</p><img src = "../Art/file_owner_nsdrawer.jpg" alt = "Hooking up the textfields and adding outlets" ></div></li><li class="li"><p>Add toggle drawer action to the MovieDocument class. Double-click File’s Owner, and in the Attributes pane of the Info window for the MovieDocument, click the “O Actions” pane. Now click the Add button, and add a <code>toggleDrawer</code> action. </p></li><li class="li"><p>Wire up the disclosure button to the <code>toggleDrawer</code> action. Click the disclosure button in the MovieDocument window. Press the Control key, then drag the wire to the File Owner’s icon. In the Connections pane of the Info window for NSButton, click the Target/Action pane. Select the <code>toggleDrawer</code> action and click the Connect button, as shown in <span class="content_text">Figure 4-12</span>. </p><div class="item_figure"><a name="//apple_ref/doc/uid/TP40001245-CH207-BBCEBBCE" title="Figure 4-12Wiring up the toggle drawer target and action in the MovieDocument.nib"></a><p><strong>Figure 4-12&nbsp;&nbsp;</strong>Wiring up the toggle drawer target and action in the MovieDocument.nib</p><img src = "../Art/toggle_drawer_outlet.jpg" alt = "Wiring up the toggle drawer target and action in the MovieDocument.nib" ></div></li></ol><p>This completes the steps you need to follow in order to construct the Cocoa drawer and hook up the outlets and actions in Interface Builder. </p><a name="//apple_ref/doc/uid/TP40001245-CH207-SW6" title="Adding Code To Your QTKitPlayer Project"></a><h2>Adding Code To Your QTKitPlayer Project</h2><p>In this section, you’ll add less than one hundred lines of code to your QTKitPlayer project by modifying your <code>MovieDocument.h</code> and <code>MovieDocument.m</code> class files. </p><a name="//apple_ref/doc/uid/TP40001245-CH207-SW7" title="Adding Code To The Movie Document Class"></a><h3>Adding Code To The Movie Document Class</h3><p>In this next sequence of steps, you’ll be adding a small amount of code to your <code>MovieDocument.h</code> class interface file. You want to declare the instance variables that you have specified as your outlets and target actions in Interface Builder. You also want to define in code the methods that will enable you to set these variables.</p><p>To begin, open the <code>MovieDocument.h</code> declaration file in your Xcode project. Follow these steps to add to your existing code in the file:</p><ol class="ol"><li class="li"><p> Insert the following line of code in the <code>@interface</code> directive block after your export outlet declarations. This enables you to specify the movie attributes for your NSDrawer object:</p><div class="codesample"><table><tr><td scope="row"><pre>IBOutlet NSDrawer  *mDrawer;<span></span></pre></td></tr></table></div></li><li class="li"><p>Add the following code (also in the <code>@interface</code> block) to specify the drawer elements for your movie attributes:</p><div class="codesample"><table><tr><td scope="row"><pre> IBOutlet NSTextField *mCurrentSize;<span></span></pre></td></tr><tr><td scope="row"><pre>    IBOutlet NSTextField *mDuration;<span></span></pre></td></tr><tr><td scope="row"><pre>    IBOutlet NSTextField *mNormalSize;<span></span></pre></td></tr><tr><td scope="row"><pre>    IBOutlet NSTextField *mSourceName;<span></span></pre></td></tr><tr><td scope="row"><pre>    IBOutlet NSTextField *mTimeDisplay;<span></span></pre></td></tr></table></div></li><li class="li"><p>Define a getter for your drawer with the following line of code:</p><div class="codesample"><table><tr><td scope="row"><pre>- (id)drawer;<span></span></pre></td></tr></table></div></li><li class="li"><p>Add to your IBActions to toggle the drawer open and closed, with the following line of code:</p><div class="codesample"><table><tr><td scope="row"><pre>- (IBAction)toggleDrawer:(id)sender;<span></span></pre></td></tr></table></div></li><li class="li"><p>Insert the following methods before the <code>@end</code> directive in the file: </p><div class="codesample"><table><tr><td scope="row"><pre>- (void)setDurationDisplay;<span></span></pre></td></tr><tr><td scope="row"><pre>- (void)setNormalSizeDisplay;<span></span></pre></td></tr><tr><td scope="row"><pre>- (void)setCurrentSizeDisplay;<span></span></pre></td></tr><tr><td scope="row"><pre>- (void)setSource:(NSString *)name;<span></span></pre></td></tr><tr><td scope="row"><pre>- (void)setTimeDisplay;<span></span></pre></td></tr></table></div></li><li class="li"><p>Add these two methods to install and remove the movie callback before the <code>@end</code> directive in the file:</p><div class="codesample"><table><tr><td scope="row"><pre>-(void)removeMovieIdleCallback;<span></span></pre></td></tr><tr><td scope="row"><pre>-(void)installMovieIdleCallback;<span></span></pre></td></tr></table></div></li></ol><a name="//apple_ref/doc/uid/TP40001245-CH207-TPXREF127" title="Adding Code To Make the Drawer Work"></a><h3>Adding Code To Make the Drawer Work</h3><p>In this next sequence of steps, you’ll be adding a larger chunk of code to your <code>MovieDocument.m</code> implementation file. </p><p>To begin, open the <code>MovieDocument.m</code> file in your Xcode project. You’ll add the following blocks of code to your file. Just follow these steps:</p><ol class="ol"><li class="li"><p>After your import and <code>#define</code> statements, add this line of C code to set your timer display. You pass your movie document in the <code>refcon</code> parameter and that gives you a way to call the <code>setTimeDisplay:</code> method. This is the function prototype you add: </p><div class="codesample"><table><tr><td scope="row"><pre>pascal Boolean MyActionFilter (MovieController mc, short action, void* params, long refCon);<span></span></pre></td></tr></table></div><p>As the movie is being serviced by QuickTime, the movie controller component calls your action filter procedure each time the component receives an action for its movie controller. You use the idle action in your filter procedure to update your timer display.</p></li><li class="li"><p>Next, you want to add these initializations for your movie drawer items. Insert these lines:</p><div class="codesample"><table><tr><td scope="row"><pre>-(void)awakeFromNib<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    // initialize movie drawer items<span></span></pre></td></tr><tr><td scope="row"><pre>    [self setDurationDisplay];<span></span></pre></td></tr><tr><td scope="row"><pre>    [self setNormalSizeDisplay];<span></span></pre></td></tr><tr><td scope="row"><pre>    [self setCurrentSizeDisplay];<span></span></pre></td></tr><tr><td scope="row"><pre>    [self setSource:[self fileName]];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>You want to return the <code>mDrawer</code> instance variable. Insert these lines before you add your setters, in a block identified as Getters:</p><div class="codesample"><table><tr><td scope="row"><pre>- (id)drawer<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return mDrawer;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Now you want to add the following block of code, which enables you to read the movie. This is also where you install the movie action callback. Add these lines:</p><div class="codesample"><table><tr><td scope="row"><pre>- (BOOL)readFromFile:(NSString *)fileName ofType:(NSString *)type<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    BOOLsuccess = NO;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // read the movie<span></span></pre></td></tr><tr><td scope="row"><pre>    if ([QTMovie canInitWithFile:fileName])<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        if ([type isEqualTo:@"MovieDocumentData"])<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            NSData*data = [NSData dataWithContentsOfFile:fileName];<span></span></pre></td></tr><tr><td scope="row"><pre>            [self setMovie:[QTMovie movieWithData:data error:nil]];<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        else<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            [self setMovie:((QTMovie *)[QTMovie movieWithFile:fileName error:nil])];<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        success = (mMovie != nil);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if (success)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            [self installMovieIdleCallback];<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return success;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Next, you need to install a movie controller action filter. If the movie is successfully created, the callback is installed. To get the controller from the movie and set the movie control filter, add this block of code:</p><div class="codesample"><table><tr><td scope="row"><pre>-(void)installMovieIdleCallback<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    ComponentResult cr = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    MovieController mc = [mMovie quickTimeMovieController];<span></span></pre></td></tr><tr><td scope="row"><pre>    if (!mc) goto bail;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    MCActionFilterWithRefConUPP upp = NewMCActionFilterWithRefConUPP(MyActionFilter);<span></span></pre></td></tr><tr><td scope="row"><pre>    if (!upp) goto bail;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    cr = MCSetActionFilterWithRefCon(mc, upp, (long)self);<span></span></pre></td></tr><tr><td scope="row"><pre>    DisposeMCActionFilterWithRefConUPP(upp);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>bail:<span></span></pre></td></tr><tr><td scope="row"><pre>    return;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>When the movie is closed, you remove the existing callback by passing <code>NIL</code> for the callback parameter. Add these lines of code: </p><div class="codesample"><table><tr><td scope="row"><pre>-(void)removeMovieIdleCallback<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [MCSetActionFilterWithRefCon([mMovie quickTimeMovieController],<span></span></pre></td></tr><tr><td scope="row"><pre>                                nil,<span></span></pre></td></tr><tr><td scope="row"><pre>                                (long)self);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>Insert the following code to toggle the drawer state:</p><div class="codesample"><table><tr><td scope="row"><pre>- (IBAction)toggleDrawer:(id)sender<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [mDrawer toggle:sender];<span></span></pre></td></tr></table></div></li><li class="li"><p>In the next sequence of steps (8-12), you add these chunks of code to the fields in the drawer. To set the current time text field, insert this chunk of code:</p><div class="codesample"><table><tr><td scope="row"><pre>- (void)setTimeDisplay<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    if (mMovie)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        QTTime currentPlayTime = [[mMovie attributeForKey:QTMovieCurrentTimeAttribute] QTTimeValue];<span></span></pre></td></tr><tr><td scope="row"><pre>        [mTimeDisplay setStringValue:QTStringFromTime(currentPlayTime)];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>To set the duration text field, insert this chunk of code:</p><div class="codesample"><table><tr><td scope="row"><pre>- (void)setDurationDisplay<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    if (mMovie)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        [mDuration setStringValue:QTStringFromTime([mMovie duration])];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>To set the normal size text field, add this: </p><div class="codesample"><table><tr><td scope="row"><pre>- (void)setNormalSizeDisplay<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    NSMutableString *sizeString = [NSMutableString string];<span></span></pre></td></tr><tr><td scope="row"><pre>    NSSize movSize = NSMakeSize(0,0);<span></span></pre></td></tr><tr><td scope="row"><pre>    movSize = [[mMovie attributeForKey:QTMovieNaturalSizeAttribute] sizeValue];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    [sizeString appendFormat:@"%.0f", movSize.width];<span></span></pre></td></tr><tr><td scope="row"><pre>    [sizeString appendString:@" x "];<span></span></pre></td></tr><tr><td scope="row"><pre>    [sizeString appendFormat:@"%.0f", movSize.height];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    [mNormalSize setStringValue:sizeString];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>To set the current size text field, add:</p><div class="codesample"><table><tr><td scope="row"><pre>- (void)setCurrentSizeDisplay<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    NSSize movCurrentSize = NSMakeSize(0,0);<span></span></pre></td></tr><tr><td scope="row"><pre>    movCurrentSize = [[mMovie attributeForKey:QTMovieCurrentSizeAttribute] sizeValue];<span></span></pre></td></tr><tr><td scope="row"><pre>    NSMutableString *sizeString = [NSMutableString string];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (mMovie &amp;&amp; [mMovieView isControllerVisible])<span></span></pre></td></tr><tr><td scope="row"><pre>        movCurrentSize.height -= [mMovieView controllerBarHeight];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    [sizeString appendFormat:@"%.0f", movCurrentSize.width];<span></span></pre></td></tr><tr><td scope="row"><pre>    [sizeString appendString:@" x "];<span></span></pre></td></tr><tr><td scope="row"><pre>    [sizeString appendFormat:@"%.0f", movCurrentSize.height];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    [mCurrentSize setStringValue:sizeString];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>To set the source text field, add: </p><div class="codesample"><table><tr><td scope="row"><pre>- (void)setSource:(NSString *)name<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    NSArray *pathComponents = [[NSFileManager defaultManager] componentsToDisplayForPath:name];<span></span></pre></td></tr><tr><td scope="row"><pre>    NSEnumerator *pathEnumerator = [pathComponents objectEnumerator];<span></span></pre></td></tr><tr><td scope="row"><pre>    NSString *component = [pathEnumerator nextObject];<span></span></pre></td></tr><tr><td scope="row"><pre>    NSMutableString *displayablePath = [NSMutableString string];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    while (component != nil) {<span></span></pre></td></tr><tr><td scope="row"><pre>        if ([component length] > 0) {<span></span></pre></td></tr><tr><td scope="row"><pre>            [displayablePath appendString:component];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            component = [pathEnumerator nextObject];<span></span></pre></td></tr><tr><td scope="row"><pre>            if (component != nil)<span></span></pre></td></tr><tr><td scope="row"><pre>                [displayablePath appendString:@":"];<span></span></pre></td></tr><tr><td scope="row"><pre>        } else {<span></span></pre></td></tr><tr><td scope="row"><pre>            component = [pathEnumerator nextObject];<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    [mSourceName setStringValue:displayablePath];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li><li class="li"><p>After the <code>@end directive</code>, you add this chunk of code to intercept some actions for the movie controller and to update the current time display in the drawer. Note that the <code>refCon</code> parameter is a document <code>id</code>: </p><div class="codesample"><table><tr><td scope="row"><pre>pascal Boolean MyActionFilter (MovieController mc, short action, void* params, long refCon)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    MovieDocument *doc = (MovieDocument *)refCon;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    switch (action)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        // handle idle events<span></span></pre></td></tr><tr><td scope="row"><pre>        case mcActionIdle:<span></span></pre></td></tr><tr><td scope="row"><pre>            // update the current time display in the info drawer<span></span></pre></td></tr><tr><td scope="row"><pre>            if ([[doc drawer] state] != NSDrawerClosedState)<span></span></pre></td></tr><tr><td scope="row"><pre>                [doc setTimeDisplay];<span></span></pre></td></tr><tr><td scope="row"><pre>            break;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return false;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></li></ol><p>This wraps up the additions to the code you need to make in your MovieDocument implementation file. You’re now ready to build and compile your Xcode project.</p><a name="//apple_ref/doc/uid/TP40001245-CH207-SW8" title="The Completed Project"></a><h2>The Completed Project</h2><p>If you’ve followed the steps outlined in this chapter, you’ll have successfully extended the QTKitPlayer application with a Cocoa drawer you can toggle open and closed. The drawer will display and update the time of any QuickTime movie you want to play. </p><p>You can control movie playback as you have before, with QTKitPlayer functionality still in place for movie control, as shown in <span class="content_text">Figure 4-13</span>.</p><br/><div><a name="//apple_ref/doc/uid/TP40001245-CH207-BBCGBEHJ" title="Figure 4-13Open drawer with movie Show Controller selected"></a><p><strong>Figure 4-13&nbsp;&nbsp;</strong>Open drawer with movie Show Controller selected</p><img src = "../Art/open_drawer_all_playback.jpg" alt = "Open drawer with movie Show Controller selected" ></div><br/><p>In a short series of steps, you’ve significantly extended the capabilities of your QTKitKPlayer application. Now you’re ready to enhance the media player by adding the capability to stream audio and video. That’s explained in the next chapter.</p>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../Chapter04/04ExtendingSimpleQTKitApp.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../Chapter06/AddingStreaming.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2004, 2005 Apple Computer, Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2005-11-09<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/QuickTime/Conceptual/QTKitProgrammingGuide/Chapter05/AddingToQTKitPlayer.html%3Fid%3DTP40001245-2.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/QuickTime/Conceptual/QTKitProgrammingGuide/Chapter05/AddingToQTKitPlayer.html%3Fid%3DTP40001245-2.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/QuickTime/Conceptual/QTKitProgrammingGuide/Chapter05/AddingToQTKitPlayer.html%3Fid%3DTP40001245-2.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>