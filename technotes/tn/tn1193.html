<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-05-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1193: How to structure your handleCheckUpdate callback</title>       <meta name="keywords" content="JManager AWT">    <meta name="Description" content="Technical Note TN1193: This Technical Note describes why a JDK 1.1.x JManager host application running on Mac OS Classic should call JMFrameUpdate from its window-drawing code, and why it should also implement a checkUpdate callback."><meta name="categories" content="Java"><meta name="week-posted" content="Jan 31, 2000 - Feb 4, 2000"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10003032" title="How to structure your handleCheckUpdate callback"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxJava-date.html">Java</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/Java/idxGraphicsImaging-date.html" target="_blank">Java > Graphics & Imaging</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1193</div>
<div id="pageheadsub">How to structure your handleCheckUpdate callback</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left">         <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">     <tr><td width=300 valign="top" align=left scope="row">    <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>        </tr>        <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left>       <span id="menutitle">CONTENTS   <br>  <br>       </span>   </td>        </tr>        <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left>       <!-- begin_toc -->         <P id ="menutext"><A HREF = "#Section1">What's the problem?</A><BR><BR>        <A HREF = "#Section2">How do we fix it?</a><BR><BR>        <A HREF = "#Section3">Why This Hasn't Been a Problem Before</A><BR><BR><A HREF = "#References">References</A><BR><BR><A HREF="#Downloads">Downloadables</A></p></td>        </tr>        <tr>   <td width=300 align=left scope="row">       <img src="images/tnmenubottom.gif" alt="" width=300 height=16>   </td>        </tr>    </table></td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id ="introtext">A JManager host application       should call <CODE>JMFrameUpdate</CODE> from its window-drawing code, and should also       implement a <CODE>checkUpdate</CODE> callback that will call <CODE>JMFrameUpdate</CODE> if the window's       update region is non-empty. (<CODE>CheckUpdate</CODE> is called by the AWT to fix up       the display immediately if part of the window may have been invalidated       by some AWT action.)</p><!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Feb 02 2000]</h3><!-- end_date --></TD>             </TR>          </TABLE> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><a name="Section1"></a>      <H2>What's the problem?</H2>      <p>Both of these routines typically do something like this:</p>      <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>BeginUpdate(window);...JMFrameUpdate(frame,window-&gt;visRgn);...EndUpdate(window);</pre></TD></TR></TABLE></CENTER><BR><BR>      <p>This results in AWT being called while the window is in a funny state   -- the <CODE>BeginUpdate</CODE> call has clipped its <CODE>visRgn</CODE> down to just the area needing   updating, so any drawing calls can only draw in that area.</p> <p>The problem comes in if another thread gets control before the JManager   call completes. This might be any other thread, and it may perform other   AWT operations like graphics-based drawing, moving components, or updating   controls. Since whatever it draws will be clipped down to the window's   <CODE>updateRgn</CODE>, some parts of the window may not be updated, which looks ugly.</p>  <BR><A HREF = "#top">Back to top</a>      <A NAME="Section2"></A>       <H2>How do we fix it?</H2>      <p>The only workable fix turns out to involve a slight change in the way         the host app calls JManager -- and the purpose of this Technote is to         tell you to make this change. It's simple to describe:</p>      <blockquote><i>Never call JManager while within a <CODE>BeginUpdate...EndUpdate</CODE>         operation.</i></blockquote>      <p>To do this, you'll need to restructure your drawing and <CODE>checkUpdate</CODE> code         to be something like the following, which was taken nearly verbatim from         MRJShellLib, the library that runs JBound apps:</p> <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>BeginUpdate(window);.../** Called in response to a JManager checkUpdate request */void RequestedWindow::checkUpdate() {    RgnHandle update = WindowPeek(itsWindow)-&gt;updateRgn;    if (! EmptyRgn(update)) {                            /*1*/        // Determine the local/global offset:        SetPort(itsWindow);        Point globalPos = {0,0};        LocalToGlobal(&amp;globalPos);        // Compute the global rgn used for the Java Frame's content:        Rect content = itsWindow-&gt;portRect;            /*2*/        if( resizeable &amp;&amp; !theGrowboxIntrudes )            content.bottom -= 15;        OffsetRect(&amp;content, globalPos.h,globalPos.v);        RgnHandle contentUpdate = NewRgn();        RectRgn(contentUpdate,&amp;content);        // Clip the update region against the Java content region:        SectRgn(contentUpdate,update, contentUpdate);  /*3*/        OffsetRgn(contentUpdate,-globalPos.h,-globalPos.v);                                   // move back to local coordinates        // Call JMFrameUpdate *without* calling BeginUpdate,        // which mucks up the visRgn:        if( !EmptyRgn(contentUpdate) ) {               /*4*/            ValidRgn(contentUpdate);                 /*5*/            JMFrameUpdate(frameRef, contentUpdate);  /*6*/        }        DisposeRgn(contentUpdate);    }}/** Main method called to handle incoming updateEvents. */void RequestedWindow::handleUpdate( ) {    checkUpdate();   // first redraw Java content    BeginUpdate(itsWindow);    ... // draw native content here    EndUpdate(itsWindow);}</pre></TD></TR></TABLE></CENTER><BR><BR>                  <p>In essence the <CODE>checkUpdate</CODE> method does the following:</p>      <ol>        <li>Checks whether the window's <CODE>updateRgn</CODE> is non-empty; otherwise it returns.</li>        <li>Computes the region of the window allocated to the Java Frame and           converts it to global coordinates.</li>        <li>Intersects the region against the window's <CODE>updateRgn</CODE>.</li>        <li>If the resulting region is empty, it returns.</li>        <li>Otherwise it calls <CODE>ValidRgn</CODE> with that region, to remove it from the           <CODE>updateRgn</CODE>.</li>        <li>Then finally it calls <CODE>JMFrameUpdate</CODE>, passing in the clipped region.</li>      </ol>      <p>Note that in the <CODE>checkUpdate</CODE> method we've avoided using <CODE>Begin/EndUpdate</CODE>         at all. The main <CODE>handleUpdate</CODE> method still needs to use them, to correctly         clip the drawing of the native content, but it calls <CODE>checkUpdate</CODE> <i>first</i>,         before calling <CODE>BeginUpdate</CODE>. (Alternatively, you might need to draw the         Java content after the native content; if so, you'll have to save a copy         of the <CODE>updateRgn</CODE> before calling <CODE>BeginUpdate</CODE>, since otherwise it'll be         lost.)</p>            <BR><A HREF = "#top">Back to top</a>         <A NAME="Section3"></A>                  <H2>Why This Hasn't Been a Problem         Before</H2>         <P>This never showed up before MRJ 2.2 because the main thread, which handles JManager calls, runs at the highest possible priority, and with the older thread scheduler it used to be impossible for any other thread to get control while this thread was active. But with MRJ 2.2's new "fair share" scheduler, other threads sometimes get time to run.</P>         <BR><A HREF = "#top">Back to top</a><a name="References"></a><H2>References</H2>        <p><A HREF = "http://developer.apple.com/documentation/java/LegacyAPI/JManager/JManager.html">           Programming with JManager for MRJ 2.1</A></p>        <p><A HREF = "ftp://ftp.apple.com/developer/Development_Kits/MRJ_SDK_2.1.sit.hqx">MRJ           2.1 SDK</A></p>      <BR><P><A HREF="#top">Back to top</A></P><A NAME="Downloads"></A> <h2>Downloadables</h2>        <center><TABLE BORDER=0 CELLPADDING=3 WIDTH="600">         <TR>             <td width=50 align=left>               <P ALIGN=center><img src="images/acrobatsmall.gif" align=middle alt="Acrobat" height=23 width=22></P>            </TD>            <td align="left">               <p>Acrobat version of this Note (60K).</P>            </TD>            <td width=60 align=left>               <p><A HREF="pdf/tn1193.pdf">Download</A></P>            </TD>          </TR> </table></center><BR><BR><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1193.html%3Fid%3DDTS10003032-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1193.html%3Fid%3DDTS10003032-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1193.html%3Fid%3DDTS10003032-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>