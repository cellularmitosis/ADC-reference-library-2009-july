<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Automator Programming Guide: Implementing an Objective-C Action</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Implementing an Objective-C Action"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP40001513" title="Implementing an Objective-C Action"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000418" target="_top">Apple Applications</a> &gt; <a href="../../../Automator-date.html#//apple_ref/doc/uid/TP30000440-TP30000418-TP40001673" target="_top">Automator</a> &gt; <a href="../index.html" target="_top">Automator Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="ImplementScriptAction.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="ShellScriptActions.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>
        
        
        <a name="//apple_ref/doc/uid/TP40001513-BCICCECC" title="Implementing an Objective-C Action"></a><hr /><H1>Implementing an Objective-C Action</H1><p><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_300"></a><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_301"></a><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_302"></a>The particular advantage of actions written in Objective-C (compared to AppleScript actions) is that they have greater access to the range of system resources of Mac OS X. Actions that use Objective-C code can incorporate the features not only of Objective-C frameworks such as Foundation<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_303"></a> and Application Kit<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_304"></a> but of virtually any other framework (Because Objective-C is a superset of ANSI C<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_305"></a>, an Objective-C class can call functions published in a C interface). Purely Objective-C actions have an offsetting disadvantage: they cannot easily control applications or access their features except for those applications that offer a public API.</p><p>In general, data that Automator pipes through the actions of a workflow<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_306"></a> is assumed to be AppleScript-compatible. If it detects that an action is based on Objective-C, however, Automator converts it into an Objective-C object that the action can deal with. It also takes the objects that Objective-C actions provide and converts them into a form suitable for AppleScript-based actions.</p>
<!-- This template is being used for both PDF and HTML. -->

    
    <!-- TopicBook.pm uses this template for its miniTOCs, but needs a different title. -->
    <h4>Contents:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="ImplementObjCAction.html#//apple_ref/doc/uid/TP40001513-96870">Specifying Cocoa Type Identifiers</a>
				
			<br/>
			
        
			
			
				<a href="ImplementObjCAction.html#//apple_ref/doc/uid/TP40001513-96896">Implementing runWithInput:fromAction:error:</a>
				
			<br/>
			
        
			
			
				<a href="ImplementObjCAction.html#//apple_ref/doc/uid/TP40001513-98935-BBCJIBEE">Updating Action Parameters</a>
				
			<br/>
			
        
			
			
				<a href="ImplementObjCAction.html#//apple_ref/doc/uid/TP40001513-99173">Loading and Executing Scripts</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP40001513-96870" title="Specifying Cocoa Type Identifiers"></a><h2>Specifying Cocoa Type Identifiers</h2><p>An action that is purely based on Objective-C must have Cocoa-specific type identifiers<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_307"></a> for its <code>AMAccepts<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_308"></a></code> and <code>AMProvides<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_309"></a></code> properties. Currently there are three Cocoa public type identifiers:</p><ul class="ul"><li class="li"><p><code>com.apple.cocoa.string</code> —An NSString for text</p></li><li class="li"><p><code>com.apple.cocoa.path</code> — An NSString for full file-system paths</p></li><li class="li"><p><code>com.apple.cocoa.url</code> —An NSURL for URLs</p></li></ul><p>For example, if you were to specify <code>com.apple.cocoa.path</code> as the sole type identifier of the <code>AMAccepts</code> property, the input object in the <code>runWithInput:fromAction:error:</code> method would an NSString object representing a path (or an array of such string objects). If you were to specify <code>com.apple.cocoa.url</code> as the type identifier of the <code>AMProvides</code> property, you would have to return an NSURL object (or an array of NSURL objects) in your implementation of <code>runWithInput:fromAction:error:</code>.</p><p>For further discussion of the Cocoa type identifiers, see <span class="content_text"><a href="AutomatorPropRef.html#//apple_ref/doc/uid/TP40001515-101803">“Type Identifiers.”</a></span></p><div class="notebox"><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_20" title="Note"></a><p><strong>Note:</strong>&nbsp;UTI type identifiers designating other types of input and output data for Objective-C actions are planned for future versions of Mac OS X.</p></div><a name="//apple_ref/doc/uid/TP40001513-96896" title="Implementing runWithInput:fromAction:error:"></a><h2>Implementing runWithInput:fromAction:error:</h2><p>In your custom subclass of AMBundleAction<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_310"></a> you must override the method <code>runWithInput:fromAction:error:</code><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_311"></a> (inherited from the AMAction class). Aside from specifying the Cocoa type identifiers in your <code>AMAccepts</code> and <code>AMProvides</code> properties, this method implementation is the only requirement for a purely Objective-C action.</p><p>If an action does not have to deal with the input data handed it—for example, its role is to select some items in the file system—the implementation of <code>runWithInput:fromAction:error:</code> can return whatever it is designed to provide without touching the input data. In the example in <span class="content_text">Listing 1</span>, the action returns a list of paths to movies selected in its user interface (and stored in its parameters):</p><a name="//apple_ref/doc/uid/TP40001513-98426-BBCEFBAA" title="Listing 1An Objective-C action that does not handle its input object"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP40001513-98426" title="Listing 1An Objective-C action that does not handle its input object"></a><strong>Listing 1&nbsp;&nbsp;</strong>An Objective-C action that does not handle its input object</p><div class="codesample"><table><tr><td scope="row"><pre>- (id)runWithInput:(id)input fromAction:(AMAction *)anAction<span></span></pre></td></tr><tr><td scope="row"><pre>        error:(NSDictionary **)errorInfo {<span></span></pre></td></tr><tr><td scope="row"><pre>    return [[self parameters] objectForKey:@"movieFiles"];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>However, most actions operate on the input data given them from the previous action. The input object and the output object for an action<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_312"></a><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_313"></a> are almost always NSArray objects because the <code>Container</code><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_314"></a> subproperties of <code>AMAccepts</code><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_315"></a> and <code>AMProvides</code><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_316"></a> are by default lists<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_317"></a> (equivalent to NSArray objects <a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_318"></a>in Objective-C). Many Objective-C actions implement <code>runWithInput:fromAction:error:</code> using a general approach that is similar to a typical <code>on run</code> handler in an AppleScript-based action:</p><ol class="ol"><li class="li"><p>If the container type of the action’s <code>AMProvides</code> property is List, prepare an output array for later use (usually by creating an NSMutableArray object).</p></li><li class="li"><p>Iterate through the elements of the input array and for each perform whatever operation is required and write the resulting data item to the output array.</p></li><li class="li"><p>Return the output array.</p></li></ol><a name="//apple_ref/doc/uid/TP40001513-99834-BBCJBGHD" title="Listing 2Implementing runWithInput:fromAction:error:"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP40001513-99834" title="Listing 2Implementing runWithInput:fromAction:error:"></a><strong>Listing 2&nbsp;&nbsp;</strong>Implementing runWithInput:fromAction:error:</p><div class="codesample"><table><tr><td scope="row"><pre>- (id)runWithInput:(id)input fromAction:(AMAction *)anAction error:(NSDictionary **)errorInfo<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    NSMutableArray *returnArray = [NSMutableArray arrayWithCapacity:[input count]];<span></span></pre></td></tr><tr><td scope="row"><pre>    NSEnumerator *enumerate = [input objectEnumerator];<span></span></pre></td></tr><tr><td scope="row"><pre>    NSString *xmlFile;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    while (xmlFile = [enumerate nextObject]) {<span></span></pre></td></tr><tr><td scope="row"><pre>        NSError *anError=nil;<span></span></pre></td></tr><tr><td scope="row"><pre>        NSString *returnStr;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        NSXMLDocument *xmlDoc = [[NSXMLDocument alloc] initWithContentsOfURL:[NSURL fileURLWithPath:xmlFile] options:nil error:&amp;anError];<span></span></pre></td></tr><tr><td scope="row"><pre>        NSLog(@"XML document = %@", [xmlDoc description]);<span></span></pre></td></tr><tr><td scope="row"><pre>        if (!xmlDoc) {<span></span></pre></td></tr><tr><td scope="row"><pre>            [returnArray addObject:[NSString stringWithFormat: @"ERROR: Could not make document from file: %@\n", xmlFile]];<span></span></pre></td></tr><tr><td scope="row"><pre>            continue;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        if (anError) {<span></span></pre></td></tr><tr><td scope="row"><pre>            [returnArray addObject:[NSString stringWithFormat: @"ERROR: Error in processing file %@, because = %@\n", xmlFile, [anError localizedDescription]]];<span></span></pre></td></tr><tr><td scope="row"><pre>            continue;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        NSString *queryStr;<span></span></pre></td></tr><tr><td scope="row"><pre>        if ([[[self parameters] objectForKey:@"elementAttributeChoice"] intValue]) { // attribute<span></span></pre></td></tr><tr><td scope="row"><pre>            queryStr = [NSString stringWithFormat:@".//@%@/text()", [[self parameters] objectForKey:@"elementAttributeName"]];<span></span></pre></td></tr><tr><td scope="row"><pre>        } else {<span></span></pre></td></tr><tr><td scope="row"><pre>            queryStr = [NSString stringWithFormat:@".//%@/text()",  [[self parameters] objectForKey:@"elementAttributeName"]];<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        anError = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>        NSArray *results = [xmlDoc nodesForXPath:queryStr error:&amp;anError];<span></span></pre></td></tr><tr><td scope="row"><pre>        if (anError) {<span></span></pre></td></tr><tr><td scope="row"><pre>            [returnArray addObject:[NSString stringWithFormat: @"ERROR: Error in XQuery because = %@\n", [anError localizedDescription]]];<span></span></pre></td></tr><tr><td scope="row"><pre>            continue;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        [returnArray addObject:[NSString stringWithFormat:@"\n--------- Found in file %@ ----------\n", xmlFile]];<span></span></pre></td></tr><tr><td scope="row"><pre>        int i, count = [results count];<span></span></pre></td></tr><tr><td scope="row"><pre>        for (i = 0; i &lt; count; i++) {<span></span></pre></td></tr><tr><td scope="row"><pre>            [returnArray addObject:[results objectAtIndex:i]];<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        [xmlDoc release];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return returnArray;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Some actions in their <code>AMAccepts</code><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_319"></a> property specify that their input<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_320"></a><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_321"></a> is optional (that is, the <code>Optional</code><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_322"></a> subproperty is set to <code>&lt;true/></code>). This setting allow users to select a “Ignore Result...” item from an input type pop-up button in the action’s view. If your action has made input optional in its <code>AMAccepts</code> property, you need to determine if the user has made this choice by sending the action an <code>ignoresInput</code><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_323"></a> message; if the response is <code>YES</code>. you do not need to do anything with the input object.</p><p>If your action encounters an error that prevents it from proceeding, it should give information describing the error to Automator, which then stops executing the workflow and displays an error alert. The last parameter of the <code>runWithInput:fromAction:error:</code> method is a pointer to an NSDictionary object. To report errors<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_324"></a><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_325"></a><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_326"></a>, you must create a dictionary containing two key-value pairs and return this object to Automator indirectly. The two dictionary properties are:</p><ul class="ul"><li class="li"><p><code><!--a  -->OSAScriptErrorNumber<!--/a--></code><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_327"></a>—Takes an error number encapsulated as an NSNumber object.</p><p>For suitable error codes, see the <code>MacErrors.h</code> header file of the Carbon Core framework, especially the error codes specific to the OSA framework.</p></li><li class="li"><p><code><!--a  -->OSAScriptErrorMessage<!--/a--></code><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_328"></a>—Takes an NSString object containing a description of the error.</p></li></ul><p>Because the code example in <span class="content_text"><a href="ImplementObjCAction.html#//apple_ref/doc/uid/TP40001513-99834-BBCJBGHD">Listing 2</a></span> output is text, it reports errors such as the lack of a valid document as part of the output. But what if this were a fatal error that required the action to stop executing? <span class="content_text">Listing 3</span> illustrates how you might handle such an error.</p><a name="//apple_ref/doc/uid/TP40001513-99569-BBCIADEA" title="Listing 3Reporting a fatal error to Automator"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP40001513-99569" title="Listing 3Reporting a fatal error to Automator"></a><strong>Listing 3&nbsp;&nbsp;</strong>Reporting a fatal error to Automator</p><div class="codesample"><table><tr><td scope="row"><pre>if (!xmlDoc) {<span></span></pre></td></tr><tr><td scope="row"><pre>    NSArray *objsArray = [NSArray arrayWithObjects:<span></span></pre></td></tr><tr><td scope="row"><pre>        [NSNumber numberWithInt:errOSASystemError],<span></span></pre></td></tr><tr><td scope="row"><pre>        [NSString stringWithFormat:@”ERROR:<span></span></pre></td></tr><tr><td scope="row"><pre>            Could not make document from file: %@\n", xmlFile], nil];<span></span></pre></td></tr><tr><td scope="row"><pre>    NSArray *keysArray = [NSArray arrayWithObjects:OSAScriptErrorNumber,<span></span></pre></td></tr><tr><td scope="row"><pre>        OSAScriptErrorMessage, nil];<span></span></pre></td></tr><tr><td scope="row"><pre>    *errorInfo = [NSDictionary dictionaryWithObjects:objsArray<span></span></pre></td></tr><tr><td scope="row"><pre>        forKeys:keysArray];<span></span></pre></td></tr><tr><td scope="row"><pre>    return nil;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Your action has the entire gamut of possibility available to Cocoa applications. It can message Cocoa-framework objects and custom objects from its AMBundleAction subclass, and it can define and implement as many other supporting classes, protocols, and categories as is needed to accomplish the task of the action. An Objective-C action could choose to do any of the following things:</p><ul class="ul"><li class="li"><p>Execute a command-line tool using an NSTask<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_329"></a> object.</p></li><li class="li"><p>Perform animation using NSAnimation<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_330"></a><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_331"></a> or NSViewAnimation.</p></li><li class="li"><p>Spin off multiple secondary threads using Foundation’s threading support.</p></li><li class="li"><p>Communicate with other applications using distributed objects<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_332"></a> or distributed notifications<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_333"></a>.</p></li><li class="li"><p>Use a C-language framework; for example, you could use Core Graphics<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_334"></a> to draw an image directly to the screen.</p></li></ul><p>An Objective-C has only two restrictions<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_335"></a><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_336"></a><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_337"></a> related to its implementation of <code>runWithInput:fromAction:error:</code>. It cannot return until it has completely finished whatever processing it has initiated. For instance, if an action instructs a camera to take a picture (an asynchronous process) it cannot return from <code>runWithInput:fromAction:error:</code> method until the picture is taken. So the action has to implement whatever blocking algorithm, timeout logic, or threading strategy is necessary until the picture is taken. The second restriction has to do with Automator’s threading architecture<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_338"></a>. Because Objective-C actions run on a secondary thread, if they want to display a window it must be done on the main thread. The <code>performSelectorOnMainThread:withObject:waitUntilDone:</code> method is adequate for this purpose; for example:</p><div class="codesample"><table><tr><td scope="row"><pre>self performSelectorOnMainThread:@selector(showPreviewWithData:) withObject:data waitUntilDone:YES]<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_339"></a><a name="//apple_ref/doc/uid/TP40001513-98935" title="Updating Action Parameters"></a><a name="//apple_ref/doc/uid/TP40001513-98935-BBCJIBEE" title="Updating Action Parameters"></a><h2>Updating Action Parameters</h2><p>A typical action uses the bindings technology of Cocoa to synchronize<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_340"></a><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_341"></a> the settings on an action’s user interface with the action’s parameters<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_342"></a> attribute. (See <span class="content_text"><a href="DevelopAction.html#//apple_ref/doc/uid/TP40001511-96877">“Constructing the User Interface”</a></span> in <span class="content_text"><a href="DevelopAction.html#//apple_ref/doc/uid/TP40001511-BAJBICGH">“Developing an Action.”</a></span>) But an action is not required to use bindings to do this synchronization. It can choose to do it manually by implementing the <code>updateParameters</code><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_343"></a> and <code>parametersUpdated</code><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_344"></a> methods. These methods are invoked went it is time to run or save the action.</p><p>The <code><!--a  -->updateParameters<!--/a--></code> method is invoked when the parameters attribute of the action (an NSDictionary object) needs to be refreshed from the settings and values the user has specified in the user interface. The <code>parametersUpdated</code> method is invoked for the opposite reason: to make the pop-up items, buttons, text fields, and other objects in the action’s view reflect the current contents of the action’s parameters, especially when those contents change programmatically.</p><p><span class="content_text">Listing 4</span> shows a typical implementation of the <code>updateParameters</code> method.</p><a name="//apple_ref/doc/uid/TP40001513-98969-CJBBIAEH" title="Listing 4Updating an Objective-C action&acirc;&#128;&#153;s parameters manually"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP40001513-98969" title="Listing 4Updating an Objective-C action&acirc;&#128;&#153;s parameters manually"></a><strong>Listing 4&nbsp;&nbsp;</strong>Updating an Objective-C action’s parameters manually</p><div class="codesample"><table><tr><td scope="row"><pre>- (void)updateParameters<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    // text<span></span></pre></td></tr><tr><td scope="row"><pre>    NSString *outputFile = [_outputFilePath stringValue];<span></span></pre></td></tr><tr><td scope="row"><pre>    if (outputFile)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        [[self parameters] setObject:outputFile forKey:@"outputFilePath"];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    NSString *waitSeconds = [_waitSeconds stringValue];<span></span></pre></td></tr><tr><td scope="row"><pre>    if (waitSeconds)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        [[self parameters] setObject:[NSNumber numberWithInt:<span></span></pre></td></tr><tr><td scope="row"><pre>            [_waitSeconds intValue]] forKey:@"waitSeconds"];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // radios<span></span></pre></td></tr><tr><td scope="row"><pre>    [[self parameters] setObject:[NSNumber numberWithInt:<span></span></pre></td></tr><tr><td scope="row"><pre>        [_interactiveType selectedRow]] forKey:@"interactiveType"];<span></span></pre></td></tr><tr><td scope="row"><pre>    [[self parameters] setObject:[NSNumber numberWithInt:<span></span></pre></td></tr><tr><td scope="row"><pre>        [_screenShotType indexOfSelectedItem]] forKey:@"screenshotType"];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // popup<span></span></pre></td></tr><tr><td scope="row"><pre>    [[self parameters] setObject:[NSNumber numberWithInt:<span></span></pre></td></tr><tr><td scope="row"><pre>        [_outputType indexOfSelectedItem]] forKey:@"outputType"];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // checks<span></span></pre></td></tr><tr><td scope="row"><pre>    [[self parameters] setObject:[NSNumber numberWithBool:<span></span></pre></td></tr><tr><td scope="row"><pre>        [_captureMainMonitorOnly state]] forKey:@"captureMainMonitorOnly"];<span></span></pre></td></tr><tr><td scope="row"><pre>    [[self parameters] setObject:[NSNumber numberWithBool:<span></span></pre></td></tr><tr><td scope="row"><pre>        [_disableSounds state]] forKey:@"disableSounds"];<span></span></pre></td></tr><tr><td scope="row"><pre>    [[self parameters] setObject:[NSNumber numberWithBool:<span></span></pre></td></tr><tr><td scope="row"><pre>        [_timedScreenshot state]] forKey:@"timedScreenshot"];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>You can also update an action’s parameters to include miscellaneous data that can stay with the action as it is, for example, copied to the pasteboard or written to disk in a workflow. When Automator archives an action it includes the action’s parameters with the archive, and thus objects stored in the parameters can be unarchived and retrieved. The only restriction is that the Foundation object saved to an action’s parameters must be a property-list object—that is, an NSData, NSDate, NSNumber, NSString, NSArray, or NSDictionary object. Any object that is not one of these must be converted to a property-list object before it can be archived.</p><p>Objects that represent URLs—in other words, instances of NSURL—are an important case in point. URLs are a type of data (identified with UTI <code>public.url</code>) that actions occasionally deal with. Fortunately, there are methods for converting NSURL objects to and from a property-list object. The code in <span class="content_text">Listing 5</span> converts an NSURL object to an NSString object and stores that in the action parameters.</p><a name="//apple_ref/doc/uid/TP40001513-115634-BBCGBEJG" title="Listing 5Saving an NSURL object to parameters as a string object"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP40001513-115634" title="Listing 5Saving an NSURL object to parameters as a string object"></a><strong>Listing 5&nbsp;&nbsp;</strong>Saving an NSURL object to parameters as a string object</p><div class="codesample"><table><tr><td scope="row"><pre>NSMutableDictionary* params;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>if (mFilterURL) // NSURL object<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    NSString* path = [mFilterURL path];<span></span></pre></td></tr><tr><td scope="row"><pre>    params = [NSMutableDictionary dictionaryWithObject:path  forKey:@"URL" ];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    [self setParameters:params];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Now when the action is archived the URL is stored with it, and when it is unarchived the URL is retrievable. The code fragment in <span class="content_text">Listing 6</span> restores the NSURL object from the NSString object stored in the action parameters.</p><a name="//apple_ref/doc/uid/TP40001513-115803-BBCCHAJH" title="Listing 6Restoring an NSURL object from an action&acirc;&#128;&#153;s parameters"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP40001513-115803" title="Listing 6Restoring an NSURL object from an action&acirc;&#128;&#153;s parameters"></a><strong>Listing 6&nbsp;&nbsp;</strong>Restoring an NSURL object from an action’s parameters</p><div class="codesample"><table><tr><td scope="row"><pre>NSURL* filterURL = nil;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>NSMutableDictionary* params = [self parameters];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>NSString* path = [params objectForKey: @"URL"];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>if (path) filterURL = [NSURL fileURLWithPath:path];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>if (filterURL)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>   // do something with filterURL here<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>This example uses <code>fileURLWithPath:</code> to create an NSURL object representing a file-scheme URL. If you want a URL object with a different scheme, you would use something such as <code>URLWithString:</code>, an NSURL class method. However, the string for this method must contain any necessary percent-escape codes. The easiest way to obtain such a string is to send <code>absoluteString</code> to the NSURL object before storing the URL string in the action parameters. If your action for some reason does not deal with absolute URLs, then it must devise a way to save and restore the various parts of the URL. </p><a name="//apple_ref/doc/uid/TP40001513-99173" title="Loading and Executing Scripts"></a><h2>Loading and Executing Scripts</h2><p>Objective-C actions can also include AppleScript code that they load and execute, making them in effect hybrid actions. The OSA framework<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_345"></a> and the Foundation framework<a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_346"></a> contain a number of classes (OSAScript, NSAppleScript, NSAppleEventDescriptor, and more) that enable creation, preparation, and execution of objects representing AppleScript scripts.</p><p><span class="content_text">Listing 7</span> illustrates how an action gets an AppleScript script either from its user interface or its parameters, creates an OSAScript object with it, and then compiles and executes the script.</p><a name="//apple_ref/doc/uid/TP40001513-99191-BBCCDFJG" title="Listing 7Executing an AppleScript script in an Objective-C action"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP40001513-99191" title="Listing 7Executing an AppleScript script in an Objective-C action"></a><strong>Listing 7&nbsp;&nbsp;</strong>Executing an AppleScript script in an Objective-C action</p><div class="codesample"><table><tr><td scope="row"><pre>- (OSAScript *)script<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSAScript *script = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    NSString *source = nil;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if ([self controller])<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        [[self controller] compileScript:self];<span></span></pre></td></tr><tr><td scope="row"><pre>        source = [[[self controller] scriptView] string];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        source = [self source];<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (source)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        script = [[OSAScript alloc] initWithSource:source language:[OSALanguage defaultLanguage]];<span></span></pre></td></tr><tr><td scope="row"><pre>        if (script)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            NSDictionary *errorInfo;<span></span></pre></td></tr><tr><td scope="row"><pre>            [script compileAndReturnError:&amp;errorInfo];<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    return [script autorelease];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (NSString *)source<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return [[self parameters] objectForKey:@"RunScriptSource"];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)setSource:(NSString *)source<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [[self parameters] setObject:source forKey:@"RunScriptSource"];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_347"></a><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_348"></a><a name="//apple_ref/doc/uid/TP40001513-DontLinkElementID_349"></a></p>

        <br/><br/> 

        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="ImplementScriptAction.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="ShellScriptActions.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2004, 2007 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2007-12-11<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/AppleApplications/Conceptual/AutomatorConcepts/Articles/ImplementObjCAction.html%3Fid%3DTP40001450-3.5&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/AppleApplications/Conceptual/AutomatorConcepts/Articles/ImplementObjCAction.html%3Fid%3DTP40001450-3.5&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/AppleApplications/Conceptual/AutomatorConcepts/Articles/ImplementObjCAction.html%3Fid%3DTP40001450-3.5&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>
