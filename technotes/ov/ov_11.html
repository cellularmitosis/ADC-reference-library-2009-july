<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note OV11: The Joy Of Being 32-Bit Clean</title><meta name="keywords" content="Mac OS 8 32-bit A/UX compatibility CDEF WDEF"><meta name="Description" content="Technical Note OV11: This Technical Note provides an overviewof what applications should do in order to be compatiblewith 32 bit systems and A/UX. Common fallacies of programmingfor A/UX are listed including: Use of the Memory Manager,Resource Manager, WDEFs and CDEFs, and Trap Patches.">                                       <meta name="categories" content="Overview"><meta name="week-posted" content="Sep 26, 1988 - Oct 7, 1988"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002609" title="The Joy Of Being 32-Bit Clean"></a><A NAME="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/index.html" target="_blank">Reference Library</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note OV11</div>
<div id="pageheadsub">The Joy Of Being 32-Bit Clean</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Section1">Introduction</A><br><br><A HREF="#Section2">General Rules</A><br><br><A HREF="#Section3">Hardware &amp; CPUs</A><br><br><A HREF="#Section4">Memory Manager</A><br><br><A HREF="#Section5">Resource Manager</A><br><br><A HREF="#Section6">WDEFs and CDEFs</A><br><br><A HREF="#Section7">File System</A><br><br><A HREF="#Section8">Low-Memory Globals</A><br><br><A HREF="#Section9">Trap Patches</A><br><br><A HREF="#Section10">Sound</A><br><br><A HREF="#References">References</A><br><br>	 <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">What to do (and what <b>not</b> to do) to make your programs run under A/UX andfuture versions of the Macintosh System Software.</p> <!-- end_intro_text --><!-- begin_date --><h3 align=center>[Oct 01 1988]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content -->        <A NAME=Section1></A><h2>Introduction</h2><p>Many programs available today will not run in a 32-bit world.  Currently theMacintosh OS runs in a 24-bit world, where the hardware ignores the high byte of all memory addresses (including pointers and handles).  Under A/UX (and future versions of the Macintosh OS), programs must run in a 32-bit world, where the entire address is significant.  This Technical Note presents guidelines which you should follow to make your program work under A/UX and future versions of the Macintosh OS.  Following these guidelines means a little extra work, but it is this extra work now which will bring you the joy of being 32-bit clean when the world changes and you don't have to rewrite your program.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>Much of the information presented here has already been discussed in one or more of the documents referenced at the end of this Note, but it isbeing repeated here because of the importance of the subject matter.</P></TD></TR></TABLE></CENTER><BR><p>Keep in mind that the rules presented here are not graven in stone.  Althoughyou may find it necessary to break some of these rules to achieve specificfunctionality in your program, it is important to remember that in doing so,you will cause your program to break in the future.  Keeping your programcompatible is your responsibility as well as Apple's.</p><p>If you are unsure about a particular programming technique or feel that youmust break a rule to accomplish your goals, contact Macintosh DeveloperTechnical Support at the address listed in Technical Note #0 to see if there isanother solution to your problem or a sanctioned way of working around aparticular rule.  If you don't ask, you will never know.</p><a name="Section2"></a><P><A HREF="#top">Back to top</A></P><h2>General Rules</h2><p>The following are some general rules that you should follow to make your program more robust:</p><UL><LI>Always code defensively.  Check the error code after you make a call to the Toolbox.  Make sure your handles and pointers are not <code>NIL</code>.  Do not assume that calls will always succeed.  See <A HREF = "ov_04.html">M.OV.CompatibilityWhy</a> for more information.</li><LI>Use <code>_SysEnvirons</code> (and, if absolutely necessary, <code>HwCfgFlags</code>)to determine your system's configuration.  When checking for the processor type, make allowances for newer Motorola processors like the 68030. See <A HREF = "ov_16.html">M.OV.GestaltSysenvirons</a>for more information on <code>_SysEnvirons</code>.</li><LI>Do not check to see if MultiFinder is active (you cannot tell anyway); yourapplication should work properly with and without MultiFinder.</li><LI>Do not make assumptions about the maximum size of a piece of memory or a resource. Do not assume that the maximum distance between two objects in memory is less than 2[32] bytes.  Do not store less than 32 bits for the size of an object (e.g., PICTs) in your data structures unless you create them.</li><LI>Call <code>_NGetTrapAddress</code> for any traps you use that are not availableunder A/UX (i.e., SCSI Manager traps).  For a complete list of traps availableunder A/UX, see <i>A/UX Toolbox:  Macintosh ROM Interface</i>.</li><LI>Always use the latest version of your development system and documentation.Even though you do everything "correctly," earlier versions may have bugs orinaccuracies that could break your program.</li></ul><p>To summarize: don't make any assumptions, even if those assumptions arecurrently true. The future <b>will</b> change.</p><a name="Section3"></a><P><A HREF="#top">Back to top</A></P><h2>Hardware &amp; CPUs</h2><UL><LI>Do not assume that you are running in the processor's supervisor mode.  Donot use <code>TRAP</code> instructions or exception vectors that are reserved forfuture use by Apple or Motorola.  See the Compatibility Guidelines chapter of<i>Inside Macintosh</i>, Volume V-1 for more information.</li><LI>Never try to bypass existing interfaces to hardware devices.  Direct hardwareaccess is not available under A/UX.  Use the Serial Driver to talk to the SCC. Use the File Manager to manipulate disks.  Use the SCSI Manager to talk to your non-disk devices like scanners and printers. Use QuickDraw to draw to your screen.</li><LI>Do not use timing loops.  Different CPUs execute them at different speeds.</li></ul><a name="Section4"></a><P><A HREF="#top">Back to top</A></P><h2>Memory Manager</h2><p>Memory Manager abuse is the leading cause of death under A/UX.  Here are somecrucial points to remember:</p><UL><LI>Do not set bits in master pointers directly.  Use Memory Manager traps (e.g., <code>_HLock</code>, <code>_HGetState</code>, and <code>_HSetState</code>) instead.</li><LI>Do not use fake handles under any circumstances.  See <A HREF = "ov_04.html">M.O.CompatibilityWhy</a> for more information on <code>Handle</code> etiquette.</li><LI>When you compare master pointers, use <code>_StripAddress</code> to convert them to the correct format.  See the OS Utilities chapter of <i>Inside Macintosh</i>, Volume V and M.TE.StripAddress for more information.</li><LI>Do not make assumptions about the contents of Memory Manager data structures,including master pointers and zone headers.  These structures have changedunder A/UX, and they will change again in the future.</li></ul><a name="Section5"></a><P><A HREF="#top">Back to top</A></P><h2>Resource Manager</h2><p>Here are some guidelines for using the Resource Manager:</p><UL><LI>   Avoid opening resource files read-only unless the resource file is on anAppleShare volume.  If another application (including DAs and other types of code) opens (or already has open) the resource file for writing, you could end up with a corrupted resource map.  If you do open a resource file read-only, you should load the resources you need into memory immediately.</li><LI>Do not set resource attribute bits directly.  Use the supplied <code>_GetResAttrs</code> and <code>_SetResAttrs</code> traps.</li><LI>Do not make assumptions about the contents of Resource Manager datastructures and, especially, the resource map.  Do not try to walk the resource map.</li></ul><a name="Section6"></a><P><A HREF="#top">Back to top</A></P><h2>WDEFs and CDEFs</h2><p>In earlier versions of the System Software, the Window Manager and the ControlManager both stored the variant code (which defines how the window or control looks) in the high byte of the <code>defProc</code> field.  You should use the <code>_GetWVariant</code> and <code>_GetCVariant</code> traps to get the variant code. If writing your own WDEF or CDEF, you should use the variant parameter that is passed to you.</p><p>If you are writing your own CDEF, you have to be very careful.  Prior to System7.0, there was no way to make a CDEF fully 32-bit clean, since the <code>calcCRgns</code> message usesthe high bit of the region handle as a flag. <i>Inside Macintosh</i>, Volume I-331 says to "clear the high byte (not just the high bit) of the region handle before attempting to update the region." <b>This is wrong.</b>  You should clear just the high bit, or your code will not run under A/UX or future versions of the Macintosh OS.</p><p>The Control Manager in System 7.0 or later has a new mechanism for calculatingcontrol regions.  The following two new messages have been defined:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>CONST    calcCntlRgn = 10;    calcThumbRgn = 11;</pre>	</TD></TR></TABLE></CENTER><p>Whenever the Control Manager used to call your CDEF with the <code>calcCRgns</code> message, it will now do the following:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    IF we are in 32-bit mode        rgnHandle := Call CDEF with message calcCntlRgn OR calcThumbRgn, as appropriate    ELSE        call CDEF with old calcCRgns method, just like the good old days</pre>	</TD></TR></TABLE></CENTER><p>Old CDEFs will continue to run in 24-bit mode, but they will look funny in 32-bit mode (however, they will not crash).</p><p>If your program has custom CDEFs, you should update them to support the newmessages (along with the old ones) as soon as possible.  Supporting the newmessages will allow them to work correctly today, and in the future.</p><a name="Section7"></a><P><A HREF="#top">Back to top</A></P><h2>File System</h2><p>Avoid building path names into your application.  A/UX uses the slash (/) as apathname separator instead of the colon (:), and external file systemsimplemented by Apple and by third parties may have other restrictions.  For thesame reason, avoid hard-coding volume and file names in your program.  Try toavoid creating your own working directories.  Do not assume any particularmaximum length for file names; A/UX limits them to 14 characters while theMacintosh OS limits them to 31.</p><p>The easiest way to avoid intimate knowledge of the file system is to let<code>_SFPutFile</code> and <code>_SFGetFile</code> manage file names for you.  Referto <i>Inside Macintosh</i>, Volume I, The Standard File Package for details onthese two calls.</p><a name="Section8"></a><P><A HREF="#top">Back to top</A></P><h2>Low-Memory Globals</h2><p>A/UX does not support all of the low-memory globals, and future systems mayprovide even less support.  Unfortunately, there are some things you justcannot do on a Macintosh without using low-memory globals, so it is currentlyimpossible to avoid them entirely.  Here are some guidelines:</p><UL><LI>Avoid writing to or reading from low-memory globals unless absolutely necessary.</li><LI>Do not use low-memory globals that are labeled private, reserved for futureuse, or that are undocumented.</li><LI>Do not use low-memory globals when there is a trap or library routine which accomplishes the same task.  For example, A/UX does not have an event queue that you can access in low memory, but it does support all of the Event Manager traps for accessing the Event Queue (e.g., <code>_GetNextEvent</code>,<code>_WaitNextEvent</code>, <code>_EventAvail</code>).</li></ul><a name="Section9"></a><P><A HREF="#top">Back to top</A></P><h2>Trap Patches</h2><p>Patching traps is one of the easiest ways to break your program.  It is<b>very</b> difficult to write a trap patch that does not make incorrectassumptions about the way things work.  Many current applications patch trapsunnecessarily.  If a trap does not work the way you want, implement your owncode instead of trying to patch the required functionality into the trap.  Hereare a few guidelines to follow if you absolutely must patch a trap:</p><UL><LI>Do not assume that <code>A5</code> is valid when you call the patch.</li><LI>Do not bypass the Trap Dispatcher to call traps directly.  The performancegains are small, and there may be serious side effects.</li><LI>Do not use the Memory Manager if the trap that you are patching is not listedin "Appendix A:  Routines That Move Or Purge Memory" of <i>Inside Macintosh X-Ref</i>.</li></ul><p>Make sure that any patch you do write is not a tail patch.  A tail patch is apatch which looks at the results returned by the original patch and modifies them to suit its own purposes.  If you call the original trap routine with a <code>JSR</code> instead of a <code>JMP</code>, you have created a tail patch.</p><p>You need to avoid tail patches because many of Apple's System Software patchescheck the return address on the stack to see who called them.  If you write atail patch, you defeat these checks and may cause things to break in strangeand less than wonderful ways.</p><a name="Section10"></a><P><A HREF="#top">Back to top</A></P><h2>Sound</h2><p>If your program needs to make sounds, use the Sound Manager.  A/UX (and thegood old Macintosh XL/Lisa) does not support sound (yet), so your program should avoid relying on it if maximum compatibility is deemed desirable--we think it is.</p><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><p><i>Inside Macintosh</i>, Volume V-1, Compatibility Guidelines</p><p><i>Inside Macintosh X-Ref</i></p><p><A HREF = "ov_505.html">M.OV.Compatibility</a></p><p><A HREF = "ov_04.html">M.OV.CompatibilityWhy</a></p><p><A HREF = "ov_16.html">M.OV.GestaltSysenvirons</a></p><p><A HREF = "../me/me_06.html">M.ME.StripAddress</a></p> <P><A HREF="#top">Back to top</A></P>         <P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (60K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/ov_11.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/ov/ov_11.html%3Fid%3DDTS10002609-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/ov/ov_11.html%3Fid%3DDTS10002609-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/ov/ov_11.html%3Fid%3DDTS10002609-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>