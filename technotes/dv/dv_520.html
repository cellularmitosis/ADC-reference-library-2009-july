<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-August-01 --><!-- Includes revisions to graphics tags --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note DV520: Device Management Overview Q&amp;As</title><meta name="keywords" content="Mac OS 8 Device Management VBL cursor mouse interrupt time"><meta name="Description" content="Technical Note DV520: This Technical Note contains a collectionof archived Q&amp;As relating to Device Management --questionssent the Developer Support Center (DSC) along with answersfrom the DSC engineers. Archived questions include: Extendingthe mouse location beyond the screen boundary, Disk FirstAid 7.0 and Hard Disk setup 2.0.4, eliminating VBL animatedcursor ghosts, Re-entrancy and the Macintosh ROM, How theMacintosh Cursor mechanism works, and How to set the cursorat interrupt time.">                                       <meta name="categories" content="Devices"><meta name="week-posted" content="Oct 1, 1990 - Oct 5, 1990"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002418" title="Device Management Overview Q&As"></a><A NAME="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/idxAccessibility-date.html" target="_blank">Hardware & Drivers > Accessibility</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxATA-date.html" target="_blank">Hardware & Drivers > ATA</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxHumanInterfaceDeviceForceFeedback-date.html" target="_blank">Hardware & Drivers > Human Interface Device & Force Feedback</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note DV520</div>
<div id="pageheadsub">Device Management Overview Q&amp;As</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc --><p id="menutext"><A HREF="#Section1">Extending Macintosh mouse location beyond screen boundary</A><BR><BR><A HREF="#Section2">System 7.0, Disk First Aid 7.0, and Hard Disk Setup 2.0.4</A><BR><BR><A HREF="#Section3">Eliminating Macintosh VBL animated cursor ghosts</A><BR><BR><A HREF="#Section4">Macintosh interrupt routines and I/O</A><BR><BR><A HREF="#Section5">How the Macintosh mouse/cursor mechanism works</A><BR><BR><A HREF="#Section6">Information on the IOP Manager not available</A><BR><BR><A HREF="#Section7">How to set the Macintosh cursor at interrupt time</A><BR><BR><A HREF="#downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><p id = "introtext">This Technical Note contains a collection of archived Q&amp;As relating to a specific topic--questions sent the Developer Support Center (DSC) along with answers from the DSC engineers. Current Q&amp;As can be found on the <a href="../../qa/index.html">Macintosh Technical Q&amp;As web site</a>.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Oct 01 1990]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content --><A NAME=Section1></A><h2>Extending Macintosh mouse location beyond screen boundary</h2><p>Date Written:  2/28/92</p><p>Last reviewed:  2/28/92</p><p>We would like to watch mouse movement directly in our program. This means thatwe would like to make the mouse disappear and then watch the mouse as it movesleft and right. We do not want to have any limits on the movement from the sizeof the screen or anything like that. For instance, if the user keeps moving tothe right, we would like our "x" coordinate tracking variable to keepincreasing...</p><p>Is there any way to do this easily? I thought of taking out the mouse handlerinterrupt, watching it there, and then increasing a counter, etc. Is there aneasier way?</p><p>___</p><p>Below you'll find a generic code sample that shows how to track changes in themouse position. There are many ways of doing this, but the one included belowis pretty straightforward and can be done at the application level with nopatching involved.</p><p>You started by saying that the cursor would be hidden when you do this. That'sgood since the method below would look very bad if the cursor were visible.This method is also polling for mouse changes; you could install a VBL taskthat performs this operation as well, though it probably won't be necessary.</p><p>The low-memory globals MTemp and RawMouse contain the current mouse location;they should always equal each other when you reset CrsrNew. CrsrNew simplytells the system that the mouse has changed location. You should be able todrop this routine into any running program. (If you have MPW, modify SAMPLE.Pto call FussMouse right after initialize and it works great.)</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>procedure FussMouse;type    PointPtr=^Point;var RawMouse:PointPtr;    MTemp:PointPtr;    RandPt:Point;    CrsrNew:ptr;    CrsrCouple:ptr;    fred:Longint;    curH,curV:Longint;    numStr:str255;    aWindow:WindowPtr;begin    aWIndow:=FrontWindow;    setPort(aWIndow);    EraseRect(aWindow^.portRect);    HideCursor;{ Environment set up to draw the current location }    RawMouse:=PointPtr($82C);    MTemp:=PointPtr($828);    CrsrNew:=ptr($8CE);    CrsrCouple:=ptr($8CF);{ Pointers to the low memory globals are inited...  RawMouse and MTemp both contain the current absolute mouse position  CrsrNew is a flag that tells the system when the mouse has changed  CrsrCouple is what CrsrNew should be set to when the mouse has changed }    curH:=0;    curV:=0;    RawMouse^:=Point($00640064);    MTemp^:=Point($00640064);{Base all movement detection off of 100,100 so that we have enough room to detectall mouse movements in the negative and positive directions.}    CrsrNew^:=CrsrCouple^;    repeat        If $00640064&lt;&gt;Longint(MTemp^) then {Mouse Moved?}            begin                RandPt:=MTemp^;  {Get the current mouse location}                   RawMouse^:=Point($00640064); {Reset Low memory for the                                                 next time}                   MTemp^:=Point($00640064);                   CrsrNew^:=CrsrCouple^;                   CurH:=curH+(RandPt.h-$0064); {Compute how much the mouse                                                 has moved}                   CurV:=CurV+(RandPt.V-$0064); {and add it to our logical                                                 position}                   Moveto(10,15);  {now simply report the new position to                                    the user}                   EraseRect(aWIndow^.PortRect);                   NumToString(CurH,NumStr);                   DrawString(concat(NumStr,','));                   NumToString(CurV,NumStr);                   DrawString(NumStr);            end;    until Button;end;</pre>	</TD></TR></TABLE></CENTER><a name="Section2"></a><h2>System 7.0, Disk First Aid 7.0, and Hard Disk Setup 2.0.4</h2><p>Date Written:  7/30/91</p><p>Last reviewed:  8/1/91</p><p>We were told that it would be highly advisable to do a file-by-file back-up ofall hard drives, a fresh format, and a restore because of a bug in the B-Treealgorithms that's been fixed in the System 7.0 Golden Master. Can we do thisand then return to System 6.0.7 safely? Is Apple going to make any sort ofgeneral announcement about this problem? Also, can we expect that it is not a"contagious" problem in any way--that is, can we back things up and restorewithout worrying about it moving from disk to disk?</p><p>___</p><p>Apple is recommending that users run the final version of Disk First Aid(version 7.0) on all their hard drives to determine if there are any problemswith the B-Trees. The reason for this is that a bug has existed in theMacintosh (HFS) operating system from its inception such that the B-Treestructures for devices would become corrupted under certain EXTREMELY RAREcircumstances. If and only if DFA reports a problem that it cannot fix (it willtell you if it can or can't) should users perform a file-by-file back up oftheir data, then reformat all Apple hard drives using HD Setup before copyingfiles back. Making a mirror backup of your data will only put the damagedB-Tree catalog back onto the drive when you restore, so be sure to make yourbackup file-by-file.</p><p>Apple does not intend to make any general published announcement about thisbecause it is addressed in the System 7.0 documentation. As for the commonlyasked question, "Why should we back up our data before upgrading to System 7.0?Are we in danger of losing our data?": Backing up your data on a regular basisis always a good idea, and we are recommending it prior to installing System7.0 only because there is always a chance of data loss when major changes aremade to any system configuration. Since System 7.0 is very different in manyways from previous system software versions, some software packages are nolonger compatible under this release and conflicts can potentially cause lossof data integrity.</p><p>There has been some confusion as to what, exactly, Disk First Aid version 7.0can do. This version can detect problems with the B-Tree structures (whereasprevious versions could not--the only clue it would offer is the "unable toverify status of disk" error). It cannot fix the damage, however. Another bugthat DFA 7.0 can correct lies in the Directory Valance. This bug went generallyunnoticed for years; it usually resulted in VERY INfrequent occurrences of someannoying behaviors such as not being able to throw away an empty folder(remember the old "Trash could not be emptied because a file was busy orlocked" error?). Like the B-Tree structure corruption, this is a bug, not avirus, and is in no way contagious.</p><p>If you reformat the drive then reinstall System 6.0.x, you run the risk ofdamaging the B-Tree structures again because the bug is still present in theB-Tree Manager in ROM. Again, however, let me reiterate that it isn't easy totake it that far. Suffice it to say, you will, in fact, be almost assuredlysafe if you run DFA 7.0 occasionally to make sure your B-Tree structures areOK. If it says everything is fine, it is. If not, back up your data andreformat.</p><p>Another important step in your upgrade to System 7.0 is updating all SCSIdevice drivers by using the Hard Disk Setup (2.0.4 or later) utility for Applehard drives that accompanies the System 7.0 software (for third-party devices,refer to the vendor to determine if updated drivers are necessary) BEFOREupgrading to System 7.0. The reason for this is that these newer drivers areincompatible with Virtual Memory. Failure to update these structures willprohibit using VM--it won't even turn on--however, you'll be able to use allother features of System 7.0 without any problems provided, of course, thatyour configuration meets the recommended memory requirements and all yoursoftware is fully compatible with this system software release.</p><a name="Section3"></a><h2>Eliminating Macintosh VBL animated cursor ghosts</h2><p>Date Written:  12/14/90</p><p>Last reviewed:  7/26/91</p><p>What do I have to do to prevent an animated cursor from leaving ghosts on theMacintosh screen?</p><p>___</p><p>Make sure the low-memory global CrsrBusy is FALSE before you try to change thecursor. MacApp does this.</p><a name="Section4"></a><h2>Macintosh interrupt routines and I/O</h2><p>Date Written:  10/1/91</p><p>Last reviewed:  10/1/91</p><p>Are there any dangers in doing a synchronous read at interrupt time? Inparticular, if an asynchronous write is executing and is interrupted by asynchronous read, can the re-entrancy into the Macintosh ROM read/write codecause problems?</p><p>___</p><p>The Macintosh ROMs are not re-entrant. For this and for timing considerations,you should do as little as possible within an interrupt routine. In any case,you should not be doing I/O of any kind from within your interrupt routines.You should simply use the interrupt to do the minimum possible to respond tothe signaled condition and set indicators to your larger application to handlethe larger context, like initiating additional I/O.</p><a name="Section5"></a><h2>How the Macintosh mouse/cursor mechanism works</h2><p>Date Written:  5/3/89</p><p>Last reviewed:  6/14/93</p><p>I'm writing a tablet (mouse, pointer, etc.) driver, and I need to be able toposition the cursor and post mouseUp mouseDown events. How do I do it?</p><p>___</p><p>Here is an explanation of the Macintosh mouse/cursor mechanism, which shouldprovide the information necessary for you to place the cursor:</p><p>The mouse is a "relative" device, which means it does not return actualcoordinates; it returns a "count" or amount of movement since the last report.</p><p>When the mouse has new information, it interrupts the Macintosh. The interrupthandler adds the horizontal and vertical counts to MTemp (a low-memorylocation), and sets crsrNew to tell the system that the coordinates are new.Some time later (but before normal VBLs are executed) the cursor VBL task isexecuted, and it compares MTemp with RawMouse (which has the last value), andfigures out the delta (that is, the horizontal and vertical distance moved),and does the scaling trick depending on what the user has selected in thecontrol panel. It also updates MTemp to reflect the new value. Then it drawsthe cursor.</p><p>Here are the names and locations of the relevant low-memory locations:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    RawMouse          equ $82C               ;point    MTemp             equ $828               ;point    CrsrNew           equ $8CE               ;byte    CrsrCouple        equ $8CF               ;byte</pre>	</TD></TR></TABLE></CENTER>    <p>(NOTE: These may change in future CPUs.)</p><p>If you wish to place the cursor in an absolute location on the screen, you mustset RawMouse, and MTemp to the same value, and set CrsrNew to the same value as CrsrCouple.</p><p>Keep in mind that moving the cursor from an application may violate the HumanInterface Guidelines, possibly confusing and frustrating the user. Also keep inmind that the low-memory locations named above are not documented, and as such,are considered unsupported and volatile.</p><p>Posting mouse down/up events is a simple matter of keeping track of the laststate of your device button, and when you detect a change, you post theappropriate event. If you wish to support the ToolBox Event Manager callButton, you must also update the low-memory global MBState. The high bit ofMBState reflects the current state of the mouse button: 1 = button up, 0 =button down.</p><p>Unfortunately, the system mouse driver will change this value if it noticesthat the state of MBState is different from the state of the real mouse button.This means if there is a mouse connected to the Macintosh while your device isconnected, it will override whatever you put in MBState. On systems equippedwith ADB, this will happen only when the mouse moves, or the button is pressed.On earlier systems this happens all the time, since the button checking routinewas a VBL task, and is always executed. One possible workaround is to patchButton, and return the state of your button, rather than MBState. The obviousproblem is that you disable the real mouse from working with Button.</p><a name="Section6"></a><h2>Information on the IOP Manager not available</h2><p>Date Written:  6/29/90</p><p>Last reviewed:  12/17/90</p><p>After reading the preliminary release notes for the Macintosh IIfx, I foundmyself craving more information on the IOP interface and the IOP Manager. Wherecan I get more information about this new manager?</p><p>___</p><p>Apple will not be releasing IOP Manager information to developers because weplan on expanding the use of the IOPs in the future.</p><p>As the release notes stated, the IOP Manager can handle up to eight IOPs, butonly two are currently used. The other six cannot be used by developers,because they are reserved by Apple for this future expansion.</p><a name="Section7"></a><h2>How to set the Macintosh cursor at interrupt time</h2><p>Date Written:  5/14/90</p><p>Last reviewed:  12/17/90</p><p>How do I set the Macintosh cursor at interrupt time, such as a VBL task?</p><p>___</p><p>Changing the cursor at interrupt time is permissible as long as the cursorhandle is locked in memory and the cursor routines are not busy. A test needsto be performed before changing the cursor. If you want to call SetCursor (witha cursor handle locked in memory), you must check CrsrBusy, a low-memory globaldefined in MPW SysEqu. If CrsrBusy is true, then you cannot call SetCursor.Changing the cursor while CrsrBusy is true causes it to leave mouse bits, ortrails, on the screen.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>     CrsrBusy   EQU $8CD ; Cursor locked out? [byte]</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P>         <a name="downloads"></a>         <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center>                                    <img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (60K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/dv_520.pdf">Download</A></P>               </TD>            </TR>         </TABLE>         <BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/dv/dv_520.html%3Fid%3DDTS10002418-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/dv/dv_520.html%3Fid%3DDTS10002418-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/dv/dv_520.html%3Fid%3DDTS10002418-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>