<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Q&amp;A OPS19: Making Data Executable</title><meta name="keywords" content="Mac OS 8 PowerPc 68k flushing processor cache MakeDataExecutable FlushCodeCacheRange"><meta name="Description" content="Technical Q&amp;A OPS19: Q&amp;A details how to correctly flush the processor cache for 68k and PowerPC code, so that data isexecutable."><meta name="categories" content="Operating System Utilities"><meta name="week-posted" content="Apr 12, 1999 - Apr 16, 1999"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"><a name="//apple_ref/doc/uid/DTS10001500" title="Making Data Executable"></a> <!-- white background --><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalqas/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/index.html" target="_blank">Reference Library</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A OPS19</div>
<div id="pageheadsub">Making Data Executable</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment -->			<!-- -->						<!-- Document Body --><CENTER><table cellspacing="0" cellpadding="0" border="0" WIDTH="600"><tr><td align="left" scope="row"><hr width=500 align=center><p id=p2>Q: I'm writing a program that constructs machine code on the fly. How do I correctly flush the processor cache so that I can execute the newly constructed instructions?</p><p id=p4>A: This answer depends on the instruction set architecture (ISA) of the code you are constructing:</p><UL>   <LI><STRONG>If you are constructing 68K code, you must call   <CODE>FlushCodeCacheRange</CODE> and, if that returns an error,   call <CODE>FlushCodeCache</CODE>.</STRONG></LI>      <LI><STRONG>If you are constructing PowerPC code, you must call   <CODE>MakeDataExecutable</CODE>.</STRONG></LI></UL><TABLE BORDER=0>   <TR>      <td bgcolor="#ffff99" align=left>         <B>IMPORTANT:<BR>                  </B>The answer is independent of the ISA of the code you are         running. For example, if you're writing PowerPC code that         constructs 68K code, you must call         <CODE>FlushCodeCacheRange</CODE> and not         <CODE>MakeDataExecutable</CODE>. Similarly, if you are         writing 68K code that constructs PowerPC code, you must call         <CODE>MakeDataExecutable</CODE>.      </TD></TR></TABLE><TABLE BORDER=0>   <TR>      <td bgcolor="#ffff99" align=left>         <B>WARNING:</B><BR>                  You can not make 68K data executable using either         <CODE>FlushInstructionCache</CODE> or         <CODE>FlushDataCache</CODE>. To correctly make 68K data         executable, you must flush both caches in the right order.         <CODE>FlushCodeCacheRange</CODE> and         <CODE>FlushCodeCache</CODE> do this for you, which is why we         strongly recommend you use them exclusively.         <BR><BR>         For a detailed description of how the Macintosh cache         architecture affects software, see&nbsp;DTS Technote         <a href="../../technotes/hw/hw_06.html" target="_blank">HW         06 Cache as Cache Can</A>.      </TD></TR></TABLE><P>The DTS sample code library "MoreIsBetter" contains a module("MoreOSUtils") that shows how to make data executable as 68K orPowerPC code. This module handles all of the complexities describedbelow.</P><P>There are a number of important things to remember when callingthe above routines:</P><UL>   <LI><CODE>FlushCodeCacheRange</CODE> is not exported by   InterfaceLib on Mac OS 8.1 and below. If you want to use   <CODE>FlushCodeCacheRange</CODE> from CFM code prior to Mac OS   8.5, you must write your own Mixed Mode glue. Technote 1127   <a href="../../technotes/tn/tn1127.html" target="_blank">In   Search of Missing Links</A> describes the general technique for   doing this.</LI>      <LI><CODE>FlushCodeCacheRange</CODE> is exported by InterfaceLib   on Mac OS 8.5 and above. To access it, you must link with the   InterfaceLib stub library from Universal Interfaces 3.2 or above.</LI>      <LI>Various versions of Universal Interfaces have one or two of   the following bugs:</LI>   </UL><BLOCKQUOTE>   <OL>      <LI>Wrong prototype for <CODE>FlushCodeCacheRange</CODE> --      Older versions of Universal Interfaces define      <CODE>FlushCodeCacheRange</CODE> to have a <CODE>void</CODE>      result rather than an <CODE>OSErr</CODE>. This is a problem      because the correct cache flushing algorithm requires you to      test the result from <CODE>FlushCodeCacheRange</CODE>.</LI>            <LI>Wrong Conditional -- Older versions of Universal Interfaces      conditionally define <CODE>FlushCodeCacheRange</CODE> so that      it's not available to CFM code. But, as explained above, it's      important to call <CODE>FlushCodeCacheRange</CODE> if you      generate 68K code, even if you generate the 68K instructions      using PowerPC code.</LI>   </OL>   </BLOCKQUOTE>      <P>The following table shows which versions of Universal   Interfaces have which of these problems:</P>   <TABLE BORDER=1>      <TR>         <TD align=center WIDTH=180 align="left">          <B>Universal Interfaces Version</B>         </TD><TD align=center WIDTH=120 align="left">           <B>Bogus Prototype</B>         </TD><TD align=center WIDTH=120 align="left">           <B>Bogus Conditional</B>         </TD></TR>      <TR>         <TD align=center WIDTH=180 align="left">            2.1.4 and below         </TD><TD align=center WIDTH=120 align="left">         	Yes         </TD><TD align=center WIDTH=120 align="left">            Yes         </TD></TR>      <TR>         <TD align=center WIDTH=180 align="left">            3.0, 3.0.1, 3.1         </TD><TD align=center WIDTH=120 align="left">            No         </TD><TD align=center WIDTH=120 align="left">            Yes         </TD></TR>      <TR>         <TD align=center WIDTH=180 align="left">            3.2         </TD><TD align=center WIDTH=120 align="left">            No         </TD><TD align=center WIDTH=120 align="left">            No         </TD></TR>   </TABLE><UL>   <LI>PowerPC-based computers always implement   <CODE>FlushCodeCacheRange</CODE>, so you never need to call   <CODE>FlushCodeCache</CODE> if you're executing PowerPC code.</LI>      <LI>Some older 68K-based computers may not implement   <CODE>_HWPriv</CODE>, the trap underlying   <CODE>FlushCodeCacheRange</CODE>. If your software might be run on   68K-based computers, you should test for the availability of the   <CODE>_HWPriv</CODE> trap before calling   <CODE>FlushCodeCacheRange</CODE>.</LI>      <LI><CODE>MakeDataExecutable</CODE> has no trap. If you're running   classic 68K code on a PowerPC-based computer, you must make   explicit CFM and Mixed Mode calls to execute this routine.   Technote 1077 <a href="../../technotes/tn/tn1077.html" target="_blank">Calling   CFM Code From Classic 68K Code</A> describes a general technique   for doing this.</LI>      <LI><CODE>BlockMove</CODE> is possibly the easiest way to flush   the 68K instruction cache, especially when you're moving large   chunks of 68K code.   <a href="../../documentation/mac/Memory/Memory-2.html" target="_blank">Inside   Macintosh: Memory</A> documents that <CODE>BlockMove</CODE> will   do whatever flushing is appropriate when any   <a href="../../documentation/mac/Memory/Memory-180.html#HEADING180-31" target="_blank">block   12 bytes and bigger</A> is moved.</LI></UL><P>For more information about instruction caches on the Macintosh, see:</P><UL>   <LI>DTS Technote   <a href="../../technotes/hw/hw_06.html" target="_blank">HW 06   Cache as Cache Can</A></LI>      <LI>Technote PT 39   <a href="../../technotes/pt/pt_39.html" target="_blank">The   DR Emulator</A></LI></UL><!-- begin_date --><H4 ALIGN=center>Updated: 12-April-1999</H4><!-- end_date --></td></tr></table></CENTER><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/ops/ops19.html%3Fid%3DDTS10001500-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/ops/ops19.html%3Fid%3DDTS10001500-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/ops/ops19.html%3Fid%3DDTS10001500-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>