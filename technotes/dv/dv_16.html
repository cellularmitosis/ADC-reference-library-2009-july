<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><!--Includes revisions to code listings--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note DV16: Serial GPi (General-Purpose Input)</title><meta name="keywords" content="Mac OS 8 Serial GPi SCC validating SwapSerialClock"><meta name="Description" content="Technical Note DV16: This Technical Note discusses supportedmethods for reading, validating, and configuring the GPiserial input across all members of the Macintosh family.GPi is a software-configurable serial input present on somemachines. This Technical Note states what machines GPi ispresent on as of 1991, then provides snippets of code thatdemonstrates how to read the state of GPi,and Gestalt callsthat will configure the GPi as an external clock."><meta name="categories" content="Devices"><meta name="week-posted" content="Jan 28, 1991 - Feb 1, 1991"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002406" title="Serial GPi (General-Purpose Input)"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/idxSerial-date.html" target="_blank">Hardware & Drivers > Serial</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note DV16</div>
<div id="pageheadsub">Serial GPi (General-Purpose Input)</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                   <td background="images/tnmenubody.gif" width=300 align=left>                        <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->					<p id="menutext"><a href="#Section1">What is GPi?</a><BR><BR><a href="#Section2">Reading GPi (The Easy Part)</a><BR><BR><a href="#Section3">Validating and Configuring GPi (A Little Bit Harder)</a><BR><BR> <a href="#references">References</a><BR><BR><A href="#downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>		<td width=300 valign="top" align=left>	<!-- begin_intro_text --><P id = "introtext">This Technical Note discusses the latest supported methods for reading, validating, and configuring the GPi serial input across all members of the Macintosh family.</p><!-- end_intro_text --><!-- begin_date --><h3>Updated: [February 01 1991]</h3><!-- end_date -->                </TD>             </TR>          </TABLE> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><a name="Section1"></a><h2>What is GPi?</h2><p>GPi is a software-configurable serial input present on some machines.  It islocated at pin 7 on the DIN-8 serial connectors, and connects to the DCD inputof the Z8530 Serial Communications Controller (SCC).  Because DCD ismonopolized by the mouse on the Macintosh Plus, GPi is not implemented on thatmachine.  Other machines which do not support GPi include the Macintosh Classicand Macintosh LC.  On these machines, pins 7 of the DIN-8 serial connectors arenot connected.</p><P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>Reading GPi (The Easy Part)</h2><p>A number of developers currently make use of the GPi input on the serial portsof the Macintosh SE, Macintosh II, and Portable families.  It's a handy featureand DTS regularly receives the question of how to read this input.  The coderequired is actually quite simple, assuming all the proper hardware support isin place.  As stated previously, some Macintosh models do not support GPi.  Forthose machines which do support GPi and for which the SCC chip is directlyaccessible, the following code reads the state of GPi.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>            movea   (SCCRd).w,a0   ; best place to get address of SCC RR0            move.b  aCtl(a0),d0    ; modem port--use bCtl for printer port            btst    #3,d0          ; GPi comes in DCD input--bit 3 of SCC RR0            beq     @GPi0    GPi1    ...            ...    GPi0    ...</pre>                           </TD></TR></table></center><p>This is currently the only way to determine the state of the GPi serial input.There is no support for this signal in the Serial Driver.  If the SCC is notdirectly accessible, then neither is GPi.  To determine if the SCC isaccessible, check with <code>_Gestalt</code>.  If an SCC exists but is notaccessible, <code>_Gestalt</code> claims that there is no SCC.</p><P><A HREF="#top">Back to top</A></P><a name="Section3"></a><h2>Validating and Configuring GPi (A Little Bit Harder)</h2><p>To aid application developers in determining whether a machine supports GPi, a<code>_Gestalt</code> selector is available in System 6.0.7 and later.  Thisselector is fully documented in <i>Inside Macintosh</i>, Volume VI, andspecifies (a) whether GPi is supported on port A, (b) whether GPi is supportedon port B, and (c) whether GPi may be used as a clock input for synchronousmodems on port A.</p><p>There is another new call which developers can use to configure GPiA as anexternal clock.  Previously, developers had to manipulate a bit in VIA1 toenable or disable external clocking on this pin.  Unfortunately, there hasalways been some ambiguity about the sense of this bit (the SE uses theopposite sense of the Macintosh II) and the VIA bit is not present at all on the Macintosh IIfx--see Technical Note #271, <u><A HREF = "../hw/hw_09.html">Macintosh IIfx: The Inside Story.</a></u>The friendly way to configure GPiA uses <code>_HwPriv</code> selector 7, asdocumented in that Technical Note.</p><p>MPW has never defined a high-level calling interface to this particular trapmacro, and no glue has ever been available for Pascal and C programmers.  Untilthis is remedied, the following inline glue fills in quite nicely:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>    FUNCTION SwapSerialClock (clock, portID: Integer) : Integer;      INLINE $205F, $7007, $A198, $6B02, $3008, $3E80;    pascal short SwapSerialClock (short clock, short portID) =    {      0x205F, 0x7007, 0xA198, 0x6B02, 0x3008, 0x3E80    }</pre>                           </TD></TR></table></center><p>For the normal 3.672 MHz internal serial clock, pass <code>$0000</code> in the<code>clock</code> parameter.  For external clocking provided at the GPiA pin, pass<code>$0001</code> in the <code>clock</code> parameter.  Other clock sources aretheoretically possible, so use only one of these two values.</p><p>Only one value is currently supported for the <code>portID</code> parameter, andthat is the Serial Driver enumerated constant <code>sPortA</code>.  If necessary,this constant must be casted to type <code>short</code> or coerced to type<code>Integer</code>, according to the terminology of your development language.</p><p>If an error results, <code>SwapSerialClock</code> returns a negative number,otherwise it returns the previous GPiA configuration which is a non-negativenumber.  This makes it convenient to save and restore the original state.</p><p><code>SwapSerialClock</code> works with system software back to 6.0.5, although it doesnot achieve the desired results on the Macintosh IIfx.  In fact, it may crash.This is a problem which is addressed in System Software 7.0.  All the featuresdescribed in this Note are technically new features for System 7.0, but Appleencourages developers to employ them if necessary (and available) in6.0.x-compatible applications and suggest to their customers to use the latestavailable system software to obtain maximum benefit from these types ofapplications.</p><p>The following code fragment shows how to use these new features withoutexplicitly depending upon specific system software versions.  It assumes onlythat the <code>_Gestalt</code> trap is implemented or emulated by MPW glue (whichis already available).  It is not necessarily possible to trap the error ofcalling <code>SwapSerialClock</code> on a Macintosh IIfx with pre-7.0 software.  Itis best to avoid executing this code at all on such a configuration or elserisk a system crash.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>    PROGRAM SerialClock;      USES Types,GestaltEqu,Serial;      CONST        internalClock = 0;     { convenient constants for SwapSerialClock }        externalClock = 1;      VAR        gestErr    : OSErr;        hasGPiAClk : Boolean;        oldClockMode: Integer;        result    : LongInt;      FUNCTION SwapSerialClock(clock,portID: Integer): Integer;        INLINE $205F,$7007,$A198,$6B02,$3008,$3E80;      { this could be supported in a future version of MPW }      BEGIN        gestErr := Gestalt(gestaltSerialAttr,result);        IF gestErr = noErr THEN BEGIN          hasGPiAClk := (band(result,bsl(1,gestaltHasGPIaToDCDa)) &lt;&gt; 0);          IF hasGPiAClk THEN BEGIN            { SwapSerialClock is supported if gestaltHasGPIaToDCDa is supported }            { it may experience difficulties with Mac IIfx and pre-7.0 systems... }            oldClockMode := SwapSerialClock(internalClock,Integer(sPortA));            IF oldClockMode &lt; 0 THEN BEGIN              { handle case of error setting the clock mode }            END;          END          ELSE BEGIN            { handle case where there is no GPiA clock support }          END;        END        ELSE BEGIN          { handle case where Gestalt doesn't know about serial attributes }          { this usually means assume no support, or ask for later system... }        END;      END.</pre>                           </TD></TR></table></center> <P><A HREF="#top">Back to top</A></P><a name="references"></a><h2>References</h2><P>   <i>Inside Macintosh</i>, Volume III, The Macintosh Hardware</p><P>   <i>Inside Macintosh</i>, Volume VI, Compatibility Guidelines</p><P>   <i>Guide to the Macintosh Family Hardware,</i> Serial I/O Ports</p><P>   Technical Note M.OV.GestaltSysenvirons - <u><A HREF = "../ov/ov_16.html">Gestalt and Sysenvirons : a Never Ending Story</a></u></p><P>   Technical Note M.HW.MacIIfx - <u><A HREF = "../hw/hw_09.html">Macintosh IIfx: The Inside Story</a></u></p><P>   Technical Manual:<i> Z8530 SCC Serial Communications Controller</i> (contact Zilog or AMD)</p>                        <P><A HREF="#top">Back to top</A></P>         <a name="downloads"></a>         <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center>                                    <img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (40K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/dv_16.pdf">Download</A></P>               </TD>            </TR>         </TABLE>         <BR>                  <P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/dv/dv_16.html%3Fid%3DDTS10002406-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/dv/dv_16.html%3Fid%3DDTS10002406-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/dv/dv_16.html%3Fid%3DDTS10002406-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --><hr width=500 align=center></BODY></HTML>