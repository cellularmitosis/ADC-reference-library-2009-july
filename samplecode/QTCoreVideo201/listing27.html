<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>QTCoreVideo201 - /Classes/QT/CoreVideo/QTCoreVideoOpenGLView.m</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/GraphicsImaging/index.html">Graphics & Imaging</a> &gt; <a href="../../samplecode/GraphicsImaging/idxVideo-date.html">Video</a> &gt; <A HREF="javascript:location.replace('index.html');">QTCoreVideo201</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->


	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">QTCoreVideo201</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/Classes/QT/CoreVideo/QTCoreVideoOpenGLView.m</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/Classes/Alert/Alert.c</option>
<option value="listing2.html">/Classes/Alert/Alert.h</option>
<option value="listing3.html">/Classes/Alert/AlertPanelKit.h</option>
<option value="listing4.html">/Classes/Alert/AlertPanelKit.m</option>
<option value="listing5.html">/Classes/MemObject/MemObject.h</option>
<option value="listing6.html">/Classes/MemObject/MemObject.m</option>
<option value="listing7.html">/Classes/MemObject/Memory.c</option>
<option value="listing8.html">/Classes/MemObject/Memory.h</option>
<option value="listing9.html">/Classes/OpenGL/FBO/OpenGLFBOAlertPanelMessages.h</option>
<option value="listing10.html">/Classes/OpenGL/FBO/OpenGLFBOKit.h</option>
<option value="listing11.html">/Classes/OpenGL/FBO/OpenGLFBOKit.m</option>
<option value="listing12.html">/Classes/OpenGL/FBO/OpenGLFBOStatusKit.h</option>
<option value="listing13.html">/Classes/OpenGL/FBO/OpenGLFBOStatusKit.m</option>
<option value="listing14.html">/Classes/OpenGL/Quad/OpenGLQuad.h</option>
<option value="listing15.html">/Classes/OpenGL/Quad/OpenGLQuad.m</option>
<option value="listing16.html">/Classes/OpenGL/Teapot/OpenGLTeapot.h</option>
<option value="listing17.html">/Classes/OpenGL/Teapot/OpenGLTeapot.m</option>
<option value="listing18.html">/Classes/OpenGL/Teapot/OpenGLTeapotList.c</option>
<option value="listing19.html">/Classes/OpenGL/Teapot/OpenGLTeapotList.h</option>
<option value="listing20.html">/Classes/OpenGL/Teapot/OpenGLTeapotTextured.h</option>
<option value="listing21.html">/Classes/OpenGL/Teapot/OpenGLTeapotTextured.m</option>
<option value="listing22.html">/Classes/OpenGL/View/OpenGLViewKit.h</option>
<option value="listing23.html">/Classes/OpenGL/View/OpenGLViewKit.m</option>
<option value="listing24.html">/Classes/QT/CoreVideo/QTCoreVideoController.h</option>
<option value="listing25.html">/Classes/QT/CoreVideo/QTCoreVideoController.m</option>
<option value="listing26.html">/Classes/QT/CoreVideo/QTCoreVideoOpenGLView.h</option>
<option value="listing27.html">/Classes/QT/CoreVideo/QTCoreVideoOpenGLView.m</option>
<option value="listing28.html">/Classes/QT/VisualContext/QTVisualContextKit.h</option>
<option value="listing29.html">/Classes/QT/VisualContext/QTVisualContextKit.m</option>
<option value="listing30.html">/main.m</option></select>
				</p>
				</form>
				<p><strong><a href="QTCoreVideo201.zip">Download Sample</a></strong> (&#147;QTCoreVideo201.zip&#148;, 1.29M)<BR>
<strong><a href="QTCoreVideo201.dmg">Download Sample</a></strong> (&#147;QTCoreVideo201.dmg&#148;, 1.28M)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">//---------------------------------------------------------------------------
//
//    File: QTCoreVideoOpenGLView.m
//
//  Abstract: Main rendering class
//              
//  Disclaimer: IMPORTANT:  This Apple software is supplied to you by Apple
//  Computer, Inc. (&quot;Apple&quot;) in consideration of your agreement to the
//  following terms, and your use, installation, modification or
//  redistribution of this Apple software constitutes acceptance of these
//  terms.  If you do not agree with these terms, please do not use,
//  install, modify or redistribute this Apple software.
//  
//  In consideration of your agreement to abide by the following terms, and
//  subject to these terms, Apple grants you a personal, non-exclusive
//  license, under Apple's copyrights in this original Apple software (the
//  &quot;Apple Software&quot;), to use, reproduce, modify and redistribute the Apple
//  Software, with or without modifications, in source and/or binary forms;
//  provided that if you redistribute the Apple Software in its entirety and
//  without modifications, you must retain this notice and the following
//  text and disclaimers in all such redistributions of the Apple Software. 
//  Neither the name, trademarks, service marks or logos of Apple Computer,
//  Inc. may be used to endorse or promote products derived from the Apple
//  Software without specific prior written permission from Apple.  Except
//  as expressly stated in this notice, no other rights or licenses, express
//  or implied, are granted by Apple herein, including but not limited to
//  any patent rights that may be infringed by your derivative works or by
//  other works in which the Apple Software may be incorporated.
//  
//  The Apple Software is provided by Apple on an &quot;AS IS&quot; basis.  APPLE
//  MAKES NO WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION
//  THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY AND FITNESS
//  FOR A PARTICULAR PURPOSE, REGARDING THE APPLE SOFTWARE OR ITS USE AND
//  OPERATION ALONE OR IN COMBINATION WITH YOUR PRODUCTS.
//  
//  IN NO EVENT SHALL APPLE BE LIABLE FOR ANY SPECIAL, INDIRECT, INCIDENTAL
//  OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
//  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
//  INTERRUPTION) ARISING IN ANY WAY OUT OF THE USE, REPRODUCTION,
//  MODIFICATION AND/OR DISTRIBUTION OF THE APPLE SOFTWARE, HOWEVER CAUSED
//  AND WHETHER UNDER THEORY OF CONTRACT, TORT (INCLUDING NEGLIGENCE),
//  STRICT LIABILITY OR OTHERWISE, EVEN IF APPLE HAS BEEN ADVISED OF THE
//  POSSIBILITY OF SUCH DAMAGE.
// 
//  Copyright (c) 2008 Apple Inc., All rights reserved.
//
//---------------------------------------------------------------------------

//---------------------------------------------------------------------------

#import &quot;AlertPanelKit.h&quot;
#import &quot;QTCoreVideoOpenGLView.h&quot;

//---------------------------------------------------------------------------

//---------------------------------------------------------------------------

struct CVAttributes
{
    CFAllocatorRef       allocator;            // CF allocator used throughout
    CGDirectDisplayID    displayId;            // Display used by CoreVideo
    CVDisplayLinkRef     displayLink;        // Display link maintained by CV
    CVOptionFlags        lockFlags;            // Flags used for locking the base address
    CVPixelBufferRef     videoFrame;        // The current frame from CV
};

typedef struct CVAttributes  CVAttributes;

//---------------------------------------------------------------------------

struct QTMovieAttributes
{
    NSSize   frame;            // Frame width &amp; height
    GLuint   frameSize;        // Frame width &amp; height
};

typedef struct QTMovieAttributes   QTMovieAttributes;

//---------------------------------------------------------------------------

struct QTCVOpenGLAttributes
{
    GeometryType       geometry;        // teapot or a quad
    CVAttributes       coreVideo;        // CoreVideo attributes
    QTMovieAttributes  qtMovie;            // QT movie attributes
};

typedef struct QTCVOpenGLAttributes   QTCVOpenGLAttributes;

//---------------------------------------------------------------------------

//---------------------------------------------------------------------------

#pragma mark -- Render Callback --

//---------------------------------------------------------------------------

//---------------------------------------------------------------------------
//
// This is the CoreVideo DisplayLink callback notifying the application when 
// the display will need each frame and is called when the DisplayLink is 
// running -- in response, we call our getFrameForTime method.
//
//---------------------------------------------------------------------------

static CVReturn CoreVideoRenderCallback(    CVDisplayLinkRef    displayLink, 
                                            const CVTimeStamp  *inNow, 
                                            const CVTimeStamp  *inOutputTime, 
                                            CVOptionFlags       flagsIn, 
                                            CVOptionFlags      *flagsOut, 
                                            void               *displayLinkContext )
{
    return [(QTCoreVideoOpenGLView *)displayLinkContext getFrameForTime:inOutputTime flagsOut:flagsOut];
} // CoreVideoRenderCallback

//---------------------------------------------------------------------------

//---------------------------------------------------------------------------

#pragma mark

//---------------------------------------------------------------------------

//---------------------------------------------------------------------------

@implementation QTCoreVideoOpenGLView

//---------------------------------------------------------------------------

#pragma mark -- Initialize Instance Variables --

//---------------------------------------------------------------------------

- (void) initCoreVideoAttributes
{
    attributes-&gt;coreVideo.allocator   = kCFAllocatorDefault;
    attributes-&gt;coreVideo.displayId   = kCGDirectMainDisplay;
    attributes-&gt;coreVideo.displayLink = NULL;
    attributes-&gt;coreVideo.videoFrame  = NULL;
    attributes-&gt;coreVideo.lockFlags   = 0;
} // initCoreVideoAttributes

//---------------------------------------------------------------------------

- (void) initQTMovieSize
{
    attributes-&gt;qtMovie.frame.width  = 1920.0f;
    attributes-&gt;qtMovie.frame.height = 820.0f;
    attributes-&gt;qtMovie.frameSize    = 0;
} // initQTMovieSize

//---------------------------------------------------------------------------

- (void) initGeometry
{
    attributes-&gt;geometry = kGeometryQuad;
} // initGeometry

//---------------------------------------------------------------------------
//
// QTKit, CoreVideo &amp; OpenGL objects
//
//---------------------------------------------------------------------------

- (void) initObjects
{
    movie         = nil;
    visualContext = nil;
    teapot        = nil;
    quad          = nil;
    fbo           = nil;
} // initObjects

//---------------------------------------------------------------------------
//
// We need a lock around our draw function so two different threads don't
// try and draw at the same time
//
//---------------------------------------------------------------------------

- (void) newRecursiveLock
{
    lock = [NSRecursiveLock new];
} // newRecursiveLock

//---------------------------------------------------------------------------
//
// Initialize
//
//---------------------------------------------------------------------------

- (void) awakeFromNib
{
    viewMemObj = [[MemObject alloc] initMemoryWithType:kMemAlloc size:sizeof(QTCVOpenGLAttributes)];
    
    if ( viewMemObj )
    {
        attributes = (QTCVOpenGLAttributesRef)[viewMemObj pointer];
        
        if ( [viewMemObj isPointerValid] )
        {
            [self initGeometry];
            [self initQTMovieSize];
            [self initCoreVideoAttributes];
            [self initObjects];
            
            [self newRecursiveLock];
        } // if
        else
        {
            [[AlertPanelKit withTitle:@&quot;QTCoreVideo OpenGL View&quot; 
                              message:@&quot;Failure Allocating Memory For View Attributes&quot;
                                 exit:YES] displayAlertPanel];
        } // else
    } // if
} // awakeFromNib

//---------------------------------------------------------------------------

#pragma mark -- Cleanup all the Resources --

//---------------------------------------------------------------------------

- (void) deleteOpenGLQuad
{
    if ( quad )
    {
        [quad release];
        
        quad = nil;
    } // if
} // deleteOpenGLQuad

//---------------------------------------------------------------------------

- (void) deleteOpenGLTeapot
{
    if ( teapot )
    {
        [teapot release];
        
        teapot = nil;
    } // if
} // deleteOpenGLTeapot

//---------------------------------------------------------------------------

- (void) deleteOpenGLFBO
{
    if ( fbo )
    {
        [fbo release];
        
        fbo = nil;
    } // if
} // deleteOpenGLFBO

//---------------------------------------------------------------------------

- (void) deleteOpenGLResources
{
    [self deleteOpenGLQuad];
    [self deleteOpenGLTeapot];
    [self deleteOpenGLFBO];
} // deleteOpenGLResources

//---------------------------------------------------------------------------
//
// Stop and release the movie
//
//---------------------------------------------------------------------------

- (void) deleteQTMovie
{
    if ( movie != nil ) 
    {
        [movie setRate:0.0];
        
        SetMovieVisualContext( [movie quickTimeMovie], NULL );
        
        [movie release];
        
        movie = nil;
    } // if
} // deleteQTMovie

//---------------------------------------------------------------------------
//
// It is critical to dispose of the display link
//
//---------------------------------------------------------------------------

- (void) deleteCVDisplayLink
{
    if ( attributes-&gt;coreVideo.displayLink ) 
    {
        CVDisplayLinkStop( attributes-&gt;coreVideo.displayLink );
        CVDisplayLinkRelease( attributes-&gt;coreVideo.displayLink );
        
        attributes-&gt;coreVideo.displayLink = NULL;
    } // if
} // deleteCVDisplayLink

//---------------------------------------------------------------------------
//
// Don't leak pixel buffers
//
//---------------------------------------------------------------------------

 - (void) deleteCVTexture
 {
    // If we have a previous frame release it

    if ( attributes-&gt;coreVideo.videoFrame != NULL ) 
    {
        CVOpenGLTextureRelease( attributes-&gt;coreVideo.videoFrame );
        
        attributes-&gt;coreVideo.videoFrame = NULL;
    } // if
 } // deleteCVTexture

//---------------------------------------------------------------------------
//
// Release the pixel image context
//
//---------------------------------------------------------------------------

- (void) deleteQTVisualContext
{
    if ( visualContext )
    {
        [visualContext release];
        
        visualContext = nil;
    } // if
} // deleteQTVisualContext
 
//---------------------------------------------------------------------------

- (void) deleteQTCVOpenGLAttributes
{
    if ( viewMemObj )
    {
        [viewMemObj release];
        
        viewMemObj = nil;
    } // if
} // deleteQTCVOpenGLAttributes

//---------------------------------------------------------------------------
//
// Release the recursive lock
//
//---------------------------------------------------------------------------

- (void) deleteRecursiveLock
{
    if ( lock ) 
    {
        [lock release];
        
        lock = nil;
    } // if 
} // deleteRecursiveLock

//---------------------------------------------------------------------------
//
// It is very important that we clean up the rendering objects before the 
// view is disposed, remember that with the display link running you're 
// applications render callback may be called at any time including when 
// the application is quitting or the view is being disposed, additionally 
// you need to make sure you're not consuming OpenGL resources or leaking 
// textures -- this clean up routine makes sure to stop and release 
// everything.
//
//---------------------------------------------------------------------------

- (void) cleanUp
{
    [self deleteCVDisplayLink];
    [self deleteCVTexture];
    [self deleteQTVisualContext];
    [self deleteQTMovie];
    [self deleteQTCVOpenGLAttributes];
    [self deleteOpenGLResources];
    [self deleteRecursiveLock];
} // delete

//---------------------------------------------------------------------------

- (void) dealloc 
{
    [self cleanUp];
    [super dealloc];
} // dealloc

//---------------------------------------------------------------------------

#pragma mark -- Draw into a OpenGL view --

//---------------------------------------------------------------------------

- (void) drawSetup
{
    // Some set up

    if ( attributes-&gt;geometry == kGeometryTeapot ) 
    {
        [self setupView:0.2];
    } // if
    else
    {
        [self setupView:0.5];
    } // else
} // drawSetup

//---------------------------------------------------------------------------

- (void) drawIntoView
{
    if ( attributes-&gt;geometry == kGeometryTeapot ) 
    {
        [teapot draw];
    } // if
    else
    {
        [quad draw];
    } // else
} // drawIntoView

//---------------------------------------------------------------------------

- (void) drawObject
{
    if ( attributes-&gt;coreVideo.videoFrame != NULL )
    {
        [fbo update:attributes-&gt;coreVideo.videoFrame];

        // Some set up

        [self drawSetup];
        
        // Constant rotation of the subject
        
        [self updatePitch];
        
        [self updateAngle];
        
        [fbo bind];
        
        [self drawIntoView];
    } // if
} // drawObject

//---------------------------------------------------------------------------

- (void) drawBegin
{
    // Prevent drawing from another thread if we're drawing already    
    
    [lock lock];
    
    // Make the GL context the current context
    
    [[self openGLContext] makeCurrentContext];

    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT );
} // drawBegin

//---------------------------------------------------------------------------

- (void) drawEnd
{
    [[self openGLContext] flushBuffer];

    // Give time to the Visual Context so it can release internally held 
    // resources for later re-use this function should be called in every 
    // rendering pass, after old images have been released, new images 
    // have been used and all rendering has been flushed to the screen.
    
    [visualContext task];

    [lock unlock];
} // drawEnd

//---------------------------------------------------------------------------

- (void) drawRect:(NSRect)rect
{  
    [self drawBegin];
    
        [self drawObject];
    
    [self drawEnd];
} // drawRect

//---------------------------------------------------------------------------

#pragma mark -- Display Link Obtaining Frames --

//---------------------------------------------------------------------------
//
// getFrameForTime is called from the Display Link callback when it's time 
// for us to check to see if we have a frame available to render -- if we do, 
// draw -- if not, just task the Visual Context and split.
//
//---------------------------------------------------------------------------

- (CVReturn) getFrameForTime:(const CVTimeStamp *)timeStamp 
                    flagsOut:(CVOptionFlags *)flagsOut
{
    // There is no autorelease pool when this method is called because it will
    // be called from another thread it's important to create one or you will 
    // leak objects
    
    NSAutoreleasePool *pool = [NSAutoreleasePool new];
    
    // Check for new frame
    
    if (        ( [visualContext isValidVisualContext] ) 
            &amp;&amp;    ( [visualContext isNewImageAvailable:timeStamp] ) ) 
    {        
        // If we have a previous frame release it

        [self deleteCVTexture];
        
        // Get a &quot;frame&quot; (image image) from the Visual Context, indexed by 
        // the provided time

        attributes-&gt;coreVideo.videoFrame = [visualContext copyImageForTime:timeStamp];
        
        // The above call may produce a null frame so check for this first
        // if we have a frame, then draw it
        
        if ( attributes-&gt;coreVideo.videoFrame != NULL )
        {
            [self drawRect:NSZeroRect];
        } // if
        else
        {
            NSLog( @&quot;WARNING: QT Visual Context Copy Image for Time Error!&quot; );
        } // else
    } // if
    
    [pool release];

    return kCVReturnSuccess;
} // getFrameForTime

//---------------------------------------------------------------------------

#pragma mark -- Initialize movie frame size --

//---------------------------------------------------------------------------

- (void) newQTMovieAttributes:(NSString *)theMoviePath
{
    // If we already have a QTMovie release it
    
    [self deleteQTMovie];

    // Instantiate a movie object
    
    movie = [[QTMovie alloc] initWithFile:theMoviePath error:nil];

    // Get the movie size
    
    [[movie attributeForKey:QTMovieNaturalSizeAttribute] getValue:&amp;attributes-&gt;qtMovie.frame];
} // newQTMovieAttributes

//---------------------------------------------------------------------------

#pragma mark -- Initialize Core Video --

//---------------------------------------------------------------------------

- (void) newCVDisplayLink
{
    [self deleteCVDisplayLink];
    
    // Create display link for the main display
    
    CVDisplayLinkCreateWithCGDisplay(    attributes-&gt;coreVideo.displayId, 
                                        &amp;attributes-&gt;coreVideo.displayLink );
    
    if ( attributes-&gt;coreVideo.displayLink != NULL ) 
    {
        // Set the current display of a display link.
        
        CVDisplayLinkSetCurrentCGDisplay(    attributes-&gt;coreVideo.displayLink, 
                                            attributes-&gt;coreVideo.displayId );
        
        // Set the renderer output callback function
        
        CVDisplayLinkSetOutputCallback( attributes-&gt;coreVideo.displayLink, 
                                        &amp;CoreVideoRenderCallback, 
                                        self );
        
        // Activates a display link
        
        CVDisplayLinkStart( attributes-&gt;coreVideo.displayLink );
    } // if
} // newCVDisplayLink

//---------------------------------------------------------------------------

#pragma mark -- Initialize QT Visual Context --

//---------------------------------------------------------------------------

- (void) newQTVisualContext
{
    // Delete the old qt visual context
    
    [self deleteQTVisualContext];
    
    // Instantiate a new qt visual context object
    
    visualContext = [[QTVisualContextKit alloc] initQTVisualContextWithSize:attributes-&gt;qtMovie.frame
                                                                        type:kQTOpenGLTextureContext
                                                                        context:[self openGLContext]
                                                                        pixelFormat:[self pixelFormat]];
} // newQTVisualContext

//---------------------------------------------------------------------------

#pragma mark -- Initialize OpenGL for a movie --

//---------------------------------------------------------------------------

- (void) newOpenGLQuadForMovie
{
    // Delete the old quad object
    
    [self deleteOpenGLQuad];
        
    // Instantiate a new quad object
    
    quad = [[OpenGLQuad alloc] initQuadWithSize:&amp;attributes-&gt;qtMovie.frame range:1];
} // newOpenGLQuadForMovie

//---------------------------------------------------------------------------

- (void) newOpenGLTeapotForMovie
{
    // Delete the old teapot object
    
    [self deleteOpenGLTeapot];
    
    // Instantiate a new teapot object
    
    teapot = [[OpenGLTeapotTextured alloc] initTeapotTexturedWithType:GL_FILL 
                                                                range:1 
                                                                grid:8 
                                                                size:0.5f
                                                                scale:&amp;attributes-&gt;qtMovie.frame];
} // newOpenGLTeapotForMovie

//---------------------------------------------------------------------------

- (void) newOpenGLFBOForMovie
{
    // Delete the old pbo object
    
    [self deleteOpenGLFBO];
    
    // Instantiate a new pbo object
    
    fbo = [[OpenGLFBOKit alloc] initFBOWithSize:attributes-&gt;qtMovie.frame];
} // newOpenGLFBOForMovie

//---------------------------------------------------------------------------

#pragma mark -- Open a movie with new resources --

//---------------------------------------------------------------------------

- (void) newResourceForMovie:(NSString *)theMoviePath
{
    // New QT &amp; CV resources for a movie
    
    [self newQTMovieAttributes:theMoviePath];
    [self newCVDisplayLink];
    [self newQTVisualContext];
    
    // New OpenGL resources for a movie
    
    [self newOpenGLQuadForMovie];
    [self newOpenGLTeapotForMovie];
    [self newOpenGLFBOForMovie];
} // newResourceForMovie

//---------------------------------------------------------------------------
//
// Open a Movie File and instantiate a QTMovie object
//
//---------------------------------------------------------------------------

- (void) openMovie:(NSString *)theMoviePath
{
    // New movie resources
    
    [self newResourceForMovie:theMoviePath];
    
    // Set Movie to loop
    
    [movie setAttribute:[NSNumber numberWithBool:YES] forKey:QTMovieLoopsAttribute];
    
    // Targets a Movie to render into a visual context
    
    [visualContext setMovie:movie];
    
    // Play the Movie
    
    [movie setRate:1.0];

    // Set the window title from the Movie if it has a name associated with it
    
    [[self window] setTitle:[movie attributeForKey:QTMovieDisplayNameAttribute]];
} // openMovie

//---------------------------------------------------------------------------

#pragma mark -- Accessors --

//---------------------------------------------------------------------------

- (CVDisplayLinkRef) displayLink
{
    return attributes-&gt;coreVideo.displayLink;
} // displayLink

//---------------------------------------------------------------------------
//
// Geometry for drawing
//
//---------------------------------------------------------------------------

- (void) setGeometry:(const GeometryType)theGeometry;
{
    attributes-&gt;geometry = theGeometry;
} // setGeometry

//---------------------------------------------------------------------------

@end

//---------------------------------------------------------------------------

//---------------------------------------------------------------------------
</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/QTCoreVideo201/listing27.html%3Fid%3DDTS40007784-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/QTCoreVideo201/listing27.html%3Fid%3DDTS40007784-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/QTCoreVideo201/listing27.html%3Fid%3DDTS40007784-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>