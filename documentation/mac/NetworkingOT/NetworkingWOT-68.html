<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Using DDP</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING68></A>
<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->

<!-- Main Body -->

<CENTER>
<P>
<A HREF="NetworkingWOT-67.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="NetworkingWOT-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="NetworkingWOT-491.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A>  <A HREF="NetworkingWOT-69.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html"><B>Inside Macintosh:</B></A> <A HREF="NetworkingWOT-2.html"><B>Networking With Open Transport </B></A> / <A HREF="NetworkingWOT-10.html"><B>Part 1 - Open Transport Essentials</B></A><BR><DD><A HREF="NetworkingWOT-66.html"><B>Chapter 15 - Datagram Delivery Protocol (DDP)</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING68-0></A>
<H1><A NAME=MARKER-9-27></A>Using DDP</H1>
 To explicitly use DDP, you open and bind a DDP endpoint. You can then use that endpoint to send or receive data in discrete packets. For outgoing packets, DDP forms the packet header and hands the packet to the appropriate data link. For incoming packets, DDP examines the packet header and attempts to deliver any packet to the specified endpoint as long as the packet meets the following criteria:<P>
<UL>
<P><LI>The destination address is valid.
<P><LI>The default type of the packet matches that of the receiving endpoint.
<P><LI>The length of the packet matches the length specified in the packet header and does not exceed the maximum for a DDP packet.
<P><LI>The checksums match (if checksumming is enabled).<P>
</UL>
 If any of these conditions is not satisfied, DDP discards the packet without notifying either the sender or the receiver of the packet. In addition, DDP has no provision for requesting the sender to retransmit a lost or damaged packet.<P>
<A NAME=HEADING68-7></A>
<H2><A NAME=MARKER-13-28></A>Binding a DDP Endpoint</H2>
 As with any endpoint, before you can use it to send or receive data, you must bind it to a physical address. The <CODE>OTBind</CODE> function takes three parameters: one that specifies the endpoint to be bound, one that requests a specific address, and one that returns the actual address to which Open Transport bound the endpoint. <P>
 When binding a DDP endpoint, you can request a particular DDP address, including a static socket address. You can also choose to only specify a <A NAME=MARKER-13-29></A>DDP type for the endpoint, in which case you set the other fields of the DDP address structure to 0 and allow DDP to dynamically assign a socket. The chapter "AppleTalk Addressing"<A HREF=NetworkingWOT-60.html#MARKER-9-21></A> describes the different address formats you can use to specify an endpoint address. <P>
 When you bind a DDP endpoint, there are a few considerations to bear in mind. For example, you do not have to specify the endpoint's socket and the DDP type, but DDP behaves differently depending on whether you specify them or not. Here are the points to remember: <P>
<UL>
<P><LI>If you bind without specifying a socket, DDP uses a dynamically assigned one; if you specify a socket, DDP tries to use it (a statically assigned socket). 
<P><LI>If you bind by specifying a DDP type of 0 to a specific socket, Open Transport sets the endpoint's DDP type to a value of 11. This gives you exclusive access to the socket, which means that no other endpoint can bind to it. 
<P><LI>If you bind using a specific DDP type, Open Transport sets the endpoint's DDP type to that value. If you bind another DDP endpoint to that socket, you must give it a different type.
<P><LI>If you bind with a combined DDP-NBP address, Open Transport uses the DDP part of the address as described in the two preceding bullets. If the bind succeeds, Open Transport registers the NBP name on the endpoint's socket.
<P><LI>If you bind with an NBP address only, there is no socket number in that form of address, so DDP uses a dynamically assigned socket. If the bind succeeds, DDP registers the endpoint's NBP name on that socket. The endpoint has no default DDP type, so Open Transport sets the DDP type to a value of 11. This has the same effect as described in the earlier bullets. <A NAME=MARKER-13-30></A><P>
</UL>
<A NAME=HEADING68-16></A>
<H2>Using the <A NAME=MARKER-13-31></A>DDP Type Field to Filter Packet Delivery</H2>
 You can choose to filter your packet delivery service by using the DDP type field in the endpoint's DDP address structure. The DDP type field is ignored by all protocols other than DDP, so you do not specify the DDP type when passing an address to an AppleTalk endpoint for all protocol layers above DDP. <P>
 If you specify a valid nonzero DDP type value when you bind an endpoint, Open Transport uses that value as the default DDP type for that endpoint, using it on all packets sent from that endpoint. If you do not specify a DDP type value or use a value of 0, Open Transport uses a DDP type value of 11 as the default DDP type for that endpoint. If you specify a different DDP type value for any individual packet that you send, Open Transport overrides the endpoint's default DDP type and uses the packet's DDP type.<P>
 When receiving incoming packets, a specified DDP type works as a filter: you only receive packets of that one type. If, however, you bind an endpoint without a DDP type or with a DDP type of 0, you receive all incoming packets. <P>
 Using the DDP type field when you bind a DDP endpoint has special significance for both sending and receiving packets, as shown in <A HREF=#MARKER-9-2>Table 15-1</A>.<P>
<B>Table 15-1   Effects of using the DDP type field </B><P>
<TABLE BORDER="0" CELLPADDING=3>
<CAPTION><A NAME=MARKER-13-1></A><A NAME=MARKER-9-2></A></CAPTION>
<TH>Task<TH>A nonzero DDP type <BR>specified at bind<TH>No DDP type or a DDP type <BR>of 0 specified at bind<TR>
<TD>Send<TD>Open Transport uses this DDP type for outgoing packets unless you specify a different DDP type on a per packet basis.<TD>Open Transport uses a DDP type of 11 for outgoing packets unless you specify a different DDP type on a per packet basis.<TR>
<TD>Receive&nbsp;&nbsp;<TD>You only receive incoming packets for this DDP type. <A NAME=MARKER-13-3></A><TD>You receive all incoming packets. </TABLE>
<P>
<A NAME=HEADING68-21></A>
<H2>Using the <A NAME=MARKER-13-32></A>Self-Send and Checksum Options</H2>
 DDP has two options you can use to control the behavior of DDP endpoints: the <CODE>OPT_SELFSEND</CODE> and the <CODE>OPT_CHECKSUM</CODE> options. <P>
 You can use the <A NAME=MARKER-13-33><CODE>OPT_SELFSEND</CODE></A> option with DDP to turn self-sending on, which means that when you send a broadcast packet, the packet will also be passed to the node itself for processing. To turn this on, you set this option with a value of 1. By default this option is turned on. <P>
 You can use the <A NAME=MARKER-13-137><CODE>OPT_CHECKSUM</CODE></A> option when sending packets to enable the calculation of checksums. A value is calculated when the packet is sent. When the packet is received, DDP calculates a checksum for the packet. If the calculated checksum does not match the packet's checksum, DDP assumes the packet has been corrupted and discards the packet without notifying its sender or receiver.<P>
 You can specify the <CODE>OPT_CHECKSUM</CODE> option on every call to <CODE>OTSndUData</CODE> and control the use of checksums on a per packet basis, or you can use the <CODE>OTOptionManagement</CODE> function to enable or disable checksums for all outgoing packets. The checksum option <CODE>OPT_CHECKSUM</CODE> can have one of two values: <CODE>T_NO</CODE>, which disables checksums, or <CODE>T_YES</CODE>, which enables it. By default this option is turned off.<P>
 For more information about using options, refer to the chapter  <A HREF=NetworkingWOT-37.html#MARKER-9-21>"Option Management"</A>.<P>
<A NAME=HEADING68-27></A>
<H2>Using <A NAME=MARKER-13-35>Echo Packets</A></H2>
 You can use the <A NAME=MARKER-13-36>AppleTalk Echo Protocol</A> (AEP), a client of DDP, to <A NAME=MARKER-13-37>measure</A> the performance of an AppleTalk network or to test for the presence of a given node. Knowing the approximate speed at which an AppleTalk internet delivers packets is helpful in tuning the behavior of an application that uses a higher-level AppleTalk protocol, such as ATP and ADSP.<P>
 AEP is implemented in each node as a DDP client process referred to as the <B>AEP Echoer.</B> To use the AEP Echoer, you use the <A NAME=MARKER-13-52><CODE>OTSndUData</CODE></A> function to send a packet, called the <A NAME=MARKER-13-39><B>echo request packet</A></B>, to the target node, and you use the <CODE>OTRcvUData</CODE> function to receive a packet in response, called the <A NAME=MARKER-13-40></A><B>echo reply packet.</B><P>
 AEP uses the statically assigned socket number 4, known as the <A NAME=MARKER-13-41><B>echoer socket</B></A>, to listen for echo packets. Whenever the endpoint associated with this socket receives a packet, AEP examines the packet's <A NAME=MARKER-13-42>DDP type</A>. A value of 4 identifies it as an AEP packet, and AEP then examines the first byte of the packet's data portion. A value of 1 identifies the packet as an echo request packet (sent out from your endpoint), and a value of 2 identifies the packet as an echo reply packet (returned to your endpoint from the remote node). <P>
 If the packet is an echo request packet, AEP changes this first byte to a value of 2 (an echo reply packet) before calling DDP to send the packet back to the socket from which it originated. <P>
 To test for the presence of a given node, you can iterate through a series of addresses--sending each several packets. If a node exists, AEP sends a packet back; if the node doesn't exist, no packet returns. Be sure to send each node address several packets in case one or more are lost in transmission.<P>
 To measure network performance, you need to know the round-trip time of a packet between two nodes on an AppleTalk internet. This is dependent on such factors as the network configuration, the number of routers and bridges that a packet must traverse, and the amount of traffic on the network. As these change, so does the packet transmission time. ATP protocol options let you specify retry-count and interval numbers whose optimum values you can better assess if you know the average round-trip time of a packet on your application's network. <P>
 Here are some <A NAME=MARKER-13-43>general guidelines</A> for using the AEP Echoer to measure network performance:<P>
<UL>
<P><LI>Use the maximum packet size that you plan on using in your application.<P>
<P><LI>Accept only echo reply packets from the target node. Set the DDP type field of your endpoint to 4 to filter out all packets except for AEP packets.<P> 
<P><LI>Send more than one packet and calculate the average round-trip time. <P>
Typically, you should receive an echo reply packet within a few milliseconds on a LAN and within a few seconds on a WAN. If you do not get a response after about 10 seconds, you can assume that DDP dropped or lost your echo request packet, and you can resend the packet. <P>
The echo reply packet contains the same data that you sent in the echo request packet. If you send multiple packets to determine an average turnaround time and to compensate for the possibility of lost or dropped packets, you should include different data in the data portion of each packet. This allows you to distinguish between replies to different request packets in the event that either some replies are not delivered in the same order that you sent them or that some packets are dropped. <P>
<P><LI>Bracket the code that sends and receives echo packets with a call to the <CODE>OTGetTimeStamp </CODE>function. This function gives much better resolution than the <A NAME=MARKER-13-44><CODE>TickCount</CODE></A> function<I>. <A NAME=MARKER-13-45></A></I><P>
</UL>
<A NAME=HEADING68-41></A>
<H2>Working With <A NAME=MARKER-13-46>Multinodes</A></H2>
 If you are using DDP, you can specify a multinode address for an endpoint. This allows you to bind endpoints to multiple node addresses on the same physical port, which can be useful for testing. Using only one physical machine, you can use multinode addressing to simulate multiple machines. <P>
 If a multinode client sends a broadcast or self-send packet, Open Transport makes copies of the packet for the other multinode clients on the same machine internally, thus reducing traffic on the network. <P>
 The significant fields for the multinode address format are the network number and node ID. You can request specific values for these address elements when you bind a multinode endpoint and the <CODE>OTBind</CODE> functionwill return the actual network and node values for the address to which Open Transport bound the endpoint. Multinode endpoints must use the <CODE>DDP_OPT_SRCADDR</CODE> option to specify the source DDP address for outgoing packets on a per-packet basis.<P>
<A NAME=HEADING68-45></A>
<H2>The <A NAME=MARKER-13-47></A>DDP Source Address Option</H2>
 DDP defines the option <A NAME=MARKER-13-129></A><CODE>DDP_OPT_SRCADDR</CODE>, which sets the source address for outgoing packets. This option is required for multinode endpoints, such as ARA, but can also be used with other types of endpoints. <P>
 The option's value must be a DDP address structure using the <CODE>AF_ATALK_DDP</CODE> address format.  The source network number, node number, and source socket are taken from the DDP address.<P>
 This option allows a multinode endpoint to tell Open Transport which of its several sockets actually sent the packet.<P>
<A NAME=HEADING68-49></A>
<H2><A NAME=MARKER-9-49></A>Using General Open Transport Functions With DDP</H2>
 This section describes any special considerations you must take into account for Open Transport functions when you use them with the Open Transport DDP implementation. DDP uses the following Open Transport functions:<P>
<UL>
<P><LI><CODE><A NAME=MARKER-13-50></A><A NAME=MARKER-9-51></A>OTBind</CODE><P>
The <CODE>OTBind</CODE> function associates a local protocol address with the endpoint you specify with the <CODE>ref</CODE> parameter. You can only bind one DDP or multinode endpoint to a single protocol address.<P> 
<P><LI><CODE><A NAME=MARKER-13-52></A><A NAME=MARKER-9-53></A>OTSndUData</CODE><P>
The <CODE>OTSndUData</CODE> function sends data through connectionless transactionless protocols. <P>
When you use this function with DDP, you can enable raw mode packet processing both on send and receive by sending a <CODE>TNetBuf</CODE> structure with the <CODE>unitdata.addr.len</CODE> field set to <CODE>0xffffffffUL</CODE>. With raw mode enabled the contents of the <CODE>unitdata.udata.buf</CODE> field is the complete DDP packet that will be sent out by the <CODE>OTSndUData</CODE> function.<P>
To disable raw mode packet processing, send a standard DDP packet with the <CODE>unitdata.addr</CODE> structure fields filled in normally.<P>
<P><LI><CODE>OTRcvUData</CODE><P>
The <CODE>OTRcvUData</CODE> function receives data through connectionless transactionless protocols. <P>
<P><LI><CODE>OTRcvUDErr</CODE><P>
Clears an error condition arising in the course of data transmission and returns the reason for the error.<A NAME=MARKER-13-3></A><P>
</UL>
<HR>
<B>Subtopics</B>
<B><!-- TOC --><DL>
<DT><A HREF="NetworkingWOT-68.html#HEADING68-7">Binding a DDP Endpoint</A>
<DD>
<DT><A HREF="NetworkingWOT-68.html#HEADING68-16">Using the DDP Type Field to Filter Packet Delivery</A>
<DD>
<DT><A HREF="NetworkingWOT-68.html#HEADING68-21">Using the Self-Send and Checksum Options</A>
<DD>
<DT><A HREF="NetworkingWOT-68.html#HEADING68-27">Using Echo Packets</A>
<DD>
<DT><A HREF="NetworkingWOT-68.html#HEADING68-41">Working With Multinodes</A>
<DD>
<DT><A HREF="NetworkingWOT-68.html#HEADING68-45">The DDP Source Address Option</A>
<DD>
<DT><A HREF="NetworkingWOT-68.html#HEADING68-49">Using General Open Transport Functions With DDP</A>
<DD>
</DL>
</B>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="NetworkingWOT-67.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="NetworkingWOT-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="NetworkingWOT-491.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A>  <A HREF="NetworkingWOT-69.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="NetworkingWOT-4.html">&copy; Apple Computer, Inc.</A><br>15 JAN 1998<P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML> 
