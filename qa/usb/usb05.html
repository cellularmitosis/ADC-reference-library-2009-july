<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Q&amp;A USB05: Understanding USB Error -6911 - (kUSBNotResponding)</title>	<meta name="keywords" content="Mac USB -6911 error kUSBNotResponding Clear_Feature usbWIndex USBClearPipeStallByReference">	<meta name="Description" content="Technical Q&amp;A USB05: Q&amp;A explains what happens when you receivea USB error -6911 (kUSBNotResponding) and details how torecover from this error."><meta name="categories" content="USB"><meta name="week-posted" content="Nov 16, 1998 - Nov 20, 1998"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"><a name="//apple_ref/doc/uid/DTS10002271" title="Understanding USB Error -6911 - (kUSBNotResponding)"></a> <!-- white background --><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalqas/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/idxUSB-date.html" target="_blank">Hardware & Drivers > USB</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A USB05</div>
<div id="pageheadsub">Understanding USB Error -6911 - (kUSBNotResponding)</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER>			<!-- -->						<!-- Document Body --><table cellspacing="0" cellpadding="0" border="0" WIDTH="600"><tr><td align="left" scope="row"><hr width=500 align=center><p id=p2>Q: I'm getting an occasional USB error -6911(<CODE>kUSBNotResponding</CODE>). According to the documentation, this means thatthe device is hung. What does this mean in terms of what happened onthe bus, and how do I handle this error in my class driver?</p><p id=p4>A: The <CODE>kUSBNotRespondingErr</CODE> results becausethe host controller on the Macintosh tried three times to transferdata and did not receive an <CODE>ACK</CODE> or <CODE>NAK</CODE> packet in return. The hostinternally tries three times before returning this error, which theUSB returns to the caller as documented in the USB Specification(revision 1.0, section 4.5.2). From a packet-level perspective, thehost controller issued 3 <CODE>IN</CODE> or <CODE>OUT</CODE> PIDs (Packet ID), and did notreceive a response from the USB function.</p><p id=p4>Usually this happens because the device is hung. Sometimes,transient errors can cause this problem on a request which takes along time. (Lots of <CODE>NAK</CODE>s give lots of opportunity for things to gowrong.)</p><p id=p4>If this is happening, you can recover from the problem. Youfirst need to clear the stall on the pipe using the<CODE>USBClearPipeStallByReference</CODE> function. Second, you need toresynchronize the host and the device (which is usually a<CODE>Clear_Feature</CODE> or <CODE>Endpoint_Stall</CODE>).</p><p id=p4>An example of sending the <CODE>Clear_Feature</CODE> request is shown below.Note that this code assumes the use of the USB v1.1 USB.h headerfile.</p>                  <TABLE BORDER=0 CELLPADDING=1> <TR> <td bgcolor="#EEEEE0" align=left><pre>    pb.pbLength = sizeof(pb);    pb.usbReference = deviceRef;    pb.usbCompletion = yourAsnchHandlerRoutine;    pb.usbStatus = noErr;    pb.pbVersion = kUSBCurrentPBVersion;    pb.usb.cntl.BMRequestType = USBMakeBMRequestType(kUSBOut,         kUSBStandard, kUSBEndpoint);    pb.usb.cntl.BRequest = kUSBRqClearFeature;    pb.usb.cntl.WValue = 0;                   // feature selector - Endpoint stall    pb.usb.cntl.WIndex = endpointNumber;    pb.usbReqCount = 0;    pb.usbBuffer = nil;    pb.usbFlags = 0;    err = USBDeviceRequest(pb);&nbsp; <B>Example 1. Clear_Feature request example</B></pre>  </TD> </TR> </TABLE><BR><p id=p4>When making the <CODE>Clear_Feature</CODE> requestusing <CODE>USBDeviceRequest</CODE>, the <CODE>usbWIndex</CODE> field must be set to the<CODE>endpointNumber</CODE>. The <CODE>endpointNumber</CODE> is typically obtained duringdevice configuration. Alternatively, you could obtain the<CODE>endpointNumber</CODE> using the <CODE>USBFindNextAssociatedDescriptor</CODE> call. Examplevalues are <CODE>0x01</CODE> for an output endpoint, or <CODE>0x81</CODE> for an input endpoint.</P><p id=p4>For USB v1.1 and greater, a minor change was implemented tosimplify the requirement that the <CODE>usbWIndex</CODE> field be set the to the <CODE>endpointNumber</CODE>. Instead of setting the <CODE>usbWIndex</CODE>field, set the <CODE>usbFlags</CODE> field with the<CODE>kUSBAddressRequest</CODE> bit set. The USBManager v1.1 and greater will check the <CODE>usbFlags</CODE> field to see if the <CODE>kUSBAddressRequest </CODE>bit is set, and check if the"usb.cntl.BMRequestType" field is for an endpoint, then fill in the<CODE>endpointNumber</CODE> into the <CODE>usbWIndex</CODE> field corresponding to the endpoint reference passed in the <CODE>usbReference</CODE> field. The following code sampledemonstrates this modification for USB v1.1 and later. Note that thecode in Example 1 also works with USB v1.1 and later. Use the<CODE>gestalt</CODE> selector <CODE>'usbv'</CODE> to determine the version of Mac OS USB present.</P><TABLE BORDER=0 CELLPADDING=1> <TR> <td bgcolor="#EEEEE0" align=left>	<pre>    pb.pbLength = sizeof(pb);    pb.usbReference = endpointRef;    pb.usbCompletion = yourAsnchHandlerRoutine;    pb.usbStatus = noErr;    pb.pbVersion = kUSBCurrentPBVersion;    pb.usb.cntl.BMRequestType =         USBMakeBMRequestType(kUSBOut, kUSBStandard, kUSBEndpoint);    pb.usb.cntl.BRequest = kUSBRqClearFeature;    pb.usb.cntl.WValue = 0;         // feature selector - Endpoint stall    pb.usbReqCount = 0;    pb.usbBuffer = nil;    pb.usbFlags = kUSBAddressRequest;    err = USBDeviceRequest(pb);&nbsp; <B>Example 2. Alternate Clear_Feature request for USB 1.1 and later</B></pre> </TD> </TR> </TABLE><p id=p4>Note that the <CODE>kUSBNotRespondingErr</CODE> can also occur if the USB cable is unplugged while the host is communicating with the device. When this error occurs, make the <CODE>Clear_Feature</CODE> request. If the device hasbeen unplugged, the <CODE>USBDeviceRequest</CODE> will complete with another -6911error.</p><!-- begin_date --><H4 ALIGN=center>[Nov 16 1998]</H4><!-- end_date --></td></tr></table></CENTER><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/usb/usb05.html%3Fid%3DDTS10002271-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/usb/usb05.html%3Fid%3DDTS10002271-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/usb/usb05.html%3Fid%3DDTS10002271-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>