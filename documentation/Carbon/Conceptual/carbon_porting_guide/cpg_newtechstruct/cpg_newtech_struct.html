<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Carbon Porting Guide (Legacy): New Carbon Technologies</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="New Carbon Technologies"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	<meta name="ROBOTS" content="NOINDEX"/>
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30000991-CH205" title="New Carbon Technologies"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../../LegacyTechnologies/index.html#//apple_ref/doc/uid/TP30000440-TP30000470" target="_top">Legacy Documents</a> &gt; <a href="../../../../LegacyTechnologies/Carbon-date.html#//apple_ref/doc/uid/TP30000440-TP30000470-TP30000494" target="_top">Carbon</a> &gt; <a href="../cpg_intro_struct/cpg_intro_struct.html#//apple_ref/doc/uid/TP30000991-CH201-TPXREF101">Carbon Porting Guide (Legacy)</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../cpg_portexampstruct/cpg_portexamp_struct.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../cpg_apdx_func/cpg_apdx_funcs.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        <script type="text/javascript" language="JavaScript">placeWatermark()</script>
<div id="legacyOuterWrapper"><div align="center" id="watermark">
<div class="legacybox">
<h1>Legacy Document<span class="closebutton"><a href="javascript:closeWatermark()"><img src="../../../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>
        <a name="//apple_ref/doc/uid/TP30000991-CH205-TPXREF101" title="New Carbon Technologies"></a><h1>New Carbon Technologies</h1><p>This chapter describes several Mac OS technologies that are new with Carbon. While these technologies are not required in Carbon applications, adopting them can result in improved performance and user experience as well as reduced development cycles. </p>
<!-- This template is being used for both PDF and HTML. -->

    
    <h4>In this section:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="cpg_newtech_struct.html#//apple_ref/doc/uid/TP30000991-CH205-TPXREF120">Carbon Event Manager</a>
				
			<br/>
			
        
			
			
				<a href="cpg_newtech_struct.html#//apple_ref/doc/uid/TP30000991-CH205-TPXREF121">Core Foundation</a>
				
			<br/>
			
        
			
			
				<a href="cpg_newtech_struct.html#//apple_ref/doc/uid/TP30000991-CH205-TPXREF122">DataBrowser</a>
				
			<br/>
			
        
			
			
				<a href="cpg_newtech_struct.html#//apple_ref/doc/uid/TP30000991-CH205-BABBEDBD">Multilingual Text Engine (MLTE)</a>
				
			<br/>
			
        
			
			
				<a href="cpg_newtech_struct.html#//apple_ref/doc/uid/TP30000991-CH205-BABBFCCI">An Example: Adding Carbon Events to Sample</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP30000991-CH205-TPXREF120" title="Carbon Event Manager"></a><h2>Carbon Event Manager</h2><p><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_104"></a>The Carbon Event Manager is an event handling API that replaces the Classic Mac OS Event Manager. It simplifies the event model and it is well-suited for the preemptive multitasking capabilities of Mac OS X. For example, when using Carbon events, an application that is performing periodic actions while idle (blinking the cursor, for example) does not have to endlessly cycle through a <code>WaitNextEvent</code> loop while doing so. The advantages of the Carbon Event Manager include the following:</p><ul class="ul"><li class="li"><p>Handlers for common events (such as mouse events and keyboard events) are included. You don’t need to write your own event handlers unless you want to override default behaviors. </p></li><li class="li"><p>The Carbon Event Manager can handle any number of event types (as opposed to the16 event types available in the Classic event record).</p></li><li class="li"><p>The Carbon Event Manager handles notifications and defproc messaging in addition to the usual events. </p></li><li class="li"><p>The streamlining of the event handling system results in a more responsive system and a better user experience. </p></li></ul><p>When adapting an application to use Carbon events, you typically replace the <code>WaitNextEvent</code> loop and event processing functions with one of more simple event handling calls. Your application must register the types of events it wishes to be notified about, and then implement handlers to address the registered events. </p><p>The Carbon Event Manager is available for Carbon applications running on Mac OS 8.6 and later, so if you do not need compatibility back to Mac OS 8.1, we highly encourage you to adopt it. The Carbon event model is flexible enough to coexist with <code>WaitNextEvent</code>, so you can make the adoption as gradual as you like. While the <code>WaitNextEvent</code> event model still works on Mac OS X, your programs and the overall system will perform better if you use Carbon events. </p><p>For more information about the Carbon Event Manager, see the documentation available at</p><p><span class="content_text"><a href="http://developer.apple.com/documentation/carbon/Reference/Carbon_Event_Manager_Ref/index.html" target="_top">http://developer.apple.com/documentation/carbon/Reference/Carbon_Event_Manager_Ref/index.html</a></span></p><p>as well as <span class="content_text"><a href="cpg_newtech_struct.html#//apple_ref/doc/uid/TP30000991-CH205-BABBFCCI">“An Example: Adding Carbon Events to Sample.”</a></span></p><a name="//apple_ref/doc/uid/TP30000991-CH205-TPXREF121" title="Core Foundation"></a><h2>Core Foundation</h2><p><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_105"></a>Core Foundation is a new set of APIs that provides a simple interface for handling many common needs for applications. For example, CFPreference APIs provide a standard interface for creating and manipulating an application’s user preferences. As most Core Foundation functions are part of the Carbon API, they run on both Mac OS X and Mac OS 8 and 9. In addition, Core Foundation functions are compatible with the Foundation classes available in the Cocoa environment, which simplifies the sharing of data between Carbon and Cocoa applications. </p><p>In addition to Preferences Services, other Core Foundation services that you may find useful for your Carbon application include the following:</p><ul class="ul"><li class="li"><p>Bundle Services, which provides the APIs used to access files and other resources stored in a bundle hierarchy. See <span class="content_text"><a href="../cpg_prepstruct/cpg_prep_struct.html#//apple_ref/doc/uid/TP30000991-CH202-BABBFHIH">“Consider Using Bundles”</a></span> for more information about bundles. </p></li><li class="li"><p>Plug-In Services, which provides a standard plug-in architecture for Mac OS X and Mac OS 8 and 9 applications. You can package plug-in binaries for multiple platforms together, and the Plug-In Services APIs can transparently load the proper one (assuming, of course, that they share the same interface).</p></li><li class="li"><p>String Services, which provides a simple interface for storing, converting, and manipulating Unicode strings. If your application uses (or is planning to support) Unicode, you should consider adopting String Services. </p></li><li class="li"><p>The XML Parser, which provides an interface for writing and reading XML documents. </p></li><li class="li"><p>Property List Services, which provides an interface to organize data into property lists (“plists”). It also allows you to convert hierarchically structured combinations of basic data types in these lists to and from standard XML.</p></li></ul><p>For more information about Core Foundation Services, see <em>Inside Mac OS X: System Overview</em> and Core Foundation documentation at the Carbon documentation site: </p><p><span class="content_text"><a href="http://developer.apple.com/documentation/Carbon/index.html" target="_top">http://developer.apple.com/documentation/Carbon/index.html</a></span></p><a name="//apple_ref/doc/uid/TP30000991-CH205-TPXREF122" title="DataBrowser"></a><h2>DataBrowser</h2><p><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_106"></a>DataBrowser is a new Control Manager control (defined in <code>ControlDefinitions.h</code>) that lets you display data in sortable, navigatable lists in a manner similar to the list view and column view settings of the Finder. If you need to organize data in manner that is easily accessible to the user, you should consider using the DataBrowser. Here are some advantages of the various views:</p><ul class="ul"><li class="li"><p>The list view allows the user to sort by various column attributes related to the data you are displaying. For example, the Finder allows you to display files by type, size, or date modified, among other characteristics.</p></li><li class="li"><p>The column view is useful for navigating large hierarchies or trees of data. For example both the Mac OS X Finder and the Navigation Services Save dialog box use DataBrowser to let the user quickly find a particular location in a volume’s file hierarchy. </p></li></ul><p>For more information about DataBrowser, see the sample code included with the Carbon SDK. </p><a name="//apple_ref/doc/uid/TP30000991-CH205-BABBEDBD" title="Multilingual Text Engine (MLTE)"></a><h2>Multilingual Text Engine (MLTE)</h2><p><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_107"></a><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_108"></a>The Multilingual Text Engine (MLTE) is the suggested replacement for TextEdit in Carbon applications. While you can still use TextEdit in Carbon, MLTE provides many additional features and simplifies the programming interface; you can accomplish more with fewer lines of code. Some of MLTE’s features include the following: </p><ul class="ul"><li class="li"><p>Full Unicode support, including transparent access to Apple Type Services for Unicode Imaging (ATSUI) for rendering text, and the Text Encoding Converter (TEC) for converting between encodings. </p></li><li class="li"><p>Full support for alternate input methods using the Text Services Manager (TSM).</p></li><li class="li"><p>Support for greater than 32 KB of text.</p></li><li class="li"><p>Built-in scroll bar handling.</p></li><li class="li"><p>Full justification of text.</p></li><li class="li"><p>Built-in support for basic user actions, such as highlighting selected text, dragging selected text, and moving the caret in response to arrow key presses. </p></li><li class="li"><p>Multiple levels of undo.</p></li><li class="li"><p>Built-in printing support.</p></li></ul><p>MLTE is available in CarbonLib 1.2 and later. You can also use it in non-Carbon applications on Mac OS 8.6 and later. </p><p>For more information about MLTE, see the documentation available at </p><p><span class="content_text"><a href="http://developer.apple.com/documentation/Carbon/Reference/Multilingual_Text_Engine/index.html" target="_top">http://developer.apple.com/documentation/Carbon/Reference/Multilingual_Text_Engine/index.html</a></span></p><p>and the MLTE SDK at </p><p><span class="content_text"><a href="http://developer.apple.com/sdk/" target="_top">http://developer.apple.com/sdk/</a></span></p><a name="//apple_ref/doc/uid/TP30000991-CH205-BABBFCCI" title="An Example: Adding Carbon Events to Sample"></a><h2>An Example: Adding Carbon Events to Sample</h2><p><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_109"></a><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_110"></a>The Carbon Event Manager is the most important of the optional technologies available with Carbon; if you plan to add only one new API to your application, it should be Carbon events. In addition to simplifying your event handling code, Carbon events will make your application a good processor-sharing citizen on Mac OS X, which will improve the performance of all running applications. </p><p>This section illustrates the adoption of the Carbon Event Manager by adding Carbon events to the Carbon version of the Sample application shown in <span class="content_text"><a href="../cpg_portexampstruct/cpg_portexamp_struct.html#//apple_ref/doc/uid/TP30000991-CH204-BBGCEAAG">Listing 3-1</a></span> and <span class="content_text"><a href="../cpg_portexampstruct/cpg_portexamp_struct.html#//apple_ref/doc/uid/TP30000991-CH204-BBGBCAAD">Listing 3-2</a></span>. </p><p><span class="content_text"><a href="../cpg_prepstruct/cpg_prep_struct.html#//apple_ref/doc/uid/TP30000991-CH202-TPXREF115">“Determine the Appropriate CarbonLib Version”</a></span> indicates that the Carbon Event Manager is available only in CarbonLib 1.2 and later when Mac OS 8.6 or later is present. While this means that you cannot run on Mac OS 8.1, it also means that you are free to incorporate any newer APIs up to Mac OS 8.6 if that makes the work easier. </p><p>The basic model for Carbon events is that you register callback handlers for each event (or type of event) you wish to handle. You attach these handlers to specific objects, such as a window or a button. Different objects of the same type do not have to have the same handler. For example, two buttons can each have their own distinct handler. With this level of flexibility in handling events, it is important to determine the scope required for each event. For example, should an event affect a single window, all open windows, or the entire application? In most cases it is easier to think in terms of what object is affected rather than what event occurred. </p><p>After any initial setup, your application calls <code>RunApplicationEventLoop</code>, which essentially replaces the <code>WaitNextEvent</code> loop. From that point on, your application is notified only when an event you specified occurs. </p><a name="//apple_ref/doc/uid/TP30000991-CH205-TPXREF123" title="Standard Event Handlers"></a><h3>Standard Event Handlers</h3><p><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_111"></a><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_112"></a><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_113"></a>The Carbon Event Manager provides default event handlers for many common types of events. For example, the standard handler for a window automatically handles dragging, activation, deactivation, window zooming and resizing. Of course, you will mostly likely still need to draw into or update the content region as a result of some actions, but much of the basic work is taken care of for you. A good rule of thumb is to install the standard handler first, see what actions it covers, and then write handlers for any additional actions you may want to take. </p><a name="//apple_ref/doc/uid/TP30000991-CH205-TPXREF124" title="The Basic Conversion"></a><h3>The Basic Conversion</h3><p>In the Carbon version of Sample, most of the event handling occurs in the functions <code>EventLoop</code> and <code>DoEvent</code>. Here is a breakdown of the events to address: </p><ul class="spaceabove"><li class="li"><p>Adjusting the cursor shape depending on the region it occupies: Previously the cursor was adjusted each time through the event loop. Because there is no equivalent event loop that we can access in Carbon events, an alternate triggering mechanism is required. One method would be to update the cursor whenever the mouse moves. Another would be to set up a timer to adjust the cursor at regular intervals. </p></li><li class="li"><p><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_114"></a><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_115"></a>Menu selections: The Carbon Event Manager can associate special command events with menu items. Many common menu items have command events defined for them in <code>CarbonEvents.h</code>, and you can assign your own using the Window Manager function <code>SetMenuItemCommandID</code>. When a menu item is selected (either through menu selection or a keyboard equivalent), the Carbon Event Manager sends the appropriate command event to the handler. Some menu selections are related to the window only (such as setting the traffic light color), while others are related to the application (such as the About command). This division suggests a menu command handler at both the window level and the application level. </p><p>Note that the standard application handler automatically handles basic menu tracking, highlighting, and so on. All you need to do is process the menu selection. </p></li><li class="li"><p><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_116"></a><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_117"></a>Keyboard events: Because the only keyboard input Sample requires are keyboard equivalents for menu items, you can handle these the same as menu selections. </p></li><li class="li"><p>Mouse clicks in the traffic light window: The light color toggles on each click in the content region of the window. This event is entirely window-related, which suggests a window-level handler. </p></li><li class="li"><p>Window dragging, zooming, resizing, activation, and deactivation: The standard window event handler addresses these events, so all you need to do is update the content region if necessary. </p></li><li class="li"><p><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_118"></a>Update events: The Carbon Event Manager posts events indicating that you should change your window contents, so you should redraw the contents at that time. </p></li><li class="li"><p>High level (Apple) events: The only case to worry about is the Quit Apple event, for which we have already installed a handler. </p></li><li class="li"><p>Disk Events: This case deals with bad floppy disks, and Carbon does not support the <code>DIBadMount</code> function or the <code>diskEvt</code> event. This example ignores disk events.</p></li><li class="li"><p>Application suspend and resume events: The standard application event handler covers the basic functionality required for suspend and resume events. </p></li></ul><p><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_119"></a><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_120"></a>This information indicates that event handlers are needed at both the window-level and the application level. </p><a name="//apple_ref/doc/uid/TP30000991-CH205-BABHBIDF" title="Installing the Standard Event Handlers"></a><h4>Installing the Standard Event Handlers</h4><p>Before adding your application-specific event handlers, you should install the standard handlers for window and application events. </p><p>One way to assign the standard window handler to the traffic light window is to call the function <code>InstallStandardWindowEventHandler</code> after creating the window in the <code>Initialize</code> function.</p><div class="codesample"><table><tr><td scope="row"><pre>window = GetNewWindow(rWindow, NULL, (WindowPtr)-1);<span></span></pre></td></tr><tr><td scope="row"><pre>InstallStandardEventHandler(GetWindowEventTarget(window)); /* installs the default */<span></span></pre></td></tr><tr><td scope="row"><pre>                                                    /* handler for window events */<span></span></pre></td></tr><tr><td scope="row"><pre>ShowWindow(window);<span></span></pre></td></tr></table></div>	<p>The <code>GetWindowEventTarget</code> function returns an event reference (type <code>EventTargetRef</code>) to associate with the desired object (in this case, a window). Similar functions exist to create event references for controls, menus, and other objects. </p><p>However, because the application must run in Mac OS 8.6 or later, you can call the Window Manager function <code>CreateNewWindow</code> instead, which lets you specify an attribute to use the standard window handler. Doing so also provides many of the standard window controls (resize button, and so on) for free.</p><div class="codesample"><table><tr><td scope="row"><pre>Rect windowBounds;           /* use Rect for bounds in CreateNewWindow */<span></span></pre></td></tr><tr><td scope="row"><pre>WindowAttributes windowAttr;  /* to hold window attribute flags in CreateNewWindow */<span></span></pre></td></tr><tr><td scope="row"><pre>…<span></span></pre></td></tr><tr><td scope="row"><pre>windowAttr = kWindowStandardDocumentAttributes| /* standard window */<span></span></pre></td></tr><tr><td scope="row"><pre>                kWindowStandardHandlerAttribute| /* standard window event handler */<span></span></pre></td></tr><tr><td scope="row"><pre>                kWindowInWindowMenuAttribute;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>SetRect (&amp;windowBounds, 40, 60, 280, 520); /* bounds for the new window */<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>CreateNewWindow(kDocumentWindowClass, windowAttr, &amp;windowBounds, &amp;window);<span></span></pre></td></tr><tr><td scope="row"><pre>SetWindowTitleWithCFString(window, CFSTR("Traffic"));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ChangeWindowAttributes(window, NULL, /* remove close box and resize tab */<span></span></pre></td></tr><tr><td scope="row"><pre>                         kWindowCloseBoxAttribute|kWindowResizableAttribute);<span></span></pre></td></tr><tr><td scope="row"><pre>ShowWindow(window);<span></span></pre></td></tr></table></div><p>The <code>SetWindowTitleWithCFString</code> function is a Core Foundation String Services function. </p><p>To more closely approximate the original Sample, you can call the Window Manager function <code>ChangeWindowAttributes</code> to remove the close box and the resize tab. </p><p>The standard application event handler is installed automatically when you call <code>RunApplicationEventLoop</code>, so you do not need to explicitly install it. </p><a name="//apple_ref/doc/uid/TP30000991-CH205-BABBBBIC" title="Registering Your Own Event Handlers"></a><h4>Registering Your Own Event Handlers</h4><p>After installing the standard handlers, you must register your event handlers with the system. The Carbon Event Manager defines events by the class of event (window, mouse, and so on) as well as the type (mouse moved, content region clicked, and so on). You must specify these when registering your handlers, as in this example: </p><div class="codesample"><table><tr><td scope="row"><pre>EventTypeSpec   appEventList[] = {{kEventClassCommand, kEventCommandProcess},<span></span></pre></td></tr><tr><td scope="row"><pre>                                { kEventClassMouse, kEventMouseMoved}};<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>EventTypeSpec   windEventList[] = {{kEventClassWindow, kEventWindowDrawContent },<span></span></pre></td></tr><tr><td scope="row"><pre>                                 { kEventClassWindow, kEventWindowClickContentRgn },<span></span></pre></td></tr><tr><td scope="row"><pre>                                 { kEventClassWindow, kEventWindowBoundsChanged},<span></span></pre></td></tr><tr><td scope="row"><pre>                                 { kEventClassCommand, kEventCommandProcess}};<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>…<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    /* Installing the application event handler */<span></span></pre></td></tr><tr><td scope="row"><pre>    InstallApplicationEventHandler(NewEventHandlerUPP(MyAppEventHandler),<span></span></pre></td></tr><tr><td scope="row"><pre>                                2, appEventList, 0, NULL);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    /* Installing the window event handler */<span></span></pre></td></tr><tr><td scope="row"><pre>    InstallWindowEventHandler(window, NewEventHandlerUPP(MyWindowEventHandler),<span></span></pre></td></tr><tr><td scope="row"><pre>                                4, windEventList, 0, NULL);<span></span></pre></td></tr></table></div>	<p>The type <code>EventTypeSpec</code> arrays hold the pairs of event classes and types which are then passed into the appropriate handler installation calls. The calls <code>InstallApplicationEventHandler</code> and <code>InstallWindowEventHandler</code> are macros derived from the more general Carbon Event Manager function <code>InstallEventHandler</code>. Remember to pass universal procedure pointers instead of normal pointers when specifying your callback handlers. <code>CarbonEvents.h</code> defines the format for your callback handlers. </p><p>If desired, you can register individual event handlers for each event. However, for this example it is convenient to group them by object.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_4" title="Note"></a><p><strong>Note:</strong>&nbsp; The handlers you install complement the standard event handlers described earlier. For example, the standard window handler will resize a window in response to a resize event. However, if you indicated that you wanted to handle window resize events in your own handler, you could specify additional actions to take (such as refreshing the content window after the resize) while still allowing the standard handler to perform the window resize. </p></div><p>The handlers in this example essentially take the place of the <code>DoEvent</code> function, which called other functions to process the events. </p><a name="//apple_ref/doc/uid/TP30000991-CH205-TPXREF125" title="The Application-Level Event Handler"></a><h4>The Application-Level Event Handler</h4><p><span class="content_text">Listing 4-1</span> shows an application-level event handler for the Sample application. </p><a name="//apple_ref/doc/uid/TP30000991-CH205-BABCGIJJ" title="Listing 4-1Application-level event handler for Sample"></a><p class="codesample"><strong>Listing 4-1&nbsp;&nbsp;</strong>Application-level event handler for Sample</p><div class="codesample"><table><tr><td scope="row"><pre>static pascal OSStatus MyAppEventHandler (EventHandlerCallRef myHandlerChain,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            EventRef event, void* userData)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    UInt32          whatHappened;<span></span></pre></td></tr><tr><td scope="row"><pre>    HICommand       commandStruct;<span></span></pre></td></tr><tr><td scope="row"><pre>    Point           wheresMyMouse;<span></span></pre></td></tr><tr><td scope="row"><pre>    RgnHandle       CursorRgn;<span></span></pre></td></tr><tr><td scope="row"><pre>    short           itemHit;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus        result = eventNotHandledErr; /* report failure by default */<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    whatHappened = GetEventKind(event);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    switch (whatHappened)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            case kEventCommandProcess:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                    GetEventParameter (event, kEventParamDirectObject,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        typeHICommand, NULL, sizeof(HICommand),<span></span></pre></td></tr><tr><td scope="row"><pre>                                        NULL, &amp;commandStruct);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                    switch (commandStruct.commandID)<span></span></pre></td></tr><tr><td scope="row"><pre>                        {<span></span></pre></td></tr><tr><td scope="row"><pre>                            case kCommandAbout:<span></span></pre></td></tr><tr><td scope="row"><pre>                                itemHit = Alert (rAboutAlert, nil);<span></span></pre></td></tr><tr><td scope="row"><pre>                                result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>                                break;<span></span></pre></td></tr><tr><td scope="row"><pre>                            default:<span></span></pre></td></tr><tr><td scope="row"><pre>                                break;<span></span></pre></td></tr><tr><td scope="row"><pre>                        }<span></span></pre></td></tr><tr><td scope="row"><pre>                    break;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            case kEventMouseMoved:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                    CursorRgn = NewRgn();<span></span></pre></td></tr><tr><td scope="row"><pre>                    GetEventParameter (event, kEventParamMouseLocation, typeQDPoint,<span></span></pre></td></tr><tr><td scope="row"><pre>                                         NULL, sizeof(Point), NULL, &amp;wheresMyMouse);<span></span></pre></td></tr><tr><td scope="row"><pre>                    AdjustCursor(wheresMyMouse, CursorRgn);<span></span></pre></td></tr><tr><td scope="row"><pre>                    DisposeRgn(CursorRgn);<span></span></pre></td></tr><tr><td scope="row"><pre>                    result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>                    break;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            default:<span></span></pre></td></tr><tr><td scope="row"><pre>                    break;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>	<p>The event handler takes three parameters: </p><ul class="spaceabove"><li class="li"><p>The <code>myHandlerChain</code> parameter is a reference to the handler calling chain; that is, the hierarchy of event handlers that could handle this event. You would pass this reference if you wanted to call <code>CallNextEventHandler</code>, for example, which you could use to add pre- or postprocessing to the actions of a standard handler. </p></li><li class="li"><p>The <code>event</code> parameter contains specific information related to the event (much the way the fields of an event record hold event-specific information). </p></li><li class="li"><p>The <code>userData</code> field holds any user data you specified when you registered your handler with the call to <code>InstallEventHandler</code> (none in this case).</p></li></ul><p>When an event occurs, <code>MyAppEventHandler</code> gets passed the event along with any user data you may have requested (none in this case). It then calls the <code>GetEventKind</code> function to determine the type of event that occurred and then handles the event appropriately.</p><p>The<a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_121"></a><code>kEventCommandProcess</code> function indicates a menu-related command occurred. By calling the <code>GetEventParameter</code> function, the handler determines which item was selected. At the application level only one command is possible: the About selection. Note <code>kCommandAbout</code> is not defined in <code>CarbonEvents.h</code> so, you need to define it yourself. You can do so and then call the Menu Manager function <a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_122"></a><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_123"></a><code>SetMenuItemCommandID</code> in the <code>Initialize</code> function to register it with the system. </p><div class="codesample"><table><tr><td scope="row"><pre>const MenuCommand kCommandAbout = FOUR_CHAR_CODE ('abou');<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>void Initialize()<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    …<span></span></pre></td></tr><tr><td scope="row"><pre>    SetMenuItemCommandID (GetMenuRef(mApple), iAbout, kCommandAbout);<span></span></pre></td></tr><tr><td scope="row"><pre>    …<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Note that instead of calling <code>SetMenuItemCommandID</code> to assign the command ID, you could choose the define it in an <code>'xmnu'</code> resource. </p><p><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_124"></a><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_125"></a><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_126"></a>You don’t need to handle the Quit event because the standard application event handler calls the default Quit Apple event handler when this occurs. If you need to take additional actions before quitting, you can install your own Quit Apple event handler. If you are not using <code>RunApplicationEventLoop</code>, (and therefore not using the standard application handler), you can process the Quit event here. Typically you call the function <code>QuitApplicationEventLoop</code> to break out of the Carbon event loop. </p><p>If you are running your application on Mac OS 8 and 9, you need to register the Quit command ID (defined as <code>kHICommandQuit</code> in <code>CarbonEvents.h</code>) using the <code>SetMenuItemCommandID</code> function, much as you had to for the About item. If you don’t, the Carbon Event Manager will not properly process the event when the Quit item is selected. A convenient time to do this is when you use Gestalt to determine whether to place a Quit item in the File menu.</p><div class="codesample"><table><tr><td scope="row"><pre>    err = Gestalt(gestaltMenuMgrAttr, &amp;result);<span></span></pre></td></tr><tr><td scope="row"><pre>    if (!err &amp;&amp; (result &amp; gestaltMenuMgrAquaLayoutMask)) {<span></span></pre></td></tr><tr><td scope="row"><pre>            menu = GetMenuHandle (mFile);<span></span></pre></td></tr><tr><td scope="row"><pre>            DeleteMenuItem(menu, iQuit);<span></span></pre></td></tr><tr><td scope="row"><pre>            DeleteMenuItem(menu, iQuit-1); /*•• the element above the Quit item */<span></span></pre></td></tr><tr><td scope="row"><pre>                                         /*•• is a separator */<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        else<span></span></pre></td></tr><tr><td scope="row"><pre>        {   /* Assign a command ID to the Quit Item so that the Carbon Event Manager */<span></span></pre></td></tr><tr><td scope="row"><pre>            /* can recognize it. */<span></span></pre></td></tr><tr><td scope="row"><pre>            SetMenuItemCommandID(GetMenuRef(mFile), iQuit, kHICommandQuit);<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr></table></div>	<p>The other application-level event you need to handle is the mouse-moved event, which determines whether or not to adjust the cursor shape. The handler for Sample calls <code>GetEventParameter</code> to obtain the mouse position (the types of parameters you can obtain depends on the event that occurred) and then calls <code>AdjustCursor</code>. </p><p><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_127"></a><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_128"></a>Alternatively, you can adjust the cursor periodically by using a Carbon event timer. Doing so merely involves creating the function to call and then registering it by calling <code>InstallEventLoopTimer</code>. However, this method is similar to polling for an event, which is more processor-intensive, and therefore not suggested for Mac OS X.</p><a name="//apple_ref/doc/uid/TP30000991-CH205-TPXREF126" title="The Window Event Handler"></a><h4>The Window Event Handler</h4><p><span class="content_text">Listing 4-2</span> shows a window event handler for Sample. </p><a name="//apple_ref/doc/uid/TP30000991-CH205-BABCCBFI" title="Listing 4-2Window event handler for Sample"></a><p class="codesample"><strong>Listing 4-2&nbsp;&nbsp;</strong>Window event handler for Sample</p><div class="codesample"><table><tr><td scope="row"><pre>static pascal OSStatus MyWindowEventHandler(EventHandlerCallRef myHandler,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            EventRef event, void* userData)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    WindowRef           window;<span></span></pre></td></tr><tr><td scope="row"><pre>    Rect                bounds;<span></span></pre></td></tr><tr><td scope="row"><pre>    UInt32              whatHappened;<span></span></pre></td></tr><tr><td scope="row"><pre>    HICommand           commandStruct;<span></span></pre></td></tr><tr><td scope="row"><pre>    MenuRef             theMenuRef;<span></span></pre></td></tr><tr><td scope="row"><pre>    UInt16              theMenuItem;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus            result = eventNotHandledErr; /* report failure by default */<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    GetEventParameter(event, kEventParamDirectObject, typeWindowRef, NULL,<span></span></pre></td></tr><tr><td scope="row"><pre>                         sizeof(window), NULL, &amp;window);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    whatHappened = GetEventKind(event);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    switch (whatHappened)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            case kEventWindowDrawContent:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                    DoUpdate(window);<span></span></pre></td></tr><tr><td scope="row"><pre>                    result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>                    break;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            case kEventWindowBoundsChanged:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                    InvalWindowRect(window, GetWindowPortBounds(window, &amp;bounds));<span></span></pre></td></tr><tr><td scope="row"><pre>                    DoUpdate(window);<span></span></pre></td></tr><tr><td scope="row"><pre>                    result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>                    break;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            case kEventWindowClickContentRgn:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                    DoContentClick(window);<span></span></pre></td></tr><tr><td scope="row"><pre>                    DoUpdate(window);<span></span></pre></td></tr><tr><td scope="row"><pre>                    AdjustMenus();<span></span></pre></td></tr><tr><td scope="row"><pre>                    result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>                    break;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            case kEventCommandProcess:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                    GetEventParameter (event, kEventParamDirectObject,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        typeHICommand, NULL, sizeof(HICommand),<span></span></pre></td></tr><tr><td scope="row"><pre>                                        NULL, &amp;commandStruct);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                    theMenuRef = commandStruct.menu.menuRef;<span></span></pre></td></tr><tr><td scope="row"><pre>                    if (theMenuRef == GetMenuHandle(mLight))<span></span></pre></td></tr><tr><td scope="row"><pre>                        {<span></span></pre></td></tr><tr><td scope="row"><pre>                            /* Because the event didn't occur *in* the window, the */<span></span></pre></td></tr><tr><td scope="row"><pre>                            /* window reference isn't valid until we set it here */<span></span></pre></td></tr><tr><td scope="row"><pre>                            window = FrontWindow();<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                            theMenuItem = commandStruct.menu.menuItemIndex;<span></span></pre></td></tr><tr><td scope="row"><pre>                            switch ( theMenuItem )<span></span></pre></td></tr><tr><td scope="row"><pre>                                {<span></span></pre></td></tr><tr><td scope="row"><pre>                                    case iStop:<span></span></pre></td></tr><tr><td scope="row"><pre>                                        SetLight(window, true);<span></span></pre></td></tr><tr><td scope="row"><pre>                                        break;<span></span></pre></td></tr><tr><td scope="row"><pre>                                    case iGo:<span></span></pre></td></tr><tr><td scope="row"><pre>                                        SetLight(window, false);<span></span></pre></td></tr><tr><td scope="row"><pre>                                        break;<span></span></pre></td></tr><tr><td scope="row"><pre>                                }<span></span></pre></td></tr><tr><td scope="row"><pre>                            DoUpdate(window);<span></span></pre></td></tr><tr><td scope="row"><pre>                            AdjustMenus();<span></span></pre></td></tr><tr><td scope="row"><pre>                            result = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>                        }<span></span></pre></td></tr><tr><td scope="row"><pre>                    break;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            default:<span></span></pre></td></tr><tr><td scope="row"><pre>                    /* If nobody handled the event, it gets propagated to the */<span></span></pre></td></tr><tr><td scope="row"><pre>                    /* application-level handler. */<span></span></pre></td></tr><tr><td scope="row"><pre>                    break;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>	<p>As with the application-level handler, the window event handler first calls <code>GetEventKind</code> to determine the type of event and then processes them appropriately: </p><ul class="spaceabove"><li class="li"><p><a name="//apple_ref/doc/uid/TP30000991-CH205-DontLinkElementID_129"></a><code>kEventWindowDrawContent</code> indicates that the window contents must be redrawn. This event is similar to an update event in the Classic event model. However, if you have the standard window handler installed, the Carbon Event Manager automatically calls <code>BeginUpdate</code> and <code>EndUpdate</code> for this event; all you need to do is draw in the window. To avoid nesting update calls, you should remove the duplicate <code>BeginUpdate</code> and <code>EndUpdate</code> calls in the <code>DoUpdate</code> function. </p></li><li class="li"><p><code>kEventWindowBoundsChanged</code> indicates that the window size has changed (by clicking the zoom button). The handler calls <code>DoUpdate</code> to redraw the content region to reflect the new size. </p></li><li class="li"><p><code>kEventWindowClickContentRgn</code> indicates that the user has clicked in the Traffic window. To toggle the light setting, the handler calls <code>DoContentClick</code> as before, but because Sample no longer receives update events, the handler also calls <code>DoUpdate</code> to draw the new setting. Similarly, because Sample cannot update the Traffic menu settings by calling <code>AdjustMenus</code> from the <code>WaitNextEvent</code> loop, the handler calls it here. </p></li><li class="li"><p><code>kEventCommandProcess</code> indicates that a menu-related command occurred. Because this is the window handler, the handler processes only cases related to the Traffic window (that is, the Red Light/Green Light items in the Traffic menu). Other commands will end up being handled by the application-level handler. To change the traffic light setting, the handler first isolates the menu item selected from the event parameter and then redraws the light (using the same calls as in the <code>kEventWindowClickContentRgn</code> case).</p><p>If desired, instead of obtaining the menu item from the <code>commandStruct</code> structure, you can define and register constants for these items as you did for the About menu item. </p></li></ul><a name="//apple_ref/doc/uid/TP30000991-CH205-TPXREF127" title="Cleanup"></a><h4>Cleanup</h4><p>After adapting Sample to use Carbon events, you no longer need the following functions:</p><ul class="spaceabove"><li class="li"><p><code>EventLoop</code>: Replaced by the call to <code>RunApplicationEventLoop</code>.</p></li><li class="li"><p><code>DoEvent</code>: Replaced by the application and window event handlers. </p></li><li class="li"><p><code>MyGetGlobalMouse</code>: The application event handler now retrieves the mouse location from the event structure. </p></li><li class="li"><p><code>DoMenuCommand</code>: The handling of these events is split between the application and window event handlers. </p></li></ul>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../cpg_portexampstruct/cpg_portexamp_struct.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../cpg_apdx_func/cpg_apdx_funcs.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2002 Apple Computer, Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2002-12-01<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Carbon/Conceptual/carbon_porting_guide/cpg_newtechstruct/cpg_newtech_struct.html%3Fid%3DTP30000991-2.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Carbon/Conceptual/carbon_porting_guide/cpg_newtechstruct/cpg_newtech_struct.html%3Fid%3DTP30000991-2.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Carbon/Conceptual/carbon_porting_guide/cpg_newtechstruct/cpg_newtech_struct.html%3Fid%3DTP30000991-2.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>