<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>SnapshotSample - /SnapshotSample.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxCarbon-date.html">Carbon</a> &gt; <A HREF="javascript:location.replace('index.html');">SnapshotSample</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Carbon/idxInterapplicationCommunication-date.html" target="_blank">Carbon > Interapplication Communication</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">SnapshotSample</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/SnapshotSample.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/SnapshotSample.c</option></select>
				</p>
				</form>
				<p><strong><a href="SnapshotSample.zip">Download Sample</a></strong> (&#147;SnapshotSample.zip&#148;, 17.3K)<BR>
<strong><a href="SnapshotSample.dmg">Download Sample</a></strong> (&#147;SnapshotSample.dmg&#148;, 77.9K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*  File:    SnapshotSample.c  Contains:  Code for saving and restoring desktop icons.        This sample, when run the first time, creates a         snapshot file in the Preferences folder which contains a list         of the names and locations fo the items on the         desktop.          Running the sample again will read the snapshot        file and tell the Finder to position the items        at the locations read from the snapshot file.          Sample does not read/set location of Trash,        nor of mounted volumes.          Sample is provided as is... I didn't get much         chance to test beyond the standard, &quot;oh, this        works!&quot; stage.          The original Pascal version was written by        Quinn &quot;The Eskimo!&quot; and released as a Freeware        utility.  This DTS sample was created by        Deborah Grits.  This version was tidied up        and released by Quinn &quot;The Eskimo!&quot;.    Oh what a tangled web we weave...  Written by: Quinn &quot;The Eskimo!&quot;    Copyright:  Copyright &copy; 1996-1999 by Apple Computer, Inc., All Rights Reserved.        You may incorporate this Apple sample source code into your program(s) without        restriction. This Apple sample source code has been provided &quot;AS IS&quot; and the        responsibility for its operation is yours. You are not permitted to redistribute        this Apple sample source code as &quot;Apple sample source code&quot; after having made        changes. If you're going to re-distribute the source, we require that you make        it clear in the source that the code was descended from Apple sample source        code, but that you've made changes.  Change History (most recent first):        7/21/1999  Karl Groethe  Updated for Metrowerks Codewarror Pro 2.1        */  #include &lt;AppleEvents.h&gt;#include &lt;Errors.h&gt;#include &lt;Events.h&gt;#include &lt;Fonts.h&gt;#include &lt;Gestalt.h&gt;#include &lt;Memory.h&gt;#include &lt;Menus.h&gt;#include &lt;OSUtils.h&gt;#include &lt;QDOffscreen.h&gt;#include &lt;QuickDraw.h&gt;#include &lt;Resources.h&gt;#include &lt;Script.h&gt;#include &lt;ToolUtils.h&gt;#include &lt;Windows.h&gt;#include &lt;AEPackObject.h&gt;#include &lt;AERegistry.h&gt;#include &lt;AEObjects.h&gt;#include &lt;Folders.h&gt;#include &lt;TextEdit.h&gt;#include &lt;Dialogs.h&gt;//////////////////////////////////////////////////////////////////////////// Basic Utilitiesstatic OSErr FindProcessByTypeAndCreator(OSType typeToFind, OSType creatorToFind, ProcessSerialNumber *processSN)  // Runs through the process list looking for the indicated application.{    OSErr err;    ProcessInfoRec infoRecToFill;      err = noErr;    processSN-&gt;lowLongOfPSN = kNoProcess;    processSN-&gt;highLongOfPSN = kNoProcess;  infoRecToFill.processInfoLength = sizeof(ProcessInfoRec);  infoRecToFill.processName = nil;  infoRecToFill.processAppSpec = nil;    do {        err = GetNextProcess(processSN);        if (err == noErr) {            GetProcessInformation(processSN, &amp;infoRecToFill);        }    } while ((infoRecToFill.processSignature != creatorToFind || infoRecToFill.processType != typeToFind) ||                   err != noErr);        return(err);}//////////////////////////////////////////////////////////////////////////// Global Types// The snapshot file is made up of records of SnapRecord type.// An empty record (ie with name == &quot;&quot;) is used to indicate// the end of the file.typedef struct {  Str63 name;  Point loc;} SnapRecord, *SnapRecordPtr, **SnapRecordHandle;//////////////////////////////////////////////////////////////////////////// Global Variables// Used to tell the main event loop to quit.static Boolean gQuit = false;// An empty AppleEvent Descriptor.const static AEDesc gNullDesc = {typeNull, nil};//////////////////////////////////////////////////////////////////////////// Restoring Snapshotsstatic OSErr SetItemPosition(Str255 fname, Point dest, AEDesc *setDataEvent)  // Sends an AppleEvent to the targetDesc (which should target the Finder)  //  to set the position of the item whose name is fname to the position dest.{  OSErr    err;  AEDesc    fileNameDesc     = gNullDesc;  AEDesc    rootDesc       = gNullDesc;  AEDesc    propertyDescriptor   = gNullDesc;  AEDesc    objParentDesc     = gNullDesc;  AEDesc    objDesc       = gNullDesc;  AEDesc    reply         = gNullDesc;  AEDesc    newData       = gNullDesc;  DescType  procDescData     = 'posn';  err = AECreateDesc(typeChar, &amp;fname[1], fname[0], &amp;fileNameDesc);      // Create objParentDesc to specify the parent object, ie item &quot;xxxx&quot; of application  if (err == noErr) {    err = CreateObjSpecifier(cObject, &amp;rootDesc, formName, &amp;fileNameDesc, false, &amp;objParentDesc);  }  // Create propertyDescriptor to hold the property specifier, ie position  if (err == noErr) {    err = AECreateDesc(typeType, &amp;procDescData, sizeof(procDescData), &amp;propertyDescriptor);  }    // Create objDesc to reference the data to set, ie position of item &quot;xxx&quot; of application  if (err == noErr) {    err = CreateObjSpecifier(cProperty, &amp;objParentDesc, formPropertyID, &amp;propertyDescriptor, false, &amp;objDesc);  }  // Create on descriptor to hold the new data, ie the new icon position.  if (err == noErr) {    err = AECreateDesc(typeQDPoint, (void*)&amp;dest, sizeof(dest), &amp;newData);  }  // Fill out the parameters, putting the objDesc into the direct object and the new data  //  into the data parameter.  if (err == noErr) {    err = AEPutParamDesc(setDataEvent, keyDirectObject, &amp;objDesc);  }  if (err == noErr) {    err = AEPutParamDesc(setDataEvent, keyAEData, &amp;newData);  }  // Send the event.  if (err == noErr) {    err = AESend(setDataEvent, &amp;reply, kAEWaitReply, kAENormalPriority, kAEDefaultTimeout, nil, nil);        // Some code that I enable when I'm debugging.        if (false) {      long errNum;      Str255      errStr;      DescType  junkType;      Size    realSize;            err = AEGetParamPtr(&amp;reply, keyErrorNumber, typeInteger, &amp;junkType, &amp;errNum, sizeof(errNum), &amp;realSize);      err = AEGetParamPtr(&amp;reply, keyErrorString, typeChar, &amp;junkType, &amp;errStr[1], 255, &amp;realSize);      errStr[0] = realSize;    }  }  // Clean up all those messy descriptors.  Don't you just love AppleEvents (-:  AEDisposeDesc(&amp;rootDesc);  AEDisposeDesc(&amp;fileNameDesc);  AEDisposeDesc(&amp;objParentDesc);  AEDisposeDesc(&amp;propertyDescriptor);  AEDisposeDesc(&amp;objDesc);  AEDisposeDesc(&amp;newData);  AEDisposeDesc(&amp;reply);    return err;}static OSErr RestoreSnapshot (FSSpec snapFss)  // Restore the snapshot file specified by snapFss.{  OSErr        err;  ProcessSerialNumber finderPSN;  AEDesc        targetDesc     = gNullDesc;  AEDesc        setDataEvent   = gNullDesc;  short        snapFileRef;  Boolean       done;  SnapRecord      aSnapRecord;  long        byteCount;  snapFileRef = 0;    // Find the Finder's ProcessSerialNumber and create the targetDesc for it.  err = FindProcessByTypeAndCreator('FNDR', 'MACS', &amp;finderPSN);  if (err == noErr) {    err = AECreateDesc(typeProcessSerialNumber, (Ptr)&amp;finderPSN, sizeof(finderPSN), &amp;targetDesc);  }  // Create the AppleEvent.  if (err == noErr) {      err = AECreateAppleEvent(kAECoreSuite, kAESetData, &amp;targetDesc,                                kAutoGenerateReturnID, kAnyTransactionID, &amp;setDataEvent);  }      // Open the file.  if (err == noErr) {    err = FSpOpenDF(&amp;snapFss, fsRdPerm, &amp;snapFileRef);  }  if (err == noErr) {        // Read the records in the file, repositioning the icons as we go.    done = false;    do {      byteCount = sizeof(SnapRecord);      err = FSRead(snapFileRef, &amp;byteCount, (void*) &amp;aSnapRecord);            if (err == noErr) {        // We're done if we hit the empty string.        done = (aSnapRecord.name[0] == 0);                if (!done) {          // Reposition the icon.          err = SetItemPosition(aSnapRecord.name, aSnapRecord.loc, &amp;setDataEvent);        }      }    } while (!done);  }    if (err == eofErr) {    err = noErr;  }  // clean up  if (snapFileRef != 0) {    (void) FSClose(snapFileRef);  }  AEDisposeDesc(&amp;setDataEvent);  AEDisposeDesc(&amp;targetDesc);      return err;}//////////////////////////////////////////////////////////////////////////// Creating Snapshotsstatic OSErr WriteFileRecord(short snapFileRef, Str63 itemName, Point itemPosition)  // Add a new record to the snapshot file.{  OSErr    err;  SnapRecord  aSnapRecord;  long    byteCount;    BlockMoveData(itemName, aSnapRecord.name, sizeof(aSnapRecord.name));  aSnapRecord.loc = itemPosition;    byteCount = sizeof(SnapRecord);  err = FSWrite(snapFileRef, &amp;byteCount, (void*) &amp;aSnapRecord);    return err;}static OSErr CreateSnapshotFile(FSSpec snapFss)  // Add the positions for the icons on the desktop to the snapshot file snapFss.{  OSErr     err;  short    snapFileRef;  short    deskVRefNum;  long    deskDirID;  CInfoPBRec  pb;  short    fileIndex;  Point    folderOrigin;  Point    itemPosition;  Str63    itemName;  UInt32    systemVersion;  snapFileRef = 0;    // Find the desktop folder.  err = FindFolder(kOnSystemDisk, kDesktopFolderType, true, &amp;deskVRefNum, &amp;deskDirID);    // Get the origin for the desktop folder.  pb.dirInfo.ioNamePtr = nil;  pb.dirInfo.ioDrDirID = deskDirID;  pb.dirInfo.ioVRefNum = deskVRefNum;  pb.dirInfo.ioFDirIndex = -1;    // get information about ioDirID  err = PBGetCatInfoSync(&amp;pb);  if (err == noErr) {    folderOrigin.h = 0;    folderOrigin.v = 0;    if (Gestalt(gestaltSystemVersion, (long *) &amp;systemVersion) != noErr || systemVersion &lt; 0x0800) {      // Evil fudge factor is needed for Finder 7.x.  Finder 8.0 does not fudge.      folderOrigin.v = folderOrigin.v - 20;    }  }  // Open up the snapshot file.  if (err == noErr) {    err = FSpOpenDF(&amp;snapFss, fsRdWrPerm, &amp;snapFileRef);  }  // Loop through each file in the folder, adding it to the snapshot file.  if (err == noErr) {    fileIndex = 1;    do {        pb.dirInfo.ioNamePtr = (StringPtr) itemName;        pb.dirInfo.ioDrDirID = deskDirID;        pb.dirInfo.ioVRefNum = deskVRefNum;        pb.dirInfo.ioFDirIndex = fileIndex;        err = PBGetCatInfoSync(&amp;pb);        if (err == noErr) {          itemPosition = pb.hFileInfo.ioFlFndrInfo.fdLocation;          SubPt(folderOrigin, &amp;itemPosition);          err = WriteFileRecord(snapFileRef, itemName, itemPosition);        }        fileIndex += 1;    } while (err == noErr);        // Write the sentinel to the end of the file.    if (err == fnfErr) {      itemName[0] = 0;      itemPosition.h = 0;      itemPosition.v = 0;      err = WriteFileRecord(snapFileRef, itemName, itemPosition);    }  }      // Clean up.  if (snapFileRef != 0) {    (void) FSClose(snapFileRef);  }      return err;}//////////////////////////////////////////////////////////////////////////// Main Linestatic void InitToolbox()  // Standard Macintosh toolbox init.{  InitGraf(&amp;qd.thePort);  InitFonts();  InitWindows();  InitMenus();  TEInit();  InitDialogs(nil);  MaxApplZone();    MoreMasters();  MoreMasters();  MoreMasters();  InitCursor();  FlushEvents(0, everyEvent);  }void main(void)  // The application's main entry point.{  OSErr   err;  FSSpec  snapFss;  long  gestaltResponse;  // First, a quick check to make sure we have Scriptable Finder.  If we don't  //  we bail quickly.    if ((Gestalt(gestaltFinderAttr, &amp;gestaltResponse) != noErr) || ((gestaltResponse &amp; (1 &lt;&lt; gestaltOSLCompliantFinder)) == 0)) {    DebugStr(&quot;\pWhoops, no Scriptable Finder.&quot;);    ExitToShell();  }  // Now bring up the standard Mac toolbox.  InitToolbox();    // Find the Preferences folder.  err = FindFolder(kOnSystemDisk, kPreferencesFolderType, false, &amp;(snapFss.vRefNum), &amp;(snapFss.parID));  if (err == noErr) {    // Open the snapshot file in the Preferences folder.    //  Should get this from a resource, of course.        (void) FSMakeFSSpec(snapFss.vRefNum, snapFss.parID, &quot;\pDesktop Snap&quot;, &amp;snapFss);    err = FSpCreate(&amp;snapFss, 'FR&iquest;G', 'FR&iquest;G', 0);        if (err == dupFNErr) {              // If we already have a snapshot file,      err = RestoreSnapshot(snapFss);        //  restore icon positions,    } else if (err == noErr) {            // otherwise make a snapshot file.      // Create the snapshot file for the desktop      err = CreateSnapshotFile(snapFss);    }  }    if (err != noErr) {    DebugStr(&quot;\pSnapshotter failed.&quot;);  }}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/SnapshotSample/listing1.html%3Fid%3DDTS10000214-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/SnapshotSample/listing1.html%3Fid%3DDTS10000214-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/SnapshotSample/listing1.html%3Fid%3DDTS10000214-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>