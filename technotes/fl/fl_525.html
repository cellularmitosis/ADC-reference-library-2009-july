<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-August-01 --><!-- Includes revisions to graphics tags --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note FL525: Standard File Package Q&amp;As</title><meta name="keywords" content="Mac OS 7 Standard File invisible Package SFGetFile SFPPutFile SFPGetFile"><meta name="Description" content="Technical Note FL525: This Technical Note contains a collectionof archived Q&amp;As relating to the Standard File Package--questionssent the Developer Support Center (DSC) along with answersfrom the DSC engineers. Archived Q&amp;As touch on such topicsas: The Standard File Package Defaults; File Handling withinSFPGetFile and SFPPutFile DlgHook functions; Working aroundStandard file quirk that occurs when the System Heap is full;Custom Standard File dialog Edit fields; Displaying invisiblefiles under System 7; and How to control the path used bySFGetFile.">                                       <meta name="categories" content="Files"><meta name="week-posted" content="Oct 1, 1990 - Oct 5, 1990"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002468" title="Standard File Package Q&As"></a><A NAME="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxUserExperience-date.html">User Experience</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/UserExperience/index.html" target="_blank">Reference Library > User Experience</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note FL525</div>
<div id="pageheadsub">Standard File Package Q&amp;As</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Section1">Standard File Package directory defaults<BR><BR></a><A HREF="#Section2">Dialog filter control with subdialog boxes<BR><BR></a><A HREF="#Section3">Working around Standard File quirk when system heap is full<BR><BR></a><A HREF="#Section4">Custom Standard File dialog edit fields under System 7<BR><BR></a><A HREF="#Section5">Displaying invisible files under Systems 6 &amp; 7 without typeList<BR><BR></a><A HREF="#Section6">Standard File and nontrashable Macintosh folders<BR><BR></a><A HREF="#Section7">How to override System 7.0 Standard File dialog centering<BR><BR></a><A HREF="#Section8">Tabbing between SFPPutFile custom dialog text fields<BR><BR></a><A HREF="#Section9">Filtering out invisible folders from a Standard File dialog list<BR><BR></a><A HREF="#Section10">File handling within SFPGetFile &amp; SFPPutFile DlgHook functions<BR><BR></a><A HREF="#Section11">What to do instead of nested SFPGetFile calls<BR><BR></a><A HREF="#Section12">Working directory not necessary for new Macintosh applications<BR><BR></a><A HREF="#Section13">How to control path used by SFGetFile<BR><BR></a><A HREF="#Section14">Saving correct Macintosh "user file last used" information   <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id ="introtext">This Technical Note contains a collection of archived Q&amp;As relating to a specific topic--questions sent the Developer Support Center (DSC) along withanswers from the DSC engineers. Current Q&amp;As can be found on the <a href="../../qa/index.html">Macintosh Technical Q&amp;As web site</a>.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Oct 01 1990]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR><!-- begin_content --><a name="Section1"></a><h2>Standard File Package directory defaults</h2><p>Date Written:  1/22/93</p><p>Last reviewed: 6/14/93</p><p>When I double-click a document that launches my application, the currentdirectory for the Standard File package (at location $398 in memory) is set tothe directory of my application and not my document. This seems to be a bugaccording to the text on page 3-31 of the new <i><cite>Inside Macintosh: Files</cite></i>manual. Is there anything special I have to do?</p><p>___</p><p>You're right. The behavior described in <i><cite>Inside Macintosh: Files</cite></i> isn'tentirely correct. It should say that the first time your application calls oneof the Standard File Package routines, the default current directory (that is,the directory whose contents are listed in the dialog box) is determined by theway your application was launched.</p><p>* If the user launched your application directly (perhaps by double-clickingits icon in the Finder), the default directory is the directory in which yourapplication is located.</p><p>* If the user launched your application indirectly (perhaps by double-clickingone of your application's document icons) and your application is passed Finderinformation, the default directory is the directory of the last document listedin the Finder information. The Finder information is the data referenced by<code>AppParmHandle</code> and accessed by the Segment Loader routines <code>CountAppFiles</code>,<code>GetAppFiles</code>, <code>ClrAppFiles</code>, and <code>GetAppParms</code>.</p><p>Note that applications that are high-level event aware are passed the list ofdocuments to open or print in a <code>kAEOpenDocument</code> or <code>kAEPrintDocument</code> Appleevent. There's no Finder information (<code>AppParmHandle</code> will be NIL) and thedefault directory is the directory in which your application is located.</p><a name="Section2"></a><P><A HREF="#top">Back to top</A></P><h2>Dialog filter control with subdialog boxes</h2><p>Date Written:  12/10/92</p><p>Last reviewed:  6/14/93</p><p>My routine uses a dialog hook to set and retrieve certain values in new itemsadded to the default box. Previously, with <code>SFPPutFile</code>, I was able to use a hiton the Save item to retrieve and save the values. This also works with<code>CustomPutFile</code> unless the Replace/Cancel dialog box appears, because the dialoghook routines are also called for it! With the dialog pointer now pointing atthe small alert, any reference to expected items leads to disaster, since theydon't exist. Isn't calling the dialog hook routine to respond to hits in thealert box wrong and therefore a bug?</p><p>___</p><p>Both Standard File and the Edition Manager in System 7 allow you to havecontrol in your filter when one of the subdialog boxes comes up. You candifferentiate between the main dialog and the subdialogs by looking in therefCon field of the dialog record passed to you. In Standard File's case, ifthe dialog is the main dialog, the refCon will be:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>/* From StandardFile.h *//* The refCon field of the dialog record during a modalfilter/* or dialoghook contains one of the following: */#define sfMainDialogRefCon 'stdf'#define sfNewFolderDialogRefCon 'nfdr'#define sfReplaceDialogRefCon 'rplc'#define sfStatWarnDialogRefCon 'stat'#define sfLockWarnDialogRefCon 'lock'#define sfErrorDialogRefCon 'err '</pre>	</TD></TR></TABLE></CENTER><p>This is described in detail on page 26-18 of <i>Inside Macintosh</i> Volume VI,in the middle of the section that describes all the callbacks and pseudo itemsfor Standard File under System 7. The main purpose of this is to allow youradditional dialog items to react properly when another dialog box is brought upin front of them, not to allow you access to the subdialogs. Also, sinceStandard File has no idea what types of items you've added to the dialogs,giving you control during subdialogs allows you to change the look of yoursubitems, or to keep them active if they need periodic time for any reason.</p><a name="Section3"></a><P><A HREF="#top">Back to top</A></P><h2>Working around Standard File quirk when system heap is full</h2><p>Date Written:  12/4/91</p><p>Last reviewed:  6/14/93</p><p>Standard File can fail to function properly when the system heap is very full;it just returns false in the reply.good field. This is a serious problem for usbecause we are unable to detect this situation; to our application, it justlooks like the user clicked the Cancel button. Do you have any suggestions forworking around this?</p><p>___</p><p>This is a significant problem, but we can't guarantee that the software willperform in any imaginable set of circumstances you want to set up. You're goingto have to check to see if it will be able to work (preflight it) and then seeif it fails. In virtually all such failure cases, the low-memory globals <code>MemErr</code>or <code>ResErr</code> will be set with an error, as tested with the functions <code>MemError()</code> or <code>ResError()</code>. You might also attempt to allocate an amount of memory in the system heap, and if that allocation fails, inform the user that "Save As..." might fail, indicating possible solutions (such as turning off balloon help, etc). To preflight for about 50-60K in the system heap would probably be adequate.</p><a name="Section4"></a><P><A HREF="#top">Back to top</A></P><h2>Custom Standard File dialog edit fields under System 7</h2><p>Date Written:  8/14/91</p><p>Last reviewed:  6/14/93</p><p>How do I change the active edit field inside a custom Standard File dialogunder System 7? In a related problem I am finding that the selection range forall edit fields in the dialog equals the number of characters in the file namefield when tabbing around.</p><p>___</p><p>The Standard File Package (SFP) routines don't behave exactly the same as theydid under System 6. Therefore, doing something like trying to change the activeitem number doesn't work under System 7's version of the SFP routines. Theproblem is that System 7 Standard File has a whole set of interfaces dedicatedto the active item list and which item is currently active, whereas System 6 SFroutines just use the dialog data to store this information. The solution tothe problem, then, is to use <code>CustomGetFile</code> to accomplish the same thing if youare running under System 7. I've included a sample program which uses the newroutine to change the focus and check the bounds of several editText items.</p><p>Your second problem is brought on by a bug in Standard File. The workaround isto install an activate procedure for Standard File (it's a parameter to theCustomGetFile call) which calls SelIText on the appropriate field to select theentire range. The included sample also does this.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>/*    CustomGetFile example    This sample uses CustomGetFile to add two edit text fields    to the standard get file box, and checks the values the user    enters into those fields. If the values are incorrect, the    user is alerted to change them, and the focus of the dialog    is changed to the proper field.    The standard file bug causing selection ranges to be calculated    improperly is also fixed in this sample by calling SelIText in    the activate procedure for edit text items.*//* prototypes */void InitStuff(void);void CustomGet(void);pascal void MyActProc(DialogPtr theDlg,short item,                      Boolean activating, Ptr data);pascal short DlgHook(short item,DialogPtr theDlg,Ptr userData);Boolean CheckField(DialogPtr theDlg,short item);/* constants */#define    kTextField1    10#define    kTextField2    11#define    kSFDlg        128#define    kAlertDlg     129void main(void){    InitStuff();    CustomGet();}/* initialize managers */void InitStuff(void){    InitGraf(&amp;qd.thePort);    InitFonts();    InitWindows();    InitMenus();    TEInit();    InitDialogs(nil);    FlushEvents(everyEvent,0);    InitCursor();}/* do getfile */void CustomGet(void){    Point where = {-1,-1};    SFReply reply;    DialogPtr theDialog;    short item;    StandardFileReply sfReply;    short activeList[5];    /* set-up active items list */    activeList[0] = 3;    activeList[1] = 7;    activeList[2] = 10;    activeList[3] = 11;    CustomGetFile(nil,-1,nil,&amp;sfReply,kSFDlg,where,DlgHook,                  nil,activeList,MyActProc,nil);}/*  activate procedure- this procedure handles the activate/deactivate of    textedit items and corrects the selection bug in standard file which    normally causes the selStart and selEnd fields of the texthandle to be    incorrect*/pascal void MyActProc(DialogPtr theDlg,short item,Boolean activating,Ptr data){    short iType;    Handle iHndl;    Rect iRect;    TEHandle textH;    GetDItem(theDlg,item,&amp;iType,&amp;iHndl,&amp;iRect);    if (iType != editText)        return;    if (activating) {        SelIText(theDlg,item,0,32000);        return;    }}/*  this dialog hook checks the contents of the additional edit fields    when the user selects a file. The focus of the dialog is changed if one    of the fields is out of range.*/pascal short DlgHook(short item,DialogPtr theDlg,Ptr userData){    if (item==ok) {        if (!CheckField(theDlg,kTextField1))            item = kTextField1 + sfHookSetActiveOffset;        else if (!CheckField(theDlg,kTextField2))            item = kTextField2 + sfHookSetActiveOffset;    }    return item;}/*  this procedure checks the range of a given edittext item to make sure it    contains a number from 0 to 256. If not, it alerts the user that the    field must be re-entered.*/Boolean CheckField(DialogPtr theDlg,short item){    short iType;    Handle iHndl;    Rect iRect;    Str255 iText;    long num;    GetDItem(theDlg,item,&amp;iType,&amp;iHndl,&amp;iRect);    GetIText(iHndl,iText);    StringToNum(iText,&amp;num);    if (num&lt;0 || num&gt;256 || iText[0]==0) {        StopAlert(kAlertDlg,nil);        return false;    }    else        return true;}The resource file follows:/*    Dialog and Alert templates for use with CustomGetFile example.    Steve Falkenburg -- MacDTS*/#include "types.r"/* CustomGetFile dialog */resource 'DLOG' (128, purgeable) {    {0, 0, 206, 344},    dBoxProc,    invisible,    noGoAway,    0x0,    128,    ""};resource 'DITL' (128, purgeable) {    {    /* array DITLarray: 11 elements */        /* [1] */        {135, 252, 155, 332}, Button { enabled, "Open" },        /* [2] */        {104, 252, 124, 332}, Button { enabled, "Cancel" },        /* [3] */        {0, 0, 0, 0}, HelpItem { disabled,            HMScanhdlg {                -6042            }        },        /* [4] */        {8, 235, 24, 337}, UserItem { enabled },        /* [5] */        {32, 252, 52, 332}, Button { enabled, "Eject" },        /* [6] */        {60, 252, 80, 332}, Button { enabled, "Desktop" },        /* [7] */        {29, 12, 159, 230}, UserItem { enabled },        /* [8] */        {6, 12, 25, 230}, UserItem { enabled },        /* [9] */        {91, 251, 92, 333}, Picture { disabled, 11 },        /* [10] */        {175, 16, 191, 91}, EditText { enabled, "" },        /* [11] */        {175, 106, 191, 181}, EditText { enabled, "" }    }};/* input check value alert */resource 'ALRT' (129) {    {110, 130, 208, 414},    129,    {    /* array: 4 elements */        /* [1] */        OK, visible, sound1,        /* [2] */        OK, visible, sound1,        /* [3] */        OK, visible, sound1,        /* [4] */        OK, visible, sound1    }};resource 'DITL' (129) {    {    /* array DITLarray: 2 elements */        /* [1] */        {68, 218, 88, 276},Button {enabled,"OK"},        /* [2] */        {10, 61, 62, 278},        StaticText { disabled,            "Your field entry is out of range.  Pleas"            "e enter a number between 0 and 256."        }    }};</pre>	</TD></TR></TABLE></CENTER><a name="Section5"></a><P><A HREF="#top">Back to top</A></P><h2>Displaying invisible files under Systems 6 &amp; 7 without typeList</h2><p>Date Written:  8/9/91</p><p>Last reviewed:  6/14/93</p><p>Under System 7 my filter procedure for displaying invisible data files nolonger works. How can I use Standard File to display the names of invisiblefiles of a specific type under System 7?</p><p>___</p><p>System 7 can show invisible files in the standard <code>SFGetFile</code> dialog box;however, not all System 6 Standard File package calls are handled the same in System 7.</p><p>When using invisible files under System 7, you should perform type filteringwithin a filter proc and not with the <code>typeList</code> field of the <code>SFGetFile</code> call.System 7 no longer allows a <code>typeList</code> for detecting invisible files. The actualcheck for invisible files of a particular type or types should be done withinthe file filter proc.</p><p>The <code>SFGetFile</code> call below displays only folders and invisible 'TEXT' files inthe standard <code>SFGetFile</code> dialog box. With the <code>numTypes</code> parameter set to -1, alltypes of files will be passed to the filter proc.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>SFGetFile( where, "", myFilterProc, -1, typeList, nil, &amp;reply );</pre>	</TD></TR></TABLE></CENTER><p>In this example, the filter proc's return value depends on the file's type and Finder flags.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>pascal Boolean myFilterProc( fp )FileParam *fp;{  if ((fp-&gt;ioFlFndrInfo.fdFlags &amp; fInvisible) &amp;&amp;      (fp-&gt;ioFlFndrInfo.fdType == 'TEXT'))    return FALSE;  else    return TRUE;}</pre>	</TD></TR></TABLE></CENTER><a name="Section6"></a><P><A HREF="#top">Back to top</A></P><h2>Standard File and nontrashable Macintosh folders</h2><p>Date Written:  7/24/91</p><p>Last reviewed:  6/14/93</p><p>When we use Standard File to get a Macintosh file in a folder, it becomesimpossible to throw that folder away and empty the trash without quittingfirst. Is this because the working directory is still open? It is myunderstanding that applications shouldn't close working directories that wereopened by Standard File. Is there something I should be doing, or is this justa limitation in the system?</p><p>___</p><p>Pre-System 7 Standard File calls (SFGetFile/SFPutFile/etc...) call PBOpenWD toopen a working directory to the folder where the selected file resides.</p><p>This working directory, along with all others created within any application,are closed by MultiFinder (or the Process Manager under System 7) when theapplication is quit. Before the application quits, you will not be able tothrow away the folder. After quitting, however, the directory is closed and thefolder can be trashed.</p><p>As described in the Macintosh Technical Note <u><A HREF = "fl_14.html">"Working Directories and MultiFinder,"</a></u> this is accomplished in the following way: When Standard File calls <code>PBOpenWD()</code>, the <code>ioWDProcID</code> field is ignored, and MultiFinder replaces its contents with a unique process identifier. When your application quits, MultiFinder indexes through all open working directories with your unique process ID and closes them.</p><p>Your understanding is correct that you don't have to close these Standard Fileworking directories yourself. If, however, you want the user to be able todelete the directory <i>while</i> your application is still running, you willhave to issue a <code>PBCloseWD()</code> call yourself, as in the following example:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    WDPBRec theWD;    Point where = {100,100};    SFGetFile ( where, nil, nil, -1, nil, nil, &amp;reply );    &lt;do file stuff here&gt;    theWD.ioVRefNum = reply.vRefNum;    err = PBCloseWD(&amp;theWD,false);</pre>	</TD></TR></TABLE></CENTER><p>If you're running under System 7, you are much better off using the new<code>StandardGetFile()</code> and <code>StandardPutFile()</code> routines. They do not use workingdirectories at all, and instead return <code>FSSpecs</code> to refer to files.</p><p>If none of the above helps, your problem may be that you have left a file openin the directory the user is trying to delete. This would cause the same erroras the one you described.</p><a name="Section7"></a><P><A HREF="#top">Back to top</A></P><h2>How to override System 7.0 Standard File dialog centering</h2><p>Date Written:  6/19/91</p><p>Last reviewed:  8/1/92</p><p>Any way to override the new default screen location (upper-middle) for StandardFile calls under System 7.0? My Standard File dialog needs to be somewhere elseon the screen.</p><p>___</p><p>You can use the <code>CustomGetFile</code> <i>(Inside Macintosh</i> Volume VI, page 26-22)and <code>CustomPutFile</code> <i>(Inside Macintosh</i> Volume VI, page 26-20) to place therelated Standard File dialogs in the location you specify as a parameter. Thisshould override the centering feature that System 7.0 uses on the StandardGetFile <i>(Inside Macintosh</i> Volume VI, page 26-22) and StandardPutFile <i>(Inside Macintosh</i> Volume VI, page 26-20) calls.</p><a name="Section8"></a><P><A HREF="#top">Back to top</A></P><h2>Tabbing between SFPPutFile custom dialog text fields</h2><p>Date Written:  6/7/91</p><p>Last reviewed:  8/1/92</p><p>How can I get the tab key to tab between text fields in my SFPPutFile customdialog instead of switching drives?</p><p>___</p><p>Here is an event filter that beeps whenever the tab key is pressed (under System 6):</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>pascal Boolean MyDlgFilter(DialogPtr theDialog,EventRecord *theEvent,short*itemHit){    WindowPtr updateWindow;    char theChar;    switch (theEvent-&gt;what) {        case keyDown:        case autoKey:            theChar = theEvent-&gt;message &amp; charCodeMask;            switch (theChar) {                case 0x0d:    /* CR */                case 0x03:  /* enter */                    *itemHit = OK;                    return true;                case 0x1b:  /* ESC */                    *itemHit = Cancel;                    return true;                case '\t':                    SysBeep(1); //   &lt;----- do your "tabbing" here                    *itemHit = 0; //   &lt;----- this is what you need toadd                    return true;            }            break;    }    return false;}</pre>	</TD></TR></TABLE></CENTER><p>Within dialog event filters, when the filter decides to process the event, thefilter not only must return true, but must also return the item number acted onby the filter. Under System 7, tab is handled by the system automatically andis not controllable from dialog event filters.</p><a name="Section9"></a><P><A HREF="#top">Back to top</A></P><h2>Filtering out invisible folders from a Standard File dialog list</h2><p>Date Written:  6/10/91</p><p>Last reviewed:  6/14/93</p><p>I want to display only visible files and folders in a Standard File dialog, butI can't find a way to filter out invisible folders--specifically the 000Move&amp;Rename folder. The <code>FileFilter</code> routine filters only files, not folders. If I put in a nonzero <code>TypeList</code>, invisible folders seem to be removed, but I want to open all types of files, just not invisible files or folders. Any suggestions?</p><p>___</p><p>This is, in fact, impossible under System 6 using general methods. The problemis that passing -1 as numTypes means not only to display all items, but todisplay invisible items. A file filter can be used to remove the invisiblefiles but cannot affect invisible folders. The only current way to do this isto use CustomGetFile under System 7, as described in the Standard File Packagechapter of <i>Inside Macintosh</i> Volume VI. This provides a filter thatallows you to filter both files and folders. This will give you the rightfunctionality, but will work only under System 7. We recommend that you usethis method under System 7, and a more standard SFGetFile when running underearlier systems.</p><a name="Section10"></a><P><A HREF="#top">Back to top</A></P><h2>File handling within SFPGetFile &amp; SFPPutFile DlgHook functions</h2><p>Date Written:  4/2/91</p><p>Last reviewed:  8/1/92</p><p>How can I obtain the volume reference information in my DlgHook function for afile selected by the user before SFPPutFile or SFPGetFile has completed thereply record?</p><p>___</p><p>On exit, <code>SFPGetFile</code> and <code>SFPPutFile</code> generate a working directory referencenumber in the <code>vRefNum</code> field of the reply record. This is not available to youfrom within the operation of a <code>DlgHook</code> function. <code>WDRefNums</code> are provided toallow compatibility with older, pre-HFS functions that took <code>vRefNum</code> values ofinteger size with the older flat file system.</p><p>We suggest that, unless you plan to support the flat file system of 64K ROMMacintosh systems, you move your file system interfaces to the HFS interfacesdocumented in the File Manager sections of <i>Inside Macintosh</i> Volumes IVand V (or to the equivalent high-level calls as documented in the MacintoshTechnical Note "New High-Level File Manager Calls"). If you're using the HFScalls, low-memory globals <code>SFSaveDisk</code> and <code>CurDirStore</code> contain, respectively, thenegative of the "real" volume reference number for the current volume and theHFS ID of the directory that Standard File is displaying. You then have all theinformation you need to create, open, rename, or delete files from within the<code>SFPGetFile</code> and <code>SFPPutFile</code> <code>DlgHook</code> functions. If a user is accessing an MFSvolume on an HFS system, these calls are designed tohandle file accesstransparently.</p><p>Moving your file system interfaces to the HFS-level conventions has a sidebenefit of being closer to the System 7 file system specifications. If you lookat the new high-level file system calls in <i>Inside Macintosh</i> Volume VI,you'll recognize much of the HFS information embedded in the new data structures.</p><p>If your file system interfaces depend on MFS-style <code>vRefNums</code>, or <code>WDRefNums</code> inthe HFS nomenclature, you can use the HFS functions <code>PBOpenWD</code>, <code>PBCloseWD</code>, and<code>PBGetWDInfo</code> to open, close, and obtain volume reference numbers and directoryIDs. This is particularly important if, for instance, you're using the THINK CANSI file I/O functions, which rely on SetVol to operate correctly.</p><p>Complete information on the HFS-level calls that will be most useful inStandard File customization is contained in the File Manager chapters of<i>Inside Macintosh</i> Volumes IV and V, and in the Macintosh Technical Notes<u><A HREF = "fl_35.html">"Determining Which File System Is Active,"</a></u><u><A HREF = "fl_22.html">"HFS Ruminations,"</a></u><u><A HREF = "fl_06.html">"HFS Elucidations,"</a></u> <u><A HREF = "fl_11.html">"Why PBHSetVol is Dangerous,"</a></u> <u><A HREF = "fl_23.html">"Setting ioNamePtr in File Manager Calls,"</a></u> and <u><A HREF = "fl_14.html">"Working Directories and MultiFinder."</a></u> For C users, the Macintosh Technical Note <u><A HREF = "fl_27.html">"Mixing HFS and C File I/O"</a></u>summarizes a list of the difficulties with mixing C file I/O with Macintosh file I/O. Macintosh Technical Notes <u><A HREF = "fl_33.html">"Customizing Standard File"</a></u> and <u><A HREF = "fl_12.html">"Standard File Tips"</a></u> discuss a few points of Standard File customization from the point ofview of HFS.</p><a name="Section11"></a><P><A HREF="#top">Back to top</A></P><h2>What to do instead of nested SFPGetFile calls</h2><p>Date Written:  1/14/90</p><p>Last reviewed:  2/6/91</p><p>I am nesting two Macintosh <code>SFPGetFile</code> dialogs through custom routines. Undersome circumstances after I call up the second <code>SFPGetFile</code> dialog and return(usually via Cancel) to the first one, I lose all of the custom controls in thefirst <code>SFPGetFile</code> dialog.</p><p>___</p><p>The SF package is not re-entrant, so there isn't really a way to do what youwant here. MOST of the information is kept around when you nest calls, but themain problem is in the resources SF uses for the items. When the nested SFdialog closes (on a cancel, for example) it releases the resources thatStandard File is using. Unfortunately, this also releases the resources thatare being used by the original dialog, so that's where your items are gettingmessed up. And while there is potentially a workaround by doing some kludgystuff, I can guarantee that anything I tell you now will be completely wrongunder System 7.0, so I can't do that. However, you can use sequential calls,instead of nested. This is a little more of a pain, but it'll work.</p><p>Call <code>SFPGetFile</code>. In your filter routine, when the user hits the control thatyou want to bring up the nested box, set a flag in your application saying"bringUpOther," and tell Standard File that you're done by passing item 1 or 2back. You return, put up your second <code>SFPGet</code>, process that info, then bring theoriginal <code>SFPget</code> back. I realize that this is not what you're looking for, sinceit'll be a little messy as the dialogs open and close, but it's the only way todo it with any chance of success on more than one system.</p><a name="Section12"></a><P><A HREF="#top">Back to top</A></P><h2>Working directory not necessary for new Macintosh applications</h2><p>Date Written:  12/12/90</p><p>Last reviewed:  8/1/92</p><p>Why does closing the working directory also close it for other users?</p><p>___</p><p>It is not necessary to use "Working Directories." When the Macintosh first cameout there was no notion of directories. MFS was a flat file system; all fileswere stored in a single directory. Hence, all of the original applicationsspecified a file by its name and the volume it was on. In other words, avRefNum and a fileName.</p><p>The Hierarchical File System (HFS) introduced the concept of directories to the Macintosh. This meant that applications now had to specify a directory ID alongwith the <code>vRefNum</code> and fileName. The problem then was that old (pre- HFS) applications had to be able to work with directories other than the root. That was accomplished by having the File System create fake <code>vRefNums</code> that represent both a real <code>vRefNum</code> and a dirID. These fake <code>vRefNums</code> are called working directories and span a special number range (less than -32000). When the file system notices a <code>vRefNum</code> in that range, it interprets it as a working directory. Using a look-up table it matches it to a real vRefNum and dirID. This allows old applications to work with sub-directories. Essentially, older applications treat each directory as a distinct volume.</p><p>In other words, working directories are for providing compatibility within thefile system for old (pre-HFS) applications. New applications and XCMDsshouldn't be creating or using them. Standard File still returns workingdirectories, and you can use those, but it is recommended to convert them intoreal <code>vRefNum/DirID</code> pairs as soon as <code>SFGet/PutFile</code> returns.</p><p>But what if you do use working directories? Under MultiFinder, the ioWDProcIDfield is filled in with the process ID that MultiFinder creates when it launches a new application. When you create a working directory, an entry is created for each <code>vRefNum/dirID/procID</code> triplet. In other words, if two applications create a working directory for the same folder, they will get two different working directory values. Closing one of them should not effect the other.</p><p>XRef: DTS Macintosh Technote "Getting a Full Pathname"</p><a name="Section13"></a><P><A HREF="#top">Back to top</A></P><h2>How to control path used by SFGetFile</h2><p>Date Written:  11/1/90</p><p>Last reviewed:  8/1/92</p><p>I would like to be able to control which path <code>SFGetFile</code> uses to display theinitial list of files for the user to choose from. I need to create theequivalent of <code>SFGetDisplayFolder</code> and <code>SFSetDisplayFolder</code> functions.</p><p>___</p><p>To set the directory for standard file dialogs, set the low memory global <code>SFSaveDisk</code> ($214) to the negative of the <code>vRefNum</code> for the volume, and set<code>CurDirStore</code> ($398) to the directory ID.  In Pascal it might look something like</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    PROCEDURE SetupStandardFile(newVRefNum: Integer; newDirID: LongInt);    TYPE      LongIntPtr = ^LongInt;      IntegerPtr = ^Integer;    CONST      SFSaveDisk = $214;   { address of two-byte vRefNum }      CurDirStore = $398;  { address of four-byte dirID  }    VAR      SFSaveDiskPtr: IntegerPtr;      CurDirStorePtr: LongIntPtr;    BEGIN      SFSaveDiskPtr := IntegerPtr(SFSaveDisk);      CurDirStorePtr := LongIntPtr(CurDirStore);      SFSaveDiskPtr^ := -1 * newVRefNum;      CurDirStorePtr^ := newDirID;  { ignored under MFS }    END;</pre>	</TD></TR></TABLE></CENTER><p>or in C:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    void SetupStandardFile(short newVRefNum, long newDirID)    {      enum { SFSaveDisk = 0x214, CurDirStore = 0x398 };      *(short *) SFSaveDisk = -1 * newVRefNum;      *(long *) CurDirStore = newDirID;    }</pre>	</TD></TR></TABLE></CENTER><p>This is documented in the Macintosh Technical Note <u><A HREF = "fl_12.html">"Standard File Tips."</a></u>Note that the <code>vRefNum</code> should be the true <code>vRefNum</code> for the desired volume, not a working directory refNum. Standard File dialogs are also unrelated to and unaffected by the default directory (<code>GetVol/SetVol</code>) and Macintosh programs should almost never have a need to get or set the default directory.</p><a name="Section14"></a><P><A HREF="#top">Back to top</A></P><h2>Saving correct Macintosh "user file last used" information</h2><p>Date Written:  11/17/89</p><p>Last reviewed:  8/1/92</p><p>I save the vRefNum returned by Standard File so I can easily get back to thefile the user last used, but why do I sometimes get "file not found" errorswhen I try to open the file?</p><p>___</p><p>What you have to remember is that under HFS, <code>vRefNums</code> are almost always workingdirectory reference numbers, containing both volume and directory information.<code>wdRefNums</code> have always been transient and not guaranteed to remain valid betweensystem boots. Under MultiFinder, <code>wdRefNums</code> are even more restrictive and arenot valid after applications exit. (See the Macintosh Technote <u><A HREF = "fl_14.html">"Working Directories and MultiFinder"</a></u>.)</p><p>What you should do is translate the <code>wdRefNum</code> into something more permanent. Try a volume name, a working directory DirID, and a filename. Use <code>PBGetWDInfo</code> todetermine the real <code>vRefNum</code> (in <code>ioWDVRefNum</code>) and the <code>DirID</code> in <code>ioWDDirID</code>. Thenuse <code>PBGetVInfo</code> to determine the volume name from the real <code>vRefNum</code> (keeping the<code>vRefNum</code> is insufficient since the <code>vRefNum</code> is likely to change depending on theorder of mounting volumes). Also store the volume creation date to distinguishbetween volumes with the same name.</p><p>This is the best you can do to save file information for later use under System 6. Under System 7, create and store an alias forthe FSSpec returned by Standard File and use that to later locate the file.</p><P><A HREF="#top">Back to top</A></P><P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (80K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/fl_525.pdf">Download</A></P>               </TD>            </TR></table><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/fl/fl_525.html%3Fid%3DDTS10002468-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/fl/fl_525.html%3Fid%3DDTS10002468-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/fl/fl_525.html%3Fid%3DDTS10002468-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>