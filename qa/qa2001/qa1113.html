<HTML><HEAD>   <title>Technical Q&amp;A QA1113: The &quot;/.vol&quot; directory and &quot;volfs&quot;</title><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><meta name="keywords" content="volfs, /.vol, Carbon File Manager, VFS plug-ins"><meta name="Description" content="Technical Q&amp;A QA1113: This Q&amp;A describes how the Carbon FileManager interacts with BSD via &quot;volfs&quot; and the &quot;/.vol&quot; directory."><meta name="categories" content="Files"><meta name="week-posted" content="Feb 11, 2002 - Feb 15, 2002"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10001661" title="The "/.vol" directory and "volfs""></a><!-- top_of_header_marker_comment --> <!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/Darwin/index.html">Darwin</a> &gt; <a href="../../technicalqas/Darwin/idxFileManagement-date.html">File Management</a> &gt; </p><!-- end_header_information --> <!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A QA1113</div>
<div id="pageheadsub">The &quot;/.vol&quot; directory and &quot;volfs&quot;</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600>   <TR>      <td align="left">         <!-- begin_content -->                  <hr width=500 align=center>                                   <P id=p2>Q: When I run <CODE>fs_usage</CODE> against my         Carbon application I see lots of accesses to items in the         "/.vol" directory. What is this directory and why am I         accessing it?</P>                  <P id=p4>A: This directory is used as the mount point for         the "volfs" file system. The "volfs" file system is a key         component for supporting the Carbon File Manager APIs on top         of the BSD file system. Historically, BSD systems only allow         you to access a file or directory by its POSIX path.         However, the Carbon File Manager API also allows you to         access an item by its catalogue node ID (CNID, a file ID         reference or a directory ID). "volfs" provides a bridge         between these two models, allowing the Carbon File Manager         APIs to work on top of the BSD file system.</P>                                             <BR><BR><CENTER><TABLE BORDER=0 CELLPADDING=4 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>WARNING:</B><BR>Under no circumstances should your application                  construct paths within "/.vol". This area of the                  file system is reserved strictly for the Carbon                  File Manager. The structure of the "volfs" file                  system is likely to change in a future releases of                  Mac OS X. You must use the following description of                  the "volfs" path structure for debugging and                  performance analysis only.</P></TD></TR></TABLE></CENTER><BR><BR>                                      <P id=p4>Carbon's use of the "volfs" file system is as         follows.</P>                  <UL id=p4>            <LI>If you access an item via a            <CODE>&lt;vRefNum&gt;</CODE>, <CODE>&lt;dirID&gt;</CODE>,            and <CODE>&lt;name&gt;</CODE> tuple (often bundled            together in an <CODE>FSSpec</CODE>), Carbon File Manager            builds a path of the form:<BR>            <TABLE BORDER=0 CELLPADDING=4 WIDTH=550>               <TR>                  <td bgcolor="#E6E6E6" align=left>                     <pre><BR>/.vol/&lt;volumeID&gt;/&lt;dirID&gt;/&lt;name&gt;<BR><BR></pre>                  </TD>               </TR>            </TABLE>             where:                        <UL id=p4>               <LI><CODE>&lt;volumeID&gt;</CODE> is the decimal               representation of a 32 bit               "volfs" volume identifier               (Carbon maintains an internal table that maps the               volume's <CODE>vRefNum</CODE> to this               value),</LI>                              <LI><CODE>&lt;dirID&gt;</CODE> is the decimal               representation of the directory ID, and</LI>                              <LI><CODE>&lt;name&gt;</CODE> is the UTF-8               representation of the item's name.</LI>            </UL>            </LI>                        <LI>If you access an item via a            <CODE>&lt;vRefNum&gt;</CODE> and            <CODE>&lt;CNID&gt;</CODE> pair, Carbon File Manager            builds a path of the form:<BR>            <TABLE BORDER=0 CELLPADDING=4 WIDTH=550>               <TR>                  <td bgcolor="#E6E6E6" align=left>                     <pre><BR>/.vol/&lt;volumeID&gt;/&lt;CNID&gt;<BR><BR></pre>                  </TD>               </TR>            </TABLE>             where:                        <UL id=p4>               <LI><CODE>&lt;volumeID&gt;</CODE> is the decimal               representation of a 32 bit               "volfs" volume identifier               as described above,               and</LI>                              <LI><CODE>&lt;CNID&gt;</CODE> is the decimal               representation of the catalogue node ID.</LI>            </UL>            </LI>                        <LI>If you access an item via <CODE>FSRef</CODE>, Carbon            File Manager builds a "volfs" path based on the private            information held within the <CODE>FSRef</CODE>.</LI>         </UL>                  <P id=p4>Once it has built this path, Carbon File Manager         can use it to access the item directly, without having to         build the actual POSIX path to the item. This saves time         (because building a POSIX path is expensive) and allows you         to access the item regardless of whether its full path has         changed. For example, if you create an alias to a file, the         Alias Manager stores a file ID reference within the alias.         When you later resolve this alias, the Alias Manager uses         "volfs" to access the file. This ensures that the alias         still resolves even if the file's name or POSIX path has         changed.</P>                  <P id=p4>Not all file systems support "volfs". As of Mac OS         X 10.1 the following file systems support "volfs":</P>                  <UL>            <LI>HFS Plus</LI>                        <LI>HFS</LI>                        <LI>AppleShare</LI>                        <LI>ISO-9660</LI>                        <LI>UDF</LI>         </UL>                  <P id=p4>and the following file systems don't:</P>                  <UL>            <LI>UFS</LI>                        <LI>NFS</LI>                        <LI>DOS/FAT</LI>                        <LI>CDDA</LI>                        <LI>SMB</LI>                        <LI>WebDAV</LI>         </UL>                  <P id=p4>This list is likely to change over time.</P>                  <P id=p4>If the file system does not support "volfs", Carbon         File Manager uses other techniques to emulate catalogue node         IDs on that file system. In general these techniques do not         provide persistent <CODE>CNID</CODE>s. For example, if you         use the Finder to create an alias to a file on a UFS file         system and then move the file to a different folder, the         alias will not resolve.</P>                  <P>                  <hr width=500 align=center>                  </P>                  <P id=p4>If you're writing a VFS         plug-in file system you can choose whether to support         "volfs". If you do support "volfs" there are a number of         things you must do.</P>                  <OL id=p4>            <LI>You must set the <CODE>MNT_DOVOLFS</CODE> flag in the            <CODE>mnt_flag</CODE> field of your <CODE>mount</CODE>            structure.</LI>                        <LI>You must support the            <CODE>getattrlist</CODE>, <CODE>setattrlist</CODE>, and            <CODE>exchange</CODE> operations in your            <CODE>vfsops</CODE>.</LI>                        <LI>You must support the ability to            lookup named forks in your <CODE>lookup</CODE> and            <CODE>cachedlookup</CODE> entry points.</LI>                        <LI>You must implement the <CODE>vget</CODE> operation in            your <CODE>vfsops</CODE>. Specifically, you must set the            <CODE>vfs_vget</CODE> field of your <CODE>vfsops</CODE>            structure to a routine that can map a CNID to a            <CODE>vnode</CODE>.</LI>                        <LI>You must return a CNID in the <CODE>va_fileid</CODE>            field of the <CODE>vattr</CODE> structure in your            <CODE>getattr</CODE> <CODE>vnodeop</CODE> entry point.            Your CNIDs should persist across            successive mounts of the volume. If they don't, you            should probably not support "volfs" and instead rely on            Carbon File Manager to emulate CNIDs for you.</LI>                        <LI>In your <CODE>getattrlist</CODE> <CODE>vnodeop</CODE>            entry point you must respond to the            <CODE>ATTR_CMN_OBJID</CODE> and            <CODE>ATTR_CMN_OBJPERMANENTID</CODE> attribute requests            by setting the <CODE>fid_objno</CODE> field to a            CNID.</LI>         </OL>                  <P id=p4>You can learn more about the implementation of         "volfs" by reading the comments in the following <A HREF="http://www.opensource.apple.com/cgi-bin/registered/cvs/System/xnu/bsd/miscfs/volfs/volfs_vnops.c">volfs_vnops.c</A>         file in the Darwin open source project (this link requires         you to have an account, which you create by agreeing to the         <A HREF="http://www.opensource.apple.com/apsl/">Apple Public         Source License</A>).</P>                  <P>                  <hr width=500 align=center>                  </P>                  <!-- begin_date --><H4><CENTER>[Feb 14 2002]</CENTER></H4><!-- end_date -->      </TD>   </TR></TABLE></CENTER><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/qa2001/qa1113.html%3Fid%3DDTS10001661-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/qa2001/qa1113.html%3Fid%3DDTS10001661-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/qa2001/qa1113.html%3Fid%3DDTS10001661-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>