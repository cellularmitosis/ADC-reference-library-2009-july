<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Kernel Extension Programming Topics: Hello Debugger: Debugging a Device Driver With GDB</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Hello Debugger: Debugging a Device Driver With GDB"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/20002367" title="Hello Debugger: Debugging a Device Driver With GDB"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000422" target="_top">Darwin</a> &gt; <a href="../../../Kernel-date.html#//apple_ref/doc/uid/TP30000440-TP30000422-TP30000532" target="_top">Kernel</a> &gt; <a href="../index.html" target="_top">Kernel Extension Programming Topics</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../KEXTConceptIOKit/hello_iokit.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../KEXTConceptPackaging/packaging_kext.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>
        
        
        <a name="//apple_ref/doc/uid/20002367-CHDIHFDI" title="Hello Debugger: Debugging a Device Driver With GDB"></a><hr /><H1>Hello Debugger: Debugging a Device Driver With GDB</H1><p>This tutorial describes how to prepare to debug a device driver for Darwin/Mac OS X. You will learn how to set up a two-machine debugging environment and how to start using GDB, a command-line debugger, to perform remote debugging.</p><p>The tutorial assumes that you are working in a Mac OS X development environment.</p><p>Although this tutorial is written with a device driver as the example, the steps for debugging are similar for debugging any type of kernel extension (KEXT). If you wish, you can substitute your own code for the example. Note, however, that you may encounter a few inconsistencies. For example, examples of GDB commands may be dependent on the underlying source code language—I/O Kit extensions (drivers) use C++; the GDB commands for C may differ.</p>
<!-- This template is being used for both PDF and HTML. -->

    
    <!-- TopicBook.pm uses this template for its miniTOCs, but needs a different title. -->
    <h4>Contents:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="hello_debugger.html#//apple_ref/doc/uid/20002367-103042-CHDBCAFC">Preparation</a>
				
			<br/>
			
        
			
			
				<a href="hello_debugger.html#//apple_ref/doc/uid/20002367-103522">Roadmap</a>
				
			<br/>
			
        
			
			
				<a href="hello_debugger.html#//apple_ref/doc/uid/20002367-98191-CHDHFJFG">On Target Machine, Enable Kernel Debugging</a>
				
			<br/>
			
        
			
			
				<a href="hello_debugger.html#//apple_ref/doc/uid/20002367-98436-CHDFBFHI">On Development Machine, Set Up a Permanent Network Connection</a>
				
			<br/>
			
        
			
			
				<a href="hello_debugger.html#//apple_ref/doc/uid/20002367-99028-CHDHBFAF">Create a Symbol File</a>
				
			<br/>
			
        
			
			
				<a href="hello_debugger.html#//apple_ref/doc/uid/20002367-99595-CHDGDJFC">On Development Machine, Import the Symbol File</a>
				
			<br/>
			
        
			
			
				<a href="hello_debugger.html#//apple_ref/doc/uid/20002367-99813-CHDEHJDG">On Development Machine, Start GDB</a>
				
			<br/>
			
        
			
			
				<a href="hello_debugger.html#//apple_ref/doc/uid/20002367-100014-CHDCDIGH">On Target Machine, Break into Kernel Debugging Mode</a>
				
			<br/>
			
        
			
			
				<a href="hello_debugger.html#//apple_ref/doc/uid/20002367-100329-CHDIAHDJ">On Development Machine, Attach to the Target Machine</a>
				
			<br/>
			
        
			
			
				<a href="hello_debugger.html#//apple_ref/doc/uid/20002367-105751">On Development Machine, Set Breakpoints in GDB</a>
				
			<br/>
			
        
			
			
				<a href="hello_debugger.html#//apple_ref/doc/uid/20002367-105887-CHDGDGII">On Target Machine, Start Running the Device Driver</a>
				
			<br/>
			
        
			
			
				<a href="hello_debugger.html#//apple_ref/doc/uid/20002367-100836-CHDFDDHH">On Development Machine, Control the Driver With GDB</a>
				
			<br/>
			
        
			
			
				<a href="hello_debugger.html#//apple_ref/doc/uid/20002367-101057-CHDBEDEA">Stop the Debugger</a>
				
			<br/>
			
        
			
			
				<a href="hello_debugger.html#//apple_ref/doc/uid/20002367-101226-CHDIIAEA">On Target Machine, Unload the Driver</a>
				
			<br/>
			
        
			
			
				<a href="hello_debugger.html#//apple_ref/doc/uid/20002367-SW1">Postmortem Debugging</a>
				
			<br/>
			
        
			
			
				<a href="hello_debugger.html#//apple_ref/doc/uid/20002367-101290">Where to Go Next</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/20002367-103042" title="Preparation"></a><a name="//apple_ref/doc/uid/20002367-103042-CHDBCAFC" title="Preparation"></a><h2>Preparation</h2><p>Before you begin this tutorial, make sure you have met the following requirements.</p><ol class="ol"><li class="li"><p>Be sure you understand the material presented in the KEXT and driver development tutorials.</p><p>The tutorials <span class="content_text"><a href="../KEXTConceptKEXT/hello_kext.html#//apple_ref/doc/uid/20002365-BABJHCJA">“Hello Kernel: Creating a Kernel Extension With Xcode”</a></span> and <span class="content_text"><a href="../KEXTConceptIOKit/hello_iokit.html#//apple_ref/doc/uid/20002366-CIHECHHE">“Hello I/O Kit: Creating a Device Driver With Xcode”</a></span> describe how to create a kernel extension's project, correct code errors, and how to create a simple I/O Kit device driver. This tutorial uses the example from “HelloIOKit”. Be sure that you have completed these tutorials (or are familiar with KEXT or driver development in Mac OS X) before beginning this one.</p></li><li class="li"><p>For remote debugging, you need two machines. On the <em>development machine</em>, you create, build, and, for this tutorial, debug your driver. On the <em>target machine</em>, you load and run the driver. </p><p>Before you begin this tutorial, you should prepare the two machines. Note that:</p><ul class="ul"><li class="li"><p>Both machines must be running the same version of Mac OS X.</p></li><li class="li"><p>Both machines must be connected via Ethernet using the built-in Ethernet ports.</p></li><li class="li"><p>If you’re running a version of Mac OS X earlier than Mac OS X version 10.3, both machines must be on the same subnet.</p></li><li class="li"><p>You must have login access to both machines; this tutorial assumes you are logging in as an administrator of your machine (in this tutorial, the user <code>admin</code>). You will need <code>root</code> privileges for some of the commands so you will be using the <strong>sudo</strong> command which allows permitted users to execute a given command as <code>root</code>. If you are using another account, substitute that account name in the examples that follow, but make sure that account has administrative access.</p></li><li class="li"><p>Make sure that Personal File Sharing and FTP Access are enabled for the target machine. Use the Sharing panel in the System Preferences (click System Preferences in the Apple menu or in the Dock) to enable FTP Access and Personal File Sharing.</p></li><li class="li"><p>If the target machine has Apple Remote Desktop enabled, you should disable it before you continue with this tutorial. To do this, open System Preferences, click Sharing, and uncheck the Apple Remote Desktop checkbox in the Services pane.</p></li></ul></li><li class="li"><p>Transfer a copy of your KEXT to the target machine.</p><p>Before you can begin to debug your driver (and each time you rebuild it), you must transfer a copy of your KEXT to the target machine. You can do this in any of several ways. For example:</p><ul class="ul"><li class="li"><p>Use File Sharing to transfer your KEXT over the network.</p></li><li class="li"><p>Use the <strong>tar</strong> and <strong>ftp</strong> commands (from within the Terminal application), to package your KEXT and transfer it over the network.</p></li></ul><p>You can also automate this process using <strong>ssh</strong>. This tutorial does not tell you how to do this, but you can find resources on the web that describe the process.</p></li></ol><a name="//apple_ref/doc/uid/20002367-103522" title="Roadmap"></a><h2>Roadmap</h2><p>This tutorial has many steps. It is important to keep the two machines clear in your mind as you work through the steps. It may help if you take a piece of paper, tear it in half, and write “Development” on one piece and “Target” on the other. Then place the pieces of paper next to the two machines.</p><p>You will be moving back and forth between the two machines many times. <span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-103640-CHDGFEIB">Figure 1</a></span> illustrates the steps you will take for each machine.</p><br/><div><a name="//apple_ref/doc/uid/20002367-103640-CHDGFEIB" title="Figure 1Steps to set up a debugging environment"></a><p><a name="//apple_ref/doc/uid/20002367-103640" title="Figure 1Steps to set up a debugging environment"></a><strong>Figure 1&nbsp;&nbsp;</strong>Steps to set up a debugging environment</p><img src = "../art/diagram.gif" alt = "" width="284" height="372"></div><br/><p>After reading <span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-103042">“Preparation,”</a></span> you should have already prepared the two machines and attached them to the network. The next two steps will enable kernel debugging and set up a permanent network connection between the two machines.</p><ol class="ol"><li class="li"><p><span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-98191">“On Target Machine, Enable Kernel Debugging”</a></span></p></li><li class="li"><p><span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-98436">“On Development Machine, Set Up a Permanent Network Connection”</a></span></p></li></ol><p>Once these steps are completed, you will not need to repeat them, even if you need to start over part way through the tutorial. The next set of steps prepare the driver for debugging, set up GDB, and attach the two machines to begin debugging your driver. If you need to start over part way through the tutorial, you should repeat all of these steps from the beginning.</p><ol class="ol"><li class="li"><p><span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-99028">“Create a Symbol File”</a></span></p></li><li class="li"><p><span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-99595">“On Development Machine, Import the Symbol File”</a></span></p></li><li class="li"><p><span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-99813">“On Development Machine, Start GDB ”</a></span></p></li><li class="li"><p><span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-100014">“On Target Machine, Break into Kernel Debugging Mode”</a></span></p></li><li class="li"><p><span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-100329">“On Development Machine, Attach to the Target Machine”</a></span></p></li><li class="li"><p><span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-105887">“On Target Machine, Start Running the Device Driver”</a></span></p></li><li class="li"><p><span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-100836">“On Development Machine, Control the Driver With GDB”</a></span></p></li></ol><p>The last two steps stop the debugger and unload the driver. If you need to start over part way through, you may need to skip ahead to these steps to reset the environment completely, then start again at <span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-99028">“Create a Symbol File.”</a></span></p><ol class="ol"><li class="li"><p><span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-101057">“Stop the Debugger”</a></span></p></li><li class="li"><p><span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-101226">“On Target Machine, Unload the Driver”</a></span></p></li></ol><a name="//apple_ref/doc/uid/20002367-98191" title="On Target Machine, Enable Kernel Debugging"></a><a name="//apple_ref/doc/uid/20002367-98191-CHDHFJFG" title="On Target Machine, Enable Kernel Debugging"></a><h2>On Target Machine, Enable Kernel Debugging</h2><p>In this step and the next, you will set up the two-machine environment. These two steps will enable kernel debugging and set up a permanent network connection between the two machines.</p><p>By default, Darwin/Mac OS X does not let you debug the kernel. Before you can debug your driver, you must first enable kernel debugging. On the target machine, do the following:</p><ol class="ol"><li class="li"><p>Start the Terminal application. From a Finder window, locate and launch the Terminal application, found at <code>/Applications/Utilities/Terminal</code>. </p></li><li class="li"><p>Set the kernel debug flags.</p><p>To enable kernel debugging, you will be setting an NVRAM (non-volatile random access memory) variable. To do this, you must use the <strong>sudo</strong> command which gives permitted users the ability to execute a given command as <code>root</code>. When <strong>sudo</strong> prompts you for a password, enter your <code>admin</code> password. (Note that nothing is displayed as you type the password.)</p><p>The <strong>sudo</strong> command will allow you to execute commands with <code>root</code> privileges without re-entering your password for a few minutes (usually 5) but after that time is up, it will ask you for your password again. This tutorial does not show the password prompt every time the <strong>sudo</strong> command is used.</p><p>If you're using a beige Power Macintosh G3 and you’re running a version of Mac OS X prior to 10.1, enter this command:</p><div class="codesample"><table><tr><td scope="row"><pre>$ sudo nvram boot-command="0 bootr debug=0x14e"<span></span></pre></td></tr></table></div><p>If your target machine is a PowerPC-based Macintosh model not listed above or an Intel-based Macintosh, enter this command:</p><div class="codesample"><table><tr><td scope="row"><pre>$ sudo nvram boot-args="debug=0x14e"<span></span></pre></td></tr><tr><td scope="row"><pre>Password:<span></span></pre></td></tr></table></div><p>For more information on debugging flags, see <span class="content_text"><a href="../../KernelProgramming/build/build.html#//apple_ref/doc/uid/TP30000905-CH221" target="_top">Building and Debugging Kernels</a></span> in <em><a href="../../KernelProgramming/index.html#//apple_ref/doc/uid/TP30000905" target="_top">Kernel Programming Guide</a></em>.</p></li><li class="li"><p>Restart the computer.</p><p>The computer restarts and displays the login screen.</p></li></ol><a name="//apple_ref/doc/uid/20002367-98436" title="On Development Machine, Set Up a Permanent Network Connection"></a><a name="//apple_ref/doc/uid/20002367-98436-CHDFBFHI" title="On Development Machine, Set Up a Permanent Network Connection"></a><h2>On Development Machine, Set Up a Permanent Network Connection</h2><p>Your development and target machines must be continuously connected by a reliable network connection. In this section, you will create such a connection.</p><div class="notebox"><a name="//apple_ref/doc/uid/20002367-DontLinkElementID_4" title="Note"></a><p><strong>Note:</strong>&nbsp;If your target machine is running Mac OS X 10.3 or later and is configured with the 0x40 debug flag set (<code>DB_ARP</code>), you can skip this section.</p></div><p>After the target machine has restarted, do the following steps on the development machine:</p><ol class="ol"><li class="li"><p>Start the Terminal application. From a Finder window, locate and launch the Terminal application, found at <code>/Applications/Utilities/Terminal</code>. </p></li><li class="li"><p>Make sure your development machine can connect to your target machine. </p><p>Use the <strong>ping</strong> command with your target machine’s hostname or IP address. For example:</p><div class="codesample"><table><tr><td scope="row"><pre>$ ping -c 1 target.apple.com<span></span></pre></td></tr></table></div><p>or</p><div class="codesample"><table><tr><td scope="row"><pre>$ ping -c 1 192.102.207.119<span></span></pre></td></tr></table></div><p>This command makes sure your development machine can reach your target machine and creates a temporary connection between them. The <code>-c 1</code> option tells <strong>ping</strong> to stop after sending (and receiving) one ICMP (Internet Control Message Protocol) packet.</p><p>You should see output similar to this:</p><div class="codesample"><table><tr><td scope="row"><pre>PING target.my-company.com (192.102.207.119): 56 data bytes<span></span></pre></td></tr><tr><td scope="row"><pre>64 bytes from 192.102.207.119: icmp_seq=0 ttl=255 time=2.099 ms<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>--- target.apple.com ping statistics ---<span></span></pre></td></tr><tr><td scope="row"><pre>1 packets transmitted, 1 packets received, 0% packet loss<span></span></pre></td></tr><tr><td scope="row"><pre>round-trip min/avg/max = 2.099/2.099/2.099 ms<span></span></pre></td></tr></table></div></li><li class="li"><p>If you don't already know it, determine the hardware Ethernet address of the target machine. </p><p>Enter this command:</p><div class="codesample"><table><tr><td scope="row"><pre>$ arp -a<span></span></pre></td></tr></table></div><p>The <strong>arp</strong> command with the <code>-a</code> option lists the static hardware Ethernet addresses of all machines your development machine has recently accessed. Make a note of the entry for your target machine's address. Because this address is stored in the hardware, you should keep track of this number for future debugging sessions (or for debugging possible kernel panics).</p><p>For example, you should see output similar to this:</p><div class="codesample"><table><tr><td scope="row"><pre>aniil33 (1192.102.207.102) at 0:0:f:0:86:c3<span></span></pre></td></tr><tr><td scope="row"><pre>target (192.102.207.119) at 0:5:2:b0:b3:20<span></span></pre></td></tr><tr><td scope="row"><pre>dev (192.102.207.124) at 0:5:2:59:2f:20<span></span></pre></td></tr></table></div><p>In this example, the hardware Ethernet address to remember is <code>0:5:2:b0:b3:20</code>. </p></li><li class="li"><p>Remove the current, temporary, connection between your development and target machines. Use the <strong>arp</strong> command with your target machine’s hostname. Because you’ll be using the <code>-d</code> option to delete the entry for the target machine, this command must be executed as <code>root</code>, so use the <strong>sudo</strong> command.</p><p>For example:</p><div class="codesample"><table><tr><td scope="row"><pre>$ sudo arp -d target.apple.com<span></span></pre></td></tr></table></div><p>You should see output like this:</p><div class="codesample"><table><tr><td scope="row"><pre>target.apple.com (192.102.207.119) deleted<span></span></pre></td></tr></table></div></li><li class="li"><p>Create a new, permanent, connection between your development and target machines. Use the <strong>arp</strong> command with the target machine’s hostname and Ethernet address. The <strong>arp</strong> command with the <code>-s</code> option must be executed as <code>root</code>, so use the <strong>sudo</strong> command.</p><p>For example:</p><div class="codesample"><table><tr><td scope="row"><pre>$ sudo arp -s target.apple.com 0:5:2:b0:b3:20<span></span></pre></td></tr></table></div><p>You can copy and paste the Ethernet address from the previous output in the Terminal window.</p></li><li class="li"><p>Make sure the connection was made correctly.</p><p>Enter this command:</p><div class="codesample"><table><tr><td scope="row"><pre>$ arp -a<span></span></pre></td></tr></table></div><p>Make sure the entry for your target machine now contains the word “permanent.” </p><p>You should see output similar to this:</p><div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>niil33 (192.102.207.102) at 0:0:f:0:86:c3<span></span></pre></td></tr><tr><td scope="row"><pre>target (192.102.207.119) at 0:5:2:b0:b3:20 permanent<span></span></pre></td></tr><tr><td scope="row"><pre>dev (192.102.207.124) at 0:5:2:59:2f:20<span></span></pre></td></tr></table></div></li></ol><a name="//apple_ref/doc/uid/20002367-99028" title="Create a Symbol File"></a><a name="//apple_ref/doc/uid/20002367-99028-CHDHBFAF" title="Create a Symbol File"></a><h2>Create a Symbol File</h2><p>The previous steps prepared the two machines to communicate with each other. The next steps will load the driver, prepare and transfer a symbol file, and start the debugger. </p><div class="warningbox"><img src="../../../../Resources/Images/icon_warning.gif" alt="!" width="20" height="20" border="0" class="warningicon" /><a name="//apple_ref/doc/uid/20002367-DontLinkElementID_5" title="Warning:"></a><p><strong>Warning:</strong>&nbsp;If you make a mistake in any of the following steps, or need to retrace any steps, you should begin again at this step.</p><p></p><div class="clear"></div></div><p>There are two ways to create a symbol file. If the target machine is running, you can generate the symbol file on the target machine itself. If the target machine is crashed, you must generate the symbol file on the host machine. This section describes both methods.</p><a name="//apple_ref/doc/uid/20002367-DontLinkElementID_1" title="Creating a Symbol File on the Target Machine"></a><h3>Creating a Symbol File on the Target Machine</h3><p>On the target machine, do the following:</p><ol class="ol"><li class="li"><p>At your option, either launch Terminal as an admin user or login as <code>>console</code> (with a blank password), then </p></li><li class="li"><p>If you logged in as <code>>console</code>, at the next login prompt, log in as an admin user.</p><p>For example:</p><div class="codesample"><table><tr><td scope="row"><pre>Darwin/BSD (dev) (console)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>login: admin<span></span></pre></td></tr><tr><td scope="row"><pre>Password for admin:<span></span></pre></td></tr><tr><td scope="row"><pre>admin$<span></span></pre></td></tr></table></div></li><li class="li"><p>Copy your KEXT to <code>/tmp</code>.</p><p>Because you will be loading your KEXT into the kernel, your KEXT must be owned by the user <code>root</code> and the group <code>wheel</code> and the folders and files of the KEXT bundle must have their permissions set so that they are not writable by any user other than the super user. If you haven't already done so, use the <strong>sudo</strong> command to copy the KEXT binary (<code>HelloIOKit.kext</code>) to the <code>/tmp</code> directory so you can load and unload the KEXT from there. Using <strong>sudo</strong> to copy the KEXT binary gives the KEXT the super user's ownership and permissions and leaves the original KEXT alone so you can revise and save it as you choose.</p><div class="notebox"><a name="//apple_ref/doc/uid/20002367-DontLinkElementID_6" title="Note"></a><p><strong>Note:</strong>&nbsp;Every time you make changes to your KEXT and rebuild it, you need to repeat this step to copy the new version to the <code>/tmp</code> directory to load and debug it.</p></div><p>For example:</p><div class="codesample"><table><tr><td scope="row"><pre>$ sudo cp -R HelloIOKit.kext /tmp<span></span></pre></td></tr></table></div><div class="warningbox"><img src="../../../../Resources/Images/icon_warning.gif" alt="!" width="20" height="20" border="0" class="warningicon" /><a name="//apple_ref/doc/uid/20002367-DontLinkElementID_7" title="Warning:"></a><p><strong>Warning:</strong>&nbsp;If you use tab-completion to avoid typing all of <code>HelloIOKit.kext</code>, you’ll get a “/” after the KEXT name. Be sure to delete this slash before you press Return. If you don’t, the <strong>cp</strong> command will copy only the <em>contents</em> of the <code>HelloIOKit.kext</code> directory to <code>/tmp</code>, instead of copying the directory and its entire subtree.</p><p></p><div class="clear"></div></div></li><li class="li"><p>For debugging purposes, you first use <strong>kextload</strong> with some options to load the driver and create a symbol file for it, but not start the driver. You'll register the driver and start it running (again using <strong>kextload</strong>) in a later step, <span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-105887">“On Target Machine, Start Running the Device Driver.”</a></span> The <strong>kextload</strong> command must be run as <code>root</code>, so you must also use the <strong>sudo</strong> command.</p><div class="warningbox"><img src="../../../../Resources/Images/icon_warning.gif" alt="!" width="20" height="20" border="0" class="warningicon" /><a name="//apple_ref/doc/uid/20002367-DontLinkElementID_8" title="Warning:"></a><p><strong>Warning:</strong>&nbsp;In the KEXT development tutorials, <span class="content_text"><a href="../KEXTConceptKEXT/hello_kext.html#//apple_ref/doc/uid/20002365-BABJHCJA">“Hello Kernel: Creating a Kernel Extension With Xcode”</a></span> and <span class="content_text"><a href="../KEXTConceptIOKit/hello_iokit.html#//apple_ref/doc/uid/20002366-CIHECHHE">“Hello I/O Kit: Creating a Device Driver With Xcode,”</a></span> you used <strong>kextload</strong> to load your KEXT and start it running all in one step. Now you will break this step in two, using different options to <strong>kextload</strong> each time. </p><p></p><div class="clear"></div></div><p>Load the driver (without starting it) and create a symbol file for it. </p><p>For example, enter the command:</p><div class="codesample"><table><tr><td scope="row"><pre>$ sudo kextload -ls /tmp HelloIOKit.kext<span></span></pre></td></tr></table></div><p>The <code>-l</code> (this is a lower-case “L”) option tells <strong>kextload</strong> to load the KEXT's code into the kernel but not to start I/O Kit matching, which would start the KEXT running. The <code>-s</code> option tells <strong>kextload</strong> to create symbol files in <code>/tmp</code> for the KEXT and any of its dependencies. To ensure uniqueness the symbol files are named after each KEXT's CFBundleIdentifier, plus a <code>.sym</code> or <code>.dSYM</code> extension.</p><p>For the most part, the two symbol file formats are equivalent. For this reason, this document does not distinguish between them except where behavior differs.</p><p>Do not rename the symbol file if you are debugging with a DWARF symbol file (<code>.dSYM</code>). If you are debugging with a STABS symbol file (<code>.sym</code>), you may rename the file so long as the name still ends with <code>.sym</code>.</p><p>The symbol file contains information that GDB needs to debug your driver. You must create the symbol file for a loaded driver, then copy the file to the development machine where it will be used. Note that you must recreate the symbol file again if you unload (and reload) the driver. This is because the KEXT may be loaded at a different address each time and the symbol files contain the actual virtual address of each symbol.</p></li><li class="li"><p>Optionally, you can rename the symbol file.</p><p>For example:</p><div class="codesample"><table><tr><td scope="row"><pre>$ mv /tmp/com.MyTutorial.driver.HelloIOKit.sym /tmp/HelloIOKit.sym<span></span></pre></td></tr></table></div></li></ol><a name="//apple_ref/doc/uid/20002367-DontLinkElementID_2" title="Creating a Symbol File on the Host Machine"></a><h3>Creating a Symbol File on the Host Machine</h3><p>To create a symbol file on the host machine, you must have a copy of the kernel extension on the host machine. The host machine must have the same architecture as the target machine (for example, two Intel machines). You must also have the kernel debug kit that correspondes with the version of Mac OS X installed on the target machine.</p><ol class="ol"><li class="li"><p>Create the symbol file.</p><div class="codesample"><table><tr><td scope="row"><pre>sudo kextload -n -k /Volumes/KernelDebugKit/mach_kernel -s /tmp/syms/ HelloIOKit.kext<span></span></pre></td></tr></table></div><p>Adjust the path to the kernel debug kit and your kernel extension as appropriate.</p></li><li class="li"><p>The <code>kextload</code> tool will now prompt you for the load addresses of your KEXT and any KEXT upon which it depends. Enter the addresses as requested.</p><p>If the target machine is still running, you can obtain a full list by running <code>kextstat</code> (with no arguments) on the target machine. See the manual page for <code><a href="../../../Reference/ManPages/man8/kextstat.8.html#//apple_ref/doc/man/8/kextstat" target="_top">kextstat(8)</a></code> for more information.</p><p>In the case of a non-graphical kernel panic, you should find a list of these address on screen.</p><p>In the case of a graphical kernel panic or a hang, you can get this information by connecting to the target machine using GDB as described in <span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-SW1">“Postmortem Debugging.”</a></span></p><p>When you finish, you should see a symbol file in <code>/tmp/syms</code>.</p></li><li class="li"><p>There’s no step 3!</p></li></ol><a name="//apple_ref/doc/uid/20002367-99595" title="On Development Machine, Import the Symbol File"></a><a name="//apple_ref/doc/uid/20002367-99595-CHDGDJFC" title="On Development Machine, Import the Symbol File"></a><h2>On Development Machine, Import the Symbol File</h2><p>On the development machine, import the symbol file (<code>.sym</code> or <code>.dSYM)</code> from the target machine, for use with GDB. You can do this by copying the file to a keychain drive or an external hard drive, or by using the <code><a href="../../../Reference/ManPages/man1/ftp.1.html#//apple_ref/doc/man/1/ftp" target="_top">ftp(1)</a></code> (file transfer protocol) or <code><a href="../../../Reference/ManPages/man1/scp.1.html#//apple_ref/doc/man/1/scp" target="_top">scp(1)</a></code> (secure copy) command. For security reasons, the <code>scp</code> command is recommended over the <code>ftp</code> command.</p><p>If you are debugging a driver built with DWARF symbols (a <code>.dSYM</code> file), you must also copy the kernel extension itself. The easiest way to do this is to create a ZIP archive of the KEXT in Finder or use tar on the command line.</p><p>For example, the following two commands create an archive of a KEXT and extract that archive, respectively:</p><div class="codesample"><table><tr><td scope="row"><pre>tar -czf mykext.tar.gz mykext.kext # create archive<span></span></pre></td></tr><tr><td scope="row"><pre>tar -xzf mykext.tar.gz # extract archive<span></span></pre></td></tr></table></div><p>To use the <code>scp</code> command, you need an account on the target machine and you need to have Remote Login enabled in the Sharing System Preferences pane. Then, issue the following commands:</p><div class="codesample"><table><tr><td scope="row"><pre>cd /path/to/store/the/symbol/file/<span></span></pre></td></tr><tr><td scope="row"><pre>scp username@target.apple.com:/path/to/remote/file.sym .<span></span></pre></td></tr></table></div><p>Change the remote username, host name, and paths as appropriate. The scp command then asks you for the remote password. Type the password, and a few seconds later, you should have a copy of the symbol file in the destination directory on your development machine.</p><p>To use the <code>ftp</code> command, you need an account on the target machine and you need to enable FTP in the Sharing System Preferences pane. A sample ftp session is shown below. Enter the ftp commands as shown.</p><div class="warningbox"><img src="../../../../Resources/Images/icon_warning.gif" alt="!" width="20" height="20" border="0" class="warningicon" /><a name="//apple_ref/doc/uid/20002367-DontLinkElementID_9" title="Warning:"></a><p><strong>Warning:</strong>&nbsp;Be sure to use the actual name or IP address of the target machine; in this example it is <code>target.apple.com</code>. Be sure to log in with your actual account name; this example uses <code>admin</code>.</p><p></p><div class="clear"></div></div><div class="codesample"><table><tr><td scope="row"><pre>$ ftp target.apple.com<span></span></pre></td></tr><tr><td scope="row"><pre>Connected to target.apple.com.<span></span></pre></td></tr><tr><td scope="row"><pre>220 target.apple.com FTP server (Version 6.00) ready.<span></span></pre></td></tr><tr><td scope="row"><pre>Name (dev:admin): admin<span></span></pre></td></tr><tr><td scope="row"><pre>331 Password required for admin.<span></span></pre></td></tr><tr><td scope="row"><pre>Password:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>230- Welcome to Darwin!<span></span></pre></td></tr><tr><td scope="row"><pre>230 User admin logged in.<span></span></pre></td></tr><tr><td scope="row"><pre>Remote system type is BSD.<span></span></pre></td></tr><tr><td scope="row"><pre>ftp> bin<span></span></pre></td></tr><tr><td scope="row"><pre>200 Type set to I.<span></span></pre></td></tr><tr><td scope="row"><pre>ftp> get /tmp/com.MyTutorial.driver.HelloIOKit.sym<span></span></pre></td></tr><tr><td scope="row"><pre>local: /tmp/com.MyTutorial.driver.HelloIOKit.sym remote: /tmp/com.MyTutorial.driver.HelloIOKit.sym<span></span></pre></td></tr><tr><td scope="row"><pre>200 PORT command successful.<span></span></pre></td></tr><tr><td scope="row"><pre>150 Opening BINARY mode data connection for '/tmp/com.MyTutorial.driver.HelloIOKit.sym'<span></span></pre></td></tr><tr><td scope="row"><pre>226 Transfer complete.<span></span></pre></td></tr><tr><td scope="row"><pre>180356 bytes received in 0.15 seconds (1.15 MB/s)<span></span></pre></td></tr><tr><td scope="row"><pre>ftp> bye<span></span></pre></td></tr></table></div><p>Note that you must recreate (and import) the symbol file again if you unload (and reload) the driver on the target machine. You should also note that any files in the <code>/tmp</code> directory are temporary and will be deleted whenever Darwin/Mac OS X is restarted.</p><a name="//apple_ref/doc/uid/20002367-99813" title="On Development Machine, Start GDB "></a><a name="//apple_ref/doc/uid/20002367-99813-CHDEHJDG" title="On Development Machine, Start GDB "></a><h2>On Development Machine, Start GDB </h2><p>Now you can start GDB. On the development machine, do the following from the Terminal application:</p><ol class="ol"><li class="li"><p>Start the debugger on the kernel.</p><p>Enter this command:</p><div class="codesample"><table><tr><td scope="row"><pre>$ gdb -arch ppc /mach_kernel<span></span></pre></td></tr></table></div><p>Substitute <code>-arch i386</code> if your debug target is an Intel-based Macintosh. You should see output like this:</p><div class="codesample"><table><tr><td scope="row"><pre>GNU gdb 4.18-20000320 (Apple version gdb-172)<span></span></pre></td></tr><tr><td scope="row"><pre>Copyright 1998 Free Software Foundation, Inc.<span></span></pre></td></tr><tr><td scope="row"><pre>...<span></span></pre></td></tr><tr><td scope="row"><pre>(gdb)<span></span></pre></td></tr></table></div></li><li class="li"><p>Load the symbol file you created and transferred.</p><p>If you are debugging a kernel extension compiled with DWARF symbols, at the GDB prompt, use the <strong>add-kext</strong> command with the name of the KEXT.</p><div class="notebox"><a name="//apple_ref/doc/uid/20002367-DontLinkElementID_10" title="Note"></a><p><strong>Note:</strong>&nbsp;When debugging with DWARF symbols (a file ending in <code>.dSYM</code>), you must place the debug symbols file in the same directory as the KEXT.</p></div><p>For example:</p><div class="codesample"><table><tr><td scope="row"><pre>(gdb) add-kext /tmp/com.MyTutorial.driver.HelloIOKit.kext<span></span></pre></td></tr></table></div><p>If you are debugging a kernel extension compiled with STABS symbols, at the GDB prompt, use the <strong>add-symbol-file</strong> command with the name of the symbol file you’ve created.</p><p>For example:</p><div class="codesample"><table><tr><td scope="row"><pre>(gdb) add-symbol-file /tmp/com.MyTutorial.driver.HelloIOKit.sym<span></span></pre></td></tr></table></div></li><li class="li"><p>Tell the debugger that you're remotely debugging a device driver.</p><p>At the GDB prompt, enter this command:</p><div class="codesample"><table><tr><td scope="row"><pre>(gdb) target remote-kdp<span></span></pre></td></tr></table></div></li></ol><a name="//apple_ref/doc/uid/20002367-100014" title="On Target Machine, Break into Kernel Debugging Mode"></a><a name="//apple_ref/doc/uid/20002367-100014-CHDCDIGH" title="On Target Machine, Break into Kernel Debugging Mode"></a><h2>On Target Machine, Break into Kernel Debugging Mode</h2><p>Before you can connect GDB to the target machine, you must break into kernel debugging mode. There are four ways to break into kernel debugging mode. </p><ul class="ul"><li class="li"><p>You can force a break into the debugger by briefly pressing the power button on the machine. Because you enabled kernel debugging in <span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-98191">“On Target Machine, Enable Kernel Debugging,”</a></span> briefly pressing the power button sends a nonmaskable interrupt (NMI) instead of sleeping or waking the machine. You will use this method in this tutorial.</p></li><li class="li"><p>On some machines, you can force a break into the debugger using the programmer's button (check your computer manual for its location) to send an NMI.</p></li><li class="li"><p>If your keyboard contains a power button, you can force a break into the debugger from the keyboard.</p><p>To use this method, you need to hold a combination of keys for three seconds. To estimate three seconds, try counting aloud “one thousand one, one thousand two, one thousand three”. </p><p>On a USB keyboard, or if you’re using a PowerBook or iBook , hold down the <em>Command</em> (or Apple) key and the <em>Power</em> button. </p><p>If you’re running Mac OS X version 10.4 or later, hold down the following five keys: <em>Command</em>, <em>Option</em>, <em>Control</em>, <em>Shift</em>, and <em>Escape</em>.</p><p>On an ADB keyboard, hold down <em>Control</em> and <em>Power</em>.</p><p>Be sure to hold down the keys for only three seconds. You could reboot the machine if you hold the keys down for too long.</p></li><li class="li"><p>In Mac OS X 10.4 and later, if you are using a USB keyboard, you can use the key combination Command-Option (Alt)-Control-Shift-Escape.</p></li><li class="li"><p>You can put a call to <code>PE_enter_debugger</code> into your code; your driver will enter the debugger when it reaches this point. For example, you could add this line to your driver's <code>init</code> method:</p><div class="codesample"><table><tr><td scope="row"><pre>PE_enter_debugger("debug")<span></span></pre></td></tr></table></div></li></ul><div class="notebox"><a name="//apple_ref/doc/uid/20002367-DontLinkElementID_11" title="Note"></a><p><strong>Note:</strong>&nbsp;Unless you’re in Console mode, it may be difficult to tell when the kernel stops and the target machine is in kernel debugging mode. One way to tell is to enable the seconds display in the menu bar clock. When the seconds stop counting, the kernel is stopped. To enable the seconds display, open System Preferences and click Date &amp; Time. Select the Clock tab and check the box next to Display the time with seconds.</p></div><p>On the target machine, do the following:</p><ol class="ol"><li class="li"><p>Break into the debugger. Briefly press the power button on the machine.</p></li><li class="li"><p>The kernel stops and the machine waits for a remote debugger connection.</p><p>If you’re in Console mode, you’ll see the following message on the screen:</p><div class="codesample"><table><tr><td scope="row"><pre>ethernet MAC address: 0:5:2:b0:b3:20<span></span></pre></td></tr><tr><td scope="row"><pre>ip address: 192.102.207.119<span></span></pre></td></tr></table></div></li><li class="li"><p>If the seconds don’t stop counting (or if you don't see the “Waiting...” message in Console mode), briefly press the power button again.</p></li><li class="li"><p>Immediately move to the development machine and attach to the target machine from GDB.</p></li></ol><a name="//apple_ref/doc/uid/20002367-100329" title="On Development Machine, Attach to the Target Machine"></a><a name="//apple_ref/doc/uid/20002367-100329-CHDIAHDJ" title="On Development Machine, Attach to the Target Machine"></a><h2>On Development Machine, Attach to the Target Machine</h2><p>Now you can tell GDB to attach to the target machine. On the development machine, do the following:</p><ol class="ol"><li class="li"><p>Attach to the target machine. At the GDB prompt, use the <code>attach</code> or <code>kdp-reattach</code> macro with the target machine’s name or IP address.</p><p>For example:</p><div class="codesample"><table><tr><td scope="row"><pre>(gdb) attach target.apple.com<span></span></pre></td></tr><tr><td scope="row"><pre>or<span></span></pre></td></tr><tr><td scope="row"><pre>(gdb) kdp-reattach target.apple.com<span></span></pre></td></tr></table></div></li><li class="li"><p>The target machine prints: </p><div class="codesample"><table><tr><td scope="row"><pre>Connected to remote debugger.<span></span></pre></td></tr></table></div><p>Note that the target machine is currently unable to accept keyboard input.</p></li></ol><a name="//apple_ref/doc/uid/20002367-105751" title="On Development Machine, Set Breakpoints in GDB"></a><h2>On Development Machine, Set Breakpoints in GDB</h2><p>This is the best place to set breakpoints in your code, before you actually run the driver on the target machine. For this tutorial, set a breakpoint at the <code>start</code> method. </p><ol class="ol"><li class="li"><p>In GDB, set a breakpoint in the <code>start</code> method.</p><p>For example:</p><div class="codesample"><table><tr><td scope="row"><pre>(gdb) break 'com_MyTutorial_driver_HelloIOKit::start(IOService<span></span></pre></td></tr><tr><td scope="row"><pre>*)'<span></span></pre></td></tr><tr><td scope="row"><pre>Breakpoint 1 at 0x53d93d0: file HelloIOKit.cpp, line 54.<span></span></pre></td></tr></table></div><p>Hint: You don't need to type the entire class name for the breakpoint; GDB can do name completion. Type a single quote, <code>'</code>, then the first part of the name, then press the tab key. If GDB does not complete the name, you may need to type a few more characters to allow it to choose an unambiguous match. For example, type</p><div class="codesample"><table><tr><td scope="row"><pre>(gdb) break 'com_&lt;TAB><span></span></pre></td></tr></table></div><p>When you press the tab key, GDB will complete the name as far as it can, unambiguously. If it cannot complete the entire name of the method, you will need to give it more clues. For example, all of the methods in this tutorial begin with <code>com_MyTutorial_driver_HelloIOKit</code>. When GDB has completed that much, it will stop. Then you can type </p><div class="codesample"><table><tr><td scope="row"><pre>::start&lt;TAB><span></span></pre></td></tr></table></div><p>GDB will finish the entry. After GDB completes the method name (with a final closing single quote), be sure to press return.</p></li><li class="li"><p>Allow the target machine to continue. On the development machine, enter the <strong>continue</strong> command at the GDB prompt. For example:</p><div class="codesample"><table><tr><td scope="row"><pre>(gdb) continue<span></span></pre></td></tr></table></div></li><li class="li"><p>The target machine is again able to accept keyboard input. Now you can run the driver.</p></li></ol><a name="//apple_ref/doc/uid/20002367-105887" title="On Target Machine, Start Running the Device Driver"></a><a name="//apple_ref/doc/uid/20002367-105887-CHDGDGII" title="On Target Machine, Start Running the Device Driver"></a><h2>On Target Machine, Start Running the Device Driver</h2><p>Now that you have GDB attached and breakpoints set, you can start the driver running. On the target machine, do the following.</p><ol class="ol"><li class="li"><p>If you are not already there, move to the <code>/tmp</code> directory, using the <strong>cd</strong> command. For example </p><div class="codesample"><table><tr><td scope="row"><pre>$ cd /tmp<span></span></pre></td></tr></table></div></li><li class="li"><p> Start the driver running, using the <strong>kextload</strong> command. Recall that you previously loaded the driver using <strong>kextload</strong> with the <code>-l</code> option, which does not start I/O Kit matching for the driver, meaning that the code doesn't start running. You must now use <strong>kextload</strong> with the <code>-m</code> option to finish the process and run the driver. For example: </p><div class="codesample"><table><tr><td scope="row"><pre>$ sudo kextload -m HelloIOKit.kext<span></span></pre></td></tr></table></div></li><li class="li"><p>The driver executes until it hits a breakpoint. </p></li></ol><a name="//apple_ref/doc/uid/20002367-100836" title="On Development Machine, Control the Driver With GDB"></a><a name="//apple_ref/doc/uid/20002367-100836-CHDFDDHH" title="On Development Machine, Control the Driver With GDB"></a><h2>On Development Machine, Control the Driver With GDB</h2><p>Now that GDB is running on the development machine, the target machine is attached to the debugger, and the driver is running, you can actually start debugging!</p><p>The driver executes on the target machine until it hits a breakpoint. When this happens, GDB will print some status on the development machine. For example: </p><div class="codesample"><table><tr><td scope="row"><pre>Breakpoint 1, com_MyTutorial_driver_HelloIOKit::start (this=0xcdcfc0, dict=0xbcfe40) at HelloIOKit.cpp:54<span></span></pre></td></tr><tr><td scope="row"><pre>54 HelloIOKit.cpp: No such file or directory.<span></span></pre></td></tr><tr><td scope="row"><pre>Current language: auto; currently c++<span></span></pre></td></tr></table></div><p>Now you can debug your driver (almost) as you would any other executable. However, because driver debugging happens at such a low level, you won't be able to take advantage of all of GDB’s features. For example:</p><ul class="ul"><li class="li"><p>You can't call a function or method in your driver.</p></li><li class="li"><p>You can't debug interrupt routines.</p></li><li class="li"><p>Kernel debug sessions don't last indefinitely. Because you must halt the target machine's kernel to use GDB, internal inconsistencies may appear that will cause the target kernel to panic or hang, forcing you to reboot the target machine. </p></li></ul><p>For help with GDB, use its <strong>help</strong> command. Most GDB commands have shortcuts; for example, you can type <code>c</code> instead of <code>continue</code>.</p><p>Here are a few things you can do. From GDB, try the following:</p><ul class="ul"><li class="li"><p>Single step through some code (<strong>s</strong> command).</p></li><li class="li"><p>List a method's source code (<strong>l</strong> command).</p></li><li class="li"><p>Print the contents of a variable (<strong>p</strong> command). For example </p><div class="codesample"><table><tr><td scope="row"><pre>(gdb) p res<span></span></pre></td></tr></table></div></li></ul><a name="//apple_ref/doc/uid/20002367-101057" title="Stop the Debugger"></a><a name="//apple_ref/doc/uid/20002367-101057-CHDBEDEA" title="Stop the Debugger"></a><h2>Stop the Debugger</h2><p>When you've finished debugging, you should stop the debugger and then unload the driver. Do the following:</p><ol class="ol"><li class="li"><p>On the target machine, break into the kernel debugger. Briefly press the power button as described in <span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-100014">“On Target Machine, Break into Kernel Debugging Mode.”</a></span></p><p>If you’re in Console mode, you’ll see the following message on the screen:</p><div class="codesample"><table><tr><td scope="row"><pre>Debugger(Programmer Key)<span></span></pre></td></tr></table></div></li><li class="li"><p>On the development machine, enter this command at the GDB prompt:</p><div class="codesample"><table><tr><td scope="row"><pre>(gdb) quit<span></span></pre></td></tr></table></div></li><li class="li"><p>Answer yes to the prompt that appears: </p><div class="codesample"><table><tr><td scope="row"><pre>The program is<span></span></pre></td></tr><tr><td scope="row"><pre>running. Exit anyway? (y or n)<span></span></pre></td></tr></table></div></li><li class="li"><p>The target machine prints </p><div class="codesample"><table><tr><td scope="row"><pre>Remote debugger<span></span></pre></td></tr><tr><td scope="row"><pre>disconnected<span></span></pre></td></tr></table></div></li></ol><p>The debugging session ends.</p><div class="notebox"><a name="//apple_ref/doc/uid/20002367-DontLinkElementID_12" title="Note"></a><p><strong>Note:</strong>&nbsp;If your target machine is running Mac OS X Server or contains a PMU (for example, a PowerBook G4 or an early G5 desktop computer), you may find that it reboots during kernel debugging or shuts down when you exit kernel debugging mode. These problems have different causes.</p>If a breakpoint or explicit NMI causes kernel debugger entry in the middle of a PMU transaction, the PMU transaction times out after a few milliseconds. The result is that the PMU driver and the PMU hardware are now out of sync. The resulting confusion can cause the computer to shut down or stall for a period of time after you leave the debugger.</p>If you experience this, you may find that forcing the PMU driver to operate in polled mode fixes the problem. To do this, set the NVRAM variable <code>pmuflags</code> to <code>1</code> when you enable kernel debugging (see <span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-98191">“On Target Machine, Enable Kernel Debugging”</a></span>), as shown below:</p><code>$ sudo nvram boot-args="pmuflags=1"</code></p>You can set the <code>pmuflags</code> variable separately, as shown above, or you can set it at the same time you set the <code>debug</code> variable, as shown below:</p><code>$ sudo nvram boot-args="debug=0x14e pmuflags=1"</code></p>In Mac OS X Server, the watchdog daemon enables a hardware watchdog timer. That watchdog timer is designed to reboot the server if it crashes or hangs. Because the daemon that tickles this timer every 30 seconds cannot run while you are debugging, debugging is indistinguishable from a crash or hang, and thus, the watchdog timer assumes that the computer has crashed and reboots it.</p>To disable the watchdog timer, you must terminate the watchdog daemon in such a way that it exits cleanly and disables the hardware watchdog timer. To do this, issue the following command prior to entering the debugger:</p><code>$ sudo killall -TERM watchdogtimerd</code></p>For more information, see the manual page for <code><a href="../../../Reference/ManPages/man8/watchdogtimerd.8.html#//apple_ref/doc/man/8/watchdogtimerd" target="_top">watchdogtimerd(8)</a></code>.</p></div><a name="//apple_ref/doc/uid/20002367-101226" title="On Target Machine, Unload the Driver"></a><a name="//apple_ref/doc/uid/20002367-101226-CHDIIAEA" title="On Target Machine, Unload the Driver"></a><h2>On Target Machine, Unload the Driver</h2><p>On the target machine, unload the driver. Use the <strong>kextunload</strong> command. This command unloads your driver by running its termination (stop) function. For example:</p><div class="codesample"><table><tr><td scope="row"><pre>$ sudo kextunload HelloIOKit.kext<span></span></pre></td></tr><tr><td scope="row"><pre>IOCatalogueTerminate(Module com.MyTutorial.driver.HelloIOKit) [0]<span></span></pre></td></tr><tr><td scope="row"><pre>done.<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/20002367-SW1" title="Postmortem Debugging"></a><h2>Postmortem Debugging</h2><p>The previous sections assume that the target machine is accessible and has not crashed. In some cases, you may need to debug a computer that has already crashed or frozen, and thus, running kextload to generate a symbol file is not possible.</p><p>To do this, you first need a development machine of the same architecture as the target machine (Intel if your target machine is Intel, for example). Next, you need a copy of the kernel debug kit for the version of Mac OS X that is running on the target machine.</p><ol class="ol"><li class="li"><p>If the target machine is frozen (as opposed to a kernel panic), drop into the debugger on the target machine as described in the section <span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-100014">“On Target Machine, Break into Kernel Debugging Mode.”</a></span></p></li><li class="li"><p>Start the debugger on the kernel.</p><p>Enter this command:</p><div class="codesample"><table><tr><td scope="row"><pre>$ gdb -arch ppc /mach_kernel<span></span></pre></td></tr></table></div><p>Substitute <code>-arch i386</code> if your debug target is an Intel-based Macintosh. You should see output like this:</p><div class="codesample"><table><tr><td scope="row"><pre>GNU gdb 4.18-20000320 (Apple version gdb-172)<span></span></pre></td></tr><tr><td scope="row"><pre>Copyright 1998 Free Software Foundation, Inc.<span></span></pre></td></tr><tr><td scope="row"><pre>...<span></span></pre></td></tr><tr><td scope="row"><pre>(gdb)<span></span></pre></td></tr></table></div></li><li class="li"><p>Tell the debugger that you're remotely debugging a device driver.</p><p>At the GDB prompt, enter this command:</p><div class="codesample"><table><tr><td scope="row"><pre>(gdb) target remote-kdp<span></span></pre></td></tr></table></div></li><li class="li"><p>Attach to the remote machine with the following command:</p><div class="codesample"><table><tr><td scope="row"><pre>kdp-reattach 192.168.1.47<span></span></pre></td></tr></table></div><p>Substitute the actual IP number of the remote machine.</p></li><li class="li"><p>Once you have connected to the target, you must load the GDB macros from the kernel debug kit by issuing the following command:</p><div class="codesample"><table><tr><td scope="row"><pre>source /Volumes/KernelDebugKit/kgmacros<span></span></pre></td></tr></table></div></li><li class="li"><p>Assuming the target machine is configured to display panic text, you already have a list of KEXTs involved in the panic. If not, you can get this information by typing the following command:</p><div class="codesample"><table><tr><td scope="row"><pre>paniclog<span></span></pre></td></tr></table></div><p>If the target machine is not in a panicked state, you can obtain a list of KEXT load addresses by typing one of two commands. If you are running Mac OS X v10.4 or earlier, use the following command:</p><div class="codesample"><table><tr><td scope="row"><pre>showallkmods<span></span></pre></td></tr></table></div><p>Otherwise, use the following command:</p><div class="codesample"><table><tr><td scope="row"><pre>showallkexts<span></span></pre></td></tr></table></div><p>The debugger will then display a list of KEXTs and their load addresses.</p></li><li class="li"><p>Once you have a list of KEXT load addresses, you must create symbol files for the relevant extension(s). For each KEXT that you care about, issue the following command in a new terminal window on the development machine:</p><div class="codesample"><table><tr><td scope="row"><pre>sudo kextload -n -k /Volumes/KernelDebugKit/mach_kernel -s  /tmp /path/to/the/desired.kext<span></span></pre></td></tr></table></div></li></ol><p>After you have generated symbols for all relevant KEXTs, you can continue following the steps in this tutorial beginning with the section <span class="content_text"><a href="hello_debugger.html#//apple_ref/doc/uid/20002367-99595">“On Development Machine, Import the Symbol File,”</a></span> skipping any steps you have already performed in this section.</p><a name="//apple_ref/doc/uid/20002367-101290" title="Where to Go Next"></a><h2>Where to Go Next</h2><p>Congratulations! You've now learned how to set up a two-machine debugging environment to debug a driver (or another type of KEXT) using GDB.</p><p>If you're interested, you can use the <code><a href="../../../Reference/ManPages/man1/man.1.html#//apple_ref/doc/man/1/man" target="_top">man(1)</a></code> command to read the manual pages for <code><a href="../../../Reference/ManPages/man8/kextload.8.html#//apple_ref/doc/man/8/kextload" target="_top">kextload(8)</a></code>, <code><a href="../../../Reference/ManPages/man8/kextstat.8.html#//apple_ref/doc/man/8/kextstat" target="_top">kextstat(8)</a></code>, and <code><a href="../../../Reference/ManPages/man8/kextunload.8.html#//apple_ref/doc/man/8/kextunload" target="_top">kextunload(8)</a></code>. In particular, you may want to read about the many ways to use <strong>kextload</strong> to get debug symbols for all types of KEXTs, including I/O Kit drivers. For example, from a Terminal window, enter the following command:</p><div class="codesample"><table><tr><td scope="row"><pre>$ man kextload<span></span></pre></td></tr></table></div><p>You may also want to familiarize yourself with GDB. Further information is available in <span class="content_text"><a href="http://developer.apple.com/documentation/DeveloperTools/index.html" target="_top">Tools Documentation</a></span>.</p>

        <br/><br/> 

        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../KEXTConceptIOKit/hello_iokit.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../KEXTConceptPackaging/packaging_kext.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2003, 2007 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2007-10-31<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Darwin/Conceptual/KEXTConcept/KEXTConceptDebugger/hello_debugger.html%3Fid%3DTP40001063-3.7&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Darwin/Conceptual/KEXTConcept/KEXTConceptDebugger/hello_debugger.html%3Fid%3DTP40001063-3.7&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Darwin/Conceptual/KEXTConcept/KEXTConceptDebugger/hello_debugger.html%3Fid%3DTP40001063-3.7&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>
