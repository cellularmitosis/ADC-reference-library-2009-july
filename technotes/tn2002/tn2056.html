<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- BEGIN META TAG INFO --><link rel="home" href="http://developer.apple.com/">
<link rel="find" href="http://developer.apple.com/search/">
<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
<script language="JavaScript" type="text/javascript" src="../../documentation/js/busnav.js"></script><script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script><!-- END META TAG INFO --><!-- BEGIN TITLE --><title>Technical Note TN2056: Installable Keyboard Layouts</title>
<!-- END TITLE --><style>
			.sourcecodebox {
				white-space: pre-wrap;
				white-space: -moz-pre-wrap !important;
				white-space: -pre-wrap;
				white-space: -o-pre-wrap;
				word-wrap: break-word;
			}
			</style>
</head>
<!-- BEGIN BODY OPEN --><body bgcolor="#ffffff"><a name="//apple_ref/doc/uid/DTS10003085" title="Installable Keyboard Layouts"></a>
<!-- END BODY OPEN --><!-- START CENTER OPEN --><center>
<!-- END CENTER OPEN --><a name="top"></a><!-- BEGIN LOGO AND SEARCH --><!--#include virtual="/includes/adcnavbar" --><!-- END LOGO AND SEARCH --><!-- START BREADCRUMB --><div id="breadcrumb"><table width="680" border="0" cellpadding="0" cellspacing="0">
<tr>
<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
</tr>
<tr valign="middle"><td align="left" colspan="2">
<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/UserExperience/index.html">User Experience</a> &gt; <a href="../../technicalnotes/UserExperience/idxHumanInterfaceDeviceForceFeedback-date.html">Human Interface Device &amp; Force Feedback</a> &gt; </td></tr>
<tr><td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td></tr>
</table></div>
<!-- END BREADCRUMB --><!-- START MAIN CONTENT --><!-- START TITLE GRAPHIC AND INTRO --><table width="680" border="0" cellpadding="0" cellspacing="0"><tr align="left" valign="top"><td><h1>
<div id="pagehead">Technical Note TN2056</div>
<div id="pageheadsub">Installable Keyboard Layouts</div>
</h1></td></tr></table>
<!-- END TITLE GRAPHIC AND INTRO --><!-- BEGIN WIDE COLUMN --><table width="680" border="0" cellpadding="0" cellspacing="0"><tr align="left" valign="top"><td align="left" width="680">
<!-- BEGIN CONTENTS --><table width="680" border="0" cellpadding="0" cellspacing="0">
<tr align="left" valign="top"><td>
<p>Mac OS X 10.2 adds the ability to install a new keyboard layout by putting a file or bundle in a standard folder. </p>
<p>It is also now possible to define a Unicode keyboard via an XML text file. These keyboards have the same set of capabilities as the <code>'uchr'</code> resource keyboards defined in the document "Supporting Unicode Input." In fact, the XML file is translated to the uchr format and then handled in exactly the same way.</p>
</td></tr>
<tr><td scope="row">
<img width="680" height="10" src="images/1dot.gif" alt=""><br><img width="680" height="1" src="images/1dot_919699.gif" alt=""><br><img width="680" height="20" src="images/1dot.gif" alt="">
</td></tr>
</table>
<table width="680" border="0" cellpadding="0" cellspacing="0">
<tr align="left" valign="top"><td width="680"><ul>
<li><a href="#SECTION1">Installation</a></li>
<li><a href="#SECTION2">Supported Keyboard Data Formats</a></li>
<li><a href="#SECTION3">XML DTD</a></li>
<li><a href="#SECTION4">XML File Structure</a></li>
<ul>
<li><a href="#SECTION4-_KEYBOARD__ELEMENT">&lt;keyboard&gt; Element</a></li>
<li><a href="#SECTION4-_LAYOUTS__ELEMENT">&lt;layouts&gt; Element</a></li>
<li><a href="#SECTION4-_LAYOUT__ELEMENT">&lt;layout&gt; Element</a></li>
<li><a href="#SECTION4-_MODIFIERMAP__ELEMENT">&lt;modifierMap&gt; Element</a></li>
<li><a href="#SECTION4-_KEYMAPSELECT__ELEMENT">&lt;keyMapSelect&gt; Element</a></li>
<li><a href="#SECTION4-_MODIFIER__ELEMENT">&lt;modifier&gt; Element</a></li>
<li><a href="#SECTION4-_KEYMAPSET__ELEMENT">&lt;keyMapSet&gt; Element</a></li>
<li><a href="#SECTION4-_KEYMAP__ELEMENT">&lt;keyMap&gt; Element</a></li>
<li><a href="#SECTION4-_KEY__ELEMENT">&lt;key&gt; Element</a></li>
<li><a href="#SECTION4-_ACTIONS__ELEMENT">&lt;actions&gt; Element</a></li>
<li><a href="#SECTION4-_ACTION__ELEMENT">&lt;action&gt; Element</a></li>
<li><a href="#SECTION4-_WHEN__ELEMENT">&lt;when&gt; Element</a></li>
<li><a href="#SECTION4-_TERMINATORS__ELEMENT">&lt;terminators&gt; Element</a></li>
</ul>
<li><a href="#A_COMPLETE_DEAD_KEY_EXAMPLE">A Complete Dead Key Example</a></li>
<li><a href="#REFERENCES">References</a></li>
<li><a href="#document_revision_summary">Document Revision History</a></li>
</ul></td></tr>
<tr><td colspan="3" scope="row">
<img width="680" height="10" src="images/1dot.gif" alt=""><br><img width="680" height="1" src="images/1dot_919699.gif" alt=""><br><img width="680" height="20" src="images/1dot.gif" alt="">
</td></tr>
</table>
<a name="SECTION1"></a><h2>Installation</h2>
<p>Keyboard layouts can be installed in one of the following locations:</p>
<pre class="sourcecodebox">/Library/Keyboard Layouts/

~/Library/Keyboard Layouts/

/Network/Library/Keyboard Layouts/</pre>
<p>Resources in <code>/Library/</code> are shared among all users on a given machine. Resources in <code>~/Library/</code> are visible only to that user. Resources in <code>/Network/Library/</code> are shared among all users on a network.</p>
<p>Keyboards have ID numbers which uniquely identify them; these are not shown to the end user. If the system detects two or more keyboards with the same ID number, it will renumber keyboards as necessary to eliminate the conflict.</p>
<p>After installing a new keyboard, the user must log out and then log in again to make the keyboard available.</p>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="SECTION2"></a><h2>Supported Keyboard Data Formats</h2>
<p>There are several different formats that are supported:</p>
<ol>
<li>
<p>Old-style Keyboard Suitcase (resource file)</p>
<p>Keyboard.rsrc (resource file containing <code>KCHR</code>, <code>uchr</code>, <code>itlk</code>, <code>kcns</code>, <code>kcs#</code>, <code>kcs4</code>, <code>kcs8</code> resources)</p>
<p>The name of the keyboard comes from the resource name of the <code>KCHR/uchr,</code> and cannot be localized. The encoding used is that of the script to which the keyboard belongs, or UTF-8 for Unicode keyboards (negative IDs). The resource file may have one or more keyboards in it. The resources may be in either the resource fork or the data fork (not both); the file extension must be <code>.rsrc</code>.</p>
<p>Icons may be in the kcns resource format, which is new for Mac OS X and is the same as the icns icon format, or in the older <code>kcs#/kcs4/kcs8</code> format used on Mac OS 9. If no icon resources are present, the keyboard will have a generic icon in the input menu and in International Preferences.</p>
<p>To use a Mac OS 9 keyboard suitcase, append the file extension <code>.rsrc</code>.</p>
</li>
<li>
<p>Localized Keyboard Suitcase Bundle </p>
<pre class="sourcecodebox"> Roman.bundle/
        Contents/
            Info.plist
            Resources/
                MyLayouts.rsrc
                English.lproj/
                    InfoPlist.strings
            version.plist</pre>
<pre class="sourcecodebox"> InfoPlist.strings file contents:
        "U.S." = "U.S.";
        "Australian" = "Australian";
        "Austrian" = "Austrian";
        ...</pre>
<p>The <code>Info.plist</code> and <code>version.plist</code> files follow standard bundle conventions. The bundle identifier must take the form <code>com.apple.keyboardlayout.name</code>.</p>
<p>The <code>MyLayouts.rsrc</code> file (which may have any name but must have the extension <code>.rsrc</code>) contains sets of <code>KCHR</code>, <code>uchr</code>, <code>itlk</code>, <code>kcns</code>, <code>kcs#</code>, <code>kcs4</code>, and <code>kcs8</code> resources.</p>
<p>The resource file may have one or more keyboards in it; icons are as for format 1. The keyboard layout names may be localized via the <code>InfoPlist.strings</code> file within the various <code>.lproj</code> folders. The unlocalized key (left hand side) will be the same as the keyboard resource name, in Unicode rather than its native encoding. For example, a Roman <code>KCHR</code> resource would have its resource name in MacRoman, but the key in the <code>InfoPlist.strings</code> file must be the Unicode equivalent.</p>
<p>This format supports resources in the data fork only.</p>
</li>
<li>
<p>XML Keyboard Definition</p>
<p>This must be a valid text XML file following the specification later in this document, and must have the extension <code>.keylayout</code>. As discussed below, the name is always in Unicode, but it cannot be localized.</p>
<p><code>Mykeyboard.keylayout</code></p>
<p>After installation, an XML keyboard will become available in the Input Menu pane of International Preferences if no errors were encountered in compiling it. If there is an error in the file, an error message will be written to <code>console.log</code>, prefixed by "uchr XML compiler." If the error is an XML syntax error, the line in the file where the error occurred is given. Usually, only the first error encountered is diagnosed, and parsing is aborted.</p>
<p>Since <code>console.log</code> is erased when you log out and log in, to see error messages, force the keyboard to compile by opening International Preferences and switching to the Input Menu pane. Launching an application and typing will also force all keyboards to compile if the modification date of the directory has changed. If the keyboard does not appear in International Preferences, you can then check in <code>console.log</code> for error messages. To fource the modification date on the directory to change, you can use the Unix <code>touch</code> command.</p>
<p>Keyboards in this format can have an optional associated icon file, in the standard <code>icns</code> format; it has the same name as the keyboard file with the extension <code>.icns</code>:</p>
<p><code>Mykeyboard.icns</code></p>
<p>If this file is absent, the keyboard will have a generic icon in the input menu and in International Preferences.</p>
</li>
<li>
<p>Localized XML Keyboard Bundle </p>
<pre class="sourcecodebox"> MyKeyboards.bundle/
        Contents/
            Info.plist
            Resources/
                MyKeyboard1.keylayout
                MyKeyboard1.icns
                MyKeyboard2.keylayout
                MyKeyboard2.icns
                English.lproj/
                    InfoPlist.strings
                version.plist</pre>
<pre class="sourcecodebox"> InfoPlist.strings file contents:
        "MyKeyboard1" = "MyKeyboard1";
        "MyKeyboard2" = "MyKeyboard2";</pre>
<p>This format supports localized names for XML keyboards. The bundle may contain multiple XML files ending in <code>.keylayout</code>. Localization is as for format 2 above. The <code>.icns</code> file is optional for each keyboard; if it is absent, the keyboard has a generic icon in the input menu and in International Preferences.</p>
</li>
</ol>
<p>The rest of this document discusses the new XML keyboard data format.</p>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="SECTION3"></a><h2>XML DTD</h2>
<p>XML keyboards must follow the XML DTD (Document Type Definition) below:</p>
<pre class="sourcecodebox">&lt;!-- Overall structure --&gt;
&lt;!ELEMENT keyboard (layouts+, modifierMap+, keyMapSet+, actions*, terminators*)&gt;
&lt;!ATTLIST keyboard group NMTOKEN #REQUIRED &gt;
&lt;!ATTLIST keyboard id NMTOKEN #REQUIRED &gt;
&lt;!ATTLIST keyboard name CDATA #REQUIRED &gt;
&lt;!ATTLIST keyboard maxout NMTOKEN #IMPLIED &gt;

&lt;!-- Hardware layout elements --&gt;
&lt;!ELEMENT layouts (layout+) &gt;
&lt;!ELEMENT layout EMPTY &gt;
&lt;!ATTLIST layout first NMTOKEN #REQUIRED &gt;
&lt;!ATTLIST layout last NMTOKEN #REQUIRED &gt;
&lt;!ATTLIST layout modifiers IDREF #REQUIRED &gt;
&lt;!ATTLIST layout mapSet IDREF #REQUIRED &gt;

&lt;!-- Modifier descriptions --&gt;
&lt;!ELEMENT modifierMap (keyMapSelect+) &gt;
&lt;!ATTLIST modifierMap id ID #REQUIRED &gt;
&lt;!ATTLIST modifierMap defaultIndex NMTOKEN #REQUIRED &gt;

&lt;!ELEMENT keyMapSelect (modifier+) &gt;
&lt;!ATTLIST keyMapSelect mapIndex NMTOKEN #REQUIRED &gt;

&lt;!ELEMENT modifier EMPTY &gt;
&lt;!ATTLIST modifier keys CDATA #REQUIRED &gt;

&lt;!-- Keyboard mapping --&gt;
&lt;!ELEMENT keyMapSet (keyMap+) &gt;
&lt;!ATTLIST keyMapSet id ID #REQUIRED &gt;

&lt;!ELEMENT keyMap (key+) &gt;
&lt;!ATTLIST keyMap index NMTOKEN #REQUIRED &gt;
&lt;!ATTLIST keyMap baseMapSet IDREF #IMPLIED &gt;
&lt;!ATTLIST keyMap baseIndex NMTOKEN #IMPLIED &gt;

&lt;!ELEMENT key (action*) &gt;
&lt;!ATTLIST key code NMTOKEN #REQUIRED &gt;
&lt;!ATTLIST key output CDATA #IMPLIED &gt;
&lt;!ATTLIST key action IDREF #IMPLIED &gt;

&lt;!-- Actions (state records) --&gt;
&lt;!ELEMENT actions (action+) &gt;
&lt;!ELEMENT action (when+) &gt;
&lt;!ATTLIST action id ID #IMPLIED &gt;

&lt;!ELEMENT when EMPTY &gt;
&lt;!ATTLIST when state NMTOKEN #REQUIRED &gt;
&lt;!ATTLIST when through NMTOKEN #IMPLIED &gt;
&lt;!ATTLIST when output CDATA #IMPLIED &gt;
&lt;!ATTLIST when multiplier NMTOKEN #IMPLIED &gt;
&lt;!ATTLIST when next NMTOKEN #IMPLIED &gt;

&lt;!-- Terminators --&gt;
&lt;!ELEMENT terminators (when+) &gt;</pre>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="SECTION4"></a><h2>XML File Structure</h2>
<p>A keyboard layout description is a standard XML file, and so follows the XML specification. The text file encoding should be Unicode, either UTF-8 or UTF-16. It's a good idea to have both <code>xml</code> and <code>DOCTYPE</code> directives at the beginning of the file, to clearly identify it:</p>
<pre class="sourcecodebox">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE keyboard SYSTEM "file://localhost/System/Library/DTDs/KeyboardLayout.dtd"&gt;</pre>
<a name="SECTION4-_KEYBOARD__ELEMENT"></a><h3>&lt;keyboard&gt; Element</h3>
<p>The top level element is <code>&lt;keyboard&gt;</code>. <code>&lt;keyboard&gt;</code> has the following attributes, all of which are required:</p>
<p class="smalltext"><strong>Table 1 : </strong>keyboard element attributes</p>
<table cellspacing="0" class="graybox">
<tr>
<th><code>group</code></th>
<td scope="row">The section of the keyboard menu in which this layout should appear. Right now, this is the script code. Unicode keyboards have a script code of 126.</td>
</tr>
<tr>
<th><code>id</code></th>
<td scope="row">The unique ID for the keyboard. Right now, this is numeric, and must match the script bundle specified in "<code>group</code>". Unicode keyboards have negative IDs. If this ID collides with that of another keyboard, the system will assign a new ID. See further discussion below.</td>
</tr>
<tr>
<th><code>name</code></th>
<td scope="row">The name of the keyboard, to appear in the Keyboard Menu. This is in whatever encoding the keyboard file itself is in (e.g., UTF-8 or UTF-16), not the encoding corresponding to the script of the keyboard. Note that this name cannot be localized, but it is possible to localize the names of keyboards using the bundle mechanism.</td>
</tr>
<tr>
<th></th>
<td scope="row">The following attribute is optional:</td>
</tr>
<tr>
<th><code>maxout</code></th>
<td scope="row">The maximum number of UTF-16 values that can be generated from one keypress.</td>
</tr>
</table>
<p>The keyboard element must contain exactly one <code>&lt;layouts&gt;</code> element, one or more <code>&lt;modifierMap&gt;</code> elements, one or more <code>&lt;keyMapSet&gt;</code> elements, an optional <code>&lt;actions&gt;</code> element, and an optional <code>&lt;terminators&gt;</code> element.</p>
<p>Unicode Keyboards (uchr or XML) can be divided into two classes. The first are those associated with a particular Mac OS script code. These keyboards should normally only generate Unicode strings that can be converted to the encoding associated with the script. The scripts (and associated codes) supported in Mac OS X are Roman (0), Japanese (1), Simplified Chinese (25), Traditional Chinese(2), Korean (3), Cyrillic (7), and Central European (29); there are no plans to support any other scripts. This type of keyboard is available to both Unicode and non-Unicode (WorldScript) applications.</p>
<p>It is possible for a keyboard associated with a script to generate Unicode strings that cannot be converted to the associated encoding. This has the disadvantage that such strings will cause question marks (?) to appear in non-Unicode applications. For example, the Kotoeri Japanese input method can generate any Unicode character, but characters outside MacJapanese are only supported in Unicode applications.</p>
<p>The second class of keyboards generate Unicode characters not associated with any of the scripts listed above. Such keyboards are only available to Unicode applications, and have negative id values. They should be assigned to group 126.</p>
<p>A good rule of thumb in deciding whether to associate a keyboard with a script code or not is whether "typical" text typed with the keyboard fits entirely within the script's character encoding. It is best to be conservative as users will have trouble understanding why they are getting ?'s in their WorldScript applications.</p>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="SECTION4-_LAYOUTS__ELEMENT"></a><h3>&lt;layouts&gt; Element</h3>
<p>The <code>&lt;layouts&gt;</code> element has no attributes, and contains one or more <code>&lt;layout&gt;</code> elements. Collectively, these elements define which <code>&lt;modifierMap&gt;</code> and <code>&lt;keyMapSet&gt;</code> elements control the mapping of keys for particular hardware keyboards.</p>
<p>The <code>&lt;layout&gt;</code> element which is physically first controls the mapping of keyboards whose IDs are not contained within the range of IDs for any <code>&lt;layout&gt;</code> element.</p>
<p>Apple will map new keyboard hardware IDs to one of the existing ones, so it is usually sufficient to copy and paste the entire <code>&lt;layouts&gt;</code> element from an existing keyboard layout.</p>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="SECTION4-_LAYOUT__ELEMENT"></a><h3>&lt;layout&gt; Element</h3>
<p>The <code>&lt;layout&gt;</code> element is an empty element (i.e., it has no subelements and is written in the empty form: <code>&lt;layout /&gt;</code>). It defines which <code>&lt;modifierMap&gt;</code> and <code>&lt;keyMapSet&gt;</code> to use for a particular range of hardware keyboard IDs. It has the following attributes, all of which are required:</p>
<p class="smalltext"><strong>Table 2 : </strong>layout element attributes</p>
<table cellspacing="0" class="graybox">
<tr>
<th><code>first</code></th>
<td scope="row">The hardware ID of the first keyboard type controlled by this element.</td>
</tr>
<tr>
<th><code>last</code></th>
<td scope="row">The hardware ID of the last keyboard type controlled by this element</td>
</tr>
<tr>
<th><code>modifiers</code></th>
<td scope="row">The identifier of the <code>&lt;modifierMap&gt;</code> element to use for this range of hardware keyboard types.</td>
</tr>
<tr>
<th><code>mapSet</code></th>
<td scope="row">The identifier of the <code>&lt;mapSet&gt;</code> element to use for this range of hardware keyboard types.</td>
</tr>
</table>
<p>Example:</p>
<pre class="sourcecodebox">&lt;layouts&gt;
 &lt;layout first="0" last="17" modifiers="commonModifiers" mapSet="ANSI" /&gt;
 &lt;layout first="18" last="18" modifiers="commonModifiers" mapSet="JIS" /&gt;
 &lt;layout first="21" last="23" modifiers="commonModifiers" mapSet="JIS" /&gt;
 &lt;layout first="30" last="30" modifiers="commonModifiers" mapSet="JIS" /&gt;
 &lt;layout first="194" last="194" modifiers="commonModifiers" mapSet="JIS" /&gt;
 &lt;layout first="197" last="197" modifiers="commonModifiers" mapSet="JIS" /&gt;
 &lt;layout first="200" last="201" modifiers="commonModifiers" mapSet="JIS" /&gt;
 &lt;layout first="206" last="207" modifiers="commonModifiers" mapSet="JIS" /&gt;
&lt;/layouts&gt;</pre>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="SECTION4-_MODIFIERMAP__ELEMENT"></a><h3>&lt;modifierMap&gt; Element</h3>
<p>The <code>&lt;modifierMap&gt;</code> element defines the mapping of modifier key combinations to <code>&lt;keyMap&gt;</code> table numbers. The element contains one or more <code>&lt;keyMapSelect&gt;</code> elements, each of which correspond to one <code>&lt;keyMap&gt;</code> table.</p>
<p>There are two required attributes:</p>
<p class="smalltext"><strong>Table 3 : </strong>Required modifierMap attributes</p>
<table cellspacing="0" class="graybox">
<tr>
<th><code>id</code></th>
<td scope="row">An arbitrary string, used to identify this <code>&lt;modifierMap&gt;</code> elsewhere (currently, only in the <code>&lt;layout&gt;</code> element). This identifier must be unique across all <code>&lt;modifierMap&gt;</code> elements. </td>
</tr>
<tr>
<th><code>defaultIndex</code></th>
<td scope="row">The table number to use for modifier key combinations which are not explicitly specified by any <code>&lt;modifier&gt;</code> element within the <code>&lt;modifierMap&gt;</code>. </td>
</tr>
</table>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="SECTION4-_KEYMAPSELECT__ELEMENT"></a><h3>&lt;keyMapSelect&gt; Element</h3>
<p>This element defines the set(s) of modifier keys which cause a particular key mapping table to be selected. It contains one or more <code>&lt;modifier&gt;</code> elements, each of which specifies modifer key combinations. Every entry in the modifier mapping table which matches one of the specified modifier key combinations is filled in with this table number. The <code>&lt;keyMapSelect&gt;</code> elements are processed in sequence, so if two or more <code>&lt;keyMapSelect&gt;</code> elements specify the same combination(s) of modifier keys, the later ones will overwrite the earlier ones.</p>
<p>There is one required attribute:</p>
<p class="smalltext"><strong>Table 4 : </strong>Required keyMapSelect attribute</p>
<table cellspacing="0" class="graybox"><tr>
<th><code>mapIndex</code></th>
<td scope="row">A table number, starting from 0, to which modifier key combinations specified by <code>&lt;modifier&gt;</code> elements within this <code>&lt;keyMapSelect&gt;</code> element should be mapped. The table numbers should be contiguous and compact as the underlying implementation uses an array. </td>
</tr></table>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="SECTION4-_MODIFIER__ELEMENT"></a><h3>&lt;modifier&gt; Element</h3>
<p>This element specifies one or more sets of modifier key combinations which should map to the table number specified in the enclosing <code>&lt;keyMapSelect&gt;</code> element. This element is empty in the XML sense (it's written as <code>&lt;modifier /&gt;</code>). There is one required attribute:</p>
<p class="smalltext"><strong>Table 5 : </strong>Required modifier element attribute</p>
<table cellspacing="0" class="graybox"><tr>
<th><code>keys</code></th>
<td scope="row">A string specifying one or more combinations of modifier keys. The string consists of one or more of the following separated by whitespace: <ul>
<li><p><code>shift</code> - The left Shift key</p></li>
<li><p><code>rightShift</code> - The right Shift key</p></li>
<li><p><code>anyShift</code> - Matches either the left or right Shift key</p></li>
<li><p><code>option</code> - The left Option key</p></li>
<li><p><code>rightOption</code> - The right Option key</p></li>
<li><p><code>anyOption</code> - Matches either the left or right Option key</p></li>
<li><p><code>control</code> - The left Control key</p></li>
<li><p><code>rightControl</code> - The right Control key</p></li>
<li><p><code>anyControl</code> - Any Control key</p></li>
<li><p><code>command</code> - The Command key</p></li>
<li><p><code>caps</code> - the Caps Lock key</p></li>
</ul>
</td>
</tr></table>
<p>The presence of a word means that the corresponding modifier must be pressed. The absence of a word means that the corresponding modifier must not be pressed. A word followed by <code>?</code> indicates that the state of the modifier is irrelevant (it may be either pressed or not pressed). For example, <code>command?</code> means that this modifier element selects modifier key combinations with the command key either pressed or not pressed (i.e., the state of the command key is irrelevant).</p>
<p>An "any" modifier matches modifier key combinations where either or both of the left and right keys are pressed. For example, "<code>anyShift</code>" will match modifier key combinations where the left Shift key, the right Shift key, or both are pressed; it will not match combinations where neither is pressed. "<code>anyShift</code>?" will match all combinations of modifier keys where either or both of the Shift keys are either pressed or not.</p>
<p>Note that many hardware keyboards do not have both left and right versions of a modifier key. It is usually safest to specify modifers in terms of the "any" variants (<code>anyShift</code>, <code>anyOption</code>, <code>anyControl</code>).</p>
<pre class="sourcecodebox">&lt;modifier keys="anyShift? anyOption caps?" /&gt;</pre>
<p>This specification will match all modifier key combinations where either the left or right Option key is pressed (or both are pressed), and the command key and left and right Control keys are not pressed. The state of the Shift and Caps Lock keys are irrelevant.</p>
<pre class="sourcecodebox">&lt;modifier keys="caps" /&gt;
&lt;modifier keys="command" /&gt;</pre>
<p>This specification will match all modifier key combinations where either caps lock key is down with no other modifiers, or the command key is down with no other modifiers.</p>
<pre class="sourcecodebox">&lt;modifier keys="" /&gt;
&lt;modifier keys="anyShift command caps?" &gt;
&lt;modifier keys="anyShift? command caps" /&gt;</pre>
<p>This specification will match modifier key combinations where</p>
<ul>
<li><p>No modifier keys are down</p></li>
<li><p>Either shift key and the command key are down, and control and option are up. </p></li>
<li><p>The caps lock key and the command key are down, and control and option are up. </p></li>
</ul>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="SECTION4-_KEYMAPSET__ELEMENT"></a><h3>&lt;keyMapSet&gt; Element</h3>
<p>This element collects a set of tables that are used to map from key presses to results. Typically there is one set for each class of hardware keyboard. Since the ISO keyboard used in Europe can be handled with the same layout as the ANSI keyboard used in the US, that leaves ANSI and JIS (used in Japan) as the two classes that need to be handled.</p>
<p>This element contains one or more <code>&lt;keyMap&gt;</code> elements, each of which specifies a particular mapping from virtual key codes to results. Typically there will be one such table for each relevant combination of modifier keys.</p>
<p>There is one required attribute:</p>
<p class="smalltext"><strong>Table 6 : </strong>Required keyMapSet element attribute</p>
<table cellspacing="0" class="graybox"><tr>
<th><code>id</code></th>
<td scope="row">A string which serves as an identifier for this <code>keyMapSet</code> when referenced from elsewhere in the XML file. This identifier must be unique across all <code>keyMapSet</code> elements. </td>
</tr></table>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="SECTION4-_KEYMAP__ELEMENT"></a><h3>&lt;keyMap&gt; Element</h3>
<p>This element specifies a particular mapping from virtual key codes to results. It contains one or more <code>&lt;key&gt;</code> elements which specify what to do when a particular virtual key code is received. The size of the resulting mapping table is determined by the largest virtual key code specified by any table in the <code>keyMapSet</code>; unspecified entries are filled with null results (they don't do anything, in other words). There are one required and two optional attributes:</p>
<p class="smalltext"><strong>Table 7 : </strong>Required keyMap element attributes</p>
<table cellspacing="0" class="graybox">
<tr>
<th><code>index</code></th>
<td scope="row">The table number. This is referenced from the <code>&lt;keyMapSelect&gt;</code> element. </td>
</tr>
<tr>
<th><code>baseMapSet</code></th>
<td scope="row">The identifier of a base map set containing a <code>&lt;keyMap&gt;</code> element of which this element is a modification. <code>&lt;key&gt;</code> entries within the current element override entries from the specified base <code>&lt;keyMap&gt;</code> element. Virtual key codes not overridden are copied from the base element. If this attribute is present then the baseIndex attribute must also be present.</td>
</tr>
<tr>
<th><code>baseIndex</code></th>
<td scope="row">The table number of a <code>&lt;keyMap&gt;</code> element within the <code>&lt;keyMapSet&gt;</code> specified by <code>baseMapSet</code>. <code>&lt;key&gt;</code> entries within the current element override entries from the specified base <code>&lt;keyMap&gt;</code> element. Virtual key codes not overridden are copied from the base element. If this attribute is present then the <code>baseMapSet</code> attribute must also be present.</td>
</tr>
</table>
<p>Typically the <code>baseMapSet</code> and <code>baseIndex</code> are used to provide overrides for a kind of hardware keyboard. The most frequent usage is to provide differences between the ANSI keyboard layout and the JIS keyboard layout, e.g.:</p>
<pre class="sourcecodebox">&lt;keyMapSet id="JIS"&gt;
    &lt;keyMap index="0" baseMapSet="ANSI" baseIndex="0"&gt;
    (overrides of ANSI layout for JIS keyboards)</pre>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="SECTION4-_KEY__ELEMENT"></a><h3>&lt;key&gt; Element</h3>
<p>This element specifies what to do when a particular virtual key code is received. The element may be empty or non-empty; it is only non-empty if an action is specified inline.</p>
<p>The following attribute is required:</p>
<p class="smalltext"><strong>Table 8 : </strong>Required key element attribute</p>
<table cellspacing="0" class="graybox"><tr>
<th><code>code</code></th>
<td scope="row">The decimal number of the virtual key code which this <code>&lt;key&gt;</code> element maps. This number must be unique across all <code>&lt;key&gt;</code> elements within a particular <code>&lt;keyMap&gt;</code> element. (You can't map the same key in two different ways.)</td>
</tr></table>
<p>It is intended that at some point named entities will be available to specify the key codes, but this is not yet implemented.</p>
<p>The <code>&lt;key&gt;</code> element takes one of three different forms:</p>
<ol>
<li>
<pre class="sourcecodebox">&lt;key code="virtualkeycode" output="string" /&gt;</pre>
<p>When the given virtual key code is received, the specified string of UTF-16 values is unconditionally output. The string must have at least one UTF-16 code point, and may contain any character legal in an XML attribute value. Literal characters are not limited to ASCII, and since XML files are themselves encoded in Unicode, many characters can be typed directly.</p>
<p>Unicode scalar values may be specified using an XML numeric character entity, either in decimal or hexadecimal. Unicode scalar values outside Plane 0 are specified by a single numeric character entity, not two; this is converted to two UTF-16 values (a surrogate pair). Characters which are illegal in XML (<code> &lt; </code> and <code>"</code>, and C0 control values among others) must be specified via a numeric character entity. Named entities are not supported.</p>
<p><strong>Example:</strong></p>
<pre class="sourcecodebox">&lt;key code="0" output="“Wow!&amp;#8594;&amp;#x2000B;”" /&gt;</pre>
<p>This &lt;key&gt; element specifies that when virtual key 0 ("a" on the US keyboard layout) is struck, the Unicode string:</p>
<pre class="sourcecodebox">“Wow!</pre>
<p>followed by <code>U+2192 RIGHTWARDS ARROW</code> followed by <code>U+2000B</code> (a plane 2 ideograph, represented by a surrogate pair) followed by</p>
<pre class="sourcecodebox">”</pre>
<p>is output. The entire UTF-16 string in hex is:</p>
<pre class="sourcecodebox">201C 0057 006F 0077 0021 2192 D840 DC0B 201D</pre>
</li>
<li>
<pre class="sourcecodebox">&lt;key code="virtualkeycode" action="name" /&gt;</pre>
<p>When the given virtual key code is received, the named action is executed. Actions are specified via the <code>&lt;actions&gt;</code> element; see below.</p>
</li>
<li>
<pre class="sourcecodebox">&lt;key code="virtualkeycode"&gt;
    &lt;action&gt;
        (an anonymous action)
    &lt;/action&gt;
&lt;/key&gt;</pre>
<p>When the given virtual key code is received, the single <code>&lt;action&gt;</code> element within the <code>&lt;key&gt;</code> element is executed. The result is the same as if the <code>&lt;action&gt;</code> element were specified within the <code>&lt;actions&gt;</code> element and referred to by name as in the second form, above. Note that anonymous actions specified in this way cannot be referenced by multiple <code>&lt;keyMap&gt;</code> tables, except through the copying mechanism (<code>baseMapSet</code> and <code>baseIndex</code>).</p>
</li>
</ol>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="SECTION4-_ACTIONS__ELEMENT"></a><h3>&lt;actions&gt; Element</h3>
<p>The <code>&lt;actions&gt;</code> element is optional. There may be at most one per XML document. It contains one or more <code>&lt;action&gt;</code> elements, specifying named actions which may be referred to from the <code>&lt;key&gt;</code> elements.</p>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="SECTION4-_ACTION__ELEMENT"></a><h3>&lt;action&gt; Element</h3>
<p>The <code>&lt;action&gt;</code> element specifies a set of actions to take based on the current state of the state machine. This is specified by one or more <code>&lt;when&gt;</code> elements, each of which specifies one or more states, and an action to take when the action is executed and the current state matches. There is one attribute:</p>
<p class="smalltext"><strong>Table 9 : </strong>action element attribute</p>
<table cellspacing="0" class="graybox"><tr>
<th><code>id</code></th>
<td scope="row">An arbitrary string identifying this action. It must be unique across all <code>&lt;action&gt;</code> elements.</td>
</tr></table>
<p>The id attribute must be present if the <code>&lt;action&gt;</code> occurs within an <code>&lt;actions&gt;</code> element, and must not be present if the <code>&lt;action&gt;</code> is inside a <code>&lt;key&gt;</code> element.</p>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="SECTION4-_WHEN__ELEMENT"></a><h3>&lt;when&gt; Element</h3>
<p>This element specifies a particular result when the state machine is in a particlar state or set of states. There are several variants of this element; all are empty. The attributes are:</p>
<p class="smalltext"><strong>Table 10 : </strong>when element attributes</p>
<table cellspacing="0" class="graybox">
<tr>
<th><code>state</code></th>
<td scope="row">Required. This specifies the state the state machine must be in for the <code>&lt;when&gt;</code> element to apply. The state may be an arbitrary string, a decimal number, or the special string <code>"none"</code>, indicating the base (initial) state. If the <code>&lt;when&gt;</code> element specifies a range, this is the beginning of the range, in which case it must be a number. A <code>&lt;when&gt;</code> element specifying state "none" must be the first in the enclosing <code>&lt;action&gt;</code>.</td>
</tr>
<tr>
<th><code>through</code></th>
<td scope="row">Optional. The <code>&lt;when&gt;</code> element specifies a range of states rather than a single state. Must be a decimal number. If omitted, a single state is specified.</td>
</tr>
<tr>
<th><code>next</code></th>
<td scope="row">Optional. If present, specifies the next state to enter. If the <code>&lt;when&gt;</code> element specifies a range, must be a decimal number. Defaults to state none (i.e., return to the default, base state).</td>
</tr>
<tr>
<th><code>output</code></th>
<td scope="row">Optional. If present, the string to emit. If the <code>&lt;when&gt;</code> element specifies a range, must be a single UTF-16 code point. Defaults to no output.</td>
</tr>
<tr>
<th><code>multiplier</code></th>
<td scope="row">Optional. A decimal number between 1 and 255. The <code>&lt;when&gt;</code> element must specify a range. The difference between the input state and the start of the range (specified by the state attribute) is multiplied by this number, then added to the next state number and/or the output UTF-16 value.</td>
</tr>
</table>
<p>The compiler will automatically assign numbers to named states; state numbers may also be referenced directly. The numbers assigned by the compiler to named states will be larger than any number referenced directly, so named states and numbered states are always distinct. If the highest state number referenced directly is large enough that there are not enough valid state numbers left to assign to the named states, an error occurs.</p>
<p>It's best to think about the <code>&lt;when&gt;</code> element in terms of two distinct forms:</p>
<ol>
<li>
<pre class="sourcecodebox">&lt;when state="id" [next="id"] [output="string"] /&gt;</pre>
<p>This form specifies an optional next state and an optional output string. One of them must be present. This is by far the most frequent form.</p>
<p>See the example after the description of the <code>&lt;terminators&gt;</code> element to better understand this form.</p>
</li>
<li>
<pre class="sourcecodebox">&lt;when state="first" [through="last"] [multiplier="number"] [output="char"] [next="next"] /&gt;</pre>
<p>This form specifies that when the input state is between first and last (inclusive), that the next state should be (input-first)*multiplier+next, and/or the output character should be (input-first)*multiplier+char.</p>
<p>This form is used for keyboards that generate a large range of characters with sequential values. Examples include the Unicode Hex keyboard, or a keyboard that generates Korean hangul.</p>
<p>See "Supporting Unicode Input" and the Unicode Hex keyboard layout XML file to better understand this form.</p>
</li>
</ol>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="SECTION4-_TERMINATORS__ELEMENT"></a><h3>&lt;terminators&gt; Element</h3>
<p>This element is optional, and may appear at most once in a file. It contains a series of <code>&lt;when&gt;</code> elements, which specify what to do when no action matches the current state. Each <code>&lt;when&gt;</code> element may specify only a single state and an output string. A next state may not be specified. If there is no <code>&lt;when&gt;</code> element for a particular state, the default is to return to the base (default) state.</p>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="A_COMPLETE_DEAD_KEY_EXAMPLE"></a><h2>A Complete Dead Key Example</h2>
<p>Here is an excerpt from a keyboard layout that shows how to specify a dead key combination that handles e acute (é). This assumes a US keyboard layout.</p>
<p>In the <code>&lt;keyMap&gt;</code> for the unshifted keyboard, we have: </p>
<pre class="sourcecodebox">&lt;key code="14" action="e" /&gt;</pre>
<p>This specifies that when key code 14 is received, we take the action named <code>"e"</code>.</p>
<p>In the <code>&lt;keyMap&gt;</code> for the option key, we have:</p>
<pre class="sourcecodebox">&lt;key code="14" action="acute" /&gt;</pre>
<p>This specifies that when key code 14 is received with the option key held down, we take the action named <code>"acute"</code>.</p>
<pre class="sourcecodebox">&lt;actions&gt;
    &lt;action id="acute"&gt;
        &lt;when state="none" next="acute" /&gt;
    &lt;/action&gt;
    &lt;action id="e"&gt;
        &lt;when state="none" output="e" /&gt;
        &lt;when state="acute" output="é" /&gt;
    &lt;/action&gt;
&lt;/actions&gt;
&lt;terminators&gt;
    &lt;when state="acute" output="´" /&gt;
&lt;/terminators&gt;</pre>
<p>If e is typed alone, we get <code>e</code>. If option-e is typed followed by e, we get <code>é</code>. If option-e is typed followed by any other key, we get <code>´</code> alone, followed by whatever that second key generates.</p>
<p>Note that we also could have specified the actions via:</p>
<p>Unshifted:</p>
<pre class="sourcecodebox">&lt;key code="14"&gt;
    &lt;action&gt;
        &lt;when state="none" output="e" /&gt;
        &lt;when state="acute" output="é" /&gt;
    &lt;/action&gt;
&lt;/key&gt;</pre>
<p>Option key:</p>
<pre class="sourcecodebox">&lt;key code="14"&gt;
    &lt;action&gt;
        &lt;when state="none" next="acute" /&gt;
    &lt;/action&gt;
&lt;/key&gt;</pre>
<p>However, this approach can get cumbersome if the same actions need to appear in more than one place. Having all the actions collected in one place can help make the file more readable, too.</p>
<p>A complete example of a keyboard layout would be too lengthy for this tech note. See the Unicode Hex Input keyboard and other keyboards in <code>/System/Library/Keyboard\ Layouts/Unicode.bundle/Contents/Resources/</code> for complete examples. </p>
<p style="margin-top:-10px"><a href="#top">Back to Top </a><a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p>
<a name="REFERENCES"></a><h2>References</h2>
<ul>
<li><p>The Unicode Standard, Version 3.0. Addison-Wesley 2000, ISBN 0-201-61633-5. </p></li>
<li><p><a href="http://www.unicode.org/">The Unicode Consortium web site.</a></p></li>
<li><p><a href="../../documentation/Carbon/text/UnicodeUtilities/unicodeutil.html">Supporting Unicode Input.</a></p></li>
<li><p>The Unicode hex input keyboard (and many other XML Unicode keyboards) can be found in: <code>/System/Library/Keyboard\ Layouts/Unicode.bundle/Contents/Resources/</code> </p></li>
</ul>
<a name="document_revision_summary"></a><h2>Document Revision History</h2>
<table cellspacing="0" class="graybox" width="680">
<tr>
<th width="100">Date</th>
<th width="580">Notes</th>
</tr>
<tr>
<td scope="row">2002-09-27</td>
<td>Explains how to define a Unicode keyboard via an XML text file.</td>
</tr>
</table>
<p><b>Posted: </b>2002-09-27</p>
<!-- END CONTENTS -->
</td></tr></table>
<!-- END WIDE COLUMN --><!-- END MAIN CONTENT --><!-- START BOTTOM APPLE NAVIGATION -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn2002/tn2056.html%3Fid%3DDTS10003085-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn2002/tn2056.html%3Fid%3DDTS10003085-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn2002/tn2056.html%3Fid%3DDTS10003085-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer" --><!-- END BOTTOM APPLE NAVIGATION --><!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->
</body>
</html>
