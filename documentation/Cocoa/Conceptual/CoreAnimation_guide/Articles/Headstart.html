<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Core Animation Programming Guide: Example: Core Animation Menu Application</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Example: Core Animation Menu Application"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP40006131" title="Example: Core Animation Menu Application"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../../GraphicsImaging/index.html#//apple_ref/doc/uid/TP30000440-TP30000424" target="_top">Graphics &amp; Imaging</a> &gt; <a href="../../../../GraphicsImaging/Quartz-date.html#//apple_ref/doc/uid/TP30000440-TP30000424-TP30000559" target="_top">Quartz</a> &gt; <a href="../index.html" target="_top">Core Animation Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="LayerVisProps.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="AnimProps.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>
        
        
        <a name="//apple_ref/doc/uid/TP40006131-SW1" title="Example: Core Animation Menu Application"></a><hr /><H1>Example: Core Animation Menu Application</H1><p>The Core Animation Menu example displays a simple selection example using Core Animation layers to generate and animate the user interface. In less than 100 lines of code, it demonstrates the following capabilities and design patterns:</p><ul class="ul"><li class="li"><p>Hosting the root-layer of a layer hierarchy in a view.</p></li><li class="li"><p>Creating and inserting layers into a layer hierarchy.</p></li><li class="li"><p>Using a <code>QCCompositionLayer</code> to display Quartz Composer compositions as layer content.</p></li><li class="li"><p>Using an explicit animation that runs continuously.</p></li><li class="li"><p>Animating Core Image Filter inputs.</p></li><li class="li"><p>Implicitly animating the position of the selection item.</p></li><li class="li"><p>Handling key events through the MenuView instance that hosts the view.</p></li></ul><p>This application makes heavy use of Core Image filters and Quartz Composer compositions and, as a result, runs only on Mac OS X. The techniques illustrated for managing the layer hierarchy, implicit and explicit animation, and event handling are common to both platforms.</p>
<!-- This template is being used for both PDF and HTML. -->

    
    <!-- TopicBook.pm uses this template for its miniTOCs, but needs a different title. -->
    <h4>Contents:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="Headstart.html#//apple_ref/doc/uid/TP40006131-SW3">The User Interface</a>
				
			<br/>
			
        
			
			
				<a href="Headstart.html#//apple_ref/doc/uid/TP40006131-SW6">The Code</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP40006131-SW3" title="The User Interface"></a><h2>The User Interface</h2><p>The Core Animation Menu application provides a very basic user interface; the user can select a single item in a menu. The user navigates the menu using the up and down arrows on the keyboard. As the selection changes the selection indicator (the rounded white rectangle) animates smoothly to its new location. A continuously animating bloom filter is set for the selection indicator causing it to subtly catch your attention. The background is a Quartz Composer animation that runs continuously. <span class="content_text">Figure 1</span> shows the application’s interface.</p><br/><div><a name="//apple_ref/doc/uid/TP40006131-SW2" title="Figure 1Core Animation Menu Interface"></a><p><strong>Figure 1&nbsp;&nbsp;</strong>Core Animation Menu Interface</p><object alt = "Core Animation Menu Interface" width="640" height="495"><param name="src" value="../Art/anim_menuscreenshot.mp4"><param name="autoplay" value="false"></object><br/><br/><img src = "../Art/menuscreenshot.jpg" alt = "Core Animation Menu Interface" ></div><br/><a name="//apple_ref/doc/uid/TP40006131-SW4" title="Examining the Nib File"></a><h3>Examining the Nib File</h3><p><code>Menu.nib</code> is very straightforward.  An instance of <code>CustomView</code> is dragged from the Interface Builder palette and positioned in the window. It is resized such that it fills the entire window. The <code>MenuView.h</code> file is imported into Interface Builder by dragging it to the Menu.nib window.  The <code>CustomView</code> is then selected, and the object type is changed to <code>MenuView</code>.</p><br/><div><img src = "../Art/menu_nib.jpg" alt = "image: ../Art/menu_nib.jpg" ></div><br/><p>No other connections need to be made.  When the nib file is loaded the window is unarchived and the <code>MenuView</code> is as well. The <code>MenuView</code> class gets an <code>awakeFromNib</code> message and the layers are configured there.</p><a name="//apple_ref/doc/uid/TP40006131-SW5" title="The Layer Hierarchy"></a><h3>The Layer Hierarchy</h3><p>The layer hierarchy, also referred to as the layer tree, of the Menu application is shown below.</p><br/><div><img src = "../Art/examplelayertree.jpg" alt = "&quot;&quot;" ></div><br/><p>The <code>rootLayer</code> is an instance of <code>QCComposerLayer</code>. As the root-layer this layer is the same size as the <code>MenuView</code> instance, and remains that way as the window is resized.</p><p>The <code>menusLayer</code> is a sublayer of the <code>rootLayer</code>. It is an empty layer; it does not have anything set as its <code>contents</code> property and none of its style properties are set.  The <code>menusLayer</code> is simply used as a container for the menu item layers. This approach allows the application to easily access a menu item sublayer by its position in the <code>menusLayers.sublayers</code> array. The <code>menusLayer</code> is the same size as, and overlaps, the <code>rootLayer</code>.  This was done intentionally so that there was no need to convert between coordinate systems when positioning the <code>selectionLayer</code> relative to the current menu item.</p><a name="//apple_ref/doc/uid/TP40006131-SW6" title="The Code"></a><h2>The Code</h2><p>Having looked at the application's nib file and the overall design, you can now begin examining the implementation of the <code>MenuView</code> class..</p><a name="//apple_ref/doc/uid/TP40006131-SW7" title="Examining MenuView.h"></a><h3>Examining MenuView.h</h3><p>The <code>MenuView</code> class is a subclass of <code>NSView</code> and it declares four instance variables:</p><ul class="simple"><li><p><code>NSIndex selectedIndex</code> — tracks the index that is currently selected.</p></li><li><p><code>CALayer *menusLayer</code> —the Core Animation layer that contains the menus items as its sublayers.</p></li><li><p><code>CALayer *selectionLayer</code> — the Core Animation layer that displays the selection indicator</p></li><li><p><code>NSArray *name</code> — an array of names displayed as menu items</p></li></ul><div class="notebox"><a name="//apple_ref/doc/uid/TP40006131-SW8" title="Note"></a><p><strong>Note:</strong>&nbsp;Notice that <code>Quartz/CoreAnimation.h</code> is imported. The <code>QuartzCore.framework</code> must be added to any project that uses Core Animation. Because this example uses Quartz Composer the <code>MenuView</code> implementation also imports <code>Quartz/Quartz.h</code>, and the <code>Quartz.framework</code> is added to the project.</p></div><a name="//apple_ref/doc/uid/TP40006131-SW9" title="Listing 1MenuView.h listing"></a><p class="codesample"><strong>Listing 1&nbsp;&nbsp;</strong>MenuView.h listing</p><div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#import &lt;Cocoa/Cocoa.h><span></span></pre></td></tr><tr><td scope="row"><pre>#import &lt;QuartzCore/CoreAnimation.h><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// the MenuView class is the view subclass that is inserted into<span></span></pre></td></tr><tr><td scope="row"><pre>// the window.  It hosts the rootLayer, and responds to events<span></span></pre></td></tr><tr><td scope="row"><pre>@interface MenuView : NSView {<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // contains the selected menu item index<span></span></pre></td></tr><tr><td scope="row"><pre>     NSInteger selectedIndex;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // the layer that contains the menu item layers<span></span></pre></td></tr><tr><td scope="row"><pre>    CALayer *menusLayer;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // the layer that is used for the selection display<span></span></pre></td></tr><tr><td scope="row"><pre>    CALayer *selectionLayer;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // the array of menu item names<span></span></pre></td></tr><tr><td scope="row"><pre>    NSArray *names;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>-(void)awakeFromNib;<span></span></pre></td></tr><tr><td scope="row"><pre>-(void)setupLayers;<span></span></pre></td></tr><tr><td scope="row"><pre>-(void)changeSelectedIndex:(NSInteger)theSelectedIndex;<span></span></pre></td></tr><tr><td scope="row"><pre>-(void)moveUp:(id)sender;<span></span></pre></td></tr><tr><td scope="row"><pre>-(void)moveDown:(id)sender;<span></span></pre></td></tr><tr><td scope="row"><pre>-(void)dealloc;<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40006131-SW10" title="Examining MenuView.m"></a><h3>Examining MenuView.m</h3><p>The <code>MenuView</code> class is the workhorse of this application.  It responds when the view is loaded by the nib, sets up the layers to be displayed, creates the animations, and handles the keys that move the selection.</p><p>The examination of the <code>MenuView.m</code> is split as follows:</p><ul class="spaceabove"><li class="li"><p>Setting Up the <code>MenuView</code></p></li><li class="li"><p>Setting Up the Layers</p></li><li class="li"><p>Animating the Selection Layer Movement</p></li><li class="li"><p>Responding to Key Events</p></li><li class="li"><p>Cleaning Up</p></li></ul><a name="//apple_ref/doc/uid/TP40006131-SW11" title="Setting Up the MenuView"></a><h4>Setting Up the MenuView</h4><p>The <code>awakeFromNib</code> method is called when <code>Menu.nib</code> is loaded and unarchived.  The view is expected to complete its setup in <code>awakeFromNib</code>.</p><p>The <code>MenuView</code> implementation of <code>awakeFromNib</code> creates an array of strings, names, that are used to display the menu items. It then calls the <code>setupLayers</code> method to setup the layers for the view.</p><div class="codesample"><table><tr><td scope="row"><pre>- (void)awakeFromNib<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    names=[[NSArray arrayWithObjects:@"Item 1",@"Item 2",<span></span></pre></td></tr><tr><td scope="row"><pre>                                     @"Item 3",@"Item 4",@"Item 5",<span></span></pre></td></tr><tr><td scope="row"><pre>                                     nil] retain];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    [self setupLayers];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40006131-SW12" title="Setting Up the Layers"></a><h4>Setting Up the Layers</h4><p>The majority of the code in the Menu example resides in the <code>setupLayers</code> method. This method is responsible for the following:</p><ul class="spaceabove"><li class="li"><p>Creating and initializing <code>rootLayer</code></p></li><li class="li"><p>Setting <code>rootLayer</code> as the hosted layer of the view</p></li><li class="li"><p>Creating and initializing the <code>menusLayer</code></p></li><li class="li"><p>Creating and initializing the menu item layers</p></li><li class="li"><p>Adding the menu item positioning constraints</p></li><li class="li"><p>Layout the <code>menusLayer</code></p></li><li class="li"><p>Creating the <code>selectionLayer</code></p></li><li class="li"><p>Configuring the continuous animation of <code>selectionLayer</code></p></li><li class="li"><p>Adding it to the layer tree of <code>rootLayer</code></p></li><li class="li"><p>Setting the initial value of <code>selectedIndex</code></p></li></ul><p>First, the constants used to position and space the layers are defined.</p><div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>-(void)setupLayers;<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CGFloat width=400.0;<span></span></pre></td></tr><tr><td scope="row"><pre>    CGFloat height=50.0;<span></span></pre></td></tr><tr><td scope="row"><pre>    CGFloat spacing=20.0;<span></span></pre></td></tr><tr><td scope="row"><pre>    CGFloat fontSize=32.0;<span></span></pre></td></tr><tr><td scope="row"><pre>    CGFloat initialOffset=100.0;<span></span></pre></td></tr></table></div><p>The view must be set as the first responder to allow it to initially handle the up and down arrow events.</p><div class="codesample"><table><tr><td scope="row"><pre>[[self window] makeFirstResponder:self];<span></span></pre></td></tr></table></div><p>Create the <code>rootLayer</code>, The <code>rootlayer</code> is an instance of <code>QCCompositionLayer</code> that displays the <code>Background.qtz</code> file which is located within the application bundle.</p><div class="codesample"><table><tr><td scope="row"><pre>QCCompositionLayer* rootLayer;<span></span></pre></td></tr><tr><td scope="row"><pre>rootLayer=[QCCompositionLayer compositionLayerWithFile:<span></span></pre></td></tr><tr><td scope="row"><pre>           [[NSBundle mainBundle] pathForResource:@"Background"<span></span></pre></td></tr><tr><td scope="row"><pre>                                           ofType:@"qtz"]];<span></span></pre></td></tr></table></div><p>The instance of <code>MenuView</code> is set as the layer-hosting view of <code>rootLayer</code>. The order of these two calls is important. By first setting the layer to <code>rootLayer</code> and then setting <code>setWantsLayer:</code> to <code>YES</code> our layer is used rather than the one that the view would create. This is the key difference between layer-hosting views and layer-backed views.</p><div class="codesample"><table><tr><td scope="row"><pre>[self setLayer:rootLayer];<span></span></pre></td></tr><tr><td scope="row"><pre>[self setWantsLayer:YES];<span></span></pre></td></tr></table></div><p>Create the <code>menusLayer</code>, and set its bounds to those of <code>rootLayer</code>. Again, this is done to allow us to use the same coordinate system for both the <code>menusLayer</code> sublayers and the <code>selectedLayer</code>. The menusLayer is also retained, <code>MenuView</code> requires it when positioning the <code>selectedLayer</code>.</p><div class="codesample"><table><tr><td scope="row"><pre>menusLayer=[[CALayer layer] retain];<span></span></pre></td></tr><tr><td scope="row"><pre>menusLayer.frame=rootLayer.frame;<span></span></pre></td></tr></table></div><p>Specify that the sublayers of <code>menusLayer</code> will be laid out using the <code>CAConstraintLayoutManager</code>. Constraints layout allows you to specify the location and size of layers relative to their sibling layers and superlayer.  The superlayer is configured to use the constraints manager, and individual <code>CAContraint</code> instances are created and attached to each of the  sublayers.</p><div class="codesample"><table><tr><td scope="row"><pre>menusLayer.layoutManager=[CAConstraintLayoutManager layoutManager];<span></span></pre></td></tr></table></div><p>Add the <code>menusLayer</code> as a sublayer of the <code>rootLayer</code>.</p><div class="codesample"><table><tr><td scope="row"><pre>[rootLayer addSublayer:menusLayer];<span></span></pre></td></tr></table></div><p>The next code fragment iterates over the items in the names array, creating a new <code>CATextLayer</code> for each name and defines its position using constraints.</p><div class="codesample"><table><tr><td scope="row"><pre>NSInteger i;<span></span></pre></td></tr><tr><td scope="row"><pre>for (i=0;i&lt;[names count];i++) {<span></span></pre></td></tr></table></div><p>Get the name at the index of the current iteration.</p><div class="codesample"><table><tr><td scope="row"><pre>NSString *name=[names objectAtIndex:i];<span></span></pre></td></tr></table></div><p>Create a new <code>CATextLayer</code> instance called <code>menuItemLayer</code>. Set its string to the name of the menu item, and specify that it should be displayed in white 32 point Lucida-Grande.</p><div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>CATextLayer *menuItemLayer=[CATextLayer layer];<span></span></pre></td></tr><tr><td scope="row"><pre>menuItemLayer.string=name;<span></span></pre></td></tr><tr><td scope="row"><pre>menuItemLayer.font=@"Lucida-Grande";<span></span></pre></td></tr><tr><td scope="row"><pre>menuItemLayer.fontSize=fontSize;<span></span></pre></td></tr><tr><td scope="row"><pre>menuItemLayer.foregroundColor=CGColorCreateGenericRGB(1.0,1.0,1.0,1.0);<span></span></pre></td></tr></table></div><p>Note that the bounds of the <code>menuItemLayer</code> is never specified.  When using <code>CATextLayer</code> instances the constraints manager takes responsibility for setting the bounds and height of the layer.</p><p>The next step is to specify the constraints for the layout. First the vertical constraint is set relative to the top edge of the superlayer. The top edge of <code>menuItemLayer</code> is offset by the <code>initialOffset</code> (defined earlier) and by the spacing between items (also specified earlier) and the height (again specified earlier) is multiplied by the index of the name. The final value is inverted because the layer coordinate system uses the bottom left as its origin.</p><div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>[menuItemLayer addConstraint:[CAConstraint<span></span></pre></td></tr><tr><td scope="row"><pre>              constraintWithAttribute:kCAConstraintMaxY<span></span></pre></td></tr><tr><td scope="row"><pre>                           relativeTo:@"superlayer"<span></span></pre></td></tr><tr><td scope="row"><pre>                            attribute:kCAConstraintMaxY<span></span></pre></td></tr><tr><td scope="row"><pre>                               offset:-(i*height+spacing+initialOffset)]];<span></span></pre></td></tr></table></div><p>The second constraint simply causes the <code>menuItemLayer</code> object to be centered horizontally, relative to the center of its superlayer.</p><div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>[menuItemLayer addConstraint:[CAConstraint<span></span></pre></td></tr><tr><td scope="row"><pre>                              constraintWithAttribute:kCAConstraintMidX<span></span></pre></td></tr><tr><td scope="row"><pre>                                           relativeTo:@"superlayer"<span></span></pre></td></tr><tr><td scope="row"><pre>                                            attribute:kCAConstraintMidX]];<span></span></pre></td></tr></table></div><p>Each <code>menuItemLayer</code> is added to the menusLayer layer as a sublayer.</p><div class="codesample"><table><tr><td scope="row"><pre>[menusLayer addSublayer:menuItemLayer];<span></span></pre></td></tr><tr><td scope="row"><pre>} // end of for loop<span></span></pre></td></tr></table></div><p>Having configured all the menu item layers you must now force them to be laid out immediately. This is necessary to ensure that the first placement of the <code>selectionLayer</code> is correct.</p><div class="codesample"><table><tr><td scope="row"><pre>[menusLayer layoutIfNeeded];<span></span></pre></td></tr></table></div><p>Now the <code>CALayer</code> that is used as the <code>selectionlayer</code> is created and configured. The <code>bounds</code> is set to be the width and height defined earlier. The layer is retained because we rely on it being available to <code>MenuView</code> after the layer is added to the layer tree.</p><div class="codesample"><table><tr><td scope="row"><pre>selectionLayer=[[CALayer layer] retain];<span></span></pre></td></tr><tr><td scope="row"><pre>selectionLayer.bounds=CGRectMake(0.0,0.0,width,height);<span></span></pre></td></tr></table></div><p>The <code>selectionLayer</code> depends on the <code>borderWidth</code>, <code>borderColor</code>, and <code>cornerRadius</code> style properties to provide its visual components. They are set to 2 points wide, a color of white, and a corner radius that ensures that the ends of the selectionLayer are rounded completely.</p><div class="codesample"><table><tr><td scope="row"><pre>selectionLayer.borderWidth=2.0;<span></span></pre></td></tr><tr><td scope="row"><pre>selectionLayer.borderColor=CGColorCreateGenericRGB(1.0f,1.0f,1.0f,1.0f);<span></span></pre></td></tr><tr><td scope="row"><pre>selectionLayer.cornerRadius=height/2;<span></span></pre></td></tr></table></div><p>As the <code>selectionLayer</code> is displayed it softly pulses every second. This is done using a CIBloom filter and animating its inputIntensity between 0 (no intensity) and 1.5 (somewhat intense).</p><p>Create the filter, set its default values, and then specify the inputRadius is 5.0.</p><div class="codesample"><table><tr><td scope="row"><pre>CIFilter *filter = [CIFilter filterWithName:@"CIBloom"];<span></span></pre></td></tr><tr><td scope="row"><pre>[filter setDefaults];<span></span></pre></td></tr><tr><td scope="row"><pre>[filter setValue:[NSNumber numberWithFloat:5.0] forKey:@"inputRadius"];<span></span></pre></td></tr></table></div><p>Core Animation extends the <code>CIFilter</code> class by adding the <code>name</code> property. The <code>name</code> property allows the inputs of filters in the layer's filters array to be animated using a key path.</p><div class="codesample"><table><tr><td scope="row"><pre>[filter setName:@"pulseFilter"];<span></span></pre></td></tr></table></div><p>Set the <code>selectionLayer</code> filters array so that it contains filter.</p><div class="codesample"><table><tr><td scope="row"><pre>[selectionLayer setFilters:[NSArray arrayWithObject:filter]];<span></span></pre></td></tr></table></div><p>The pulse animation is an explicit animation that runs continuously. It is a subclass of <code>CABasicAnimation</code> and, as such, must specify values for a <code>keyPath</code>, <code>toValue</code>, and <code>fromValue</code>.</p><div class="codesample"><table><tr><td scope="row"><pre>CABasicAnimation* pulseAnimation = [CABasicAnimation animation];<span></span></pre></td></tr></table></div><p>Set the key path to be animated to <code>filters.pulseFilter.inputIntensity</code>. This is where the filter's name property is used.</p><div class="codesample"><table><tr><td scope="row"><pre>pulseAnimation.keyPath = @"filters.pulseFilter.inputIntensity";<span></span></pre></td></tr></table></div><p>Set the <code>fromValue</code> and <code>toValue</code> to 0 and 1.0 respectively. This gives a nice pulse effect.</p><div class="codesample"><table><tr><td scope="row"><pre>pulseAnimation.fromValue = [NSNumber numberWithFloat: 0.0];<span></span></pre></td></tr><tr><td scope="row"><pre>pulseAnimation.toValue = [NSNumber numberWithFloat: 1.0];<span></span></pre></td></tr></table></div><p>The animation is 1 second long, and it repeats indefinitely. When the animation reaches 1.5, it cycles back to 0, and so on. The following code sets that up.</p><div class="codesample"><table><tr><td scope="row"><pre>pulseAnimation.duration = 1.0;<span></span></pre></td></tr><tr><td scope="row"><pre>pulseAnimation.repeatCount = 1e100f;<span></span></pre></td></tr><tr><td scope="row"><pre>pulseAnimation.autoreverses = YES;<span></span></pre></td></tr></table></div><p>The <code>timingFunction</code> of an animation controls how the animation values are distributed over the course of the animation duration. In this case we'll use an easeIn-easeOut animation. This causes the animation to begin slowly, ramp up to speed, and then slow again before completing.</p><div class="codesample"><table><tr><td scope="row"><pre>pulseAnimation.timingFunction = [CAMediaTimingFunction functionWithName:<span></span></pre></td></tr><tr><td scope="row"><pre>                                     kCAMediaTimingFunctionEaseInEaseOut];<span></span></pre></td></tr></table></div><p>For an explicit animation to begin you must add it to the layer's animation collection. This is done using <code>addAnimation:forKey:</code>. The key itself is used as an identifier for removing the animation later, if necessary.</p><div class="codesample"><table><tr><td scope="row"><pre>[selectionLayer addAnimation:pulseAnimation forKey:@"pulseAnimation"];<span></span></pre></td></tr></table></div><p>Finally, now that setup is complete add the <code>selectionLayer</code> to the <code>rootLayer</code>.</p><div class="codesample"><table><tr><td scope="row"><pre>[rootLayer addSublayer:selectionLayer];<span></span></pre></td></tr></table></div><p>Set the initial position of the <code>selectionLayer</code> and the initial <code>selectedIndex</code> to 0.</p><div class="codesample"><table><tr><td scope="row"><pre>[self changeSelectedIndex:0];<span></span></pre></td></tr><tr><td scope="row"><pre>// end of setupLayers<span></span></pre></td></tr></table></div><p>The <code>setupLayers</code> method is by far the longest and most complex in this application.  However, by breaking it down into the setup for each layer, it becomes much easier to understand.</p><a name="//apple_ref/doc/uid/TP40006131-SW13" title="Animating the Selection Layer Movement"></a><h4>Animating the Selection Layer Movement</h4><p>The method <code>changeSelectedIndex:</code> is responsible for: setting selectedIndex to the new value, ensuring that the new value of selectedIndex is within the range of the number of items in the menu items, and positioning the selection layer relative to the <code>menusLayer</code> sublayer at the <code>selectedIndex</code>. This causes the selection layer to animate to show that the new item is selected.</p><div class="codesample"><table><tr><td scope="row"><pre>-(void)changeSelectedIndex:(NSInteger)theSelectedIndex<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    selectedIndex=theSelectedIndex;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (selectedIndex == [names count]) selectedIndex=[names count]-1;<span></span></pre></td></tr><tr><td scope="row"><pre>    if (selectedIndex &lt; 0) selectedIndex=0;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    CALayer *theSelectedLayer=[[menusLayer sublayers] objectAtIndex:selectedIndex];<span></span></pre></td></tr><tr><td scope="row"><pre>    selectionLayer.position=theSelectedLayer.position;<span></span></pre></td></tr><tr><td scope="row"><pre>};<span></span></pre></td></tr></table></div><p>Notice that all that is required to animate the <code>selectionLayer</code> is to simply assign a new value to its <code>position</code> property. This is an example of implicit animation</p><a name="//apple_ref/doc/uid/TP40006131-SW14" title="Responding to Key Events"></a><h4>Responding to Key Events</h4><p>Because layers do not take part in the responder chain, or accept events, the MenuView that acts as the layer-host for the layer tree must assume that role. The <code>moveUp:</code> and <code>moveDown:</code> messages are provided by <code>NSResponder</code>, of which <code>MenuView</code> is a descendent. The <code>moveUp:</code> and <code>moveDown:</code> messages are invoked when the up arrow and down arrows are pressed respectively. Using these methods allows the application to respect any remapped arrow key functionally specified by the user. (And it's easier than implementing <code>keyDown:</code>).</p><p>When the up arrow is pressed the <code>selectedIndex</code> value is de-incremented and updated by calling <code>changeSelectedIndex:</code>.</p><div class="codesample"><table><tr><td scope="row"><pre>-(void)moveUp:(id)sender<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [self changeSelectedIndex:selectedIndex-1];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>When the down arrow is pressed the <code>selectedIndex</code> value is incremented and updated by calling <code>changeSelectedIndex:</code>.</p><div class="codesample"><table><tr><td scope="row"><pre>-(void)moveDown:(id)sender<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [self changeSelectedIndex:selectedIndex+1];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40006131-SW15" title="Cleaning Up"></a><h4>Cleaning Up</h4><p>When the <code>MenuView</code> is released, we are responsible for cleaning up our instance variables. The <code>menusLayer</code>, <code>selectionLayer</code>, and <code>names</code> are autoreleased in the <code>dealloc</code> implementation.</p><div class="codesample"><table><tr><td scope="row"><pre>-(void)dealloc<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    [menusLayer autorelease];<span></span></pre></td></tr><tr><td scope="row"><pre>    [selectionLayer autorelease];<span></span></pre></td></tr><tr><td scope="row"><pre>    [names autorelease];<span></span></pre></td></tr><tr><td scope="row"><pre>    [super dealloc];<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>

        <br/><br/> 

        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="LayerVisProps.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="AnimProps.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2008 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2008-11-13<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Cocoa/Conceptual/CoreAnimation_guide/Articles/Headstart.html%3Fid%3DTP40004514-5.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Cocoa/Conceptual/CoreAnimation_guide/Articles/Headstart.html%3Fid%3DTP40004514-5.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Cocoa/Conceptual/CoreAnimation_guide/Articles/Headstart.html%3Fid%3DTP40004514-5.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>
