<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><!--Includes revisions to code listings--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note DV05: Drive Queue Elements</title><meta name="keywords" content="Mac OS 8 drive queue elements dQDrvSz2 DrvQELPtr File Manager"><meta name="Description" content="Technical Note DV05: This Technical Note discusses the drivequeue and the drive queue element structure. It includescode snippets, in Pascal and MPW C, for accessing the flagsthat precede a drive queue entry and a code sample in AssemblyLanguage, that adds a drive to the drive queue.">                                       <meta name="categories" content="Devices"><meta name="week-posted" content="May 27, 1985 - Jun 7, 1985"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002395" title="Drive Queue Elements"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/idxMassStorageDevices-date.html" target="_blank">Hardware & Drivers > Storage</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note DV05</div>
<div id="pageheadsub">Drive Queue Elements</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                   <td background="images/tnmenubody.gif" width=300 align=left>                        <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc --><p id="menutext"><a href="#Section1">Drive queue element</a><BR><BR><a href="#Section2">Creating new drives</a><BR><BR><a href="#references">References</a><BR><BR><A HREF="#downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>		<td width=300 valign="top" align=left>	<!-- begin_intro_text --><P id = "introtext">This note expands on <i>Inside Macintosh</i>'s definition of the drive queue, which is given in the File Manager chapter.</p><!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [June 01 1995]</h3><!-- end_date -->                </TD>             </TR>          </TABLE> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><a name="Section1"></a><h2>Drive queue element</h2><P>As shown in <i>Inside Macintosh</i>, a drive queue element has the following structure:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    DrvQEl = RECORD        qLink:    QElemPtr; {next queue entry}        qType:    INTEGER;  {queue type}        dQDrive:  INTEGER;  {drive number}        dQRefNum: INTEGER;  {driver reference number}        dQFSID:   INTEGER;  {file-system identifier}        dQDrvSz:  INTEGER;  {number of logical blocks on drive}        dQDrvSz2: INTEGER;  {additional field to handle large drive size}    END;</pre>	</TD></TR></TABLE></CENTER><p>Note that <code>dQDrvSz2</code> is only used if <code>qType</code> is 1. In this case, <code>dQDrvSz2</code> containsthe high-order word of the size, and <code>dQDrvSz</code> contains the low-order word.</p><p><i>Inside Macintosh</i> also mentions four bytes of flags that preced each drivequeue entry. How are these flags accessed? The flags begin 4 bytes before the address pointed to by the <code>DrvQElPtr</code>. In assembly language, accessing this isn't a problem:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>MOVE.L  -4(A0),D0   ;A0 = DrvQElPtr; get drive queue flags</pre>	</TD></TR></TABLE></CENTER><p>If you're using Pascal, it's a little more complicated. You can get to the<code>flags</code> with this routine:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    FUNCTION DriveFlags(aDQEPtr: DrvQElPtr): LONGINT;       VAR          flagsPtr : ^LONGINT; {we'll point at drive queue flags with this}       BEGIN          {subtract 4 from the DrvQElPtr, and get the LONGINT there}          flagsPtr := POINTER(ORD4(aDQEPtr) - 4);          DriveFlags := flagsPtr^;       END;</pre>	</TD></TR></TABLE></CENTER><p>From MPW C, you can use:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    long DriveFlags(aDQEPtr)    DrvQElPtr    aDQEPtr;    { /* DriveFlags */        return(*((long *)aDQEPtr - 1));  /* coerce flagsPtr to a (long *)                                            so that subtracting 1 from it                                            will back us up 4 bytes */    } /* DriveFlags */</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>Creating New Drives</h2><p>To add a drive to the drive queue, assembly-language programmers can use thefunction defined below. It takes two parameters: the driver reference number ofthe driver which is to "own" this drive, and the size of the new drive inblocks. It returns the drive number created. It is vital that you <b>not</b> hard-code the drive number; if the user has installed other non-standarddrives in the queue, the drive number you're expecting may already be taken.(Note that the example function below arbitrates to find an unused drivenumber, taking care of this problem for you. You should also note that this functiondoesn't mount the new volume; your code should take care of that, calling theDisk Initialization Package to reformat the volume if necessary).</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>AddMyDrive  PROC     EXPORT;---------------------------------------------------------------------------;FUNCTION AddMyDrive(drvSize: LONGINT; drvrRef: INTEGER): INTEGER;;---------------------------------------------------------------------------;Add a drive to the drive queue. Returns the new drive number, or a negative;error code (from trying to allocate the memory for the queue element).;---------------------------------------------------------------------------DQESize     EQU      18          ;size of a drive queue element;We use a constant here because the number in SysEqu.a doesn't take into;account the flags LONGINT before the element, or the size word at the end.;---------------------------------------------------------------------------StackFrame  RECORD   {link},DECRresult      DS.W     1           ;function resultparams      EQU      *drvSize     DS.L     1           ;drive size parameterdrvrRef     DS.W     1           ;drive refNum parameterparamSize   EQU      params-*return      DS.L     1           ;return addresslink        DS.L     1           ;saved value of A6 from LINKblock       DS.B     ioQElSize   ;parameter block for call to MountVollinkSize    EQU      *            ENDR;---------------------------------------------------------------------------         WITH     StackFrame     ;use the offsets declared above         LINK     A6,#linkSize   ;create stack frame         ;search existing drive queue for an unused number         LEA      DrvQHdr,A0     ;get the drive queue header         MOVEQ    #4,D0          ;start with drive number 4CheckDrvNum         MOVE.L   qHead(A0),A1   ;start with first driveCheckDrv         CMP.W    dqDrive(A1),D0 ;does this drive already have our number?         BEQ.S    NextDrvNum     ;yep, bump the number and try again.         CMP.L    A1,qTail(A0)   ;no, are we at the end of the queue?         BEQ.S    GotDrvNum      ;if yes, our number's unique! Go use it.         MOVE.L   qLink(A1),A1   ;point to next queue element         BRA.S    CheckDrv       ;go check it.NextDrvNum         ;this drive number is taken, pick another         ADDQ.W   #1,D0          ;bump to next possible drive number         BRA.S    CheckDrvNum    ;try the new numberGotDrvNum         ;we got a good number (in D0.W), set it aside         MOVE.W   D0,result(A6)  ;return it to the user         ;get room for the new DQE         MOVEQ    #DQESize,D0    ;size of drive queue element, adjusted         _NewPtr  sys            ;get memory for it         BEQ.S    GotDQE         ;no error...continue         MOVE.W   D0,result(A6)  ;couldn't get the memory! return error         BRA.S    FinishUp       ;and exitGotDQE         ;fill out the DQE         MOVE.L   #$80000,(A0)+  ;flags: non-ejectable; bump past flags         MOVE.W   #1,qType(A0)   ;qType of 1 means we do use dQDrvSz2         CLR.W    dQFSID(A0)     ;"local file system"         MOVE.W   drvSize(A6),dQDrvSz2(A0)  ;high word of number of blocks         MOVE.W   drvSize+2(A6),dQDrvSz(A0) ;low word of number of blocks         ;call AddDrive         MOVE.W   result(A6),D0  ;get the drive number back         SWAP     D0             ;put it in the high word         MOVE.W   drvrRef(A6),D0 ;move the driver refNum in the low word         _AddDrive               ;add this drive to the drive queueFinishUp         UNLK     A6             ;get rid of stack frame         MOVE.L   (SP)+,A0       ;get return address         ADDQ     #paramSize,SP  ;get rid of parameters         JMP      (A0)           ;back to caller;---------------------------------------------------------------------------         ENDPROC</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="references"></a><h2>References</h2><P>The File Manager chapter of <i>Inside Macintosh</i></p><P>The Device Manager chapter of <i>Inside Macintosh</i></p><P><A HREF="#top">Back to top</A></P>         <a name="downloads"></a>         <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center>                                    <img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (48K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/dv_05.pdf">Download</A></P>               </TD>            </TR>         </TABLE>         <BR>                  <P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/dv/dv_05.html%3Fid%3DDTS10002395-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/dv/dv_05.html%3Fid%3DDTS10002395-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/dv/dv_05.html%3Fid%3DDTS10002395-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>