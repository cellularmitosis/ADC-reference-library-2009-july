<HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><script language="JavaScript" src="frametest.js"></script><TITLE> Opening Devices</TITLE></HEAD><BODY BGCOLOR="#ffffff"><DIV><a name="top"></a><!-- start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!-- start of path --><font face="Geneva,Helvetica,Arial" size="1"><b><br>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Documentation</a> &gt; <!-- a href="" target="_top" -->Hardware<!-- /a -->  <b>&gt; </b><a href="../../devicemgrs.html" target="_top">Device Managers and Drivers</a> <b>&gt; </b><a href="../pci_srvcs.html" target="_top">PCI Card Services</a> <b>&gt; </b>Designing PCI Cards and Drivers for Power Macintosh Computers</font><br><br><!-- end of path --><A HREF="PCI_BOOK.86.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.8b.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.8d.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><HR></DIV><H1 CLASS="H1.Heading1"><A NAME="pgfId=3469"> </A>Opening Devices</H1><P CLASS="T1.Text1"><A NAME="pgfId=3470"> </A>There is a clear distinction between device initialization and device opening. A device opening action is a connection-oriented response to client requests. Device drivers should expect to run with multiple <TT CLASS="cv">Open</TT> and <TT CLASS="cv">Close</TT> commands. This means that each driver is responsible for counting open requests from clients, and must not close itself until all clients have issued close requests. Initialization can occur independently of client requests--for example at startup time, or (in the case of PCMCIA devices) when a device is hot-swapped into or out of the system.</P><P CLASS="T1.Text1"><A NAME="pgfId=3471"> </A>Initialization of native driver-controlled devices is handled in phases as described in the previous section. It is necessary to make a distinction here between PCI drivers and 68K drivers because the 68K driver initialization path has not changed.</P><P CLASS="T1.Text1"><A NAME="pgfId=3473"> </A>The first phase of native <A NAME="marker=3472"> </A>driver initialization consists of searching the device portion of the Name Registry for boot devices. Boot device nodes should be flagged as <TT CLASS="cv">kDriverIsLoadedUponDiscovery</TT> and <TT CLASS="cv">kDriverIsOpenedUponLoad</TT> in the <TT CLASS="cv">driver-descriptor</TT> property associated with the device node. The contents of the <TT CLASS="cv">driver-descriptor</TT> property is a <TT CLASS="cv">TheDriverDescription</TT> structure. Boot devices are loaded, initialized, and opened by the system. Their drivers, which must be in ROM, should be passive code controlled by the system starting up. </P><P CLASS="T1.Text1"><A NAME="pgfId=3474"> </A>The second phase of startup comes after the Mac OS file system is available. In this second phase the Extensions folder is scanned for family experts, which are run as they are located. Their job is to locate and initialize all devices of their particular service category in the Name Registry. The family experts are initialized and run before their service category devices are initialized because the family expert extends the system facilities to provide services to their service category devices. For example, the Display Manager extends the system to provide VBL capabilities to <TT CLASS="cv">'disp'</TT> service category drivers. In the past, VBL services have been provided by the Slot Manager; but with native drivers, family-specific services such as VBL services move from being a part of bus software to being a part of family software.</P><P CLASS="T1.Text1"><A NAME="pgfId=3475"> </A>A family expert, whether ROM based or disk based, scans the Name Registry for devices of a particular service category. Each device entered in the Registry with the specified service category is initialized and installed in the system in a family-specific way.</P><P CLASS="T1.Text1"><A NAME="pgfId=3479"> </A>Note that startup steps 10 and 11 listed in <A HREF="PCI_BOOK.88.html#17485" CLASS="XRef">PCI Boot Sequence</A> initialize the Display Manager and the SCSI Manager. The <A NAME="marker=3480"> </A>Display Manager and <A NAME="marker=3481"> </A>SCSI Manager are both family experts. These are ROM-based experts that look for service category <TT CLASS="cv">'disp'</TT> (<TT CLASS="cv">'ndrv'</TT> for current display devices) and service category <TT CLASS="cv">'blok'</TT> respectively. The SCSI Manager loads and activates PCI SIMs in the way described in <I CLASS="italics">Inside Macintosh: Devices</I> and in <A HREF="PCI_BOOK.23f.html#17094" CLASS="XRef">SIMs for Current Versions of Mac&nbsp;OS</A>. The Display Manager loads, initializes, and opens display devices. Disk-based experts perform exactly the same task as ROM-based experts, but disk-based experts are run after the file system is available. For more information about the Display Manager, see <I CLASS="italics">Display Device Driver Guide,</I> listed in <A HREF="PCI_BOOK.25d.html#21666" CLASS="XRef">Apple Publications</A>.</P><HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 26 March 99)<P><A HREF="PCI_BOOK.86.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.8b.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.8d.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>