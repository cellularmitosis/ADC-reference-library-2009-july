<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Writing a User Routine for Connection Events(IM:N)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING112></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Networking-111.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-113.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Networking-2.html"><B>Networking</B></A> / <BR><DD><A HREF="Networking-98.html"><B>Chapter 5 - AppleTalk Data Stream Protocol (ADSP) </B></A> / <A HREF="Networking-107.html"><B>Using ADSP</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING112-0></A>
<H2><A NAME=MARKER-9-190></A><A NAME=MARKER-2-115></A><A NAME=MARKER-21-192></A>Writing a User Routine for Connection Events</H2>
 <A NAME=MARKER-2-55></A><A NAME=MARKER-2-18></A>When you execute the <CODE>dspInit</CODE> <CODE>routine</CODE>, you can specify a pointer to a routine that you provide (referred to as the <I>user routine</I>). <A NAME=MARKER-2-195></A>Whenever an unsolicited connection event occurs, ADSP sets a flag in the CCB and calls the user routine. The user routine must clear the flag to acknowledge that it has read the flag field, and then it can respond to the event in any manner you deem appropriate. The CCB flags are described in<A HREF=Networking-117.html#MARKER-9-232>"The ADSP Connection Control Block Record" beginning on page 5-35</A>. The four following types <BR>of unsolicited connection events set flags in the CCB:<P>
<UL>
<LI>ADSP has been informed by the remote connection end that the remote connection end is about to close the connection. An appropriate response might be to store a flag indicating that the connection end is about to close. When your application regains control, it can then display a dialog box informing the user of this event and asking whether the application should attempt to reconnect later.
<LI>ADSP has determined that the remote connection end is not responding and so has closed the connection. Your user routine can attempt to open a new connection immediately. Alternatively, you can store a flag indicating that the connection has closed, and when your application regains control, it can display a dialog box asking the user whether to attempt to reconnect. 
<LI>ADSP has received an <A NAME=MARKER-2-83></A>attention message from the remote connection end. Depending on what you are using the attention-message mechanism for, you might want to read the attention code in the <CODE>attnCode</CODE> field of the CCB and the attention message pointed to by the <CODE>attnPtr</CODE> field of the CCB. 
<LI>ADSP has received a forward reset command from the remote client end. It has then discarded all ADSP data not yet delivered, including the data in the receive queue of the local client end, and has resynchronized the connection. Your response to this event depends on the purpose for which you are using the forward reset mechanism. You might want to resend the last data you have sent or inform the user of the event. <P>
</UL>
 When ADSP calls your user routine, the CPU is in interrupt-processing mode and register A1 contains a pointer to the CCB of the connection end that generated the event. You can examine the <CODE>userFlags</CODE> field of the CCB to determine what event caused the interrupt, and you can examine the <CODE>state</CODE> field of the CCB to determine the current state of the connection. <P>
 Because the CPU is set to interrupt-processing mode, your user routine must preserve <BR>all registers other than A0, A1, D0, D1, and D2. Your routine must not make any direct <BR>or indirect calls to the Memory Manager, and it cannot depend on handles to unlocked blocks being valid. If you want to use any of your application's global variables, you must save the contents of the A5 register before using the variables, and you must restore the A5 register before your routine terminates. <A HREF=Networking-110.html#MARKER-9-181>Listing 5-1</A> and <A HREF=#MARKER-9-198>Listing 5-3</A> illustrate the use of the CCB to store the pointer to your application's global variables. <P>
 If you want to execute a routine each time an unsolicited connection event occurs but the interrupt environment is too restrictive, you can specify a <CODE>NIL</CODE> pointer to the user routine and periodically poll the <CODE>userFlags</CODE> field of the CCB. <P>
<DL>
<DT><B>WARNING</B>
<DD>When an unsolicited connection event <A NAME=MARKER-2-82></A>occurs, you must clear the bit in the <CODE>userFlags</CODE> field by setting it to 0 or the connection will hang. To ensure that you do not lose any attention messages, you must read any attention messages into an internal buffer before you clear the bit in the <CODE>userFlags</CODE> field.<EM></EM>   <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 <A HREF=#MARKER-9-198>Listing 5-3 on page 5-28</A> shows the user routine called by <A HREF=Networking-110.html#MARKER-9-181>Listing 5-1 on page 5-17</A>. When this routine is called, it first checks the CCB to determine the source of the interrupt <BR>and then clears the bit in the <CODE>userFlags</CODE> field of the CCB. If the routine has received <BR>an attention message, the user routine reads the message into an internal buffer before <BR>it clears the <CODE>flag</CODE> bit. The definitions of procedures <CODE>PushA5</CODE>, <CODE>GetMyTRCCBA5</CODE>, and <BR><CODE>PopA5</CODE> are shown in <A HREF=#MARKER-9-198>Listing 5-3</A> for your convenience. In a complete application these procedures would be defined in the calling routine (see <A HREF=Networking-110.html#MARKER-9-181>Listing 5-1</A> for an example).<P>
<B>Listing 5-3  <A NAME=MARKER-9-198></A><A NAME=MARKER-21-199></A>An ADSP user routine </B><P>
<PRE>
PROCEDURE PushA5;          {moves current value of A5 onto stack}
   INLINE $2F0D;           {MOVE.L A5,-(SP)}

PROCEDURE GetMyTRCCBA5;    {retrieves A5 from the head of the TRCCB }
                           { (pointed to by A1) and puts it in A5 register}
   INLINE $2A69, $FFFC;    {MOVE.L -4(A1), A5}

PROCEDURE PopA5;           {restores A5 from stack}
   INLINE $2A5F;           {MOVE.L (SP)+, A5}

PROCEDURE MyConnectionEvtUserRoutine;

BEGIN
{The connection received an unexpected connection event. Find }
{ out what kind and process accordingly.}
   
   PushA5;                 {save the current A5}
   GetMyTRCCBA5;           {set up A5 to point to your }
                           { application's global variables}
   
   WITH dspCCB.u DO
   BEGIN
      IF BAND(userFlags, eClosed) &lt;&gt; 0 THEN TellUserItsClosed;
      IF BAND(userFlags, eTearDown) &lt;&gt; 0 THEN TellUserItsBroken;
      IF BAND(userFlags, eFwdReset) &lt;&gt; 0 THEN TellUserItsReset;
      IF BAND(userFlags, eAttention) &lt;&gt; 0 THEN
      BEGIN                {the event is an attention message}
         myAttnCode := AttnCode;       
                           {get the attention code}
         CopyAttnMsg(AttnPtr, AttnSize, @myAttnData);
                           {copy the attention message into your buffer}
         tempFlag := userFlags;
         tempCFlag := eAttention;
         BClr(LongInt(tempFlag), tempCFlag);
                           {clear the flag}
         userFlags := tempFlag;
         {Do something with the message.}
      END;
      gReceivedAnEvent := TRUE
   END;
   PopA5                   {restore the current A5}
END;
</PRE>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Networking-111.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-113.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Networking-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
