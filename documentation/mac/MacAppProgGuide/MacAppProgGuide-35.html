<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Initializing MacApp's Core Code (MacApp PG)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING35></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="MacAppProgGuide-34.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="MacAppProgGuide-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="MacAppProgGuide-158.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="MacAppProgGuide-36.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="MacAppProgGuide-2.html"><B>Programmer's Guide to MacApp</B></A> / <A HREF="MacAppProgGuide-21.html"><B>Part 1 - MacApp Theory and Architecture</B></A><BR><DD><A HREF="MacAppProgGuide-33.html"><B>Chapter 4 - Launching and Terminating  an Application</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING35-0></A>
<H1><A NAME=MARKER-9-23></A>Initializing MacApp's Core Code</H1>
 A <CODE>main</CODE> routine may begin the process of initializing MacApp by calling <CODE><A NAME=MARKER-2-24></A>InitUMacApp</CODE>, a macro provided as a convenience to invoke three separate calls:<P>
<PRE>
InitUMacApp_Step1();
InstallFailureHandler;
InitUMacApp_Step3(callsToMoreMasters);
</PRE>
 Some applications will need to call these routines directly instead of calling <CODE>InitUMacApp</CODE>. For an example, see <A HREF=MacAppProgGuide-129.html#MARKER-9-77>"Recipe--Launching an Application With a Startup Screen," beginning on page 294</A>.<P>
 The three calls made by <CODE>InitUMacApp</CODE> perform the bulk of all MacApp initialization. <A HREF=#MARKER-9-31>Figure 4-2</A> shows the initialization steps performed by <CODE>InitUMacApp</CODE>. These routines are described in the following sections.<P>
<A NAME=HEADING35-5></A>
<H2><A NAME=MARKER-2-25></A><A NAME=MARKER-9-26></A>InitUMacApp_Step1</H2>
 The <CODE>InitUMacApp_Step1</CODE> routine has these responsibilities:<P>
<UL>
<LI>It calls the <CODE>UniversalStartup</CODE> routine to<P>
<UL>
<LI>make sure the application can run with the current processor
<LI>initialize the Macintosh Toolbox
<LI>perform preliminary memory initialization<P>
</UL>
<LI>It verifies that the hardware and software features required by the application are available on the current machine.<P>
</UL>
 These operations are described in the following sections.<P>
<A NAME=HEADING35-13></A>
<H3>UniversalStartup</H3>
 The <CODE><A NAME=MARKER-2-28></A>UniversalStartup</CODE> routine can run safely on 68K-based or Power Macintosh machines. It performs initialization that must be done before it is known which type of processor is present.<P>
<A NAME=HEADING35-15></A>
<H4>Checking the Processor</H4>
 The <CODE>UniversalStartup</CODE> routine first calls MacApp's <CODE>ValidateProcessor</CODE> routine. <CODE>ValidateProcessor</CODE> uses the Toolbox <CODE>Gestalt</CODE> routine to check processor requirements. The application may require a 68020, 68030, or 68040 microprocessor. It may also require a floating-point unit. If the required processor is not available, <CODE>UniversalStartup</CODE> displays an alert box and terminates the application.<P>
<A NAME=HEADING35-17></A>
<H4>Initializing the Macintosh Toolbox</H4>
 The <CODE>UniversalStartup</CODE> routine next calls MacApp's <CODE>InitToolBox</CODE> routine, which makes sure there is enough memory available to perform required Toolbox initialization and then calls the <CODE><A NAME=MARKER-2-41></A>DoRealInitToolBox</CODE> routine.<P>
 If the application is set up to run in the background only, <CODE>DoRealInitToolBox</CODE> terminates the program, since MacApp does not currently support <P>
<B>Figure 4-2  <A NAME=MARKER-9-31></A>Initialization performed by the <CODE>InitUMacApp</CODE> macro</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/MacApp_PG-L-061.gif"><P>
 background-only operation. Otherwise, <CODE>DoRealInitToolBox</CODE> calls Toolbox initialization routines that most applications require: <CODE>InitGraf</CODE>, <CODE>InitFonts</CODE>, <CODE>InitWindows</CODE>, <CODE>InitMenus</CODE>, <CODE>TEInit</CODE>, <CODE>InitDialogs</CODE>, and <CODE>InitCursor</CODE>. These routines initialize <A NAME=MARKER-2-32></A>Toolbox <B>managers</B>--sets of software routines in the Macintosh ROM that handle various parts of the computer's operation. They must be initialized in a specific order before an application can run.You can read about these routines in the <I>Inside Macintosh</I> volumes <I>Imaging</I>, <I>Macintosh Toolbox Essentials</I>, <I>Overview</I>, and <I>Text</I>.<P>
<A NAME=HEADING35-23></A>
<H4><A NAME=MARKER-2-33></A>Performing Preliminary Memory Initialization</H4>
 The <CODE>UniversalStartup</CODE> routine then calls MacApp's <CODE>ExpandHeap</CODE> routine to perform certain preliminary memory initialization tasks. <CODE>ExpandHeap</CODE> examines the application's <CODE>'mem!'</CODE> and <CODE>'ppc!'</CODE> (<CODE>'68k!'</CODE> for 68K applications) resources to determine the size for the object heap, the heap increment, the temporary reserve, the low space reserve, and the stack. <CODE>UniversalStartup</CODE> stores these values in global variables for later use when memory initialization is completed. It then calls the MacApp routine <CODE>SetStackSpace</CODE> to set the stack for the application and calls the Toolbox routine <CODE>MaxApplZone</CODE> to expand the application heap zone to include all available heap memory.<P>
<A NAME=HEADING35-25></A>
<H3>Validating the Machine Configuration</H3>
 The <CODE>InitUMacApp_Step1</CODE> routine calls the <CODE>ValidateConfiguration</CODE> routine to ensure that the current machine matches the required configuration. <CODE><A NAME=MARKER-2-35></A>ValidateConfiguration</CODE> calls individual MacApp routines such as <CODE>GetSystemVersion</CODE> to test for various features. MacApp itself currently requires System 7.0 or later and Color QuickDraw. Your application may require System 7.5. If so, you specify that requirement when you build your application. <A HREF=MacAppProgGuide-148.html#MARKER-9-10>Appendix A</A> explains how to specify various requirements with the MacApp build system.<P>
<A NAME=HEADING35-27></A>
<H2><A NAME=MARKER-9-36></A>Installing a Top-Level Failure Handler</H2>
 The <CODE>InstallFailureHandler</CODE> macro installs a topmost failure handler for the application. This failure handler must be set up in the <CODE>main</CODE> routine so that the return address the failure handler saves is always part of the call chain. To ensure this outcome, the <CODE>InitUMacApp</CODE> routine is implemented as a macro. (MacApp's failure-handling mechanism is described in <A HREF=MacAppProgGuide-25.html#MARKER-9-21>Chapter 3, "Core Technologies."</A>)<A NAME=MARKER-10-8></A><P>
<A NAME=HEADING35-29></A>
<H2><A NAME=MARKER-2-38></A><A NAME=MARKER-9-39></A>InitUMacApp_Step3</H2>
 The <CODE>InitUMacApp_Step3</CODE> routine finishes initializing MacApp after the top-level failure handler has been installed. It makes the following calls, to initialize MacApp's memory management system, to initialize MacApp's segment management system (on 68K-based machines), and to perform other MacApp initialization required by all applications.<P>
<PRE>
InitUMemory(callsToMoreMasters);
#if qSegments
   InitUSegments();
#endif // qSegments
DoInitUMacApp();
</PRE>
 MacApp's segment management system is needed only for segmented, 68K applications. MacApp uses the <CODE>qSegments</CODE> flag to control compilation of this code.<P>
 The initialization tasks performed by the <CODE><A NAME=MARKER-9-1></A>InitUMemory</CODE> routine are described in detail in <A HREF=MacAppProgGuide-123.html#MARKER-9-21>"Initializing MacApp's Memory Management," beginning on page 70</A>. <A NAME=MARKER-2-41></A>MacApp's segment management system, described in detail in <A HREF=MacAppProgGuide-25.html#MARKER-9-21>Chapter 3, "Core Technologies,"</A> is part of memory management for 68K-based machines. The initialization tasks performed by the <CODE>InitUSegments</CODE> routine are described in <A HREF=MacAppProgGuide-30.html#MARKER-9-170>"Initializing MacApp's Segment Management," beginning on page 71</A>.<P>
<A NAME=HEADING35-34></A>
<H2><A NAME=MARKER-9-42></A>Performing Additional Required Initialization</H2>
 After calling <CODE>InitUMemory</CODE>, <CODE>InitUMacApp_Step3</CODE> calls the <CODE><A NAME=MARKER-2-43></A>DoInitUMacApp</CODE> routine to initialize the core of MacApp. The <CODE>DoInitUMacApp</CODE> routine first calls <CODE>InitUObject</CODE>, which initializes MacApp's runtime type information for objects (see <A HREF=MacAppProgGuide-23.html#MARKER-9-21>page 27</A>). This information cannot be initialized until after <CODE>InitUMemory</CODE> has been called.<P>
 If the application is built to include MacApp's debug information, <CODE>DoInitUMacApp</CODE> calls <CODE>InitUDebug</CODE>.<P>
 <CODE>DoInitUMacApp</CODE> then patches the Macintosh Toolbox trap <CODE><A NAME=MARKER-2-44></A>ExitToShell</CODE> to call the MacApp routine <CODE><A NAME=MARKER-2-45></A>CleanupMacApp</CODE>. From this point on, if <CODE>ExitToShell</CODE> is called to terminate the application, the patch calls MacApp's cleanup routine (see also <A HREF=MacAppProgGuide-39.html#MARKER-9-71>"Terminating the Application," beginning on page 95</A>).<P>
 <CODE>DoInitUMacApp</CODE> then performs additional initialization required by most applications:<P>
<UL>
<LI>It creates global convenience variables for a temporary region and a port (<CODE><A NAME=MARKER-2-46></A>gTemporaryRegion</CODE> and <CODE><A NAME=MARKER-2-47></A>gWorkPort</CODE>).
<LI>It initializes MacApp's code unit that automatically displays a busy cursor during long operations.
<LI>For applications that create views from resource templates, it registers certain view classes (see <A HREF=MacAppProgGuide-65.html#MARKER-9-119>"Registering View Classes," beginning on page 219</A>).<P>
</UL>
 Finally, <CODE>DoInitUMacApp</CODE> calls initialization routines for various MacApp code units. These routines create and initialize objects to aid the application with drawing (<CODE><A NAME=MARKER-2-48></A>InitUAdorners</CODE>), menu handling (<CODE><A NAME=MARKER-2-49></A>InitUMenuMgr</CODE>), and Clipboard support (<CODE>InitUClipboardMgr</CODE>).<P>
 If the application is built to include MacApp's debugging code, <CODE>DoInitUMacApp</CODE> calls initialization routines for two units used in debugging, <CODE><A NAME=MARKER-9-154></A>InitUDialog</CODE> and <CODE><A NAME=MARKER-2-52></A>InitUTEView</CODE>. (If your application uses MacApp's dialog or text-editing view support, you should call these routines from your <CODE>main</CODE> routine, whether or not you are building a debug version.)<A NAME=MARKER-9-74></A><P>

</BLOCKQUOTE>
<HR>
<center>
<A HREF="MacAppProgGuide-34.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="MacAppProgGuide-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="MacAppProgGuide-158.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="MacAppProgGuide-36.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="MacAppProgGuide-3.html">&copy; Apple Computer, Inc.</A><br>25 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
