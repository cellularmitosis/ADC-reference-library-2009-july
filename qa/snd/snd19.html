<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Q&amp;A SND19: Synchronizing Sounds to Video</title><meta name="keywords" content="Mac OS 9 sound callback"><meta name="Description" content="Technical Q&amp;A SND19: Q&amp;A discusses how to enable sound callbacksto be called regularly under Mac OS 9 and Sound Manager 4.0.">	<meta name="categories" content="Sound"><meta name="week-posted" content="Oct 4, 1999 - Oct 8, 1999"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"><a name="//apple_ref/doc/uid/DTS10002186" title="Synchronizing Sounds to Video"></a> <!-- white background --><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/MusicAudio/index.html">Audio</a> &gt; <a href="../../technicalqas/MusicAudio/idxCarbon-date.html">Carbon</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Not Recommended Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>The information in this document is <strong>Not Recommended</strong> and should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/MusicAudio/idxCarbon-date.html" target="_blank">Audio > Carbon</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A SND19</div>
<div id="pageheadsub">Synchronizing Sounds to Video</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER>			<!-- -->						<!-- Document Body --><table cellspacing="0" cellpadding="0" border="0" WIDTH="600"><tr><td align="left" scope="row"><hr width=500 align=center><p id=p2>Q: With Mac OS 9.0 and Sound Manager 4.0, my sound callbacks are no longer being called in a regular manner. This makes it very hard to synchronize sound to video. How can I get my sound callbacks to be called regularly?</p><p id=p4>A: The big change with Sound Manager 4.0 isthat your callbacks happen as soon as the sound has been given to theDMA engine to give to the hardware, and that the DMA buffer has increased in size. This means that the callbacks are getting called a little sooner than they used to. This problem is exasperated by having a buffer that is smaller than the hardware&#146;s (or in this case the DMA buffer&#146;s).</p><p id=p4>When you have a buffer of sound data to play that is smaller than the hardware&#146;s buffer, it will be copied completely into thehardware&#146;s buffer. At that point the sound is considered to be&#147;done,&#148; and the next command in the sound channel&#146;s queue will be called. Typically the next command in the queue would be a<CODE>callBackCmd</CODE>. If you were expecting that the sound be done when your callback was called, you are in for a problem because the sound is probably not done.</p><p id=p4>The solution to this problem is simple: increase the size of the buffers that you play. You want the buffer&#146;s size to be at least the size of the hardware&#146;s, and for most situations, twice the hardware&#146;s buffer size is a good choice.</p><p id=p4>Currently, with Sound Manager 4.0 the buffer size without VM on is 512 samples, and with VM on is 4,096 samples.</p><p id=p4>However, you should not assume that you know these values as they may change in the future. You can query the hardware to get thesevalues using the following code:</p><TABLE BORDER=1>   <TR>      <td bgcolor="#CCCCCC" align=left>         <pre>/*    Returns the size of the output buffer in bytes.*/static long GetSoundOutputBufferSize (Component outputDevice,short sampleSize, short numChannels,   UnsignedFixed sampleRate) {    SoundComponentData  outputFormat;    OSErr               err;    SndChannelPtr       chan            = nil;    SndCommand          cmd;    ExtSoundHeader      sndHeader;    long                bufSize         = 0;    err = SndNewChannel (&amp;chan, 0, 0, nil);    sndHeader.samplePtr = nil;    sndHeader.numChannels = numChannels;    sndHeader.sampleRate = sampleRate;    sndHeader.loopStart = 0;    sndHeader.loopEnd = 0;    sndHeader.encode = extSH;    sndHeader.baseFrequency = kMiddleC;    sndHeader.numFrames = 0;    sndHeader.markerChunk = nil;    sndHeader.instrumentChunks = nil;    sndHeader.AESRecording = nil;    sndHeader.sampleSize = sampleSize;    sndHeader.futureUse1 = 0;    sndHeader.futureUse2 = 0;    sndHeader.futureUse3 = 0;    sndHeader.futureUse4 = 0;    sndHeader.sampleArea[0] = 0;    // This really isn't needed since the Sound Manager currently    // ignores this value.    UnsignedFixedTox80 (sampleRate, &amp;sndHeader.AIFFSampleRate);    // Get the sound channel setup so we can query it.    cmd.cmd = soundCmd;    cmd.param2 = (long)&amp;sndHeader;    err = SndDoCommand (chan, &amp;cmd, true);    if (err == noErr) {        err = GetSoundOutputInfo (outputDevice, siHardwareFormat, &amp;outputFormat);    }#if DEBUG    if (err != noErr) {        printf ("Got error #%d trying to do GetSoundOutputInfo with        siHardwareFormat\n\n", err);    } else {        bufSize = outputFormat.sampleCount * (sampleSize / 8) * numChannels;        printf ("Sound output buffer is %d samples, ", outputFormat.sampleCount);        printf ("which is %d bytes.\n\n", bufSize);    }#endif    return (bufSize);}</pre>      </TD>   </TR></TABLE><BR><TABLE>	<TR>		<td width=500 align=left><p id=p4>If the <CODE>GetSoundOutputInfo</CODE> call fails, you can fall back to assuming that the size of the sound output buffer is the size of the sound input buffer, and you can get that information with this call:</p>		</TD>	</TR></TABLE><BR><TABLE BORDER=1>   <TR>      <td bgcolor="#CCCCCC" align=left>         <pre>/*    Returns the size of the input buffer in bytes.*/static long GetSoundInputBufferSize (UInt32 siRefNum) {    OSErr               err;    long                inputBufferSize;    err = SPBGetDeviceInfo (siRefNum, siDeviceBufferInfo, &amp;inputBufferSize);#if DEBUG    if (err != noErr) {        printf ("\nGet device buffer info error, err: %d\n", err);    } else {        printf ("\nSound input buffer is %d bytes\n", inputBufferSize);    }#endif    return (inputBufferSize);}</pre>      </TD>   </TR></TABLE><BR><!-- begin_date --><H4 ALIGN=center>[Oct 05 1999]</H4><!-- end_date --></td></tr></table></CENTER><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/snd/snd19.html%3Fid%3DDTS10002186-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/snd/snd19.html%3Fid%3DDTS10002186-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/snd/snd19.html%3Fid%3DDTS10002186-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>