<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Using Shadow Libraries </TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING40></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="RTArch-39.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="RTArch-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="RTArch-147.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="RTArch-41.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="RTArch-2.html"><B>Mac OS Runtime Architectures</B></A> / <BR><DD><A HREF="RTArch-35.html"><B>Chapter 3 - Programming for the CFM-Based Runtime Architecture </B></A> / <A HREF="RTArch-36.html"><B>Calling the Code Fragment Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING40-0></A>
<H2>Using Shadow Libraries </H2>
 <A NAME=MARKER-2-33></A>In some cases you might want to prepare import libraries on an "on-call" basis the same way you would with plug-ins. For example, if you only occasionally use routines from <CODE>mooLib</CODE> in your application, you may not want to take up excess memory when <CODE>mooLib</CODE> is not required. In such cases, you should create a shadow library. A shadow library is essentially a small library whose only purpose is to prepare an import library when a symbol from that library is required.<P>
 For example, suppose you have a simple header file with this function:<P>
 <CODE>StatusType FunctionOne (ParamOneAType param1A, ParamOneBType param1B);</CODE><P>
 <A HREF=#MARKER-9-34>Listing 3-5</A> shows how to access these functions through a simple shadow library. <P>
<B>Listing 3-5  <A NAME=MARKER-9-34></A>Sample code found in a shadow library</B><P>
<PRE>
/* Function pointers used internally by the shadows. */
typedef StatusType (* FunctionOnePtr) (PramOneAType param1A, ParamOneBType param1B);

/* The initial version of the function pointers. */
static StatusType PrepareAndCallF1 (ParamOneAType param1A, ParamOneBType param1B);
static FunctionOnePtr gFunctionOne = PrepareAndCallF1;

/* The initial version of the function pointer, which does setup first, and then */
/* calls through to the actual function. */

static StatusType PrepareAndCallF1 (ParamOneAType param1A, ParamOneBType param1B)
{
   OSErr err = Setup ();
   if (err == noErr) 
      err = (*gFunctionOne) (param1A, param1B);
   return err;
}

/* The shadow implememtation of FunctionOne, which calls through the */
/* function pointer, which itself could point to the setup version */
/* (first time) or to the actual routine (second time or later). */

StatusType FunctionOne (ParamOneAType param1A, ParamOneBType param1B)
   {
   return (*gFunctionOne) (param1A, param1B);
   }

static OSErr Setup (void)
   {
   CFragConnectionID connID;
   OSErr err = GetSharedLibrary (&quot;\pRealImplementation&quot;, 
                                   kCompiledCFragArch, kReferenceCFrag,
                                   &amp;connID, NULL, NULL);

   if (err == noErr) 
      {
      FunctionOnePtr p1;
      err = FindSymbol (connID, &quot;\pFunctionOne&quot;, (Ptr *) &amp; p1, NULL);
      if (err == noErr)
         gFunctionOne = p1;
      }
   return err;
   }
</PRE>
 This example just uses local pointers to go to the "right" function.  The first time through, these pointers take you to routines that call the Code Fragment Manager to prepare the real library. Subsequent times they take you to the real routines.  This implementation requires no changes to clients (for example, you can change the import library without recompiling or relinking the clients).  <P>
 Note that this example works only if all functions in the library return some sort of success/failure indication.  This could be through an explicit status value, a null/nonnull pointer, and so on. Also, this example is not preemptive thread safe, and it does not have sophisticated error checking. If you are writing code to prepare a shadow library, you should anticipate errors such as the following:<P>
<UL>
<LI>The initialization function in the library fails.
<LI>The Code Fragment Manager cannot find a compatible library.
<LI>The Code Fragment Manager cannot find the required symbols in the library.<P>
</UL>
 Also, if your shadow library may be released at some point, you should include code in the library's termination routine to release any libraries it has prepared and to perform any other necessary cleanup. <A NAME=MARKER-2-35></A><P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="RTArch-39.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="RTArch-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="RTArch-147.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="RTArch-41.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="RTArch-3.html">&copy; Apple Computer, Inc.</A><br>11 MARCH 1997<P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML> 
