<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html><head>
<!-- BEGIN META TAG INFO -->
<link rel="home" href="http://developer.apple.com/">
<link rel="find" href="http://developer.apple.com/search/">
<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
<script language="JavaScript" type="text/javascript" src="../../documentation/js/busnav.js"></script>
<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<!-- END META TAG INFO -->
<!-- BEGIN TITLE -->
<title>Technical Note TN2137: Building Universal Binaries from &quot;configure&quot;-based Open Source Projects</title>
<!-- END TITLE -->
</head>
<!-- BEGIN BODY OPEN -->
<body bgcolor="#ffffff"><a name="//apple_ref/doc/uid/DTS10003754" title="Building Universal Binaries from "configure"-based Open Source Projects"></a>
<!--END BODY OPEN -->
<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->
<a name="top"></a>
<!-- BEGIN LOGO AND SEARCH -->
<!--#include virtual="/includes/adcnavbar"-->
<!-- END LOGO AND SEARCH -->
<!-- START BREADCRUMB -->
<div id="breadcrumb"><table width="680" border="0" cellpadding="0" cellspacing="0"><tr>
<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
<td><img width="340" height="10" src="images/1dot.gif" alt=""></td></tr><tr valign="middle"><td align="left" colspan="2">
<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/OpenSource/index.html">Open Source</a> &gt; <a href="../../technicalnotes/OpenSource/idxPorting-date.html">Porting</a> &gt; 
</td></tr><tr><td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td></tr></table></div>
<!-- END BREADCRUMB -->

<!-- START MAIN CONTENT -->
<!-- START TITLE GRAPHIC AND INTRO-->
<table width="680" border="0" cellpadding="0" cellspacing="0"><tr align="left" valign="top">
<td><h1>
<div id="pagehead">Technical Note TN2137</div>
<div id="pageheadsub">Building Universal Binaries from &quot;configure&quot;-based Open Source Projects</div>
</h1></td></tr></table>
<!-- END TITLE GRAPHIC AND INTRO -->
<!-- BEGIN WIDE COLUMN -->
<table width="680" border="0" cellpadding="0" cellspacing="0"><tr align="left" valign="top"><td align="left" width="680">
<!-- BEGIN CONTENTS -->
<table width="680" border="0" cellpadding="0" cellspacing="0"><tr align="left" valign="top"><td><p>This technical note discusses how to build universal binaries out of some &quot;configure&quot;-based Open Source projects.</p></td></tr><tr><td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br><img height="1" width="680" src="images/1dot_919699.gif" alt=""><br><img width="680" height="20" src="images/1dot.gif" alt=""></td></tr></table><table width="680" border="0" cellpadding="0" cellspacing="0"><tr align="left" valign="top"><td width="680"><ul><li><a href="#TNTAG1">Introduction</a></li><li><a href="#TNTAG2">Configuring for universal binaries</a></li><li><a href="#TNTAG3">Merging multiple builds</a></li><li><a href="#TNTAG4">What to Watch Out For</a></li><li><a href="#TNT_HISTORY_TAG">Document Revision History</a></li></ul></td></tr><tr><td colspan="3" scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br><img height="1" width="680" src="images/1dot_919699.gif" alt=""><br><img width="680" height="20" src="images/1dot.gif" alt=""></td></tr></table><A NAME="TNTAG1"></A><H2>Introduction</H2><p>The Xcode IDE provides a streamlined build system that hides most of the complexity of building a universal binary.  Settings, environment variables, and the commands to actually build and link the source file are either implict in pre-set build configurations, or are easily adjustable from the Xcode UI.</p><p>Many open source projects use a build-time configuration script to determine the environment in which the program will compile and run, including machine information (such as CPU type, word order and pointer size), and which header files and libraries are available on the system.  This script typically constructs one or more Makefiles and header files.  The Makefiles will contain the compiler and linker options, and cannot benefit from the automated constructs in the Xcode IDE.  The header files generated by this process typically contain constants that are used in feature tests., e.g.</p><pre class="sourcecodebox">
#ifdef HAVE_UNISTD_H
# include &lt;unistd.h&gt;
#endif
</pre><p>with a <code>#define HAVE_UNISTD_H</code> in the generated <code>config.h</code> file.</p><p>This approach works well in traditional compilation environments, and has made it relatively easy to port many Open Source projects to Mac OS X; the problem arises because the configure environment was not envisioned with a universal binary-like situation in mind.</p><div class="notebox"><p><strong>Note:</strong> This technote does not discuss any code changes that might be necessary to migrate an existing project to an Intel-based Macintosh.  See the <A HREF="../../documentation/MacOSX/Conceptual/universal_binary/index.html">Universal Binary Programming Guide</A> for discussion of which code changes may be required.</p></div><p>There are two main approaches to handling this, and producing a universal binary.  We will examine both approaches using the GNU Hello package, a &quot;Hello, World&quot; program designed to show how to use the configure script.  The GNU Hello source is available from the <A HREF="http://directory.fsf.org/GNU/hello.html">Free Software Foundation</A>.</p><p><a href="#top">Back to Top</a>&nbsp;<a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p><A NAME="TNTAG2"></A><H2>Configuring for universal binaries</H2><p>The first approach is to simply have <code>configure</code> build a universal binary, by passing in the appropriate <code>CFLAGS</code> and <code>LDFLAGS</code> environment variables.  This is done simply by running</p><pre class="sourcecodebox">
env CFLAGS=&quot;-O -g -isysroot /Developer/SDKs/MacOSX10.4u.sdk -arch i386 -arch ppc&quot; \
  LDFLAGS=&quot;-arch i386 -arch ppc&quot;   ./configure --prefix=${HOME}/Hello --disable-dependency-tracking
</pre><p>from the shell command prompt.  The <code>--disable-dependency-tracking</code> option to <code>configure</code> causes it to not use gcc's built-in dependency generation code, which does not work with multiple <code>-arch</code> targets.  To verify that your configure script properly handles the <code>--disable-dependency-tracking</code> option, use the help option on configure:</p><pre class="sourcecodebox">
./configure --help
</pre><p>The help option prints out a message giving usage instructions for configure, as well as arguments it understands how to process.</p><div class="notebox"><p><strong>Note:</strong> On an Intel-based Macintosh system the libraries are already universal, and support the Intel and PowerPC architectures, and you may specify only the <code>-arch i386 -arch ppc</code> options for <code>CFLAGS</code>; on a PowerPC-based Macintosh, you must use the MacOSX10.4u SDK.</p></div><p>After running configure and then building with make, the result is a universal binary in <code>./src/hello</code>.  We can verify this by querying the file type using the file command:</p><pre class="sourcecodebox">
file ./src/hello
</pre><p>which would output:</p><pre class="sourcecodebox">
src/hello: Mach-O fat file with 2 architectures
src/hello (for architecture i386):      Mach-O executable i386
src/hello (for architecture ppc):       Mach-O executable ppc
</pre><p>This executable can be natively run on both PowerPC- and Intel-based Macintoshes.</p><p><a href="#top">Back to Top</a>&nbsp;<a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p><A NAME="TNTAG3"></A><H2>Merging multiple builds</H2><p>While the GNU Hello program is one of the most complicated &quot;Hello, World&quot; programs ever written, it is still a relatively simple program:  it does not care about byte order, word size, or pointer size; nor does the configuration process generate any executables which themselves produce configuration files based on the machine target.  Not all Open Source projects are this simple.  For them, there is another approach, which involves using the <code>lipo</code> command.</p><p>If it had not been possible to configure and build the GNU Hello program using the process above, we could still produce a universal binary by configuring and building the program multiple times (very likely on multiple machines).</p><p>On both an Intel- and PowerPC-based Macintosh, configure and build the program as follows:</p><pre class="sourcecodebox">
./configure --prefix=${HOME}/Hello
make
</pre><p>Copy the resultant <code>src/hello</code> programs to a single machine; for example, into <code>/tmp</code> on a PowerPC-based Macintosh, with the names <code>hello-intel</code> and <code>hello-ppc</code>, respectively.  Then, use the <code>lipo</code> command to combine the two:</p><pre class="sourcecodebox">
lipo -create hello-intel hello-ppc -output hello
</pre><p>As before, the <code>file</code> command can verify the file contents:</p><pre class="sourcecodebox">
file hello
</pre><p>will report</p><pre class="sourcecodebox">
hello: Mach-O fat file with 2 architectures
hello (for architecture i386):  Mach-O executable i386
hello (for architecture ppc):   Mach-O executable ppc
</pre><p>For more complicated projects, it may be necessary to install each configuration, and generate a list of Mach-O files (libraries and executables), and run <code>lipo</code> on each of them.</p><p><a href="#top">Back to Top</a>&nbsp;<a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p><A NAME="TNTAG4"></A><H2>What to Watch Out For</H2><p>Even with this approach, however, there are some things to be aware of:</p><p>First, all architectures should be configured the same way.  If the configuration for one architecture expects run-time files to be in <code>/usr/local/etc</code>, but the configuration for another architecture expects them to be in <code>/etc</code>, the run-time behaviors will be different.</p><p>Second, sometimes it is not possible to avoid that situation, e.g., if the configuration process uses the processor type (e.g., &quot;ppc&quot; or &quot;i386&quot; or &quot;i686&quot;) in the run-time directories.  When building such a project for binary release, it may be necessary to manually examine the trees created by the install process, and ensure that either all variants are in the final release, or that symbolic links are used to emulate this.  (E.g., <code>/usr/local/myproj/etc/i386/input.conf</code> and <code>/usr/local/myproj/etc/ppc/input.conf</code> should either both be present, or a symbolic link may be used to point <code>/usr/local/myproj/etc/ppc</code> at <code>/usr/local/myproj/etc/i386</code>.)</p><p><a href="#top">Back to Top</a>&nbsp;<a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p><A NAME="TNT_HISTORY_TAG"></A><H2>Document Revision History</H2><table cellspacing="0" class="graybox" width="680"><tr><th width="100">Date</th><th width="580">Notes</th></tr><tr><td scope="row">2006-10-05</td><td>Corrected section on LDFLAGS. Added information on handling configure scripts that don't respond to --disable-dependency-tracking</td></tr><tr><td scope="row">2005-08-25</td><td>Describes some methods for building some existing &quot;configure&quot;-based Open Source packages as universal binaries.</td></tr></table><p><b>Posted:</b> 2006-10-05</p>
<!-- END CONTENTS -->
</td></tr></table>
<!-- END WIDE COLUMN -->
<!-- END MAIN CONTENT -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn2005/tn2137.html%3Fid%3DDTS10003754-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn2005/tn2137.html%3Fid%3DDTS10003754-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn2005/tn2137.html%3Fid%3DDTS10003754-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

<!-- START BOTTOM APPLE NAVIGATION -->
<!--#include virtual="/includes/footer"-->
<!-- END BOTTOM APPLE NAVIGATION -->
<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->
</body></html>