<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Summary of ADSP(IM:N)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING142></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Networking-141.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-143.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Networking-2.html"><B>Networking</B></A> / <BR><DD><A HREF="Networking-98.html"><B>Chapter 5 - AppleTalk Data Stream Protocol (ADSP) </B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING142-0></A>
<H1>Summary of ADSP</H1>
<A NAME=HEADING142-1></A>
<H2>Pascal Summary</H2>
<A NAME=HEADING142-2></A>
<H3>Constants</H3>
<PRE>
CONST
   {ADSP routine selectors}
   dspInit                 = 255;         {create a new connection end}
   dspRemove               = 254;         {remove a connection end}
   dspOpen                 = 253;         {open a connection}
   dspClose                = 252;         {close a connection}
   dspCLInit               = 251;         {create a connection listener}
   dspCLRemove             = 250;         {remove a connection listener}
   dspCLListen             = 249;         {post a listener request}
   dspCLDeny               = 248;         {deny an open-connection request}
   dspStatus               = 247;         {get status of connection end}
   dspRead                 = 246;         {read data from the connection}
   dspWrite                = 245;         {write data on the connection}
   dspAttention            = 244;         {send an attention message}
   dspOptions              = 243;         {set connection end options}
   dspReset                = 242;         {forward reset the connection}
   dspNewCID               = 241;         {generate a CID for a }
                                          { connection end}
   sdspOpen                = 229;         {open a secure connection}
   {ADSP connection-opening modes}
   ocRequest               = 1;           {request a connection with a }
                                          { remote connection end}
   ocPassive               = 2;           {wait for a connection request }
                                          { from remote connection end}
   ocAccept                = 3;           {accept request as delivered by }
                                          { listener}
   ocEstablish             = 4;           {consider connection to be open}
   
   {ADSP connection end states}
   sListening              = 1;           {for connection listeners}
   sPassive                = 2;           {waiting for a connection }
                                          { request from remote }
                                          { connection end}
   sOpening                = 3;           {requesting a connection }
                                          { with remote connection end}
   sOpen                   = 4;           {connection is open}
   sClosing                = 5;           {connection is being torn down}
   sClosed                 = 6;           {connection end state is closed}

   {ASDSP end-of-message and encrypt flags and masks}
   dspEncryptBit           = 1;           {set to encrypt message}
   dspEOMBit               = 0;           {set if EOM at end of write}
   dspEOMMask              = $1;          {mask for setting the EOM bit}
   dspEncryptMask          = $2;          {mask for setting the encrypt bit}

   {ADSP client event flags}
   eClosed                 = $80;         {received connection-closed event}
   eTearDown               = $40;         {closed due to broken connection}
   eAttention              = $20;         {received attention message}
   eFwdReset               = $10;         {received forward reset event}
   
   {miscellaneous ADSP constants}
   attnBufSize             = 570;         {size of client attention buffer}
   minDSPQueueSize         = 100;         {minimum size of receive or }
                                          { send queue}

   {driver control ioResults}
   errRefNum               = -1280;       {bad connection refNum}
   errAborted              = -1279;       {control call was aborted}
   errState                = -1278;       {bad connection state for this }
                                          { operation}
   errOpening              = -1277;       {open connection request failed}
   errAttention            = -1276;       {attention message too long}
   errFwdReset             = -1275;       {read terminated by forward reset}
   errDSPQueueSize         = -1274;       {DSP read/write queue too small}
   errOpenDenied           = -1273;       {open connection request denied}
</PRE>
<A NAME=HEADING142-5></A>
<H3>Data Types</H3>
<A NAME=HEADING142-6></A>
<H4>The ADSP Connection Control Block Record</H4>
<PRE>
TYPE TRCCB = 
   PACKED RECORD
      ccbLink:          TPCCB;      {link to next CCB}
      refNum:           Integer;    {reference number}
      state:            Integer;    {state of the connection end}
      userFlags:        Byte;       {user flags for connection}
      localSocket:      Byte;       {local socket number}
      remoteAddress:    AddrBlock;  {remote end internet address}
      attnCode:         Integer;    {attention code received}
      attnSize:         Integer;    {size of attention data}
      attnPtr:          Ptr;        {pointer to attention data}
      reserved:         PACKED ARRAY[1..220] OF Byte;
                                    {reserved for use by ADSP}
   END;
</PRE>
<A NAME=HEADING142-8></A>
<H4>The Address Block Record</H4>
<PRE>
TYPE AddrBlock = 
   PACKED RECORD
      aNet:             Integer;    {network number}
      aNode:            Byte;       {node ID}
      aSocket:          Byte;       {socket number}
   END;
</PRE>
<A NAME=HEADING142-10></A>
<H4>The DSP Parameter Block</H4>
<PRE>
TYPE DSPParamBlock = 
   PACKED RECORD
      qLink:            QElemPtr;   {reserved}
      qType:            Integer;    {reserved}
      ioTrap:           Integer;    {reserved}
      ioCmdAddr:        Ptr;        {reserved}
      ioCompletion:     ProcPtr;    {completion routine}
      ioResult:         OSErr;      {result code}
      ioNamePtr:        StringPtr;  {reserved}
      ioVRefNum:        Integer;    {reserved}
      ioCRefNum:        Integer;    {driver reference number}
      csCode:           Integer;    {primary command code}
      qStatus:          LongInt;    {reserved}
      ccbRefNum:        Integer;    {CCB reference number}
   CASE Integer OF
   dspInit, dspCLInit:
      (ccbPtr:          TPCCB;      {pointer to CCB}
      userRoutine:      ProcPtr;    {pointer to user routine}
      sendQSize:        Integer;    {size of send queue}
      sendQueue:        Ptr;        {pointer to send queue}
      recvQSize:        Integer;    {size of receive queue}
      recvQueue:        Ptr;        {pointer to receive queue}
      attnPtr:          Ptr;        {pointer to attention-message buffer}
      localSocket:      Byte;       {local socket number}
      filler1:          Byte);      {filler for proper alignment}
   dspOpen, dspCLListen, dspCLDeny:
      (localCID:        Integer;    {local connection ID}
      remoteCID:        Integer;    {remote connection ID}
      remoteAddress:    AddrBlock;  {remote internet address}
      filterAddress:    AddrBlock;  {address filter}
      sendSeq:          LongInt;    {send sequence number}
      sendWindow:       Integer;    {size of remote buffer}
      recvSeq:          LongInt;    {receive sequence number}
      attnSendSeq:      LongInt;    {attention send seq number}
      attnRecvSeq:      LongInt;    {attention receive seq num}
      ocMode:           Byte;       {connection-opening mode}
      ocInterval:       Byte;       {interval bet. open requests}
      ocMaximum:        Byte;       {retries of open-conn req}
      filler2:          Byte);      {filler for proper alignment}
   dspClose, dspRemove:
      (abort:           Byte;       {abort send requests}
      filler3:          Byte);      {filler for proper alignment}
   dspStatus:
      (statusCCB:       TPCCB;      {pointer to CCB}
      sendQPending:     Integer;    {bytes waiting in send queue}
      sendQFree:        Integer;    {available send-queue buffer}
      recvQPending:     Integer;    {bytes in receive queue}
      recvQFree:        Integer);   {avail receive-queue buffer}
   dspRead, dspWrite:
      (reqCount:        Integer;    {requested number of bytes}
      actCount:         Integer;    {actual number of bytes}
      dataPtr:          Ptr;        {pointer to data buffer}
      eom:              Byte;       {1 if end of message}
      flush:            Byte);      {1 to send data now}
   dspAttention:
      (attnCode:        Integer;    {client attention code}
      attnSize:         Integer;    {size of attention data}
      attnData:         Ptr;        {pointer to attention data}
      attnInterval:     Byte;       {reserved}
      filler4:          Byte);      {filler for proper alignment}
   dspOptions:
      (sendBlocking:    Integer;    {send-blocking threshold}
      sendTimer:        Byte;       {reserved}
      rtmtTimer:        Byte;       {reserved}
      badSeqMax:        Byte;       {retransmit advice threshold}
      useCheckSum:      Byte);      {DDP checksum for packets}
   dspNewCID:
      (newCID:          Integer);   {new connection ID}
   END;
DSPPBPtr = ^DSPParamBlock;
</PRE>
<A NAME=HEADING142-13></A>
<H4>The ASDSP Parameter Block</H4>
<PRE>
TYPE SDSPParamBlock = 
   PACKED RECORD
   CASE INTEGER OF
      1: (dspParamBlock: DSPParamBlock);
      2: (qLink:        QElemPtr;      {reserved}
         qType:         Integer;       {reserved}
         ioTrap:        Integer;       {reserved}
         ioCmdAddr:     Ptr;           {reserved}
         ioCompletion:  ProcPtr;       {completion routine}
         ioResult:      OSErr;         {result code}
         ioNamePtr:     StringPtr;     {reserved}
         ioVRefNum:     Integer;       {reserved}
         ioCRefNum:     Integer;       {adsp driver refNum}
         csCode:        Integer;       {asdsp driver control code}
         qStatus:       Longint;       {reserved}
         ccbRefNum:     Integer;       {connection end refNum}
         secureParams:  TRSecureParams);
                                       {parameters for dspOpenSecure}
   END;

SDSPPBPtr = ^SDSPParamBlock; 
</PRE>
<A NAME=HEADING142-15></A>
<H4>The <CODE>TRSecureParams</CODE> Record</H4>
<PRE>
TYPE  TRSecureParams = 
   PACKED RECORD
      localCID:         Integer;       {local connection ID}
      remoteCID:        Integer;       {remote connection ID}
      remoteAddress:    AddrBlock;     {address of remote end}
      filterAddress:    AddrBlock;     {address filter}
      sendSeq:          Longint;       {local send sequence number}
      sendWindow:       Integer;       {send window size}
      recvSeq:          Longint;       {receive sequence number}
      attnSendSeq:      Longint;       {attention send sequence number}
      attnRecvSeq:      Longint;       {attention receive sequence number}
      ocMode:           Byte;          {open connection mode}
      ocInterval:       Byte;          {open connection request }
                                       { retry interval}
      ocMaximum:        Byte;          {open connection request }
                                       { retry maximum}
      secure:           Boolean;       {for initiator, TRUE if session is }
                                       { authenticated}
                                       {for recipient, TRUE if session was }
                                       { authenticated}
      sessionKey:       AuthKeyPtr;    {encryption key for session}
      credentialsSize:  Longint;       {length of credentials}
      credentials:      Ptr;           {pointer to credentials}
      workspace:        Ptr;           {pointer to workspace for }
                                       { connection. Align on }
                                       { even boundary and }
                                       { length = sdspWorkSize}
      recipient:        AuthIdentity;  {identity of recipient }
                                       { or initiator if active mode}
      issueTime:        UTCTime;       {time when credentials were issued}
      expiry:           UTCTime;       {time when credentials expire}
      initiator:        RecordIDPtr;   {RecordID of initiator returned in }
                                       { the buffer pointed to by this field}
      hasIntermediary:  Boolean;       {set if credentials has an }
                                       { intermediary}
      intermediary:     RecordIDPtr;   {Record ID of intermediary returned} 
   END;
</PRE>
<A NAME=HEADING142-17></A>
<H2>C Summary</H2>
<A NAME=HEADING142-18></A>
<H3>Constants</H3>
<PRE>
/*workspace used internally by ASDSP for the sdspOpen call*/
#define sdspWorkSize          2048        /*size of ASDSP workspace*/
enum{                                     /*ADSP routine selectors*/
   dspInit                 = 255,         /*create a new connection end*/
   dspRemove               = 254,         /*remove a connection end*/
   dspOpen                 = 253,         /*open a connection*/
   dspClose                = 252,         /*close a connection*/
   dspCLInit               = 251,         /*create a connection listener*/
   dspCLRemove             = 250,         /*remove a connection listener*/
   dspCLListen             = 249,         /*post a listener request*/
   dspCLDeny               = 248,         /*an open-connection request*/
   dspStatus               = 247,         /*get status of connection end*/
   dspRead                 = 246,         /*read data from the connection*/
   dspWrite                = 245,         /*write data on the connection*/
   dspAttention            = 244,         /*send an attention message*/
   dspOptions              = 243,         /*set connection end options*/
   dspReset                = 242,         /*forward reset the connection*/
   dspNewCID               = 241,         /*generate a CID for a */
                                          /* connection end*/
   sdspOpen                = 229;         /*open a secure connection*/
   
enum {                                    /*ADSP connection-opening modes*/
   ocRequest               = 1,           /*request a connection with a */
                                          /* remote connection end*/
   ocPassive               = 2,           /*wait for a connection request */
                                          /* from remote connection end*/
   ocAccept                = 3,           /*accept request as delivered by */
                                          /* listener*/
   ocEstablish             = 4};          /*consider connection to be */
                                          /* open*/
   
enum {                                    /*ADSP connection end states*/
   sListening              = 1,           /*for connection listeners*/
   sPassive                = 2,           /*waiting for a connection */
                                          /* request from remote */
                                          /* connection end*/
   sOpening                = 3,           /*requesting a connection */
                                          /* with remote connection end*/
   sOpen                   = 4,           /*connection is open*/
   sClosing                = 5,           /*connection is being torn down*/
   sClosed                 = 6};          /*connection end state */
                                          /* is closed*/

/*ASDSP end-of-message and encrypt flags and masks*/
enum {
   dspEOMBit               = 0,           /*set if EOM at end of write*/
   dspEncryptBit           = 1};          /*set to encrypt message*/

enum {
   dspEOMMask              = 1&lt;&lt;dspEOMBit,
   dspEncryptMask          = 1&lt;&lt;dspEncryptBit
};
   
enum {                                    /*ADSP client event flags*/
   eClosed                 = $80,         /*received connection-closed */
                                          /* event*/
   eTearDown               = $40,         /*closed due to broken */
                                          /* connection*/
   eAttention              = $20,         /*received attention message*/
   eFwdReset               = $10};        /*received forward reset event*/
   
enum {                                    /*miscellaneous ADSP constants*/
   attnBufSize             = 570,         /*size of client attention */
                                          /* buffer*/
   minDSPQueueSize         = 100};        /*minimum size of receive or */
                                          /* send queue*/

enum {                                    /*driver control ioResults*/
   errRefNum               = -1280,       /*bad connection refNum*/
   errAborted              = -1279,       /*control call was aborted*/
   errState                = -1278,       /*bad connection state for this */
                                          /* operation*/
   errOpening              = -1277,       /*open connection request */
                                          /* failed*/
   errAttention            = -1276,       /*attention message too long*/
   errFwdReset             = -1275,       /*read terminated */
                                          /* by forward reset*/
   errDSPQueueSize         = -1274,       /*DSP read/write queue */
                                          /* too small*/
   errOpenDenied           = -1273};      /*open connection request */
                                          /* denied*/
</PRE>
<A NAME=HEADING142-21></A>
<H3>Data Types</H3>
<A NAME=HEADING142-22></A>
<H4>The ADSP Connection Control Block Record</H4>
<PRE>
struct TRCCB { 
   unsigned char     *ccbLink;         /*link to next CCB*/
   unsigned short    refNum;           /*reference number*/
   unsigned short    state;            /*state of the connection end*/
   unsigned char     userFlags;        /*user flags for connection*/
   unsigned char     localSocket;      /*local socket number*/
   AddrBlock         remoteAddress;    /*remote end internet address*/
   unsigned short    attnCode;         /*attention code received*/
   unsigned short    attnSize;         /*size of attention data*/
   unsigned char     *attnPtr;         /*pointer to attention data*/
   unsigned char     reserved[220];    /*reserved*/
};
typedef struct TRCCB TRCCB;
typedef TRCCB *TPCCB;
</PRE>
<A NAME=HEADING142-25></A>
<H4>The Address Block Record</H4>
<PRE>
struct AddrBlock {
   short             aNet;             /*network number*/
   unsigned char     aNode;            /*node ID*/
   unsigned char     aSocket;          /*socket number*/
};
typedef struct AddrBlock AddrBlock; 
</PRE>
<A NAME=HEADING142-28></A>
<H4>Parameter Block for dspInit and dspCLInit</H4>
<PRE>
struct TRinitParams {
   TPCCB             ccbPtr;        /*pointer to connection control block*/
   ProcPtr           userRoutine;   /*client routine to call on event*/
   unsigned short    sendQSize;     /*size of send queue (0..64K bytes)*/
   unsigned char     *sendQueue;    /*client passed send queue buffer*/
   unsigned short    recvQSize;     /*size of receive queue */
                                    /* (0..64K bytes)*/
   unsigned char     *recvQueue;    /*client passed receive queue buffer*/
   unsigned char     *attnPtr;      /*client passed receive attention */
                                    /* buffer*/
   unsigned char     localSocket;   /*local socket number*/
};
typedef struct TRinitParams TRinitParams;
</PRE>
<A NAME=HEADING142-31></A>
<H4>Parameter Block for dspOpen, dspCLListen, and dspCLDeny</H4>
<PRE>
struct TRopenParams {
   unsigned short    localCID;         /*local connection ID*/
   unsigned short    remoteCID;        /*remote connection ID*/
   AddrBlock         remoteAddress;    /*address of remote end*/
   AddrBlock         filterAddress;    /*address filter*/
   unsigned long     sendSeq;          /*local send sequence number*/
   unsigned short    sendWindow;       /*send window size*/
   unsigned long     recvSeq;          /*receive sequence number*/
   unsigned long     attnSendSeq;      /*attention send sequence number*/
   unsigned long     attnRecvSeq;      /*attention receive sequence */
                                       /* number*/
   unsigned char     ocMode;           /*open connection mode*/
   unsigned char     ocInterval;       /*open connection request retry */
                                       /* interval*/
   unsigned char     ocMaximum;        /*open connection request retry */
};                                     /* maximum*/
typedef struct TRopenParams TRopenParams;
</PRE>
<A NAME=HEADING142-34></A>
<H4>Parameter Block for dspClose and dspRemove</H4>
<PRE>
struct TRcloseParams {
   unsigned char        abort; /*abort connection immediately if nonzero*/
};
typedef struct TRcloseParams TRcloseParams;
</PRE>
<A NAME=HEADING142-37></A>
<H4>Parameter Block for dspStatus</H4>
<PRE>
struct TRstatusParams {
   TPCCB                ccbPtr;        /*pointer to ccb*/
   unsigned short       sendQPending;  /*pending bytes in send queue*/
   unsigned short       sendQFree;     /*available buffer space in send */
                                       /* queue*/
   unsigned short       recvQPending;  /*pending bytes in receive queue*/
   unsigned short       recvQFree;     /*available buffer space in */
};                                     /* receive queue*/
typedef struct TRstatusParams TRstatusParams;
</PRE>
<A NAME=HEADING142-40></A>
<H4>Parameter Block for dspRead and dspWrite</H4>
<PRE>
struct TRioParams {
   unsigned short       reqCount;      /*requested number of bytes*/
   unsigned short       actCount;      /*actual number of bytes*/
   unsigned char        *dataPtr;      /*pointer to data buffer*/ 
   unsigned char        eom;           /*indicates logical end of message*/
   unsigned char        flush;         /*send data now*/
};
typedef struct TRioParams TRioParams;
</PRE>
<A NAME=HEADING142-43></A>
<H4>Parameter Block for dspAttention</H4>
<PRE>
struct TRattnParams {
   unsigned short       attnCode;      /*client attention code*/
   unsigned short       attnSize;      /*size of attention data*/
   unsigned char        *attnData;     /*pointer to attention data*/
   unsigned char        attnInterval;  /*retransmit timer in 10-tick */
                                       /* intervals*/
};
typedef struct TRattnParams TRattnParams;
</PRE>
<A NAME=HEADING142-46></A>
<H4>Parameter Block for dspOptions</H4>
<PRE>
struct TRoptionParams {
   unsigned short       sendBlocking;  /*quantum for data packets*/
   unsigned char        sendTimer;     /*send timer in 10-tick intervals*/
   unsigned char        rtmtTimer;     /*retransmit timer in 10-tick */
                                       /* intervals*/
   unsigned char        badSeqMax;     /*threshold for sending retransmit */
                                       /* advice*/
   unsigned char        useCheckSum;   /*use ddp packet checksum*/
};
typedef struct TRoptionParams TRoptionParams;
</PRE>
<A NAME=HEADING142-49></A>
<H4>Parameter Block for dspNewCID</H4>
<PRE>
struct TRnewcidParams {
   unsigned short       newcid;        /*new connection ID returned*/
};
typedef struct TRnewcidParams TRnewcidParams;
</PRE>
<A NAME=HEADING142-52></A>
<H4>The DSP Parameter Block</H4>
<PRE>
struct DSPParamBlock {
   struct QElem      *qLink;           /*reserved*/
   short             qType;            /*reserved*/
   short             ioTrap;           /*reserved*/
   Ptr               ioCmdAddr;        /*reserved*/
   ProcPtr           ioCompletion;     /*pointer to completion routine*/
   OSErr             ioResult;         /*routine result*/
   char              *ioNamePtr;       /*reserved*/
   short             ioVRefNum;        /*reserved*/
   short             ioCRefNum;        /*ADSP driver refNum*/
   short             csCode;           /*ADSP driver control code*/
   long              qStatus;          /*reserved*/
   short             ccbRefNum;
union{
   TRinitParams      initParams;       /*dspInit, dspCLInit*/
   TRopenParams      openParams;       /*dspOpen, dspCLListen, dspCLDeny*/
   TRcloseParams     closeParams;      /*dspClose, dspRemove*/
   TRioParams        ioParams;         /*dspRead, dspWrite*/
   TRattnParams      attnParams;       /*dspAttention*/
   TRstatusParams    statusParams;     /*dspStatus*/
   TRoptionParams    optionParams;     /*dspOptions*/
   TRnewcidParams    newCIDParams;     /*dspNewCID*/
   } u;
};
typedef struct DSPParamBlock DSPParamBlock;
typedef DSPParamBlock *DSPPBPtr;
</PRE>
<A NAME=HEADING142-55></A>
<H4>The ASDSP Parameter Block</H4>
<PRE>
struct TRSecureParams {
   unsigned short    localCID;         /*local connection ID*/
   unsigned short    remoteCID;        /*remote connection ID*/
   AddrBlock         remoteAddress;    /*address of remote end*/
   AddrBlock         filterAddress;    /*address filter*/
   unsigned long     sendSeq;          /*local send sequence number*/
   unsigned short    sendWindow;       /*send window size*/
   unsigned long     recvSeq;          /*receive sequence number*/
   unsigned long     attnSendSeq;      /*attention send sequence number*/
   unsigned long     attnRecvSeq;      /*attention receive sequence */
                                       /* number*/
   unsigned char     ocMode;           /*open connection mode*/
   unsigned char     ocInterval;       /*open connection request retry */
                                       /* interval*/
   unsigned char     ocMaximum;        /*open connection request retry */
                                       /* maximum*/      
   Boolean           secure;           /*TRUE if session was */
                                       /* authenticated*/
   AuthKeyPtr        sessionKey;       /*encryption key for session*/
   unsigned          longcredentialsSize;
                                       /*length of credentials*/
   Ptr               credentials;      /*pointer to credentials*/

   Ptr               workspace;        /*pointer to workspace for */
                                       /* connection. align on even */
                                       /* boundary and length equals */
                                       /* sdspWorkSize*/
   AuthIdentity      recipient;        /*identity of recipient */
                                       /* (or initiator if active mode)*/
   UTCTime           issueTime;        /*when credentials were issued*/ 
   UTCTime           expiry;           /*when credentials expire*/
   RecordIDPtr       initiator;        /*pointer to RecordID of */
                                       /* initiator returned*/
   Boolean           hasIntermediary;  /*is set if credentials */
                                       /* have an intermediary*/
   RecordIDPtr       intermediary;     /*pointer to RecordID of */
                                       /* intermediary returned*/
   };

The TRSecureParams Record           

typedef struct TRSecureParams TRSecureParams;

struct SDSPParamBlock {
      struct QElem      *qLink;        /*reserved*/
      short             qType;         /*reserved*/
      short             ioTrap;        /*reserved*/
      Ptr               ioCmdAddr;     /*reserved*/
      ProcPtr           ioCompletion;
                                       /*pointer to completion routine*/
      OSErr             ioResult;      /*routine result*/
      char              *ioNamePtr;    /*reserved*/
      short             ioVRefNum;     /*reserved*/
      short             ioCRefNum;     /*ADSP driver refNum*/
      short             csCode;        /*ADSP driver control code*/
      long              qStatus;       /*ADSP internal use*/
      short             ccbRefNum;     /*connection end refNum*/
   union {
      TRinitParams      initParams;    /*dspInit, dspCLInit*/
      TRopenParams      openParams;    /*dspOpen, dspCLListen, dspCLDeny*/
      TRcloseParams     closeParams;   /*dspClose, dspRemove*/
      TRioParams        ioParams;      /*dspRead, dspWrite*/
      TRattnParams      attnParams;    /*dspAttention*/
      TRstatusParams    statusParams;  /*dspStatus*/
      TRoptionParams    optionParams;  /*dspOptions*/
      TRnewcidParams    newCIDParams;  /*dspNewCID*/
      TRSecureParams    secureParams;  /*dspOpenSecure*/
   } u;
};
typedef struct SDSPParamBlock SDSPParamBlock;
typedef SDSPParamBlock *SDSPPBPtr;
</PRE>
<A NAME=HEADING142-59></A>
<H2>Assembly-Language Summary</H2>
<A NAME=HEADING142-60></A>
<H3>Constants</H3>
<A NAME=HEADING142-61></A>
<H4>ADSP Queue Element Equates and Sizes</H4>
<PRE>
csQStatus      EQU      CSParam        ;ADSP internal use
csCCBRef       EQU      csQStatus+4    ;refnum of ccb
</PRE>
<A NAME=HEADING142-63></A>
<H4>Command Codes</H4>
<PRE>
dspInit        EQU      255            ;create a new connection end
dspRemove      EQU      254            ;remove a connection end
dspOpen        EQU      253            ;open a connection
dspClose       EQU      252            ;close a connection
dspCLInit      EQU      251            ;create a connection listener
dspCLRemove    EQU      250            ;remove a connection listener
dspCLListen    EQU      249            ;post a listener request
dspCLDeny      EQU      248            ;deny an open connection request
dspStatus      EQU      247            ;get status of connection end
dspRead        EQU      246            ;read data from the connection
dspWrite       EQU      245            ;write data on the connection
dspAttention   EQU      244            ;send an attention message
dspOptions     EQU      243            ;set connection end options
dspReset       EQU      242            ;forward reset the connection
dspNewCID      EQU      241            ;generate a cid for a connection end
sdspOpen       EQU      229            ;open a secure connection
</PRE>
<A NAME=HEADING142-65></A>
<H4>Open Connection Modes</H4>
<PRE>
ocRequest      EQU      1              ;request a connection with remote
ocPassive      EQU      2              ;wait for a connection request from
                                       ; remote
ocAccept       EQU      3              ;accept request as delivered by
                                       ; listener
ocEstablish    EQU      4              ;consider connection to be open
</PRE>
<A NAME=HEADING142-67></A>
<H4>Connection States</H4>
<PRE>
sListening     EQU      1              ;for connection listeners
sPassive       EQU      2              ;waiting for a connection request
                                       ; from remote
sOpening       EQU      3              ;requesting a connection with remote
sOpen          EQU      4              ;connection is open
sClosing       EQU      5              ;connection is being torn down
sClosed        EQU      6              ;connection end state is closed
</PRE>
<A NAME=HEADING142-69></A>
<H4>Client Event Flags (Bit-Mask)</H4>
<PRE>
eClosed        EQU      $80            ;received connection closed advice
eTearDown      EQU      $40            ;closed due to broken connection
eAttention     EQU      $20            ;received attention message
eFwdReset      EQU      $10            ;received forward reset advice
</PRE>
<A NAME=HEADING142-71></A>
<H4>Miscellaneous Equates</H4>
<PRE>
attnBufSize    EQU      570            ;size of client attention message
minDSPQueueSize
               EQU      100            ;minimum size for both receive and
                                       ; send queues
sdspWorkSize   EQU      2048           ;size of ASDSP workspace
</PRE>
<A NAME=HEADING142-73></A>
<H4>ASDSP Encrypt and End-of-Message Flags and Masks</H4>
<PRE>
dspEOMBit      EQU      0              ;set if EOM at end of write
dspEncryptBit  EQU      1              ;set to encrypt message
dspEncryptMask EQU      $1             ;mask for setting the encrypt bit
dspEOMMask     EQU      $2             ;mask for setting the EOM bit
</PRE>
<A NAME=HEADING142-75></A>
<H3>Data Structures</H3>
<A NAME=HEADING142-76></A>
<H4>ADSP Connection Control Block Data Structure
<TABLE BORDER="0" CELLPADDING=3><TD>0<TD>ccbLink<TD>long<TD>link to next CCB<TR>
<TD>4<TD>refNum<TD>word<TD>reference number<TR>
<TD>6<TD>state<TD>word<TD>state of the connection end<TR>
<TD>8<TD>userFlags<TD>byte<TD>user flags for connection<TR>
<TD>9<TD>localSocket<TD>byte<TD>local socket number<TR>
<TD>10<TD>remoteAddress<TD>long<TD>internet address of remote end<TR>
<TD>14<TD>attnCode<TD>word<TD>attention code received<TR>
<TD>16<TD>attnSize<TD>word<TD>size of received attention data<TR>
<TD>18<TD>attnPtr<TD>long<TD>pointer to received attention data<TR>
<TD>22<TD>reserved<TD>220 bytes<TD>reserved</TABLE>
</H4>
<A NAME=HEADING142-77></A>
<H4>DPS Parameter Block Common Fields for ADSP and ASDSP
<TABLE BORDER="0" CELLPADDING=3><TD>0<TD>qLink<TD>long<TD>reserved<TR>
<TD>4<TD>qType<TD>word<TD>reserved<TR>
<TD>6<TD>ioTrap<TD>word<TD>reserved<TR>
<TD>8<TD>ioCmdAddr<TD>long<TD>reserved<TR>
<TD>12<TD>ioCompletion<TD>long<TD>address of completion routine<TR>
<TD>16<TD>ioResult<TD>word<TD>result code<TR>
<TD>18<TD>ioNamePtr<TD>long<TD>reserved<TR>
<TD>22<TD>ioVRefNum<TD>word<TD>reserved<TR>
<TD>24<TD>ioCRefNum<TD>word<TD>driver reference number<TR>
<TD>28<TD>qStatus<TD>long<TD>reserved<TR>
<TD>32<TD>ccbRefNum<TD>word<TD>reference number of CCB</TABLE>
</H4>
<A NAME=HEADING142-78></A>
<H4>dspInit and dspCLInit
<TABLE BORDER="0" CELLPADDING=3><TD>26<TD>csCode<TD>word<TD><CODE>dspInit</CODE> or <CODE>dspCLInit</CODE><TR>
<TD>34<TD>ccbPtr<TD>long<TD>pointer to CCB<TR>
<TD>38<TD>userRoutine<TD>long<TD>pointer to routine to call on connection events<TR>
<TD>42<TD>sendQSize<TD>word<TD>size in bytes of the send queue<TR>
<TD>44<TD>sendQueue<TD>long<TD>pointer to send queue<TR>
<TD>48<TD>recvQSize<TD>word<TD>size in bytes of the receive queue<TR>
<TD>50<TD>recvQueue<TD>long<TD>pointer to receive queue<TR>
<TD>54<TD>attnPtr<TD>long<TD>pointer to buffer for incoming attention messages<TR>
<TD>58<TD>localSocket<TD>byte<TD>DDP socket number for this connection end</TABLE>
 Parameter Variant</H4>
<A NAME=HEADING142-79></A>
<H4>dspOptions
<TABLE BORDER="0" CELLPADDING=3><TD>16<TD>ioResult<TD>word<TD>result code <TR>
<TD>24<TD>ioCRefNum<TD>word<TD>driver reference number<TR>
<TD>26<TD>csCode<TD>word<TD>always <CODE>dspOptions</CODE><TR>
<TD>34<TD>sendBlocking<TD>word<TD>send-blocking threshold<TR>
<TD>38<TD>badSeqMax<TD>byte<TD>threshold to send retransmit advice<TR>
<TD>39<TD>useCheckSum<TD>byte<TD>DDP checksum flag</TABLE>
 Parameter Variant</H4>
<A NAME=HEADING142-80></A>
<H4>dspOpen, dspCLListen, and dspCLDeny
<TABLE BORDER="0" CELLPADDING=3><TD>26<TD>csCode<TD>word<TD><CODE>dspOpen</CODE>, <CODE>dspCLListen</CODE>, or <CODE>dspCLDeny</CODE><TR>
<TD>34<TD>localCID<TD>word<TD>ID of this connection end<TR>
<TD>36<TD>remoteCID<TD>word<TD>ID of remote connection end<TR>
<TD>38<TD>remoteAddress<TD>long<TD>remote internet address<TR>
<TD>42<TD>filterAddress<TD>long<TD>filter for open-connection requests<TR>
<TD>46<TD>sendSeq<TD>long<TD>initial send sequence number<TR>
<TD>50<TD>sendWindow<TD>word<TD>initial size of remote receive queue<TR>
<TD>52<TD>recvSeq<TD>long<TD>initial receive sequence number<TR>
<TD>56<TD>attnSendSeq<TD>long<TD>attention send sequence number<TR>
<TD>60<TD>attnRecvSeq<TD>long<TD>attention receive sequence number<TR>
<TD>64<TD>ocMode<TD>byte<TD>connection-opening mode<TR>
<TD>65<TD>ocInterval<TD>byte<TD>interval between open requests<TR>
<TD>66<TD>ocMaximum<TD>byte<TD>retries of open-connection request</TABLE>
 Parameter Variant</H4>
<A NAME=HEADING142-81></A>
<H4>sdspOpen Parameter Variant
<TABLE BORDER="0" CELLPADDING=3><TD>26<TD>csCode<TD>word<TD><CODE>sdspOpen</CODE><TR>
<TD>34<TD>localCID<TD>word<TD>ID of this connection end<TR>
<TD>36<TD>remoteCID<TD>word<TD>ID of remote connection end<TR>
<TD>38<TD>remoteAddress<TD>long<TD>remote internet address<TR>
<TD>42<TD>filterAddress<TD>long<TD>filter for open-connection requests<TR>
<TD>46<TD>sendSeq<TD>long<TD>initial send sequence number<TR>
<TD>50<TD>sendWindow<TD>word<TD>initial size of remote receive queue<TR>
<TD>52<TD>recvSeq<TD>long<TD>not used for ASDSP<TR>
<TD>56<TD>attnSendSeq<TD>long<TD>attention send sequence number<TR>
<TD>60<TD>attnRecvSeq<TD>long<TD>not used for ASDSP<TR>
<TD>64<TD>ocMode<TD>byte<TD>connection-opening mode<TR>
<TD>65<TD>ocInterval<TD>byte<TD>interval between open requests<TR>
<TD>66<TD>ocMaximum<TD>byte<TD>retries of open-connection request<TR>
<TD>68<TD>secure<TD>word<TD>flag that determines if ASDSP authenticates <BR>the connection<TR>
<TD>70<TD>sessionKey<TD>long<TD>pointer to the encryption key for the session <TR>
<TD>74<TD>credentialsSize<TD>long<TD>length of credentials<TR>
<TD>78<TD>credentials<TD>long<TD>pointer to credentials<TR>
<TD>82<TD>workspace<TD>long<TD>pointer to workspace for connection<TR>
<TD>86<TD>recipient<TD>long<TD>identity of recipient <TR>
<TD>90<TD>issueTime<TD>long<TD>time when credentials were issued<TR>
<TD>94<TD>expiry<TD>long<TD>time when credentials expire<TR>
<TD>98<TD>initiator<TD>long<TD>pointer to record ID of initiator <TR>
<TD>102<TD>hasIntermediary<TD>word<TD><CODE>TRUE</CODE> if credentials have an intermediary<TR>
<TD>104<TD>intermediary<TD>long<TD>pointer to record ID of intermediary</TABLE>
</H4>
<A NAME=HEADING142-82></A>
<H4>dspNewCID Parameter Variant
<TABLE BORDER="0" CELLPADDING=3><TD>26<TD>csCode<TD>word<TD>always <CODE>dspNewCID</CODE><TR>
<TD>34<TD>newCID<TD>word<TD>ID of new connection</TABLE>
</H4>
<A NAME=HEADING142-83></A>
<H4>dspClose, dspRemove, and dspCLRemove Parameter Variant
<TABLE BORDER="0" CELLPADDING=3><TD>26<TD>csCode<TD>word<TD><CODE>dspClose</CODE>, <CODE>dspRemove</CODE>, or <CODE>dspCLRemove</CODE><TR>
<TD>34<TD>abort<TD>byte<TD>abort send requests or connection listener if not 0</TABLE>
</H4>
<A NAME=HEADING142-84></A>
<H4>dspStatus Parameter Variant
<TABLE BORDER="0" CELLPADDING=3><TD>26<TD>csCode<TD>word<TD>always <CODE>dspStatus</CODE><TR>
<TD>34<TD>statusCCB<TD>pointer<TD>pointer to CCB<TR>
<TD>38<TD>sendQPending<TD>word<TD>bytes waiting to be sent or acknowledged<TR>
<TD>40<TD>sendQFree<TD>word<TD>available send queue in bytes<TR>
<TD>42<TD>recvQPending<TD>word<TD>bytes waiting to be read from queue<TR>
<TD>44<TD>recvQFree<TD>word<TD>available receive queue in bytes </TABLE>
</H4>
<A NAME=HEADING142-85></A>
<H4>dspRead and dspWrite Parameter Variant
<TABLE BORDER="0" CELLPADDING=3><TD>26<TD>csCode<TD>word<TD><CODE>dspRead</CODE> or <CODE>dspWrite</CODE><TR>
<TD>34<TD>reqCount<TD>word<TD>requested number of bytes<TR>
<TD>36<TD>actCount<TD>word<TD>actual number of bytes read or written<TR>
<TD>38<TD>dataPtr<TD>pointer<TD>pointer to data buffer<TR>
<TD>42<TD>eom<TD>byte<TD>for ADSP: 1 if end of message; 0 otherwise <BR>for ASDSP: bit 0 = end of message; bit 1 turns on <BR>encryption, if set<TR>
<TD>43<TD>flush<TD>byte<TD>1 to send data now; 0 otherwise</TABLE>
</H4>
<A NAME=HEADING142-86></A>
<H4>dspAttention and dspReset Parameter Variant
<TABLE BORDER="0" CELLPADDING=3><TD>26<TD>csCode<TD>word<TD><CODE>dspAttentio</CODE>n or <CODE>dspReset</CODE><TR>
<TD>34<TD>attnCode<TD>word<TD>client attention code<TR>
<TD>36<TD>attnSize<TD>word<TD>size of attention data in bytes<TR>
<TD>38<TD>attnData<TD>pointer<TD>pointer to attention data</TABLE>
</H4>
<A NAME=HEADING142-87></A>
<H2>Result Codes
<TABLE BORDER="0" CELLPADDING=3><TD>noErr<TD>0<TD>No error or unrecognized event code<TR>
<TD>ddpSktErr<TD>-91<TD>Error opening socket<TR>
<TD>errOpenDenied<TD>-1273<TD>Open request denied by recipient<TR>
<TD>errDSPQueueSize<TD>-1274<TD>Send or receive queue is too small<TR>
<TD>errFwdReset<TD>-1275<TD>Read terminated by forward reset<TR>
<TD>errAttention<TD>-1276<TD>Attention message too long<TR>
<TD>errOpening<TD>-1277<TD>Attempt to open connection failed<TR>
<TD>errState<TD>-1278<TD>Bad connection state for this operation<TR>
<TD>errAborted<TD>-1279<TD>Request aborted by <CODE>dspRemove</CODE> or <CODE>dspClose</CODE> routine<TR>
<TD>errRefNum<TD>-1280<TD>Bad connection reference number<TR>
<TD>kOCEUnsupportedCredentialsVersion<TD>-1543<TD>Credentials version not supported<TR>
<TD>kOCEBadEncryptionMethod<TD>-1559<TD>During the authentication process, the ASDSP implementations could not agree on an encryption method to be used (ASDSP can support multiple stream encryption methods. In Release 1, only <BR>RC4 and "no encryption" are supported.<A NAME=MARKER-2-217></A>)<TR>
<TD>kOCENoASDSPWorkSpace<TD>-1570<TD>You passed <CODE>NIL</CODE> for the workspace parameter<TR>
<TD>kOCEAuthenticationTrouble<TD>-1571<TD>Authentication process failed</TABLE>
</H2>
</BLOCKQUOTE><P>

</BLOCKQUOTE>
<HR>
<center>
<A HREF="Networking-141.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-143.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Networking-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
