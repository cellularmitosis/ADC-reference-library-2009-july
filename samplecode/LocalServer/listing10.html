<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>LocalServer - /LocalServerUDP/LocalServerUDPClient/UDPClientSample.cp</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/Carbon/index.html">Carbon</a> &gt; <a href="../../samplecode/Carbon/idxNetworking-date.html">Networking</a> &gt; <A HREF="javascript:location.replace('index.html');">LocalServer</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Not Recommended Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>The information in this document is <strong>Not Recommended</strong> and should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Carbon/idxNetworking-date.html" target="_blank">Carbon > Networking</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">LocalServer</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/LocalServerUDP/LocalServerUDPClient/UDPClientSample.cp</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/LocalServerTCP/LocalServerClient/Carbon.r</option>
<option value="listing2.html">/LocalServerTCP/LocalServerClient/Prefix.h</option>
<option value="listing3.html">/LocalServerTCP/LocalServerClient/TCPPitchSample.cp</option>
<option value="listing4.html">/LocalServerTCP/main.c</option>
<option value="listing5.html">/LocalServerTCP/main.h</option>
<option value="listing6.html">/LocalServerTCP/main.r</option>
<option value="listing7.html">/LocalServerTCP/ServerInfo.h</option>
<option value="listing8.html">/LocalServerUDP/LocalServerUDPClient/Carbon.r</option>
<option value="listing9.html">/LocalServerUDP/LocalServerUDPClient/Prefix.h</option>
<option value="listing10.html">/LocalServerUDP/LocalServerUDPClient/UDPClientSample.cp</option>
<option value="listing11.html">/LocalServerUDP/main.c</option>
<option value="listing12.html">/LocalServerUDP/main.h</option>
<option value="listing13.html">/LocalServerUDP/main.r</option>
<option value="listing14.html">/LocalServerUDP/ServerInfo.h</option></select>
				</p>
				</form>
				<p><strong><a href="LocalServer.zip">Download Sample</a></strong> (&#147;LocalServer.zip&#148;, 758.8K)<BR>
<strong><a href="LocalServer.dmg">Download Sample</a></strong> (&#147;LocalServer.dmg&#148;, 1.13M)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*  File:    TCPPitchSample.cp  Contains:  Tcp pitch sample.  Copyright:  &copy; 1993-1997, 2000 by Apple Computer, Inc., all rights reserved.*/// OT TCP Pitch Test Program (as an SIOW app)#include &lt;OpenTransport.h&gt;#include &lt;OpenTransportProviders.h&gt;#include &lt;Processes.h&gt;#include &lt;stdio.h&gt;#include &lt;StdLib.h&gt;#include &quot;ServerInfo.h&quot;#include &lt;AppleEvents.h&gt;#ifndef T_DISCON_IND#define T_DISCON_IND 128#endif/********************************************************************************* GLOBAL VARIABLES********************************************************************************/InetPort  gCatchPort    = 0;InetHost  gCatchIpAddr  = 0;InetPort    gPitchPort    = 0;InetHost  gPitchIpAddr  = 0;  unsigned short gBindCompleted    = 0;unsigned short gCallRcvOrdDiscon  = 0;static OTNotifyUPP    gNotifier = nil;struct InetAddress gCatchAddr;/********************************************************************************* Function Prototypes********************************************************************************/void Inits();OSErr GetServerInfo();void CleanUp();void Idle();  void DoIt();OSErr FindProcessBySignature( const OSType targetType,                    const OSType targetCreator,                    ProcessSerialNumberPtr psnPtr );OTResult SetFourByteOption(EndpointRef ep,                           OTXTILevel level,                           OTXTIName  name,                           UInt32   value);/*********************************************************************************  main function********************************************************************************/void main(){  printf (&quot;Hello World\n&quot;);  Inits();  if (GetServerInfo() == noErr)  {    DoIt();  }  else    printf (&quot;GetServerInfo returned an error\n&quot;);  CleanUp();}/********************************************************************************* Initialize Quickdraw and ASLM********************************************************************************/void Inits(){  if (InitOpenTransport() != kOTNoError)  {    fprintf(stderr, &quot;OTTcpPitch: Could not initialize ASLM, exiting\n&quot;);    exit(1);  }}/*******************************************************************************  The FindProcessBySignature function returns a ProcessSerialNumber  for a process whose signature (type and creator) matches the input values.  The ProcessSerialNumber will be kNoProcess is the requested process cannot  be found.   targetType    input:  The file type of the process to be found.  targetCreator  input:  The creator type of the process to be found.    psnPtr      input:  Pointer to a ProcessSerialNumber where the              process serial number is returned.          output:  Process serial number.    RESULT CODES  ____________  noErr         0  No error  procNotFound  \xD0600  No eligible process with specified descriptor  ____________********************************************************************************/OSErr FindProcessBySignature( const OSType targetType,                    const OSType targetCreator,                    ProcessSerialNumberPtr psnPtr ){  OSErr    anErr = noErr;  Boolean    foundTheProcess = false;    ProcessInfoRec  infoRec;    infoRec.processInfoLength = sizeof( ProcessInfoRec );  infoRec.processName = nil;  infoRec.processLocation = nil;  infoRec.processAppSpec = nil;    psnPtr-&gt;lowLongOfPSN = kNoProcess;  psnPtr-&gt;highLongOfPSN = kNoProcess;  while ( !foundTheProcess &amp;&amp; (anErr == noErr) )  {    anErr = GetNextProcess( psnPtr );    if ( anErr == noErr )    {      anErr = GetProcessInformation( psnPtr, &amp;infoRec );      if ( ( anErr == noErr )         &amp;&amp; ( infoRec.processType == targetType )         &amp;&amp; ( infoRec.processSignature == targetCreator ) )      {        foundTheProcess = true;      }    }  }    return anErr;}//end FindProcessBySignature/********************************************************************************* Send an Apple Event to find out if the server is up and running** which will return the address to send the event to ********************************************************************************/OSErr GetServerInfo(){  AppleEvent        reqEvent = { typeNull, nil };  AppleEvent        retEvent = { typeNull, nil };  DescType        typeCode;  OSErr          err;  ProcessSerialNumber    psn = { kNoProcess, kNoProcess };  AEDesc          targetAppDesc = { typeNull, nil };  Size          size;  char          mystr[255];  UInt32          dummy;  err = FindProcessBySignature(kApplicationFileType, kPassServerSignature, &amp;psn);  if (err == noErr)  {    err = AECreateDesc (typeProcessSerialNumber, &amp;psn, sizeof( ProcessSerialNumber ), &amp;targetAppDesc);    if ( err == noErr )    {      err = AECreateAppleEvent( kPassServerInfoClass, kPassServerInfoEvent, &amp;targetAppDesc,                    kAutoGenerateReturnID, kAnyTransactionID, &amp;reqEvent);      if (err)        printf(&quot;AECreateAppleEvent returned error %d\n&quot;, err);    }    else      printf(&quot;AECreateDesc returned error %d\n&quot;, err);          AEDisposeDesc( &amp;targetAppDesc );  }  else    printf(&quot;FindProcessBySignature returned error %d\n&quot;, err);      if (err == noErr)  {    // we have to insert a dummy in the outgoing AppleEvent list which the    // LocalServer is expecting, but will not do anything with.  Just doing this    // for kicks    err = AEPutParamPtr(&amp;reqEvent, keyDirectObject, typeLongInteger, &amp;dummy,              sizeof(dummy) );  }    if (err == noErr)  {    err = AESend(&amp;reqEvent, &amp;retEvent, kAEWaitReply+kAENeverInteract, kAENormalPriority,          kAEDefaultTimeout, nil, nil);              if (err != noErr)    {      printf(&quot;Error calling AESend = %d\n&quot;, err);    }    else    {        // get the apple event object      err = AEGetParamPtr(&amp;retEvent, keyDirectObject, kPassServerType, &amp;typeCode,                  &amp;gCatchAddr, sizeof (struct InetAddress), &amp;size );      if (err != noErr)        printf(&quot;Error calling AEGetParamDesc to get the catch address %d\n&quot;, err);      // dispose of the returned apple event      AEDisposeDesc(&amp;retEvent);    }    AEDisposeDesc(&amp;reqEvent);  }    if (err == noErr)  {    OTInetHostToString(gCatchAddr.fHost, mystr);    printf(&quot;LocalServer found at %s, port %d.\n&quot;, mystr, gCatchAddr.fPort);  }  return err;}/********************************************************************************* Clean up at the end********************************************************************************/void CleanUp(){  CloseOpenTransport();}/********************************************************************************* Idle********************************************************************************/void Idle(){  EventRecord  theEvent;  WaitNextEvent(everyEvent, &amp;theEvent, 1, nil);}/********************************************************************************* EventHandler********************************************************************************/pascal void EventHandler(void*, OTEventCode event, OTResult, void*){  OTEventCode tempevent = 0;  switch ( event )  {    case T_BINDCOMPLETE:              gBindCompleted = 1;              break;    case T_DATA:              printf(&quot;T_DATA event occurred\n&quot;);              break;    case T_ERROR:              printf(&quot;T_ERROR event occurred\n&quot;);              break;        default:              printf(&quot;TCP EventHandler got unexpected event %d&quot;, event);              break;  }  return;}/********************************************************************************* DoIt********************************************************************************/void DoIt(){  TEndpoint*    ep = NULL;  TEndpointInfo  info;  struct InetAddress rcvsin, reqsin, retsin;  TBind      req, ret;  TUnitData    sendunitdata, rcvunitdata;  OSStatus    err = kOTNoError;  OTResult    result;  long      myport = 0;  char      mystr[255];  OTFlags      flags = 0;  OTTimeStamp    time;    OTTimeStamp    end, begin, diff;    UInt32      diffInMsec;  UInt32      i, j;  UInt8      *ptr;  myport = 0;  gPitchPort =(InetPort)  myport;    gPitchIpAddr = gCatchAddr.fHost;  OTMemset(&amp;rcvsin, 0, sizeof(struct InetAddress));  OTMemset(&amp;reqsin, 0, sizeof(struct InetAddress));  OTMemset(&amp;rcvsin, 0, sizeof(struct InetAddress));  OTMemset(&amp;req, 0, sizeof(TBind));  OTMemset(&amp;ret, 0, sizeof(TBind));  do  {    //    // Now create a TCP    //    ep = OTOpenEndpoint(OTCreateConfiguration(kUDPName), 0, &amp;info, &amp;err);    if ( ep == NULL || err != kOTNoError )    {      ep = NULL;      fprintf(stderr,&quot;ERROR: OpenEndpoint(\&quot;UDP\&quot;) failed with %d\n&quot;, err);      break;    }        err = ep-&gt;SetSynchronous();    if ( err != kOTNoError )    {      fprintf(stderr, &quot;ERROR: SetSynchronous() failed with %d\n&quot;, err);      break;    }    //    // Install notifier we're going to use for testing    //    gNotifier = NewOTNotifyUPP(EventHandler);    err = ep-&gt;InstallNotifier(gNotifier, 0);    if ( err != kOTNoError )    {      fprintf(stderr, &quot;ERROR: InstallNotifier() failed with %d\n&quot;, err);      break;    }    //    // Try to bind    //    gPitchIpAddr = 0;    OTInitInetAddress(&amp;reqsin, gPitchPort, gPitchIpAddr);    req.addr.len = sizeof(struct InetAddress);    req.addr.buf = (unsigned char *) &amp;reqsin;    req.qlen = 0;                    // don't care for udp    ret.addr.maxlen = sizeof(struct InetAddress);    ret.addr.buf = (unsigned char *) &amp;retsin;    OTInetHostToString(retsin.fHost, mystr);    printf(&quot;Trying to bind at %s, port %d.\n&quot;, mystr, gPitchPort);    // bind TCP to current address and port    err = ep-&gt;Bind(&amp;req, &amp;ret);    if ( err != kOTNoError )    {      fprintf(stderr, &quot;ERROR: Bind() failed with %d\n&quot;, err);      break;    }    OTInetHostToString(retsin.fHost, mystr);    printf(&quot;Bound ep to %s, port %d.\n&quot;, mystr, retsin.fPort);    err = ep-&gt;SetSynchronous();    if ( err != kOTNoError )    {      fprintf(stderr, &quot;ERROR: SetSynchronous() failed with %d\n&quot;, err);      break;    }        for (i = 0; i &lt; 50; i++)    {      OTGetTimeStamp(&amp;time);      sendunitdata.addr.len = sizeof(struct InetAddress);      sendunitdata.addr.buf = (UInt8*) &amp;gCatchAddr;            sendunitdata.opt.len = 0;      sendunitdata.opt.buf = 0;      sendunitdata.udata.len = sizeof(time);      sendunitdata.udata.buf = (UInt8*)&amp;time;      rcvunitdata.addr.maxlen = sizeof(struct InetAddress);      rcvunitdata.addr.buf = (UInt8*) &amp;rcvsin;      rcvunitdata.opt.maxlen = 0;      rcvunitdata.opt.buf = 0;      rcvunitdata.udata.maxlen = sizeof(time);      rcvunitdata.udata.len = 0;        // set address of &quot;begin&quot; as the buffer to return the OTTimeStamp in      rcvunitdata.udata.buf = (UInt8*)&amp;begin;      err = ep-&gt;SndUData(&amp;sendunitdata);      if ( err == kOTNoError)      {        // the server will return the byte sent        result = ep-&gt;RcvUData(&amp;rcvunitdata, &amp;flags);        // get a timestamp         OTGetTimeStamp(&amp;end);        fprintf(stderr, &quot;Sent bytes: &lt;%d&gt; data\n&quot;, sendunitdata.udata.len);          // print out the bytes of the time stamp        if (result == kOTNoError)        {          fprintf(stderr, &quot;Rcv'd nbytes: &lt;%d&gt; data\n&quot;, rcvunitdata.udata.len);          // &quot;begin&quot; should contain the original time stamp          OTSubtractTimeStamps(&amp;diff, &amp;begin, &amp;end);          diffInMsec = OTTimeStampInMilliseconds(&amp;diff);          printf(&quot;%ld bytes received - %ld milliseconds\n&quot;, rcvunitdata.udata.len, diffInMsec);          ptr = (UInt8*) &amp;begin;          for (j = 0; j &lt; rcvunitdata.udata.len; j++)            fprintf(stderr, &quot;%X &quot;, *ptr++);          fprintf(stderr, &quot;\n&quot;);         }        else          fprintf(stderr, &quot;OTRcvUData error %d\n&quot;, result);                }      else       {        fprintf(stderr, &quot;ERROR: Snd() failed with %d\n&quot;, err);        break;      }      Idle();      fflush(stderr);    }      } while (false);  if ( ep != NULL )  {    err = ep-&gt;SetSynchronous();          //    // Remove notifier    //    ep-&gt;RemoveNotifier();      //    // Try to Unbind    //     err = ep-&gt;Unbind();    if ( err != kOTNoError )    {      fprintf(stderr, &quot;ERROR: Unbind() returned %d\n&quot;, err);    }    //    // Get rid of endpoint.    //    err = OTCloseProvider(ep);    if ( err != kOTNoError )    {      fprintf(stderr, &quot;ERROR: CloseEndpoint() failed with %d\n&quot;, err);    }  }  fprintf(stderr, &quot;Bye\n&quot;);}OTResult SetFourByteOption(EndpointRef ep,                           OTXTILevel level,                           OTXTIName  name,                           UInt32   value){   OTResult err;   TOption  option;   TOptMgmt request;   TOptMgmt result;      /* Set up the option buffer to specify the option and value to         set. */   option.len  = kOTFourByteOptionSize;   option.level= level;   option.name = name;   option.status = 0;   option.value[0] = value;   /* Set up request parameter for OTOptionManagement */   request.opt.buf= (UInt8 *) &amp;option;   request.opt.len= sizeof(option);   request.flags  = T_NEGOTIATE;   /* Set up reply parameter for OTOptionManagement. */   result.opt.buf  = (UInt8 *) &amp;option;   result.opt.maxlen  = sizeof(option);      err = OTOptionManagement(ep, &amp;request, &amp;result);   if (err == noErr) {      if (option.status != T_SUCCESS)          err = option.status;   }               return (err);}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/LocalServer/listing10.html%3Fid%3DDTS10000701-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/LocalServer/listing10.html%3Fid%3DDTS10000701-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/LocalServer/listing10.html%3Fid%3DDTS10000701-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>