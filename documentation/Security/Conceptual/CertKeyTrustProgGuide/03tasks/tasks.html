<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Certificate, Key, and Trust Services Programming Guide: Certificate, Key, and Trust Services Tasks for Mac OS X</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Certificate, Key, and Trust Services Tasks for Mac OS X"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP40001358-CH205" title="Certificate, Key, and Trust Services Tasks for Mac OS X"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000434" target="_top">Security</a> &gt; <a href="../../../Authentication-date.html#//apple_ref/doc/uid/TP30000440-TP30000434-TP30000487" target="_top">Authentication</a> &gt; <a href="../01introduction/introduction.html#//apple_ref/doc/uid/TP40001358-CH203-DontLinkElementID_10">Certificate, Key, and Trust Services Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../iPhone_Tasks/iPhone_Tasks.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../glossary/glossary.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP40001358-CH205-SW1" title="Certificate, Key, and Trust Services Tasks for Mac OS X"></a><h1><a name="//apple_ref/doc/uid/TP40001358-CH205-TP9" title="Certificate, Key, and Trust Services Tasks for Mac OS X"></a>Certificate, Key, and Trust Services Tasks for Mac OS X</h1><p>This chapter describes and illustrates the use of Certificate, Key, and Trust Services functions to evaluate the trust of a certificate, determine the cause of a trust failure, and recover from a trust failure.</p><p>The sequence of operations illustrated in this chapter is:</p><ol class="ol"><li class="li"><p>Find a certificate in a keychain.</p></li><li class="li"><p>Obtain a policy object for the policy used in evaluation of the certificate.</p></li><li class="li"><p>Validate the certificate and evaluate whether it can be trusted as specified by the policy.</p></li><li class="li"><p>Test for a recoverable trust error.</p></li><li class="li"><p>Determine whether the trust error is due to an expired certificate.</p></li><li class="li"><p>Change the evaluation criteria to ignore expired certificates.</p></li><li class="li"><p>Reevaluate the certificate.</p></li></ol><p><span class="content_text"><a href="../02concepts/concepts.html#//apple_ref/doc/uid/TP40001358-CH204-TP9">“Chapter 2, Certificate, Key, and Trust Services Concepts,”</a></span> provides an introduction to the concepts and terminology of Certificate, Key, and Trust Services. For detailed information about all Certificate, Key, and Trust Services functions, see <em><a href="../../../Reference/certifkeytrustservices/index.html#//apple_ref/doc/uid/TP30000157" target="_top">Certificate, Key, and Trust Services Reference</a></em>.</p>
<!-- This template is being used for both PDF and HTML. -->

    
    <h4>In this section:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="tasks.html#//apple_ref/doc/uid/TP40001358-CH205-BCIHAAGG">Finding a Certificate on the Keychain</a>
				
			<br/>
			
        
			
			
				<a href="tasks.html#//apple_ref/doc/uid/TP40001358-CH205-DontLinkElementID_5">Obtaining a Policy Object</a>
				
			<br/>
			
        
			
			
				<a href="tasks.html#//apple_ref/doc/uid/TP40001358-CH205-DontLinkElementID_6">Evaluating Trust</a>
				
			<br/>
			
        
			
			
				<a href="tasks.html#//apple_ref/doc/uid/TP40001358-CH205-DontLinkElementID_7">Recovering From a Trust Failure</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP40001358-CH205-BCIHAAGG" title="Finding a Certificate on the Keychain"></a><h2>Finding a Certificate on the Keychain</h2><p>Before you can evaluate the trust of a certificate, you must obtain a reference object for the certificate. You can obtain a certificate object by using the Secure Transport API <code><a href="../../../Reference/secureTransportRef/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/c/func/SSLGetPeerCertificates" target="_top">SSLGetPeerCertificates</a></code> function, by creating one from certificate data using the <code><a href="../../../Reference/certifkeytrustservices/Reference/reference.html#//apple_ref/c/func/SecCertificateCreateFromData" target="_top">SecCertificateCreateFromData</a></code> function, or by finding the certificate on a keychain. </p><p><span class="content_text">Listing 3-1</span> shows sample code for obtaining a certificate object by finding the certificate on a keychain. In this sample, the certificate is identified by the email address of the certificate owner. You can use other certificate attributes for this purpose, such as the label of the keychain item or its modification date. A detailed explanation for each numbered line of code follows the listing.</p><a name="//apple_ref/doc/uid/TP40001358-CH205-DontLinkElementID_12" title="Listing 3-1Finding a certificate on the keychain"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP40001358-CH205-BBCFIHHF" title="Listing 3-1Finding a certificate on the keychain"></a><strong>Listing 3-1&nbsp;&nbsp;</strong>Finding a certificate on the keychain</p><div class="codesample"><table><tr><td scope="row"><pre>#include &lt;CoreFoundation/CoreFoundation.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;Security/Security.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;CoreServices/CoreServices.h><span></span></pre></td></tr><tr><td scope="row"><pre>OSStatus GetCertRef (SecKeychainAttributeList *attrList,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    SecKeychainItemRef *itemRef)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status;<span></span></pre></td></tr><tr><td scope="row"><pre>    SecKeychainSearchRef searchReference = nil;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status = SecKeychainSearchCreateFromAttributes (    <span>// 1</span></pre></td></tr><tr><td scope="row"><pre>        NULL,                                           <span>// 2</span></pre></td></tr><tr><td scope="row"><pre>        kSecCertificateItemClass,                       <span>// 3</span></pre></td></tr><tr><td scope="row"><pre>        attrList,                                       <span>// 4</span></pre></td></tr><tr><td scope="row"><pre>        &amp;searchReference<span></span></pre></td></tr><tr><td scope="row"><pre>    );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status = SecKeychainSearchCopyNext (                <span>// 5</span></pre></td></tr><tr><td scope="row"><pre>        searchReference,<span></span></pre></td></tr><tr><td scope="row"><pre>        itemRef<span></span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre>    if (searchReference)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(searchReference);                     <span>// 6</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return (status);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre>int main (int argc, const char * argv[]) {<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status;<span></span></pre></td></tr><tr><td scope="row"><pre>    SecKeychainItemRef itemRef = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    SecKeychainAttributeList attrList;<span></span></pre></td></tr><tr><td scope="row"><pre>    SecKeychainAttribute attrib;<span></span></pre></td></tr><tr><td scope="row"><pre>    attrList.count = 1;                                 <span>// 7</span></pre></td></tr><tr><td scope="row"><pre>    attrList.attr  = &amp;attrib;<span></span></pre></td></tr><tr><td scope="row"><pre>    attrib.tag = kSecAlias;                             <span>// 8</span></pre></td></tr><tr><td scope="row"><pre>    attrib.data = "emailname@domain.com";               <span>// 9</span></pre></td></tr><tr><td scope="row"><pre>    attrib.length = strlen(attrib.data);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status = GetCertRef (&amp;attrList, &amp;itemRef);<span></span></pre></td></tr><tr><td scope="row"><pre>    .<span></span></pre></td></tr><tr><td scope="row"><pre>    .<span></span></pre></td></tr><tr><td scope="row"><pre>    .<span></span></pre></td></tr><tr><td scope="row"><pre>    if (itemRef)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(itemRef);                             <span>// 10</span></pre></td></tr><tr><td scope="row"><pre>    return (status);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Sets up keychain item search criteria and gets a search reference object. This object must be disposed of when it’s no longer needed.</p></li><li class="li"><p>Passes <code>NULL</code> to use the default keychain search list.</p></li><li class="li"><p>Specifies that the search is for a certificate.</p></li><li class="li"><p>Provides the list of attributes to match. The attributes are defined in the main routine (see steps 7 through 9).</p></li><li class="li"><p>Finds the certificate on the keychain and retrieves the keychain item reference object. This object must be disposed of when no longer needed. Note that a keychain item object for a certificate can be cast to a certificate object.</p></li><li class="li"><p>Disposes of the search reference object, which is no longer needed.</p></li><li class="li"><p>Specifies that there is only one attribute in the attribute list.</p></li><li class="li"><p>Specifies that the attribute is to be of type <code>kSecAlias</code>. In the case of a certificate, this indicates that the attribute is the email address of the certificate owner.</p></li><li class="li"><p>Specifies the email address to search for.</p></li><li class="li"><p>Disposes of the keychain item object at the end of the routine, after it has been used to evaluate the trust (<span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP40001358-CH205-BBCEIJHC">Listing 3-3</a></span>).</p></li></ol><a name="//apple_ref/doc/uid/TP40001358-CH205-DontLinkElementID_5" title="Obtaining a Policy Object"></a><h2>Obtaining a Policy Object</h2><p>The criteria for evaluation of trust are set by trust policies.   Trust policies can specify, for example, whether each certificate in the chain must be checked against a certificate revocation list, or that certificates’ expiration dates should be ignored.</p><p><span class="content_text">Listing 3-2</span> shows how you can obtain a policy object for use in an evaluation. To use this procedure, you must know the object identifier (OID) of the policy. OIDs of policies implemented by the AppleX509TP CDSA module are shown in <span class="content_text"><a href="../../../Reference/certifkeytrustservices/certKeyTrustPolicies/certKeyTrustPolicies.html#//apple_ref/doc/uid/TP30000157-CH204" target="_top">Appendix A</a></span> of <em><a href="../../../Reference/certifkeytrustservices/index.html#//apple_ref/doc/uid/TP30000157" target="_top">Certificate, Key, and Trust Services Reference</a></em>. A detailed explanation for each numbered line of code follows the listing.</p><a name="//apple_ref/doc/uid/TP40001358-CH205-DontLinkElementID_13" title="Listing 3-2Obtaining a policy reference object"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP40001358-CH205-BBCCHDDG" title="Listing 3-2Obtaining a policy reference object"></a><strong>Listing 3-2&nbsp;&nbsp;</strong>Obtaining a policy reference object</p><div class="codesample"><table><tr><td scope="row"><pre>OSStatus FindPolicy (const CSSM_OID *policyOID, SecPolicyRef *policyRef)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status1;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status2;<span></span></pre></td></tr><tr><td scope="row"><pre>    SecPolicySearchRef searchRef;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status1 = SecPolicySearchCreate (               <span>// 1</span></pre></td></tr><tr><td scope="row"><pre>        CSSM_CERT_X_509v3,                          <span>// 2</span></pre></td></tr><tr><td scope="row"><pre>        policyOID,                                  <span>// 3</span></pre></td></tr><tr><td scope="row"><pre>        NULL,<span></span></pre></td></tr><tr><td scope="row"><pre>        &amp;searchRef<span></span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status2 = SecPolicySearchCopyNext (             <span>// 4</span></pre></td></tr><tr><td scope="row"><pre>        searchRef,<span></span></pre></td></tr><tr><td scope="row"><pre>        policyRef<span></span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (searchRef)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(searchRef);                       <span>// 5</span></pre></td></tr><tr><td scope="row"><pre>    return (status2);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre>int main (int argc, const char * argv[]) {<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status;<span></span></pre></td></tr><tr><td scope="row"><pre>    const CSSM_OID *myPolicyOID = &amp;CSSMOID_APPLE_X509_BASIC;<span></span></pre></td></tr><tr><td scope="row"><pre>    SecPolicyRef policyRef = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    status = FindPolicy (myPolicyOID, &amp;policyRef);<span></span></pre></td></tr><tr><td scope="row"><pre>    .<span></span></pre></td></tr><tr><td scope="row"><pre>    .<span></span></pre></td></tr><tr><td scope="row"><pre>    .<span></span></pre></td></tr><tr><td scope="row"><pre>    if (policyRef)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(policyRef);                        <span>// 6</span></pre></td></tr><tr><td scope="row"><pre>    return (status);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Sets up policy search criteria and gets a policy search reference object. This object must be disposed of when no longer needed.</p></li><li class="li"><p>Specifies the type of certificates used by the policy. Specify <code>CSSM_CERT_X_509v3</code> if you are uncertain of the certificate type.</p></li><li class="li"><p>Specifies the OID of the policy.</p></li><li class="li"><p>Finds the policy and retrieves the policy reference object. This object must be disposed of when no longer needed.</p></li><li class="li"><p>Disposes of the search reference object, which is no longer needed.</p></li><li class="li"><p>Disposes of the policy object at the end of the routine, after it has been used to evaluate the trust (<span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP40001358-CH205-BBCEIJHC">Listing 3-3</a></span>).</p></li></ol><a name="//apple_ref/doc/uid/TP40001358-CH205-DontLinkElementID_6" title="Evaluating Trust"></a><h2>Evaluating Trust</h2><p>Having obtained a certificate object (<span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP40001358-CH205-BBCFIHHF">Listing 3-1</a></span>) and a policy object (<span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP40001358-CH205-BBCCHDDG">Listing 3-2</a></span>), you can evaluate the trust of a certificate. If you know—or have a good guess for—the intermediate and root certificates needed to verify the certificate, you can include them in the array of certificates passed to the <code>SecTrustCreateWithCertificates</code> function. Whereas the intermediate and root certificates can be in any order, the leaf certificate—the one you want to evaluate—must be the first in the array. You can include certificates not needed for the evaluation with no ill effects. Any certificates in the certificate chain that you do not pass in to the function are sought in keychains on the system. Certificates and certificate chains are discussed in <em><a href="../../Security_Overview/index.html#//apple_ref/doc/uid/TP30000976" target="_top">Security Overview</a></em>.</p><p><span class="content_text">Listing 3-3</span> illustrates how you use Certificate, Key, and Trust functions to evaluate trust of a certificate. A detailed explanation for each numbered line of code follows the listing.</p><a name="//apple_ref/doc/uid/TP40001358-CH205-DontLinkElementID_14" title="Listing 3-3Evaluating trust"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP40001358-CH205-BBCEIJHC" title="Listing 3-3Evaluating trust"></a><strong>Listing 3-3&nbsp;&nbsp;</strong>Evaluating trust</p><div class="codesample"><table><tr><td scope="row"><pre>OSStatus EvaluateCert (SecCertificateRef cert, CFTypeRef policyRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                            SecTrustResultType *result,<span></span></pre></td></tr><tr><td scope="row"><pre>                            SecTrustRef *pTrustRef)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status1;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status2;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    SecCertificateRef evalCertArray[1] = { cert };  <span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    CFArrayRef cfCertRef = CFArrayCreate ((CFAllocatorRef) NULL,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        (void *)evalCertArray, 1,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        &amp;kCFTypeArrayCallBacks);<span></span></pre></td></tr><tr><td scope="row"><pre>    if (!cfCertRef)<span></span></pre></td></tr><tr><td scope="row"><pre>        return memFullErr;                          <span>// 2</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status1 = SecTrustCreateWithCertificates (      <span>// 3</span></pre></td></tr><tr><td scope="row"><pre>        cfCertRef,                                  <span>// 4</span></pre></td></tr><tr><td scope="row"><pre>        policyRef,                                  <span>// 5</span></pre></td></tr><tr><td scope="row"><pre>        pTrustRef<span></span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre>    if (status1)<span></span></pre></td></tr><tr><td scope="row"><pre>        return status1;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status2 = SecTrustEvaluate (                    <span>// 6</span></pre></td></tr><tr><td scope="row"><pre>        *pTrustRef,<span></span></pre></td></tr><tr><td scope="row"><pre>        result                                      <span>// 7</span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre>    // Release the objects we allocated<span></span></pre></td></tr><tr><td scope="row"><pre>    if (cfCertRef)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(cfCertRef);<span></span></pre></td></tr><tr><td scope="row"><pre>    if (cfDate)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(cfDate);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return (status2);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre>int main (int argc, const char * argv[]) {<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status1;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status2;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    SecKeychainItemRef itemRef = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    SecKeychainAttributeList attrList;<span></span></pre></td></tr><tr><td scope="row"><pre>    SecKeychainAttribute attrib;<span></span></pre></td></tr><tr><td scope="row"><pre>    attrList.count = 1;<span></span></pre></td></tr><tr><td scope="row"><pre>    attrList.attr  = &amp;attrib;<span></span></pre></td></tr><tr><td scope="row"><pre>    attrib.tag = kSecAlias;<span></span></pre></td></tr><tr><td scope="row"><pre>    attrib.data = "emailname@domain.com";<span></span></pre></td></tr><tr><td scope="row"><pre>    attrib.length = strlen(attrib.data);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    const CSSM_OID *myPolicyOID = &amp;CSSMOID_APPLE_X509_BASIC;<span></span></pre></td></tr><tr><td scope="row"><pre>    SecPolicyRef policyRef = nil;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    SecTrustRef trustRef = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    SecTrustResultType result;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    CFArrayRef certChain;<span></span></pre></td></tr><tr><td scope="row"><pre>    CSSM_TP_APPLE_EVIDENCE_INFO *statusChain = nil;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status = GetCertRef (&amp;attrList, &amp;itemRef);      <span>// 8</span></pre></td></tr><tr><td scope="row"><pre>    status1 = FindPolicy (myPolicyOID, &amp;policyRef); <span>// 9</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status2 = EvaluateCert (<span></span></pre></td></tr><tr><td scope="row"><pre>                            (SecCertificateRef)itemRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                            (CFTypeRef) policyRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                             &amp;result, &amp;trustRef);   <span>// 10</span></pre></td></tr><tr><td scope="row"><pre>    .<span></span></pre></td></tr><tr><td scope="row"><pre>    .<span></span></pre></td></tr><tr><td scope="row"><pre>    .<span></span></pre></td></tr><tr><td scope="row"><pre>    if (itemRef)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(itemRef);<span></span></pre></td></tr><tr><td scope="row"><pre>    if (policyRef)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(policyRef);<span></span></pre></td></tr><tr><td scope="row"><pre>    if (trustRef)<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(trustRef);                        <span>// 11</span></pre></td></tr><tr><td scope="row"><pre>    return (status2);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Makes a CFArray of one element from the provided certificate. See <span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP40001358-CH205-BBCFIHHF">Listing 3-1</a></span> for code to find a certificate on a keychain.</p></li><li class="li"><p>Returns with an error if it can’t allocate the array.</p></li><li class="li"><p>Sets up trust evaluation criteria and gets a trust management object. This object must be disposed of when no longer needed.</p></li><li class="li"><p>Provides an array of certificates, containing the certificate to be evaluated and possibly intermediate and root certificates that might be needed in the evaluation. In this sample, the array contains only one certificate.</p></li><li class="li"><p>Specifies the policy reference object of the policy to used in evaluating this certificate. See <span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP40001358-CH205-BBCCHDDG">Listing 3-2</a></span> for code to obtain a policy reference object.</p></li><li class="li"><p>Evaluates the certificate according to the specified policy.</p></li><li class="li"><p>Returns a result object that is used to obtain information about the result of the evaluation; see <span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP40001358-CH205-BBCHGDAI">Listing 3-5</a></span>.</p></li><li class="li"><p>Gets a certificate reference object; see <span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP40001358-CH205-BBCFIHHF">Listing 3-1</a></span>.</p></li><li class="li"><p>Gets a policy reference object; see <span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP40001358-CH205-BBCCHDDG">Listing 3-2</a></span>.</p></li><li class="li"><p>Evaluates the certificate and obtains a trust reference object. This object must be disposed of when no longer needed. The keychain item object is cast to a certificate object, which is possible because the certificate is on the keychain.</p></li><li class="li"><p>Disposes of the trust reference object, after it has been used to recover from a trust failure (<span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP40001358-CH205-BBCHGDAI">Listing 3-5</a></span>).</p></li></ol><a name="//apple_ref/doc/uid/TP40001358-CH205-DontLinkElementID_7" title="Recovering From a Trust Failure"></a><h2>Recovering From a Trust Failure</h2><p>There are several possible results of a trust evaluation, depending on such factors as whether all the certificates in the chain were found, whether they are all valid, and what the user trust settings are for the certificates. It is up to your application to determine the course of action based on the result of the evaluation. For example, if the result is <code>kSecTrustResultConfirm</code>, you should display a dialog requesting that the user give permission to proceed.</p><p>The evaluation result <code>kSecTrustResultRecoverableTrustFailure</code> indicates that trust was denied, but that it is possible to change settings to get a different result. For example, if the certificate used to sign a document has expired, you can change the date used for the evaluation to see whether the certificate was valid when the document was signed. The code in <span class="content_text">Listing 3-4</span> illustrates how to change the evaluation date. Note that the <code><a href="../../../../CoreFoundation/Reference/CFDateRef/Reference/reference.html#//apple_ref/c/func/CFDateCreate" target="_top">CFDateCreate</a></code> function takes an absolute time (the number of seconds since 1 January 2001); you can use the <code><a href="../../../../CoreFoundation/Reference/CFTimeUtils/Reference/reference.html#//apple_ref/c/func/CFGregorianDateGetAbsoluteTime" target="_top">CFGregorianDateGetAbsoluteTime</a></code> function to convert a calendar date and time into an absolute time.</p><a name="//apple_ref/doc/uid/TP40001358-CH205-DontLinkElementID_15" title="Listing 3-4Setting an evaluation date"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP40001358-CH205-BBCHECEH" title="Listing 3-4Setting an evaluation date"></a><strong>Listing 3-4&nbsp;&nbsp;</strong>Setting an evaluation date</p><div class="codesample"><table><tr><td scope="row"><pre>    OSStatus status;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    CFAbsoluteTime expDate;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFDateRef cfDate = nil;<span></span></pre></td></tr><tr><td scope="row"><pre>    expDate = 157680000;  //seconds since 1 Jan 2001<span></span></pre></td></tr><tr><td scope="row"><pre>    cfDate = CFDateCreate (NULL, expDate);<span></span></pre></td></tr><tr><td scope="row"><pre>    status = SecTrustSetVerifyDate (*pTrustRef, cfDate);<span></span></pre></td></tr></table></div><p><span class="content_text">Listing 3-5</span> illustrates recovery from a trust failure caused by an expired certificate. In this case, the evaluation criteria are changed to ignore expiration dates. A detailed explanation for each numbered line of code follows the listing.</p><a name="//apple_ref/doc/uid/TP40001358-CH205-DontLinkElementID_16" title="Listing 3-5Recovering from a trust failure"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP40001358-CH205-BBCHGDAI" title="Listing 3-5Recovering from a trust failure"></a><strong>Listing 3-5&nbsp;&nbsp;</strong>Recovering from a trust failure</p><div class="codesample"><table><tr><td scope="row"><pre>     int n;<span></span></pre></td></tr><tr><td scope="row"><pre>     CSSM_TP_APPLE_CERT_STATUS AllStatusBits = 0;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>status3 = EvaluateCert (<span></span></pre></td></tr><tr><td scope="row"><pre>                        (SecCertificateRef)itemRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                        (CFTypeRef) policyRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                        &amp;result, &amp;trustRef);                <span>// 1</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>if (status3 == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>    if (result ==  kSecTrustResultRecoverableTrustFailure)  <span>// 2</span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            status3 = SecTrustGetResult (<span></span></pre></td></tr><tr><td scope="row"><pre>                                        trustRef,           <span>// 3</span></pre></td></tr><tr><td scope="row"><pre>                                        &amp;result,            <span>// 4</span></pre></td></tr><tr><td scope="row"><pre>                                        &amp;certChain,         <span>// 5</span></pre></td></tr><tr><td scope="row"><pre>                                        &amp;statusChain        <span>// 6</span></pre></td></tr><tr><td scope="row"><pre>                                        );<span></span></pre></td></tr><tr><td scope="row"><pre>            if (!status3 &amp;&amp; statusChain)<span></span></pre></td></tr><tr><td scope="row"><pre>            {                                               <span>// 7</span></pre></td></tr><tr><td scope="row"><pre>                for (n = 0; n &lt;=                            <span>// 8</span></pre></td></tr><tr><td scope="row"><pre>                        (CFArrayGetCount(certChain)-1); n++)<span></span></pre></td></tr><tr><td scope="row"><pre>                AllStatusBits =<span></span></pre></td></tr><tr><td scope="row"><pre>                    AllStatusBits | statusChain[n].StatusBits;<span></span></pre></td></tr><tr><td scope="row"><pre>            if (AllStatusBits &amp; CSSM_CERT_STATUS_EXPIRED)<span></span></pre></td></tr><tr><td scope="row"><pre>                {<span></span></pre></td></tr><tr><td scope="row"><pre>                    CSSM_APPLE_TP_ACTION_DATA actionData;   <span>// 9</span></pre></td></tr><tr><td scope="row"><pre>                    actionData.Version =<span></span></pre></td></tr><tr><td scope="row"><pre>                            CSSM_APPLE_TP_ACTION_VERSION;   <span>// 10</span></pre></td></tr><tr><td scope="row"><pre>                    actionData.ActionFlags =<span></span></pre></td></tr><tr><td scope="row"><pre>                        CSSM_TP_ACTION_ALLOW_EXPIRED |<span></span></pre></td></tr><tr><td scope="row"><pre>                        CSSM_TP_ACTION_ALLOW_EXPIRED_ROOT;  <span>// 11</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                    CFDataRef myActionData =                <span>// 12</span></pre></td></tr><tr><td scope="row"><pre>                        CFDataCreateWithBytesNoCopy<span></span></pre></td></tr><tr><td scope="row"><pre>                            (NULL, (UInt8*) &amp;actionData,<span></span></pre></td></tr><tr><td scope="row"><pre>                             sizeof(actionData),<span></span></pre></td></tr><tr><td scope="row"><pre>                             kCFAllocatorNull);             <span>// 13</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                    if (myActionData)<span></span></pre></td></tr><tr><td scope="row"><pre>                        {<span></span></pre></td></tr><tr><td scope="row"><pre>                            status2 = SecTrustSetParameters (<span></span></pre></td></tr><tr><td scope="row"><pre>                                        trustRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        CSSM_TP_ACTION_DEFAULT,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        myActionData);      <span>// 14</span></pre></td></tr><tr><td scope="row"><pre>                            status3 = SecTrustEvaluate (<span></span></pre></td></tr><tr><td scope="row"><pre>                                        trustRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        &amp;result<span></span></pre></td></tr><tr><td scope="row"><pre>                                        );                  <span>// 15</span></pre></td></tr><tr><td scope="row"><pre>                            status3 = SecTrustGetResult (<span></span></pre></td></tr><tr><td scope="row"><pre>                                        trustRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        &amp;result,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        &amp;certChain,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        &amp;statusChain);      <span>// 16</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                            CFRelease(myActionData);<span></span></pre></td></tr><tr><td scope="row"><pre>                    }<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Evaluates trust for a specific certificate and policy (see <span class="content_text"><a href="tasks.html#//apple_ref/doc/uid/TP40001358-CH205-BBCEIJHC">Listing 3-3</a></span>).</p></li><li class="li"><p>Checks the result of the evaluation. If there was a recoverable trust failure, the routine goes on to obtain more information.</p></li><li class="li"><p>Passes the trust management object obtained earlier.</p></li><li class="li"><p>Passes a pointer to the result object obtained earlier.</p></li><li class="li"><p>Returns the certificate chain used to verify the evaluated certificate.</p></li><li class="li"><p>Returns an array of structures, each of which contains information about the status of one certificate in the chain.</p></li><li class="li"><p>If the function suceeds, checks for the validity of <code>statusChain</code>. The <code>statusChain</code> pointer is left uninitialized if <code>(result !=  kSecTrustResultRecoverableTrustFailure)</code> or if <code>(status3 != noErr)</code>.</p></li><li class="li"><p>Checks to see if the status bits of any certificates in the chain indicate an expired certificate. If so, you can recover from this condition.</p><p>Before proceeding, you should prompt the user to ask permission to use expired certificates. You can check through the status chain to determine which certificate has expired and give that information to the user. If the user approves of using expired certificates, continue with the rest of this sample. If not, quit here.</p></li><li class="li"><p>Allocates space on the stack for an action data structure.</p></li><li class="li"><p>Fills in the <code>Version</code> field of the action data structure.</p></li><li class="li"><p>Fills in the <code>ActionFlags</code> field of the action data structure to allow expired certificates and root certificates.</p></li><li class="li"><p>Creates a CFDataRef from the action data.</p></li><li class="li"><p>Passes <code>kCFAllocatorNull</code> as the last parameter (<code>bytesDeallocator</code>) so that the bytes the CFDataRef points to aren’t freed automatically.</p></li><li class="li"><p>Uses the action data to set the parameters for the trust object so that the next time it is evaluated, it will allow expired certificates.</p></li><li class="li"><p>Reevaluates the trust.</p></li><li class="li"><p>Checks the results of the evaluation.</p></li></ol>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../iPhone_Tasks/iPhone_Tasks.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../glossary/glossary.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2003, 2008 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2008-11-19<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Security/Conceptual/CertKeyTrustProgGuide/03tasks/tasks.html%3Fid%3DTP40001358-2.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Security/Conceptual/CertKeyTrustProgGuide/03tasks/tasks.html%3Fid%3DTP40001358-2.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Security/Conceptual/CertKeyTrustProgGuide/03tasks/tasks.html%3Fid%3DTP40001358-2.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>