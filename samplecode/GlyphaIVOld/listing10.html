<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>GlyphaIVOld - /G4Sound.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/Games/index.html">Games</a> &gt; <a href="../../samplecode/Games/idxGraphicsImaging-date.html">Graphics & Imaging</a> &gt; <A HREF="javascript:location.replace('index.html');">GlyphaIVOld</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Not Recommended Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>The information in this document is <strong>Not Recommended</strong> and should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Games/idxGraphicsImaging-date.html" target="_blank">Games > Graphics & Imaging</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">GlyphaIVOld</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/G4Sound.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/G4Enemy.c</option>
<option value="listing2.html">/G4Externs.h</option>
<option value="listing3.html">/G4Graphics.c</option>
<option value="listing4.html">/G4Interface.c</option>
<option value="listing5.html">/G4Lava.c</option>
<option value="listing6.html">/G4Main.c</option>
<option value="listing7.html">/G4Play.c</option>
<option value="listing8.html">/G4Prefs.c</option>
<option value="listing9.html">/G4SetUpTakeDown.c</option>
<option value="listing10.html">/G4Sound.c</option>
<option value="listing11.html">/G4Utilities.c</option></select>
				</p>
				</form>
				<p><strong><a href="GlyphaIVOld.zip">Download Sample</a></strong> (&#147;GlyphaIVOld.zip&#148;, 106.6K)<BR>
<strong><a href="GlyphaIVOld.dmg">Download Sample</a></strong> (&#147;GlyphaIVOld.dmg&#148;, 175.8K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*  File:    G4Sound.c  Contains:  xxx put contents here xxx  Version:  xxx put version here xxx  Copyright:  &copy; 1998 by Apple Computer, Inc., all rights reserved.  File Ownership:    DRI:        xxx put dri here xxx    Other Contact:    xxx put other contact here xxx    Technology:      xxx put technology here xxx  Writers:    (sjb)  Steve Bollinger  Change History (most recent first):     &lt;2&gt;    7/1/98  sjb    Update to CWPro 2*///============================================================================//----------------------------------------------------------------------------//                  Sound.c//----------------------------------------------------------------------------//============================================================================// This file handles all sound routines.  It handles 2 concurrent sound\xC9// channels allowing 2 sounds to be played simultaneously.  It also handles\xC9// a system of priorites whereby you can ensure that &quot;important&quot; sounds don't\xC9// get cut off by &quot;lesser&quot; sounds.  In that there are 2 channels however,\xC9// &quot;lesser&quot; sounds are not discounted outright - both channels are considered\xC9// to determine if one of the channels is not playing at all (priority = 0) or\xC9// playing a sound of an even lesser priority.  Make sense?#include &lt;Sound.h&gt;#include &quot;G4Externs.h&quot;#include &lt;Resources.h&gt;#define kMaxSounds        17      // Number of sounds to load.#define  kBaseBufferSoundID    1000    // ID of first sound (assumed sequential).#define kSoundDone        913      // Just a number I chose.#define kSoundDone2        749      // Just a number I chose.void PlaySound1 (short, short);void PlaySound2 (short, short);pascal void ExternalCallBack (SndChannelPtr, SndCommand *);pascal void ExternalCallBack2 (SndChannelPtr, SndCommand *);void LoadAllSounds (void);OSErr LoadBufferSounds (void);OSErr DumpBufferSounds (void);OSErr OpenSoundChannel (void);OSErr CloseSoundChannel (void);SndCallBackUPP    externalCallBackUPP, externalCallBackUPP2;SndChannelPtr    externalChannel, externalChannel2;Ptr          theSoundData[kMaxSounds];short        externalPriority, externalPriority2;Boolean        channelOpen, soundOn;//==============================================================  Functions//--------------------------------------------------------------  PlaySound1// This function takes a sound ID and a priority, and forces that sound to // play through channel 1 - and saves the priority globally.  As well, a // callback command is queues up in channel 1.void PlaySound1 (short soundID, short priority){  SndCommand  theCommand;  OSErr    theErr;    theCommand.cmd = flushCmd;      // Send 1st a flushCmd to clear the sound queue.  theCommand.param1 = 0;  theCommand.param2 = 0L;  theErr = SndDoImmediate(externalChannel, &amp;theCommand);    theCommand.cmd = quietCmd;      // Send quietCmd to stop any current sound.  theCommand.param1 = 0;  theCommand.param2 = 0L;  theErr = SndDoImmediate(externalChannel, &amp;theCommand);    externalPriority = priority;    // Copy priority to global variable.    theCommand.cmd = bufferCmd;      // Then, send a bufferCmd to channel 1.  theCommand.param1 = 0;        // The sound played will be soundID.  theCommand.param2 = (long)(theSoundData[soundID]);  theErr = SndDoImmediate(externalChannel, &amp;theCommand);    theCommand.cmd = callBackCmd;    // Lastly, queue up a callBackCmd to notify us\xC9  theCommand.param1 = kSoundDone;    // when the sound has finished playing.  theCommand.param2 = SetCurrentA5();  theErr = SndDoCommand(externalChannel, &amp;theCommand, TRUE);}//--------------------------------------------------------------  PlaySound2// This function is identical to the above function except that it handles\xC9// playing sounds through channel 2.void PlaySound2 (short soundID, short priority){  SndCommand  theCommand;  OSErr    theErr;    theCommand.cmd = flushCmd;      // Send 1st a flushCmd to clear the sound queue.  theCommand.param1 = 0;  theCommand.param2 = 0L;  theErr = SndDoImmediate(externalChannel2, &amp;theCommand);    theCommand.cmd = quietCmd;      // Send quietCmd to stop any current sound.  theCommand.param1 = 0;  theCommand.param2 = 0L;  theErr = SndDoImmediate(externalChannel2, &amp;theCommand);    externalPriority2 = priority;    // Copy priority to global variable.    theCommand.cmd = bufferCmd;      // Then, send a bufferCmd to channel 1.  theCommand.param1 = 0;        // The sound played will be soundID.  theCommand.param2 = (long)(theSoundData[soundID]);  theErr = SndDoImmediate(externalChannel2, &amp;theCommand);    theCommand.cmd = callBackCmd;    // Lastly, queue up a callBackCmd to notify us\xC9  theCommand.param1 = kSoundDone2;  // when the sound has finished playing.#if !GENERATINGCFM  theCommand.param2 = SetCurrentA5();#endif  theErr = SndDoCommand(externalChannel2, &amp;theCommand, TRUE);}//--------------------------------------------------------  PlayExternalSound// This function is probably poorly named for this application.  I lifted this\xC9// whole library from one of my games and chopped it down for purposes of Glypha.// The original game treated &quot;external&quot; and &quot;cockpit&quot; sounds as seperate channels\xC9// (such that cockpit sounds could only &quot;override&quot; other cockpit sounds and\xC9// external sounds could only override other external sounds.// In any event, this is the primary function called from throughout Glypha.// This function is called with a sound ID and a priority (just some number) and\xC9// the function then determines if one of the two sound channels is free to play\xC9// the sound.  It determines this by way of priorities.  If a sound channel is\xC9// idle and playing no sound, its channel priority is 0.  Since the priority of\xC9// the sound you want to play is assumed to be greater than 0, it will, without\xC9// a doubt, be allowed to play on an idle channel.  If however there is already\xC9// a sound playing (the channel's priority is not equal to 0), the sound with the\xC9// largest priority wins.  Mind you though that there are two channels to choose\xC9// between.  Therefore, the function compares the priority passed in with the\xC9// sound channel with the lowest priority.void PlayExternalSound (short soundID, short priority){              // A little error-checking.  if ((soundID &gt;= 0) &amp;&amp; (soundID &lt; kMaxSounds))  {    if (soundOn)    // More error-checking.    {          // Find channel with lowest priority.      if (externalPriority &lt; externalPriority2)      {        // Compare priority with that of channel 1.        if (priority &gt;= externalPriority)          PlaySound1(soundID, priority);      }      else      {        // Compare priority with that of channel 2.        if (priority &gt;= externalPriority2)          PlaySound2(soundID, priority);      }    }  }}//--------------------------------------------------------  ExternalCallBack// Callback routine.  If this looks ugly, blame Apple's Universal Headers.// The callback routine is called after a sound finishes playing.  The\xC9// callback routine is extremely useful in that it enables us to know when\xC9// to set the sound channels priority back to 0 (meaning no sound playing).// Keep in mind (by the way) that this funciton is called at interrupt time\xC9// and thus may not cause memory to be moved.  Also, note that also because\xC9// of the interupt situation, we need to handle setting A5 to point to our\xC9// app's A5 and then set it back again.#if GENERATINGCFMRoutineDescriptor ExternalCallBackRD =     BUILD_ROUTINE_DESCRIPTOR(uppSndCallBackProcInfo, ExternalCallBack);#endifpascal void ExternalCallBack (SndChannelPtr theChannel, SndCommand *theCommand){#if !GENERATINGCFM  long    thisA5, gameA5;#endif    if (theCommand-&gt;param1 == kSoundDone)  // See if it's OUR callback.  {#if !GENERATINGCFM    gameA5 = theCommand-&gt;param2;      // Extract our A5 from sound command.    thisA5 = SetA5(gameA5);        // Point A5 to our app (save off current A5).#endif        externalPriority = 0;        // Set global to reflect no sound playing.    #if !GENERATINGCFM    thisA5 = SetA5(thisA5);        // Restire A5.#endif  }}//--------------------------------------------------------  ExternalCallBack2// This function is identical to the above function but handles sound channel 2.#if GENERATINGCFMRoutineDescriptor ExternalCallBackRD2 =     BUILD_ROUTINE_DESCRIPTOR(uppSndCallBackProcInfo, ExternalCallBack2);#endifpascal void ExternalCallBack2 (SndChannelPtr theChannel, SndCommand *theCommand){#if !GENERATINGCFM  long    thisA5, gameA5;#endif    if (theCommand-&gt;param1 == kSoundDone2)  // See if it's OUR callback.  {#if !GENERATINGCFM    gameA5 = theCommand-&gt;param2;      // Extract our A5 from sound command.    thisA5 = SetA5(gameA5);        // Point A5 to our app (save off current A5).#endif        externalPriority2 = 0;        // Set global to reflect no sound playing.    #if !GENERATINGCFM    thisA5 = SetA5(thisA5);        // Restire A5.#endif  }}//--------------------------------------------------------  LoadBufferSounds// This function loads up all the sounds we'll need in the game and then\xC9// strips off their header so that we can pass them as buffer commands.// Sounds are stored in our resource fork as 'snd ' resources.  There is a\xC9// 20 byte header that we need to remove in order to use bufferCmd's.// This function is called only once, when the game loads up.OSErr LoadBufferSounds (void){  Handle    theSound;  long    soundDataSize;  OSErr    theErr;  short    i;    theErr = noErr;            // Assume no errors.    for (i = 0; i &lt; kMaxSounds; i++)  // Walk through all sounds.  {                  // Load 'snd ' from resource.    theSound = GetResource('snd ', i + kBaseBufferSoundID);    if (theSound == 0L)        // Make sure it loaded okay.      return (ResError());    // Return reason it failed (if it did).        HLock(theSound);        // If we got this far, lock sound down.                    // Calculate size of sound minus header.    soundDataSize = GetHandleSize(theSound) - 20L;    HUnlock(theSound);        // Okay, unlock.                    // Create pointer the size calculated above.    theSoundData[i] = NewPtr(soundDataSize);    if (theSoundData[i] == 0L)    // See if we created it okay.      return (MemError());    // If failed, return the reason why.    HLock(theSound);        // Okay, lock the sound handle again.                    // Copy sound data (minus header) to our pointer.    BlockMove((Ptr)(*theSound + 20L), theSoundData[i], soundDataSize);    HUnlock(theSound);        // Unlock sound handle again.    ReleaseResource(theSound);    // And toss it from memory.  }    return (theErr);}//--------------------------------------------------------  DumpBufferSounds// This function is called when Glypha exits (quits).  All those nasty pointers\xC9// we created in the above function are reclaimed.OSErr DumpBufferSounds (void){  OSErr    theErr;  short    i;    theErr = noErr;    for (i = 0; i &lt; kMaxSounds; i++)    // Go through all sound pointers.  {    if (theSoundData[i] != 0L)      // Make sure it exists.      DisposePtr(theSoundData[i]);    // Dispose of it.    theSoundData[i] = 0L;        // Make sure it reflects its &quot;nonexistence&quot;.  }    return (theErr);}//--------------------------------------------------------  OpenSoundChannel// This should perhaps be called OpenSoundChannels() since it opens two.// It is called once (at initialization) to set up the two sound channels\xC9// we will use throughout Glypha.  For purposes of speed, 8-bit sound channels\xC9// with no interpolation and monophonic are opened.  They'll use the sampled\xC9// synthesizer (digitized sound) and be assigned their respective callback\xC9// routines.OSErr OpenSoundChannel (void){  OSErr    theErr;    #if GENERATINGCFM    externalCallBackUPP = &amp;ExternalCallBackRD;  // Handle Universal Header ugliness.    externalCallBackUPP2 = &amp;ExternalCallBackRD2;  #else    externalCallBackUPP = (SndCallBackUPP) &amp;ExternalCallBack;    externalCallBackUPP2 = (SndCallBackUPP) &amp;ExternalCallBack2;  #endif    theErr = noErr;                  // Assume no errors.    if (channelOpen)                // Error checking.    return (theErr);    externalChannel = 0L;  theErr = SndNewChannel(&amp;externalChannel,     // Open channel 1.      sampledSynth, initNoInterp + initMono,       (SndCallBackUPP)externalCallBackUPP);  if (theErr == noErr)              // See if it worked.    channelOpen = TRUE;    externalChannel2 = 0L;  theErr = SndNewChannel(&amp;externalChannel2,     // Open channel 2.      sampledSynth, initNoInterp + initMono,       (SndCallBackUPP)externalCallBackUPP2);  if (theErr == noErr)              // See if it worked.    channelOpen = TRUE;    return (theErr);}//--------------------------------------------------------  CloseSoundChannel// This function is called only upon quitting Glypha.  Both sound channels\xC9// we created above are closed down.OSErr CloseSoundChannel (void){  OSErr    theErr;    theErr = noErr;    if (!channelOpen)      // Error checking.    return (theErr);    if (externalChannel != 0L)  // Dispose of channel 1 (if open).    theErr = SndDisposeChannel(externalChannel, TRUE);  externalChannel = 0L;    // Flag it closed.    if (externalChannel2 != 0L)  // Dispose of channel 2 (if open).    theErr = SndDisposeChannel(externalChannel2, TRUE);  externalChannel2 = 0L;    // Flag it closed.    if (theErr == noErr)    channelOpen = FALSE;    return (theErr);}//--------------------------------------------------------  InitSound// All the above initialization routines are handled by this one function.// This single function is the only one that needs to be called - it handles\xC9// calling the functions that load the sounds and create the sound channels.// It is called from main() when Glypha is loading up and going through its\xC9// initialization phase.void InitSound (void){  OSErr    theErr;    soundOn = TRUE;      // Note that initialization of sounds has occurred\xC9              // (or rather is just about to this instant!).  externalChannel = 0L;  // Flag channels as nonexistant.  externalChannel2 = 0L;  externalPriority = 0;  // Set priorities to 0 (no sound playing).  externalPriority2 = 0;              // Load up all sounds (see above function).  theErr = LoadBufferSounds();  if (theErr != noErr)  // If it fails, we'll quit Glypha.    RedAlert(&quot;\pFailed Loading Sounds&quot;);              // Open up the two sound channels.  theErr = OpenSoundChannel();  if (theErr != noErr)  // If that fails we'll quit Glypha as well.    RedAlert(&quot;\pFailed To Open Sound Channels&quot;);}//--------------------------------------------------------  KillSound// Complementary to the above function, this one is called only when Glypha\xC9// quits and it handles all the &quot;shut-down&quot; routines.  It also is called from\xC9// main(), but it is called last - just as Glypha is quitting.void KillSound (void){  OSErr    theErr;    theErr = DumpBufferSounds();  // Kill all sound pointers.  theErr = CloseSoundChannel();  // Close down the sound channels.}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/GlyphaIVOld/listing10.html%3Fid%3DDTS10000053-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/GlyphaIVOld/listing10.html%3Fid%3DDTS10000053-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/GlyphaIVOld/listing10.html%3Fid%3DDTS10000053-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>