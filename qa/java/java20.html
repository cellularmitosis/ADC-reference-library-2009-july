<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">	<title>Technical Q&amp;A JAVA20: Using System.currentTimeMillis( )</title>				<meta name="keywords" content="MRJ Java System.currentTimeMillis">	<meta name="Description" content="Technical Q&amp;A JAVA20: Q&amp;A explains why the routine &quot;System.currentTimeMillis&quot;
returns incorrect values on certain Macintosh computers,
in jdk 1.1.x on Mac OS Classic
and discusses workaround options for this."><meta name="categories" content="Java"><meta name="week-posted" content="Jan 31, 2000 - Feb 4, 2000"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10001395" title="Using System.currentTimeMillis( )"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalqas/LegacyTechnologies/idxJava-date.html">Java</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/Java/idxPorting-date.html" target="_blank">Java > Porting</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A JAVA20</div>
<div id="pageheadsub">Using System.currentTimeMillis( )</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment -->						<!-- begin_content --> <CENTER><TABLE BORDER=0 CELLPADDING=0 WIDTH=600><TR> <td align="left"><hr width=500 align=center><p id=p2>Q: My Java application relies on the values returned by <CODE>System.currentTimeMillis( )</CODE> for its internal timing. This routine seems to return incorrect values on portable Macintosh computers. For example, I have some code:</p>      <TABLE BORDER=0 CELLPADDING=1 width="545">        <TR bgcolor="#EFEFDE">           <td align="left">             <pre><b>import</b> java.text.*;<b>public class</b> CurrentTimeChecker <b>implements</b> Runnable{    Thread thread <b>=</b> <b>new</b> Thread(<b>this</b>);    <b>long</b>[] times = <b>new</b> <b>long</b>[500];    <b>long</b> lastT = 0;    <b>int</b> timesCursor = 0;    <b>public boolean</b> timeToStop = <b>false</b>;    NumberFormat nf = <b>null</b>;    <b>public</b> CurrentTimeChecker()    {        initNF();        thread.start();    }    <b>void</b> initNF()    {        nf = NumberFormat.getNumberInstance();        nf.setMinimumFractionDigits(0);        nf.setMaximumFractionDigits(0);        <b>int</b> numDigits = Long.toString(Long.MAX_VALUE).length();        nf.setMinimumIntegerDigits(numDigits);        nf.setMaximumIntegerDigits(numDigits);    }    <b>static public void</b> main(String[] args)    {        <b>new</b> CurrentTimeChecker();    }   <b> public void</b> run()    {        <b>while</b>(! timeToStop)        {            <b>try</b>            {                Thread.sleep(1000);            }            <b>catch</b>(InterruptedException e) {}            <b>long</b> t = System.currentTimeMillis();            <b>if</b> ( t &#62; lastT )                System.out.println(nf.format(t));            <b>if</b> ( t &#60; lastT )            {                System.out.println(nf.format(t) + "  &#60;---- ");                java.awt.Toolkit.getDefaultToolkit().beep();            }            times[timesCursor++] = t;        <b>    if</b> (timesCursor &#62;= times.length)                timesCursor = 0;            lastT = t;        }        System.out.println("Finished...");    }} // class CurrentTimeChecker</pre>          </TD> </TR> </TABLE> <BR><p id=p2>My code sleeps for a certain interval, then calculates the elapsed time. On my PowerBook, sometimes I get negative time intervals. Why does this happen?</P><p id=p4>A: This is the result of a bug in MRJ 2.1.4. It is not the <CODE>sleep( )</CODE>that is causing the problem, it is the call to <CODE>System.currentTimeMillis( )</CODE> that is causing this behavior. This problem may occur for ANY interval calculation regardless of whether <code>sleep( )</code> is called or not. As of MRJ 2.2, the issue has been resolved. Incidentally, the fix was discovered as a consequence of long file name testing on Mac OS 9.</p><p id=p4>Mac OS 9 has a millisecond accurate time service available that works with "modern" hardware. Older systems and older hardware have to make do with unreconciled fast timers and the 1-second granular clock. Previous MRJ versions would sample the 1-second granule clock, mark that sample as being .0, and count milliseconds forward from the timer clock. This algorithm would restart every minute. The effect is that every minute MRJ would report times being up to plus/minus one second from the previous time. There may even have been cases where reported time intervals would briefly go backwards.</p><p id=p4>The new behavior on Mac OS 9 and "modern" hardware (G3 for the most part) is to let Mac OS do it for us. Otherwise, we pause on startup and note and track (with the timer) the transition of the 1-second granule clock. This calibration is repeated after an interval of several minutes.</p><p id=p4>This new fix is present in MRJ 2.2. Developers may download MRJ 2.2 from the <a href="http://developer.apple.com/java/text/download.html" target="_blank">MRJ 2.2 Download page</a>.</p><p id=p4>For developers who do not wish to update to the lastest version, we recommend that you use Mac OS 9, which should minimize this problem on new hardware. If you need to do timing on previous operating systems or older machines, we recommend that you check out <a href="mailto:glguerin@amug.org">Greg Guerin's</a> example on how to use the Macintosh microsecond timer, instead. Not only will you not experience this problem, but you will also be able to get finer grained control:</p><BLOCKQUOTE><p id=p4>"If you're interested, the <a href="http://www.amug.org/%7Eglguerin/sw/hax/Anti-time-bandit.sit.bin">source for my test program</a> has a class that will read the free-running microsecond timer under MRJ. Obviously, it won't work on other platforms, but you can write platform-sensing Java code to pick between implementations. As far as I can tell, this counter is completely free-running, and counts microseconds since last restart, though I don't know if it has PowerBook peculiarities in low-power modes. Also, it doesn't seem to be subject to the backwards-time drift correction currently observable in MRJ. While this won't help sleep(long) or wait(long), it should let you calculate elapsed times without worrying about drift-correcting adjustments botching the calculation."</p></BLOCKQUOTE><!-- begin_date --><H4 ALIGN=center>[Feb 02 2000]</H4><!-- end_date --></td></tr></table></CENTER><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/java/java20.html%3Fid%3DDTS10001395-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/java/java20.html%3Fid%3DDTS10001395-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/java/java20.html%3Fid%3DDTS10001395-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --> <hr width=500 align=center> </BODY> </HTML>