<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Determining and Changing Control Settings(IM:Tb)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING311></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Toolbox-310.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Toolbox-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Toolbox-490.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Toolbox-312.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Toolbox-2.html"><B>Macintosh Toolbox Essentials</B></A> / <BR><DD><A HREF="Toolbox-297.html"><B>Chapter 5 - Control Manager</B></A> / <A HREF="Toolbox-308.html"><B>Using the Control Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING311-0></A>
<H2><A NAME=MARKER-9-227></A>Determining and Changing Control Settings</H2>
 <A NAME=MARKER-2-228></A>Using either the control resource or the parameters to the <CODE>NewControl</CODE> function, your application specifies a control's various default values--such as its current setting and minimum and maximum settings--when it creates the control. <P>
 When the user clicks a control, however, your application often needs to determine <BR>the current setting and other possible values of that control. When the user clicks a checkbox, for example, your application must determine whether the box is checked before your application can decide whether to clear or draw a checkmark inside the checkbox. When the user moves the scroll box, your application needs to determine what part of the document to display.<P>
 Applications must adjust some controls in response to events other than mouse events in the controls themselves. For example, when the user resizes a window, your application must use the Control Manager procedures <CODE>MoveControl</CODE> and <CODE>SizeControl</CODE> to move and resize the scroll bars appropriately.<P>
 Your application can use the <CODE>GetControlValue</CODE> function to determine the current setting of a control, and it can use the <CODE>GetControlMaximum</CODE> function to determine a control's maximum setting.<P>
 You can use the <CODE>SetControlValue</CODE> procedure to change the control's setting and redraw the control accordingly. You can use the <CODE>SetControlMaximum</CODE> procedure to change a control's maximum setting and to redraw the indicator or scroll box to reflect the new setting.<P>
 <A NAME=MARKER-2-135></A>In response to user action involving a control, your application often needs to change the setting and possibly redraw the control. When the user clicks a checkbox, for example, your application must determine whether the checkbox is currently selected or not, and then switch its setting. When you use <CODE>SetControlValue</CODE> to switch a checkbox setting, the Control Manager either draws or removes the X inside the checkbox, as appropriate. When the user clicks a radio button, your application must determine whether the radio button is already on and, if not, turn the previously selected radio button off and turn the newly selected radio button on.<P>
 <A HREF=Toolbox-310.html#MARKER-9-208>Figure 5-15 on page 5-31</A> shows a checkbox in the Play Sounds window. When the user clicks the checkbox to turn it on, the application adds a drum roll to the sound it plays whenever the user clicks the Play button.<P>
 <A NAME=MARKER-2-230></A><A HREF=#MARKER-9-231>Listing 5-13</A> shows the application-defined routine <CODE>DoDrumRollCheckBox</CODE>, which responds to a click in a checkbox. This routine uses the <CODE>GetControlValue</CODE> function to determine the last value of the checkbox and then uses the <CODE>SetControlValue</CODE> procedure to change it. The <CODE>GetControlValue</CODE> function returns a control's current setting, which is stored in the <CODE>contrlValue</CODE> field of the control record. The <CODE>SetControlValue</CODE> procedure sets the <CODE>contrlValue</CODE> field to the specified value and redraws the control to reflect the new setting. (For checkboxes and radio buttons, the value 1 fills the control with the appropriate mark, and the value 0 removes the mark. For scroll bars, <CODE>SetControlValue</CODE> redraws the scroll box at the appropriate position along the scroll bar. For a pop-up menu, <CODE>SetControlValue</CODE> displays in its pop-up box the name of the menu item corresponding to the specified value.)<P>
<B>Listing 5-13  <A NAME=MARKER-9-231></A>Responding to a click in a checkbox</B><P>
<PRE>
PROCEDURE DoDrumRollCheckBox (mouse: Point; control: ControlHandle);
VAR
   checkbox:Integer;
BEGIN          
   IF TrackControl(control, mouse, NIL) &lt;&gt; 0 THEN  {user clicks checkbox}
   BEGIN
      checkbox := GetControlValue(control);  {get last value of checkbox}
      checkbox := 1 - checkbox;              {toggle value of checkbox}
      SetControlValue(control, checkbox);    {set checkbox to new value}
      IF checkbox = 1 THEN                   {the checkbox is checked}
         gPlayDrumRoll := TRUE {play a drum roll next time user clicks Play}
      ELSE
         gPlayDrumRoll := FALSE;
   END;
END;
</PRE>
 The <CODE>DoDrumRollCheckBox</CODE> routine uses <CODE>TrackControl</CODE> to determine which control the user selects. When <CODE>TrackControl</CODE> reports that the user clicks the checkbox, <CODE>DoDrumRollCheckBox</CODE> uses <CODE>GetControlValue</CODE> to determine whether the user last selected the checkbox (that is, whether the control has a current setting of 1) or deselected it (in which case, the control has a current setting of 0). By subtracting the control's current setting from 1, <CODE>DoDrumRollCheckBox</CODE> toggles to a new setting <BR>and then uses <CODE>SetControlValue</CODE> to assign this new setting to the checkbox. The <CODE>SetControlValue</CODE> procedure changes the current setting of the checkbox and redraws it appropriately, by either drawing an X in the box if the new setting of the control is 1 or removing the X if the new setting of the control is 0.<A NAME=MARKER-9-573></A><A NAME=MARKER-2-136></A><P>
 <A NAME=MARKER-2-234></A><A HREF=Toolbox-309.html#MARKER-9-159>Listing 5-4</A> on <A HREF=Toolbox-309.html#MARKER-9-159>page 5-20</A> shows the control resources that specify a window's scroll bars, and <A HREF=Toolbox-309.html#MARKER-9-161>Listing 5-5</A> on <A HREF=Toolbox-309.html#MARKER-9-161>page 5-21</A> shows an application's <CODE>DoNew</CODE> routine for creating a document window with these scroll bars. This routine uses the <CODE>GetNewControl</CODE> function to create the scroll bars and then calls an application-defined routine, <CODE>MyAdjustScrollBars</CODE>. <A HREF=#MARKER-9-235>Listing 5-14</A> shows <CODE>MyAdjustScrollBars</CODE>, which in turn <BR>calls other application-defined routines that determine the proper sizes, locations, <BR>and maximum settings of the scroll bars.<P>
<B>Listing 5-14  <A NAME=MARKER-9-235></A>Adjusting scroll bar settings and locations </B><P>
<PRE>
PROCEDURE MyAdjustScrollBars (window: WindowPtr; 
                              resizeScrollBars: Boolean);
VAR
   myData: MyDocRecHnd;
BEGIN
   myData := MyDocRecHnd(GetWRefCon(window));
   HLock(Handle(myData));
   WITH myData^^ DO
   BEGIN
      HideControl(vScrollBar);   {hide the vertical scroll bar}
      HideControl(hScrollBar);   {hide the horizontal scroll bar}
      IF resizeScrollBars THEN   {move and size if needed}
         MyAdjustScrollSizes(window);
      MyAdjustScrollValues(window, NOT resizeScrollBars);
      ShowControl(vScrollBar);   {show the vertical scroll bar}
      ShowControl(hScrollBar);   {show the horizontal scroll bar}
   END;
   HUnLock(Handle(myData));
END; {of MyAdjustScrollbars}
</PRE>
 When calling the <CODE>DoOpen</CODE> routine to open an existing document in a window, <BR>SurfWriter also uses this <CODE>MyAdjustScrollBars</CODE> procedure to size and adjust the <BR>scroll bars. When the user changes the window's size, the SurfWriter application <BR>uses <CODE>MyAdjustScrollBars</CODE> again.<P>
 The <CODE>MyAdjustScrollBars</CODE> routine begins by getting a handle to the window's document record, which stores handles to the scroll bars as well as other relevant data about the document. (See the chapter "Window Manager" in this book for information about creating your application's own document record for a window.)<P>
 Before making any adjustments to the scroll bars, <CODE>MyAdjustScrollBars</CODE> passes the handles to these controls to the Control Manager procedure <CODE>HideControl</CODE>, which makes the controls invisible. The <CODE>MyAdjustScrollBars</CODE> routine then calls another application-defined procedure, <CODE>MyAdjustScrollSizes</CODE> (shown in <A HREF=Toolbox-313.html#MARKER-9-310>Listing 5-24 on page 5-61</A>), to move and resize the scroll bars appropriately. After calling yet another application-defined procedure, <CODE>MyAdjustScrollValues</CODE>, to set appropriate current and maximum settings for the scroll bars, <CODE>MyAdjustScrollBars</CODE> uses the Control Manager procedure <CODE>ShowControl</CODE> to display the scroll bars in their new locations.<A NAME=MARKER-2-132></A><P>
 <A HREF=#MARKER-9-237>Listing 5-15</A> shows how the <CODE>MyAdjustScrollValues</CODE> procedure calls another application-defined routine, <CODE>MyAdjustHV</CODE>, which uses Control Manager routines to assign appropriate settings to the scroll bars. <P>
<B>Listing 5-15  <A NAME=MARKER-9-237></A>Assigning settings to scroll bars</B><P>
<PRE>
PROCEDURE MyAdjustScrollValues (window: WindowPtr);
VAR
   myData: MyDocRecHnd;
BEGIN
   myData := MyDocRecHnd(GetWRefCon(window));
   HLock(Handle(myData));
   WITH myData^^ DO
   BEGIN
      MyAdjustHV(TRUE, vScrollBar, editRec);
      MyAdjustHV(FALSE, hScrollBar, editRec);
   END;
   HUnLock(Handle(myData));
END; {of MyAdjustScrollValues}
</PRE>
 To prevent the user from scrolling past the edge of the document and seeing a blank window, you should limit the scroll bars' maximum settings, as illustrated in <A HREF=Toolbox-303.html#MARKER-9-86>Figure 5-6 on page 5-9</A>. If the window is larger than the document (which can easily happen with small documents on large monitors), your application should make the maximum scroll bar settings identical to their minimum settings. In this case, the Control Manager then makes the scroll bars inactive, which is appropriate when all the information fits in <BR>the window.<P>
 <A HREF=#MARKER-9-238>Listing 5-16</A> shows the application-defined <CODE>MyAdjustHV</CODE> procedure, used for adjusting the current and maximum settings for a scroll bar. When passed <CODE>TRUE</CODE> in the <CODE>isVert</CODE> parameter, <CODE>MyAdjustHV</CODE> calculates and adjusts the maximum and current settings for the vertical scroll bar; when passed <CODE>FALSE</CODE>, it calculates and adjusts those settings for the horizontal scroll bar. <P>
 In this example, the document consists of monostyled text stored in a TextEdit edit record. The <CODE>viewRect</CODE> field of a TextEdit edit record specifies the rectangle where the text is visible; because <CODE>viewRect</CODE> already excludes the scroll bar regions, <CODE>MyAdjustHV</CODE> does not need to subtract the scroll bar regions from the window height or width when calculating the maximum settings for these scroll bars. (For more information about TextEdit in general and the edit record in particular, see <I>Inside Macintosh: Text.</I>)<P>
<B>Listing 5-16  <A NAME=MARKER-9-238></A>Adjusting the maximum and current settings for a scroll bar</B><P>
<PRE>
PROCEDURE MyAdjustHV (isVert: Boolean; control: ControlHandle; 
                      editRec: TEHandle);
VAR
   oldValue, oldMax, width:   Integer;
   max, lines, value:         Integer;
BEGIN
   {calculate new maximum and current settings for the vertical or }
   { horizontal scroll bar}
   oldMax := GetControlMaximum(control);
   oldValue := GetControlValue(control);
   MyGetDocWidth(width);
   IF isVert THEN    {adjust max setting for the vertical scroll bar}
   BEGIN
      lines := editRec^^.nLines;
      {since nLines isn't right if the last character is a carriage }
      { return, check for that case}
      IF Ptr(ORD(editRec^^.hText^) + editRec^^.teLength - 1)^ = kCRChar THEN
         lines := lines + 1;
      max := lines - ((editRec^^.viewRect.bottom - editRec^^.viewRect.top)
                      DIV editRec^^.lineHeight);
   END
   ELSE           {adjust max setting for the horizontal scroll bar}
      max := width - (editRec^^.viewRect.right - editRec^^.viewRect.left);
   IF max &lt; 0 THEN
      max := 0;   {check for negative settings}
   SetControlMaximum(control, max); {set the max value of the control}
   IF isVert THEN {adjust current setting for vertical scroll bar}
      value := (editRec^^.viewRect.top - editRec^^.destRect.top)
                DIV editRec^^.lineHeight
   ELSE           {adjust current setting for the horizontal scroll bar}
      value := editRec^^.viewRect.left - editRec^^.destRect.left;
   IF value &lt; 0 THEN
      value := 0
   ELSE IF value &gt; max THEN
      value := max;  {don't allow current setting to be greater than the }
                     { maximum setting}
   SetControlValue(control, value);
END; {of MyAdjustHV}
</PRE>
 The <CODE>MyAdjustHV</CODE> routine first uses the <CODE>GetControlMaximum</CODE> and <CODE>GetControlValue</CODE> functions to determine the maximum and current settings for the scroll bar <BR>being adjusted.<A NAME=MARKER-2-138></A><P>
 Then <CODE>MyAdjustHV</CODE> calculates a new maximum setting for the case of a vertical scroll bar. Because the window displays a text-only document, <CODE>MyAdjustHV</CODE> uses the <CODE>nLines</CODE> field of the edit record to determine the total number of lines in--and hence, the length of--the document. Then <CODE>MyAdjustHV</CODE> subtracts the calculated height of the window from the length of the document, and makes this value the maximum setting for the vertical scroll bar.<P>
 To calculate the total height in pixels of the window, <CODE>MyAdjustHV</CODE> begins by subtracting the top coordinate of the view rectangle from its bottom coordinate. (The upper-left corner of a window is normally at point [0,0]; therefore the vertical coordinate of a <BR>point at the bottom of a rectangle has a larger value than a point at the top of the rectangle.) Then <CODE>MyAdjustHV</CODE> divides the pixel height of the window by the value of <BR>the edit record's <CODE>lineHeight</CODE> field, which for monostyled text specifies the document's line height in pixels. By dividing the window height by the line height of the text, <CODE>MyAdjustHV</CODE> determines the window's height in terms of lines of text.<P>
 The <CODE>MyAdjustHV</CODE> routine uses another application-defined routine, <CODE>MyGetDocWidth</CODE>, <BR>to determine the width of the document. To calculate the width of the window, <CODE>MyAdjustHV</CODE> subtracts the left coordinate of the view rectangle from its right coordinate. By subtracting the window width from the document width, <CODE>MyAdjustHV</CODE> derives the maximum setting for the horizontal scroll bar.<P>
 For both vertical and horizontal scroll bars, <CODE>MyAdjustHV</CODE> assigns a maximum setting of 0 whenever the window is larger than the document--for instance, when a window is created for a new document that contains no data yet. In this case, <CODE>MyAdjustHV</CODE> assigns the same value, 0, to both the maximum and current settings for the scroll bar. The standard control definition function for scroll bars automatically makes a scroll bar inactive when its minimum and maximum settings are identical. This is entirely appropriate, because whenever the user has nowhere to scroll, the scroll bar should be inactive. When you make the maximum setting exceed the minimum, the control definition function makes the scroll bar active again.<A NAME=MARKER-2-4></A><P>
 The <CODE>MyAdjustHV</CODE> routine then uses the Control Manager procedure <CODE>SetControlMaximum</CODE> to assign the newly calculated maximum settings to either <BR>scroll bar. The <CODE>SetControlMaximum</CODE> procedure revises the control to reflect the new maximum setting; for example, if the user deletes a large portion of the document, thereby reducing the maximum setting, <CODE>SetControlMaximum</CODE> moves the scroll box <BR>to indicate the new position relative to the smaller document.<A NAME=MARKER-2-112></A><P>
 When the user adds information to or removes information from a document or adjusts its window size, your application may need to adjust the current setting of the scroll bar as well. The <CODE>MyAdjustHV</CODE> routine calculates a new current setting for the control and then uses <CODE>SetControlValue</CODE> to assign that setting to the control as well as to reposition the scroll box accordingly.<A NAME=MARKER-2-168></A><P>
 The destination rectangle, specified in the <CODE>destRect</CODE> field of the edit record, is the rectangle in which the text is drawn, whereas the view rectangle is the rectangle in which the text is actually visible. By subtracting the top coordinate of the destination rectangle from the top coordinate of the view rectangle, and dividing the result by the line height, <CODE>MyAdjustHV</CODE> derives the number of the line currently displayed at the top of the window. This is the line number <CODE>MyAdjustHV</CODE> uses for the current setting of the vertical scroll bar.<P>
 To derive the current setting of the horizontal scroll bar in terms of pixels, <CODE>MyAdjustHV</CODE> subtracts the left coordinate of the destination rectangle from the left coordinate of the view rectangle.<A NAME=MARKER-2-186></A><A NAME=MARKER-2-137></A><P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Toolbox-310.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Toolbox-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Toolbox-490.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Toolbox-312.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Toolbox-3.html">&copy; Apple Computer, Inc.</A><br>11 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
