<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-05-01 --><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1120: Opening Resource Files Twice Considered Hard?</title>      <meta name="keywords" content="Mac OS 8 FSpOpenResFile Opening resource files twice TopMapHndl">    <meta name="Description" content="Technical Note TN1120: This Technical Note describes theexact behavior of                                     FSpOpenResFilewhen the resource file is already open,                                    and describes some cookbook solutionsto avoid                                     problems inthis case."><meta name="categories" content="Human Interface Toolbox"><meta name="week-posted" content="Dec 29, 1997 - Jan 2, 1998"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002960" title="Opening Resource Files Twice Considered Hard?"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxCarbon-date.html">Carbon</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Carbon/idxHumanInterfaceToolbox-date.html" target="_blank">Carbon > Human Interface Toolbox</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1120</div>
<div id="pageheadsub">Opening Resource Files Twice Considered Hard?</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><center><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left">          <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                        <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left><!-- begin_toc --><p id="menutext"><A HREF = "#Section1">Describing the         Problem</A><BR><BR>                  <A HREF = "#Section2"><CODE>FSpOpenResFile</CODE>         Explain!</A><BR><BR>                  <A HREF = "#Section3">Cookbook         Solutions</A><BR><BR>                 <A HREF="#Summary">Summary</A><BR><BR><A HREF="#References">References</a><BR><BR><A HREF="#Downloads">Downloadables</A></p>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left>            			<!-- begin_intro_text --><p id="introtext">Most Mac OS         programmers do not consider <CODE>FSpOpenResFile</CODE> (or         it's older cousins <CODE>OpenResFile</CODE>,         <CODE>OpenRFPerm</CODE>, and <CODE>HOpenResFile</CODE>) to         be difficult to call. However, the behavior of these calls         when the resource file is already open has never been         documented properly.</P>         <p id="introtext">This Note describes the <A HREF = "#Section2">exact         behavior</A> of <CODE>FSpOpenResFile</CODE> when the         resource file is already open, and describes some         <A HREF = "#Section3">cookbook solutions</A> to avoid problems         in this case.</P>         <p id="introtext">All Mac OS programmers who use the         <a href="http://developer.apple.com/documentation/mac/MoreToolbox/MoreToolbox-9.html">Resource         Manager</A> should read the <A HREF = "#Summary">Summary</A>         section of this Note, just to familiarize themselves with         the problem. In addition, programmers who are writing         non-application code should carefully read the entire Note         to ensure maximum compatibility for their code.</P>               <!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Jan 30 1998]</h3><!-- end_date -->        </td>    </tr></table> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><A NAME="Section1"></A>         <H2>Describing the Problem</H2>                  <P><a href="http://developer.apple.com/documentation/mac/MoreToolbox/MoreToolbox-41.html"><I>Inside         Macintosh: More Macintosh Toolbox</I> (p1-60)</A> has the         following to say about the behavior of         <CODE>FSpOpenResFile</CODE> when the resource file is         already open:</P>                  <BLOCKQUOTE><P><A NAME="IMQuote"></A>If you attempt to use         <CODE>FSpOpenResFile</CODE> to open a resource fork that is         already open, <CODE>FSpOpenResFile</CODE> returns the         existing file reference number or a new one, depending on         the access permission for the existing access path. For         example, your application receives a new file reference         number after a successful request for read-only access to a         file previously opened with write access, whereas it         receives the same file reference number in response to a         second request for write access to the same file. In this         case, <CODE>FSpOpenResFile</CODE> doesn't make that file the         current resource file.</P></BLOCKQUOTE>                  <P>This statement is mostly true, but it certainly is not         the whole truth. The exact situation is a lot more complex.         </P>                  <H3>Complicating Factors</H3>                  <P>The complicating factors when opening a resource file         include:</P>                  <UL>            <LI>the exact call used to open the file, i.e.            <CODE>OpenResFile</CODE>, <CODE>OpenRFPerm</CODE>,            <CODE>HOpenResFile</CODE>, and            <CODE>FSpOpenResFile</CODE>,</li>                        <LI>the permissions supplied to the call,</li>                        <LI>whether the resource file is already open,</li>                        <LI>if the resource file is already open (whether by this process or by another)</li>                        <LI>if the resource file is already open by another            process (whether this process is on the local machine or            on another machine accessing the file via File Sharing)</li>                                    <LI>if the resource file is already open (the permissions            previously used to open the file).</li>         </UL>                  <P>These complicating factors combine to make opening a         resource file potentially much more complicated than it         seems on first examination.</P>                  <H3>Simplifying the Problem</H3>                  <P>Fortunately, not all of the above factors actually         complicate the problem. We can simplify the analysis by         noting the following:</P>                  <UL>            <LI><CODE>OpenResFile</CODE>, <CODE>OpenRFPerm</CODE>,            <CODE>HOpenResFile</CODE>, and            <CODE>FSpOpenResFile</CODE> all behave in the same way.            While you might think this is obvious, DTS engineers take            nothing for granted and I hope you feel reassured to know            that I actually tested this.</li>         </UL>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>                                    <CODE>OpenResFile</CODE> does not take a                  permission parameter. When you call                  <CODE>OpenResFile</CODE>, it acts as if you had                  supplied the permission <CODE>fsCurPerm</CODE>.</P></TD></TR></TABLE></CENTER><BR><BR>                  <UL>            <LI>There are only three <A NAME="outcomes"></A>outcomes            from calling <CODE>FSpOpenResFile</CODE>:                        <OL>               <LI><A NAME="CompleteSuccess"></A><STRONG>Complete               Success</STRONG> -- A new resource map is               created and added to the top of the resource chain.               The routine makes the new resource map the current               resource map and returns its resource file reference               number.</li>                              <LI><A NAME="PartialSuccess"></A><STRONG>Partial               Success</STRONG> -- The resource file reference number               of an existing resource map is returned. That existing               map will become the current resource map.</li>                              <LI><A NAME="Failure"></A><STRONG>Failure</STRONG> --               <CODE>FSpOpenResFile</CODE> returns -1 and the               resource chain remains unchanged. You can call               <CODE>ResError</CODE> to get the real error number.</li>            </OL></li>         </UL>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>                  In the Partial Success outcome above,                  <CODE>CurResFile</CODE> is changed, which directly                  contradicts the last sentence of the                  <A HREF = "#IMQuote">quote from <I>Inside Macintosh:                  More Macintosh Toolbox</I></A>. This Technote is                  correct and Inside Macintosh is in error.</P></TD></TR></TABLE></CENTER><BR><BR>                  <UL>            <LI>In all cases, asking for <CODE>fsWrPerm</CODE> and            asking for <CODE>fsRdWrPerm</CODE> have the same effect.</li>         </UL>                  <P>These points combine to make it much easier to describe         the exact situation. What remains is to describe the         behavior in each of the remaining cases.</p><BR><P><A HREF="#top">Back to top</A></P>         <P><A NAME="Section2"></A></P>                  <H2><CODE>FSpOpenResFile</CODE> Explained!         </H2>                  <P>The following table show the exact behavior of         <CODE>FSpOpenResFile</CODE> in the various interesting cases.</P>                  <TABLE BORDER=1>            <TR>               <td width=120 align=left>                  <P><B>Permissions Used<BR>                                    to Open First</B></p>               </TD><td width=120 align=left>                  <P><B>Permissions Used<BR>                                    to Open Second</B></p>               </TD><td width=70 align=left>                  <P><B><A NAME="ColumnA"></A>Same<BR>                                    Process</B></p>               </TD><td width=70 align=left>                  <P><B>Same<BR>                                    Machine</B></p>               </TD><td width=70 align=left>                  <P><B>Different<BR>                                    Machines</B></p>               </TD></TR>            <TR>               <td width=120 align=left>                  <P></p>               </TD><td width=120 align=left>                  <P></p>               </TD><td width=70 align=left>                  <P></p>               </TD><td width=70 align=left>                  <P></p>               </TD><td width=70 align=left>                  <P></p>               </TD></TR>            <TR>               <td width=120 align=left>                  <P><CODE>fsCurPerm</CODE></p>               </TD><td width=120 align=left>                  <P><CODE>fsCurPerm</CODE></p>               </TD><td width=70 align=left>                  <P><A HREF = "#CompleteSuccess">Success</A> R-O</p>               </TD><td width=70 align=left>                  <P><A HREF = "#CompleteSuccess">Success</A> R-O</p>               </TD><td width=70 align=left>                  <P><A HREF = "#Failure">Failure</A> -54</p>               </TD></TR>            <TR>               <td width=120 align=left>                  <P><CODE>fsCurPerm</CODE></p>               </TD><td width=120 align=left>                  <P><CODE>fsRdPerm</CODE></p>               </TD><td width=70 align=left>                  <P><A HREF = "#CompleteSuccess">Success</A> R-O</p>               </TD><td width=70 align=left>                  <P><A HREF = "#CompleteSuccess">Success</A> R-O</p>               </TD><td width=70 align=left>                  <P><A HREF = "#Failure">Failure</A> -54</p>               </TD></TR>            <TR>               <td width=120 align=left>                  <P><CODE>fsCurPerm</CODE></p>               </TD><td width=120 align=left>                  <P><CODE>fsWrPerm<BR>                                    fsRdWrPerm</CODE></p>               </TD><td width=70 align=left>                  <P><A HREF = "#PartialSuccess">Partial</A> R/W</p>               </TD><td width=70 align=left>                  <P><A HREF = "#Failure">Failure</A> -49</p>               </TD><td width=70 align=left>                  <P><A HREF = "#Failure">Failure</A> -54</p>               </TD></TR>            <TR>               <td width=120 align=left>                  <P></p>               </TD><td width=120 align=left>                  <P></p>               </TD><td width=70 align=left>                  <P></p>               </TD><td width=70 align=left>                  <P></p>               </TD><td width=70 align=left>                  <P></p>               </TD></TR>            <TR>               <td width=120 align=left>                  <P><CODE>fsRdPerm</CODE></p>               </TD><td width=120 align=left>                  <P><CODE>fsCurPerm</CODE></p>               </TD><td width=70 align=left>                  <P><A HREF = "#CompleteSuccess">Success</A> R-O</p>               </TD><td width=70 align=left>                  <P><A HREF = "#CompleteSuccess">Success</A> R-O</p>               </TD><td width=70 align=left>                  <P><A HREF = "#CompleteSuccess">Success</A> R-O</p>               </TD></TR>            <TR>               <td width=120 align=left>                  <P><CODE>fsRdPerm</CODE></p>               </TD><td width=120 align=left>                  <P><CODE>fsRdPerm</CODE></p>               </TD><td width=70 align=left>                  <P><A HREF = "#CompleteSuccess">Success</A> R-O</p>               </TD><td width=70 align=left>                  <P><A HREF = "#CompleteSuccess">Success</A> R-O</p>               </TD><td width=70 align=left>                  <P><A HREF = "#CompleteSuccess">Success</A> R-O</p>               </TD></TR>            <TR>               <td width=120 align=left>                  <P><CODE>fsRdPerm</CODE></p>               </TD><td width=120 align=left>                  <P><CODE>fsWrPerm<BR>                                    fsRdWrPerm</CODE></p>               </TD><td width=70 align=left>                  <P><A HREF = "#PartialSuccess">Partial</A> R-O</p>               </TD><td width=70 align=left>                  <P><A HREF = "#Failure">Failure</A> -49</p>               </TD><td width=70 align=left>                  <P><A HREF = "#CompleteSuccess">Success</A> R-O</p>               </TD></TR>            <TR>               <td width=120 align=left>                  <P></p>               </TD><td width=120 align=left>                  <P></p>               </TD><td width=70 align=left>                  <P></p>               </TD><td width=70 align=left>                  <P></p>               </TD><td width=70 align=left>                  <P></p>               </TD></TR>            <TR>               <td width=120 align=left>                  <P><CODE>fsWrPerm<BR>                                    fsRdWrPerm</CODE></p>               </TD><td width=120 align=left>                  <P><CODE>fsCurPerm</CODE></p>               </TD><td width=70 align=left>                  <P><A HREF = "#CompleteSuccess">Success</A> R-O</p>               </TD><td width=70 align=left>                  <P><A HREF = "#CompleteSuccess">Success</A> R-O</p>               </TD><td width=70 align=left>                  <P><A HREF = "#Failure">Failure</A> -54</p>               </TD></TR>            <TR>               <td width=120 align=left>                  <P><CODE>fsWrPerm<BR>                                    fsRdWrPerm</CODE></p>               </TD><td width=120 align=left>                  <P><CODE>fsRdPerm</CODE></p>               </TD><td width=70 align=left>                  <P><A HREF = "#CompleteSuccess">Success</A> R-O</p>               </TD><td width=70 align=left>                  <P><A HREF = "#CompleteSuccess">Success</A> R-O</p>               </TD><td width=70 align=left>                  <P><A HREF = "#Failure">Failure</A> -54</p>               </TD></TR>            <TR>               <td width=120 align=left>                  <P><CODE>fsWrPerm<BR>                                    fsRdWrPerm</CODE></p>               </TD><td width=120 align=left>                  <P><CODE>fsWrPerm<BR>                                    fsRdWrPerm</CODE></p>               </TD><td width=70 align=left>                  <P><A HREF = "#PartialSuccess">Partial</A> R/W</p>               </TD><td width=70 align=left>                  <P><A HREF = "#Failure">Failure</A> -49</p>               </TD><td width=70 align=left>                  <P><A HREF = "#Failure">Failure</A> -54</p>               </TD></TR>         </TABLE>                  <P>The first column gives the permission value used the         first time the file was opened. The second column gives the         permission value for this call to         <CODE>FSpOpenResFile</CODE>.</P>                  <P>The remaining three columns describe the behavior in         each of the three important cases:</P>                  <UL>            <LI><B>Same Process</B> -- The file has already been            opened by the same process.</li>                        <LI><B>Same Machine</B> -- The file has already been            opened by another process on the same machine.</li>                        <LI><B>Different Machines</B> -- The file has already            been opened by another process on another machine            connected via File Sharing.</li>         </UL>                  <P>Each cell is labelled with a pair of items. The first         item is the outcome of the call, <A HREF = "#outcomes">as         defined above</A>. The second item is either the permissions         associated with the returned resource file reference number         (for outcomes <A HREF = "#CompleteSuccess">Success</A> and         <A HREF = "#PartialSuccess">Partial</A> ) or the error code         returned (for outcome <A HREF = "#Failure">Failure</A> ).</P>                  <H3>Gotchas and Observations         </H3>                  <P>There are a number of important observations to be made         about the above table:</P>                  <UL>            <LI>Asking for write permissions to a file if it has            already been opened by your process will yield            <A HREF = "#PartialSuccess">Partial Success</A>, i.e.            <CODE>FSpOpenResFile</CODE> will return the resource file            reference number of an existing resource map. If you're            not prepared for this (and you close the resource map            after using it, say), you will find yourself in a world            of pain. For example, it's common for developers to            accidentally close the resource map of their own            application, or the system resource map.</li>                        <LI>It is possible to get lesser permissions than you            asked for. For example, in <A HREF = "#ColumnA">Same            Process</A> column in the table, if the file is already            open with <CODE>fsRdPerm</CODE> and you open it with            <CODE>fsRdWrPerm</CODE>, the resource file reference            number returned has read-only permissions. You can check            for this situation using the            <A HREF = "#CheckPermissions">code shown below</A>.</li>                        <LI>Asking for <CODE>fsRdWrPerm</CODE> permissions to a            file which has already been opened with            <CODE>fsRdPerm</CODE> by another machine will succeed            (!), but will give you a read-only resource file            reference number.</li>                        <LI>The exact error code you get back when a resource            file is already opened by another process depends on            whether that process is running on the local machine or            not.</li>         </UL>                  <H3><A NAME="OneFinalGotcha"></A>One         Final Gotcha</H3>                  <P>The last problem with opening the same resource file         twice is intrinsic to the design of the Resource Manager and         very hard to guard against. When you open a resource file,         the Resource Manager loads a catalog of all the resources         (the <STRONG>resource map</STRONG>) into your heap, and uses         that map to locate the data for each resource resides in the         resource file.</P>                  <P>When changing the resource map, the Resource Manager does         not coordinate between the various processes that might         have the resource file open. While the Resource Manager         prevents you from opening two read/write resource file         reference numbers to the same resource file, it does not         stop you from having a read-only and a read/write resource file         reference number simultaneously.</P>                  <P>This can cause serious problems in the following         situation:</P>                  <OL>            <LI>Process A opens the resource file read/write. The            Resource Manager reads the resource map for the file into            Process's A's heap.</li>                        <LI>Process B opens the resource read-only. The Resource            Manager reads the resource map for the file into            Process's B's heap.</li>                        <LI>Process A then changes the resource file and calls            <CODE>UpdateResFile</CODE> to write those changes back to            the disk. This can cause the position of various            resources in the resource file to change quite            dramatically.</li>                        <LI>Process B then calls the Resource Manager to read a            resource from the resource file. Because Process B's copy            of the resource map no longer matches the actual file,            the Resource Manager returns bogus resource data.</li>         </OL>                  <P>The restriction is described quite well in the Special         Considerations section of the description of         <a href="http://developer.apple.com/documentation/mac/MoreToolbox/MoreToolbox-41.html">FSpOpenResFile         in <I>Inside Macintosh: More Macintosh Toolbox</I></A>, but that         description is worth reiterating while we're on the subject         of opening resource files twice.</p><BR><P><A HREF="#top">Back to top</A></P>         <P><A NAME="Section3"></A></P>                  <H2>Cookbook Solutions</H2>                  <P>This section describes some useful techniques you can         employ to ensure that the weirdnesses of         <CODE>FSpOpenResFile</CODE> does not bite your software. These         are listed with the most recommended (and easiest to         implement) first.</P>                  <H3>Open Resource Files Once         </H3>                  <P>If you're writing normal application-level code, it's         easy to remember whether your process has already opened a         resource file and avoid opening it twice. The following snippet         shows a simple example of this.</P>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>static SInt16 gResourceResFile = 0;static UInt32 gResourceUsageCount = 0;&nbsp;static OSErr StartUsingResources(ConstFSSpecPtr fss){    OSErr  err;    SInt16 tmpResFile;&nbsp;    err = noErr;    if (gResourceUsageCount == 0) {        tmpResFile = FSpOpenResFile(fss, fsRdWrPerm);        err = ResError();        if (err == noErr) {            gResourceResFile = tmpResFile;        }    }    if (err == noErr) {        gResourceUsageCount += 1;    }&nbsp;    return err;}&nbsp;static void StopUsingResources(void){    gResourceUsageCount -= 1;    if (gResourceUsageCount == 0) {        CloseResFile(gResourceResFile);        gResourceResFile = 0;    }}</pre></TD></TR></TABLE></CENTER><BR><BR>                  <P>Extending this technique for more than one resource file is         left as an exercise to the developer.</P>                  <H3>Open Resource Files Read         Only</H3>                  <P>In situations where you don't know whether a resource         file has already been opened by the current process (in         system extension code, for example), the easiest solution is         to always open the resource file read-only, i.e. using         <CODE>fsRdPerm</CODE>. If you do this, you will always get a         new resource reference number that you can safely close.         </P>                  <P>A further refinement of this solution is to open, read,         and close the resource file quickly, without yielding time         to other processes in between. This helps prevent another         process from modifying the file while you're reading it, and         minimizes your vulnerability to the         <A HREF = "#OneFinalGotcha">trickiest gotcha described         above</A>. This refinement is only useful in certain         situations, but is definitely one to keep in your         'cookbook'.</P>                  <H3>Check <CODE>TopMapHndl</CODE></H3>                  <P>In situations where you don't know whether a resource         file has already been opened by the current process and you         must open the resource file read/write, the best technique         is to monitor the <CODE>TopMapHndl</CODE> low memory global         to see if it changes around your call to         <CODE>FSpOpenResFile</CODE>. If this global changes, a new         resource map has been added to the top of the resource         chain, and you are responsible for closing it. If the global         does not change, an existing resource map reference number         was returned and you should not close it.</P>                  <P>The following snippet illustrates this technique.</P>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>static void SafeOpenResFileReadWrite(ConstFSSpecPtr fss){    OSErr   err;    SInt16  oldResFile;    Handle  oldTopMap;    SInt16  resFile;    Boolean shouldClose;&nbsp;    oldResFile = CurResFile();&nbsp;    oldTopMap = LMGetTopMapHndl();    resFile = FSpOpenResFile(fss, fsRdWrPerm);    err = ResError();&nbsp;    if (err == noErr) {        shouldClose = (LMGetTopMapHndl() != oldTopMap);&nbsp;        // do the stuff with the resource file&nbsp;        if (shouldClose) {            CloseResFile(resFile);        }    }&nbsp;    UseResFile(oldResFile);}</pre></TD></TR></TABLE></CENTER><BR><BR>                  <P>It's important to remember that this technique is only         necessary if you need to open the file read/write and you         don't know whether the file is already open by the current         process. As such, this technique is needed most by         non-application code -- such as system extensions, shared         libraries, application plug-ins, etc -- but it may also be         useful for application code is running in strange environments,         such as a Standard File filter function.</P>                  <H3>Always Preserve <CODE>CurResFile</CODE>         </H3>                  <P>Regardless of which of above techniques you use, it's         always a good idea to bracket your calls to         <CODE>FSpOpenResFile</CODE> with calls to         <CODE>CurResFile</CODE> and <CODE>UseResFile</CODE> to         ensure that your code does not accidentally change the         current resource map. The above snippets also illustrates         this technique.</P>                  <H3><A NAME="CheckPermissions"></A>Check         Permissions</H3>                  <P>If you need to write to a resource file and you are not         sure whether that file has already been opened, it pays to         examine the resource file reference number to ensure that it         supports read/write access. While having a read/write         resource file reference number is not a guarantee that         writing to the file will succeed, it's a good idea to check         this as the first step.</P>                  <P>You can check whether a resource file reference number is         read/write by calling the File Manager routine         <CODE>PBGetFCBInfoSync</CODE> and looking at bit 8 of         <CODE>ioFCBFlags</CODE>. The following snippet demonstrates         this technique.</P>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>static Boolean IsResourceFileRefNumWritable(SInt16 rsrcRefNum){    Boolean result;    FCBPBRec fcbPB;    fcbPB.ioNamePtr = nil;    fcbPB.ioVRefNum = 0;    fcbPB.ioRefNum = rsrcRefNum;    fcbPB.ioFCBIndx = 0;    if ( PBGetFCBInfoSync(&amp;fcbPB) == noErr ) {        result = ((fcbPB.ioFCBFlags &amp; (1 &lt;&lt; 8)) != 0);    } else {        result = false;    }    return result;}</pre></TD></TR></TABLE></CENTER><BR><BR><BR><P><A HREF="#top">Back to top</A></P>         <P><A NAME="Summary"></A></P>                  <H2>Summary</H2>                  <P>If you open the same resource file twice, you are         vulnerable to a number of strange behaviors of the Resource         Manager, including:</P>                  <UL>            <LI><CODE>FSpOpenResFile</CODE> returning an existing            resource file reference number rather than opening a new            resource file reference number.</li>                        <LI><CODE>FSpOpenResFile</CODE> returning a read-only            resource file reference number, even though you            explicitly asked for read/write access.</li>                        <LI>Possible corrupt resource data if you read a resource            file through a read-only resource file reference number            while simultaneously modifying it through another            read/write resource file reference number.</li>         </UL>                  <P>The best way to guard against these problems is to avoid         opening a resource file twice. If this is unavoidable, this         Note suggests a <A HREF = "#Section3">number of approaches</A>         you can use to minimize your vulnerability.</p><BR><P><A HREF="#top">Back to top</A></P><A NAME="References" TARGET="_top"></A><H2>References</H2><P><a href="http://developer.apple.com/documentation/mac/MoreToolbox/MoreToolbox-2.html"><I>Inside            Macintosh: More Macintosh Toolbox</I></A>, Chapter 1            <a href="http://developer.apple.com/documentation/mac/MoreToolbox/MoreToolbox-9.html">Resource            Manager</A></p>                        <p><A HREF = "../fl/fl_37.html">DTS            Technote FL 37 You Want Permission to do What?!!</A></p><BR><P><A HREF="#top">Back to top</A></P>        <A NAME="Downloads"></A>         <br><h2>Downloadables</h2>        <center><TABLE BORDER=0 CELLPADDING=3 WIDTH="600">          <TR>             <td width=50 align=left>               <P ALIGN=center><img src="images/acrobatsmall.gif" align=middle alt="Acrobat" width=22 height=23></P>            </TD>            <td align="left">               <p>Acrobat version of this Note (72K).</P>            </TD>            <td width=60 align=left>               <p><A HREF="pdf/tn1120.pdf">Download</A></P>            </TD>          </TR>        </TABLE></center><BR><BR>        </td></tr></table></center><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1120.html%3Fid%3DDTS10002960-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1120.html%3Fid%3DDTS10002960-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1120.html%3Fid%3DDTS10002960-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>