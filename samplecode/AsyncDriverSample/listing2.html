<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>AsyncDriverSample - /AsyncDriverMain.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; <A HREF="javascript:location.replace('index.html');">AsyncDriverSample</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/index.html" target="_blank">Reference Library > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">AsyncDriverSample</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/AsyncDriverMain.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/AsyncDriverCommon.p</option>
<option value="listing2.html">/AsyncDriverMain.c</option>
<option value="listing3.html">/AsyncDriverSample.p</option>
<option value="listing4.html">/DiskImageCore.p</option>
<option value="listing5.html">/DropMounter/DropMounter.p</option>
<option value="listing6.html">/TradDriverLoaderLib/TradDriverLoaderLib.c</option>
<option value="listing7.html">/TradDriverLoaderLib/TradDriverLoaderLib.h</option>
<option value="listing8.html">/TradDriverLoaderLib/TradDriverLoaderLib.p</option></select>
				</p>
				</form>
				<p><strong><a href="AsyncDriverSample.zip">Download Sample</a></strong> (&#147;AsyncDriverSample.zip&#148;, 43.2K)<BR>
<strong><a href="AsyncDriverSample.dmg">Download Sample</a></strong> (&#147;AsyncDriverSample.dmg&#148;, 102.6K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*  File:    AsyncDriverMain.c  Contains:  Driver glue modified for use with CodeWarrior custom header.  Written by:  Quinn &quot;The Eskimo!&quot;  Copyright:  &copy; 1996 by Apple Computer, Inc., all rights reserved.  Change History (most recent first):  You may incorporate this sample code into your applications without  restriction, though the sample code has been provided &quot;AS IS&quot; and the  responsibility for its operation is 100% yours.  However, what you are  not permitted to do is to redistribute the source as &quot;DSC Sample Code&quot;  after having made changes. If you're going to re-distribute the source,  we require that you make it clear in the source that the code was  descended from Apple Sample Code, but that you've made changes.  Change History (most recent first):     &lt;5&gt;  970307  Quinn    Tidied up CodeWarrior driver header,                   as per Chad Magendanz's suggestions.     &lt;4&gt;  970206  Quinn    Ported to CodeWarrior, which required                  syntactic changes everywhere and some                  changes to how the entry point offsets                  are calculated.  Also added A4 save, setup                  and restore.     &lt;3&gt;  941027  BL&iexcl;B    Incomplete async routines should return noErr .     &lt;2&gt;  960803  BL&iexcl;B    Moved to Universal Headers (post ETO 18).     &lt;1&gt;   10/94  BL&iexcl;B    Corrected asynch not-complete return case                  to put 0 in D0.     &lt;0&gt;   10/93  gs and JML  Clean up for Sample Code release.*/#include &lt;A4Stuff.h&gt;#include &lt;Devices.h&gt;#include &lt;DriverGestalt.h&gt;/* This file is necessary because the standard Metrowerks driver header  has a number of problems:      o  It assumes that the driver entry point is using C calling    conventions.  As you can't declare C calling convention routines    in Pascal, I'm stuck with doing some sort of C glue.  Given    the other problems, I thought might as well do the whole enchilada.      o It does not handle _KillIO processing.    o It doesn't set ioResult for immediate calls.       This code is based on the &quot;Driver.a&quot; used for the long standing    DTS RAMDisk sample, modified for operation in the CodeWarrior    environment.*/// External declarations for the Pascal routines.extern pascal OSErr DRVROpen(ParmBlkPtr paramBlock, DCtlPtr devCtlEnt);extern pascal OSErr DRVRPrime(ParmBlkPtr paramBlock, DCtlPtr devCtlEnt);extern pascal OSErr DRVRControl(ParmBlkPtr paramBlock, DCtlPtr devCtlEnt);extern pascal OSErr DRVRStatus(ParmBlkPtr paramBlock, DCtlPtr devCtlEnt);extern pascal OSErr DRVRClose(ParmBlkPtr paramBlock, DCtlPtr devCtlEnt);// The Universal headers no longer define simple constants for low-memory//  globals, so we have to define our own.enum {  JIODone = 0x8FC};// Constants for VMImmune bit in dCtlFlags.enum {  dVMImmuneBit = 0,  dVMImmuneMask = 0x0001};    /*  If dVMImmuneBit is set to true the VM system does not hold down  parameter blocks (or the data that read/write parameter blocks point to)  passed to this driver.*//*  Driver Header  The code is based on &quot;Driver.a&quot; from the RAMDisk sample.  Unfortunately I had to make a number of changes.  Some of them are purely  syntactic, using 0x instead of $ for example, but others are more substantial.  CodeWarrior's assembler doesn't let you go &quot;dc.b Label1 - Label2&quot;, so  the entry points in the driver header are now calculated using the label  and a static offset.  My second change was to save, setup and restore A4 in the code.*/asm void __Startup__(void);asm void __Startup__(void){DHeader:DFlags:      dc.w  dReadEnableMask    \            + dWritEnableMask  \            + dCtlEnableMask  \            + dStatEnableMask  \            + dNeedLockMask    \            + dVMImmuneMask    \            + kmDriverGestaltEnableMask  // &lt;5&gt; Driver flagsDDelay:      dc.w  0              // noneDEMask:      dc.w  0              // DA event maskDMenu:      dc.w  0              // no menu        dc.w  DOpen + 8           // &lt;4&gt; &lt;5&gt; offset to Open        dc.w  DPrime + 10           // &lt;4&gt; &lt;5&gt; offset to Prime        dc.w  DControl + 12         // &lt;4&gt; &lt;5&gt; offset to Control        dc.w  DStatus + 14         // &lt;4&gt; &lt;5&gt; offset to Status        dc.w  DClose + 16           // &lt;4&gt; &lt;5&gt; offset to CloseName:      dc.b  &quot;\p.AsyncDriverSample&quot;    // &lt;4&gt; &lt;5&gt; name of driver        DOpen:      pea    DRVROpen        bra.s  DRVRDispatch                DPrime:      pea    DRVRPrime        bra.s  DRVRDispatch                DControl:    pea    DRVRControl        bra.s  DRVRDispatchDStatus:    pea    DRVRStatus        bra.s  DRVRDispatchDClose:      pea    DRVRClose          // and fall thru to DRVRDispatchDRVRDispatch:        movem.l a0/a1/a4, -(sp)        // &lt;4&gt; save registers (for IODone)                    // Push parameters for driver routines with Pascal calling conventions.        clr.w  -(sp)            // save room for result        move.l  a0, -(sp)          // push paramblock ptr on stack        move.l  a1, -(sp)          // push dce ptr on stack    // Now setup A4 -- have to do this after above because it messes up a0.            jsr    SetCurrentA4        // &lt;4&gt; establish CodeWarrior globals        // Now call the driver routine.        movea.l 0x16(sp), a0        // load address of driver routine into a0        jsr    (a0)            // go to it!                        move.w  (sp)+, d0          // put result into d0                        movem.l (sp)+, a0/a1/a4        // &lt;4&gt; restore registers (for IODone)        addq.l  #4, a7            // clear driver routine address off stack// Check for special case exits (Open, Close, KillIO, Immediate, incomplete Async)// Open, Close and KillIO always RTS to the Device Manager with the driver result// in         move.w  struct(IOParam.ioTrap)(a0), d1  // copy low byte of trap word to d1    // _Open check        tst.b    d1            // _Open == A000        beq.s    Done          // rts if _Open    // _Close check        cmpi.b  #1, d1            // _Close == A001        beq.s    Done          // rts if _Close    // _KillIO check        cmpi.b  #6, d1            // _KillIO == A006        beq.s    Done          // rts if _KillIO    // It must be _Read, _Write, _Control, or _Status        // Immediate check        btst    #noQueueBit, d1      // test immediate bit        beq.s    NotImmediate      // branch if not immediateImmediate:        move.w  d0, struct(IOParam.ioResult)(a0)                          // The Device Manager doesn't set ioResult,                          // so we do just in case the caller checks                          // ioResult instead of the function result.        bra.s    Done          // rts if immediate                NotImmediate:// &lt;3&gt; BL&iexcl;B// If the call is asynchronous and not complete, it should return noErr (0)// in D0 instead of 1 -- otherwise, the Device Manager sees the 1 and// returns 1 as an error to the caller. If the File Manager is the caller,// it converts the 1 to ioErr and returns it to the program that called// it.   See develop issue 13 page 10.//    // Incomplete Async check        cmp.w    #1, d0          // We're using the convention that if the                          // driver result = 1 then the device driver                          // hasn't completed the non-immediate                          // operation.        bne.s    Complete        moveq    #0, d0          // clear D0 and...        bra.s    Done          // rts if the operation is incompleteComplete:    move.l  JIODone, -(sp)        // push jIODone onto stackDone:      rts}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/AsyncDriverSample/listing2.html%3Fid%3DDTS10000438-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/AsyncDriverSample/listing2.html%3Fid%3DDTS10000438-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/AsyncDriverSample/listing2.html%3Fid%3DDTS10000438-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>