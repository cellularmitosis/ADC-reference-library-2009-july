<HTML><HEAD>   <title>Technical Q&amp;A QA1078: Getting the User and Computer Name</title><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><meta name="keywords" content="user name, computer name, machine name, CSCopyMachineName,CSCopyUserName"><meta name="Description" content="Technical Q&amp;A QA1078: Describes how to get the user name(of the currently logged in user) and the computer name onMac OS X."><meta name="categories" content="Overview and Operating System Utilities"><meta name="week-posted" content="Oct 29, 2001 - Nov 2, 2001"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10001630" title="Getting the User and Computer Name"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/Carbon/index.html">Carbon</a> &gt; <a href="../../technicalqas/Carbon/idxNetworking-date.html">Networking</a> &gt; </p><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A QA1078</div>
<div id="pageheadsub">Getting the User and Computer Name</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600>   <TR>      <td align="left">         <!-- begin_content -->                  <hr width=500 align=center>                           <P id=p2>Q: On traditional Mac OS my application use the         resources <CODE>'STR '</CODE> ID=-16096 and ID=-16413 to         access the user name and the computer name. This doesn't         work on Mac OS X. What should I do?</P>                  <P id=p4>A: The simple answer is that Carbon provides two         high-level routines in "OSUtils.h",         <CODE>CSCopyUserName</CODE> and         <CODE>CSCopyMachineName</CODE>, that do what you want.         However, things are never <I>that</I> easy. You have to be         aware of the following issues.</P>                  <UL id=p4>            <LI>The routines are available in all versions of Mac OS            X.</LI>                        <LI>The routines are available in CarbonLib 1.5 and            higher. At the time of publication this version of            CarbonLib is not publically available. If you're running            against an older version of CarbonLib you must continue            to access this information via the Resource Manager.</LI>                        <LI>Mac OS X 10.0 and 10.0.1 had a bug (r. 2665708)            that caused a crash the second time you call these            routines.</LI>                        <LI>In Mac OS X 10.0.x the <CODE>CSCopyMachineName</CODE>            routine returned the BSD hostname rather than the            computer name as set in the Sharing panel of System            Preferences (r. 2650897).</LI>                        <LI>These routines are not directly accessible to CFM            programs in Mac OS X 10.0.x.</LI>                        <LI>The routines are not in CarbonFrameworkLib in            Universal Interfaces 3.4 (r. 2782236).</LI>         </UL>                  <P id=p4>The code in Listing 1 works around all of these         problems. You can download a copy of this code, complete         with test program, using the link at the bottom of this         Technical Q&amp;A.</P>                  <P>Finally, these APIs are part of Carbon. If you're working         at a lower level (for example, your program is a daemon         process that remains running across login/logout), you         should use the equivalent low-level APIs provided by System         Configuration framework (a new framework introduced in Mac         OS X 10.1). The routines you want are         <CODE>SCDynamicStoreCopyConsoleUser</CODE> and         <CODE>SCDynamicStoreCopyComputerName</CODE>. System         Configuration framework also provides a way for you to be         notified when these values change.</P>                  <CENTER><TABLE BORDER=0 CELLPADDING=4 WIDTH=550>            <TR>               <td bgcolor="#E6E6E6" align=left>                  <pre>static UInt32 gMoreCSSystemVersion = 0;enum {    kMoreCSMacOSX10point0 = 0x01000,    kMoreCSMacOSX10point1 = 0x01010};static CFStringRef CreateCFStringFromStringResource(SInt16 rsrcID)    // This routine is called on Mac OS 9 to create a CFString    // from the system 'STR ' resource with ID of rsrcID.{    CFStringRef result;    SInt8       s;    Handle      stringH;    result = nil;    stringH = GetResource('STR ', rsrcID);    if (stringH != nil) {        s = HGetState(stringH);        HLock(stringH);        // CFStringGetSystemEncoding returns the CFStringEncoding of the        // system as a whole.  We want the system text encoding because        // the user/machine name is set by the File Sharing control panel        // and the File Sharing control panel is localised in the system script.        //        // This only applies because we're reading a resource from the        // System file.  If we were reading it from an application resource        // we would have used GetApplicationTextEncoding (from &quot;Processes.h&quot;)        // instead.        result = CFStringCreateWithPascalString(kCFAllocatorSystemDefault,                                                (StringPtr) *stringH,                                                CFStringGetSystemEncoding() );        HSetState(stringH, s);    }    return result;}static CFStringRef ReadMachineNameFromFile(void)    // This routine is called when the client tries to get the    // machine name on Mac OS X 10.0.x.  Because CSCopyMachineName returns    // un-useful information on those systems, w reads the name    // directly from the System Configuration preferences file.{    CFStringRef     result;    CFURLRef        url;    CFDataRef       data;    CFDictionaryRef dict;    CFDictionaryRef systemDict;    CFDictionaryRef system2Dict;    assert( gMoreCSSystemVersion &gt;= kMoreCSMacOSX10point0 );    assert( gMoreCSSystemVersion &lt;  kMoreCSMacOSX10point1 );    // *** IMPORTANT ***    //    // The location and format of the System Configuration framework    // preferences file in the code below is subject to change    // at any time.  Do not write any code which makes any assumptions    // on this file since your app WILL BREAK at some point in time.    // The only reason we can do this safely in this code is because    // we know we're running on Mac OS 10.0 through 10.0.4.  This is    // enforced by the asserts above.  For Mac OS X 10.1 and above you    // must use the public System Configuration framework APIs (or    // APIs, like CSCopyMachineName, which are layered on top of    // System Configuration framework).    result = nil;    url = CFURLCreateWithFileSystemPath(kCFAllocatorDefault,                     CFSTR(&quot;/var/db/SystemConfiguration/preferences.xml&quot;),                     kCFURLPOSIXPathStyle,                     false );    if (url != nil) {        if ( CFURLCreateDataAndPropertiesFromResource(kCFAllocatorDefault,                                        url, &amp;data, nil, nil, nil ) ) {            dict = CFPropertyListCreateFromXMLData(kCFAllocatorSystemDefault,                                        data, kCFPropertyListImmutable, nil);            if (dict != nil) {                systemDict = CFDictionaryGetValue(dict, CFSTR(&quot;System&quot;) );                if (systemDict != nil) {                    system2Dict = CFDictionaryGetValue(systemDict,                                                       CFSTR(&quot;System&quot;) );                    if ( system2Dict != nil ) {                        result = CFDictionaryGetValue(system2Dict,                                                       CFSTR(&quot;ComputerName&quot;) );                        if (result != nil) {                            // Increment the string's reference count so that                            // releasing &quot;dict&quot; doesn't release the name.                            CFRetain(result);                        }                        // Don't need to release system2Dict because it was &quot;got&quot;.                    }                    // Don't need to release systemDict because it was &quot;got&quot;.                }                CFRelease(dict);            }            CFRelease( data );        }        CFRelease( url );    }    return result;}extern pascal CFStringRef MoreCSCopyUserName(Boolean useShortName)    // See comment in header file.{    CFStringRef result;    if ( gMoreCSSystemVersion == 0 ) {        (void) Gestalt(gestaltSystemVersion, (SInt32 *) &amp;gMoreCSSystemVersion);    }    if ( gMoreCSSystemVersion &lt; kMoreCSMacOSX10point0 ) {        // Running on traditional Mac OS.  If we have a recent version        // of CarbonLib (1.5 and above) that supports the routine, use        // that.  Otherwise fall back to the Resource Manager.        if ( CSCopyUserName != (void *) kUnresolvedCFragSymbolAddress) {            result = CSCopyUserName(useShortName);        } else {            result = CreateCFStringFromStringResource(-16096);        }    } else {        // Call the API.  However, if we're built CFM we can't just        // call it directly because the routine isn't exported to        // CFM on Mac OS 10.0.x.  So for CFM builds we have to call        // through CFBundle.        #if TARGET_RT_MAC_CFM            {                typedef CFStringRef (*CSCopyUserNameProc)(Boolean useShortName);                CSCopyUserNameProc  csCopyUserName;                CFBundleRef         bundle;                result = nil;                csCopyUserName = nil;                bundle = CFBundleGetBundleWithIdentifier(                                                 CFSTR(&quot;com.apple.Carbon&quot; ) );                if (bundle != nil) {                    csCopyUserName =                       (CSCopyUserNameProc) CFBundleGetFunctionPointerForName(                                              bundle, CFSTR(&quot;CSCopyUserName&quot;) );                }                if (csCopyUserName != nil) {                    result = csCopyUserName(useShortName);                }                // Both bundle and csCopyUserName got with &quot;Get&quot;, so                // no need to release.            }        #elif TARGET_RT_MAC_MACHO            result = CSCopyUserName(useShortName);        #else            #error MoreCSCopyUserName: What runtime are you using?        #endif        // Mac OS 10.0 and 10.0.1 (which have the same gestaltSystemVersion        // result -- this just gets better and better) have a bug [2665708]        // where they fail to retain the user name and host name strings        // each time they return it to the client.  The upshot is that        // the client crashes the second time it calls CSCopyUserName or        // CSCopyMachineName.  This extra CFRetain prevents this from happening.        //        // Note that we don't need a similar workaround in MoreCSCopyMachineName        // because we never call the CSCopyMachineName on 10.0 or 10.0.1        // because of another issue.        if (result != nil &amp;&amp; gMoreCSSystemVersion == kMoreCSMacOSX10point0) {            CFRetain(result);        }    }    return result;}extern pascal CFStringRef MoreCSCopyMachineName(void)    // See comment in header file.{    CFStringRef result;    if ( gMoreCSSystemVersion == 0 ) {        (void) Gestalt(gestaltSystemVersion, (SInt32 *) &amp;gMoreCSSystemVersion);    }    if ( gMoreCSSystemVersion &lt; kMoreCSMacOSX10point0 ) {        // Running on traditional Mac OS.  If we have a recent version        // of CarbonLib (1.5 and above) that supports the routine, use        // that.  Otherwise fall back to the Resource Manager.        if ( CSCopyMachineName != (void *) kUnresolvedCFragSymbolAddress) {            result = CSCopyMachineName();        } else {            result = CreateCFStringFromStringResource(-16413);        }    } else if ( gMoreCSSystemVersion &lt; kMoreCSMacOSX10point1 ) {        // Running on Mac OS X 10.0.x.  Read the file directly because        // the API returns the wrong information (the BSD hostname rather        // than the computer name) [2650897].        result = ReadMachineNameFromFile();    } else {        // Running on Mac OS X 10.1 and above.  Let's just call the API.        // The following checks that the CFM weak link worked.        // It's benign for the Mach-O build.        if ( CSCopyMachineName == (void *) kUnresolvedCFragSymbolAddress ) {            result = nil;        } else {            result = CSCopyMachineName();        }    }    return result;</pre>               </TD>            </TR>            <TR>               <td align="left">                  <P><B>Listing 1</B>. Code for getting user and                  machine name</P>               </TD>            </TR>         </TABLE>         </CENTER>                                    <BR>         <BR>                 <hr width=500 align=center>                            <P><B>Downloadables</B></P>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td align="left">                  <P>qa1078.hqx (108K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="downloads/qa1078.hqx">Download</A></P>               </TD>            </TR>         </TABLE>         <BR><BR>                                                                   <BR>         <BR>                  <hr width=500 align=center>                                                                                          <!-- begin_date --><H4><CENTER>[Oct 30 2001]</CENTER></H4><!-- end_date -->      </TD>   </TR></TABLE></CENTER><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/qa2001/qa1078.html%3Fid%3DDTS10001630-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/qa2001/qa1078.html%3Fid%3DDTS10001630-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/qa2001/qa1078.html%3Fid%3DDTS10001630-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>