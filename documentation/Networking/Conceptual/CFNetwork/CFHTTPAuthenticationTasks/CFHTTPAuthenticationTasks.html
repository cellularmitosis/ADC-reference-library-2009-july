<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>CFNetwork Programming Guide: Communicating with Authenticating HTTP Servers</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Communicating with Authenticating HTTP Servers"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30001132-CH8" title="Communicating with Authenticating HTTP Servers"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000429" target="_top">Networking</a> &gt; <a href="../Introduction/Introduction.html#//apple_ref/doc/uid/TP30001132-CH1-DontLinkElementID_24">CFNetwork Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../CFHTTPTasks/CFHTTPTasks.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../CFFTPTasks/CFFTPTasks.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30001132-CH8-SW1" title="Communicating with Authenticating HTTP Servers"></a><h1>Communicating with Authenticating HTTP Servers</h1><p>This chapter describes how to interact with authenticating HTTP servers by taking advantage of the CFHTTPAuthentication API. It explains how to find matching authentication objects and credentials, apply them to an HTTP request, and store them for later use.</p><p>In general, if an HTTP server returns a 401 or 407 response following your HTTP request, it means that the server is authenticating and requires credentials. In the CFHTTPAuthentication API, each set of credentials is stored in a CFHTTPAuthentication object. Therefore, every different authenticating server and every different user connecting to that server requires a separate CFHTTPAuthentication object. To communicate with the server, you need to apply your CFHTTPAuthentication object to the HTTP request. These steps are explained in more detail next.</p>
<!-- This template is being used for both PDF and HTML. -->

    
    <h4>In this section:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="CFHTTPAuthenticationTasks.html#//apple_ref/doc/uid/TP30001132-CH8-SW3">Handling Authentication</a>
				
			<br/>
			
        
			
			
				<a href="CFHTTPAuthenticationTasks.html#//apple_ref/doc/uid/TP30001132-CH8-SW6">Keeping Credentials in Memory</a>
				
			<br/>
			
        
			
			
				<a href="CFHTTPAuthenticationTasks.html#//apple_ref/doc/uid/TP30001132-CH8-SW5">Keeping Credentials in a Persistent Store</a>
				
			<br/>
			
        
			
			
				<a href="CFHTTPAuthenticationTasks.html#//apple_ref/doc/uid/TP30001132-CH8-DontLinkElementID_6">Authenticating Firewalls</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP30001132-CH8-SW3" title="Handling Authentication"></a><h2>Handling Authentication</h2><p>Adding support for authentication will allow your application to talk with authenticating HTTP servers (if the server returns a 401 or 407 response). Even though HTTP authentication is not a difficult concept, it is a complicated process to execute. The procedure is as follows:</p><ol class="ol"><li class="li"><p>The client sends an HTTP request to the server.</p></li><li class="li"><p>The server returns a challenge to the client.</p></li><li class="li"><p>The client bundles the original request with credentials and sends them back to the server.</p></li><li class="li"><p>A negotiation takes place between the client and server.</p></li><li class="li"><p>When the server has authenticated the client, it sends back the response to the request.</p></li></ol><p>Performing this procedure requires a number of steps. A diagram of the entire procedure can be seen in <span class="content_text">Figure 4-1</span> and <span class="content_text">Figure 4-2</span>.</p><br/><div><a name="//apple_ref/doc/uid/TP30001132-CH8-SW4" title="Figure 4-1Handling authentication"></a><p><strong>Figure 4-1&nbsp;&nbsp;</strong>Handling authentication</p><img src = "../Art/apply.gif" alt = "Handling Authentication Flow-chart" width="369" height="314"></div><br/><br/><div><a name="//apple_ref/doc/uid/TP30001132-CH8-SW7" title="Figure 4-2Finding an authentication object"></a><p><strong>Figure 4-2&nbsp;&nbsp;</strong>Finding an authentication object</p><img src = "../Art/authentication.gif" alt = "Finding an Authentication Object Flow-chart" width="571" height="368"></div><br/><p>When an HTTP request returns a 401 or 407 response, the first step is for the client to find a valid CFHTTPAuthentication object. An authentication object contains credentials and other information that, when applied to an HTTP message request, verifies your identity with the server. If you've already authenticated once with the server, you will have a valid authentication object. However, in most cases, you will need to create this object from the response with the <code><a href="../../../../CoreFoundation/Reference/CFHTTPAuthenticationRef/Reference/reference.html#//apple_ref/doc/c_ref/CFHTTPAuthenticationCreateFromResponse" target="_top">CFHTTPAuthenticationCreateFromResponse</a></code> function. See <span class="content_text">Listing 4-1</span>.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30001132-CH8-DontLinkElementID_19" title="Note"></a><p><strong>Note:</strong>&nbsp;All the sample code regarding authentication is adapted from the <em><a href="../../../../../samplecode/ImageClient/index.html#//apple_ref/doc/uid/DTS10003661" target="_top">ImageClient</a></em> application.</p></div><a name="//apple_ref/doc/uid/TP30001132-CH8-SW13" title="Listing 4-1Creating an authentication object"></a><p class="codesample"><strong>Listing 4-1&nbsp;&nbsp;</strong>Creating an authentication object</p><div class="codesample"><table><tr><td scope="row"><pre>if (!authentication) {<span></span></pre></td></tr><tr><td scope="row"><pre>    CFHTTPMessageRef responseHeader =<span></span></pre></td></tr><tr><td scope="row"><pre>        (CFHTTPMessageRef) CFReadStreamCopyProperty(<span></span></pre></td></tr><tr><td scope="row"><pre>            readStream,<span></span></pre></td></tr><tr><td scope="row"><pre>            kCFStreamPropertyHTTPResponseHeader<span></span></pre></td></tr><tr><td scope="row"><pre>        );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Get the authentication information from the response.<span></span></pre></td></tr><tr><td scope="row"><pre>    authentication = CFHTTPAuthenticationCreateFromResponse(NULL, responseHeader);<span></span></pre></td></tr><tr><td scope="row"><pre>    CFRelease(responseHeader);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>If the new authentication object is valid, then you are done and can continue to the second step of <span class="content_text"><a href="CFHTTPAuthenticationTasks.html#//apple_ref/doc/uid/TP30001132-CH8-SW4">Figure 4-1</a></span>. If the authentication object is not valid, then throw away the authentication object and credentials and check to see if the credentials were bad. For more information about credentials, read "<span class="content_text"><a href="http://developer.apple.com/qa/qa2001/qa1277.html" target="_top">Security Credentials</a></span>".</p><p>Bad credentials mean that the server did not accept the login information at it will continue to listen for new credentials. However, if the credentials were good but the server still rejected your request, then the server is refusing to speak with you, so you must give up. Assuming the credentials were bad, retry this entire process beginning with creating an authentication object until you get working credentials and a valid authentication object. In code, this procedure should look like the one in <span class="content_text">Listing 4-2</span>.</p><a name="//apple_ref/doc/uid/TP30001132-CH8-SW14" title="Listing 4-2Finding a valid authentication object"></a><p class="codesample"><strong>Listing 4-2&nbsp;&nbsp;</strong>Finding a valid authentication object</p><div class="codesample"><table><tr><td scope="row"><pre>CFStreamError err;<span></span></pre></td></tr><tr><td scope="row"><pre>if (!authentication) {<span></span></pre></td></tr><tr><td scope="row"><pre>    // the newly created authentication object is bad, must return<span></span></pre></td></tr><tr><td scope="row"><pre>    return;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>} else if (!CFHTTPAuthenticationIsValid(authentication, &amp;err)) {<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // destroy authentication and credentials<span></span></pre></td></tr><tr><td scope="row"><pre>    if (credentials) {<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(credentials);<span></span></pre></td></tr><tr><td scope="row"><pre>        credentials = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    CFRelease(authentication);<span></span></pre></td></tr><tr><td scope="row"><pre>    authentication = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // check for bad credentials (to be treated separately)<span></span></pre></td></tr><tr><td scope="row"><pre>    if (err.domain == kCFStreamErrorDomainHTTP &amp;&amp;<span></span></pre></td></tr><tr><td scope="row"><pre>        (err.error == kCFStreamErrorHTTPAuthenticationBadUserName<span></span></pre></td></tr><tr><td scope="row"><pre>        || err.error == kCFStreamErrorHTTPAuthenticationBadPassword))<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        retryAuthorizationFailure(&amp;authentication);<span></span></pre></td></tr><tr><td scope="row"><pre>        return;<span></span></pre></td></tr><tr><td scope="row"><pre>    } else {<span></span></pre></td></tr><tr><td scope="row"><pre>        errorOccurredLoadingImage(err);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Now that you have a valid authentication object, continue following the flowchart in <span class="content_text"><a href="CFHTTPAuthenticationTasks.html#//apple_ref/doc/uid/TP30001132-CH8-SW4">Figure 4-1</a></span>. First, determine whether you need credentials. If you don't, then apply the authentication object to the HTTP request. The authentication object is applied to the HTTP request in <span class="content_text"><a href="CFHTTPAuthenticationTasks.html#//apple_ref/doc/uid/TP30001132-CH8-SW9">Listing 4-4</a></span> (<code>resumeWithCredentials</code>).</p><p>Without storing credentials (as explained in <span class="content_text"><a href="CFHTTPAuthenticationTasks.html#//apple_ref/doc/uid/TP30001132-CH8-SW6">“Keeping Credentials in Memory”</a></span> and <span class="content_text"><a href="CFHTTPAuthenticationTasks.html#//apple_ref/doc/uid/TP30001132-CH8-SW5">“Keeping Credentials in a Persistent Store”</a></span>), the only way to obtain valid credentials is by prompting the user. Most of the time, a user name and password are needed for the credentials. By passing the authentication object to the <code><a href="../../../../CoreFoundation/Reference/CFHTTPAuthenticationRef/Reference/reference.html#//apple_ref/doc/c_ref/CFHTTPAuthenticationRequiresUserNameAndPassword" target="_top">CFHTTPAuthenticationRequiresUserNameAndPassword</a></code> function you can see if a user name and password are necessary. If the credentials do need a user name and password, prompt the user for them and store them in the credentials dictionary. For an NTLM server, the credentials also require a domain. After you have the new credentials, you can apply the authentication object to the HTTP request using the <code><!--a-->resumeWithCredentials<!--/a--></code> function from <span class="content_text"><a href="CFHTTPAuthenticationTasks.html#//apple_ref/doc/uid/TP30001132-CH8-SW9">Listing 4-4</a></span>. This whole process is shown in <span class="content_text">Listing 4-3</span>.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30001132-CH8-DontLinkElementID_20" title="Note"></a><p><strong>Note:</strong>&nbsp;In code listings, when comments are preceded and succeeded by ellipses, it means that that action is outside the scope of this document, but does need to be implemented. This is different from normal comments which describe what action is taking place.</p></div><a name="//apple_ref/doc/uid/TP30001132-CH8-SW16" title="Listing 4-3Finding credentials (if necessary) and applying them"></a><p class="codesample"><strong>Listing 4-3&nbsp;&nbsp;</strong>Finding credentials (if necessary) and applying them</p><div class="codesample"><table><tr><td scope="row"><pre>// ...continued from <code><span class="content_text">Listing 4-2</span></code><span></span></pre></td></tr><tr><td scope="row"><pre>else {<span></span></pre></td></tr><tr><td scope="row"><pre>    cancelLoad();<span></span></pre></td></tr><tr><td scope="row"><pre>    if (credentials) {<span></span></pre></td></tr><tr><td scope="row"><pre>        resumeWithCredentials();<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    // are a user name &amp; password needed?<span></span></pre></td></tr><tr><td scope="row"><pre>    else if (CFHTTPAuthenticationRequiresUserNameAndPassword(authentication))<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>        CFStringRef realm = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>        CFURLRef url = CFHTTPMessageCopyRequestURL(request);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>         // check if you need an account domain so you can display it if necessary<span></span></pre></td></tr><tr><td scope="row"><pre>        if (!CFHTTPAuthenticationRequiresAccountDomain(authentication)) {<span></span></pre></td></tr><tr><td scope="row"><pre>            realm = CFHTTPAuthenticationCopyRealm(authentication);<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        // ...prompt user for user name (user), password (pass)<span></span></pre></td></tr><tr><td scope="row"><pre>        // and if necessary domain (domain) to give to the server...<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        // Guarantee values<span></span></pre></td></tr><tr><td scope="row"><pre>        if (!user) user = (CFStringRef)@"";<span></span></pre></td></tr><tr><td scope="row"><pre>        if (!pass) pass = (CFStringRef)@"";<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        CFDictionarySetValue(credentials, kCFHTTPAuthenticationUsername, user);<span></span></pre></td></tr><tr><td scope="row"><pre>        CFDictionarySetValue(credentials, kCFHTTPAuthenticationPassword, pass);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        // Is an account domain needed? (used currently for NTLM only)<span></span></pre></td></tr><tr><td scope="row"><pre>        if (CFHTTPAuthenticationRequiresAccountDomain(authentication)) {<span></span></pre></td></tr><tr><td scope="row"><pre>            if (!domain) domain = (CFStringRef)@"";<span></span></pre></td></tr><tr><td scope="row"><pre>            CFDictionarySetValue(credentials,<span></span></pre></td></tr><tr><td scope="row"><pre>                                 kCFHTTPAuthenticationAccountDomain, domain);<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        if (realm) CFRelease(realm);<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(url);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        resumeWithCredentials();<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30001132-CH8-SW9" title="Listing 4-4Applying the authentication object to a request"></a><p class="codesample"><strong>Listing 4-4&nbsp;&nbsp;</strong>Applying the authentication object to a request</p><div class="codesample"><table><tr><td scope="row"><pre>void resumeWithCredentials() {<span></span></pre></td></tr><tr><td scope="row"><pre>    // Apply whatever credentials we've built up to the old request<span></span></pre></td></tr><tr><td scope="row"><pre>    if (!CFHTTPMessageApplyCredentialDictionary(request, authentication,<span></span></pre></td></tr><tr><td scope="row"><pre>                                                credentials, NULL)) {<span></span></pre></td></tr><tr><td scope="row"><pre>        errorOccurredLoadingImage();<span></span></pre></td></tr><tr><td scope="row"><pre>    } else {<span></span></pre></td></tr><tr><td scope="row"><pre>        // Now that we've updated our request, retry the load<span></span></pre></td></tr><tr><td scope="row"><pre>        loadRequest();<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30001132-CH8-SW6" title="Keeping Credentials in Memory"></a><h2>Keeping Credentials in Memory</h2><p>If you plan on communicating with an authenticating server often, it may be worth reusing credentials to avoid prompting the user for the server's user name and password multiple times. This section explains the changes that should be made to one-time use authentication code (such as in <span class="content_text"><a href="CFHTTPAuthenticationTasks.html#//apple_ref/doc/uid/TP30001132-CH8-SW3">“Handling Authentication”</a></span>) to store credentials in memory for reuse later.</p><p>To reuse credentials, there are three data structure changes you need to make to your code.</p><ol class="ol"><li class="li"><p>Create a mutable array to hold all the authentication objects.</p><div class="codesample"><table><tr><td scope="row"><pre>CFMutableArrayRef authArray;<span></span></pre></td></tr></table></div><p>instead of:</p><div class="codesample"><table><tr><td scope="row"><pre>CFHTTPAuthenticationRef authentication;<span></span></pre></td></tr></table></div></li><li class="li"><p>Create a mapping from authentication objects to credentials using a dictionary.</p><div class="codesample"><table><tr><td scope="row"><pre>CFMutableDictionaryRef credentialsDict;<span></span></pre></td></tr></table></div><p>instead of:</p><div class="codesample"><table><tr><td scope="row"><pre>CFMutableDictionaryRef credentials;<span></span></pre></td></tr></table></div></li><li class="li"><p>Maintain these structures everywhere you used to modify the current authentication object and the current credentials.</p><div class="codesample"><table><tr><td scope="row"><pre>CFDictionaryRemoveValue(credentialsDict, authentication);<span></span></pre></td></tr></table></div><p>instead of:</p><div class="codesample"><table><tr><td scope="row"><pre>CFRelease(credentials);<span></span></pre></td></tr></table></div></li></ol><p>Now, after creating the HTTP request, look for a matching authentication object before each load. A simple, unoptimized method for finding the appropriate object can be seen in <span class="content_text">Listing 4-5</span>.</p><a name="//apple_ref/doc/uid/TP30001132-CH8-SW11" title="Listing 4-5Looking for a matching authentication object"></a><p class="codesample"><strong>Listing 4-5&nbsp;&nbsp;</strong>Looking for a matching authentication object</p><div class="codesample"><table><tr><td scope="row"><pre>CFHTTPAuthenticationRef findAuthenticationForRequest {<span></span></pre></td></tr><tr><td scope="row"><pre>    int i, c = CFArrayGetCount(authArray);<span></span></pre></td></tr><tr><td scope="row"><pre>    for (i = 0; i &lt; c; i ++) {<span></span></pre></td></tr><tr><td scope="row"><pre>        CFHTTPAuthenticationRef auth = (CFHTTPAuthenticationRef)<span></span></pre></td></tr><tr><td scope="row"><pre>                CFArrayGetValueAtIndex(authArray, i);<span></span></pre></td></tr><tr><td scope="row"><pre>        if (CFHTTPAuthenticationAppliesToRequest(auth, request)) {<span></span></pre></td></tr><tr><td scope="row"><pre>            return auth;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    return NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>If the authentication array has a matching authentication object, then check the credentials store to see if the correct credentials are also available. Doing so prevents you from having to prompt the user for a user name and password again. Look for the credentials using the <code><a href="../../../../CoreFoundation/Reference/CFDictionaryRef/Reference/reference.html#//apple_ref/doc/c_ref/CFDictionaryGetValue" target="_top">CFDictionaryGetValue</a></code> function as shown in <span class="content_text">Listing 4-6</span>.</p><a name="//apple_ref/doc/uid/TP30001132-CH8-SW8" title="Listing 4-6Searching the credentials store"></a><p class="codesample"><strong>Listing 4-6&nbsp;&nbsp;</strong>Searching the credentials store</p><div class="codesample"><table><tr><td scope="row"><pre>credentials = CFDictionaryGetValue(credentialsDict, authentication);<span></span></pre></td></tr></table></div><p>Then apply your matching authentication object and credentials to your original HTTP request and resend it.</p><div class="warningbox"><img src="../../../../Resources/Images/icon_warning.gif" alt="!" width="20" height="20" border="0" class="warningicon" /><a name="//apple_ref/doc/uid/TP30001132-CH8-DontLinkElementID_21" title="Warning:"></a><p><strong>Warning:</strong>&nbsp;Do not apply credentials to the HTTP request <em>before</em> receiving a server challenge. The server may have changed since the last time you authenticated and you could create a security risk.</p><p></p><div class="clear"></div></div><p>With these changes, you application will be able to store authentication objects and credentials in memory for use later.</p><a name="//apple_ref/doc/uid/TP30001132-CH8-SW5" title="Keeping Credentials in a Persistent Store"></a><h2>Keeping Credentials in a Persistent Store</h2><p>Storing credentials in memory prevents a user from having to reenter a server's user name and password during that specific application launch. However, when the application quits, those credentials will be released. To avoid losing the credentials, save them in a persistent store so each server's credentials need to be generated only once. A keychain is the recommended place for storing credentials. Even though you can have multiple keychains, this document refers to the user's default keychain as <em>the</em> keychain. Using the keychain means that the authentication information that you store can also be used in other applications trying to access the same server, and vice versa.</p><p>Storing and retrieving credentials in the keychain requires two functions: one for finding the credentials dictionary for authentication and one for saving the credentials of the most recent request. These functions will be declared in this document as:</p><div class="codesample"><table><tr><td scope="row"><pre>CFMutableDictionaryRef findCredentialsForAuthentication(<span></span></pre></td></tr><tr><td scope="row"><pre>        CFHTTPAuthenticationRef auth);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>void saveCredentialsForRequest(void);<span></span></pre></td></tr></table></div><p>The function <code><!--a-->findCredentialsForAuthentication<!--/a--></code> first checks the credentials dictionary stored in memory to see whether the credentials are cached locally. See <span class="content_text"><a href="CFHTTPAuthenticationTasks.html#//apple_ref/doc/uid/TP30001132-CH8-SW8">Listing 4-6</a></span> for how to implement this. </p><p>If the credentials are not cached in memory, then search the keychain. To search the keychain, use the function <code><a href="../../../../Security/Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainFindInternetPassword" target="_top">SecKeychainFindInternetPassword</a></code>. This function requires a large number of parameters. The parameters, and a short description of how they are used with HTTP authentication credentials, are:</p><dl class="termdef">	<dt><code>keychainOrArray</code></dt><dd><p><code>NULL</code> to specify the user's default keychain list.</p></dd><dt><code>serverNameLength</code></dt><dd><p>The length of <code>serverName</code>, usually <code>strlen(serverName)</code>.</p></dd><dt><code>serverName</code></dt><dd><p>The server name parsed from the HTTP request.</p></dd><dt><code>securityDomainLength</code></dt><dd><p>The length of security domain, or <code>0</code> if there is no domain. In the sample code, <code>realm ? strlen(realm) : 0</code> is passed to account for both situations.</p></dd><dt><code>securityDomain</code></dt><dd><p>The realm of the authentication object, obtained from the <code><a href="../../../../CoreFoundation/Reference/CFHTTPAuthenticationRef/Reference/reference.html#//apple_ref/doc/c_ref/CFHTTPAuthenticationCopyRealm" target="_top">CFHTTPAuthenticationCopyRealm</a></code> function.</p></dd><dt><code>accountNameLength</code></dt><dd><p>The length of <code>accountName</code>. Since the <code>accountName</code> is <code>NULL</code>, this value is <code>0</code>.</p></dd><dt><code>accountName</code></dt><dd><p>There is no account name when fetching the keychain entry, so this should be <code>NULL</code>.</p></dd><dt><code>pathLength</code></dt><dd><p>The length of <code>path</code>, or <code>0</code> if there is no path. In the sample code, <code>path ? strlen(path) : 0</code> is passed to account for both situations.</p></dd><dt><code>path</code></dt><dd><p>The path from the authentication object, obtained from the <code><a href="../../../../CoreFoundation/Reference/CFURLRef/Reference/reference.html#//apple_ref/doc/c_ref/CFURLCopyPath" target="_top">CFURLCopyPath</a></code> function.</p></dd><dt><code>port</code></dt><dd><p>The port number, obtained from the function <code>CFURLGetPortNumber</code>.</p></dd><dt><code>protocol</code></dt><dd><p>A string representing the protocol type, such as HTTP or HTTPS. The protocol type is obtained by calling the <code>CFURLCopyScheme</code> function.</p></dd><dt><code>authenticationType</code></dt><dd><p>The authentication type, obtained from the function <code>CFHTTPAuthenticationCopyMethod</code>.</p></dd><dt><code>passwordLength</code></dt><dd><p><code>0</code>, because no password is necessary when fetching a keychain entry.</p></dd><dt><code>passwordData</code></dt><dd><p><code>NULL</code>, because no password is necessary when fetching a keychain entry.</p></dd><dt><code>itemRef</code></dt><dd><p>The keychain item reference object, <code>SecKeychainItemRef</code>, returned upon finding the correct keychain entry</p></dd></dl><p>When called properly, the code should look like that in <span class="content_text">Listing 4-7</span>.</p><a name="//apple_ref/doc/uid/TP30001132-CH8-SW15" title="Listing 4-7Searching the keychain"></a><p class="codesample"><strong>Listing 4-7&nbsp;&nbsp;</strong>Searching the keychain</p><div class="codesample"><table><tr><td scope="row"><pre>didFind =<span></span></pre></td></tr><tr><td scope="row"><pre>    SecKeychainFindInternetPassword(NULL,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    strlen(host), host,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    realm ? strlen(realm) : 0, realm,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    0, NULL,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    path ? strlen(path) : 0, path,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    port,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    protocolType,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    authenticationType,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    0, NULL,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    &amp;itemRef);<span></span></pre></td></tr></table></div><p>Assuming that <code><a href="../../../../Security/Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainFindInternetPassword" target="_top">SecKeychainFindInternetPassword</a></code> returns successfully, create a keychain attribute list (<code>SecKeychainAttributeList</code>) containing a single keychain attribute (<code>SecKeychainAttribute</code>).  The keychain attribute list will contain the user name and password. To load the keychain attribute list, call the function <code><a href="../../../../Security/Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainItemCopyContent" target="_top">SecKeychainItemCopyContent</a></code> and pass it the keychain item reference object (<code>itemRef</code>) that was returned by <code><a href="../../../../Security/Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainFindInternetPassword" target="_top">SecKeychainFindInternetPassword</a></code>. This function will fill the keychain attribute with the account's user name, and a <code>void **</code> as its password.</p><p>The user name and password can then be used to create a new set of credentials. <span class="content_text">Listing 4-8</span> shows this procedure.</p><a name="//apple_ref/doc/uid/TP30001132-CH8-SW2" title="Listing 4-8Loading server credentials from the keychain"></a><p class="codesample"><strong>Listing 4-8&nbsp;&nbsp;</strong>Loading server credentials from the keychain</p><div class="codesample"><table><tr><td scope="row"><pre>if (didFind == noErr) {<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    SecKeychainAttribute     attr;<span></span></pre></td></tr><tr><td scope="row"><pre>    SecKeychainAttributeList attrList;<span></span></pre></td></tr><tr><td scope="row"><pre>    UInt32                   length;<span></span></pre></td></tr><tr><td scope="row"><pre>    void                     *outData;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // To set the account name attribute<span></span></pre></td></tr><tr><td scope="row"><pre>    attr.tag = kSecAccountItemAttr;<span></span></pre></td></tr><tr><td scope="row"><pre>    attr.length = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>    attr.data = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    attrList.count = 1;<span></span></pre></td></tr><tr><td scope="row"><pre>    attrList.attr = &amp;attr;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (SecKeychainItemCopyContent(itemRef, NULL, &amp;attrList, &amp;length, &amp;outData)<span></span></pre></td></tr><tr><td scope="row"><pre>        == noErr) {<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        // attr.data is the account (username) and outdata is the password<span></span></pre></td></tr><tr><td scope="row"><pre>        CFStringRef username =<span></span></pre></td></tr><tr><td scope="row"><pre>            CFStringCreateWithBytes(kCFAllocatorDefault, attr.data,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    attr.length, kCFStringEncodingUTF8, false);<span></span></pre></td></tr><tr><td scope="row"><pre>        CFStringRef password =<span></span></pre></td></tr><tr><td scope="row"><pre>            CFStringCreateWithBytes(kCFAllocatorDefault, outData, length,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    kCFStringEncodingUTF8, false);<span></span></pre></td></tr><tr><td scope="row"><pre>        SecKeychainItemFreeContent(&amp;attrList, outData);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        // create credentials dictionary and fill it with the user name &amp; password<span></span></pre></td></tr><tr><td scope="row"><pre>        credentials =<span></span></pre></td></tr><tr><td scope="row"><pre>            CFDictionaryCreateMutable(NULL, 0,<span></span></pre></td></tr><tr><td scope="row"><pre>                                      &amp;kCFTypeDictionaryKeyCallBacks,<span></span></pre></td></tr><tr><td scope="row"><pre>                                      &amp;kCFTypeDictionaryValueCallBacks);<span></span></pre></td></tr><tr><td scope="row"><pre>        CFDictionarySetValue(credentials, kCFHTTPAuthenticationUsername,<span></span></pre></td></tr><tr><td scope="row"><pre>                             username);<span></span></pre></td></tr><tr><td scope="row"><pre>        CFDictionarySetValue(credentials, kCFHTTPAuthenticationPassword,<span></span></pre></td></tr><tr><td scope="row"><pre>                             password);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(username);<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(password);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    CFRelease(itemRef);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Retrieving credentials from the keychain is only useful if you can store credentials in the keychain first. The steps are very similar to loading credentials. First, see if the credentials are already stored in the keychain. Call <code><a href="../../../../Security/Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainFindInternetPassword" target="_top">SecKeychainFindInternetPassword</a></code>, but pass the user name for <code>accountName</code> and the length of <code>accountName</code> for <code>accountNameLength</code>.</p><p>If the entry exists, modify it to change the password. Set the <code>data</code> field of the keychain attribute to contain the user name, so that you modify the correct attribute. Then call the function <code><a href="../../../../Security/Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainItemModifyContent" target="_top">SecKeychainItemModifyContent</a></code> and pass the keychain item reference object (<code>itemRef</code>), the keychain attribute list, and the new password. By modifying the keychain entry rather than overwriting it, the keychain entry will be properly updated and any associated metadata will still be preserved. The entry should look like the one in <span class="content_text">Listing 4-9</span>.</p><a name="//apple_ref/doc/uid/TP30001132-CH8-SW12" title="Listing 4-9Modifying the keychain entry"></a><p class="codesample"><strong>Listing 4-9&nbsp;&nbsp;</strong>Modifying the keychain entry</p><div class="codesample"><table><tr><td scope="row"><pre>// Set the attribute to the account name<span></span></pre></td></tr><tr><td scope="row"><pre>attr.tag = kSecAccountItemAttr;<span></span></pre></td></tr><tr><td scope="row"><pre>attr.length = strlen(username);<span></span></pre></td></tr><tr><td scope="row"><pre>attr.data = (void*)username;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Modify the keychain entry<span></span></pre></td></tr><tr><td scope="row"><pre>SecKeychainItemModifyContent(itemRef, &amp;attrList, strlen(password),<span></span></pre></td></tr><tr><td scope="row"><pre>                             (void *)password);<span></span></pre></td></tr></table></div><p>If the entry does not exist, then you will need to create it from scratch. The function <code>SecKeychainAddInternetPassword</code> accomplishes this task. Its parameters are the same as <code><a href="../../../../Security/Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainFindInternetPassword" target="_top">SecKeychainFindInternetPassword</a></code>, but in contrast with the call to <code><a href="../../../../Security/Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainFindInternetPassword" target="_top">SecKeychainFindInternetPassword</a></code>, you supply <code><a href="../../../../Security/Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainAddInternetPassword" target="_top">SecKeychainAddInternetPassword</a></code> both a user name and a password. Release the keychain item reference object following a successful call to <code><a href="../../../../Security/Reference/keychainservices/Reference/reference.html#//apple_ref/doc/c_ref/SecKeychainAddInternetPassword" target="_top">SecKeychainAddInternetPassword</a></code> unless you need to use it for something else. See the function call in <span class="content_text">Listing 4-10</span>.</p><a name="//apple_ref/doc/uid/TP30001132-CH8-SW10" title="Listing 4-10Storing a new keychain entry"></a><p class="codesample"><strong>Listing 4-10&nbsp;&nbsp;</strong>Storing a new keychain entry</p><div class="codesample"><table><tr><td scope="row"><pre>SecKeychainAddInternetPassword(NULL,<span></span></pre></td></tr><tr><td scope="row"><pre>                               strlen(host), host,<span></span></pre></td></tr><tr><td scope="row"><pre>                               realm ? strlen(realm) : 0, realm,<span></span></pre></td></tr><tr><td scope="row"><pre>                               strlen(username), username,<span></span></pre></td></tr><tr><td scope="row"><pre>                               path ? strlen(path) : 0, path,<span></span></pre></td></tr><tr><td scope="row"><pre>                               port,<span></span></pre></td></tr><tr><td scope="row"><pre>                               protocolType,<span></span></pre></td></tr><tr><td scope="row"><pre>                               authenticationType,<span></span></pre></td></tr><tr><td scope="row"><pre>                               strlen(password), password,<span></span></pre></td></tr><tr><td scope="row"><pre>                               &amp;itemRef);<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30001132-CH8-DontLinkElementID_6" title="Authenticating Firewalls"></a><h2>Authenticating Firewalls</h2><p>Authenticating firewalls is very similar to authenticating servers except that every failed HTTP request must be checked for both proxy authentication and server authentication. This means that you need separate stores (both local and persistent) for proxy servers and origin servers. Thus, the procedure for a failed HTTP response will now be:</p><ul class="ul"><li class="li"><p>Determine whether the response's status code was 407 (a proxy challenge). If it is, find a matching authentication object and credentials by checking the local proxy store and the persistent proxy store. If neither of those has a matching object and credentials, then request the credentials from the user. Apply the authentication object to the HTTP request and try again.</p></li><li class="li"><p>Determine whether the response's status code was 401 (a server challenge). If it is, follow the same procedure as with a 407 response, but use the origin server stores.</p></li></ul><p>There are also a few minor differences to enforce when using proxy servers. The first is that the arguments to the keychain calls come from the proxy host and port, rather than from the URL for an origin server. The second is that when asking the user for a user name and password, make sure the prompt clearly states what the password is for.</p><p>By following these instructions, your application should be able to work with authenticating firewalls.</p>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../CFHTTPTasks/CFHTTPTasks.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../CFFTPTasks/CFFTPTasks.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2009 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2009-05-06<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Networking/Conceptual/CFNetwork/CFHTTPAuthenticationTasks/CFHTTPAuthenticationTasks.html%3Fid%3DTP30001132-6.3&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Networking/Conceptual/CFNetwork/CFHTTPAuthenticationTasks/CFHTTPAuthenticationTasks.html%3Fid%3DTP30001132-6.3&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Networking/Conceptual/CFNetwork/CFHTTPAuthenticationTasks/CFHTTPAuthenticationTasks.html%3Fid%3DTP30001132-6.3&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>