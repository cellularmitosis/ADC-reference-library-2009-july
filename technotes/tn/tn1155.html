<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-05-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1155: JNI Tips: Building Your Native-Method Libraries For MacOS</title>    <meta name="keywords" content="Mac OS 8 Java JNI MRJ libraries export native-method">    <meta name="Description" content="Technical Note TN1155: This Technical Note describes techniques
developers can use to get their JDK 1.1.x  JNI libraries to work correctly
on MacOS Classic. Included is a discussion on how to set
up exports for linking, how to name and position the libraries,
and how to debug the loading process."><meta name="categories" content="Java"><meta name="week-posted" content="Feb 1, 1999 - Feb 5, 1999"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002994" title="JNI Tips: Building Your Native-Method Libraries For MacOS"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxJava-date.html">Java</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Java/idxPorting-date.html" target="_blank">Java > Porting</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1155</div>
<div id="pageheadsub">JNI Tips: Building Your Native-Method Libraries For MacOS</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left">   <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">     <tr><td width=300 valign="top" align=left scope="row">    <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>            <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>  </tr>  <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left> <span id="menutitle">CONTENTS   <br>  <br> </span>   </td>  </tr>  <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left> <!-- begin_toc --><P id = "menutext"><A HREF = "#Section1">I'm Superunsatisfied!</A><BR>         <BR>         <A HREF = "#Section2">Exporting the Right Stuff</A><BR>         <BR>         <A HREF = "#Section3">Naming the Library</A><BR>         <BR>         <A HREF = "#Section4">Positioning the Library</A><BR>         <BR>         <A HREF = "#Section5">Debugging The Loading Process</A><BR><BR>         <A HREF = "#References">References</A><BR><BR>         <A HREF="#Downloads">Downloadables</A></p>       <!-- end_toc --></td>  </tr>  <tr>   <td width=300 align=left scope="row"> <img src="images/tnmenubottom.gif" alt="" width=300 height=16>   </td>  </tr>    </table></td>  <td width=300 valign="top" align=left>            <!-- begin_intro_text --><P id = "introtext">J NI (Java Native         Interface) is a cross-platform standard for implementing         Java methods in native code. MRJ 2.0 and 2.1 support JNI;         however, some developers run into trouble getting their JNI         libraries to work correctly on Mac OS. For the most part         these are build- and installation-related issues. This         Technote is designed to put you at ease.</P>         <!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Mar 1 1999]</h3><!-- end_date --></TD> </TR>    </TABLE> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR>      <!-- begin_content -->               <H2><A NAME=Section1></A></H2>                  <H2>I'm Superunsatisfied!</H2>                  <P>You just got your JNI-based code to compile and link ...         but MRJ still throws an <CODE>UnsatisfiedLinkError</CODE> when         you try to use it. If you're porting code that runs on other         platforms, this can be pretty frustrating. Fortunately the         problem and the fix are usually pretty simple. The most         common problems are:</P>                  <UL>            <LI>You're not exporting the method implementations</LI>                        <LI>Your library's code-fragment name is wrong</LI>                        <LI>Your library file isn't located where MRJ can find            it</LI>         </UL>                  <P>Let's look at each of these in detail.</P><p><A HREF = "#top">Back to top</a></p><A NAME=Section2></A>                  <H2>Exporting The Right         Stuff</H2>                  <P>For MRJ to find the right functions to call in your         library, they need to be <I>exported</I>. The linker needs         to know which functions to export when it links the library.         The documentation for your development system (probably         either MPW or CodeWarrior) will describe in detail how to         set up exports. There are basically two ways to do it:</P>                  <P><B>Use a .exp file. </B>One way to set up exports is via         a separate ".exp" file, which is a text file that contains         the names of the exported functions, one per line. If using         CodeWarrior, you add the .exp file to your project, then go         to the "PPC PEF" panel of the Project Settings dialog and         set the "Export" pop-up to "Use '.exp' File." If using MPW's         <CODE>ppclink</CODE> tool, you use the "<CODE>-@export</CODE>"         flag.</P>                  <P>If you use a .exp file, make sure that you spell all the         function names correctly (pasting them in from your source files         is the best bet) and be sure to keep the file in sync when         you add, remove, or rename native methods -- <I>or if any         parameters change</I>.</P>                  <P><B>Use #pragma export. </B>The other method -- which I prefer -- is to use a C/C++ "<CODE>pragma</CODE>" to mark functions for export. The line "<CODE>#pragma export on</CODE>" tells the compiler to mark any function declarations it sees for export; the line "<CODE>#pragma export reset</CODE>" turns off this mode. One convenient way to use this is to turn on export mode while including the JNI-generated header file that         declares all of your methods:</P>                           <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>// MyNativeClass.c#pragma export on#include "MyNativeClass.h"  // this is the header that java.h generated#pragma export reset...function bodies follow...</pre></TD></TR></TABLE></CENTER><BR><BR>         <P>Another equivalent way to mark the functions for export         is to use the standard <CODE>JNIEXPORT</CODE> and         <CODE>JNICALL</CODE> macros defined in <CODE>&lt;jni.h&gt;;         JNIEXPORT</CODE> has the same functionality as turning on         "<CODE>#pragma export</CODE>." It looks like this:</P>                           <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>// MyNativeClass.c#include "MyNativeClass.h"  // this is the header that java.h generatedJNIEXPORT jint JNICALL Java_com_foo_MyNativeClass_myMethod(JNIEnv* e) {    ...}</pre></TD></TR></TABLE></CENTER><BR><BR>                  <P>You then need to tell the linker to export marked         functions. If using CodeWarrior, go to the "PPC PEF" panel of the Project Settings dialog and set the "Export" pop-up to "Use #pragma." If using MPW's <CODE>ppclink</CODE> tool, export-marked functions will automatically be exported.</P>                  <P>The advantage of using the second technique is that it         always exports the correct functions, even if the set of         native methods change. All you have to do is re-run java.h         (or recompile your Java classes, if you're using         CodeWarrior's option to emit JNI headers) and the list of         exported functions will automatically be updated next time         you build your native library.</P><p><A HREF = "#top">Back to top</a></p>         <H2><A NAME=Section3></A>Naming The         Library</H2>                  <P>The second major mistake developers make is incorrectly naming the library . The name of the library should be         exactly the same as the name you pass to         <CODE>System.loadLibrary</CODE>. (Metrowerks' Java VM required         prepending "<CODE>java_</CODE>" to the library name; MRJ does         not.)</P>                  <P>Moreover, the library name is <I>not</I> the same thing         as the library's filename. The filename is ignored; it's the         library name (or "fragment name") that counts. In         CodeWarrior, you set it in the "PPC PEF" project settings         panel. In MPW's <CODE>ppclink</CODE>, use the         "<CODE>-fragname</CODE>" flag.</P>                           <P><B>Note:</B><BR>                  MRJ 2.0 and some of the early-access releases of                  MRJ 2.1 had problems handling non-ASCII characters                  (such as &aacute;c&ccedil;&euml;&ntilde;t&egrave;d                  letters or Symbols&reg;) in library names, and                  would map them to the wrong character. This problem                  has been fixed in MRJ 2.1.</P><p><A HREF = "#top">Back to top</a></p>         <H2><A NAME=Section4></A>Positioning         The Library</H2>                  <P>Finally, even if your library is built perfectly, it         won't do much good if MRJ can't find it. The library file         needs to be on the <I>CFM search path</I>. Basically, this         means that it needs to be:</P>                  <OL>            <LI>Inside the application itself</LI>                        <LI>In the same folder as the application</LI>                        <LI>In the Extensions folder</LI>                        <LI>In a folder directly contained in the Extensions            folder, <I>e.g.,</I> the MRJ Libraries folder. <I>This is            not recursive</I> -- sub-folders of MRJ Libraries will            not be searched. A common mistake is to put the library            in the MRJClasses folder.</LI>         </OL>                  <P>"The application", of course, can mean a JBindery-generated         application, a browser like Microsoft Internet Explorer, or         Apple Applet Runner. (Note that if you're running your code         directly from JBindery without saving the settings as an         app, then "the application" means JBindery itself).</P>                  <P>If your native code is being used by a specific         application, then the usual place to put the library is into         the same folder as the app. If your native code is part of a         shared Java library that's installed in the MRJClasses         folder, then the native library should go into the MRJ         Libraries folder (not the MRJClasses folder, for reasons         described above).</P>                  <P>Embedding the code fragment within the application itself         is tempting, especially since -- if combined with a Virtual         File System -- you can boil your whole app down to a single         file. Since the data fork is already in use by the VFS, the         best place to put the code fragment is into a resource.         You'll have to tell the linker to generate a code resource,         then copy the resource into the app and add a new entry to         the app's <CODE>'cfrg'</CODE> resource to point to your code         fragment.</P><p><A HREF = "#top">Back to top</a></p>         <H2><A NAME=Section5></A>Debugging The         Loading Process</H2>                  <P>If you have a pesky native library that just flat-out         refuses to load even after you've used all the previous         information to troubleshoot it, here's a way to debug some         of the loading process. (You must have MacsBug installed to         do this. <A HREF = "tn1154.html">Technote 1154, <I>Debugging Java Code With MacsBug,</I></A> has an introduction to MacsBug for Java         developers.)</P>                  <OL>            <LI>Before your app tries to load the native            library, break into MacsBug by holding down the Command            (cloverleaf) key and pressing the Power key.</LI>                        <LI>Enter the command:<BR>            <CODE>tvb GetSharedLibrary ';dm r3 pstring'<BR>            </CODE>then enter "<CODE>g</CODE>" to continue.</LI>                        <LI>At the next point where MRJ tries to load a native            library, you will hit the breakpoint and drop into            MacsBug. There should be a line reading "<CODE>PowerPC            TVector Break At GetSharedLibrary</CODE>" in the MacsBug            console, followed on the next line by the name of the            library being loaded. MRJ loads a lot of libraries when            it starts up, so this may not be the library you're            looking for. If not, enter "<CODE>g</CODE>" to continue and            go back to step 3.</LI>                        <LI>If it <I>is</I> your library, double-check that the            spelling of the library name is exactly as you specified            it to the IDE or linker. If not, you need to make them            match. Do the last step, below, then rebuild and try            again...</LI>                        <LI>Enter "<CODE>r8</CODE>" to display the value of this            register -- you'll need it later.</LI>                        <LI>Enter "<CODE>gtp lr</CODE>" to step over the            <CODE>GetSharedLibrary</CODE> call.</LI>                        <LI>Enter "<CODE>error r3</CODE>" to see the status returned.            If this is zero (<CODE>noErr</CODE>), the library            successfully loaded and initialized. This would imply            that your problems are due to missing exports.</LI>                        <LI>If the error is nonzero, it's probably in the CFM            error range, <CODE>-28xx</CODE>. The error command gives you a brief            description, and you can get more info by consulting            <I>Inside Macintosh: PowerPC System Software</I>. In            particular, the most common error is <CODE>-2804</CODE>            (<CODE>fragLibNotFound</CODE>): your library or some library            it imports could not be found.</LI>                        <LI>The error may refer to your shared library or to            another library that it imports. Remember the            "<CODE>r8</CODE>" command you entered in step 5? Enter            "<CODE>dm <i>XXXX</i> pstring</CODE>" now, where            "<CODE><i>XXXX</i></CODE>" is the hex register value returned            by the "<CODE>r8</CODE>" command. The string displayed is the            name of the library that caused the error.</LI>                        <LI>Finally, enter "<CODE>tvc</CODE>" to clear the breakpoint            and then "<CODE>g</CODE>" to continue.</LI>         </OL>     <p><A HREF = "#top">Back to top</a></p><H2><A NAME=References></A>References</H2>                      <p>Sun Microsystems. <A HREF = "http://java.sun.com/docs/books/tutorial/book.html#cont"><I>The                Java Tutorial Continued</I></A>. Addison-Wesley,                1998.Includes a good <A HREF = "http://java.sun.com/docs/books/tutorial/native1.1/index.html">JNI                tutorial</A> that's also available online.</p>                          <p>Gordon, Rob. <A HREF = "http://www.phptr.com/ptrbooks/ptr_0136798950.html"><I>Essential                JNI</I></A>. Prentice-Hall PTR, 1998. Excellent description of JNI, with lots of examples                and a handy reference section at the end. Unfortunately,                the platform-specific details cover only Windows and                Unix, but this Technote should help you over the few                trouble spots.</p>                            <p>Apple Computer. <a href="http://developer.apple.com/documentation/mac/PPCSoftware/PPCSoftware-2.html"><I>Inside                Macintosh: PowerPC System Software</I></A>.                Addison-Wesley, 1994. Contains a detailed description of the Code Fragment                Manager (CFM) and how it loads shared libraries. (The                entire book is <a href="http://developer.apple.com/documentation/mac/PPCSoftware/PPCSoftware-2.html">available                online</A> in PDF form.)</p>                            <p>Apple Computer. <a href="http://developer.apple.com/tools/mpw-tools/"><I>Building                and Managing Programs in MPW</I></A>. Documents MPW tools, including <CODE>ppclink</CODE>, and                build processes.</p>            <BR><p><A HREF = "#top">Back to top</a></p><A NAME="Downloads"></A> <h2>Downloadables</h2><center><TABLE BORDER=0 CELLPADDING=3 WIDTH="600"> <TR> <td width=50 align=left>   <P ALIGN=center><img src="images/acrobatsmall.gif" align=middle alt="Acrobat" width=22 height=23></P></TD><td align="left">   <p>Acrobat version of this Note (60K).</P></TD><td width=60 align=left>   <p><A HREF="pdf/tn1155.pdf">Download</A></P></TD>  </TR> </table></center><BR><p><a href="#top">Back to top</a></p></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1155.html%3Fid%3DDTS10002994-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1155.html%3Fid%3DDTS10002994-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1155.html%3Fid%3DDTS10002994-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>