<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TE515: Keyboard Resource Q&amp;As</title>                                       <meta name="categories" content="Text"><meta name="week-posted" content="Oct 1, 1990 - Oct 5, 1990"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002838" title="Keyboard Resource Q&As"></a><a name="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/idxAccessibility-date.html" target="_blank">Hardware & Drivers > Accessibility</a></li>
		<li><a href="../../referencelibrary/UserExperience/idxHelpTechnologies-date.html" target="_blank">User Experience > Help Technologies</a></li>
		<li><a href="../../referencelibrary/UserExperience/idxTextFonts-date.html" target="_blank">User Experience > Text & Fonts</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TE515</div>
<div id="pageheadsub">Keyboard Resource Q&amp;As</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">This Technical Note contains a collection of archived Q&amp;As relating to a specifictopic - questions sent the Developer Support Center (DSC) along withanswers from the DSC engineers. Current Q&amp;A's can be found on the <A HREF = "../../qa/index.html">Macintosh Technical Q&amp;A's web site</a>.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Sep 01 1993]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content --><a name=Section1></A><h2>Code for getting Macintosh system KCHR resource</h2><p>How do I find the current <code>KCHR</code> resource?</p>___<P>Here's a method for getting a copy of the <code>KCHR</code> currently being used by thesystem. This method works for both System 6 and System 7.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>{  long    keyScript, KCHRID;  Handle  KCHRHdl;  /*  First get the current keyboard script. */  keyScript = GetEnvirons(smKeyScript);  /*  Now get the KCHR resource ID for that script. */  KCHRID = GetScript((short)keyScript, smScriptKeys);  /*  Finally, get your own copy of this KCHR. Now you can pass    a proper KCHR pointer to KeyTrans. */  KCHRHdl = GetResource('KCHR',KCHRID);</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></p><h2>ResEdit and Macintosh Portable 'KCAP' resources</h2><P>Date Written:  6/17/91</p><P>Last reviewed:  6/14/93</p><p>I am trying to use the <code>'KCAP'</code> resource to draw the Macintosh Portable keyboardlayout in our application. I used the ResEdit to check <code>'KCAP'</code> in both System 7and the Key Layout file, but the Portable keyboard type is not there.</p>___<P>The resource numbers 6 and 7 of <code>'KCAP'</code> are contained in the ROM of the Portableand some other Macintosh models. Being located in ROM, the resources are notdirectly viewable with ResEdit. They do, however, exist in the resource chain,so a <code>RGetResource</code> for <code>'KCAP'</code> number 6 should load and return a pointer to thisresource. ROM resources and the resource chain are discussed in the ResourceManager chapters of <i>Inside Macintosh</i> Volumes IV and V. The <code>'KCAP'</code>resource is documented in <i>Inside Macintosh</i>: Text, C-28 -6 C-34.</p><P><A HREF="#top">Back to top</A></p><h2>Using Macintosh KCAP resource to draw a keyboard</h2><P>Date Written:  1/10/92</P><P>Last reviewed:  6/14/93</p><p>How can I use the <code>KCAP</code> resource to draw the keyboard?</p>___<P><code>KCAP</code> resources describe the key layout of Macintosh keyboards. They areintended for use by the Key Caps desk accessory, but applications can also takeadvantage of <code>KCAP</code>s for information about key arrangements. The program <A HREF = "downloads/kcapApp_1.2.sea.hqx"><code>kcapApp</code></a>demonstrates use of the <code>KCAP</code> resource and is available in the Snippetscollection.</p><p>This is the format of the <code>KCAP</code> resource:</p>  <ul type="disc">	<li>rect, boundary for the keyboard (8 bytes)</li>	<li>rect, appropriate for an editable line of text (8 bytes)</li>	<li>integer, number of key shapes to follow (2 bytes)</li></ul>    <p>for each key shape:</p>    <ul type="disc">	<li>integer, number of points defining this key shape - 1 (2 bytes)</li></ul>    <p>for each point:</p>    <ul type="disc">	<li>  point, opposite corner of a rect (2 bytes)</li></ul>    <p>number of keys of this shape - 1 (2 bytes)</p>    <p>for each key:</p>     <ul type="disc">	<li> byte, modifier mask (1 byte)</li>	<li>byte, OR/AND setting for modifier mask (1 bit) plus</li>	<li>virtual keycode for this key (7 bits)</li>	<li>integer, vertical offset from previous key (2 bytes)</li>	<li>integer, horizontal offset from previous key (2 bytes)</li></ul><p>The keyboard boundary rect may be offset from the origin. It can be realignedwith</P><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre> OffsetRect(keybdRect, - keybdRect.left, - keybdRect.top)</pre>	</TD></TR></TABLE></CENTER>    <p>Each key shape consists of one or more rectangles. The rectangles are definedby a series of points, with one point specifying each rectangle. The firstpoint is the opposite corner of a rectangle anchored at the starting penlocation for the key; the next point is the opposite corner of a rectangle fromthe last point; and so on. The key shape is the union of the rects defined bythe points.</p><p>Note that a rectangle's point may be above or to the left of the previouspoint. To QuickDraw, this would define an empty rectangle, so the rectangle'shorizontal and/or vertical coordinates may need to be swapped before <code>FrameRect</code>is called to add a rect to the key's region.</p><p>The pen is moved to the top left of the keyboard boundary rect before drawingeach group of keys of a given shape. The pen location for each key is given asa horizontal and vertical offset from the pen location for the previous key.The pen location for the first key of each shape is an offset from the top leftcorner of the keyboard boundary rectangle. The pen does not change locationwhen a key is drawn.</p><p>Use <code>KeyTrans</code> to determine the character to be drawn on the key. The <code>KCAP</code>resource provides a 7-bit virtual keycode, plus a mask for the modifiers to bepassed to <code>KeyTrans</code>. If the most significant bit of the keycode byte is set, ANDthe desired modifiers with the modifier mask. If the bit is clear, OR themodifiers with the mask.</p><p>The high bit of the virtual keycode byte indicates to <code>KeyTrans</code> the type of thekeystroke; before calling <code>KeyTrans</code>, clear the bit for a keydown, or set it fora keyup. The bit should be clear if you're drawing a keyboard. <code>KeyTrans</code> setsthe state appropriately for dead keys only when called for keydowns.</p><p>The global <code>KbdType</code> ($21E), a byte, contains the <code>KCAP</code> resource number for thelast keyboard used. Under System 6, <code>KCAP</code> resources are kept in the file "KeyLayout" in the System folder. Starting with System 7, <code>KCAP</code> resources are in theSystem file. Alternatively, a machine's <code>KCAP</code> may be stored in ROM, where it'savailable with the <code>GetResource</code> call but cannot be viewed with ResEdit.</p><p>The most complete information about the <code>KCAP</code> resource format can be found inthe new <i>Inside Macintosh</i> "Text" volume, C-28 to C-34. For moreinformation on <code>KeyTrans</code> and <code>KCHR</code>s, see Chapter 10 of <i>Inside Macintosh</i>Volume V, pages 14-23 and 14-96 of <i>Inside Macintosh</i> Volume VI, and theMacintosh Technical Note <A HREF = "../tb/tb_12.html">"Key Mapping."</a> KCAP resources are also discussed onpages 14-95, 14-100 and 14-101 of <i>Inside Macintosh</i> Volume VI.</p><P><A HREF="#top">Back to top</A></p><h2>Macintosh Option key: Techniques for ignoring</h2><P>Date Written:  10/16/91</p><P>Last reviewed:  2/28/92</p><p>I would like to use the Macintosh Option key as the Control key for keyboardsthat lack a Control key, such as for Macintosh Plus keyboards. How can I findthe ASCII value that would have been returned if the Option key weren'tpressed, in a way that would be compatible with other keyboards?</p>___<P>There are a couple of clean ways to ignore the Option key. One is to"reprocess" the keyboard event. The fourth byte of the event message is theASCII code, but the third byte is the virtual key code. The system calls thetrap <code>KeyTrans</code> to map the virtual key code to ASCII according to a <code>'KCHR'</code>resource. You can do the same, and since the high byte of the modifiers arepart of the input to <code>KeyTrans</code>, you can strip out the Option key, call KeyTranson the third byte of the event message, and get back the "true" ASCII keypress.<code>KeyTrans</code> and <code>'KCHR'</code> resources are documented in Chapter 10 of <i>InsideMacintosh</i> Volume V, Chapter 14 of <i>Inside Macintosh</i> Volume VI (pages14-23 and 14-96), and the Macintosh Technical Note <A HREF = "../tb/tb_12.html">"Key Mapping."</a> In Pascal,these steps would look something like:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    keycode := BAND(event.message, keyCodeMask); { get virtual code }    keycode := BSR(keycode, 8); { move to low byte }    { now combine with modifiers }    keycode := BOR(keycode, BAND($FF00, event.modifiers));    keycode := BAND(keycode, $FFFF - optionKey); { strip option }</pre>	</TD></TR></TABLE></CENTER><p>The resource ID of the current <code>KCHR</code> is available as<code>GetScript(GetEnvirons(smKeyScript), smScriptKeys)</code>. Alternatively, a pointer tothe <code>KCHR</code> data is available under System 7 as <code>GetEnvirons(smKCHRCache)</code>, asdiscussed in the Technote "International Canceling."</p><p>This method may work for you, but there is a possible problem: dead keys. Sincedead keys are processed before your application gets the event, yourapplication will not see (for example) the first Option-e typed. However, thedead keys are specified in the <code>'KCHR'</code> resource, so you can create a <code>KCHR</code>(ResEdit 2.1.1 includes a template) to omit dead keys (and, if you choose,option characters) and include it with your application. Call SetScript to getthe system to use your <code>'KCHR'</code> (see the Technote <A HREF = "../tb/tb_12.html">"Key Mapping,"</a> IM V-313, andIM VI 14-40).</p><p>Another problem is that System 7 ignores a <code>'KCHR'</code> in the application'sresources, so an application's <code>'KCHR'</code> has to be installed in the system. Youcan install the <code>'KCHR'</code> with an installer program, or provide a keyboard fileusers can drag to the System file. (To create a keyboard file, use ResEdit toput the <code>'KCHR'</code> in the System file, and then drag it out with the System 7Finder.)</p>         <a name="Downloads"></a>       <P><A HREF="#top">Back to top</A></p><h2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (48K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/te_515.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/te/te_515.html%3Fid%3DDTS10002838-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/te/te_515.html%3Fid%3DDTS10002838-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/te/te_515.html%3Fid%3DDTS10002838-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>