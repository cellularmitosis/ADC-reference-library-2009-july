<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>HID Class Device Interface Guide: Working With HID Class Device Interfaces</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Working With HID Class Device Interfaces"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30000105" title="Working With HID Class Device Interfaces"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../../HardwareDrivers/index.html#//apple_ref/doc/uid/TP30000440-TP40003576" target="_top">Hardware &amp; Drivers</a> &gt; <a href="../../../../HardwareDrivers/HumanInterfaceDeviceForceFeedback-date.html#//apple_ref/doc/uid/TP30000440-TP40003576-TP30000855" target="_top">Human Interface Device &amp; Force Feedback</a> &gt; <a href="../intro/intro.html#//apple_ref/doc/uid/TP40000970-CH202-DontLinkElementID_6">HID Class Device Interface Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../basics/basics.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../samples/samples.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30000105-TP9" title="Working With HID Class Device Interfaces"></a><h1>Working With HID Class Device Interfaces</h1><p>This chapter provides step-by-step instructions, including listings of sample code, for accessing a HID class device on Mac OS X. These examples assume that you have already obtained an iterator for a list of devices matching certain properties (for example, by using the <code><!--a-->MyFindHIDDevices<!--/a--></code> function, <span class="content_text"><a href="../basics/basics.html#//apple_ref/doc/uid/TP40000970-CH211-BABCGAHI">Listing 2-3</a></span>).</p><p>Now that you have a device iterator, you can use it to examine each device and create a device interface for it. The functions in this chapter demonstrate this process by first displaying the properties and then creating and testing a device interface for each device in turn.</p><p>This chapter contains the following sections:</p><ol class="ol"><li class="li"><p><span class="content_text"><a href="workingwith.html#//apple_ref/doc/uid/TP30000105-CCHCCFGH">“Printing the Properties of a HID Class Device”</a></span></p></li><li class="li"><p><span class="content_text"><a href="workingwith.html#//apple_ref/doc/uid/TP30000105-CCHGABDH">“Creating a HID Class Device Interface”</a></span></p></li><li class="li"><p><span class="content_text"><a href="workingwith.html#//apple_ref/doc/uid/TP30000105-BABGHGHH">“Obtaining HID Cookies”</a></span></p></li><li class="li"><p><span class="content_text"><a href="workingwith.html#//apple_ref/doc/uid/TP30000105-CCHJGDBH">“Performing Operations on a HID Class Device”</a></span></p></li><li class="li"><p><span class="content_text"><a href="workingwith.html#//apple_ref/doc/uid/TP30000105-BABHBEBJ">“Using Queue Callbacks”</a></span></p></li></ol><p>For code to help you locate HID class devices, see <span class="content_text"><a href="../basics/basics.html#//apple_ref/doc/uid/TP40000970-CH211-CIHFIAID">“HID Access Overview.”</a></span></p><a name="//apple_ref/doc/uid/TP30000105-CCHCCFGH" title="Printing the Properties of a HID Class Device"></a><h2>Printing the Properties of a HID Class Device</h2><p>Since the properties of a HID class device often contain nested element dictionaries, the functions that access the elements must do so in a recursive manner. In the sample code, the <code>MyShowHIDProperties</code> function uses CFShow to print a dictionary.</p><a name="//apple_ref/doc/uid/TP30000105-CCHFCGBD" title="Listing 3-1A function that shows all properties for a HID class device"></a><p class="codesample"><strong>Listing 3-1&nbsp;&nbsp;</strong>A function that shows all properties for a HID class device</p><div class="codesample"><table><tr><td scope="row"><pre>static void MyShowHIDProperties(io_registry_entry_t hidDevice)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>        kern_return_t                                   result;<span></span></pre></td></tr><tr><td scope="row"><pre>        CFMutableDictionaryRef                          properties = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>        char                                            path[512];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        result = IORegistryEntryGetPath(hidDevice, kIOServicePlane, path);<span></span></pre></td></tr><tr><td scope="row"><pre>        if (result == KERN_SUCCESS)<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("[ %s ]", path);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        //Create a CF dictionary representation of the I/O<span></span></pre></td></tr><tr><td scope="row"><pre>        //Registry entry's properties<span></span></pre></td></tr><tr><td scope="row"><pre>        result = IORegistryEntryCreateCFProperties(hidDevice, &amp;properties,<span></span></pre></td></tr><tr><td scope="row"><pre>                kCFAllocatorDefault, kNilOptions);<span></span></pre></td></tr><tr><td scope="row"><pre>        if ((result == KERN_SUCCESS) &amp;&amp; properties)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>                CFShow(properties);<span></span></pre></td></tr><tr><td scope="row"><pre>                /* Some common properties of interest include:<span></span></pre></td></tr><tr><td scope="row"><pre>                    kIOHIDTransportKey, kIOHIDVendorIDKey,<span></span></pre></td></tr><tr><td scope="row"><pre>                    kIOHIDProductIDKey, kIOHIDVersionNumberKey,<span></span></pre></td></tr><tr><td scope="row"><pre>                    kIOHIDManufacturerKey, kIOHIDProductKey,<span></span></pre></td></tr><tr><td scope="row"><pre>                    kIOHIDSerialNumberKey, kIOHIDLocationIDKey,<span></span></pre></td></tr><tr><td scope="row"><pre>                    kIOHIDPrimaryUsageKey, kIOHIDPrimaryUsagePageKey,<span></span></pre></td></tr><tr><td scope="row"><pre>                    and kIOHIDElementKey.<span></span></pre></td></tr><tr><td scope="row"><pre>                */<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                //Release the properties dictionary<span></span></pre></td></tr><tr><td scope="row"><pre>                CFRelease(properties);<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("\n\n");<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p><code>MyShowHIDProperties</code> takes the HID class device found in the I/O Registry and uses <code>IORegistryEntryCreateCFProperties</code> to create a CF dictionary representation of the device’s properties. It then calls CFShow to format the information and print it to the screen.</p><a name="//apple_ref/doc/uid/TP30000105-CCHGABDH" title="Creating a HID Class Device Interface"></a><h2>Creating a HID Class Device Interface</h2><p>A device interface provides functions your application or other code running on Mac OS X can use to access a device. The <code>MyCreateHIDDeviceInterface</code> function, shown in <span class="content_text"><a href="workingwith.html#//apple_ref/doc/uid/TP30000105-CCHBAJCD">Listing 3-2</a></span>, creates and returns a HID class device interface based on a passed object from the I/O Registry. It also demonstrates how to obtain the class name of the passed object by calling the I/O Kit function <code>IOObjectGetClass</code>.</p><p>To create a HID class device interface, the <code>MyCreateHIDDeviceInterface</code> function performs the following steps:</p><ol class="ol"><li class="li"><p>It obtains an interface of type <code>IOCFPlugInInterface</code> for the HID class device represented by the passed <code>hidDevice</code> object.</p><p>To obtain this interface, it calls the <code>IOCreatePlugInInterfaceForService</code> function, passing the value <code>kIOHIDDeviceUserClientTypeID</code> for the plug-in type parameter and the value <code>kIOCFPlugInInterfaceID</code> for the interface type parameter. <code>kIOHIDDeviceUserClientTypeID</code> is defined in <code><a href="../../../../Darwin/Reference/IOKit/IOHIDLib_h/index.html#//apple_ref/doc/header/IOHIDLib.h" target="_top">IOHIDLib.h</a></code> and <code>kIOCFPlugInInterfaceID</code> is defined in <code>IOCFPlugIn.h</code> (located in <code>IOKit.framework</code>).</p></li><li class="li"><p>It obtains a HID class device interface by calling the <code>QueryInterface</code> method of the <code>IOCFPlugInInterface</code> object. To specify a HID class device interface, it uses the following term:</p><p><code>CFUUIDGetUUIDBytes(</code><code><a href="../../../../Darwin/Reference/IOKit/IOHIDLibObsolete_h/index.html#//apple_ref/c/macro/kIOHIDDeviceInterfaceID" target="_top">kIOHIDDeviceInterfaceID</a></code><code>)</code></p><p>This term produces a UUID (universally unique identifier) for the device interface. UUIDs are described in the Core Foundation developer documentation, available in the <span class="content_text"><a href="../../../../../referencelibrary/CoreFoundation/index.html#//apple_ref/doc/uid/TP30000943-TP30000421" target="_top">Reference Library > Core Foundation</a></span> section of the developer documentation website. <code><a href="../../../../Darwin/Reference/IOKit/IOHIDLibObsolete_h/index.html#//apple_ref/c/macro/kIOHIDDeviceInterfaceID" target="_top">kIOHIDDeviceInterfaceID</a></code> is defined in <code><a href="../../../../Darwin/Reference/IOKit/IOHIDLib_h/index.html#//apple_ref/doc/header/IOHIDLib.h" target="_top">IOHIDLib.h</a></code>.</p></li><li class="li"><p>It releases the <code>IOCFPlugInInterface</code> object and returns the HID class device interface in the <code>hidDeviceInterface</code> parameter.</p></li></ol><div class="notebox"><a name="//apple_ref/doc/uid/TP30000105-DontLinkElementID_11" title="Note"></a><p><strong>Note:</strong>&nbsp;The following listing uses a number of minor support functions that are not included as part of the text of this document because they do not relate directly to the use of HID class device interfaces. For a complete listing that includes these support functions, see <span class="content_text"><a href="../samples/samples.html#//apple_ref/doc/uid/TP40000970-CH212-SW1">“Complete Code Samples.”</a></span></p></div><a name="//apple_ref/doc/uid/TP30000105-CCHBAJCD" title="Listing 3-2A function that creates and returns a HID class device interface based on a passed object from the I/O Registry"></a><p class="codesample"><strong>Listing 3-2&nbsp;&nbsp;</strong>A function that creates and returns a HID class device interface based on a passed object from the I/O Registry</p><div class="codesample"><table><tr><td scope="row"><pre>static void MyCreateHIDDeviceInterface(io_object_t hidDevice,<span></span></pre></td></tr><tr><td scope="row"><pre>                            IOHIDDeviceInterface ***hidDeviceInterface)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    io_name_t               className;<span></span></pre></td></tr><tr><td scope="row"><pre>    IOCFPlugInInterface     **plugInInterface = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    HRESULT                 plugInResult = S_OK;<span></span></pre></td></tr><tr><td scope="row"><pre>    SInt32                  score = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>    IOReturn                ioReturnValue = kIOReturnSuccess;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    ioReturnValue = IOObjectGetClass(hidDevice, className);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    print_errmsg_if_io_err(ioReturnValue, "Failed to get class name.");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    printf("Found device type %s\n", className);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    ioReturnValue = IOCreatePlugInInterfaceForService(hidDevice,<span></span></pre></td></tr><tr><td scope="row"><pre>                            kIOHIDDeviceUserClientTypeID,<span></span></pre></td></tr><tr><td scope="row"><pre>                            kIOCFPlugInInterfaceID,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;plugInInterface,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;score);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (ioReturnValue == kIOReturnSuccess)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        //Call a method of the intermediate plug-in to create the device<span></span></pre></td></tr><tr><td scope="row"><pre>        //interface<span></span></pre></td></tr><tr><td scope="row"><pre>        plugInResult = (*plugInInterface)->QueryInterface(plugInInterface,<span></span></pre></td></tr><tr><td scope="row"><pre>                            CFUUIDGetUUIDBytes(kIOHIDDeviceInterfaceID),<span></span></pre></td></tr><tr><td scope="row"><pre>                            (LPVOID *) hidDeviceInterface);<span></span></pre></td></tr><tr><td scope="row"><pre>        print_errmsg_if_err(plugInResult != S_OK, "Couldn't create HID class device interface");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        (*plugInInterface)->Release(plugInInterface);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000105-BABGHGHH" title="Obtaining HID Cookies"></a><h2>Obtaining HID Cookies</h2><p>The following function, <code>getHIDCookies</code> (shown in <span class="content_text"><a href="workingwith.html#//apple_ref/doc/uid/TP30000105-CCHGABHB">Listing 3-3</a></span>), places certain cookies associated with the HID class device’s x axis, button 1, button 2, and button 3 into a data structure so the queue handling functions can add these elements to a queue.</p><a name="//apple_ref/doc/uid/TP30000105-CCHGABHB" title="Listing 3-3A function that stores selected cookies in global variables for later use"></a><p class="codesample"><strong>Listing 3-3&nbsp;&nbsp;</strong>A function that stores selected cookies in global variables for later use</p><div class="codesample"><table><tr><td scope="row"><pre>typedef struct cookie_struct<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>        IOHIDElementCookie gXAxisCookie;<span></span></pre></td></tr><tr><td scope="row"><pre>        IOHIDElementCookie gButton1Cookie;<span></span></pre></td></tr><tr><td scope="row"><pre>        IOHIDElementCookie gButton2Cookie;<span></span></pre></td></tr><tr><td scope="row"><pre>        IOHIDElementCookie gButton3Cookie;<span></span></pre></td></tr><tr><td scope="row"><pre>} *cookie_struct_t;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>cookie_struct_t getHIDCookies(IOHIDDeviceInterface122 **handle)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>        cookie_struct_t cookies = memset(malloc(sizeof(*cookies)), 0,<span></span></pre></td></tr><tr><td scope="row"><pre>            sizeof(*cookies));<span></span></pre></td></tr><tr><td scope="row"><pre>        CFTypeRef                               object;<span></span></pre></td></tr><tr><td scope="row"><pre>        long                                    number;<span></span></pre></td></tr><tr><td scope="row"><pre>        IOHIDElementCookie                      cookie;<span></span></pre></td></tr><tr><td scope="row"><pre>        long                                    usage;<span></span></pre></td></tr><tr><td scope="row"><pre>        long                                    usagePage;<span></span></pre></td></tr><tr><td scope="row"><pre>        CFArrayRef                              elements; //<span></span></pre></td></tr><tr><td scope="row"><pre>        CFDictionaryRef                         element;<span></span></pre></td></tr><tr><td scope="row"><pre>        IOReturn                                success;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if (!handle || !(*handle)) return cookies;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        // Copy all elements, since we're grabbing most of the elements<span></span></pre></td></tr><tr><td scope="row"><pre>        // for this device anyway, and thus, it's faster to iterate them<span></span></pre></td></tr><tr><td scope="row"><pre>        // ourselves. When grabbing only one or two elements, a matching<span></span></pre></td></tr><tr><td scope="row"><pre>        // dictionary should be passed in here instead of NULL.<span></span></pre></td></tr><tr><td scope="row"><pre>        success = (*handle)->copyMatchingElements(handle, NULL, &amp;elements);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        printf("LOOKING FOR ELEMENTS.\n");<span></span></pre></td></tr><tr><td scope="row"><pre>        if (success == kIOReturnSuccess) {<span></span></pre></td></tr><tr><td scope="row"><pre>                CFIndex i;<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("ITERATING...\n");<span></span></pre></td></tr><tr><td scope="row"><pre>                for (i=0; i&lt;CFArrayGetCount(elements); i++)<span></span></pre></td></tr><tr><td scope="row"><pre>                {<span></span></pre></td></tr><tr><td scope="row"><pre>                        element = CFArrayGetValueAtIndex(elements, i);<span></span></pre></td></tr><tr><td scope="row"><pre>                        // printf("GOT ELEMENT.\n");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                        //Get cookie<span></span></pre></td></tr><tr><td scope="row"><pre>                        object = (CFDictionaryGetValue(element,<span></span></pre></td></tr><tr><td scope="row"><pre>                            CFSTR(kIOHIDElementCookieKey)));<span></span></pre></td></tr><tr><td scope="row"><pre>                        if (object == 0 || CFGetTypeID(object) != CFNumberGetTypeID())<span></span></pre></td></tr><tr><td scope="row"><pre>                            continue;<span></span></pre></td></tr><tr><td scope="row"><pre>                        if(!CFNumberGetValue((CFNumberRef) object, kCFNumberLongType,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;number))<span></span></pre></td></tr><tr><td scope="row"><pre>                                continue;<span></span></pre></td></tr><tr><td scope="row"><pre>                        cookie = (IOHIDElementCookie) number;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                        //Get usage<span></span></pre></td></tr><tr><td scope="row"><pre>                        object = CFDictionaryGetValue(element, CFSTR(kIOHIDElementUsageKey));<span></span></pre></td></tr><tr><td scope="row"><pre>                        if (object == 0 || CFGetTypeID(object) != CFNumberGetTypeID())<span></span></pre></td></tr><tr><td scope="row"><pre>                            continue;<span></span></pre></td></tr><tr><td scope="row"><pre>                        if (!CFNumberGetValue((CFNumberRef) object, kCFNumberLongType,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;number))<span></span></pre></td></tr><tr><td scope="row"><pre>                                continue;<span></span></pre></td></tr><tr><td scope="row"><pre>                        usage = number;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                        //Get usage page<span></span></pre></td></tr><tr><td scope="row"><pre>                        object = CFDictionaryGetValue(element,<span></span></pre></td></tr><tr><td scope="row"><pre>                            CFSTR(kIOHIDElementUsagePageKey));<span></span></pre></td></tr><tr><td scope="row"><pre>                        if (object == 0 || CFGetTypeID(object) != CFNumberGetTypeID())<span></span></pre></td></tr><tr><td scope="row"><pre>                            continue;<span></span></pre></td></tr><tr><td scope="row"><pre>                        if (!CFNumberGetValue((CFNumberRef) object, kCFNumberLongType,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;number))<span></span></pre></td></tr><tr><td scope="row"><pre>                                continue;<span></span></pre></td></tr><tr><td scope="row"><pre>                        usagePage = number;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                        //Check for x axis<span></span></pre></td></tr><tr><td scope="row"><pre>                        if (usage == 0x30 &amp;&amp; usagePage == 0x01)<span></span></pre></td></tr><tr><td scope="row"><pre>                            cookies->gXAxisCookie = cookie;<span></span></pre></td></tr><tr><td scope="row"><pre>                        //Check for buttons<span></span></pre></td></tr><tr><td scope="row"><pre>                        else if (usage == 0x01 &amp;&amp; usagePage == 0x09)<span></span></pre></td></tr><tr><td scope="row"><pre>                            cookies->gButton1Cookie = cookie;<span></span></pre></td></tr><tr><td scope="row"><pre>                        else if (usage == 0x02 &amp;&amp; usagePage == 0x09)<span></span></pre></td></tr><tr><td scope="row"><pre>                            cookies->gButton2Cookie = cookie;<span></span></pre></td></tr><tr><td scope="row"><pre>                        else if (usage == 0x03 &amp;&amp; usagePage == 0x09)<span></span></pre></td></tr><tr><td scope="row"><pre>                            cookies->gButton3Cookie = cookie;<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("DONE.\n");<span></span></pre></td></tr><tr><td scope="row"><pre>        } else {<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("copyMatchingElements failed with error %d\n", success);<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        return cookies;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>	<a name="//apple_ref/doc/uid/TP30000105-CCHJGDBH" title="Performing Operations on a HID Class Device"></a><h2>Performing Operations on a HID Class Device</h2><p>Once you have found a HID class device in the I/O Registry and created a device interface for it, you can perform operations such as:</p><ul class="ul"><li class="li"><p>opening the device</p></li><li class="li"><p>getting element values</p></li><li class="li"><p>creating and manipulating queues</p></li><li class="li"><p>closing the device</p></li></ul><p>The sample code in this section performs these types of operations through the test function <code>MyTestHIDDeviceInterface</code>, shown in <span class="content_text"><a href="workingwith.html#//apple_ref/doc/uid/TP30000105-CCHGAHCF">Listing 3-4</a></span>. This function is passed a HID class device interface and it first calls the device interface function <code>open</code> to open the device. Next, it calls <code>MyTestQueues</code>, shown in <span class="content_text"><a href="workingwith.html#//apple_ref/doc/uid/TP30000105-CCHBFIGD">Listing 3-5</a></span>, to create and manipulate a queue. Then, it calls <code>MyTestHIDInterface</code> to get various element values and print them. Finally, it closes the device by calling the device interface function <code>close</code>.</p><a name="//apple_ref/doc/uid/TP30000105-CCHGAHCF" title="Listing 3-4A function that performs testing on a passed HID class device interface"></a><p class="codesample"><strong>Listing 3-4&nbsp;&nbsp;</strong>A function that performs testing on a passed HID class device interface</p><div class="codesample"><table><tr><td scope="row"><pre>static void MyTestHIDDeviceInterface(IOHIDDeviceInterface **hidDeviceInterface, cookie_struct_t cookies)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>        IOReturn ioReturnValue = kIOReturnSuccess;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        //open the device<span></span></pre></td></tr><tr><td scope="row"><pre>        ioReturnValue = (*hidDeviceInterface)->open(hidDeviceInterface, 0);<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("Open result = %d\n", ioReturnValue);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        //test queue interface<span></span></pre></td></tr><tr><td scope="row"><pre>        MyTestQueues(hidDeviceInterface, cookies);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        //test the interface<span></span></pre></td></tr><tr><td scope="row"><pre>        MyTestHIDInterface(hidDeviceInterface, cookies);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        //close the device<span></span></pre></td></tr><tr><td scope="row"><pre>        if (ioReturnValue == KERN_SUCCESS)<span></span></pre></td></tr><tr><td scope="row"><pre>                ioReturnValue = (*hidDeviceInterface)->close(hidDeviceInterface);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        //release the interface<span></span></pre></td></tr><tr><td scope="row"><pre>        (*hidDeviceInterface)->Release(hidDeviceInterface);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>	<p>The <code>MyTestQueues</code> function (shown in <span class="content_text"><a href="workingwith.html#//apple_ref/doc/uid/TP30000105-CCHBFIGD">Listing 3-5</a></span>) first calls the HID device interface function <code>allocQueue</code> to allocate a queue. Next, it uses the queue handling functions <code>addElement</code>, <code>hasElement</code>, and <code>removeElement</code> to add elements to the queue, check to see if an element is in the queue, and remove an element, respectively. Finally, <code>MyTestQueues</code> simulates a game loop by calling the <code>start</code> queue function to start data delivery to the queue and then repeatedly calling the <code>getNextEvent</code> queue function to retrieve the values for elements in the queue. All queue handling functions for HID class devices are defined in <code><a href="../../../../Darwin/Reference/IOKit/IOHIDLib_h/index.html#//apple_ref/doc/header/IOHIDLib.h" target="_top">IOHIDLib.h</a></code>.</p><a name="//apple_ref/doc/uid/TP30000105-CCHBFIGD" title="Listing 3-5A function to test the HID class device interface queue handling functions"></a><p class="codesample"><strong>Listing 3-5&nbsp;&nbsp;</strong>A function to test the HID class device interface queue handling functions</p><div class="codesample"><table><tr><td scope="row"><pre>static void MyTestQueues(IOHIDDeviceInterface **hidDeviceInterface, cookie_struct_t cookies)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>        HRESULT                                                 result;<span></span></pre></td></tr><tr><td scope="row"><pre>        IOHIDQueueInterface **                                          queue;<span></span></pre></td></tr><tr><td scope="row"><pre>        Boolean                                         hasElement;<span></span></pre></td></tr><tr><td scope="row"><pre>        long                                            index;<span></span></pre></td></tr><tr><td scope="row"><pre>        IOHIDEventStruct                                                event;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        queue = (*hidDeviceInterface)->allocQueue(hidDeviceInterface);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if (queue)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("Queue allocated: %lx\n", (long) queue);<span></span></pre></td></tr><tr><td scope="row"><pre>                //create the queue<span></span></pre></td></tr><tr><td scope="row"><pre>                result = (*queue)->create(queue, 0, 8);<span></span></pre></td></tr><tr><td scope="row"><pre>                    /*  depth (8): maximum number of elements in queue before oldest<span></span></pre></td></tr><tr><td scope="row"><pre>                        elements in queue begin to be lost.<span></span></pre></td></tr><tr><td scope="row"><pre>                     */<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("Queue create result: %lx\n", result);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                //add elements to the queue<span></span></pre></td></tr><tr><td scope="row"><pre>                result = (*queue)->addElement(queue, cookies->gXAxisCookie, 0);<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("Queue added x axis result: %lx\n", result);<span></span></pre></td></tr><tr><td scope="row"><pre>                result = (*queue)->addElement(queue, cookies->gButton1Cookie, 0);<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("Queue added button 1 result: %lx\n", result);<span></span></pre></td></tr><tr><td scope="row"><pre>                result = (*queue)->addElement(queue, cookies->gButton2Cookie, 0);<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("Queue added button 2 result: %lx\n", result);<span></span></pre></td></tr><tr><td scope="row"><pre>                result = (*queue)->addElement(queue, cookies->gButton3Cookie, 0);<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("Queue added button 3 result: %lx\n", result);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                //check to see if button 3 is in queue<span></span></pre></td></tr><tr><td scope="row"><pre>                hasElement = (*queue)->hasElement(queue,cookies->gButton3Cookie);<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("Queue has button 3 result: %s\n", hasElement ? "true" :<span></span></pre></td></tr><tr><td scope="row"><pre>                    "false");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                //remove button 3 from queue<span></span></pre></td></tr><tr><td scope="row"><pre>                result = (*queue)->removeElement(queue, cookies->gButton3Cookie);<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("Queue remove button 3 result: %lx\n",result);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                //start data delivery to queue<span></span></pre></td></tr><tr><td scope="row"><pre>                result = (*queue)->start(queue);<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("Queue start result: %lx\n", result);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                //check queue a few times to see accumulated events<span></span></pre></td></tr><tr><td scope="row"><pre>                sleep(1);<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("Checking queue\n");<span></span></pre></td></tr><tr><td scope="row"><pre>                for (index = 0; index &lt; 10; index++)<span></span></pre></td></tr><tr><td scope="row"><pre>                {<span></span></pre></td></tr><tr><td scope="row"><pre>                        AbsoluteTime                            zeroTime = {0,0};<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                        result = (*queue)->getNextEvent(queue, &amp;event, zeroTime, 0);<span></span></pre></td></tr><tr><td scope="row"><pre>                        if (result)<span></span></pre></td></tr><tr><td scope="row"><pre>                                printf("Queue getNextEvent result: %lx\n", result);<span></span></pre></td></tr><tr><td scope="row"><pre>                        else<span></span></pre></td></tr><tr><td scope="row"><pre>                                printf("Queue: event:[%lx] %ld\n",<span></span></pre></td></tr><tr><td scope="row"><pre>                                                                (unsigned long) event.elementCookie,<span></span></pre></td></tr><tr><td scope="row"><pre>                                                                event.value);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                        sleep(1);<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                //stop data delivery to queue<span></span></pre></td></tr><tr><td scope="row"><pre>                result = (*queue)->stop(queue);<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("Queue stop result: %lx\n", result);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                //dispose of queue<span></span></pre></td></tr><tr><td scope="row"><pre>                result = (*queue)->dispose(queue);<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("Queue dispose result: %lx\n", result);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                //release the queue we allocated<span></span></pre></td></tr><tr><td scope="row"><pre>                (*queue)->Release(queue);<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>	<p>The <code>MyTestHIDInterface</code> function uses the passed-in HID device interface to call the device interface <code>getElement</code> function to get the element values associated with the cookies stored in the global variables <code>gXAxisCookie</code>, <code>gButton1Cookie</code>, <code>gButton2Cookie</code>, and <code>gButton3Cookie</code> by <code>getHIDCookies</code><code></code> (shown in <span class="content_text"><a href="workingwith.html#//apple_ref/doc/uid/TP30000105-CCHGABHB">Listing 3-3</a></span>). The sample code simulates a game loop by repeatedly calling <code>getElementValue</code> in a <code>for</code> loop.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000105-DontLinkElementID_12" title="Note"></a><p><strong>Note:</strong>&nbsp;HID device interfaces have two functions, <code>getElementValue</code> and <code><!--a-->queryElementvalue<!--/a--></code>. They behave in subtly different ways, and should not be confused, for performance reasons.</p>The function <code>getElementValue</code> should be used for elements associated with inputs (button presses, for example). These values are typically sent whenever the value changes via interrupt reports. Thus, the HID stack will return the last value sent by the device.</p>The function <code><!--a-->queryElementvalue<!--/a--></code> should be used only for “feature” elements. Since these elements do not trigger an interrupt, their values must be manually polled from the device.</p></div><a name="//apple_ref/doc/uid/TP30000105-SW1" title="Listing 3-6A function that uses HID class device interface functions to get and display selected element values over time"></a><p class="codesample"><strong>Listing 3-6&nbsp;&nbsp;</strong>A function that uses HID class device interface functions to get and display selected element values over time</p><div class="codesample"><table><tr><td scope="row"><pre>static void MyTestHIDInterface(IOHIDDeviceInterface ** hidDeviceInterface, cookie_struct_t cookies)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>        HRESULT                                 result;<span></span></pre></td></tr><tr><td scope="row"><pre>        IOHIDEventStruct                                        hidEvent;<span></span></pre></td></tr><tr><td scope="row"><pre>        long                                    index;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        printf("X Axis (%lx), Button 1 (%lx), Button 2 (%lx), Button 3 ($lx)\n",<span></span></pre></td></tr><tr><td scope="row"><pre>                        (long) cookies->gXAxisCookie, (long) cookies->gButton1Cookie,<span></span></pre></td></tr><tr><td scope="row"><pre>                        (long) cookies->gButton2Cookie, (long) cookies->gButton3Cookie);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        for (index = 0; index &lt; 10; index++)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>                long xAxis, button1, button2, button3;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                //Get x axis<span></span></pre></td></tr><tr><td scope="row"><pre>                result = (*hidDeviceInterface)->getElementValue(hidDeviceInterface,<span></span></pre></td></tr><tr><td scope="row"><pre>                    cookies->gXAxisCookie, &amp;hidEvent);<span></span></pre></td></tr><tr><td scope="row"><pre>                if (result)<span></span></pre></td></tr><tr><td scope="row"><pre>                     printf("getElementValue error = %lx", result);<span></span></pre></td></tr><tr><td scope="row"><pre>                xAxis = hidEvent.value;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                //Get button 1<span></span></pre></td></tr><tr><td scope="row"><pre>                result = (*hidDeviceInterface)->getElementValue(hidDeviceInterface,<span></span></pre></td></tr><tr><td scope="row"><pre>                    cookies->gButton1Cookie, &amp;hidEvent);<span></span></pre></td></tr><tr><td scope="row"><pre>                if (result)<span></span></pre></td></tr><tr><td scope="row"><pre>                     printf("getElementValue error = %lx", result);<span></span></pre></td></tr><tr><td scope="row"><pre>                button1 = hidEvent.value;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                //Get button 2<span></span></pre></td></tr><tr><td scope="row"><pre>                result = (*hidDeviceInterface)->getElementValue(hidDeviceInterface,<span></span></pre></td></tr><tr><td scope="row"><pre>                    cookies->gButton2Cookie, &amp;hidEvent);<span></span></pre></td></tr><tr><td scope="row"><pre>                if (result)<span></span></pre></td></tr><tr><td scope="row"><pre>                     printf("getElementValue error = %lx", result);<span></span></pre></td></tr><tr><td scope="row"><pre>                button2 = hidEvent.value;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                //Get button 3<span></span></pre></td></tr><tr><td scope="row"><pre>                result = (*hidDeviceInterface)->getElementValue(hidDeviceInterface,<span></span></pre></td></tr><tr><td scope="row"><pre>                    cookies->gButton3Cookie, &amp;hidEvent);<span></span></pre></td></tr><tr><td scope="row"><pre>                if (result)<span></span></pre></td></tr><tr><td scope="row"><pre>                     printf("getElementValue error = %lx", result);<span></span></pre></td></tr><tr><td scope="row"><pre>                button3 = hidEvent.value;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                //Print values<span></span></pre></td></tr><tr><td scope="row"><pre>                printf("%ld %s%s%s\n", xAxis, button1 ? "button1 " : "",<span></span></pre></td></tr><tr><td scope="row"><pre>                                button2 ? "button2 " : "", button3 ? "button3 " : "");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                sleep(1);<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>	<a name="//apple_ref/doc/uid/TP30000105-BABHBEBJ" title="Using Queue Callbacks"></a><h2>Using Queue Callbacks</h2><p>There are two basic ways of using queues when interacting with HID devices: polling and callbacks. In <span class="content_text"><a href="workingwith.html#//apple_ref/doc/uid/TP30000105-CCHBFIGD">Listing 3-5</a></span>, queues are accessed in a polled fashion. The example project “hidexample” uses this mechanism.</p><p>For performance reasons (and for programming convenience), it often makes more sense to use queue callbacks. In this usage, a function in your program is called whenever the queue becomes non-empty.</p><p>The code snippet is relatively straightforward. Essentially, you allocate a private data structure that contains a reference to the queue, create an asynchronous event source for the queue, add a queue callback handler, and finally, add the newly-created queue event source to your run loop.</p><p>The queue callback is passed two <code>void *</code> parameters, <code>callbackRefcon</code> and <code>callbackTarget</code>, both of which can contain pointers to arbitrary data. With this design, the same callback function can operate on multiple queues, feeding data to multiple class instances, simply by passing different queue and class pointers to the <code><!--a-->setEventCallout<!--/a--></code> function.</p><p>In <span class="content_text"><a href="workingwith.html#//apple_ref/doc/uid/TP30000105-BABBHJCA">Listing 3-7</a></span>, the <code>callbackTarget</code> parameter will be passed <code>NULL</code>, and the <code>callbackRefcon</code> parameter will be passed a dynamically-allocated object containining the <code>hidQueueInterface</code> pointer (just for grins).</p><a name="//apple_ref/doc/uid/TP30000105-BABBHJCA" title="Listing 3-7Adding a Queue Callback"></a><p class="codesample"><strong>Listing 3-7&nbsp;&nbsp;</strong>Adding a Queue Callback</p><div class="codesample"><table><tr><td scope="row"><pre>bool addQueueCallbacks(IOHIDQueueInterface **hidQueueInterface)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    IOReturn ret;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFRunLoopSourceRef eventSource;<span></span></pre></td></tr><tr><td scope="row"><pre>    /*  We could use any data structure here. This data structure<span></span></pre></td></tr><tr><td scope="row"><pre>        will be passed to the callback, and should probably<span></span></pre></td></tr><tr><td scope="row"><pre>        include some information about the queue, assuming your<span></span></pre></td></tr><tr><td scope="row"><pre>        program deals with more than one. */<span></span></pre></td></tr><tr><td scope="row"><pre>    IOHIDQueueInterface ***myPrivateData = malloc(sizeof(*myPrivateData));<span></span></pre></td></tr><tr><td scope="row"><pre>    *myPrivateData = hidQueueInterface;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // In the calling function, we did something like:<span></span></pre></td></tr><tr><td scope="row"><pre>    // hidQueueInterface = (*hidDeviceInterface)-><span></span></pre></td></tr><tr><td scope="row"><pre>    //      allocQueue(hidDeviceInterface);<span></span></pre></td></tr><tr><td scope="row"><pre>    // (*hidQueueInterface)->create(hidQueueInterface, 0, 8);<span></span></pre></td></tr><tr><td scope="row"><pre>    ret = (*hidQueueInterface)-><span></span></pre></td></tr><tr><td scope="row"><pre>        createAsyncEventSource(hidQueueInterface,<span></span></pre></td></tr><tr><td scope="row"><pre>        &amp;eventSource);<span></span></pre></td></tr><tr><td scope="row"><pre>    if ( ret != kIOReturnSuccess )<span></span></pre></td></tr><tr><td scope="row"><pre>        return false;<span></span></pre></td></tr><tr><td scope="row"><pre>    ret = (*hidQueueInterface)-><span></span></pre></td></tr><tr><td scope="row"><pre>        setEventCallout(hidQueueInterface,<span></span></pre></td></tr><tr><td scope="row"><pre>        QueueCallbackFunction, NULL, myPrivateData);<span></span></pre></td></tr><tr><td scope="row"><pre>    if ( ret != kIOReturnSuccess )<span></span></pre></td></tr><tr><td scope="row"><pre>        return false;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFRunLoopAddSource(CFRunLoopGetCurrent(), eventSource,<span></span></pre></td></tr><tr><td scope="row"><pre>        kCFRunLoopDefaultMode);<span></span></pre></td></tr><tr><td scope="row"><pre>    return true;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>The final example in this section is taken from the “HidTestTool” example. This snippet shows how to handle a queue callback. This code is structurally somewhat different in that a data structure is passed as the <code>refcon</code> argument. This allows it to pass in both information about the queue and information about the elements supported by a given HID device.</p><a name="//apple_ref/doc/uid/TP30000105-SW2" title="Listing 3-8A Basic Queue Callback Function"></a><p class="codesample"><strong>Listing 3-8&nbsp;&nbsp;</strong>A Basic Queue Callback Function</p><div class="codesample"><table><tr><td scope="row"><pre>static void QueueCallbackFunction(<span></span></pre></td></tr><tr><td scope="row"><pre>                            void *          target,<span></span></pre></td></tr><tr><td scope="row"><pre>                            IOReturn            result,<span></span></pre></td></tr><tr><td scope="row"><pre>                            void *          refcon,<span></span></pre></td></tr><tr><td scope="row"><pre>                            void *          sender)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    HIDDataRef          hidDataRef      = (HIDDataRef)refcon;<span></span></pre></td></tr><tr><td scope="row"><pre>    AbsoluteTime    zeroTime    = {0,0};<span></span></pre></td></tr><tr><td scope="row"><pre>    CFNumberRef     number      = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFMutableDataRef    element     = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    HIDElementRef   tempHIDElement  = NULL;//(HIDElementRef)refcon;<span></span></pre></td></tr><tr><td scope="row"><pre>    IOHIDEventStruct    event;<span></span></pre></td></tr><tr><td scope="row"><pre>    bool                change;<span></span></pre></td></tr><tr><td scope="row"><pre>    bool                stateChange = false;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if ( !hidDataRef || ( sender != hidDataRef->hidQueueInterface))<span></span></pre></td></tr><tr><td scope="row"><pre>        return;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    while (result == kIOReturnSuccess)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        result = (*hidDataRef->hidQueueInterface)->getNextEvent(<span></span></pre></td></tr><tr><td scope="row"><pre>                                        hidDataRef->hidQueueInterface,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        &amp;event,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        zeroTime,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        0);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if ( result != kIOReturnSuccess )<span></span></pre></td></tr><tr><td scope="row"><pre>            continue;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        // Only intersted in 32 values right now<span></span></pre></td></tr><tr><td scope="row"><pre>        if ((event.longValueSize != 0) &amp;&amp; (event.longValue != NULL))<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            free(event.longValue);<span></span></pre></td></tr><tr><td scope="row"><pre>            continue;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        number = CFNumberCreate(kCFAllocatorDefault, kCFNumberIntType,<span></span></pre></td></tr><tr><td scope="row"><pre>            &amp;event.elementCookie);<span></span></pre></td></tr><tr><td scope="row"><pre>        if ( !number )  continue;<span></span></pre></td></tr><tr><td scope="row"><pre>        element = (CFMutableDataRef)CFDictionaryGetValue(hidDataRef-><span></span></pre></td></tr><tr><td scope="row"><pre>            hidElementDictionary, number);<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(number);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if ( !element ||<span></span></pre></td></tr><tr><td scope="row"><pre>            !(tempHIDElement = (HIDElement *)CFDataGetMutableBytePtr(element)))<span></span></pre></td></tr><tr><td scope="row"><pre>            continue;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        change = (tempHIDElement->currentValue != event.value);<span></span></pre></td></tr><tr><td scope="row"><pre>        tempHIDElement->currentValue = event.value;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>	

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../basics/basics.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../samples/samples.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2001, 2009 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2009-05-06<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/DeviceDrivers/Conceptual/HID/workingwith/workingwith.html%3Fid%3DTP40000970-3.7&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/DeviceDrivers/Conceptual/HID/workingwith/workingwith.html%3Fid%3DTP40000970-3.7&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/DeviceDrivers/Conceptual/HID/workingwith/workingwith.html%3Fid%3DTP40000970-3.7&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>