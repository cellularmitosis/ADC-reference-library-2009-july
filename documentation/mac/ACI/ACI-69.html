<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Embedding Profiles and Profile Identifiers</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING69></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->




<!-- Main Body -->

<CENTER>
<P>
<A HREF="ACI-68.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="ACI-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="ACI-122.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="ACI-70.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="ACI-2.html"><B>Advanced Color Imaging on the Mac OS</B></A> / <BR><DD><A HREF="ACI-55.html"><B>Chapter 4 - Developing ColorSync-Supportive Applications</B></A> / <A HREF="ACI-60.html"><B>Developing Your ColorSync-Supportive Application</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING69-0></A>
<H2><A NAME=MARKER-9-91></A>Embedding Profiles and Profile Identifiers</H2>
 <A NAME=MARKER-2-92></A>When the user creates and saves a document or picture containing a color image created or modified with your application, your application can provide for future color matching by saving--along with that document or picture--the profile for the device on which the image was created or modified. In addition to a profile--or instead of a profile--your application can save a profile identifier. A <B>profile identifier</B> is an abbreviated data structure that identifies, and possibly specifies the rendering intent for, a profile in memory or on disk.<P>
 To get the system profile, your application can use the <CODE>CMGetSystemProfile</CODE> function described in <A HREF=ACI-65.html#MARKER-9-64>"Identifying the Current Default System Profile" (page 4-20)</A> and in <A HREF=#nonexistent-marker>"ColorSync Manager Reference for Applications and Device Drivers"</A> in <I>Advanced Color Imaging Reference</I>. <A HREF=ACI-71.html#MARKER-9-127>"Searching for Profiles in the ColorSync(TM) Profiles Folder" (page 4-48)</A> describes other functions your application can use to search for device profiles.<P>
 When embedding source profiles or profile identifiers in the documents created by your application, you can store them in any manner that you choose. In the resource fork of the document file, for example, you may choose to have your application store one profile for an entire image, or a separate profile for every object in an image, or a separate profile identifier that points to a profile on disk for every device on which the user modified the image.<P>
 When embedding source profiles or profile identifiers in PICT file pictures, your application should use the <CODE>cmComment</CODE> picture comment, which has a <CODE>kind</CODE> value of 224 and is defined for embedded version 2.x profiles. This comment is followed by a 4-byte selector that describes the type of data in the comment. The following selectors are currently defined:
<TABLE BORDER="0" CELLPADDING=3><TH ALIGN=LEFT>Selector<TH>Value<TH>Description<TR>
<TD><CODE><A NAME=MARKER-13-98></A>cmBeginProfileSel</CODE><TD>0<TD>Beginning of a version 2.x profile. Profile data to follow.<TR>
<TD><CODE><A NAME=MARKER-13-100></A>cmContinueProfileSel</CODE><TD>1<TD>Continuation of version 2.x profile data. Profile data to follow.<TR>
<TD><CODE><A NAME=MARKER-13-101></A>cmEndProfileSel</CODE><TD>2<TD>End of version 2.x profile data. No profile data follows.<TR>
<TD>cmProfileIdentifierSel<TD>3<TD>Profile identifier follows. A profile identifier identifies a profile that may reside in memory or on disk.</TABLE>
<P>
 Because the <CODE>dataSize</CODE> parameter of the <CODE>PicComment</CODE> procedure is a signed 16-bit value, the maximum amount of profile data that can be embedded in a single picture comment is 32,763 bytes (32,767 - 4 bytes for the selector).<P>
 You can embed a larger profile by using multiple picture comments of selector type <CODE><A NAME=MARKER-13-100></A>cmContinueProfileSel</CODE>. You must embed the profile data in consecutive order, and you must conclude the profile data by embedding a picture comment of selector type <CODE><A NAME=MARKER-13-101></A>cmEndProfileSel</CODE>. The ColorSync Manager provides the <A NAME=MARKER-11-19></A><CODE>NCMUseProfileComment</CODE> function to automate the process of embedding profile information.<P>
<A NAME=HEADING69-7></A>
<H3>Embedded Profile Format</H3>
 <A HREF=#MARKER-9-102>Figure 4-7</A> shows how profile data is embedded in a PICT file picture as a series of picture comments. The illustration shows two embedded profiles. The first profile contains less than 32K of data, so its data can be stored in one picture comment with selector type <CODE><A NAME=MARKER-13-98></A>cmBeginProfileSel</CODE>. However, a second comment of selector type <CODE><A NAME=MARKER-13-101></A>cmEndProfileSel</CODE>, containing no data, concludes the embedded profile.<P>
 The second embedded profile shown in <A HREF=#MARKER-9-102>Figure 4-7</A> has more than 32K of data, so it's data must be stored in two consecutive picture comments. The first comment has selector type <CODE><A NAME=MARKER-13-98></A>cmBeginProfileSel</CODE>, while the second has type <CODE><A NAME=MARKER-13-100></A>cmContinueProfileSel</CODE>. If the profile were larger and required additional picture comments, each additional comment would have selector type <CODE><A NAME=MARKER-13-100></A>cmContinueProfileSel</CODE>. As with all embedded profiles, the final picture comment has selector type <CODE><A NAME=MARKER-13-101></A>cmEndProfileSel</CODE>.<P>
<B>Figure 4-7  <A NAME=MARKER-9-102></A>Embedding profile data in a PICT file picture</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/CSU-L-33.jpg">
<A NAME=HEADING69-12></A>
<H3>Embedding Different Profile Versions</H3>
 For version 1.0 of the ColorSync Manager, you use picture comment types <CODE>cmBeginProfile</CODE> and <CODE>cmEndProfile</CODE> to begin and end a picture comment. The <CODE>cmBeginProfile</CODE> comment is not supported for ColorSync Manager version 2.x profiles; however, you can use the <CODE>cmEndProfile</CODE> comment to end the current profile and begin using the system profile for both ColorSync 1.0 and 2.x. (Following a <CODE>cmEndProfile</CODE> comment, the ColorSync Manager reverts to the system profile.) You use the <CODE>cmEnableMatching</CODE> and <CODE>cmDisableMatching</CODE> picture comments to begin and end color matching in both ColorSync 1.0 and 2.x. See <a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><I>Inside Macintosh: Imaging With QuickDraw</I></a> for more information about picture comments.<P>
<A NAME=HEADING69-14></A>
<H3>The <A NAME=MARKER-11-19></A>NCMUseProfileComment Function</H3>
 The ColorSync Manager provides the <A NAME=MARKER-11-19></A><CODE>NCMUseProfileComment</CODE> function to automate the process of embedding a profile or profile identifier. This function generates the picture comments required to embed the specified profile or identifier into the open picture. It calls the QuickDraw <CODE>PicComment</CODE> function with a picture comment <CODE>kind</CODE> value of <CODE>cmComment</CODE> and a 4-byte selector that describes the type of data in the picture comment: cmBeginProfileSel to begin the profile, cmContinueProfileSel to continue, cmEndProfileSel to end the profile, or cmProfileIdentifierSel for a profile identifier. For a profile, if the size in bytes of the profile and the 4-byte selector together exceed 32 KB, this function segments the profile data and embeds the multiple segments in consecutive order using selector cmContinueProfileSel to embed each segment.<P>
 For embedded profiles or profile identifiers to work correctly, the currently effective profile must be terminated by a picture comment of <CODE>kind</CODE> <CODE>cmEndProfile</CODE> after drawing operations using that profile are performed. If you do not specify a picture comment to end the profile, the profile will remain in effect until the next embedded profile is introduced with a picture comment of <CODE>kind</CODE> <CODE>cmBeginProfile</CODE>. It is good practice to always pair use of the <CODE>cmBeginProfile</CODE> and <CODE>cmEndProfile</CODE> picture comments. When the ColorSync Manager encounters a <CODE>cmEndProfile</CODE> picture comment, it restores use of the system profile for matching until it encounters another <CODE>cmBeginProfile</CODE> picture comment.<P>
<DL>
<DT><B>IMPORTANT</B>
<DD>The <CODE>NCMUseProfileComment</CODE> function does not automatically terminate the embedded profile or profile identifier with a <CODE>cmEndProfile</CODE> picture comment. You must add a picture comment of <CODE>kind cmEndProfile</CODE> when the drawing operations to which the profile applies are complete. Otherwise, the profile remains in effect until the next embedded profile with a picture comment of <CODE>kind cmBeginProfile</CODE> is encountered.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 In addition to embedded profiles, an image may contain embedded profile identifiers, which are stored with the selector cmProfileIdentifierSel. For more information on profile identifiers, see <A HREF=ACI-77.html#MARKER-9-178>"Searching for a Profile That Matches a Profile Identifier" (page 4-75)</A>, and <A HREF=#nonexistent-marker>"Profile Identifier Structure"</A> in <I>Advanced Color Imaging Reference</I>. <P>
 <A HREF=#MARKER-9-105>Listing 4-6</A> shows how to embed a profile in a picture file. The <CODE>MyPreprendProfileToPicHandle</CODE> function creates a new picture, embeds the profile for the device used to create the picture, then draws the picture. The caller passes a reference for the profile as the <CODE>prof</CODE> parameter. After <CODE>MyPreprendProfileToPicHandle</CODE> calls the <CODE>NCMUseProfileComment</CODE> function to embed the profile, it calls its own <CODE>MyEndProfileComment</CODE> function to embed a comment of <CODE>kind</CODE> <CODE>cmEndProfile</CODE>, ensuring that the profile is properly terminated.<B></B><P>
<B>Listing 4-6  Embedding a profile by <A NAME=MARKER-9-105></A>prepending it before its associated picture</B><P>
<PRE>
CMError MyPrependProfileToPicHandle (
                        PicHandle pict,
                        PicHandle *pictNew,
                        CMProfileRef prof,
                        Boolean embedAsIdentifier)
{
   OSErr             err = noErr;
   CGrafPtr          savePort;
   GDHandle          saveGDev;
   GWorldPtr         smallOff;
   Rect              pictRect;
   unsigned long     flags;

   if (prof==nil)
      return paramErr;

   /* Determine whether to embed as identifier or whole profile */
   if (embedAsIdentifier)
      flags = cmEmbedProfileIdentifier;
   else
      flags = cmEmbedWholeProfile;

   /* create a temporary graphics world */
   err = NewSmallGWorld(&amp;smallOff);
   if (err)
      return err;
   
   GetGWorld(&amp;savePort, &amp;saveGDev);
   SetGWorld(smallOff, nil);
   pictRect = (**pict).picFrame;
   ClipRect(&amp;pictRect);       /* important: set clipRgn */

   /* create a new picture */
   *pictNew = OpenPicture(&amp;pictRect);/* start recording */
   err = NCMUseProfileComment(prof,flags);
   DrawPicture(pict, &amp;pictRect);
   MyEndProfileComment();     /* routine shown below */
   ClosePicture(); 
if (err)
      KillPicture(*pictNew);

   SetGWorld(savePort, saveGDev);
   DisposeGWorld(smallOff);

   return err;
}
</PRE>
 Here is the application-defined <CODE>MyEndProfileComment</CODE> function called by <A NAME=MARKER-11-106></A><A NAME=MARKER-2-107></A>MyPrependProfileToPicHandle to add the <CODE>cmEndProfile</CODE> picture comment to terminate the profile:<P>
<PRE>
void MyEndProfileComment (void)
{
   PicComment(cmEndProfile, 0, 0);
}
</PRE>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="ACI-68.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="ACI-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="ACI-122.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="ACI-70.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="ACI-3.html">&copy; Apple Computer, Inc.</A><br>13 NOV 1996<P>
<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->
</BODY>
</HTML> 
