<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html><head>
<!-- BEGIN META TAG INFO -->
<link rel="home" href="http://developer.apple.com/">
<link rel="find" href="http://developer.apple.com/search/">
<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
<script language="JavaScript" type="text/javascript" src="../../documentation/js/busnav.js"></script>
<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<!-- END META TAG INFO -->
<!-- BEGIN TITLE -->
<title>Technical Q&amp;A QA1242: Developing for VFS</title>
<!-- END TITLE -->
</head>
<!-- BEGIN BODY OPEN -->
<body bgcolor="#ffffff"><a name="//apple_ref/doc/uid/DTS10002278" title="Developing for VFS"></a>
<!--END BODY OPEN -->
<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->
<a name="top"></a>
<!-- BEGIN LOGO AND SEARCH -->
<!--#include virtual="/includes/adcnavbar"-->
<!-- END LOGO AND SEARCH -->
<!-- START BREADCRUMB -->
<div id="breadcrumb"><table width="680" border="0" cellpadding="0" cellspacing="0"><tr>
<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
<td><img width="340" height="10" src="images/1dot.gif" alt=""></td></tr><tr valign="middle"><td align="left" colspan="2">
<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/Darwin/index.html">Darwin</a> &gt; <a href="../../technicalqas/Darwin/idxFileManagement-date.html">File Management</a> &gt; 
</td></tr><tr><td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td></tr></table></div>
<!-- END BREADCRUMB -->

<!-- START MAIN CONTENT -->
<!-- START TITLE GRAPHIC AND INTRO-->
<table width="680" border="0" cellpadding="0" cellspacing="0"><tr align="left" valign="top">
<td><h1>
<div id="pagehead">Technical Q&amp;A QA1242</div>
<div id="pageheadsub">Developing for VFS</div>
</h1></td></tr></table>
<!-- END TITLE GRAPHIC AND INTRO -->
<!-- BEGIN WIDE COLUMN -->
<table width="680" border="0" cellpadding="0" cellspacing="0"><tr align="left" valign="top"><td align="left" width="680">
<!-- BEGIN CONTENTS -->
<h2>Q: Does Apple support the development of external file systems (VFS plug-ins) on Mac OS X?  Where can I find information about developing such a file system?</h2><p>A: The answer depends on what type of file system you're developing.</p><A NAME="SECLEAF"></A><H2>Leaf File Systems</H2><p>A <strong>leaf file system</strong> works independently of other file systems.  Leaf file systems include:</p><ul><li><p><strong>local file systems</strong> &mdash; These talk straight to a block storage device, which is typically attached to the computer directly (for example, an ATA hard disk).  HFS Plus is an example of a local file system.</p></li><li><p><strong>network file systems</strong> &mdash; A network file system translates each file system operation into the corresponding network commands and transmits those to a file server.  Mac OS X supports a number of network file systems, including AFP, NFS, and SMB/CIFS.</p></li><li><p><strong>cluster file systems</strong> &mdash; A cluster file system combines the previous two approaches, using network commands for metadata operations and block storage commands for data transfer (typically via a Storage Area Network, or SAN).  Xsan is Apple's cluster file system.</p></li></ul><p>Apple supports the development of leaf file systems for all versions of Mac OS X.  However, the rules have changed substantially, and for the better, in Mac OS X 10.4 Tiger.</p><p>Prior to the introduction of Mac OS X 10.4 Tiger, the BSD portions of the Mac OS X kernel were not architected for binary compatibility.  Implementing a VFS plug-in required intimate knowledge of the kernel's internals, and the resulting product embedded that knowledge, making it very brittle.  The slightest change to the kernel (reordering the fields within a structure, for example) would break all VFS plug-ins.</p><p>With Mac OS X 10.4 Tiger, Apple has solved this problem by introducing a VFS Kernel Programming Interface (KPI).  This KPI isolates your VFS plug-in from kernel changes.  For example, you no longer access fields in kernel structures directly; rather you call accessor functions that are supplied by the KPI.  By using this KPI you can develop a VFS plug-in with the expectation that it will be compatible with future systems.</p><p>This sounds like file system nirvana, right?  Alas, there are still a few things to worry about.</p><ul><li><p>There is no binary compatibility for VFS plug-ins between pre-10.4 systems and 10.4.  If your product has to support pre-10.4 systems, you have to develop and ship two VFS plug-ins: one for pre-10.4, and one for 10.4 and beyond.  There are ways to minimize the pain (for example, you can create an internal abstraction layer that isolates the bulk of your code from these differences), but no way to eliminate it entirely.</p></li><li><p>If you're porting a VFS plug-in to the Mac OS X 10.4 KPI from another UNIX platform, you will notice that certain well known UNIX kernel structures (such as <code>struct uio</code>) are now opaque.  That is, you can't directly access the fields of <code>struct uio</code>; you must call the appropriate accessor functions instead.</p><p>This change is a direct consequence of our binary compatibility requirement, but it can cause problems if you have a cross platform code base.  The only good solution is to change all of your code to use some form of macros to access these fields, and then define the macros appropriately for the platform.</p></li><li><p>Documentation for the VFS KPI is still rather rudimentary.  Apple will rectify this in the future <A HREF="rdar://problem/3524590">(r. 3524590)</A>; in the meantime, this Q&amp;A includes a list of references to documentation and other resources.</p></li></ul><p>If you're developing a VFS plug-in, you may find the following resources useful.</p><ul><li><p>Mac OS X's VFS architecture is derived from 4.4BSD.  &quot;The Design and Implementation of the 4.4BSD Operating System&quot; (ISBN: 0-201-54979-4) includes a good overview of VFS on that system. As there are key differences between 4.4BSD and Mac OS X (KPIs, the Unified Buffer Cache, changes to support HFS semantics, and more), you should not consider this book authoritative.</p></li><li><p>For general information about Mac OS X kernel programming, see the <A HREF="../../documentation/Darwin/Kernel-date.html">documentation</A> on the Apple developer web site.</p></li><li><p>There are a number of <A HREF="../../technicalqas/Darwin/idxFileManagement-date.html">DTS Q&amp;As</A> that cover VFS.  These Q&amp;As cover the most frequently encountered gotchas with VFS development on Mac OS X, and they're well worth a look.</p></li><li><p>The following VFS plug-ins were written specifically as sample code:</p><ul><li><p><A HREF="../../samplecode/EmptyFS/index.html">Sample Code Project 'EmptyFS'</A> is a very simple VFS plug-in; its volumes are completely empty (except for the root directory). The purpose of this sample is to create the minimal VFS plug-in that builds and runs. You can use EmptyFS to explore VFS behaviour, or as a template for your own VFS plug-in.</p></li><li><p><A HREF="../../samplecode/MFSLives/index.html">Sample Code Project 'MFSLives'</A> is a sample VFS plug-in that implements read-only access to the Macintosh File System (MFS) volume format. MFS is an excellent volume format for sample code because it's very simple but it allows you to exercise the code paths associated with Macintosh-specific metadata (specifically, Finder info, multi-fork files, and volfs).</p></li></ul></li><li><p>The source for a number of existing file systems is available in <A HREF="../../darwin/">Darwin</A> (the open source underpinnings of Mac OS X). I recommend the DOS/FAT file system (the &quot;msdosfs&quot; project) and the WebDAV file system (the &quot;webdavfs&quot; project).</p></li></ul><p>If you have technical questions, there are a variety of mailing lists for free community-based support (I recommend the <A HREF="http://www.lists.apple.com/darwin-kernel">darwin-kernel</A> mailing list) and Apple <A HREF="../../technicalsupport/index.html">Developer Technical Support</A> for paid support.</p><p><a href="#top">Back to Top</a>&nbsp;<a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p><A NAME="SECSTACKING"></A><H2>Stacking File Systems</H2><p>A <strong>stacking file system</strong> (sometimes called a <strong>filter file system</strong>) sits on top of another file system and modifies its behavior in some way.  The canonical example of a stacking file system is an encryption file system.  You could stack this file system on top of any existing file system to provide encryption support.</p><p>Apple does not support the development of stacking VFS plug-ins on Mac OS X <A HREF="rdar://problem/4383626">(r. 4383626)</A>.  We've taken this position because, in our opinion, it's not possible to create a stacking VFS plug-in that:</p><ul><li><p>works reliably</p></li><li><p>does not severely impinge on system performance</p></li><li><p>has any hope of binary (or even source-level) compatibility with future systems</p></li></ul><p>If you have a problem that can only be solved via a stacking file system, please let us know by mailing <A HREF="mailto:dts@apple.com">Developer Technical Support</A>.  While we can't support your development, we are interested in gathering information about what developers need and why.  This feedback will guide our long-term approach to this question.  We may also be able to suggest an alternative design that does not require stacking.</p><p>Finally, there are a number of third party developers who are working in this realm. If you are absolutely determined to develop an unsupported stacking VFS plug-in, you will find some help on the Internet.</p><div class="notebox"><p><strong>Note:</strong> Earlier Apple documentation stated that stacking VFS plug-ins could be used to solve certain problems, such as file-level encryption and virus checking. We even went so far as to publish an example of this, the Politically Correct file system (PCFS), that ran on pre-release builds of Mac OS X. Subsequent experience has shown that this technique does not work properly and we no longer support it. Thus, we have removed all references to stacking VFS from our documentation and we will not publish an update to PCFS. The existing PCFS source code is not useful because it has not been updated to support the Unified Buffer Cache.</p></div><p><a href="#top">Back to Top</a>&nbsp;<a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p><A NAME="SECALTERNATIVES"></A><H2>Alternatives</H2><p>Developing a VFS plug-in for Mac OS X is hard.  There are a number of factors that contribute to the difficulty:</p><ul><li><p>File systems are inherently complex.</p></li><li><p>File systems must be very reliable.</p></li><li><p>Your code is executed within the kernel, which is a more difficult programming environment than user space.</p></li><li><p>Your file system can be accessed by all applications, which make compatibility engineering and testing difficult.</p></li></ul><p>All-in-all, it's much better if you can avoid developing a file system.  Moreover, if you must develop a file system, it's better if you can push as much of that development into user space as possible.</p><p>There are two well known techniques for minimising the amount of kernel code that you have to write.</p><ul><li><p><strong>NFS server</strong> &mdash; You can avoid writing any kernel code by writing a local NFS server, running it on the user's computer, and then using Apple's built-in NFS client to mount that server in the file system hierarchy.  While it might seem convoluted, this approach is relatively simple and effective: Apple uses it to implement the automount and FTP file systems.</p><p>Because of the multiple round trips in and out of the kernel, this approach is not appropriate for a data- or metadata-intensive file system.</p></li><li><p><strong>kernel/user hybrid</strong> &mdash; This approach places the bulk of the code in a user space daemon, with an in-kernel stub file system that redirects requests to the daemon.  This is how Apple's WebDAV file system works.  It has the advantage that you get total control over how your file system appears to the user, while keeping most of the code in user space.</p><p>A hybrid approach is also more suited to performance sensitive applications because you choose which data (or metadata) is generated (or cached) by the kernel, and which is left up to the daemon.  The WebDAV file system has a particularly interesting take on this: in WebDAV the daemon caches data in files on the local hard disk, and the kernel stub can service read and write requests directly from those files.</p></li></ul><p>Finally, Mac OS X provides specific APIs to solve problems that might otherwise require a stacking file system.</p><ul><li><p>I/O Media filter scheme drivers can be used to implement block-level encryption.  While this isn't an exact replacement for a stacked encryption file system (each has its own advantages and disadvantages), it goes a long way towards meeting the user-level goal.</p><p>See <A HREF="../../samplecode/SampleFilterScheme/index.html">Sample Code Project 'SampleFilterScheme'</A> for an example of how to do this.</p></li><li><p>Mac OS X 10.4 introduces a new KPI, Kernel Authorization (or Kauth), which can be used to implement an anti-virus file scanner.  Kauth is documented in <A HREF="../../technotes/tn2005/tn2127.html">Technical Note TN2127, 'Kernel Authorization'</A>, with its associated <A HREF="../../samplecode/KauthORama/index.html">Sample Code Project 'KauthORama'</A>.</p></li></ul><p><a href="#top">Back to Top</a>&nbsp;<a href="#top"><img src="images/arrow_linkup.gif" height="7" width="10" border="0" alt=""></a></p><A NAME="TNT_HISTORY_TAG"></A><H2>Document Revision History</H2><table cellspacing="0" class="graybox" width="680"><tr><th width="100">Date</th><th width="580">Notes</th></tr><tr><td scope="row">2006-12-22</td><td>Added links to EmptyFS and MFSLives, and the Kauth documentation and sample code. Added a bug number for VFS documentation.</td></tr><tr><td scope="row">2006-03-16</td><td>Added bug number to track stacking VFS requirement.</td></tr><tr><td scope="row">2005-05-24</td><td>Update for Mac OS X 10.4 Tiger.</td></tr><tr><td scope="row">2003-03-26</td><td>Describes Apple's position on developing external file systems (VFS plug-ins) for Mac OS X.</td></tr></table><p><b>Posted:</b> 2006-12-22</p>
<!-- END CONTENTS -->
</td></tr></table>
<!-- END WIDE COLUMN -->
<!-- END MAIN CONTENT -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/qa2001/qa1242.html%3Fid%3DDTS10002278-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/qa2001/qa1242.html%3Fid%3DDTS10002278-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/qa2001/qa1242.html%3Fid%3DDTS10002278-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

<!-- START BOTTOM APPLE NAVIGATION -->
<!--#include virtual="/includes/footer"-->
<!-- END BOTTOM APPLE NAVIGATION -->
<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->
</body></html>