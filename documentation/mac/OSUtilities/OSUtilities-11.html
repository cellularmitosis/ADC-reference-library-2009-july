
<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Using the Gestalt Manager (IM: U)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING11></A>



<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="OSUtilities-10.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="OSUtilities-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="OSUtilities-222.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="OSUtilities-12.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="OSUtilities-2.html"><B>Operating System Utilities</B></A> / <BR><DD><A HREF="OSUtilities-9.html"><B>Chapter 1 - Gestalt Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING11-0></A>
<H1><A NAME=MARKER-21-418></A><A NAME=MARKER-21-419></A><A NAME=MARKER-9-420></A><A NAME=MARKER-21-421></A>Using the Gestalt Manager</H1>
 The Gestalt Manager includes three functions--<CODE>Gestalt</CODE>, <CODE>NewGestalt</CODE>, and <CODE>ReplaceGestalt</CODE>. You can use the <CODE>Gestalt</CODE> function to get information about hardware or software components available on the current machine. You can use <CODE>NewGestalt</CODE> to register new software modules (such as drivers and patches) with the Gestalt Manager. You can use <CODE>ReplaceGestalt</CODE> to replace the function associated with a particular selector code.<P>
<DL>
<DT><B>Note</B>
<DD><A NAME=MARKER-9-422></A>Most applications do not need to use either <CODE>NewGestalt</CODE> or <CODE>ReplaceGestalt</CODE>.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 If the Gestalt Manager is not present, you can get a brief description of the operating environment by calling the <CODE>SysEnvirons</CODE> function.<P>
<A NAME=HEADING11-4></A>
<H2><A NAME=MARKER-9-423></A><A NAME=MARKER-21-424></A>Determining Whether the Gestalt Manager Is Available</H2>
 <A NAME=MARKER-2-91></A><A NAME=MARKER-9-38></A>Versions 3.2 and later of MPW provide glue routines that allow you to call the Gestalt Manager functions even if they're not in ROM or in the System file (that is, if your application is running under a system software version earlier than 6.0.4). In assembly language, however, and possibly in other development environments, you must verify that the Gestalt Manager is available before you use it.<P>
 You can verify that the <CODE>Gestalt</CODE> function is available by calling the function <CODE>NGetTrapAddress</CODE>, specifying the trap number of <CODE>Gestalt</CODE>, and comparing the result with the address of the code that is executed when you invoke an unimplemented instruction. If <CODE>Gestalt</CODE> is available, you can safely assume that <CODE>NewGestalt</CODE> and <CODE>ReplaceGestalt</CODE> are also available. For efficiency, you might want to define a global Boolean variable that you can set at the beginning of your program. <A HREF=#MARKER-9-427>Listing 1-1</A> illustrates a test that sets the variable <CODE>gHasGestalt</CODE>.<P>
<B>Listing 1-1  <A NAME=MARKER-9-427></A><A NAME=MARKER-21-428></A>Determining whether <EM>Gestalt</EM> is available</B><P>
<PRE>
gHasGestalt := MySWRoutineAvailable(_Gestalt);
</PRE>
 For a sample definition of the application-defined function <CODE>MySWRoutineAvailable</CODE>, see the chapter "Trap Manager" later in this book.<A NAME=MARKER-2-429></A><A NAME=MARKER-2-92></A><P>
<A NAME=HEADING11-10></A>
<H2><A NAME=MARKER-9-431></A><A NAME=MARKER-21-432></A>Getting Information About the Operating Environment</H2>
 When your application needs information about a software or hardware feature, it calls the <CODE>Gestalt</CODE> function, which has this interface:<P>
<PRE>
FUNCTION Gestalt (selector: OSType; VAR response: LongInt): OSErr;
</PRE>
 The first parameter is a selector code, which specifies the kind of information your application needs. You can use any of the Apple-defined selector codes listed later in this section and described in more detail in the section <A HREF=OSUtilities-13.html#MARKER-9-463>"Constants" beginning on page 1-14</A>. You can also define and register your own selector codes using the <CODE>NewGestalt</CODE> function (as described in <A HREF=#MARKER-9-446>"Adding a New Selector Code" beginning on page 1-10</A>), and you can use selector codes defined and registered by other applications.<A NAME=MARKER-9-97></A><A NAME=MARKER-2-5></A><A NAME=MARKER-2-123></A><P>
 If <CODE>Gestalt</CODE> can determine the requested information, it returns that information in the <CODE>response</CODE> parameter and returns a result code of <CODE>noErr</CODE>. If Gestalt cannot obtain the information, it returns a result code indicating the cause of the error; in that case, the value of the <CODE>response</CODE> parameter is undefined. You should always check the result code returned by <CODE>Gestalt</CODE> to make sure that the <CODE>response</CODE> parameter contains meaningful information.<A NAME=MARKER-2-37></A><P>
 <A HREF=#MARKER-9-437>Listing 1-2</A> illustrates an application-defined function that retrieves the sound attributes of the current operating environment. The application-defined <CODE>MyGetSoundAttr</CODE> function checks the function result returned by <CODE>Gestalt</CODE> and passes any calls with a nonzero result code to an error-handling routine.<P>
<B>Listing 1-2  <A NAME=MARKER-9-437></A><A NAME=MARKER-21-438></A>Calling <EM>Gestalt</EM> and checking its result code</B><P>
<PRE>
FUNCTION MyGetSoundAttr: LongInt;
VAR
   myErr:   OSErr;
   myAttr:  LongInt;
BEGIN
   IF gHasGestalt THEN
   BEGIN
      myErr := Gestalt(gestaltSoundAttr, myAttr);
      IF myErr &lt;&gt; noErr THEN        {Gestalt failed}
         DoError(myErr)
   END
   ELSE
      myAttr := 0;                  {Gestalt not available}
   MyGetSoundAttr := myAttr;
END;
</PRE>
 You get different kinds of information from <CODE>Gestalt</CODE> by passing selectors from two kinds of Apple-defined selector codes: <P>
<UL>
<LI><B>environmental selectors</B>, which return information your application can use to guide its actions
<LI><B>informational selectors</B>, which return information that cannot be used to determine whether a feature is available<A NAME=MARKER-2-439></A><P>
</UL>
 It is particularly important that you understand the difference between environmental and informational selectors. The response returned by <CODE>Gestalt</CODE> when it is passed an informational selector is for your (or the user's) edification only; it should never be used by your application to determine whether a specific hardware or software feature is available. For example, you can use <CODE>Gestalt</CODE> to test for the version of the ROM installed on a particular machine. You can display this information to the user, but you should not infer from it anything about the actual software available. Routines you expect to be in ROM may actually be in RAM; hence, you cannot know that a routine usually found in ROM is not present simply because the ROM version predates the routine. Also, routines contained in ROM may have been patched by the system at startup time, in which case the system might not have the features you think it has on the basis of the reported ROM version. A Macintosh Plus with an old ROM, for example, could be running System 7. Similar remarks apply to other informational selectors, including ROM size, machine type, and System file version number.<P>
 To retrieve specific information about the hardware and software features available, you can use the following environmental selectors:<A NAME=MARKER-0-5></A><P>
<PRE>
CONST
   gestaltAddressingModeAttr  = 'addr'; {addressing-mode attributes}
   gestaltAliasMgrAttr        = 'alis'; {Alias Manager attributes}
   gestaltAppleEventsAttr     = 'evnt'; {Apple events attributes}
   gestaltAppleTalkVersion    = 'atlk'; {old format AppleTalk version}
   gestaltATalkVersion        = 'atkv'; {new format AppleTalk version}
   gestaltAUXVersion          = 'a/ux'; {A/UX version, if present}
   gestaltCFMAttr             = 'cfrg'; {Code Fragment Manager attributes}
   gestaltCloseViewAttr       = 'BSDa'; {CloseView attributes}
   gestaltComponentMgr        = 'cpnt'; {Component Manager version}
   gestaltCompressionMgr      = 'icmp'; {Image Compression Manager version}
   gestaltConnMgrAttr         = 'conn'; {Connection Manager attributes}
   gestaltCRMAttr             = 'crm '; {Communication Resource Manager }
                                        { attributes}
   gestaltCTBVersion          = 'ctbv'; {Communication Toolbox version}
   gestaltDBAccessMgrAttr     = 'dbac'; {Data Access Manager attributes}
   gestaltDictionaryMgrAttr   = 'dict'; {Dictionary Manager attributes}
   gestaltDisplayMgrAttr      = 'dply'; {Display Manager atributes}
   gestaltDisplayMgrVers      = 'dplv'; {Display Manager version}
   gestaltDITLExtAttr         = 'ditl'; {Dialog Manager extensions}
   gestaltDragMgrAttr         = 'drag'; {Drag Manager attributes}
   gestaltEasyAccessAttr      = 'easy'; {Easy Access attributes}
   gestaltEditionMgrAttr      = 'edtn'; {Edition Manager attributes}
   gestaltExtToolboxTable     = 'xttt'; {Toolbox trap dispatch table info}
   gestaltFinderAttr          = 'fndr'; {Finder attributes}
   gestaltFindFolderAttr      = 'fold'; {FindFolder attributes}
   gestaltFirstSlotNumber     = 'slt1'; {first physical slot}
   gestaltFontMgrAttr         = 'font'; {Font Manager attributes}
   gestaltFPUType             = 'fpu '; {floating-point unit (FPU) type}
   gestaltFSAttr              = 'fs  '; {file system attributes}
   gestaltFXfrMgrAttr         = 'fxfr'; {File Transfer Manager attributes}
   gestaltHelpMgrAttr         = 'help'; {Help Manager attributes}
   gestaltIconUtilitiesAttr   = 'icon'; {Icon Utilities attributes}
   gestaltKeyboardType        = 'kbd '; {keyboard type code}
   gestaltLogicalPageSize     = 'pgsz'; {logical page size}
   gestaltLogicalRAMSize      = 'lram'; {logical RAM size}
   gestaltLowMemorySize       = 'lmem'; {size of low memory}
   gestaltMiscAttr            = 'misc'; {miscellaneous attributes}
   gestaltMixedModeVersion    = 'mixd'; {MixedMode version}
   gestaltMMUType             = 'mmu '; {MMU type}
   gestaltNativeCPUtype       = 'cput'; {native CPU type}
   gestaltNotificationMgrAttr = 'nmgr'; {Notification Manager attributes}
   gestaltNuBusConnectors     = 'sltc'; {NuBus connector bitmap}
   gestaltNuBusSlotCount      = 'nubs'; {number of logical NuBus slots}
   gestaltOSAttr              = 'os  '; {Operating System attributes}
   gestaltOSTable             = 'ostt'; {base address of Operating System }
                                        { trap dispatch table}
   gestaltParityAttr          = 'prty'; {parity attributes}
   gestaltPCXAttr             = 'pcxg'; {PC exchange attributes}
   gestaltPhysicalRAMSize     = 'ram '; {physical RAM size}
   gestaltPopupAttr           = 'pop!'; {pop-up 'CDEF' attributes}
   gestaltPowerMgrAttr        = 'powr'; {Power Manager attributes}
   gestaltPPCToolboxAttr      = 'ppc '; {Program-to-Program Communications }
                                        { (PPC) Toolbox attributes}
   gestaltProcessorType       = 'proc'; {microprocessor type code}
   gestaltQuickdrawFeatures   = 'qdrw'; {QuickDraw features}
   gestaltQuickdrawVersion    = 'qd  '; {QuickDraw version}
   gestaltQuickTimeVersion    = 'qtim'; {QuickTime version}
   gestaltRealTimeMgrAttr     = 'rtmr'; {Realtime Manager attributes}
   gestaltResourceMgrAttr     = 'rsrc'; {Resource Manager attributes}
   gestaltScrapMgrAttr        = 'scra'; {Scrap Manager attributes}
   gestaltScriptCount         = 'scr#'; {number of active script systems}
   gestaltScriptMgrVersion    = 'scri'; {Script Manager version}
   gestaltSerialAttr          = 'ser '; {serial hardware attributes}
   gestaltSlotAttr            = 'slot'; {slot attributes}
   gestaltSoundAttr           = 'snd '; {sound attributes}
   gestaltSpeechAttr          = 'ttsc'; {Speech Manager attributes}
   gestaltStandardFileAttr    = 'stdf'; {Standard File attributes}}
   gestaltStdNBPAttr          = 'nlup'; {StandardNBP attributes}
   gestaltSysArchitecture     = 'sysa'; {Native System Architecture}
   gestaltTEAttr              = 'teat'; {TextEdit attributes}
   gestaltTermMgrAttr         = 'term'; {Terminal Manager attributes}
   gestaltTextEditVersion     = 'te  '; {TextEdit version code}
   gestaltThreadMgrAttr       = 'thds'; {Thread Manager attributes}
   gestaltTimeMgrVersion      = 'tmgr'; {Time Manager version code}
   gestaltToolboxTable        = 'tbtt'; {base address of Toolbox trap }
                                        { dispatch table}
   gestaltTranslationAttr     = 'xlat'; {Translation Manager attributes}
   gestaltTSMgrVersion        = 'tsmv'; {Text Services Manager version}
   gestaltVersion             = 'vers'; {Gestalt version}
   gestaltVMAttr              = 'vm  '; {virtual memory attributes}
</PRE>
 The informational selectors are provided for your or the user's information only. You can display the information returned from these selectors, but you should never use this information as an indication of what hardware or software features may be available. You can use the following informational selectors:<A NAME=MARKER-2-60></A><P>
<PRE>
CONST
   gestaltHardwareAttr        = 'hdwr'; {hardware attributes}
   gestaltMachineIcon         = 'micn'; {machine 'ICON'/'cicn' resource ID}
   gestaltMachineType         = 'mach'; {Macintosh model code}
   gestaltROMSize             = 'rom '; {ROM size}
   gestaltROMVersion          = 'romv'; {ROM version}
   gestaltSystemVersion       = 'sysv'; {System file version number}
</PRE>
 For a description of the return values for these environmental and informational selectors, see the next section, <A HREF=#MARKER-9-442>"Interpreting Gestalt Responses,"</A> and the list of constants beginning on <A HREF=OSUtilities-13.html#MARKER-9-463>page 1-14</A>.<P>
<A NAME=HEADING11-27></A>
<H2><A NAME=MARKER-9-442></A><A NAME=MARKER-21-443></A>Interpreting Gestalt Responses</H2>
 The meaning of the value that <CODE>Gestalt</CODE> returns in the <CODE>response</CODE> parameter depends on the selector code with which it was called. For example, if you call <CODE>Gestalt</CODE> using the <CODE>gestaltTimeMgrVersion</CODE> selector, it returns a version code in the <CODE>response</CODE> parameter. In this case, a returned value of 3 indicates that the extended Time Manager is available.<P>
 In most cases, the last few characters in the selector's symbolic name form a suffix that indicates what type of value you can expect <CODE>Gestalt</CODE> to place in the <CODE>response</CODE> parameter. For example, if the suffix in a <CODE>Gestalt</CODE> selector is <CODE>Size</CODE>, then <CODE>Gestalt</CODE> returns a size in the <CODE>response</CODE> parameter. <A HREF=#MARKER-9-1>Table 1-1</A> lists the meaningful suffixes<A NAME=MARKER-2-7></A>.
<TABLE BORDER="0" CELLPADDING=3>
<CAPTION><A NAME=MARKER-9-1></A><B>Table 1-1  <EM>Gestalt</EM> selector suffixes and their meanings</B></CAPTION>
<TH>Suffix<TH>Returned value<TR>
<TD>Attr<TD>A range of 32 bits, the meanings of which are defined by a list of constants. Bit 0 is the least significant bit of the long word.<TR>
<TD>Count<TD>A number indicating how many of the indicated type of item exist.<TR>
<TD>Size<TD>A size, usually in bytes.<TR>
<TD>Table<TD>The base address of a table.<TR>
<TD>Type<TD>An index to a list of feature descriptions.<TR>
<TD>Version<TD>A version number, which can be either a constant with a defined meaning or an actual version number, usually stored as four hexadecimal digits in the low-order word of the return value. Implied decimal points may separate digits. The value $0701, for example, returned in response to the <CODE>gestaltSystemVersion</CODE> selector, represents system software version 7.0.1.</TABLE>
<P>
 Selectors that have the suffix <CODE>Attr</CODE> deserve special attention. They cause <CODE>Gestalt</CODE> to return a bit field that your application must interpret to determine whether a desired feature is present. For example, the application-defined sample function <CODE>MyGetSoundAttr</CODE>, defined in <A HREF=#MARKER-9-437>Listing 1-2</A> on <A HREF=#MARKER-9-437>page 1-6</A>, returns a <CODE>LongInt</CODE> that contains the Sound Manager attributes field retrieved from <CODE>Gestalt</CODE>. To determine whether a particular feature is available, you need to look at the designated bit. The application-defined sample function <CODE>MyIsStereoMixing</CODE> in <A HREF=#MARKER-9-445>Listing 1-3</A>, for example, determines whether stereo mixing is available.<P>
<B>Listing 1-3  <A NAME=MARKER-9-445></A>Interpreting a <EM>Gestalt</EM> attributes response</B><P>
<PRE>
FUNCTION MyIsStereoMixing: Boolean;
BEGIN
   MyIsStereoMixing := BTst(MyGetSoundAttr, gestaltStereoMixing);
END;
</PRE>
 The <CODE>MyIsStereoMixing</CODE> function uses the MPW Pascal function <CODE>BTst</CODE> and the application-defined<CODE> MyGetSoundAttr</CODE> function to determine whether the stereo-mixing bit is set in the <CODE>response</CODE> value returned by <CODE>Gestalt</CODE> when it's called with the <CODE>gestaltSoundAttr</CODE> selector. The constant <CODE>gestaltStereoMixing</CODE> is defined in the header files.<P>
<A NAME=HEADING11-34></A>
<H2><A NAME=MARKER-9-446></A><A NAME=MARKER-9-447></A>Adding a New Selector Code</H2>
 <A NAME=MARKER-2-93></A>You can add your own selector code to those already understood by <CODE>Gestalt</CODE> by calling the <CODE>NewGestalt</CODE> function. Typically, a system extension registers itself with the Gestalt Manager so that applications that might use its services can find out whether it's there. A debugger, for example, could register its presence. Programmers working on an application could then embed instructions for the debugger in code under development and call <CODE>Gestalt</CODE> to make sure the debugger is available before invoking those instructions.<P>
 The <CODE>NewGestalt</CODE> function requires two parameters: the new selector to be registered and the address of the associated <B>selector function</B>.<B> <CODE>Gestalt</CODE></B> executes the selector function to determine what value to pass back when it's called with the new selector code.<A NAME=MARKER-2-449></A><A NAME=MARKER-2-450></A><P>
 The selector code is a four-character sequence of type <CODE>OSType</CODE>. If you have registered a creator string with Apple Computer, Inc., you are strongly encouraged to use that sequence as your selector code. The Pipeline debugger, for example, with a creator string of <CODE>'PIPE'</CODE>, would use a <CODE>Gestalt</CODE> selector code of <CODE>'PIPE'</CODE>.<A NAME=MARKER-2-451></A><P>
<DL>
<DT><B>Note</B>
<DD>Apple reserves for its own use all four-character sequences consisting solely of lowercase letters and nonalphabetic ASCII characters.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 When you register your own selector code with the Gestalt Manager, you supply the address of the selector function to be executed when an application calls <CODE>Gestalt</CODE> with that code. Your selector function must reside in the system heap and must have the following interface:<P>
<PRE>
FUNCTION MySelectorFunction (selector: OSType; 
                             VAR response: LongInt): OSErr;
</PRE>
 The <CODE>Gestalt</CODE> function passes its input parameters on to your selector function. Your function places the requested information in the <CODE>LongInt</CODE> pointed to by the <CODE>response</CODE> parameter and returns an error code, which <CODE>Gestalt</CODE> returns to its caller.<P>
 Your selector function should be as simple as possible. If your function needs to use global variables from the A5 world--that of your own software or that of some other software--it must explicitly set up A5 and then restore it upon exit. (See <I><A HREF="../Memory/Memory-2.html">Inside Macintosh: Memory</A></I> for an explanation of setting up and restoring the A5 world.)<A NAME=MARKER-2-142></A><P>
 Your selector function can, if necessary, call <CODE>Gestalt</CODE> and pass it other selector codes. Note that the <CODE>response</CODE> parameter is merely the address into which your function places the information requested. You cannot use that parameter to pass information to your selector function.<P>
 <A HREF=#MARKER-9-453>Listing 1-4</A> illustrates a minimal selector function that sets the <CODE>response</CODE> parameter and returns an error code of <CODE>noErr</CODE>. The application-defined sample function, <CODE>MyGestaltPipe</CODE>, is isolated in a <CODE>UNIT</CODE> element for separate compilation and placement in a resource.<P>
<B>Listing 1-4  <A NAME=MARKER-9-453></A>Defining a simple <EM>Gestalt</EM> selector function</B><P>
<PRE>
UNIT GestaltFunc;
INTERFACE
   USES OSIntf;
   FUNCTION MyGestaltPipe (gestaltSelector: OSType;
                           VAR gestaltReply: LongInt): OSErr;
IMPLEMENTATION
   FUNCTION MyGestaltPipe;
   BEGIN
      gestaltReply := $ACE;      {reply defined by Pipeline}
      MyGestaltPipe := noErr;    {too simple for errors}
   END;
END.
</PRE>
 This sample linking command places the compiled code in resource ID 128 of a type arbitrarily named <CODE>'GDEF'</CODE>.<P>
<PRE>
Link GestaltFunc.p.o -rn -rt GDEF=128 -o Pipeline
</PRE>
 To add a <CODE>Gestalt</CODE> selector code, you first move the selector function into the system heap and then call the <CODE>NewGestalt</CODE> function, which adds the selector code and its function to the <CODE>Gestalt</CODE> repertoire.<P>
<DL>
<DT><B>WARNING</B>
<DD><A NAME=MARKER-9-454></A>Take special care when accessing memory in the system heap; it persists even after your application terminates.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 <A HREF=#MARKER-9-455>Listing 1-5</A> illustrates the installation of a new <CODE>Gestalt</CODE> selector.<P>
<B>Listing 1-5  <A NAME=MARKER-9-455></A>Installing a new <EM>Gestalt</EM> selector<A NAME=MARKER-2-81></A></B><P>
<PRE>
PROCEDURE MyInstallGestFunc;
VAR
   gestFuncHandle:   Handle;
   gestFuncSize:     Size;
   gestSysPtr:       Ptr;
   myErr:            OSErr;
BEGIN
   gestFuncHandle := GetResource('GDEF', 128);
   IF ResError = noErr THEN
   BEGIN
      gestFuncSize := SizeResource(gestFuncHandle);
      gestSysPtr := NewPtrSys(gestFuncSize);
      IF MemError = noErr THEN
      BEGIN
         BlockMove(gestFuncHandle^, gestSysPtr, gestFuncSize);
         FlushInstructionCache;
         myErr := NewGestalt('PIPE',
                  SelectorFunctionUUP(gestSysPtr));
      END;
      ReleaseResource(gestFuncHandle);
   END;
END;
</PRE>
 The application-defined sample procedure <CODE>MyInstallGestFunc</CODE> loads the resource and then gets its size so it can allocate a pointer in the system heap. It then copies the resource to the pointer and releases the resource.<P>
<DL>
<DT><B>WARNING</B>
<DD>Be sure to call the <CODE>FlushInstructionCache</CODE> procedure every time you modify code in RAM. See the chapter "Memory Management Utilities" in <I><A HREF="../Memory/Memory-2.html">Inside Macintosh: Memory</A></I> for details about <CODE>FlushInstructionCache</CODE>.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 Finally, <CODE>MyInstallGestFunc</CODE> calls <CODE>NewGestalt</CODE> to register the selector code <CODE>'PIPE'</CODE> and its selector function with the Gestalt Manager.<P>
 Because the new selector function resides in the system heap, <CODE>Gestalt</CODE> recognizes and responds to the new selector until the machine restarts, even if your software terminates before that time. You might therefore want your selector function to determine whether your software is still running before filling in the <CODE>response</CODE> value. The simplest way to report that your application is not available is to return an error code.<P>
 If you attempt to add a selector code that <CODE>Gestalt</CODE> already recognizes, <CODE>NewGestalt</CODE> returns the error code <CODE>gestaltDupSelectorErr</CODE>.<A NAME=MARKER-0-10></A><A NAME=MARKER-2-458></A><P>
<A NAME=HEADING11-59></A>
<H2><A NAME=MARKER-9-459></A>Modifying a Selector Function</H2>
 You can use the <CODE>ReplaceGestalt</CODE> function to modify the function that <CODE>Gestalt</CODE> executes when passed a particular selector code. Your replacement selector function must reside in the system heap and must conform to the interface defined in the previous section, <A HREF=#MARKER-9-447>"Adding a New Selector Code."</A> <A NAME=MARKER-2-139></A><P>
 To allow the new function to call the function it's replacing, <CODE>ReplaceGestalt</CODE> returns the address of the previous function.<P>
 If you attempt to redefine a selector that is not yet defined, <CODE>ReplaceGestalt</CODE> returns an error code; in that case, the address of the previous function is undefined. Always test the result code of <CODE>ReplaceGestalt</CODE> before calling <CODE>Gestalt</CODE> with that selector or attempting to use the <CODE>response</CODE> parameter.<P>
<DL>
<DT><B>Note</B>
<DD>If you modify the function associated with an existing <CODE>Gestalt</CODE> selector, do not use any bits in the <CODE>response</CODE> parameter that are not documented in this chapter. Apple reserves all undocumented bits in the <CODE>response</CODE> parameters returned by Apple-defined <CODE>Gestalt</CODE> selectors.<EM></EM>   <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 Because <CODE>ReplaceGestalt</CODE> supplies the address of the function it's replacing, you can use it to retrieve the address of the selector function associated with a selector code.<P>
<A NAME=HEADING11-65></A>
<H2>Getting Environmental Information Without the Gestalt Manager</H2>
 You can call the <CODE>SysEnvirons</CODE> function, which predates the Gestalt Manager, to get a brief description of the operating environment. The <CODE>SysEnvirons</CODE> function is available on all models of the Macintosh computer since the Macintosh SE and Macintosh II.<P>
<DL>
<DT><B>Note</B>
<DD>The <CODE>SysEnvirons</CODE> function is not part of the Gestalt Manager, but is documented in this chapter for the sake of completeness.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 The <CODE><A NAME=MARKER-0-25></A>SysEnvirons</CODE> function fills in a record that contains the model of the machine, the System file version number, the microprocessor type, a keyboard type code, and Boolean indicators of whether the machine has a floating-point unit or Color QuickDraw. The system environment record includes one detail not available through <CODE>Gestalt</CODE>: the working directory reference number of the folder or volume that holds the System file (although that information is available through the <CODE>FindFolder</CODE> function). See <A HREF=OSUtilities-15.html#MARKER-9-468>"The System Environment Record" beginning on page 1-28</A> for a complete description of the system environment record.<A NAME=MARKER-2-462></A><P>

</BLOCKQUOTE>
<HR>
<center>
<A HREF="OSUtilities-10.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="OSUtilities-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="OSUtilities-222.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="OSUtilities-12.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="OSUtilities-3.html">&copy; Apple Computer, Inc.</A><br>6 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
