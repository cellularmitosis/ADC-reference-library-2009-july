<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>StreamNOP - /StreamNOP.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxCarbon-date.html">Carbon</a> &gt; <A HREF="javascript:location.replace('index.html');">StreamNOP</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Carbon/idxNetworking-date.html" target="_blank">Carbon > Networking</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">StreamNOP</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/StreamNOP.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/StreamNOP.c</option></select>
				</p>
				</form>
				<p><strong><a href="StreamNOP.zip">Download Sample</a></strong> (&#147;StreamNOP.zip&#148;, 11.9K)<BR>
<strong><a href="StreamNOP.dmg">Download Sample</a></strong> (&#147;StreamNOP.dmg&#148;, 71.4K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*  File:    StreamNOP.c  Contains:  Stream module that does nothing.  Written by:  Quinn &quot;The Eskimo!&quot;  Copyright:  Copyright &copy; 1997-2000 by Apple Computer, Inc., All Rights Reserved.  Disclaimer:  IMPORTANT:  This Apple software is supplied to you by Apple Computer, Inc.        (&quot;Apple&quot;) in consideration of your agreement to the following terms, and your        use, installation, modification or redistribution of this Apple software        constitutes acceptance of these terms.  If you do not agree with these terms,        please do not use, install, modify or redistribute this Apple software.        In consideration of your agreement to abide by the following terms, and subject        to these terms, Apple grants you a personal, non-exclusive license, under Apple's        copyrights in this original Apple software (the &quot;Apple Software&quot;), to use,        reproduce, modify and redistribute the Apple Software, with or without        modifications, in source and/or binary forms; provided that if you redistribute        the Apple Software in its entirety and without modifications, you must retain        this notice and the following text and disclaimers in all such redistributions of        the Apple Software.  Neither the name, trademarks, service marks or logos of        Apple Computer, Inc. may be used to endorse or promote products derived from the        Apple Software without specific prior written permission from Apple.  Except as        expressly stated in this notice, no other rights or licenses, express or implied,        are granted by Apple herein, including but not limited to any patent rights that        may be infringed by your derivative works or by other works in which the Apple        Software may be incorporated.        The Apple Software is provided by Apple on an &quot;AS IS&quot; basis.  APPLE MAKES NO        WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION THE IMPLIED        WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY AND FITNESS FOR A PARTICULAR        PURPOSE, REGARDING THE APPLE SOFTWARE OR ITS USE AND OPERATION ALONE OR IN        COMBINATION WITH YOUR PRODUCTS.        IN NO EVENT SHALL APPLE BE LIABLE FOR ANY SPECIAL, INDIRECT, INCIDENTAL OR        CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE        GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)        ARISING IN ANY WAY OUT OF THE USE, REPRODUCTION, MODIFICATION AND/OR DISTRIBUTION        OF THE APPLE SOFTWARE, HOWEVER CAUSED AND WHETHER UNDER THEORY OF CONTRACT, TORT        (INCLUDING NEGLIGENCE), STRICT LIABILITY OR OTHERWISE, EVEN IF APPLE HAS BEEN        ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  Change History (most recent first):*//////////////////////////////////////////////////////////////////////// The OT debugging macros in &lt;OTDebug.h&gt; require this variable to// be set.#ifndef qDebug#define qDebug  1#endif/////////////////////////////////////////////////////////////////////// Determine whether this is going to be an instrumented build or not.#ifndef INSTRUMENTATION_ACTIVE  #define INSTRUMENTATION_ACTIVE 0#else  #define INSTRUMENTATION_ACTIVE 1#endif/////////////////////////////////////////////////////////////////////// Pick up all the standard OT module stuff.#include &lt;OpenTransportKernel.h&gt;/////////////////////////////////////////////////////////////////////// Pick up Instrumentation SDK stuff.  We only do this if we're// actually instrumenting, so you don't even have to have the SDK// to compile the non-instumented version of the code.  If we're// not instrumenting, we compile a bunch of bogus macros that generally// compile to nothing.#if INSTRUMENTATION_ACTIVE  #include &lt;InstrumentationMacros.h&gt;#else  #define TRACE_SETUP    long __junk  #define LOG_ENTRY(n)  if (0) { __junk ; }  #define LOG_EXIT    if (0) { __junk ; }#endif/////////////////////////////////////////////////////////////////////// To get OTDebugStr you have to link with OpenTptMiscUtilsPPC.o, which // is not part of Universal Interfaces.  So we just define our own version, // layered on top of the lowercase debugstr.extern pascal void OTDebugStr(const char* str){  debugstr(str);}/////////////////////////////////////////////////////////////////////// Some simple routines we use in our various assertions.static Boolean IsReadQ(queue_t* q)  // Returns true if q is the read queue of a queue pair.{  return ( (q-&gt;q_flag &amp; QREADR) != 0 );}static Boolean IsWriteQ(queue_t* q)  // Returns true if q is the write queue of a queue pair.{  return ( (q-&gt;q_flag &amp; QREADR) == 0 );}/////////////////////////////////////////////////////////////////////// Per-Stream information// This structure is used to hold the per-stream data for the module.// While module's can use normal global variables to store real globals,// they must maintain their own per-stream data structures.  I use// mi_open_comm to allocate this data structure when the stream is// opened.  mi_open_comm stores the address of this data structure in the// read and write queue's q_ptr field, so the rest of the code// can get to it by calling the GetPerStreamData function.enum {  kStreamNOPPerStreamDataMagic = 'NOOP'};struct PerStreamData{  OSType         magic;        // kStreamNOPPerStreamDataMagic = 'NOOP' for debugging  // Your per-stream data structures go here.};typedef struct PerStreamData PerStreamData, *PerStreamDataPtr;static PerStreamDataPtr GetPerStreamData(queue_t* readOrWriteQ)  // You can pass both the read or the write queue to this routine  // because mi_open_comm sets up both q_ptr's to point to the  // queue local data.  //  // Note that, in order to avoid the overhead of a function call,  // you would normally use inline code (or a macro)  // to get your per-stream data instead of using a separate function.  // However I think the separate function makes things clearer.  // I also acts as a central bottleneck for my debugging code.  //  // Environment: any standard STREAMS entry point{  PerStreamDataPtr streamData;    streamData = (PerStreamDataPtr) readOrWriteQ-&gt;q_ptr;  OTAssert(&quot;GetPerStreamData: what streamData&quot;, streamData != nil);  OTAssert(&quot;GetPerStreamData: Bad magic&quot;, streamData-&gt;magic == kStreamNOPPerStreamDataMagic);    return (streamData);}// mi_open_comm and mi_close_comm (and also mi_detach and mi_close_detached)// use this global to store the list of open streams to this module.static char* gStreamList = nil;/////////////////////////////////////////////////////////////////////// Open routinestatic SInt32 StreamNOPOpen(queue_t* rdq, dev_t* dev, SInt32 flag, SInt32 sflag, cred_t* creds)  // This routine is called by STREAMS when a new stream is connected to  // our module.  The bulk of the work here is done by the Mentat helper  // routine mi_open_comm.  //  // Environment: standard STREAMS entry point{  TRACE_SETUP;  int err;  PerStreamDataPtr streamData;  LOG_ENTRY( &quot;StreamNOP:StreamNOPOpen&quot; );    OTAssert(&quot;StreamNOPOpen: Not the read queue&quot;, IsReadQ(rdq) );  OTDebugBreak(&quot;StreamNOPOpen&quot;);    err = noErr;    // If we already have per-stream data for this stream, the stream is being reopened.  // In that case, we can just return.  // Note that we can't call GetPerStreamData because it checks that streamData is not nil.    if ( rdq-&gt;q_ptr != nil ) {    goto done;  }  // Make sure we're being opened properly -- because we're a module we  // require a &quot;module&quot; open.  Other possibilities are the value 0 (used  // to open a specific minor device number (ie stream) on a device driver),  // and CLONEOPEN (used to open a new stream to a device number where you  // don't care what device number you get -- the typical behaviour for  // networking (as opposed to serial) devices).    if ( (err == noErr) &amp;&amp; (sflag != MODOPEN) ) {    err = ENXIO;  }    // Use the mi_open_comm routine to allocate our per-stream data.  Then  // zero out the entire per-stream data record and fill out the fields  // we're going to need.    if (err == noErr) {    err = mi_open_comm(&amp;gStreamList, sizeof(PerStreamData), rdq, dev, flag, sflag, creds);    if ( err == noErr ) {      // Note that we can't call GetPerStreamData because the magic is not set up yet.      streamData = (PerStreamDataPtr) rdq-&gt;q_ptr;            OTMemzero(streamData, sizeof(PerStreamData));            streamData-&gt;magic = kStreamNOPPerStreamDataMagic;    }  }done:  LOG_EXIT;  return (err);}/////////////////////////////////////////////////////////////////////// Close routinestatic SInt32 StreamNOPClose(queue_t* rdq, SInt32 flags, cred_t* credP)  // This routine is called by STREAMS when a stream is being  // disconnected from our module (ie closed).  The bulk of the work  // is done by the magic Mentat helper routine mi_close_comm.  //  // Environment: standard STREAMS entry point{  TRACE_SETUP;  #pragma unused(flags)  #pragma unused(credP)  LOG_ENTRY( &quot;StreamNOP:StreamNOPClose&quot; );  OTAssert(&quot;StreamNOPClose: Not the read queue&quot;, IsReadQ(rdq) );  (void) mi_close_comm(&amp;gStreamList, rdq);  LOG_EXIT;  return (0);}/////////////////////////////////////////////////////////////////////enum {  kNoPrimitive = -1};static long GetPrimitive(mblk_t* mp)  // GetPrimitive gets the TPI/DLPI primitive out of a message block.  // It returns kNoPrimitive if the message block is of the wrong  // type or there is no primitive.  //  // Environment: any standard STREAMS entry point{  if ((mp-&gt;b_datap-&gt;db_type == M_PROTO || mp-&gt;b_datap-&gt;db_type == M_PCPROTO) &amp;&amp; MBLK_SIZE(mp) &gt;= sizeof(long) ) {    return ( ( (union T_primitives*) mp-&gt;b_rptr)-&gt;type );  } else {    return ( kNoPrimitive );  }}/////////////////////////////////////////////////////////////////////// Write-side put routinestatic SInt32 StreamNOPWritePut(queue_t* q, mblk_t* mp)  // This routine is called by STREAMS when it has a message for our  // module from upstream.  Typically, this routine is a big case statement  // that dispatches to our various message handling routines.  However, the   // function of this stream module is to pass through all messages unchanged,  // so the case statement is not very exciting.  //  // Environment: standard STREAMS entry point{  TRACE_SETUP;  PerStreamDataPtr streamData;    LOG_ENTRY( &quot;StreamNOP:StreamNOPWritePut&quot; );  OTAssert(&quot;StreamNOPWritePut: Not the write queue&quot;, IsWriteQ(q) );  // OTDebugBreak(&quot;StreamNOPWritePut: Entered&quot;);    streamData = GetPerStreamData(q);  switch ( GetPrimitive(mp) ) {    default:      putnext(q, mp);      break;  }    LOG_EXIT;    return 0;}/////////////////////////////////////////////////////////////////////// Read-side put routinestatic SInt32 StreamNOPReadPut(queue_t* q, mblk_t* mp)  // This routine is called by STREAMS when it has a message for our  // module from downstream.  Typically, this routine is a big case statement  // that dispatches to our various message handling routines.  However, the   // function of this stream module is to pass through all messages unchanged,  // so the case statement is not very exciting.  //  // Environment: standard STREAMS entry point{  TRACE_SETUP;  PerStreamDataPtr streamData;    LOG_ENTRY( &quot;StreamNOP:StreamNOPReadPut&quot; );  OTAssert(&quot;StreamNOPReadPut: Not the read queue&quot;, IsReadQ(q) );  // OTDebugBreak(&quot;StreamNOPReadPut: Entered&quot;);    streamData = GetPerStreamData(q);  switch ( GetPrimitive(mp) ) {    default:      putnext(q, mp);      break;  }    LOG_EXIT;    return 0;}/////////////////////////////////////////////////////////////////////// Static Declaration Structuresstatic struct module_info gModuleInfo =  {  9992,            // Module Number, only useful for debugging  &quot;StreamNOP&quot;,        // Name of module  0,              // Minimum data size  INFPSZ,            // Maximum data size  16384,            // Hi water mark for queue  4096            // Lo water mark for queue};static struct qinit gReadInit = {  StreamNOPReadPut,    // Put routine for &quot;incoming&quot; data  nil,            // Service routine for &quot;incoming&quot; data  StreamNOPOpen,      // Our open routine  StreamNOPClose,     // Our close routine  nil,            // No admin routine  &amp;gModuleInfo        // Our module_info};static struct qinit gWriteInit ={  StreamNOPWritePut,    // Put routine for client data  nil,            // Service routine for client data  nil,            // open  field only used in read-side structure  nil,            // close field only used in read-side structure  nil,            // admin field only used in read-side structure  &amp;gModuleInfo        // Our module_info};static struct streamtab theStreamTab = {  &amp;gReadInit,          // Our read-side qinit structure  &amp;gWriteInit,        // Our write-side qinit structure  0,              // We are not a mux, so set this to nil  0              // We are not a mux, so set this to nil};/////////////////////////////////////////////////////////////////////// Macintosh-specific Static Structuresstatic struct install_info theInstallInfo ={  &amp;theStreamTab,      // Stream Tab pointer  kOTModIsModule + kOTModUpperIsTPI + kOTModIsFilter,              // Tell OT that we are a driver, not a module  SQLVL_MODULE,      // Synchronization level, module level for the moment  0,            // Shared writer list buddy  0,            // Open Transport use - always set to 0  0            // Flag - always set to 0};// Prototypes for the exported routines below.extern Boolean InitStreamModule(void *portInfo);extern void TerminateStreamModule(void);extern install_info* GetOTInstallInfo();#pragma export list GetOTInstallInfo, InitStreamModule, TerminateStreamModule// Export entry pointextern Boolean InitStreamModule(void *portInfo)  // Initialises the module before the first stream is opened.  // Should return true if the module has started up correctly.  //  // Environment: Always called at SystemTask time.{    TRACE_SETUP;  #pragma unused(portInfo)  Boolean result;    OTDebugBreak(&quot;StreamNOP: InitStreamModule&quot;);    LOG_ENTRY( &quot;StreamNOP:InitStreamModule&quot; );  result = true;    LOG_EXIT;  return (result);}extern void TerminateStreamModule(void)  // Shuts down the module after the last stream has been  // closed.  //  // Environment: Always called at SystemTask time.{  TRACE_SETUP;    LOG_ENTRY( &quot;StreamNOP:TerminateStreamModule&quot; );    // It's an excellent idea to have the following in your code, just to make  // sure you haven't left any streams open before you quit.  In theory, OT  // should not call you until the last stream has been closed, but in practice  // this can happen if you use mi_detach to half-close a stream.    OTAssert(&quot;TerminateStreamModule: Streams are still active&quot;, gStreamList == nil);  LOG_EXIT;}extern install_info* GetOTInstallInfo()  // Return pointer to install_info to STREAMS.{  return &amp;theInstallInfo;}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/StreamNOP/listing1.html%3Fid%3DDTS10000260-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/StreamNOP/listing1.html%3Fid%3DDTS10000260-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/StreamNOP/listing1.html%3Fid%3DDTS10000260-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>