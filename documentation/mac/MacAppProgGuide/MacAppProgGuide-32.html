<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Trap Patching (MacApp PG)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING32></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="MacAppProgGuide-31.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="MacAppProgGuide-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="MacAppProgGuide-158.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="MacAppProgGuide-33.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="MacAppProgGuide-2.html"><B>Programmer's Guide to MacApp</B></A> / <A HREF="MacAppProgGuide-21.html"><B>Part 1 - MacApp Theory and Architecture</B></A><BR><DD><A HREF="MacAppProgGuide-25.html"><B>Chapter 3 - Core Technologies</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING32-0></A>
<H1><A NAME=MARKER-9-227></A><A NAME=MARKER-2-228></A>Trap Patching</H1>
 MacApp supplies a general-purpose mechanism for patching Toolbox traps, using universal procedure pointers, that works for either 68K-based or Power Macintosh machines. MacApp uses the patching mechanism itself to patch a number of Toolbox routines. For example, MacApp patches the Toolbox routine <CODE>ExitToShell</CODE> to call<A NAME=MARKER-2-229></A> <CODE>ExitToShellCleanupMacApp</CODE>, which in turn calls MacApp's cleanup routine, <CODE>CleanupMacApp</CODE>.<P>
<A NAME=HEADING32-2></A>
<H2>Patching Traps in Your Application</H2>
 You patch a trap by defining a subclass, <CODE>T<I>YourTrapPatch</I></CODE>, of the <CODE><A NAME=MARKER-2-230></A>TrapPatch</CODE> <CODE>struct</CODE> and overriding the <CODE>CallInherited</CODE> and <CODE>Install</CODE> methods. You also supply a compiler definition that generates the appropriate style of procedure pointer to handle patches for either 68K-based or Power Macintosh machines, depending on the type of application built.<P>
 You define a static variable of type <CODE>T<I>YourTrapPatch</I></CODE>, and call its <CODE>PatchTrap</CODE> method to do the work. The <CODE>PatchTrap</CODE> method saves the old trap address, sets the trap to the new address, and inserts the <CODE>TrapPatch</CODE> record into a linked list. This linked list is used later when the <CODE>CleanupMacApp</CODE> routine calls <CODE>UnpatchAll</CODE> to set all patched traps back to their original addresses.<P>
 When the application makes a call to a patched trap, the trap jumps to the address you have supplied instead of the address it previously jumped to. The patch is set to the address of a universal procedure pointer that points to your routine. Your code has access to the old trap address through the <CODE>TrapPatch</CODE> method <CODE>GetOldTrapAddr</CODE>, so your patch can do its own special task and then call the previous trap.<P>
<A NAME=HEADING32-6></A>
<H2><A NAME=MARKER-9-231></A>MacApp's Patching for Segmentation</H2>
 MacApp applications that run on 68K-based machines store their code in segments. Code segments are loaded and unloaded as needed while the application is running <A HREF=MacAppProgGuide-31.html#MARKER-9-205>(page 75)</A>. MacApp manages memory so that there will always be room to load a required segment. However, it must be informed when a segment is about to be loaded so it can free memory if necessary to make room for the segment. The next sections describe the patches MacApp makes so that it will be notified before and after a segment is loaded.<P>
<A NAME=HEADING32-8></A>
<H3>Patching for Nonstandard Builds</H3>
 If you build your application with the <CODE>-ModelFar</CODE> or <CODE>-CFM68K</CODE> option, MacApp causes the runtime library (RTLib) to be linked with your application. The RTLib provides a convenient mechanism to specify routines that will be called automatically before and after a segment is loaded. When the RTLib is available, MacApp uses it to install segment load callback routines. MacApp takes care of this automatically--your application doesn't have to do anything special.<P>
<A NAME=HEADING32-10></A>
<H3>Patching for a Standard Build</H3>
 For a standard build (if you do <I>not</I> use either the <CODE>-ModelFar</CODE> option or the <CODE>-CFM68K</CODE> option), MacApp does not link the RTLib with your application. When the RTLib is not available, MacApp patches the segment loader directly to notify MacApp before a segment is loaded. Again, this takes place automatically and requires no special effort by your application.<A NAME=MARKER-2-232></A><P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="MacAppProgGuide-31.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="MacAppProgGuide-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="MacAppProgGuide-158.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="MacAppProgGuide-33.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="MacAppProgGuide-3.html">&copy; Apple Computer, Inc.</A><br>25 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
