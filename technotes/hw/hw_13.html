<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"        "http://www.w3.org/TR/1998/REC-html40-19980424/loose.dtd"><HTML><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note HW13: Macintosh Portable ROM Expansion</title><meta name="categories" content="Hardware"><meta name="week-posted" content="Sep 25, 1989 - Oct 6, 1989"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF" TEXT="#000000"><a name="//apple_ref/doc/uid/DTS10002482" title="Macintosh Portable ROM Expansion"></a><a name="top"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/index.html" target="_blank">Reference Library > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note HW13</div>
<div id="pageheadsub">Macintosh Portable ROM Expansion</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->                     <P id = "menutext"><A HREF = "#Introduction">Introduction</a><BR><BR>         <A HREF = "#Section1">Address Space</a><BR><BR>          <A HREF = "#Section2">Expansion ROM Board</a><BR><BR>           <A HREF = "#Section3">Software Standards</a><BR><BR>            <A HREF = "#Section4">The EDisk Driver</a><BR><BR><A HREF = "#Section5">EDisk Implementation Details</a><BR><BR><A HREF = "#Section6">Some Final Thoughts</a><BR><BR>     <A HREF="#References">References</A><BR><BR>         <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --> <P id= "introtext">This Technical Note explains the practice of and theory behind compatible useof the expansion ROM in the Macintosh Portable.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Oct 01 1989]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR><!-- begin_content --><a name="Introduction"></a><h2>Introduction</h2><p>Due to the unique nature of the Macintosh Portable, developers now have theability to add ROM to the Macintosh.  To provide for compatible shared use ofthis ROM space with Apple and other developers, this Note describes the featureand suggests methods of shared implementation.</p><P><A HREF="#top">Back to top</A></P><a name="Section1"></a><h2>Address Space</h2><p>The Macintosh Portable contains 256K of processor ROM, which is fundamentallythe same as the ROM in the Macintosh SE.  This ROM is located at the low end ofa 1 MB ROM space.  With an expansion card, one can either completely replacethe 1 MB ROM or simply add an additional 4 MB of ROM.  The original 1 MB ofaddress space is <b>reserved</b> for use by Apple, but the additional 4 MBaddress space is available for third-party developers.</p><p>Apple reserved ROM space is located from $90 0000 through $9F FFFF.  You canreplace this ROM space with an expansion board, thus overriding these ROMs;however, if you override these ROMs your machine will no longer work with mostapplications.  This ability to override the original ROMs is intended for Applein the event that a ROM upgrade is ever necessary for the Macintosh Portable.Developers should use the 4 MB ROM address space from $A0 0000 through $DFFFFF, which is illustrated in Figure 1, for expansion.</p><p>Since Apple could provide a ROM upgrade (on a ROM expansion board), werecommend that developers use a standard 32-pin DIP socketed ROM part for anyexpansion board.  Following this recommendation ensures that the user willnever have to choose between an Apple ROM upgrade and a third-party expansionboard, since Apple could provide sockets for third-party ROMs if we were toproduce such an upgrade.</p><P align=center><img src="images/hw_13_001.gif" alt="Macintosh Portable Memory Map" width=160 height=312></P><P ALIGN="center"><b>Figure 1 - Macintosh Portable Memory Map</b></p><a name="Section2"></a><P><A HREF="#top">Back to top</A></P><h2>Expansion ROM Board</h2><p>If Apple were to produce an expansion ROM board for an upgrade, it would havethe following characteristics.  Side one would contain four 32-pin ROM socketscompatible with 128K x 8 bit or 512K x 8 bit ROMs, a dip switch for choosingbetween 128K or 512K socket address sizes, and appropriate decouplingcapacitors.  Side two would contain Apple's expansion ROMs and any additionalcircuitry.  This design implies that developers would be able to use at mosteither 512K or 2 MB of the total 4 MB expansion space.</p><p>When designing your own expansion board, remember that it must containcircuitry for decoding, controlling, and buffering, and it should use CMOS,since the Macintosh Portable restricts ROM expansion boards to a maximum of25ma.  The number of wait states inserted depends upon the DTACK generated byyour board, which connects to the Macintosh Portable through a single 50-pinconnector (slot).  The machine provides all of the appropriate signals (addressbus, data bus, and control) to the expansion slot, where they are decoded intochip selects and routed to address and data buffers.  These signal names anddescriptions are illustrated in Figure 2 and described in Table 1.  It is alsoimportant to buffer the address and data buffers to reduce capacitiveloading.</p><P align=center><img src="images/hw_13_002.gif" alt="Internal ROM Expansion Connector Signals" width=224 height=312></P><P align=center><b>Figure 2 - Internal ROM Expansion Connector Signals</b></p><p align=center><img src="images/hw_13_003.gif" alt="Internal ROM Expansion Connector Signal Descriptions" width=344 height=324></p><p align=center><b>Table 1 -  Internal ROM Expansion Connector Signal Descriptions</b></P><p align=center><img src="images/hw_13_004.gif" alt="Internal ROM Expansion Board Guidelines" width=448 height=390></P><P align=center><b>Figure 3 - Internal ROM Expansion Board Guidelines</b></p><a name="Section3"></a><P><A HREF="#top">Back to top</A></P><h2>Software Standards</h2><p>For the purposes of expansion ROM, Apple has introduced Electronic Disks(EDisks), which appear to the user as very fast, silent disk drives.  The EDiskdriver supports EDisks, which use RAM or ROM as their storage media.</p><p>ROM EDisks, which can be produced by third parties, are connected to the systemusing the internal ROM expansion slot.  The 4 MB address space allocated forthis type of expansion supports any number of ROM EDisks, as long as they starton a 64K boundary (their size may exceed 64K).  ROM EDisks behave like RAMEDisks, except that they are read-only and cannot be resized.</p><a name="Section4"></a><P><A HREF="#top">Back to top</A></P><h2>The EDisk Driver</h2><p>The EDisk driver provides a system interface to EDisks similar to that providedby the Sony and SCSI disk drivers.  It supports 512 byte block I/O operationsand does not support file system tags.  The EDisk driver is a ROM <code>'DRVR'</code>resource with an ID of 48, <code>RefNum</code> of -49, and driver name of".EDisk".  Since it is a disk driver, it also creates a Drive Queue Element foreach EDisk.  Information on how these driver calls apply to the Sony driverappear in the Disk Driver chapters of <i>Inside Macintosh</i>, Volumes II, IV,&amp; V.</p><P><A HREF="#top">Back to top</A></P><a name="Section5"></a><h2>EDisk Implementation Details</h2><p>The remainder of this section describes some of the implementation details,data formats, and algorithms used by the EDisk driver that may be useful fordevelopers who want to produce ROM EDisks.</p><h3>Data Checksumming</h3><p>To provide better data integrity, the EDisk driver supports checksumming ofeach data block, which is computed when a write is performed to a block andchecked on every read operation.  It computes a 32-bit checksum for each512-byte block.  This calculation is performed by adding each longword in theblock to a running longword checksum, which is initially zero, and is rotatedleft by one bit before each longword is added.  The following assembly codedemonstrates this algorithm:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>Lea        TheBlock,a0    ; A0 is pointer to the block to checksumMoveq.L    #0,D0        ; D0 is the checksum, initially zeroMoveq.L    #(512/4)-l,D1    ; loop counter for 1 block (4 bytes per iteration)@Loop        Rol.L        #l,D0        ; rotate the checksumAdd.L        (A0)+,D0    ; add the data to the running checksumDbra        D1,@Loop    ; loop through each longword in the block</pre>	</TD></TR></TABLE></CENTER><h3>Internal ROM EDisk Details</h3><p>When the EDisk driver is opened, it searches the address range from the base ofthe system ROM to $00E0 0000 for internal ROM EDisks.  An internal ROM EDiskmust begin with an EDisk header block, which must start on a 64K boundary (butmay be any size).  If a valid header block is found, it is compared to allother known headers, and if it is identical to another, it is ignored toeliminate duplicates caused by address wrapping.  If the header block isunique, the EDisk driver supports it and creates a drive queue entry for it.The driver can support any number of internal ROM EDisks, and it is limitedonly by the address space allocated for ROM.</p><h3>EDisk Header Format</h3><p>There is a 512-byte header block associated with ROM EDisks.  This headerdescribes the layout of the EDisk and uniquely identifies it.  The generalformat of the header block is described below.  The EDisk header marks thebeginning of an EDisk, and it should occur at the beginning of the ROM spacethat is used for EDisk storage (i.e., starting at the first byte of a 64K ROMblock).</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>EDiskHeader    Record 0,increment    ; layout of the EDisk signature blockHdrScratch        DS.B    128    ; scratch space for r/w testing and vendor infoHdrBlockSize        DS.W    1    ; size of header block (512 bytes for version 1)HdrVersion        DS.W    1    ; header version number (this is version 1)HdrSignature        DS.B    12    ; 45 44 69 73 6B 20 47 61 72 79 20 44HdrDeviceSize        DS.L    1    ; size of device, in bytesHdrFormatTime        DS.L    1    ; time when last formatted (pseudo unique ID)HdrFormatTicks    DS.L    1    ; ticks when last formatted (pseudo unique ID)HdrCheckSumOff    DS.L    1    ; offset to the Checksum table, if presentHdrDataStartOff    DS.L    1    ; offset to the first byte of data storageHdrDataEndOff        DS.L    1    ; offset to the last byte+l of data storageHdrMediaIconOff    DS.L    1    ; offset to the media Icon and Mask, if presentHdrDriveIconOff    DS.L    1    ; offset to the drive Icon and Mask, if presentHdrWhereStrOff    DS.L    1    ; offset to the  Get Info Where: string, if presentHdrDriveInfo        DS.L    1    ; longword for Return Drive Info call, if present            DS.B    512-*    ; rest of block is reservedEDiskHeaderSize    EQU    *    ; size of EDisk header block            ENDR</pre>	</TD></TR></TABLE></CENTER><p><code>HdrScratch</code>    is a 128-byte field that is used for read and write testing onRAM EDisks to determine if the memory is ROM or RAM.  On ROM EDisks, it shouldbe filled in by the vendor with a unique string to identify this version of theROM EDisk (e.g., "Copyright 1989, Apple Computer, Inc. System Tools 6.0.49/5/89").</p><p><code>HdrBlockSize</code>    is a 2-byte field that indicates the size of the EDisk headerblock.  The size is currently 512 bytes.</p><p><code>HdrVersion</code>    is a 2-byte field that indicates the version of the EDiskheader block.  The version number is currently $0001.</p><p><code>HdrSignature</code>    is a 12-byte field that identifies a valid EDisk headerblock.  The signature must be set to <code>45 44 69 73 6B 20 47 61 72 79 2044</code> in hexadecimal.</p><p><code>HdrDeviceSize</code>    is a 4-byte field that indicates the size of the device inbytes, which may be greater than the actual usable storage space.  One mightalso think of the device size as the offset (from the beginning of the headerblock) of the last byte of the storage device.</p><p><code>HdrFormatTime</code>    is a 4-byte field that indicates the time of day when theEDisk was last formatted. The EDisk driver updates this for RAM EDisks when theformat control call is made.  This information may be useful for uniquelyidentifying a RAM EDisk.</p><p><code>HdrFormatTicks</code>    is a 4-byte field that indicates the value of the systemglobal <code>Ticks</code> when the EDisk was last formatted, which should be aunique number.  The EDisk driver updates this for RAM EDisks when the formatcontrol call is made.  This information may be useful for uniquely identifyinga RAM EDisk.</p><p><code>HdrCheckSumOff</code>    is a 4-byte field that is the offset (from the beginning ofthe header block) of the checksum table, or zero if checksumming should not beperformed on this EDisk.</p><p><code>HdrDataStartOff</code>    is a 4-byte field that is the offset (from the beginningof the header block) of the first block of EDisk data.</p><p><code>HdrDataEndOff</code>    is a 4-byte field that is the offset (from the beginning ofthe header block) of the byte after the end of the last block of EDisk data.</p><p><code>HdrMediaIconOff</code>    is a 4-byte field that is the offset (from the beginningof the header block) of the 128-byte icon and 128-byte icon mask, whichrepresents the disk media.  An offset of zero indicates that the EDisk drivershould use the default media icon for this EDisk.</p><p><code>HdrDriveIconOff</code>    is a 4-byte field that is the offset (from the beginningof the header block) of the 128-byte icon and 128-byte icon mask, whichrepresents the disk drive physical location.  An offset of zero indicates thatthe EDisk driver should use the default drive icon for this EDisk.</p><p><code>HdrWhereStrOff</code>    is a 4-byte field that is the offset (from the beginning ofthe header block) of the Pascal string that describes the disk location for theFinder Get Info command.  An offset of zero indicates that the EDisk drivershould use the default string for this EDisk.</p><p><code>HdrDriveInfo</code>    is a 4-byte field that should be returned by the driveinformation control call.  A value of zero indicates that the EDisk drivershould use the default drive info for this EDisk.</p><p>You should not override the default media or drive icons without first givingserious consideration as to how a different icon will affect the userinterface.  What often appears to be a clever idea for a cute icon usuallyturns out to be a source of frustration for the user when deciding what theitem is and where it is physically located.</p><P><A HREF="#top">Back to top</A></P><a name="Section6"></a><h2>Some Final Thoughts</h2><h3>Do Not Use More Space Than You Need</h3><p>As wonderful and indispensable as your ROM product may be, users may wish toalso use ROMs from another developer.  Although ROM address space is quitelarge (in today's terms), board space and number of ROM chip sockets islimited.  If you use only the space you really need and leave room (addressspace and empty chip sockets) in your ROM product to add other ROMs, users willnever have to make a choice between your product and another, unanticipatedstroke of genius.</p><h3>Keep It Relocatable</h3><p>Just because your code is in ROM does not mean that it will always reside at aspecific address.  When moving your ROM to another board (an Apple upgrade oranother third-party board), users should neither have to worry about addressrange conflicts nor socket location.  In addition, Apple may implement ROMexpansion in a future product with expanded or different address space; keepingyour ROM code relocatable could mean the difference between additional sales orincompatibility and upgrades.</p><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><P><i>Inside Macintosh</i>, Volume II, IV, &amp; V, The Disk Driver</p><P><A HREF="#top">Back to top</A></P><P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (344K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/hw_13.pdf">Download</A></P>               </TD>            </TR></table><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/hw/hw_13.html%3Fid%3DDTS10002482-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/hw/hw_13.html%3Fid%3DDTS10002482-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/hw/hw_13.html%3Fid%3DDTS10002482-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>