<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-August-01 --><!-- Includes revisions to graphics tags --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note DV545: Power Manager Q&amp;As</title>    <meta name="keywords" content="Macintosh Portable PowerBook Power Manager SetWUTime sleep voltage charging"><meta name="Description" content="Technical Note DV545: This Technical Note contains a collectionof archived Q&amp;As relating to the Power Manager--questionssent the Developer Support Center (DSC) along with answersfrom the DSC engineers. Archived Q&amp;As include: Think C SetWUTimeglue problem and workaround, Reasons for a networked PowerBooknot sleeping, how to check if a Macintosh Portable is charging,and How to notify a Device Driver when Macintosh Portablesleeps.">                                      <meta name="categories" content="Devices"><meta name="week-posted" content="Oct 1, 1990 - Oct 5, 1990"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002423" title="Power Manager Q&As"></a><A NAME="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/index.html" target="_blank">Reference Library > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note DV545</div>
<div id="pageheadsub">Power Manager Q&amp;As</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc --><p id="menutext"><a href="#Section1">Think C SetWUTime glue problem and workaround</a><BR><BR><a href="#Section2">Conditions for networked PowerBook not going to sleep</a><BR><BR><a href="#Section3">SetWUTime documentation fix</a><BR><BR><a href="#Section4">Power Manager BatteryStatus returns voltage &amp; charger details</a><BR><BR><a href="#Section5">How to notify a device driver when Macintosh Portable sleeps</a><BR><BR><A HREF="#downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><p id = "introtext">This Technical Note contains a collection of archived Q&amp;As relating to a specific topic--questions sent the Developer Support Center (DSC) along with answers from the DSC engineers. Current Q&amp;As can be found on the <a href="../../qa/index.html">Macintosh Technical Q&amp;As web site</a>.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Oct 01 1990]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content --><A NAME="Section1"></A><h2>Think C SetWUTime glue problem and workaround</h2><p>Date Written:  2/1/93</p><p>Last reviewed:  6/14/93</p><p>Does the wakeup timer work on PowerBooks? At first accRun time in my driver, asa test, I do the following using Think C:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>        {        unsigned long       currentSecs;        OSErr               err;        GetDateTime(&amp;currentSecs);        err = SetWUTime(currentSecs + 60);        }</pre>	</TD></TR></TABLE></CENTER><p>I then manually sleep my PowerBook and wait for it to awake after a minute. Itdoesn't. Am I doing something wrong?</p><p>___</p><p>There's an error in the Think glue for this routine. It works as documented inMPW, but fails when you use it with Think C. After a little digging we foundthat the Think C glue is expecting the value to be passed by reference. So thefollowing code fragment should be correct for Think C.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>        {        unsigned long       currentSecs;        OSErr               err;        GetDateTime(&amp;currentSecs);        currentSecs = currentSecs +60L;        err = SetWUTime((long)&amp;currentSecs);        }</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>Conditions for networked PowerBook not going to sleep</h2><p>Date Written:  1/20/93</p><p>Last reviewed:  5/14/93</p><p>When my PowerBook is connected to a network, it never goes to sleep. Why?</p><p>___</p><p>There are two situations in which the PowerBook won't go to sleep, ascontrasted to simply dimming the screen. For reference, screen dimming is basedon user activity, and sleep is based on system activity. One reason for thePowerBook to remain awake is that AppleTalk is active and the PowerBook has therecharger cord plugged in. This was a design decision made on the assumptionthat if the recharger is plugged in and AppleTalk is active, then you're atyour office and it's likely you'd want the PowerBook to be as responsive aspossible. Note that the PowerBook only detects whether the recharger cord isplugged in, not whether there's actual current flowing through the recharger.</p><p>The second reason for the PowerBook not going to sleep is that AppleTalk isactive and the user has activated some network service such as AppleShare orsome e-mail service. The Power Manager detects that there is periodic activityat the AppleTalk port and will not allow the unit to go to sleep. Simply havingAppleTalk active and plugged into a LocalTalk network will not keep the unitawake when the power cable isn't connected.</p><P><A HREF="#top">Back to top</A></P><a name="Section3"></a><h2>SetWUTime documentation fix</h2><p>Date Written:  5/18/92</p><p>Last reviewed:  7/13/92</p><p>I'm trying to use SetWUTime to wake the PowerBook in one minute from thecurrent time, as follows:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    long time;    GetDateTime( &amp;time);    SetWUTime( time + 60);</pre>	</TD></TR></TABLE></CENTER>        <p>I run this code and then sleep the PowerBook but it never wakes up as itshould. This seems very simple. Am I missing something?</p><p>___</p><p>Earlier documentation for SetWUTime is in error in that the time parametertakes a pointer to the long time, not the long itself, as shown below:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    long time;    GetDateTime( &amp;time);    time = time + 60;    SetWUTime( &amp;time);</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="Section4"></a><h2>Power Manager BatteryStatus returns voltage &amp; charger details</h2><p>Date Written:  10/15/91</p><p>Last reviewed:  8/1/92</p><p>How can we check if a Macintosh Portable is charging?</p><p>___</p><p>The Power Manager chapter of <i>Inside Macintosh</i> Volume VI (pages 31-23 and31-24) describes the BatteryStatus call, which provides you with the following information:</p><p>* Whether the charger is connected (status bit 0)</p><p>* Whether the charger is in High or Normal charge</p><p>* If the battery voltage is below the warning threshold</p><p>* A power value from which you can calculate the battery's current voltage</p><p>To calculate a battery's current voltage, you'll need to average the voltageover an extended time period (tens of seconds to several minutes for goodaccuracy). The power load within the Portable is a dynamic environment, so thecurrent draw of the various subsystems on the battery will affect the voltagethat you read.</p><P><A HREF="#top">Back to top</A></P><a name="Section5"></a><h2>How to notify a device driver when Macintosh Portable sleeps</h2><p>Date Written:  10/30/90</p><p>Last reviewed:  8/1/92</p><p>Is there any way for a device driver to be notified when the Macintosh Portablegoes to sleep or shuts down the disk?</p><p>___</p><p>Yes, there is. You can install a queue element in the Sleep Queue, and thatroutine will be called during a sleep or wakeup request or demand. This isdescribed in the Power Manager chapter of <i>Inside Macintosh</i> Volume VI.The routines you'll want are</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    struct SleepQRec {        struct SleepQRec *sleepQLink;        short sleepQType;            /*type = 16*/        ProcPtr sleepQProc;          /*Pointer to sleep routine*/        short sleepQFlags;    };    typedef struct SleepQRec SleepQRec;    typedef SleepQRec *SleepQRecPtr;    void SleepQInstall(SleepQRecPtr qRecPtr)        = {0x205F,0xA28A};    void SleepQRemove(SleepQRecPtr qRecPtr)        = {0x205F,0xA48A};</pre>	</TD></TR></TABLE></CENTER>        <p>The type of request (sleep request [1] sleep demand [2] wake [3] sleep requestcancelled [4]) is passed in D0, and a pointer to your queue entry is passed inA0, if you need them. Most of the time you won't. You can deny a sleep request,but you <i>cannot </i>deny a sleep demand, since this could be caused by aseriously low battery, and your denying it could damage the user's hardware. Asa general rule, you should allow both requests and demands. You accept therequest by clearing D0 to 0, and deny it by storing a non-zero number in D0.</p><p>That's a brief overview. You should look at the beta Inside Macintosh chapter to get the complete story.</p><P><A HREF="#top">Back to top</A></P>         <a name="downloads"></a>         <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center>                                    <img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (48K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/dv_545.pdf">Download</A></P>               </TD>            </TR>         </TABLE>         <BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/dv/dv_545.html%3Fid%3DDTS10002423-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/dv/dv_545.html%3Fid%3DDTS10002423-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/dv/dv_545.html%3Fid%3DDTS10002423-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>