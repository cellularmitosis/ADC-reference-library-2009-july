<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>ElectricImageComponent.win - /EI_GraphicsImport/EI_GraphicsImport.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/QuickTime/index.html">QuickTime</a> &gt; <a href="../../samplecode/QuickTime/idxQuickTimeComponentCreation-date.html">QuickTime Component Creation</a> &gt; <A HREF="javascript:location.replace('index.html');">ElectricImageComponent.win</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">ElectricImageComponent.win</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/EI_GraphicsImport/EI_GraphicsImport.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/Dllmain.c</option>
<option value="listing2.html">/EI_FormatIncludes/EI_Image.h</option>
<option value="listing3.html">/EI_GraphicsExport/EI_GraphicsExport.c</option>
<option value="listing4.html">/EI_GraphicsExport/EI_GraphicsExport.r</option>
<option value="listing5.html">/EI_GraphicsExport/EI_GraphicsExportDispatch.h</option>
<option value="listing6.html">/EI_GraphicsExport/EI_GraphicsExportVersion.h</option>
<option value="listing7.html">/EI_GraphicsImport/EI_GraphicsImport.c</option>
<option value="listing8.html">/EI_GraphicsImport/EI_GraphicsImport.r</option>
<option value="listing9.html">/EI_GraphicsImport/EI_GraphicsImportDispatch.h</option>
<option value="listing10.html">/EI_GraphicsImport/EI_GraphicsImportVersion.h</option>
<option value="listing11.html">/EI_ImageDecompressor/EI_Codec.c</option>
<option value="listing12.html">/EI_ImageDecompressor/EI_Codec.r</option>
<option value="listing13.html">/EI_ImageDecompressor/EI_CodecDispatch.h</option>
<option value="listing14.html">/EI_ImageDecompressor/EI_CodecVersion.h</option>
<option value="listing15.html">/EI_MovieExport/EI_MovieExport.c</option>
<option value="listing16.html">/EI_MovieExport/EI_MovieExport.r</option>
<option value="listing17.html">/EI_MovieExport/EI_MovieExportDialog.r</option>
<option value="listing18.html">/EI_MovieExport/EI_MovieExportDispatch.h</option>
<option value="listing19.html">/EI_MovieExport/EI_MovieExportVersion.h</option>
<option value="listing20.html">/EI_MovieImport/EI_MovieImport.c</option>
<option value="listing21.html">/EI_MovieImport/EI_MovieImport.r</option>
<option value="listing22.html">/EI_MovieImport/EI_MovieImportDispatch.h</option>
<option value="listing23.html">/EI_MovieImport/EI_MovieImportVersion.h</option>
<option value="listing24.html">/ImportExampleTest.c</option>
<option value="listing25.html">/plist_carb.r</option>
<option value="listing26.html">/PrefixIncludes/EIComponentPB.r</option>
<option value="listing27.html">/PrefixIncludes/EIComponentStandAloneCarbon.h</option>
<option value="listing28.html">/PrefixIncludes/EIComponentStandAloneMachO.r</option>
<option value="listing29.html">/PrefixIncludes/EIComponentStandAlonePPC.h</option>
<option value="listing30.html">/PrefixIncludes/EIComponentWindows.r</option>
<option value="listing31.html">/PrefixIncludes/EIComponentWindowsPrefix.h</option>
<option value="listing32.html">/PrefixIncludes/ImportExampleLinked.h</option>
<option value="listing33.html">/PrefixIncludes/ImportExampleLinkedCarbon.h</option>
<option value="listing34.html">/PrefixIncludes/ImportExampleLinkedMachO.r</option>
<option value="listing35.html">/PrefixIncludes/ImportExamplePPC.r</option>
<option value="listing36.html">/RezDocs.txt</option>
<option value="listing37.html">/Utilities/EI_MakeImageDescription.c</option>
<option value="listing38.html">/Utilities/EI_MakeImageDescription.h</option>
<option value="listing39.html">/Utilities/GetFile.c</option>
<option value="listing40.html">/Utilities/GetFile.h</option></select>
				</p>
				</form>
				<p><strong><a href="ElectricImageComponent.win.zip">Download Sample</a></strong> (&#147;ElectricImageComponent.win.zip&#148;, 5.70M)<BR>
<strong><a href="ElectricImageComponent.win.dmg">Download Sample</a></strong> (&#147;ElectricImageComponent.win.dmg&#148;, 6.87M)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*
  File:    EI_GraphicsImport.c
  
  Description: QuickTime graphics importer component

  Author:    QuickTime Engineering
  
  Copyright:   &copy; Copyright 1999-2003 Apple Computer, Inc. All rights reserved.
  
  Disclaimer:  IMPORTANT:  This Apple software is supplied to you by Apple Computer, Inc.
        (&quot;Apple&quot;) in consideration of your agreement to the following terms, and your
        use, installation, modification or redistribution of this Apple software
        constitutes acceptance of these terms.  If you do not agree with these terms,
        please do not use, install, modify or redistribute this Apple software.

        In consideration of your agreement to abide by the following terms, and subject
        to these terms, Apple grants you a personal, non-exclusive license, under Apple's
        copyrights in this original Apple software (the &quot;Apple Software&quot;), to use,
        reproduce, modify and redistribute the Apple Software, with or without
        modifications, in source and/or binary forms; provided that if you redistribute
        the Apple Software in its entirety and without modifications, you must retain
        this notice and the following text and disclaimers in all such redistributions of
        the Apple Software.  Neither the name, trademarks, service marks or logos of
        Apple Computer, Inc. may be used to endorse or promote products derived from the
        Apple Software without specific prior written permission from Apple.  Except as
        expressly stated in this notice, no other rights or licenses, express or implied,
        are granted by Apple herein, including but not limited to any patent rights that
        may be infringed by your derivative works or by other works in which the Apple
        Software may be incorporated.

        The Apple Software is provided by Apple on an &quot;AS IS&quot; basis.  APPLE MAKES NO
        WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION THE IMPLIED
        WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY AND FITNESS FOR A PARTICULAR
        PURPOSE, REGARDING THE APPLE SOFTWARE OR ITS USE AND OPERATION ALONE OR IN
        COMBINATION WITH YOUR PRODUCTS.

        IN NO EVENT SHALL APPLE BE LIABLE FOR ANY SPECIAL, INDIRECT, INCIDENTAL OR
        CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE
        GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
        ARISING IN ANY WAY OUT OF THE USE, REPRODUCTION, MODIFICATION AND/OR DISTRIBUTION
        OF THE APPLE SOFTWARE, HOWEVER CAUSED AND WHETHER UNDER THEORY OF CONTRACT, TORT
        (INCLUDING NEGLIGENCE), STRICT LIABILITY OR OTHERWISE, EVEN IF APPLE HAS BEEN
        ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
        
  Change History (most recent first):
     &lt;2&gt;    12/09/00  ERA      updated for X
     &lt;1&gt;     11/28/99  QTE      first file
*/

#if TARGET_OS_WIN32
    #include &quot;EIComponentWindowsPrefix.h&quot;
#endif

#if __MACH__
    #include &lt;Carbon/Carbon.h&gt;
    #include &lt;QuickTime/QuickTime.h&gt;
#else
    #include &lt;Endian.h&gt;
    #include &lt;ImageCompression.h&gt;
    #include &lt;Movies.h&gt;
    #include &lt;Script.h&gt;
    #include &lt;TextUtils.h&gt;
#endif

#include &quot;EI_Image.h&quot;
#include &quot;EI_MakeImageDescription.h&quot;
#include &quot;EI_GraphicsImportVersion.h&quot;

// Component globals
typedef struct {
  ComponentInstance    self;
  ComponentInstance    parent;
  ComponentInstance    delegateComponent;
} EI_GraphicsImportGlobalsRecord, *EI_GraphicsImportGlobals;

// Setup required for ComponentDispatchHelper.c
#define GRAPHICSIMPORT_BASENAME()  EI_GraphicsImport
#define GRAPHICSIMPORT_GLOBALS()   EI_GraphicsImportGlobals storage

#define CALLCOMPONENT_BASENAME()  GRAPHICSIMPORT_BASENAME()
#define  CALLCOMPONENT_GLOBALS()    GRAPHICSIMPORT_GLOBALS()

#define COMPONENT_UPP_PREFIX()    uppGraphicsImport
#define COMPONENT_DISPATCH_FILE    &quot;EI_GraphicsImportDispatch.h&quot;
#define COMPONENT_SELECT_PREFIX()    kGraphicsImport

#define  GET_DELEGATE_COMPONENT()  (storage-&gt;delegateComponent)

#if __MACH__
  #include &lt;CoreServices/Components.k.h&gt;
  #include &lt;QuickTime/ImageCompression.k.h&gt;
  #include &lt;QuickTime/ComponentDispatchHelper.c&gt;
#else
  #include &lt;Components.k.h&gt;
  #include &lt;ImageCompression.k.h&gt;
  #include &lt;ComponentDispatchHelper.c&gt;
#endif

// Component Open Request - Required
pascal ComponentResult EI_GraphicsImportOpen(EI_GraphicsImportGlobals store, ComponentInstance self)
{
  ComponentResult err = noErr;

  // Allocate memory for our globals, set them up and inform the component manager that we've done so
  store = (EI_GraphicsImportGlobals)NewPtrClear(sizeof(EI_GraphicsImportGlobalsRecord));
  if (err = MemError()) goto bail;
  
  store-&gt;self = self;
  store-&gt;parent = self;

  SetComponentInstanceStorage(self, (Handle)store);

  // Open and target an instance of the base graphic importer as we delegate
  // most of our calls to the base importer instance
  err = OpenADefaultComponent(GraphicsImporterComponentType, GraphicsImporterComponentType, &amp;store-&gt;delegateComponent);
  if (err) goto bail;
  
  err = ComponentSetTarget(store-&gt;delegateComponent, self);
  if (err) goto bail;

bail:
  return err;
}

// Component Close Request - Required
pascal ComponentResult EI_GraphicsImportClose(EI_GraphicsImportGlobals store, ComponentInstance self)
{
#pragma unused(self)
  
  // Make sure to close the base component and dealocate our storage
  if (store) {
    if (store-&gt;delegateComponent)
      CloseComponent(store-&gt;delegateComponent);

    DisposePtr((Ptr)store);
  }

  return noErr;
}

// Component Version Request - Required
pascal ComponentResult EI_GraphicsImportVersion(EI_GraphicsImportGlobals store)
{
#pragma unused(store)

  #if TARGET_CPU_68K || TARGET_OS_WIN32
    return kEI_GraphicsImportVersion;
  #else
    return kEI_GraphicsImportVersionPPC;
  #endif
}

// Component Target Request
//     Allows another component to &quot;target&quot; you i.e., you call another component whenever
// you would call yourself (as a result of your component being used by another component)
pascal ComponentResult EI_GraphicsImportTarget(EI_GraphicsImportGlobals store, ComponentInstance target)
{
  store-&gt;parent = target;
  
  return noErr;
}

#pragma mark-

// GraphicsImportGetImageDescription
//    Examine the image file and construct an image description for it.
// The base importer uses this image description to respond to other calls such as GraphicsImportGetNaturalBounds and
// GraphicsImportDraw. In the case of GraphicsImportDraw, the image description is passed to the Image Compression
// Manager, so the cType field must identify a codec that will be able to draw the image. If a graphics importer needs to pass
// extra information that the codec will need at PreDecompress time, it can pass it in an image description extension.
pascal ComponentResult EI_GraphicsImportGetImageDescription(EI_GraphicsImportGlobals store, ImageDescriptionHandle *descOut)
{
  ComponentResult err = noErr;
  ImageFrame frame;
  unsigned long offset, size;
  short colorCount;
  Ptr colors = NULL;

  if (!descOut)
    return paramErr;

  // Get the offset and size of the image data
  err = GraphicsImportGetDataOffsetAndSize(store-&gt;parent, &amp;offset, &amp;size);
  if (err) goto bail;

  // Read some data, in this case an ImageFrame (this is specific to the Electric Image Format)
  err = GraphicsImportReadData(store-&gt;parent, &amp;frame, offset, sizeof(frame));
  if (err) goto bail;

  // framePalettes contains the number of entries in the color table
  colorCount = EndianU16_BtoN(frame.framePalettes);

  // Alocate some storage for the color table and get it
  colors = NewPtr(3 * colorCount);
  if (err = MemError()) goto bail;

  err = GraphicsImportReadData(store-&gt;parent, colors, offset + sizeof(frame), 3 * colorCount);
  if (err) goto bail;

  // Create the Image Description
  err = EI_MakeImageDescription(&amp;frame, colorCount, (UInt8 *)colors, descOut);
  if (err) goto bail;

bail:
  if (colors)
    DisposePtr(colors);

  return err;  
}

// GraphicsImportGetDataOffsetAndSize
//     Returns the offset and size of the compressed image data within a file.
// Sometimes, the data to be passed to the image decompressor is only a portion of the file. In these cases, implement
// the GraphicsImportGetDataOffsetAndSize function to indicate the byte range to send to the image decompressor.
// It is often useful for this call to first call the base importer's implementation to find out the size of the input data stream.
pascal ComponentResult EI_GraphicsImportGetDataOffsetAndSize(EI_GraphicsImportGlobals store, unsigned long *offsetOut, unsigned long *sizeOut)
{
  ComponentResult err = noErr;
  ImageHeader header;
  ImageFrame frame;
  unsigned long offset, size;

  // Call the base importer first
  err = GraphicsImportGetDataOffsetAndSize(store-&gt;delegateComponent, &amp;offset, &amp;size);
  if (err) goto bail;

  // Read some data
  err = GraphicsImportReadData(store-&gt;parent, &amp;header, offset, sizeof(header));
  if (err) goto bail;

  // If we don't like what we see bail!
  if ((EndianU16_BtoN(header.imageVersion) != 5) || (EndianU32_BtoN(header.imageFrames) &lt; 1)) {
    err = codecBadDataErr;
    goto bail;
  }

  // Read some more data
  err = GraphicsImportReadData(store-&gt;parent, &amp;frame, offset + sizeof(header), sizeof(frame));
  if (err) goto bail;

  // Set the correct offset into the image and adjust the size appropriately
  if (offsetOut) *offsetOut = offset + sizeof(ImageHeader);
  if (sizeOut) *sizeOut = sizeof(ImageFrame) + (EndianU16_BtoN(frame.framePalettes) * 3) + EndianU32_BtoN(frame.frameSize);

bail:
  return err;
}

// GraphicsImportValidate
//     Attempt to ascertain quickly whether a file matches the importer's format.
// This is especially useful for formats which start with identifying codes or &quot;magic numbers&quot; (such as PNG and TIFF)
// in situations where image files do not have correct file types or suffixes. In situations like this, the Image Compression
// Manager may ask many graphics importers in turn to validate until it finds one that accepts the file, so it is important that
// GraphicsImportValidate calls not be too slow. Importers that implement the GraphicsImportValidate call
// should have the canMovieImportValidateFile bit set in their component flags.
pascal ComponentResult EI_GraphicsImportValidate(EI_GraphicsImportGlobals store, Boolean *valid)
{
  ComponentResult err = noErr;
  unsigned char header[2];

  *valid = false;

  err = GraphicsImportReadData(store-&gt;parent, &amp;header[0], 0, 2);
  if (err) goto bail;
  
  // If your image format has a &quot;magic number&quot; at the start, this is where you should look for it.
  
  // Electric Image files don't have a magic number, but they do have a version code, which should
  // be a big-endian two-byte integer &quot;5&quot;.  So we'll check that.   
  if( ( 0 == header[0] )
   &amp;&amp; ( 5 == header[1] ) )
    *valid = true;
    
bail:
  return err;
}

// GraphicsImportGetMetaData
//     Extract metadata from an image file and add it to a user data structure.
// Note that userData must already be allocated. If the user data passed to GraphicsImportGetMetaData
// belongs to a movie, track or media, then whatever metadata is extracted will be added to that movie, track or media.
pascal ComponentResult EI_GraphicsImportGetMetaData(EI_GraphicsImportGlobals store, void *userData)
{
#pragma unused(store)

  ComponentResult err = noErr;
  Handle  dataHandle = NULL;
  UserData userDataOut = (UserData)userData;

  // For the sake of example we'll return a fixed string as metadata.
  char *theCString = { &quot;File created with Electric Image&quot; };
  
  #if !TARGET_API_MAC_CARBON
    StringPtr thePString = c2pstr(theCString);
  #else
    Str255 thePString;
    CopyCStringToPascal(theCString, thePString);
  #endif // TARGET_API_MAC_CARBON

  if (NULL == userData) {
    err = paramErr;
    goto bail;
  }

  dataHandle = NewHandle(0);
  if (NULL == dataHandle) {
    err = memFullErr;
    goto bail;
  }
  
  err = PtrAndHand(&amp;thePString[1], dataHandle, thePString[0]);
  if (err) goto bail;
  
  err = AddUserDataText(userDataOut, dataHandle, kUserDataTextInformation, 1, langEnglish);

bail:
  if (dataHandle)
    DisposeHandle(dataHandle);

  return err;
}

// GraphicsImportGetMIMETypeList
//     Returns a list of MIME types supported by the graphics import component.
// To indicate that your graphics import component supports this function, set the hasMovieImportMIMEList flag in the
// componentFlags field of the component description record.
pascal ComponentResult EI_GraphicsImportGetMIMETypeList(EI_GraphicsImportGlobals store, void *qtAtomContainerPtr)
{
  // Note that GetComponentResource is only available in QuickTime 3.0 or later.
  // However, it's safe to call it here because GetMIMETypeList is only defined in QuickTime 3.0 or later.
  return GetComponentResource((Component)store-&gt;self, FOUR_CHAR_CODE('mime'), 128, (Handle *)qtAtomContainerPtr);
}

#pragma mark-

// When building the *Application Version Only* make our component available for use by applications (or other clients).
// Once the Component Manager has registered a component, applications can find and open the component using standard
// Component Manager routines.
#if !STAND_ALONE &amp;&amp; !TARGET_OS_WIN32
void EI_GraphicsImporterRegister(void);
void EI_GraphicsImporterRegister(void)
{
  ComponentDescription foo;  
  #if !TARGET_API_MAC_CARBON
    ComponentRoutineUPP componentEntryPoint = NewComponentRoutineProc(EI_GraphicsImportComponentDispatch);
  #else
    ComponentRoutineUPP componentEntryPoint = NewComponentRoutineUPP((ComponentRoutineProcPtr)EI_GraphicsImportComponentDispatch);
  #endif

    foo.componentType = GraphicsImporterComponentType;
    foo.componentSubType = FOUR_CHAR_CODE('EIDI');
    foo.componentManufacturer = kAppleManufacturer;
    foo.componentFlags = 0;
    foo.componentFlagsMask = 0;

  RegisterComponent(&amp;foo, componentEntryPoint, registerComponentGlobal, NULL, NULL, NULL);
}
#endif // !STAND_ALONE &amp;&amp; !TARGET_OS_WIN32
</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/ElectricImageComponent.win/listing7.html%3Fid%3DDTS10000889-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/ElectricImageComponent.win/listing7.html%3Fid%3DDTS10000889-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/ElectricImageComponent.win/listing7.html%3Fid%3DDTS10000889-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>