<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Sending and Receiving Data: An Overview(IM:N)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING186></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Networking-185.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-187.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Networking-2.html"><B>Networking</B></A> / <BR><DD><A HREF="Networking-179.html"><B>Chapter 7 - Datagram Delivery Protocol (DDP)</B></A> / <A HREF="Networking-185.html"><B>Using DDP</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING186-0></A>
<H2><A NAME=MARKER-9-56></A>Sending and Receiving Data: An Overview</H2>
 To send data, you must address each packet to the socket for which it is intended because you cannot open and maintain a connection between two sockets using DDP. To receive a data packet using DDP, you must provide a socket listener process that DDP associates with the socket that your application uses. When you open the socket for your application to use, you must provide a pointer to the socket listener. DDP associates the address of the socket listener with your application's socket so that the .MPP driver can call your socket listener when it receives a packet that is addressed to your socket-client application. DDP maintains a separate entry in its <A NAME=MARKER-2-74></A>socket table for each socket and socket listener pair. <P>
 Applications developers commonly write a single socket-client application that both sends and receives data and that includes a socket listener process to receive data. <BR>To clarify the steps involved in sending and receiving data, this section gives you an overview of these tasks as separate sequences after it explains how to open a socket. <BR>The steps for sending and receiving data refer to sections that are provided later in <BR>this chapter that describe how to<P>
<UL>
<LI>create a write-data structure, which you need to send data
<LI>use the registers that the .MPP driver uses to pass parameters to your socket listener
<LI>write a socket listener, with sample code illustrating this<P>
</UL>
 If you want to provide features in addition to the DDP <A NAME=MARKER-2-166></A>checksum feature to check data and correct errors, you can include them in your application, you can define your own AppleTalk protocol, or you can use a higher-level AppleTalk protocol such as ATP or ADSP instead of calling DDP directly. (For information about DDP checksums, see <A HREF=Networking-188.html#MARKER-9-93>"Using Checksums" beginning on page 7-19</A>.)<P>
 To make your application available to other users of AppleTalk, you must use the NBP <A NAME=MARKER-2-82></A><CODE>PRegisterName</CODE> function to register the name that represents your socket-client applica-<BR>tion. When you are finished using the socket, you must use the NBP <A NAME=MARKER-2-25></A><CODE>PRemoveName</CODE> function to remove this name from the NBP names table. See the chapter "Name-Binding Protocol (NBP)" in this book for more information about these functions. <P>
<A NAME=HEADING186-8></A>
<H3><A NAME=MARKER-9-49></A>Opening a Socket</H3>
 To send and receive data using DDP, your application must first open a socket. Opening a socket makes your application a client of that socket. You open a socket with the <A NAME=MARKER-2-12></A><CODE>POpenSkt</CODE> function. When you open a socket, you must provide a pointer to your socket listener and you must specify 0 for the socket number if you want DDP to dynamically assign a socket. <P>
 <A NAME=MARKER-2-4></A>The <CODE>POpenSkt</CODE> function assigns a socket number to your application and enters the number in the socket table along with the pointer to the socket listener that you provide. The <CODE>POpenSkt</CODE> function returns the socket number to you in the <CODE>socket</CODE> field of the parameter block. <P>
<DL>
<DT><B>Associating a single socket listener with more than one socket</B>
<DD>If your application includes processes that each have their own sockets, you can assign a single <A NAME=MARKER-2-108></A>socket listener to more than one socket, but each socket should have its own buffer or set of buffers for receiving data.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
 If you do not want DDP to randomly assign a socket number to your application, you can specify the number of a particular socket for DDP to open. For information on the range of socket numbers from which you can select, see <A HREF=Networking-182.html#MARKER-9-30>"Assigning Socket Numbers" on page 7-6</A>.<A NAME=MARKER-2-140></A> <P>
<DL>
<DT><B>IMPORTANT</B>
<DD><A NAME=MARKER-9-54></A>You cannot specify a <CODE>NIL</CODE> pointer to the socket listener. If you do, <BR>the system on which your application is running will crash.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 When your application is finished using a socket, you must use the <CODE>PCloseSkt</CODE> function to close the socket. <P>
<A NAME=HEADING186-16></A>
<H3>Sending Data</H3>
 <A NAME=MARKER-2-116></A>To send data, you must create a write-data structure that contains the data in a specific format and then call a DDP function to send the data. After you have opened a socket using the <CODE>POpenSkt</CODE> function, here are the steps that you follow to send data using DDP: <P>
<OL>
<LI>Create a write-data structure. 
<LI>Use the DDP function <CODE>PWriteDDP</CODE> to send the data. <P>
</OL>
 See <A HREF=Networking-187.html#MARKER-9-63>"Creating a DDP Write-Data Structure" beginning on page 7-12</A> for information about how to create a write-data structure using the DDP procedure <CODE>BuildDDPwds</CODE> <BR>or your own code. <P>
 Packets with long headers can include a checksum that can be used to verify the integrity of the packet data. For information on how to direct DDP to calculate a checksum for data that you want to send, see <A HREF=Networking-188.html#MARKER-9-93>"Using Checksums" beginning on page 7-19</A>.<A NAME=MARKER-2-107></A> For details of the contents of a long header, see "The DDP Packet and <BR>Frame Headers" beginning on <A HREF=Networking-188.html#MARKER-9-72>page 7-14</A>.<P>
<A NAME=HEADING186-22></A>
<H3>Receiving Data</H3>
 <A NAME=MARKER-2-121></A>To receive data using DDP, you must provide a socket listener that is part of your socket-<BR>client application. The socket listener code must<P>
<UL>
<LI>be written in assembly language because it must read from and write to the <BR>CPU's registers
<LI>include buffers to hold the data that it reads
<LI>use the register values that the .MPP driver passes to your socket listener
<LI>determine the type of packet, if you have defined more than one protocol type that your application handles
<LI>if the packet includes a<B> </B><A NAME=MARKER-2-126></A>long header, calculate the checksum value, if one is used <P>
</UL>
 There are many ways to design and write a socket-client application and socket listener. This chapter offers one possibility. For details of this sample socket listener and for its code, see <A HREF=Networking-189.html#MARKER-9-101>"A Sample Socket Listener" beginning on page 7-20</A>.<P>
<DL>
<DT><B>Note</B>
<DD>Your socket-client application should test to find out when the socket listener finishes processing a packet so that the socket-client application can begin its own packet reading and processing.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
 To receive data, your application must have already opened a socket using the <CODE>POpenSkt</CODE> function and have passed the <CODE>POpenSkt</CODE> function a pointer to your <BR>socket listener. <P>
 Here are the tasks involved in receiving data using DDP:<P>
<OL>
<LI>The .MPP driver calls your socket listener when it receives a packet addressed to your socket-client application. The .MPP driver passes values to you in the CPU's registers. You need to know how the .MPP driver uses these registers and how you can use them. For information about these registers, see <A HREF=Networking-188.html#MARKER-9-69>"How the .MPP Driver Calls Your Socket Listener" beginning on page 7-13</A>. One of the values that the .MPP driver passes to you is a pointer to the buffer that holds the DDP packet header. You need <BR>to know how the DDP packet header and the<A NAME=MARKER-2-156></A> frame header are structured. For information about these headers, see <A HREF=Networking-188.html#MARKER-9-72>"The DDP Packet and Frame Headers" beginning on page 7-14</A>.
<LI>To hold the data that it reads, your socket listener must allocate memory for buffers. In addition to allocating data buffers, either your socket-client application or the socket listener (if you write the socket listener code to carry out this function) must perform some initialization tasks. For information about these tasks and how the sample socket listener handles them, see <A HREF=Networking-189.html#MARKER-9-103>"Socket Listener Queues and Buffers" beginning on page 7-20</A>, <A HREF=Networking-189.html#MARKER-9-108>"Setting Up the Socket Listener" beginning on page 7-22</A>, <BR>and <A HREF=Networking-189.html#MARKER-9-110>"Initializing the Socket Listener" beginning on page 7-24</A>.
<LI>When the .MPP driver calls your socket listener, the socket listener must read the incoming packet into one or more data buffers. To do this, the socket listener uses two processes, <CODE>ReadPacket</CODE> and <CODE>ReadRest</CODE>, which are implemented as a single routine <BR>in the hardware driver. The .MPP driver passes you the address of this routine in one of the CPU's registers. For more information, see <A HREF=Networking-188.html#MARKER-9-83>"Reading an Incoming Packet" beginning on page 7-17</A>.
<LI><A NAME=MARKER-2-65></A>If you have defined more than one DDP protocol type that your application handles, check the DDP protocol type field of the datagram header (see <A HREF=Networking-188.html#MARKER-9-77>Figure 7-6 on page 7-15</A>) to determine the protocol type of the packet you have just received. <P>
The AppleTalk internet address (network number, node ID, and socket number) is insufficient to distinguish between packets intended for different processes that are using the same socket. Your socket listener must use some other information (such as <A NAME=MARKER-2-61></A>the DDP protocol type or a higher-level protocol header imbedded in the DDP packet data) to make this distinction. 
<LI>If the packet contains a long header, the socket listener needs to find out if the header contains a checksum. If it does, the socket listener needs to calculate the checksum to determine if the packet's data has been corrupted. For more information, see <A HREF=Networking-188.html#MARKER-9-93>"Using Checksums" beginning on page 7-19</A>.
<LI>The socket listener can now process the packet or pass it to the client application for processing. The sample socket listener provided here writes the packet buffer to a queue that it uses for successfully processed packets and removes the packet from the queue for incoming packets. For a description of how the sample socket listener does this, see <A HREF=Networking-189.html#MARKER-9-112>"Processing a Packet" beginning on page 7-25</A>. 
<LI>The client application can now read in the packet for its own purposes. The client application should include code that periodically checks to determine whether the socket listener has finished processing an incoming packet. For a description of how the sample socket listener's client application performs this task and some sample code, see <A HREF=Networking-189.html#MARKER-9-115>"Testing for Available Packets" beginning on page 7-31</A>.<A NAME=MARKER-2-120></A><P>
</OL>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Networking-185.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Networking-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Networking-304.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt= "Book Index"></A> <A HREF="Networking-187.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Networking-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
