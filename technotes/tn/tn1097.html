<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"            "http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><!--Includes revisions to code listings--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1097: Desktop Printing Revealed</title>       <meta name="keywords" content="Mac OS 8 desktop printing background printing future dtp">    <meta name="Description" content="Technical Note TN1097: This Technical Note describes howa printer vendor might add desktop                                    printing support in their printer driver. Thusthis Note covers background printing for all                                    pre-Mac OS X versions of the MacOS."><meta name="categories" content="Printing"><meta name="week-posted" content="Jul 27, 1998 - Aug 7, 1998"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002937" title="Desktop Printing Revealed"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxPrinting-date.html">Printing</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/Printing/idxHardwareDrivers-date.html" target="_blank">Printing > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1097</div>
<div id="pageheadsub">Desktop Printing Revealed</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">            <tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                   <td background="images/tnmenubody.gif" width=300 align=left>                        <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                    <!-- begin_toc -->                    <p id="menutext">         <A HREF = "#Section1">Classic Background Printing</A><BR><BR>                  <A HREF = "#Section2">Desktop Printing Today</A><BR><BR>                  <A HREF = "#Section3">Desktop Printing Tomorrow</A><BR><BR>                  <A HREF = "#Section4">The Future Is Now</A><BR><BR>                           <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="Technote menu gif" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left>   <!-- begin_intro_text -->         <P id = "introtext">This Technote, originally written in February 1997, describes how a printer vendor might add desktop printing support in their printer driver. Support for third-party desktop printing has been added to Mac OS 8.5 with specification changes, so we encourage you to read the revisions in this updated Technote, and to try adding desktop printing support to your printer driver.</p>                                   <!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Aug 10 1998]</h3><!-- end_date -->                </TD>             </TR>          </TABLE> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><P>With the introduction of System 6 and MultiFinder in 1989, Apple         introduced background printing. For the first time, a user         could regain control of the Macintosh almost immediately         after printing a document, while the printer driver         processed the document in the background. Classic background         printing has been far more robust than anyone might have         imagined, and it's still the basis of much of today's         printing technology, including desktop printing.         Unfortunately for developers interested in supporting         desktop printing, the interfaces to background printing have         remained largely undocumented.</P>          <P>In 1994, the desktop printing architecture was introduced         with the LaserWriter 8.3 and the StyleWriter 1200 driver. From         its initial release to the present, desktop printing has         existed as a collection of extensions and invisible         applications. While this has not created a clear and simple         picture for developers interested in supporting desktop         printing, this technology shows every sign of thriving for a         long time to come, so understanding its architecture is more         vital than ever.         </P>                  <P>While the complete story is far from written, and things         will certainly change again with the introduction of         Mac OS X, this article will cover background printing for         all pre-Mac OS X versions of the Mac OS. This includes the         significant changes that make Desktop Printing         accessible to third-party developers. If you currently         have a printer driver, this updated article describes         everything you need to add support for desktop printing.</P><BR><BR>         <A NAME="Section1"></A>         <H2>Classic Background Printing</H2>                  <P>In early background printing, printer         drivers would save each page as a QuickDraw picture in the         data fork of a temporary file (a spool file) in a special         folder (the Spool Folder) within the System Folder. There         was also information stored in the resource fork describing         the page format, document name, and other job information,         as well as offsets to the beginning of the data for each         page. A special application (Backgrounder) launched by         MultiFinder at startup time (in System 7, Backgrounder was         incorporated into Finder) would see the document created by         the printer driver and would then launch PrintMonitor, which         would run in the background, feeding the spool file to the         printer driver.</P>                  <P>PrintMonitor performs its magic by calling the printer         driver in much the same way as an application would, except         rather than your driver's '<CODE>PDEF' 0</CODE> resource getting called,         its <CODE>'PDEF' 126</CODE> resource--which has the same format         as the <CODE>'PDEF' 0</CODE> resource--is called. A special         <CODE>PrGeneral</CODE> call is sent just after <CODE>PrOpen</CODE> has been called         (before <CODE>PrOpenDoc</CODE> has been called) to provide the printer         driver with the pointers to notification functions it will         need to call. PrintMonitor then prints each page by         replaying the stored page data to the driver. This method of         background printing is still used by the Printing Manager         today in two cases: when desktop printing isn't installed         (or has been disabled) and when the Finder isn't running         (usually because At Ease is running instead).</P>                  <P>Getting to know classic background printing means learning the structure of its spool file. The resource         fork of the spool file contains the following resources         (note that all structures mentioned in this document have         68k alignment): </P><UL TYPE=DISC>    <LI>'PREC' 3 -- the print record</li></UL><UL TYPE=DISC>    <LI>'alis' -8192 -- an alias to the driver that         created the spool file</li></UL><UL TYPE=DISC>    <LI>'ics#' 131 -- the small icon to display for the         spool file in the PrintMonitor window</li></UL><UL TYPE=DISC>    <LI>'PREC' 124 -- the printer name</li></UL><UL TYPE=DISC>    <LI>'PREC' 126 -- the job information</li></UL>       <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>    <td bgcolor="#E6E6E6" align=left><pre>typedef {    short version;    // always 1    short flags;      // always 0    short numPages;   // total number of pages in the spool file    short numCopies;  // total number of copies for the spool file    OSType creator;   // the creator type of the driver used to                      // create the spool file    Str31 appName;    // the application name used to print the                      // spool file} PREC126Record, *PREC126Ptr, **PREC126Handle;</pre>    </TD></TR></TABLE></CENTER>               <UL TYPE=DISC>    <LI>'STR ' -8192 -- the filename of the printer         driver</li></UL><UL TYPE=DISC>    <LI>'STR ' -8189 -- the document name [always padded         to 80 bytes]</li></UL> The data fork of the spool file with a <CODE>SpoolFileHeader</CODE> structure, followed by the pages. <BR> <BR>         <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>    <td bgcolor="#E6E6E6" align=left><pre>typedef struct {    short version;      // should always be 1    long fileLen;       // length of file including spool file header    long fileFlags;     // should always be 0    short numPages;     // total number of pages in the spool file    TPrint printRecord; // used only if PREC 3 can't be read} SpoolFileHeader, *SpoolFileHeaderPtr, **SpoolFileHeaderHandle;typedef struct {    long pictFlags;      // should always be 0    Picture thePict;     // variable length    long pageOffset;     // offset to the beginning of this page's                         // PICT} SpoolPage;</pre>    </TD></TR></TABLE></CENTER>         <P>The spool file is created by the driver in the Spool Folder or PrintMonitor Documents folder within the System Folder (or in the current default desktop printer folder if Mac OS 8 desktop printing is active-- you can find the correct folder with <CODE>FindFolder</CODE> and the <CODE>kPrintMonitorDocsFolderType</CODE> selector). Spool files that are         being written have a type of <CODE>'?job'</CODE> and a creator of <CODE>'prmt'</CODE>.         Once the file is completely written, the driver changes the         type to <CODE>'pjob'</CODE>. When the version of Desktop Printing that         supports third-party drivers is available, your driver also         needs to send an Apple event to the Finder telling it that a         new spool file was created (more on this below).</P>                  <P>When PrintMonitor (or Desktop PrintMonitor) prints a job,         it calls the driver's <CODE>PrOpen</CODE> routine and then calls         <CODE>PrGeneral</CODE> with the structure shown below (see the         "DesktopPrinting.h" header file for specifics). PrintMonitor         then calls <CODE>PrOpenDoc</CODE> with a <CODE>pIdleProc</CODE> that the driver needs         to call periodically. <CODE>PrOpenPage</CODE> and <CODE>PrClosePage</CODE> will get         called for each page of the document, and the page will be         printed to the driver.</P>                  <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>    <td bgcolor="#E6E6E6" align=left><pre>// Notification Procstypedef pascal void (*DTPAsyncErrorNotificationProcPtr) (StringHandle string);typedef pascal void (*DTPEndNotificationProcPtr) ();typedef pascal Boolean (*DTPInForegroundProcPtr) ();typedef pascal void (*DTPStatusMessageProcPtr) (StringHandle string);// PrGeneral call that PrintMonitor/Desktop PrintMonitor// use to set up the notification process#define kPrintMonitorPrGeneral = -3;// TPrintMonitorPrintingData:// for classic background printing and desktop printing// that does not support third-party driverstypedef struct {    short iOpCode;    // kPrintMonitorPrGeneral    short iError;    long iReserved;   // 0 - classic PrintMonitor is running    THPrint hPrint;    short noProcs;    // number of notification procs    long iReserved2;    DTPAsyncErrorNotificationUPP        pAsyncNotificationProc; // UPP to put up a notification    DTPEndNotificationUPP        pAsyncEndnotifyProc;    // UPP to take down                                // the notification    DTPInForegroundUPP        pDTPInForegroundProc;   // UPP to check if PrintMonitor is                                // in foreground} TPrintMonitorPrintingData;// TDesktopPrintMonitorPrintingData:// for desktop printing that supports third-party print driverstypedef struct {    short iOpCode;      // kPrintMonitorPrGeneral    short iError;    long iReserved;     // 1 - Desktop PrintMonitor is running    THPrint hPrint;    short noProcs;      // number of notification procs    long iReserved2;    DTPAsyncErrorNotificationUPP        pAsyncNotificationProc; // UPP to put up a notification    DTPEndNotificationUPP        pAsyncEndnotifyProc; // UPP to take down the notification    DTPInForegroundUPP        pInForegroundProc; // UPP to check if desktop printing is                           // in foreground    DTPStatusMessageUPP        pStatusMessageProc; // UPP to update the printing status                            // message in the desktop printer window} TDesktopPrintMonitorPrintingData;</pre>    </TD></TR></TABLE></CENTER>                   <P>When printing with background printing, both PrintMonitor         and Desktop PrintMonitor will put a <CODE>DialogPtr</CODE> into the         low-memory global <CODE>ApplScratch</CODE> just before calling <CODE>PrOpenDoc</CODE>.         The driver should put status messages into the first item in         that dialog using <CODE>GetDialogItem</CODE> and <CODE>SetDialogItemText</CODE>.</P>                  <P>If the <CODE>PrGeneral</CODE> call says that printing is occurring         from Desktop PrintMonitor (which is a faceless background         application), no dialogs or alerts should be displayed. The         one exception is that Desktop PrintMonitor patches <CODE>StopAlert</CODE>         and <CODE>ParamText</CODE>. If you call <CODE>ParamText</CODE> and then <CODE>StopAlert</CODE>, the         Finder will display an alert for you with the text you've         set. However, the filter proc passed into <CODE>StopAlert</CODE> will not         be called. </P>                  <P> A printer driver can provide the user the options of putting          a job on hold, stopping the print queue, trying to print again, or canceling the job. After user selects an option in the alert,          the printer driver should set the print manager error (<CODE>SetPrError</CODE>)          to one of the following error codes that corresponds to user selection:</p>        <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>    <td bgcolor="#E6E6E6" align=left><pre>//// desktop printing error codes//#define kDTPHoldJobErr -4200#define kDTPStopQueueErr -4201#define kDTPTryAgainErr -4202#define kDTPAbortJobErr 128        </pre>    </TD></TR></TABLE></CENTER> <P>        Desktop PrintMonitor will then put the job on hold, stop the print queue,         try to print the job again, or cancel the job accordingly.</P>                   <P><A HREF="#top">Back to top</A></P>         <A NAME="Section2"></A>         <H2>Desktop Printing Today</H2>                 <P>Desktop printing was introduced with the LaserWriter 8.3         and the StyleWriter 1200 printer drivers, and it uses much         the same approach as classic background printing. Currently,         desktop printing only supports Apple print drivers, but the         additions described in this section are things you will need         to incorporate into your drivers so they will work with         desktop printing in the future.</P>                 <P>The additional resources a driver needs to add to support         desktop printing are the icons for the desktop printers. As         a driver developer you'll need to supply a full <CODE>'BNDL'</CODE>         resource with your driver's creator. Beyond the types and         icons you've probably already got in your driver (for the         driver itself and any preferences file), you'll need to add         icons for the types <CODE>'dpnn'</CODE>, <CODE>'dpcn'</CODE>, and <CODE>'dpna'</CODE>, which         correspond to a "normal" desktop printer, a default desktop         printer (with the heavy line around it), and an inactive (or         unavailable) desktop printer. As an example, the bundle from         the Color StyleWriter 2500 is shown below. LaserWriter 8 has         a slightly different scheme for setting the icons for         desktop printers; it retrieves them from the         PostScript printer description (PPD) file for a given         printer.</P>                           <P align=center><img src="images/tn1097_001.gif" border=0 alt="The StyleWriter 2500 bundle and icons" width=219 height=197><BR>         <B>Figure 1.</b>The StyleWriter 2500 bundle and icons</P>                  <p>When an Apple driver creates a spool file for desktop          printing, it places the file in the same folder used by          classic background printing. The Desktop Printing Extension          will take care of moving the file to the desktop printer and          beginning the process of actually printing the document. When           desktop printing is active, the following resources are added           to the spool file: </P>               <UL TYPE=DISC>    <LI>'PINX' -8200 -- the page index resource</li></UL>      <UL TYPE=DISC>    <LI>'jobi' 1 -- the print job information</li></UL><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>    <td bgcolor="#E6E6E6" align=left><pre>// PINX -8200 (page index resource)typedef struct {    short count;         // number of elements in the pageOffset array    long pageOffset[1];  // the offset from the beginning of the file                         // to the page record                         // e.g., it would be sizeof(SpoolFileHeader)                         // for the first page.} SpoolPageIndex,  *SpoolPageIndexPtr, **SpoolPageIndexHandle;// jobi 1 (DTP print job information resource)// print priorities#define kDTPPrintJobUrgent 0x00000001#define kDTPPrintJobAtTime 0x00000002#define kDTPPrintJobNormal 0x00000003#define kDTPPrintJobHolding 0x00001003typedef struct{    short firstPageToPrint;  // first page in the spool file to print    short priority;          // print priority (e.g.,  kDTPPrintJobNormal)    short numCopies;         // total number of copies    short numPages;          // total number of pages in the spool file    unsigned long  timeToPrint;  // time to print (in seconds) when                                 // priority is kDTPPrintJobAtTime    Str31 documentName;     // name of the document    Str31 applicationName;  // name of the application that's used                            // to create this spool file    Str32 printerName;      // name of the target printer                            // (should be the same as what's in PREC 124)} DTPPrintJobInfo, *DTPPrintJobInfoPtr, **DTPPrintJobInfoHandle;</pre>    </TD></TR></TABLE></CENTER>                  <P>Another addition is a new way to change the default         desktop printer. An application or driver can send an Apple         event to the Finder as shown below. (Note that         <CODE>SendAEToFinder</CODE> just sends the event to the Finder--see "DTPSample.c" for info.)</P>         <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>    <td bgcolor="#E6E6E6" align=left><pre>#define kDTPSignature  'dtpx'#define aeDTPSetDefaultEventType 'pfsd'// event datatypedef struct {    OSType dtpSignature; // kDTPSignature    OSType dtpEventType; // aeDTPSetDefaultEventType or aeDTPSyncEventType    FSSpec dtpSpec; // the file spec of the target dtp} DTPAppleEventData;OSErr SetDefaultDTP(const FSSpec* dtpSpec) {    OSErr err;    DTPAppleEventData myEvent;    myEvent.dtpsignature = kDTPSignature;    myEvent.dtpEventType = aeDTPSetDefaultEventType;    BlockMove((Ptr)dtpSpec, (Ptr)&amp;myEvent.dtpSpec, sizeof(FSSpec));    err = SendAEToFinder((Ptr)&amp;myEvent, sizeof(DTPAppleEventData));    return err;}</pre>    </TD></TR></TABLE></CENTER> <P><A HREF="#top">Back to top</A></P>         <A NAME="Section3"></A>         <H2>Desktop Printing Tomorrow</H2>                 <P>With the introduction of Mac OS 8, desktop printing will         no longer be a separate extension. It will be integrated         into the Finder and therefore available in most cases. A         user can still disable desktop printing by disabling the         Desktop PrintMonitor and Desktop Printer Spooler in         Extensions Manager, though. In Mac OS 8.5, changes have been          made to make it possible for third          parties to integrate support.</P>                  <P>Desktop printing installs a <CODE>Gestalt</CODE> selector to         tell you         if third-party drivers can be supported. If desktop printing         is available, but this selector does not report that         third-party drivers are supported by desktop printing, you         will need to use the methods described in the "Classic         Background Printing" section above.</P><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>    <td bgcolor="#E6E6E6" align=left><pre>//// Desktop Printing Feature Gestalt// Use this gestalt to check if third-party printer driver support is available//enum { gestaltDTPFeatures = 'dtpf' };#define kDTPThirdPartySupported 0x00000004  // mask for checking if third-                                            // party drivers are supportedBoolean ThirdPartyDriverSupported(void) {    long response;    Boolean result = false;    OSErr err = Gestalt(gestaltDTPFeatures, &amp;response);    if (err == noErr) {        result = !!(response &amp; kDTPThirdPartySupported);    }    return(result);}</pre>    </TD></TR></TABLE></CENTER>        <P>When non-Apple drivers are supported by desktop printing,         your driver needs to write your spool files directly to the         desktop printer folder with the type of <CODE>'?job'</CODE>. When you are         done spooling, you need to change the file's type to <CODE>'pjob'</CODE>.         The driver can determine the current default desktop printer         folder, and many other things, by calling the <CODE>Gestalt</CODE>         routine with the desktop printing extension selector. The         selector is <CODE>'dtpx'</CODE>, and the information is returned to you         in a handle. When you're done with the handle, do not call         <CODE>DisposeHandle</CODE> on <CODE>theDTPList</CODE> and the <CODE>GestaltDTPInfoHdle</CODE>.</P>         <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>    <td bgcolor="#E6E6E6" align=left><pre>//// Desktop Printer Info Gestalt// Use this gestalt to gather information for all of the// active desktop printers//enum { gestaltDTPInfo = 'dtpx' };enum{        // version 2.0f0 (for Mac OS 8.0, 8.1 and 7.x)    kDTPGestaltStructVersion2 = 0x02008000,        // version 3.0 (for Mac OS 8.5)    kDTPGestaltStructVersion3 = 0x03000000};// DTPInfotypedef struct {    short vRefNum;      // vRefNum of the DTP folder    long dirID;         // directory ID of the DTP folder    Str31 dtpName;      // name of the DTP folder    OSType driverType;  // creator type of the print driver for this DTP    Boolean current;    // is this DTP currently the default printer?    Str32 printerName;  // name of the actual printer on the net                        // (only for LaserWriter 8 dtps)    Str32 zoneName;     // zone where this printer resides                        // (only for LaserWriter 8 dtps)} DTPInfo;// data associated with the desktop printer info gestalttypedef struct {    long version; // kDTPGestaltStructVersion3 or kDTPGestaltStructVersion2    short numDTPs; // number of the active dtps    Handle theDTPList; // handle to a list of DTPInfo for the active dtps    Handle theDTPDriverList; // handle to a list of print driver file specs for                             // each of the active dtp in theDTPList    long reserved;} GestaltDTPInfo, **GestaltDTPInfoHdle;         </pre>    </TD></TR></TABLE></CENTER>                  <P>When you're done writing the spool file, you need to send         an Apple event to tell the Finder about the new spool file          (see <CODE>SyncDTP</CODE> function in the file "DTPSample.c").</p>                           <P>There are also added calls for this version of desktop         printing. Specifically, there are three new <CODE>PrGeneral</CODE>         selectors that a driver needs to support:          <CODE>kDTPIsSamePrinterInfo</CODE>, <CODE>kDTPGetPrinterInfo</CODE>, and         <CODE>kDTPSetDefaultPrinterInfo</CODE>. These selectors enable the desktop         printing extension to decide which of the driver's desktop         printers is the current default printer, to determine         whether it needs to create a new desktop printer, and to         inform the driver that a desktop printer has been selected         as the default. The structures you'll need to use to support         these selectors are shown below:</p>       <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>    <td bgcolor="#E6E6E6" align=left><pre>// PrGeneral opcodesenum{    kDTPGetPrinterInfo        = 23,    kDTPIsSamePrinterInfo     = 24,    kDTPSetDefaultPrinterInfo = 25};// DTP printer types (address types)enum{    kDTPUnknownPrinterType      = -1,   // unknown address type    kDTPSerialPrinterType       = 0,    // serial printer    kDTPAppleTalkPrinterType    = 1,    // AppleTalk printer    kDTPTCPIPPrinterType        = 2,    // TCP/IP printer    kDTPSCSIPrinterType         = 3,    // SCSI printer    kDTPUSBPrinterType          = 4     // USB printer};// serial portsenum{    kDTPUnknownPort = -1, // for drivers that support serial connection by the                          // Comm Toolbox other than modem and printer port    kDTPPrinterPort = 0,  // printer port    kDTPModemPort = 1     // modem port};// serial printer addresstypedef struct{    short    port;        // kDTPPrinterPort, kDTPModemPort or kDTPUnknownPort    Str31    portName;    // name of the port specified in the port field} DTPSerialAddress;// AppleTalk printer addresstypedef struct{    Str32    nbpName;    Str32    nbpZone;    Str32    nbpType;} DTPAppleTalkAddress;// TCP/IP printer addresstypedef struct{    Str255    TCPIPAddress;    Str255    queueName;} DTPTCPIPAddress;// SCSI printer addresstypedef struct{    short    id;         // SCSI id} DTPSCSIAddress;// USB printer addresstypedef struct{    Str255    name;       // printer name} DTPUSBAddress;// data passed into the PrGeneral callstypedef struct{    Str31 dtpDefaultName; // default name for the desktop printer.    short printerType;    // kDTPSerialPrinterType, kDTPAppleTalkPrinterType,                          // kDTPTCPIPPrinterType, kDTPSCSIPrinterType,                          // kDTPUSBPrinterType or kDTPUnknownPrinterType    // Info specific to each type of printers    union    {        DTPSerialAddress    serial;        DTPAppleTalkAddress appleTalk;        DTPTCPIPAddress     tcpip;        DTPSCSIAddress      scsi;        DTPUSBAddress       usb;    } u;    // optional driver-specific information can be appended here} DTPPrinterInfo, **DTPPrinterInfoHandle;typedef struct {    short iOpCode; // kDTPGetPrinterInfo, kDTPIsSamePrinterInfo                   // or kDTPSetDefaultPrinterInfo    short iError;    long iCommand;    DTPPrinterInfoHandle printerInfo;} TDTPPrGeneralData;</pre>    </TD></TR></TABLE></CENTER>In order for the Finder to recognize whether or not your device supports desktop printing, you need to add the <CODE>'dtpi'</CODE> resource to the printer driver's resource fork.<CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>    <td bgcolor="#E6E6E6" align=left><pre>//// desktop printer info resource//#define kDTPInfoResType 'dtpi'#define kDTPInfoResID -8192// connection types supported#define kDTPUnknownConnection 0x00000000 // unknown connection type#define kDTPSerialConnection 0x00000001 // serial connection#define kDTPSCSIConnection 0x00000002 // SCSI connection#define kDTPAppleTalkConnection 0x00000004 // AppleTalk connection#define kDTPTCPIPConnection 0x00000008 // TCP/IP connection#define kDTPUSBConnection 0x00000010 // USB connection// dtp extra features supported#define kDTPBasicFeatures 0x00000000 // only basic dtp funtionalities                                     // are supportedtypedef struct{    long features; // kDTPBasicFeatures (only basic features are supported                   // for MacOS 8.5)    long connectionType; // can be kDTPUnknownConnection or any combination                         // of kDTPSerialConnection, kDTPSCSIConnection,                         // kDTPAppleTalkConnection, kDTPTCPIPConnection,                         // and kDTPUSBConnection} DTPInfoResource;</pre>    </TD></TR></TABLE></CENTER>         <P>When your driver is selected in the Chooser, desktop         printing will call your driver via a series of <CODE>PrGeneral</CODE>         calls. First, you'll get called with the <CODE>kIsSamePrinterInfo</CODE>         selector for each of the desktop printers created by your         driver in order to determine which is the currently selected         printer. Your driver responds by filling in the <CODE>iError</CODE> field         of the <CODE>TPrinterInfoPrGeneralData</CODE> record. If the printer that         your driver thinks is current matches the information passed         in with the <CODE>kIsSamePrinterInfo</CODE> selector, the driver responds         by setting the <CODE>iError</CODE> field to <CODE>noErr</CODE>. If it's not a match,         the driver sets the <CODE>iError</CODE> field to <I>-1</I>.</P>                  <P>If the printer selected in the Chooser is not among the         desktop printers owned by your driver, desktop printing will         create a new desktop printer and call <CODE>PrGeneral</CODE> with the         <CODE>kGetPrinterInfo</CODE> selector to get the information for the         selected printer. At this point, your driver should resize         the <CODE>printerInfo</CODE> handle and fill in the printer information.         You need to fill in the <CODE>dtpDefaultName</CODE> field with the name         you'd like to see assigned to the newly created desktop printer. Note also         that your driver can append as much (or as little) extra         printer information as you'd like. Once you've returned the         information, the desktop printing extension will save this         information into the desktop printer.</P>                  <P>If a user selects one of your desktop printers via the         Set Default Printer menu item in the Printing menu (which         appears in the Finder when you've clicked on a desktop         printer), your driver will get a <CODE>PrGeneral</CODE> call with the         <CODE>kSetDefaultPrinterInfo</CODE> selector. When you receive this call,         you should change any internal settings your driver         maintains so that the printer pointed to by the         <CODE>DTPPrinterInfo</CODE> handle you received is now the currently selected         printer for your driver.</P>          <P><A HREF="#top">Back to top</A></P>                   <A NAME="Section4"></A>         <H2>The Future Is Now</H2>                  <P>If you've currently got a driver that supports classic         background printing, your best bet for future compatibility         is to add support for desktop printing. However, if you're         just starting to tackle background printing now, and while you         could implement support for Mac OS 8 desktop printing only,         we strongly recommend that you support the current desktop         printing architecture and classic background printing as         well. That way, your users will have a more consistent         experience when printing, regardless of which version of the         Mac OS they're running.</P>                   <P><A HREF="#top">Back to top</A></P>                                    <P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (100K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tn1097.pdf">Download</A></P>               </TD>            </TR> <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/redbook.gif" width=20 height=20 align=bottom alt="Redbook gif"></P>               </TD>               <td align="left">                  <P>DesktopPrinting.h (144K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF = "downloads/tn_1097.1.hqx">Download</A></P>               </TD>            </TR>            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/redbook.gif" width=20 height=20 align=bottom alt="Redbook gif"></P>               </TD>               <td align="left">                  <P>DTPSample.c (140K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF = "downloads/tn_1097.2.hqx">Download</A></P>               </TD>            </TR>         </TABLE>         <BR>                  <P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content -->        <!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1097.html%3Fid%3DDTS10002937-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1097.html%3Fid%3DDTS10002937-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1097.html%3Fid%3DDTS10002937-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>