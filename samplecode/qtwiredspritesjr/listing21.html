<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>qtwiredspritesjr - /QTWiredSpritesJr.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/QuickTime/index.html">QuickTime</a> &gt; <a href="../../samplecode/QuickTime/idxWiredMoviesandSprites-date.html">Wired Movies and Sprites</a> &gt; <A HREF="javascript:location.replace('index.html');">qtwiredspritesjr</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">qtwiredspritesjr</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/QTWiredSpritesJr.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/Application Files/ComApplication.c</option>
<option value="listing2.html">/Application Files/ComApplication.h</option>
<option value="listing3.html">/Application Files/ComResource.h</option>
<option value="listing4.html">/Application Files/QTWiredSpritesJr.r</option>
<option value="listing5.html">/Common Files/ComFramework.c</option>
<option value="listing6.html">/Common Files/ComFramework.h</option>
<option value="listing7.html">/Common Files/EndianUtilities.c</option>
<option value="listing8.html">/Common Files/EndianUtilities.h</option>
<option value="listing9.html">/Common Files/ImageCompressionUtilities.c</option>
<option value="listing10.html">/Common Files/ImageCompressionUtilities.h</option>
<option value="listing11.html">/Common Files/MacFramework.c</option>
<option value="listing12.html">/Common Files/MacFramework.h</option>
<option value="listing13.html">/Common Files/MacPrefix.h</option>
<option value="listing14.html">/Common Files/QTUtilities.c</option>
<option value="listing15.html">/Common Files/QTUtilities.h</option>
<option value="listing16.html">/Common Files/SpriteUtilities.c</option>
<option value="listing17.html">/Common Files/SpriteUtilities.h</option>
<option value="listing18.html">/Common Files/WinFramework.c</option>
<option value="listing19.html">/Common Files/WinFramework.h</option>
<option value="listing20.html">/Common Files/WinPrefix.h</option>
<option value="listing21.html">/QTWiredSpritesJr.c</option>
<option value="listing22.html">/QTWiredSpritesJr.h</option>
<option value="listing23.html">/QTWiredSpritesJr.r</option>
<option value="listing24.html">/README.txt</option>
<option value="listing25.html">/WiredSpriteUtilities.c</option>
<option value="listing26.html">/WiredSpriteUtilities.h</option></select>
				</p>
				</form>
				<p><strong><a href="qtwiredspritesjr.zip">Download Sample</a></strong> (&#147;qtwiredspritesjr.zip&#148;, 872.9K)<BR>
<strong><a href="qtwiredspritesjr.dmg">Download Sample</a></strong> (&#147;qtwiredspritesjr.dmg&#148;, 1.31M)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">//////////////  File:    QTWiredSpritesJr.c////  Contains:  QuickTime wired sprites support for QuickTime movies.////  Written by:  Tim Monroe////  Copyright:  &copy; 2001 by Apple Computer, Inc., all rights reserved.////  Change History (most recent first):////     &lt;1&gt;     01/18/01  rtm    first file; based on existing QTSprites and QTWiredSprites sample code//     ////////////////////////// header files////////////#include &quot;QTWiredSpritesJr.h&quot;////////////// QTWired_CreateDraggableIconMovie// Create a QuickTime movie containing a sprite track.////////////OSErr QTWired_CreateDraggableIconMovie (void){  Movie          myMovie = NULL;  Track          myTrack = NULL;  Media          myMedia = NULL;  FSSpec          myFile;  Boolean          myIsSelected = false;  Boolean          myIsReplacing = false;    Fixed          myHeight = 0;  Fixed          myWidth = 0;  StringPtr         myPrompt = QTUtils_ConvertCToPascalString(kSpriteSavePrompt);  StringPtr         myFileName = QTUtils_ConvertCToPascalString(kSpriteSaveMovieFileName);  long          myFlags = createMovieFileDeleteCurFile | createMovieFileDontCreateResFile;  OSType          myType = FOUR_CHAR_CODE('none');  short          myResRefNum = 0;  short          myResID = movieInDataForkResID;  OSErr          myErr = noErr;  //////////  //  // create a new movie file  //  //////////  // prompt the user for the destination file name  QTFrame_PutFile(myPrompt, myFileName, &amp;myFile, &amp;myIsSelected, &amp;myIsReplacing);  myErr = myIsSelected ? noErr : userCanceledErr;  if (!myIsSelected)    goto bail;  // create a movie file for the destination movie  myErr = CreateMovieFile(&amp;myFile, FOUR_CHAR_CODE('TVOD'), smSystemScript, myFlags, &amp;myResRefNum, &amp;myMovie);  if (myErr != noErr)    goto bail;    // select the &quot;no-interface&quot; movie controller  myType = EndianU32_NtoB(myType);  SetUserDataItem(GetMovieUserData(myMovie), &amp;myType, sizeof(myType), kUserDataMovieControllerType, 1);    //////////  //  // create the sprite track and media  //  //////////    myWidth = Long2Fix(kIconSpriteTrackWidth);  myHeight = Long2Fix(kIconSpriteTrackHeight);  myTrack = NewMovieTrack(myMovie, myWidth, myHeight, kNoVolume);  myMedia = NewTrackMedia(myTrack, SpriteMediaType, kSpriteMediaTimeScale, NULL, 0);  myErr = BeginMediaEdits(myMedia);  if (myErr != noErr)    goto bail;  //////////  //  // add the appropriate samples to the sprite media  //  //////////    myErr = QTWired_AddIconMovieSamplesToMedia(myMedia);  if (myErr != noErr)    goto bail;    myErr = EndMediaEdits(myMedia);  if (myErr != noErr)    goto bail;    // add the media to the track  InsertMediaIntoTrack(myTrack, 0, 0, GetMediaDuration(myMedia), fixed1);      //////////  //  // set the sprite track properties  //  //////////    QTWired_SetTrackProperties(myMedia, 1);    //////////  //  // add the movie resource to the movie file  //  //////////    myErr = AddMovieResource(myMovie, myResRefNum, &amp;myResID, myFile.name);    bail:  if (myResRefNum != 0)    CloseMovieFile(myResRefNum);  if (myMovie != NULL)    DisposeMovie(myMovie);      free(myPrompt);  free(myFileName);  return(myErr);}////////////// QTWired_AddIconMovieSamplesToMedia// Build the key frame for the icon sprite movie.////////////OSErr QTWired_AddIconMovieSamplesToMedia (Media theMedia){  QTAtomContainer      mySample = NULL;  QTAtomContainer      mySpriteData = NULL;  RGBColor        myKeyColor;  Point          myLocation;  short          isVisible, myIndex;  FixedPoint        myPoint;  OSErr          myErr = noErr;    //////////  //  // create a key frame sample containing the sprite images  //  //////////  // create a new, empty key frame sample  myErr = QTNewAtomContainer(&amp;mySample);  if (myErr != noErr)    goto bail;  myKeyColor.red = myKeyColor.green = myKeyColor.blue = 0xffff;    // white    myPoint.x = Long2Fix(kIconDimension / 2);  myPoint.y = Long2Fix(kIconDimension / 2);  // add images to the key frame sample  SpriteUtils_AddPICTImageToKeyFrameSample(mySample, kNewQTIconID, &amp;myKeyColor, 1, &amp;myPoint, NULL);  SpriteUtils_AddPICTImageToKeyFrameSample(mySample, kNewQTIconDownID, &amp;myKeyColor, 2, &amp;myPoint, NULL);  //////////  //  // add the initial sprite properties to the key frame sample  //  //////////    myErr = QTNewAtomContainer(&amp;mySpriteData);  if (myErr != noErr)    goto bail;  // the QT icon sprite  myLocation.h   = kIconDimension + (kIconDimension / 2);  myLocation.v  = kIconDimension + (kIconDimension / 2);  isVisible    = true;  myIndex      = kNewQTIconImageIndex;    SpriteUtils_SetSpriteData(mySpriteData, &amp;myLocation, &amp;isVisible, NULL, &amp;myIndex, NULL, NULL, NULL);  SpriteUtils_AddSpriteToSample(mySample, mySpriteData, kQTIconSpriteAtomID);  QTWired_MakeSpriteDraggable(mySample, kQTIconSpriteAtomID);  QTWired_AddCursorChangeToSprite(mySample, kQTIconSpriteAtomID);  SpriteUtils_AddSpriteSampleToMedia(theMedia, mySample, kSpriteMediaFrameDurationIcon, true, NULL);  bail:    if (mySample != NULL)    QTDisposeAtomContainer(mySample);  if (mySpriteData != NULL)    QTDisposeAtomContainer(mySpriteData);    return(myErr);}////////////// QTWired_AddControllerButtonSamplesToMedia// Build the key frame for the controller sprite track.////////////void QTWired_AddControllerButtonSamplesToMedia (Media theMedia, long theTrackWidth, long theTrackHeight, TimeValue theDuration){  QTAtomContainer      mySample = NULL;  QTAtomContainer      myActions = NULL;  QTAtomContainer      myPauseButton, myPlayButton, myPrevButton, myNextButton, myStartButton, myEndButton;  RGBColor        myKeyColor;  Point          myLocation;  short          isVisible, myIndex, myLayer;  short          myCount;  long          mySixth;#if !USE_WIRED_UTILITIES  QTAtom          myEventAtom = 0;  QTAtom          myActionAtom = 0;  long          myAction;#endif  OSErr          myErr = noErr;    //////////  //  // create a key frame sample containing the sprite images  //  //////////  // create a new, empty key frame sample  myErr = QTNewAtomContainer(&amp;mySample);  if (myErr != noErr)    goto bail;  myKeyColor.red = myKeyColor.green = myKeyColor.blue = 0xffff;    // white    // add images to the key frame sample  for (myCount = 0; myCount &lt; kNumControllerImages; myCount++)    SpriteUtils_AddPICTImageToKeyFrameSample(mySample, kFirstControllerImageID + myCount, &amp;myKeyColor, myCount + 1, NULL, NULL);  // assign group IDs to the images  SpriteUtils_AssignImageGroupIDsToKeyFrame(mySample);    //////////  //  // add the initial sprite properties and actions to the key frame sample  //  //////////    mySixth = theTrackWidth / kNumControllerButtons;  // the Pause button sprite  myErr = QTNewAtomContainer(&amp;myPauseButton);  if (myErr != noErr)    goto bail;  myLocation.h   = (kPauseSpritePosition * mySixth) + ((mySixth - kButtonWidth) / 2);  myLocation.v  = theTrackHeight - (kButtonHeight + 5);  isVisible    = true;  myIndex      = kPauseUpIndex;  myLayer      = 1;    SpriteUtils_SetSpriteData(myPauseButton, &amp;myLocation, &amp;isVisible, &amp;myLayer, &amp;myIndex, NULL, NULL, NULL);  WiredUtils_AddSpriteSetImageIndexAction(myPauseButton, kParentAtomIsContainer, kQTEventMouseClick, 0, NULL, 0, 0, NULL, kPauseDownIndex, NULL);  WiredUtils_AddSpriteSetImageIndexAction(myPauseButton, kParentAtomIsContainer, kQTEventMouseClickEnd, 0, NULL, 0, 0, NULL, kPauseUpIndex, NULL);  WiredUtils_AddMovieSetRateAction(myPauseButton, kParentAtomIsContainer, kQTEventMouseClickEndTriggerButton, 0);  SpriteUtils_AddSpriteToSample(mySample, myPauseButton, kPauseSpriteAtomID);    // the Play button sprite  myErr = QTNewAtomContainer(&amp;myPlayButton);  if (myErr != noErr)    goto bail;  myLocation.h   = (kPlaySpritePosition * mySixth) + ((mySixth - kButtonWidth) / 2);  myLocation.v  = theTrackHeight - (kButtonHeight + 5);  isVisible    = true;  myIndex      = kPlayUpIndex;  myLayer      = 1;    SpriteUtils_SetSpriteData(myPlayButton, &amp;myLocation, &amp;isVisible, &amp;myLayer, &amp;myIndex, NULL, NULL, NULL);  WiredUtils_AddSpriteSetImageIndexAction(myPlayButton, kParentAtomIsContainer, kQTEventMouseClick, 0, NULL, 0, 0, NULL, kPlayDownIndex, NULL);  WiredUtils_AddSpriteSetImageIndexAction(myPlayButton, kParentAtomIsContainer, kQTEventMouseClickEnd, 0, NULL, 0, 0, NULL, kPlayUpIndex, NULL);  WiredUtils_AddMovieSetRateAction(myPlayButton, kParentAtomIsContainer, kQTEventMouseClickEndTriggerButton, fixed1);  SpriteUtils_AddSpriteToSample(mySample, myPlayButton, kPlaySpriteAtomID);    // the Go-To-Start button sprite  myErr = QTNewAtomContainer(&amp;myStartButton);  if (myErr != noErr)    goto bail;  myLocation.h   = (kToBeginSpritePosition * mySixth) + ((mySixth - kButtonWidth) / 2);  myLocation.v  = theTrackHeight - (kButtonHeight + 5);  isVisible    = true;  myIndex      = kToBeginUpIndex;  myLayer      = 1;    SpriteUtils_SetSpriteData(myStartButton, &amp;myLocation, &amp;isVisible, &amp;myLayer, &amp;myIndex, NULL, NULL, NULL);  #if USE_WIRED_UTILITIES  // add actions to the Start button, using the wired sprite utilities  WiredUtils_AddSpriteSetImageIndexAction(myStartButton, kParentAtomIsContainer, kQTEventMouseClick, 0, NULL, 0, 0, NULL, kToBeginDownIndex, NULL);  WiredUtils_AddSpriteSetImageIndexAction(myStartButton, kParentAtomIsContainer, kQTEventMouseClickEnd, 0, NULL, 0, 0, NULL, kToBeginUpIndex, NULL);  WiredUtils_AddMovieGoToBeginningAction(myStartButton, kParentAtomIsContainer, kQTEventMouseClickEndTriggerButton);#else  // add actions to the Start button, without using the wired sprite utilities;  // significantly longer, eh?  //////////  //  // add a mouse click event handler  //  //////////  // add a kQTEventMouseClick event atom to the Start button atom  myErr = QTInsertChild(myStartButton, kParentAtomIsContainer, kQTEventType, kQTEventMouseClick, 1, 0, NULL, &amp;myEventAtom);  if (myErr != noErr)    goto bail;      // add an action atom to the event handler  myErr = QTInsertChild(myStartButton, myEventAtom, kAction, 0, 0, 0, NULL, &amp;myActionAtom);  if (myErr != noErr)    goto bail;    myAction = EndianU32_NtoB(kActionSpriteSetImageIndex);  myErr = QTInsertChild(myStartButton, myActionAtom, kWhichAction, 1, 1, sizeof(myAction), &amp;myAction, NULL);  if (myErr != noErr)    goto bail;  // add a parameter to the set image index action: image index  myIndex = EndianU32_NtoB(kToBeginDownIndex);  myErr = QTInsertChild(myStartButton, myActionAtom, kActionParameter, 0, (short)kFirstParam, sizeof(myIndex), &amp;myIndex, NULL);  if (myErr != noErr)    goto bail;  //////////  //  // add a mouse click end event handler  //  //////////  // add a kQTEventMouseClickEnd event atom to the Start button atom  myErr = QTInsertChild(myStartButton, kParentAtomIsContainer, kQTEventType, kQTEventMouseClickEnd, 1, 0, NULL, &amp;myEventAtom);  if (myErr != noErr)    goto bail;      // add an action atom to the event handler  myErr = QTInsertChild(myStartButton, myEventAtom, kAction, 0, 0, 0, NULL, &amp;myActionAtom);  if (myErr != noErr)    goto bail;    myAction = EndianU32_NtoB(kActionSpriteSetImageIndex);  myErr = QTInsertChild(myStartButton, myActionAtom, kWhichAction, 1, 1, sizeof(myAction), &amp;myAction, NULL);  if (myErr != noErr)    goto bail;  // add a parameter to the set image index action: image index  myIndex = EndianU32_NtoB(kToBeginUpIndex);  myErr = QTInsertChild(myStartButton, myActionAtom, kActionParameter, 0, (short)kFirstParam, sizeof(myIndex), &amp;myIndex, NULL);  if (myErr != noErr)    goto bail;  //////////  //  // add a mouse button click event handler  //  //////////  // add a kQTEventMouseClickEndTriggerButton event atom to the Start button atom  myErr = QTInsertChild(myStartButton, kParentAtomIsContainer, kQTEventType, kQTEventMouseClickEndTriggerButton, 1, 0, NULL, &amp;myEventAtom);  if (myErr != noErr)    goto bail;      // add an action atom to the event handler  myErr = QTInsertChild(myStartButton, myEventAtom, kAction, 0, 0, 0, NULL, &amp;myActionAtom);  if (myErr != noErr)    goto bail;    myAction = EndianU32_NtoB(kActionMovieGoToBeginning);  myErr = QTInsertChild(myStartButton, myActionAtom, kWhichAction, 1, 1, sizeof(myAction), &amp;myAction, NULL);  if (myErr != noErr)    goto bail;#endif  SpriteUtils_AddSpriteToSample(mySample, myStartButton, kToBeginSpriteAtomID);    // the Go-To-End button sprite  myErr = QTNewAtomContainer(&amp;myEndButton);  if (myErr != noErr)    goto bail;  myLocation.h   = (kToEndSpritePosition * mySixth) + ((mySixth - kButtonWidth) / 2);  myLocation.v  = theTrackHeight - (kButtonHeight + 5);  isVisible    = true;  myIndex      = kToEndUpIndex;  myLayer      = 1;    SpriteUtils_SetSpriteData(myEndButton, &amp;myLocation, &amp;isVisible, &amp;myLayer, &amp;myIndex, NULL, NULL, NULL);  WiredUtils_AddSpriteSetImageIndexAction(myEndButton, kParentAtomIsContainer, kQTEventMouseClick, 0, NULL, 0, 0, NULL, kToEndDownIndex, NULL);  WiredUtils_AddSpriteSetImageIndexAction(myEndButton, kParentAtomIsContainer, kQTEventMouseClickEnd, 0, NULL, 0, 0, NULL, kToEndUpIndex, NULL);  WiredUtils_AddMovieGoToEndAction(myEndButton, kParentAtomIsContainer, kQTEventMouseClickEndTriggerButton);  SpriteUtils_AddSpriteToSample(mySample, myEndButton, kToEndSpriteAtomID);    // the Step Back button sprite  myErr = QTNewAtomContainer(&amp;myPrevButton);  if (myErr != noErr)    goto bail;  myLocation.h   = (kBackStepSpritePosition * mySixth) + ((mySixth - kButtonWidth) / 2);  myLocation.v  = theTrackHeight - (kButtonHeight + 5);  isVisible    = true;  myIndex      = kBackStepUpIndex;  myLayer      = 1;    SpriteUtils_SetSpriteData(myPrevButton, &amp;myLocation, &amp;isVisible, &amp;myLayer, &amp;myIndex, NULL, NULL, NULL);  WiredUtils_AddSpriteSetImageIndexAction(myPrevButton, kParentAtomIsContainer, kQTEventMouseClick, 0, NULL, 0, 0, NULL, kBackStepDownIndex, NULL);  WiredUtils_AddSpriteSetImageIndexAction(myPrevButton, kParentAtomIsContainer, kQTEventMouseClickEnd, 0, NULL, 0, 0, NULL, kBackStepUpIndex, NULL);  WiredUtils_AddMovieStepBackwardAction(myPrevButton, kParentAtomIsContainer, kQTEventMouseClickEndTriggerButton);  SpriteUtils_AddSpriteToSample(mySample, myPrevButton, kBackStepSpriteAtomID);    // the Step Forward button sprite  myErr = QTNewAtomContainer(&amp;myNextButton);  if (myErr != noErr)    goto bail;  myLocation.h   = (kAheadStepSpritePosition * mySixth) + ((mySixth - kButtonWidth) / 2);  myLocation.v  = theTrackHeight - (kButtonHeight + 5);  isVisible    = true;  myIndex      = kAheadStepUpIndex;  myLayer      = 1;    SpriteUtils_SetSpriteData(myNextButton, &amp;myLocation, &amp;isVisible, &amp;myLayer, &amp;myIndex, NULL, NULL, NULL);  WiredUtils_AddSpriteSetImageIndexAction(myNextButton, kParentAtomIsContainer, kQTEventMouseClick, 0, NULL, 0, 0, NULL, kAheadStepDownIndex, NULL);  WiredUtils_AddSpriteSetImageIndexAction(myNextButton, kParentAtomIsContainer, kQTEventMouseClickEnd, 0, NULL, 0, 0, NULL, kAheadStepUpIndex, NULL);  WiredUtils_AddMovieStepForwardAction(myNextButton, kParentAtomIsContainer, kQTEventMouseClickEndTriggerButton);  SpriteUtils_AddSpriteToSample(mySample, myNextButton, kAheadStepSpriteAtomID);    SpriteUtils_AddSpriteSampleToMedia(theMedia, mySample, theDuration, true, NULL);  bail:    if (mySample != NULL)    QTDisposeAtomContainer(mySample);  if (myPauseButton != NULL)    QTDisposeAtomContainer(myPauseButton);    if (myPlayButton != NULL)    QTDisposeAtomContainer(myPlayButton);    if (myPrevButton != NULL)    QTDisposeAtomContainer(myPrevButton);    if (myNextButton != NULL)    QTDisposeAtomContainer(myNextButton);    if (myStartButton != NULL)    QTDisposeAtomContainer(myStartButton);    if (myEndButton != NULL)    QTDisposeAtomContainer(myEndButton);  }////////////// QTWired_SetTrackProperties// Set the track properties for the specified sample sprite movie.////////////void QTWired_SetTrackProperties (Media theMedia, UInt32 theIdleFrequency){  QTAtomContainer    myTrackProperties;  RGBColor      myBackgroundColor;  Boolean        hasActions;  UInt32        myFrequency;  OSErr        myErr = noErr;      // add a background color to the sprite track  myBackgroundColor.red = EndianU16_NtoB(0xffff);  myBackgroundColor.green = EndianU16_NtoB(0xffff);  myBackgroundColor.blue = EndianU16_NtoB(0xffff);    myErr = QTNewAtomContainer(&amp;myTrackProperties);  if (myErr == noErr) {    QTInsertChild(myTrackProperties, 0, kSpriteTrackPropertyBackgroundColor, 1, 1, sizeof(myBackgroundColor), &amp;myBackgroundColor, NULL);    // tell the movie controller that this sprite track has actions    hasActions = true;    QTInsertChild(myTrackProperties, 0, kSpriteTrackPropertyHasActions, 1, 1, sizeof(hasActions), &amp;hasActions, NULL);      // tell the sprite track to generate QTIdleEvents    myFrequency = EndianU32_NtoB(theIdleFrequency);    QTInsertChild(myTrackProperties, 0, kSpriteTrackPropertyQTIdleEventsFrequency, 1, 1, sizeof(myFrequency), &amp;myFrequency, NULL);    SetMediaPropertyAtom(theMedia, myTrackProperties);        QTDisposeAtomContainer(myTrackProperties);  }}  ////////////// QTWired_AddSpriteControllerTrack// Add a track to the specified movie that contains wired sprites for controlling the movie.//// We add six sprites to the track, which will function like buttons. On mouse down, the image// of the sprite is changed to the &quot;clicked&quot; image; on mouse up, the image is returned to the// normal &quot;unclicked&quot; image; on mouse button events (that is, kQTEventMouseClickEndTriggerButton),// we execute an action (for instance kActionMovieGoToBeginning). No other logic and no sprite track// variables are required here.////////////OSErr QTWired_AddSpriteControllerTrack (Movie theMovie){  Track          myTrack = NULL;  Media          myMedia = NULL;  MatrixRecord      myMatrix;  RGBColor        myKeyColor;  Fixed          myWidth, myHeight;  Rect          myRect;  TimeValue        myDuration = 0L;  TimeValue        myTimeScale = 0L;  OSType          myType = FOUR_CHAR_CODE('none');  MatrixRecord      myInverseMatrix;  OSErr          myErr = noErr;  //////////  //  // get some information about the target movie  //  //////////  if (theMovie == NULL) {    myErr = paramErr;    goto bail;  }  GetMovieBox(theMovie, &amp;myRect);  myWidth = Long2Fix(myRect.right - myRect.left);  myHeight = Long2Fix(myRect.bottom - myRect.top);  myDuration = GetMovieDuration(theMovie);  myTimeScale = GetMovieTimeScale(theMovie);    //////////  //  // create a new sprite track in the target movie  //  //////////    myTrack = NewMovieTrack(theMovie, myWidth, myHeight, kNoVolume);  myMedia = NewTrackMedia(myTrack, SpriteMediaType, myTimeScale, NULL, 0);  // set the track matrix to compensate for any existing movie matrix  GetMovieMatrix(theMovie, &amp;myMatrix);  if (InverseMatrix(&amp;myMatrix, &amp;myInverseMatrix))    SetTrackMatrix(myTrack, &amp;myInverseMatrix);  myErr = BeginMediaEdits(myMedia);  if (myErr != noErr)    goto bail;    //////////  //  // add sprite images and sprites to the sprite track; add actions to the sprites  //  //////////    QTWired_AddControllerButtonSamplesToMedia(myMedia, myRect.right - myRect.left, myRect.bottom - myRect.top, myDuration);    //////////  //  // insert media into track  //  //////////    myErr = EndMediaEdits(myMedia);  if (myErr != noErr)    goto bail;    // add the media to the track  InsertMediaIntoTrack(myTrack, 0, 0, GetMediaDuration(myMedia), fixed1);      //////////  //  // set the sprite track properties  //  //////////    QTWired_SetTrackProperties(myMedia, kNoQTIdleEvents);    myKeyColor.red = myKeyColor.green = myKeyColor.blue = 0xffff;    // white  MediaSetGraphicsMode(GetMediaHandler(myMedia), transparent, &amp;myKeyColor);    // make sure that the sprite track is in the frontmost layer  SetTrackLayer(myTrack, kMaxLayerNumber);  SetTrackLayer(myTrack, QTWired_GetLowestLayerInMovie(theMovie) - 1);    // select the &quot;no-interface&quot; movie controller  myType = EndianU32_NtoB(myType);  SetUserDataItem(GetMovieUserData(theMovie), &amp;myType, sizeof(myType), kUserDataMovieControllerType, 1);  bail:  return(myErr);}////////////// QTWired_MakeSpriteDraggable// Add atoms to the specified sprite to make it draggable.//// To make a sprite draggable, we need to install handlers for three kinds of events: mouse click, mouse click end,// and idle. On mouse click (within the sprite), we set a track variable to 1; on mouse click end, we set that variable// to 0. Thus, the value of that variable can be used to tell us if the mouse is down within the sprite. On idle, we// look to see if the value of the variable is 1; if it is, we set the position of the sprite to the current mouse position.////////////OSErr QTWired_MakeSpriteDraggable (QTAtomContainer theContainer, QTAtomID theID){  QTAtom                mySpriteAtom = 0;  QTAtom                myEventAtom = 0;  QTAtom                myActionAtom = 0;  QTAtom                myParamAtom = 0;  QTAtom                myConditionalAtom, myExpressionAtom, myOperatorAtom, myActionListAtom, myParameterAtom;  short                myOperandIndex;  QTAtomID              myVariableID;  float                myConstantValue;  Boolean                myIsAbsolute;#if !USE_WIRED_UTILITIES  QTAtom                myOperandAtom, myOperandTypeAtom;  long                myAction;  float                myVariableValue;#endif  OSErr                myErr = noErr;    // find the sprite atom with the specified ID in the specified container  mySpriteAtom = QTFindChildByID(theContainer, kParentAtomIsContainer, kSpriteAtomType, theID, NULL);  if (mySpriteAtom == 0) {    myErr = paramErr;    goto bail;  }    //////////  //  // add a mouse click event handler  //  //////////  #if USE_WIRED_UTILITIES  myErr = WiredUtils_AddSpriteTrackSetVariableAction(theContainer, mySpriteAtom, kQTEventMouseClick, kMouseStateVariableID, 1, 0, NULL, 0);  if (myErr != noErr)    goto bail;#else  // find the event atom of type kQTEventMouseClick in the sprite atom  myEventAtom = QTFindChildByID(theContainer, mySpriteAtom, kQTEventType, kQTEventMouseClick, NULL);  if (myEventAtom == 0) {    // if there is none, insert a new event atom of type kQTEventMouseClick into the sprite atom    myErr = QTInsertChild(theContainer, mySpriteAtom, kQTEventType, kQTEventMouseClick, 1, 0, NULL, &amp;myEventAtom);    if (myErr != noErr)      goto bail;  }    // add an action atom to the mouse click event handler  myErr = QTInsertChild(theContainer, myEventAtom, kAction, 0, 0, 0, NULL, &amp;myActionAtom);  if (myErr != noErr)    goto bail;    myAction = EndianU32_NtoB(kActionSpriteTrackSetVariable);  myErr = QTInsertChild(theContainer, myActionAtom, kWhichAction, 1, 1, sizeof(myAction), &amp;myAction, NULL);  if (myErr != noErr)    goto bail;        // add parameters to the set variable action: variable ID (QTAtomID) and value (float)  myVariableID = EndianU32_NtoB(kMouseStateVariableID);  myErr = QTInsertChild(theContainer, myActionAtom, kActionParameter, 0, (short)kFirstParam, sizeof(myVariableID), &amp;myVariableID, NULL);  if (myErr != noErr)    goto bail;    myVariableValue = (float)1;  EndianUtils_Float_NtoB(&amp;myVariableValue);  myErr = QTInsertChild(theContainer, myActionAtom, kActionParameter, 0, (short)kSecondParam, sizeof(myVariableValue), &amp;myVariableValue, NULL);  if (myErr != noErr)    goto bail;#endif    //////////  //  // add a mouse click end event handler  //  //////////  #if USE_WIRED_UTILITIES  myErr = WiredUtils_AddSpriteTrackSetVariableAction(theContainer, mySpriteAtom, kQTEventMouseClickEnd, kMouseStateVariableID, 0, 0, NULL, 0);  if (myErr != noErr)    goto bail;#else  // find the event atom of type kQTEventMouseClick in the sprite atom  myEventAtom = QTFindChildByID(theContainer, mySpriteAtom, kQTEventType, kQTEventMouseClickEnd, NULL);  if (myEventAtom == 0) {    // if there is none, insert a new event atom of type kQTEventMouseClick into the sprite atom    myErr = QTInsertChild(theContainer, mySpriteAtom, kQTEventType, kQTEventMouseClickEnd, 1, 0, NULL, &amp;myEventAtom);    if (myErr != noErr)      goto bail;  }    // add an action atom to the mouse click event handler  myErr = QTInsertChild(theContainer, myEventAtom, kAction, 0, 0, 0, NULL, &amp;myActionAtom);  if (myErr != noErr)    goto bail;    myAction = EndianU32_NtoB(kActionSpriteTrackSetVariable);  myErr = QTInsertChild(theContainer, myActionAtom, kWhichAction, 1, 1, sizeof(myAction), &amp;myAction, NULL);  if (myErr != noErr)    goto bail;    // add parameters to the set variable action: variable ID (QTAtomID) and value (float)  myVariableID = EndianU32_NtoB(kMouseStateVariableID);  myErr = QTInsertChild(theContainer, myActionAtom, kActionParameter, 0, (short)kFirstParam, sizeof(myVariableID), &amp;myVariableID, NULL);  if (myErr != noErr)    goto bail;    myVariableValue = (float)0;  EndianUtils_Float_NtoB(&amp;myVariableValue);  myErr = QTInsertChild(theContainer, myActionAtom, kActionParameter, 0, (short)kSecondParam, sizeof(myVariableValue), &amp;myVariableValue, NULL);  if (myErr != noErr)    goto bail;#endif    //////////  //  // add an idle event handler  //  //////////  #if USE_WIRED_UTILITIES  myErr = WiredUtils_AddQTEventAndActionAtoms(theContainer, mySpriteAtom, kQTEventIdle, kActionCase, &amp;myActionAtom);  if (myErr != noErr)    goto bail;  // add a parameter atom to the kActionCase action atom; this will serve as a parent to hold the expression and action atoms  myErr = WiredUtils_AddActionParameterAtom(theContainer, myActionAtom, kFirstParam, 0, NULL, &amp;myParamAtom);  if (myErr != noErr)    goto bail;    myErr = WiredUtils_AddConditionalAtom(theContainer, myParamAtom, 1, &amp;myConditionalAtom);  if (myErr != noErr)    goto bail;      myErr = WiredUtils_AddExpressionContainerAtomType(theContainer, myConditionalAtom, &amp;myExpressionAtom);  if (myErr != noErr)    goto bail;      myErr = WiredUtils_AddOperatorAtom(theContainer, myExpressionAtom, kOperatorEqualTo, &amp;myOperatorAtom);  if (myErr != noErr)    goto bail;  myOperandIndex = 1;    myConstantValue = 1;  myErr = WiredUtils_AddOperandAtom(theContainer, myOperatorAtom, kOperandConstant, myOperandIndex, NULL, myConstantValue);  if (myErr != noErr)    goto bail;  myOperandIndex = 2;  myVariableID = kMouseStateVariableID;  myErr = WiredUtils_AddVariableOperandAtom(theContainer, myOperatorAtom, myOperandIndex, 0, NULL, 0, myVariableID);  if (myErr != noErr)    goto bail;      myErr = WiredUtils_AddActionListAtom(theContainer, myConditionalAtom, &amp;myActionListAtom);  if (myErr != noErr)    goto bail;  myErr = WiredUtils_AddActionAtom(theContainer, myActionListAtom, kActionSpriteTranslate, &amp;myActionAtom);  if (myErr != noErr)    goto bail;      // add parameters to the translate action: Fixed x, Fixed y, Boolean isAbsolute  // first parameter: get current mouse position x  myErr = WiredUtils_AddActionParameterAtom(theContainer, myActionAtom, kFirstParam, 0, NULL, &amp;myParameterAtom);  if (myErr != noErr)    goto bail;  myErr = WiredUtils_AddExpressionContainerAtomType(theContainer, myParameterAtom, &amp;myExpressionAtom);  if (myErr != noErr)    goto bail;  myErr = WiredUtils_AddOperandAtom(theContainer, myExpressionAtom, kOperandMouseLocalHLoc, 1, NULL, 0);  if (myErr != noErr)    goto bail;      // second parameter: get current mouse position y  myErr = WiredUtils_AddActionParameterAtom(theContainer, myActionAtom, kSecondParam, 0, NULL, &amp;myParameterAtom);  if (myErr != noErr)    goto bail;  myErr = WiredUtils_AddExpressionContainerAtomType(theContainer, myParameterAtom, &amp;myExpressionAtom);  if (myErr != noErr)    goto bail;  myErr = WiredUtils_AddOperandAtom(theContainer, myExpressionAtom, kOperandMouseLocalVLoc, 1, NULL, 0);  if (myErr != noErr)    goto bail;    // third parameter: true  myIsAbsolute = true;  myErr = WiredUtils_AddActionParameterAtom(theContainer, myActionAtom, kThirdParam, sizeof(myIsAbsolute), &amp;myIsAbsolute, NULL);    #else  // find the event atom of type kQTEventIdle in the sprite atom  myEventAtom = QTFindChildByID(theContainer, mySpriteAtom, kQTEventType, kQTEventIdle, NULL);  if (myEventAtom == 0) {    // if there is none, insert a new event atom of type kQTEventIdle into the sprite atom    myErr = QTInsertChild(theContainer, mySpriteAtom, kQTEventType, kQTEventIdle, 1, 0, NULL, &amp;myEventAtom);    if (myErr != noErr)      goto bail;  }    // add an action atom to the mouse click event handler  myErr = QTInsertChild(theContainer, myEventAtom, kAction, 0, 0, 0, NULL, &amp;myActionAtom);  if (myErr != noErr)    goto bail;    myAction = EndianU32_NtoB(kActionCase);  myErr = QTInsertChild(theContainer, myActionAtom, kWhichAction, 1, 1, sizeof(myAction), &amp;myAction, NULL);  if (myErr != noErr)    goto bail;  // add a parameter atom to the kActionCase action atom; this will serve as a parent to hold conditional atom  myErr = QTInsertChild(theContainer, myActionAtom, kActionParameter, 1, kFirstParam, 0, NULL, &amp;myParamAtom);  if (myErr != noErr)    goto bail;    // the condition atom is the parent of the expression and action list atoms  myErr = QTInsertChild(theContainer, myParamAtom, kConditionalAtomType, 0, 1, 0, NULL, &amp;myConditionalAtom);  if (myErr != noErr)    goto bail;  myErr = QTInsertChild(theContainer, myConditionalAtom, kExpressionContainerAtomType, 1, 1, 0, NULL, &amp;myExpressionAtom);  if (myErr != noErr)    goto bail;  myErr = QTInsertChild(theContainer, myExpressionAtom, kOperatorAtomType, kOperatorEqualTo, 1, 0, NULL, &amp;myOperatorAtom);  if (myErr != noErr)    goto bail;      // add the operands to the operator atom  myOperandIndex = 1;    myConstantValue = 1;  myErr = QTInsertChild(theContainer, myOperatorAtom, kOperandAtomType, 0, myOperandIndex, 0, NULL, &amp;myOperandAtom);  if (myErr != noErr)    goto bail;    myErr = QTInsertChild(theContainer, myOperandAtom, kOperandConstant, 1, 1, 0, NULL, &amp;myOperandTypeAtom);  if (myErr != noErr)    goto bail;  EndianUtils_Float_NtoB(&amp;myConstantValue);  myErr = QTSetAtomData(theContainer, myOperandTypeAtom, sizeof(myConstantValue), &amp;myConstantValue);    myOperandIndex = 2;  myVariableID = kMouseStateVariableID;  myErr = QTInsertChild(theContainer, myOperatorAtom, kOperandAtomType, 0, myOperandIndex, 0, NULL, &amp;myOperandAtom);  if (myErr != noErr)    goto bail;    myErr = QTInsertChild(theContainer, myOperandAtom, kOperandSpriteTrackVariable, 1, 1, 0, NULL, &amp;myOperandTypeAtom);  if (myErr != noErr)    goto bail;    myVariableID = EndianU32_NtoB(myVariableID);  myErr = QTInsertChild(theContainer, myOperandTypeAtom, kActionParameter, 1, 1, sizeof(myVariableID), &amp;myVariableID, NULL);  if (myErr != noErr)    goto bail;  // add an action list atom  myErr = QTInsertChild(theContainer, myConditionalAtom, kActionListAtomType, 1, 1, 0, NULL, &amp;myActionListAtom);  if (myErr != noErr)    goto bail;  // add sprite translate action  myErr = QTInsertChild(theContainer, myActionListAtom, kAction, 0, 0, 0, NULL, &amp;myActionAtom);  if (myErr != noErr)    goto bail;    myAction = EndianU32_NtoB(kActionSpriteTranslate);  myErr = QTInsertChild(theContainer, myActionAtom, kWhichAction, 1, 1, sizeof(myAction), &amp;myAction, NULL);  if (myErr != noErr)    goto bail;  // add parameters to the translate action: Fixed x, Fixed y, Boolean isAbsolute    // first parameter: get current mouse position x  myErr = QTInsertChild(theContainer, myActionAtom, kActionParameter, 0, (short)kFirstParam, 0, NULL, &amp;myParameterAtom);  if (myErr != noErr)    goto bail;      myErr = QTInsertChild(theContainer, myParameterAtom, kExpressionContainerAtomType, 1, 1, 0, NULL, &amp;myExpressionAtom);  if (myErr != noErr)    goto bail;  myErr = QTInsertChild(theContainer, myExpressionAtom, kOperandAtomType, 0, 1, 0, NULL, &amp;myOperandAtom);  if (myErr != noErr)    goto bail;      myErr = QTInsertChild(theContainer, myOperandAtom, kOperandMouseLocalHLoc, 1, 1, 0, NULL, NULL);  if (myErr != noErr)    goto bail;  // second parameter: get current mouse position y  myErr = QTInsertChild(theContainer, myActionAtom, kActionParameter, 0, (short)kSecondParam, 0, NULL, &amp;myParameterAtom);  if (myErr != noErr)    goto bail;      myErr = QTInsertChild(theContainer, myParameterAtom, kExpressionContainerAtomType, 1, 1, 0, NULL, &amp;myExpressionAtom);  if (myErr != noErr)    goto bail;  myErr = QTInsertChild(theContainer, myExpressionAtom, kOperandAtomType, 0, 1, 0, NULL, &amp;myOperandAtom);  if (myErr != noErr)    goto bail;      myErr = QTInsertChild(theContainer, myOperandAtom, kOperandMouseLocalVLoc, 1, 1, 0, NULL, NULL);  if (myErr != noErr)    goto bail;  // third parameter: true  myIsAbsolute = true;  myErr = QTInsertChild(theContainer, myActionAtom, kActionParameter, 0, (short)kThirdParam, sizeof(myIsAbsolute), &amp;myIsAbsolute, NULL);#endif  bail:  return(myErr);}////////////// QTWired_AddCursorChangeToSprite// Add cursor-change-on-mouse-over and -down actions to the sprite having the specified ID// in the specified atom container.//// Here we use the new &quot;sprite behaviors atom&quot; introduced in QuickTime 4.0, which// simplifies adding button-like capabilities to sprites.////////////OSErr QTWired_AddCursorChangeToSprite (QTAtomContainer theContainer, QTAtomID theID){  QTAtom                mySpriteAtom = 0;  QTAtom                myBehaviorAtom = 0;  QTSpriteButtonBehaviorStruct    myBehaviorRec;  OSErr                myErr = paramErr;    // find the sprite atom with the specified ID in the specified container  mySpriteAtom = QTFindChildByID(theContainer, kParentAtomIsContainer, kSpriteAtomType, theID, NULL);  if (mySpriteAtom == 0)    goto bail;    // insert a new sprite behaviors atom into the sprite atom  myErr = QTInsertChild(theContainer, mySpriteAtom, kSpriteBehaviorsAtomType, 1, 1, 0, NULL, &amp;myBehaviorAtom);  if (myErr != noErr)    goto bail;    // set the sprite cursor behavior; -1 means: no change associated with this state transition  myBehaviorRec.notOverNotPressedStateID = EndianS32_NtoB(-1);  myBehaviorRec.overNotPressedStateID = EndianS32_NtoB(kQTCursorOpenHand);  myBehaviorRec.overPressedStateID = EndianS32_NtoB(kQTCursorClosedHand);  myBehaviorRec.notOverPressedStateID = EndianS32_NtoB(-1);  myErr = QTInsertChild(theContainer, myBehaviorAtom, kSpriteCursorBehaviorAtomType, 1, 1, sizeof(QTSpriteButtonBehaviorStruct), &amp;myBehaviorRec, NULL);bail:  return(myErr);}////////////// QTWired_GetLowestLayerInMovie// Return the layer of the frontmost layer in the specified movie.////////////short QTWired_GetLowestLayerInMovie (Movie theMovie){  long    myCount = 0;  long    myIndex;  short    myLayer = 0;  short    myMinLayer = kMaxLayerNumber;    myCount = GetMovieTrackCount(theMovie);    for (myIndex = 1; myIndex &lt;= myCount; myIndex++) {    myLayer = GetTrackLayer(GetMovieIndTrack(theMovie, myIndex));    if (myLayer &lt; myMinLayer)      myMinLayer = myLayer;  }    return(myMinLayer);}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/qtwiredspritesjr/listing21.html%3Fid%3DDTS10001078-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/qtwiredspritesjr/listing21.html%3Fid%3DDTS10001078-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/qtwiredspritesjr/listing21.html%3Fid%3DDTS10001078-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>