<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TE23: International Canceling</title>                                       <meta name="categories" content="Text"><meta name="week-posted" content="Jan 29, 1990 - Feb 2, 1990"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002831" title="International Canceling"></a><a name="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxTextFonts-date.html">Text & Fonts</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/TextFonts/index.html" target="_blank">Reference Library > Text & Fonts</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TE23</div>
<div id="pageheadsub">International Canceling</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Section1">Where Did That Key Go?</A><BR><BR><A HREF="#Section2">A Bit Confusing (to me at least)</A><BR><BR><A HREF="#References">References</A><BR><BR><A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">This Technical Note describes potential problems canceling operations with theCommand-period key sequence and international keyboards.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Feb 01 1990]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content --><a name=Section1></A><h2>Where Did That Key Go?</h2><p>Canceling an operation, from printing to compiling, has always been done withthe key sequence Command-Period.  The problem with this is that on someinternational systems, one needs to hold the Shift key down to produce aperiod.  Many keyboard mappings, including that of the U.S., ignore the Shiftkey when the Command key is down.  In other words, on a system where aperiod&nbsp;(.) is a shifted character (e.g., Italian) pressingCommand-Shift-KeyThatMakesAPeriod does not generate the ASCII code for aperiod.  Instead, the keyboard mapping software generates the ASCII code forthe unshifted character.  If an application is looking for Command-period tocancel some time intensive operation, and an international user types theshifted key sequence that normally produces a period along with the Commandkey, the application is going to miss that request unless it takes specialprecautions.</p><P><A HREF="#top">Back to top</A></p><a name="Section2"></a><h2>A Bit Confusing (to me at least)</h2><p>The solution to this potential international disaster is to strip the Commandkey out of the modifiers, and then run the key code back through the keyboardmapping software.  The trap <code>_KeyTrans</code> makes this procedure very easy.<code>_KeyTrans</code> takes as parameters a pointer to a <code>'KCHR'</code> resource(see M.TB.KeyMapping), a word which contains the keycode and the modifier bits,and a word which serves as a state variable.</p><p>One note on the result returned by <code>_KeyTrans</code>.  <i>InsideMacintosh</i>, Volume V-195, The Toolbox Event Manager, states, "ASCII 1 is theASCII value of the first character generated by the key code parameter."  Thisstatement is followed by an illustration (Figure 7 on page V-195) which showsASCII 1 as the low byte of the high word in the long word result.  Althoughthis statement and the accompanying illustration are correct, they have misleada number of people (me for one).</p><p>It is dangerous to expect the character code in one particular word of the longword result.  In fact, the architecture of the <code>_KeyTrans</code> trap does notspecify which word contains the character code in which you might beinterested.  This is because the <code>_KeyTrans</code> trap's primary purpose isto create a package that can be used to build a key-down event, and the ToolboxEvent Manager just doesn't care about particular keys.  In fact, it is possibleto get a result from <code>_KeyTrans</code> that contains character codes in bothwords.  This is how dead keys are handled.</p><p>But how does one handle a particular character, specifically a period?  Thestrategy adopted in the sample function in this Note is to check both words ofthe result.  If a period exists in either word and the Command key is down, itis counted as a Command-period key sequence.</p><p>Now that everything is straight about parameters and results, it's time to lookat some sample code.  The code fragment which follows ensures that you get thatperiod regardless of the state of the modifier keys.</p><h3>MPW Pascal</h3><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>CONST  kMaskModifier = $FE00; {need to strip command key from Modifiers}  kMaskVirtualKey = $0000FF00; {get virtual key from event message}  kMaskASCII1 = $00FF0000;  kMaskASCII2= $000000FF; {get key from KeyTrans return}  kKeyUpMask  = $0080;  kPeriod = ORD('.');TYPE  EventPtr = ^EventRecord;FUNCTION CmdPeriod(theEvent: EventPtr): Boolean;VAR  keyCode     : Integer;  virtualKey,  keyInfo,  lowChar,  highChar,  state,  keyCId      : Longint;  hKCHR       : Handle;BEGIN  CmdPeriod  := FALSE;  IF ( theEvent^.what = keyDown ) | ( theEvent^.what = autoKey ) THEN BEGIN    {see if the command key is down.  If it is, get the ASCII }    IF  BAND(theEvent^.modifiers,cmdKey) &lt;&gt; 0  THEN BEGIN      virtualKey := BAND(theEvent^.message,kMaskVirtualKey) DIV 256;    {strip the virtual key by ANDing the modifiers with our mask}      keyCode := BAND(theEvent^.modifiers,kMaskModifier);      keyCode := BOR(keyCode,kKeyUpMask);  {let KeyTrans think it was a keyup event,      this will keep special dead key processing from occurring }    {Finally OR in the virtualKey}      keyCode := BOR(keyCode,virtualKey);      state := 0;      keyCId := GetScript( GetEnvirons(smKeyScript), smScriptKeys);      {read the appropriate KCHR resource }      hKCHR := GetResource('KCHR',keyCId);      IF hKCHR &lt;&gt; NIL THEN BEGIN        { we don't need to lock the resource since KeyTrans will not move memory }        keyInfo := KeyTrans(hKCHR^,keyCode,state);        ReleaseResource(hKCHR);      END      ELSE        {if we can't get the KCHR for some reason we set keyInfo to the message         field. This ensures that we still get the Cancel operation on systems where      '.' isn't shifted.}        keyInfo := theEvent^.message;      LowChar := BAND(keyInfo,kMaskASCII2);      HighChar := BSR(BAND(keyInfo,kMaskASCII1),16);      IF ( LowChar = kPeriod ) | (HighChar = kPeriod) THEN           CmdPeriod := TRUE;    END;  END;</pre>	</TD></TR></TABLE></CENTER><h3>MPW C</h3><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>#define kMaskModifiers  0xFE00    // we need the modifiers without the command key                    // for KeyTrans#define kMaskVirtualKey 0x0000FF00    // get virtual key from event message for                    // KeyTrans#define kUpKeyMask      0x0080#define kShiftWord      8        // we shift the virtual key to mask it into the                    // keyCode for KeyTrans#define kMaskASCII1     0x00FF0000    // get the key out of the ASCII1 byte#define kMaskASCII2     0x000000FF    // get the key out of the ASCII2 byte#define kPeriod         0x2E     // ascii for a periodBoolean CmdPeriod( EventRecord *theEvent ){  Boolean  fTimeToQuit;  short    keyCode;  long     virtualKey, keyInfo, lowChar, highChar, state, keyCId;  Handle   hKCHR;  fTimeToQuit = false;  if (((*theEvent).what == keyDown) || ((*theEvent).what == autoKey)) {  // see if the command key is down.  If it is, find out the ASCII  // equivalent for the accompanying key.  if ((*theEvent).modifiers &amp; cmdKey ) {    virtualKey = ((*theEvent).message &amp; kMaskVirtualKey) &gt;&gt; kShiftWord;    // And out the command key and Or in the virtualKey    keyCode    = ((*theEvent).modifiers &amp; kMaskModifiers)  |  virtualKey;    state      = 0;    keyCId     = GetScript( GetEnvirons(smKeyScript), smScriptKeys );    hKCHR      = GetResource( 'KCHR', keyCId );    if (hKCHR != nil) {      /* Don't bother locking since KeyTrans will never move memory */      keyInfo = KeyTrans(*hKCHR, keyCode, &amp;state);      ReleaseResource( hKCHR );    }    else     keyInfo = (*theEvent).message;    lowChar =  keyInfo &amp;  kMaskASCII2;    highChar = (keyInfo &amp; kMaskASCII1) &gt;&gt; 16;    if (lowChar == kPeriod || highChar == kPeriod)      fTimeToQuit = true;  }  // end the command key is down}  // end key down eventreturn( fTimeToQuit );</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></p><h2>What About That Resource</h2><p>The astute observer may have noticed that the code example requires that youread a resource.  Although this certainly isn't that big of a deal, it isalways nice when you can cut down on disk accesses.  In System 7.0 a verb isadded that can be used to get <code>_GetEnvirons</code> to return a pointer to thecurrent <code>'KCHR'</code>.  The verb is defined and used as follows:</p><h3>Pascal</h3><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>CONST    smKCHRCache =  38;</pre>	</TD></TR></TABLE></CENTER><h3>C</h3><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>#define smKCHRCache 38</pre>	</TD></TR></TABLE></CENTER><p>Unfortunately, in system software prior to 7.0, you must use<code>_GetResource</code> as demonstrated above to obtain the current<code>'KCHR'</code> resource.  However, since <code>_GetEnvirons</code> always returnszero when passed a verb it does not recognize, you can build System 7.0compatibility into your application without having to check which systemsoftware is running.  To do this, you could modify the routines as follows:</p><h3>Pascal</h3><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>CONST {define our own constant until System 7.0 headers ship.  At that point, if you       have not shipped, you can put in the real constant}    NewVerb_smKeyCache = 38;VAR    KCHRPtr : Ptr;    KCHRPtr := Ptr(GetEnvirons(NewVerb_smKeyCache ));    hKCHR   := NIL;  {set to NIL before starting}    IF KCHRPtr = NIL THEN BEGIN  {we didn't get the ptr from GetEnvirons}      keyCId := GetScript(GetEnvirons(smKeyScript), smScriptKeys);      {read the appropriate KCHR resource }      hKCHR := GetResource('KCHR',keyCId);      KCHRPtr := hKCHR^;    END;    IF KCHRPtr &lt;&gt; NIL THEN BEGIN      { we don't need to lock the resource since KeyTrans will not move memory }      keyInfo := KeyTrans(KCHRPtr,keyCode,state);      IF hKCHR &lt;&gt; NIL THEN        ReleaseResource(hKCHR);</pre>	</TD></TR></TABLE></CENTER><h3>C</h3><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>/* again we define our own constant for now */#define NewVerb_smKeyCache 38Ptr KCHRPtr;    hKCHR = nil;  /* set this to nil before starting */    KCHRPtr = (Ptr)GetEnvirons(NewVerb_smKeyCache );    IF ( !KCHRPtr ) {      keyCId = GetScript( GetEnvirons(smKeyScript), smScriptKeys);      hKCHR   = GetResource('KCHR',keyCId);      KCHRPtr = *hKCHR;    };    IF (KCHRPtr) {      keyInfo := KeyTrans(KCHRPtr ,keyCode,state);      if (hKCHR)        ReleaseResource(hKCHR);</pre>	</TD></TR></TABLE></CENTER><BR><P><A HREF="#top">Back to top</A></p><a name = "References"></a><h2>References</h2><P><i>Inside Macintosh</i>, Volume V, The Script Manager</p><P><i>Inside Macintosh</i>, Volume V, The Toolbox Event Manager</p><P><A HREF = "../tb/tb_12.html">M.TB.KeyMapping</a></p>         <a name="Downloads"></a>       <P><A HREF="#top">Back to top</A></p><h2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (48K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/te_23.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/te/te_23.html%3Fid%3DDTS10002831-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/te/te_23.html%3Fid%3DDTS10002831-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/te/te_23.html%3Fid%3DDTS10002831-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>