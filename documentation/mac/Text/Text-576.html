<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Key-Map Resource (Type 'KMAP')(IM: Tx)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING576></A>



<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Text-575.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Text-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Text-594.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Text-577.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Text-2.html"><B>Text</B></A> / <BR><DD><A HREF="Text-570.html"><B>Appendix C - Keyboard Resources</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING576-0></A>
<H1><A NAME=MARKER-9-44></A>Key-Map Resource (Type 'KMAP')</H1>
 <A NAME=MARKER-2-45></A>The key-map resource (resource type <CODE>'KMAP'</CODE>) is used for converting the raw key codes produced by a keyboard's microprocessor into hardware-independent virtual key codes. There is one key-map resource per physical keyboard on a Macintosh; it belongs to the Operating System, not to any script system.<P>
 The key-map resource ID number equals the ID number of the type of keyboard it is associated with. See <A HREF=Text-571.html#MARKER-9-1>Table C-1 on page C-4</A>. If a matching key-map resource cannot be found for the keyboard in use, the Operating System substitutes the <CODE>'KMAP'</CODE> resource whose ID is 0; on all Macintosh systems later than the Macintosh Plus, the key-map resource with ID = 0 is in ROM.<P>
<DL>
<DT><B>Note</B>
<DD>Most current keyboards use the key-map resource with ID = 0. However, keyboard types 2 and 5, for example, require their own key-map resources.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
 The key-map resource contains a 128-byte table that provides a one-to-one mapping of raw key codes to virtual key codes--the first byte contains the virtual key code for a raw key code of $00, the second for $01, and so forth. The table is followed by an array of exceptions. The high bit of the byte containing the virtual key code signals an exception entry in the exception array. (Virtual key codes themselves are only 7 bits long.)<P>
 <A NAME=MARKER-2-140></A>The exception array lets the device driver initiate communication with the device, usually to perform a state change--for example, to send codes to the keyboard that instruct it to turn on lights when a given key such as Caps Lock is down. The exception array begins with a 2-byte record count followed by that many records. The format of the key-map resource and its exception array is shown in <A HREF=#MARKER-9-47>Figure C-4</A>.<P>
<B>Figure C-4  <A NAME=MARKER-9-47></A>Format of the key-map resource</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/KR_L-02.jpg">
 The elements in the resource have these meanings:<P>
<UL>
<LI>ID. The resource ID for this particular key-map resource.
<LI>Version. The version number of this key-map resource format.
<LI>Key code map. A 128-byte table that contains virtual key codes. At each byte offset into the table, the entry is the virtual key code (plus possibly an exception entry flag) for the raw key code whose value equals that offset.
<LI>Count of exception records. The number of entries in the exception array.
<LI><A NAME=MARKER-2-48></A>Exception array. An array of exception records, which map raw key codes to communication instructions.<P>
</UL>
 Each exception record has these elements (see also <A HREF=#MARKER-9-47>Figure C-4</A>):<P>
<UL>
<LI>A raw key code.
<LI>One byte containing the following elements:<P>
<UL>
<LI>A Boolean (<CODE>Xor</CODE> or <CODE>noXor</CODE>) field that determines whether to instruct the driver to invert the state of the key instead of using the state provided by the hardware.
<LI>Filler (3 bits in length).
<LI>The ADB opcode, an instruction to the keyboard to perform some task. ADB opcodes are described in <I><A HREF="../Devices/Devices-2.html">Inside Macintosh: Devices</A></I>.<P>
</UL>
<LI>A variable length Pascal data string that is passed to the ADB op trap along with the ADB opcode. The first byte in the string is the length byte.<P>
</UL>
 The following is an example of the exception array used to turn the Caps Lock light of the Apple Extended Keyboard II on and off, to match the state of the Caps Lock key.<P>
<PRE>
   {
            $39, noXor, $E, &quot;\$00\$02&quot;;
            $B9, noXor, $E, &quot;\$00\$02&quot;;
   }
</PRE>
<DL>
<DT><B>Note</B>
<DD>Do not change the key-map resource. Everything your application needs to support any kind of text input is in the keyboard-layout and key-remap resources. You need to work with the key-map resource only if you are making your own keyboard.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
<HR>
<B>Subtopics</B>
<B><!-- TOC --><DL>
<DL>
<DT><A HREF="Text-577.html#HEADING577-0">Apple Extended Keyboard</A>
<DD>
<DT><A HREF="Text-578.html#HEADING578-0">Reassigning Right-Hand Key Codes</A>
<DD>
<DT><A HREF="Text-579.html#HEADING579-0">Other Hardware Dependencies</A>
<DD>
<DT><A HREF="Text-580.html#HEADING580-0">Virtual Key Codes for Non-ADB Keyboards</A>
<DD>
</DL>
</DL>
</B>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Text-575.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Text-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Text-594.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Text-577.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Text-3.html">&copy; Apple Computer, Inc.</A><br>6 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
