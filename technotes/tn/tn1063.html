<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1063: Inside Macintosh: Processes: Time Manager Addenda</title>   <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"><meta name="keywords" content="have creator list relevant keywords here"><meta name="Description" content="Technical Note TN1063: have creator write a brief descriptionhere."><meta name="categories" content="Inside Macintosh Addenda and Processes"><meta name="week-posted" content="Jul 31, 2000 - Aug 4, 2000"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002904" title="Inside Macintosh: Processes: Time Manager Addenda"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxCarbon-date.html">Carbon</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Carbon/idxProcessManagement-date.html" target="_blank">Carbon > Process Management</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1063</div>
<div id="pageheadsub">Inside Macintosh: Processes: Time Manager Addenda</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"> <!-- begin_header_box --> <table width="600" cellpadding="0" cellspacing="0" border="0">	<tr>		<td width=300 valign="top" align=left scope="row">			<table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>				</tr>				<tr bgcolor="#e6e6e6">					<td background="images/tnmenubody.gif" width=300 align=left>						<span id="menutitle">							CONTENTS                             <br>                            <br>						</span>					</td>				</tr>				<tr bgcolor="#e6e6e6">					<td background="images/tnmenubody.gif" width=300 align=left><!-- begin_toc --><p id="menutext"><A HREF="#BasicRules">Some Basic Time Manager Rules</A><BR>                                    <BR>                                    <A HREF="#tmReserved">Setting Up tmReserved</A><BR>                                    <BR>                                    <A HREF="#tmWakeup">About tmWakeup</A><BR>                                    <BR>                                    <A HREF="#Microseconds">The Microseconds                  Alternative</A><BR>                                    <BR>                                    <A HREF="#UndeferredTasks">Undeferred Time Manager                  Task</A><BR>                                    <BR>                                    <A HREF="#NativeTimeManager">The Native Time                  Manager</A><BR>                                    <BR>                                    <A HREF="#TimeManagerErrors">Time Manager                  Errors</A><BR>                                    <BR>                                    <A HREF="#Summary">Summary</A><BR>                                    <BR>                                    <A HREF="#References">References</A><BR>                                    <BR>                                    <A HREF="#Changes">Change History</A><BR>                                    <BR>                                    <A HREF="#Downloads">Downloadables</A></p>                  <!-- end_toc --> 								</td>				</tr>				<tr>					<td width=300 align=left scope="row">						<img src="images/tnmenubottom.gif" alt="" width=300 height=16>					</td>				</tr>			</table>		</td>		<td width=300 valign="top" align=left>			<!-- begin_intro_text -->            <P id = "introtext">This technote discusses a number of Time Manager issuesthat are not covered in the<a href="http://developer.apple.com/documentation/mac/Processes/Processes-53.html">TimeManager</A> chapter of <CITE>Inside Macintosh: Processes</CITE>.</P>                  <P id = "introtext">This Note is intended for all developers whowant to do time measurement using the Time Managerroutines.</P>                  <!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Sep 01 1996]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_header_box --> <BR><BR><hr width=500 align=center>          <BR><BR> <!-- begin_content -->                  <P><A NAME="BasicRules"></A></P>                  <H2>Some Basic Time Manager Rules</H2>                  <P>When programming with the Time Manager, it is important         to observe the following rules: </P>                  <UL>            <LI>For each Time Manager task that you insert (using            <CODE>InsTime</CODE> or <CODE>InsXTime</CODE>), you must            remove the same Time Manager task (using            <CODE>RmvTime</CODE>) once and only once.</li>                        <LI>While your Time Manager task is inserted (that is,            between <CODE>InsTime</CODE> and <CODE>RmvTime</CODE>),            you can prime the task multiple times. For example, the            sequence <CODE>InsTime</CODE>, <CODE>PrimeTime</CODE>,            fire, <CODE>PrimeTime</CODE>, fire,            <CODE>PrimeTime</CODE>, fire, <CODE>RmvTime</CODE> is            perfectly legal. Some developers always insert, prime and            remove their Time Manager tasks. While legal, this is            unnecessarily inefficient.</li>                        <LI>If you remove a Time Manager task (using            <CODE>RmvTime</CODE>), you must insert it again (using            <CODE>InsTime</CODE> or <CODE>InsXTime</CODE>) before            priming it.</li>                        <LI>If you have primed a Time Manager task, you must not            prime it again until it fires. This is explicitly called            out in            <a href="http://developer.apple.com/documentation/mac/Processes/Processes-59.html">Inside            Macintosh: Processes, page 3-11</A>. If you need to            cancel a Time Manager task, simply remove it using            <CODE>RmvTime</CODE>. If you need to reschedule a Time            Manager task, remove it, then reinsert it, then prime it            again.</li>                        <LI>Don't use <CODE>InsXTime</CODE> unless you want drift            free timing. A common mistake is to install a drift free            Time Manager task (using <CODE>InsXTime</CODE>), prime it            for 1 second, let it fire, and then, 5 minutes later,            prime it again for another 1 second. The task fires            immediately because it was installed as a drift free            task. To avoid this behavior, simply use the original            <CODE>InsTime</CODE> call.</li>         </UL>                  <P>This rules are not new; they are all explicitly or         implicitly described in <CITE>Inside Macintosh:          Processes</CITE>. However, recent systems now enforce these         rules more strictly. If you break these rules, you may see         one of the following symptoms: </P>                  <UL>            <LI>The system crashes with a            <CODE>dsVMDeferredFuncTableFull</CODE> (112) system            error.</li>                        <LI>The system freezes because low-memory is trashed            (prior to System 7.5.5).</li>                        <LI>The system bus errors because of a            <A HREF="tn1094b.html#Implementation1">fatal            page fault</A>.</li>                        <LI><CODE>PrimeTime</CODE> returns <CODE>qErr</CODE> (-1)            when you attempt to prime a task that isn't installed.</li>                        <LI>Timer Manager tasks not firing at the right time.</li>         </UL>         <BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>                                    "Timer.h" defines the various Time Managers                  routines as void functions, which prevents you                  from getting the error result from                  <CODE>PrimeTime</CODE>. See                  <A HREF="#TimeManagerErrors">Time Manager                  Errors</A> for instructions on how to get this                  error result.</P></TD></TR></TABLE></CENTER><BR>                  <P><A HREF="#top">Back to top</A></P>                  <P><A NAME="tmReserved"></A></P>                  <H2>Setting Up tmReserved</H2>                  <P>On page 3-8 of         <a href="http://developer.apple.com/documentation/mac/Processes/Processes-60.html">         <I>Inside Macintosh: Processes</I></A>, it clearly states         that both <CODE>tmWakeUp</CODE> and <CODE>tmReserved</CODE>         should be set to 0 (as shown in Listing 1) prior to the         first call to <CODE>InsXTime</CODE> when using the extended         Time Manager.</P>                                                     <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>theTMTask.tmWakeUp = 0;theTMTask.tmReserved = 0;InsXTime((QElemPtr)&amp;theTMTask);PrimeTime((QElemPtr)&amp;theTMTask, 2000);</pre>	</TD></TR><TR>	<td align="left"><P><b>Listing 1.</b> Set both<CODE>tmWakeUp</CODE> and <CODE>tmReserved</CODE>to 0 before calling <CODE>InsXTime</CODE>.</p>	</TD></TR></TABLE></CENTER>                  <P>If you do want to do some time measurement, then you have         to call <CODE>RmvTime</CODE> to get the current value of         <CODE>tmCount</CODE>, which leads later to a new call to         <CODE>InsXTime</CODE>, and a call to <CODE>PrimeTime</CODE>         with a 0 delay which has a special meaning in that case.         Although it appears, after much reading, rather clear that         you leave the current value of <CODE>tmWakeUp</CODE>         untouched in the <CODE>TMTask</CODE> structure, you can't be         sure what to do about the value of <CODE>tmReserved</CODE>.         </P>                  <P>The truth is that prior to October, 1992 (System Software         7.1), you didn't care, but it's more of a concern now, since         Apple slightly modified the behavior of the Time Manager to         deal with performance issues.</P>                  <P>If you use code like that in Listing 2 and leave         <CODE>tmReserved</CODE> untouched, then after 127 calls your         extended time task is converted into a non-extended time         task (for a good but can't-be-disclosed reason) which, being         waked up with a 0 delay <CODE>PrimeTime</CODE> (which has no         special meaning for a non-extended time task), will suddenly         be called and called again -- more frequently than it should         be.</P>                                                      <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>// WARNING: Don't use this code!RmvTime((QElemPtr)&amp;theTMTask);remaining = theTMTask.tmCount;InsXTime((QElemPtr)&amp;theTMTask);PrimeTime((QElemPtr)&amp;theTMTask, 0);// WARNING: Don't use this code!</pre>	</TD></TR><TR>	<td align="left"><P><b>Listing 2.</b> Typical code formeasuring time using the Time Manager.</p>	</TD></TR></TABLE></CENTER>         <P>So, if you perform that kind of time measurement, changeyour code to that shown in Listing 3.</P>                           <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>RmvTime((QElemPtr)&amp;theTMTask);remaining = theTMTask.tmCount;theTMTask.tmReserved = 0;InsXTime((QElemPtr)&amp;theTMTask);PrimeTime((QElemPtr)&amp;theTMTask, 0);</pre>	</TD></TR><TR>	<td align="left"><P><b>Listing 3.</b> Correct code for measuring time using the Time Manager.</p>	</TD></TR></TABLE></CENTER>                   <P>Since the Time Manager, prior to System Software 7.1,         doesn't care about <CODE>tmReserved</CODE>, then you can set         <CODE>tmReserved</CODE> to 0 before each call to         <CODE>InsXTime</CODE> without checking the system version.         You still have, of course, to ensure that the Time Manager         you're using is the extended one (the response to         <CODE>gestaltTimeMgrVersion</CODE> is         <CODE>gestaltExtendedTimeMgr</CODE> (3) or greater).</P>                  <P><A HREF="#top">Back to top</A></P>                  <P><A NAME="tmWakeup"></A></P>                  <H2>About tmWakeUp</H2>                  <P>The following sentence, also on page 3-8 in <I>Inside         Macintosh: Processes,</I> is incorrect: "The         <CODE>tmWakeUp</CODE> field contains the time at which the         Time Manager task specified by <CODE>tmAddr</CODE> was last         executed (or 0 if it has not yet been executed)." It should         say: "The <CODE>tmWakeUp</CODE> field contains the time at         which the Time Manager task specified by <CODE>tmAddr</CODE>         is scheduled to be executed (or 0 if it has not yet been         primed)."</P>                 <BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>                                    Since the format of that field is undocumented and                  used internally by the Time Manager, developers are                  strongly discouraged anyway from performing any                  kind of calculation or comparison on the value of                  this field, since that format could change in the                  future.</p></TD></TR></TABLE></CENTER><BR>                  <P><A HREF="#top">Back to top</A></P>                  <P><A NAME="Microseconds"></A></P>                  <H2>The Microseconds Alternative</H2>                  <P>Another way to perform time measurement would be to use         the <CODE>Microseconds</CODE> call, which is much easier to         use and less likely to change in the future.</P>                                    <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>pascal void Microseconds(UnsignedWide *microseconds);</pre>	</TD></TR><TR>	<td align="left"><P><b>Listing 4.</b> The prototype for <CODE>Microseconds</CODE>.</p>	</TD></TR></TABLE></CENTER><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Important:</B><BR><CODE>Microseconds</CODE> has a reputation for being                  inconveniently slow. Many developers have run                  performance tests and noticed that                  <CODE>Microseconds</CODE> can take over 10 microseconds to                  execute. Prior to the advent of the <A HREF="#NativeTimeManager">native                  Time Manager</A>,                  <CODE>Microseconds</CODE> had a number of performance                  problems: </P>                                                               <UL>                     <LI>It was implemented in                     68K code.</li>                                          <LI>It relied on a time                     base which is very slow to access on modern                     computers.</li>                                          <LI>The algorithm was                     somewhat convoluted.</li>                                          <LI>It was patched by                     various system components.</li>                  </UL>                                    <P>The native Time Manager                  has significantly improved the performance of                  <CODE>Microseconds</CODE>. However, for best performance,                  your application should use the <CODE>UpTime</CODE> routine. <CODE>UpTime</CODE> is layered directly on top of the                  PowerPC Time Base Register (TBR) and is both faster                  and more accurate than <CODE>Microseconds</CODE>.</P>                                    <P><CODE>UpTime</CODE> is exported by <CODE>InterfaceLib</CODE> on all computers running Mac OS                  8.5 and higher, and by <CODE>DriverServicesLib</CODE> on all PCI-based computers                  regardless of the system version.</p></TD></TR></TABLE></CENTER><BR>                       <P><A HREF="#top">Back to top</A></P>                  <P><A NAME="UndeferredTasks"></A></P>                  <H2>Undeferred Time Manager Tasks</H2>                  <P>This section describes an optimization that you might         want to employ when using the Time Manager in the presence         of virtual memory (VM). Most developers will not be         interested in this; however, all users of the Time Manager         should heed the following warning.</P>                  <TABLE BORDER=0 CELLPADDING=3         WIDTH=500>            <TR>               <td bgcolor="#E6E6E6" align=left>                  <P><B>WARNING: </B><BR>                                    Because there is an <EM>extremely remote</EM>                  possibility that the memory you have allocated for                  your Time Manager task contains the special value                  listed below, if you want to ensure the behavior                  defined in                  <B><a href="http://developer.apple.com/documentation/mac/Memory/Memory-2.html">                  Inside Macintosh: Memory</A></B>, you should always                  clear the <CODE>qLink</CODE> field in the                  <CODE>TMTask</CODE> before installing it.</p>               </TD></TR>         </table><br>                  <P>As described in         <B><a href="http://developer.apple.com/documentation/mac/Memory/Memory-2.html">Inside         Macintosh: Memory</A></B>, Time Manager tasks are         automatically deferred by the Virtual Memory (VM) system to         avoid fatal page faults. This was done for backward         compatibility with existing applications that use the Time         Manager, but it can seriously increase the latency between         when the timer expires and when your Time Manager task         executes.</P>                  <P>For more information about interactions between the Time         Manager and VM, see Technote 1094         <A HREF="tn1094.html">Virtual Memory Application         Compatibility</A>.</P>                  <P>For example, if you schedule a Time Manager task to         execute at time X and, at time (X - delta) some process         takes a page fault, your Time Manager task will not be         called until time (X + Y - delta), where Y is the time         required to field a page fault. If the page fault causes the         hard disk to seek, Y could be as great as the hard disk's         average seek time, approximately 10 ms. If you are trying to         use the Time Manager to measure time in         <EM>microseconds</EM>, this could be a problem.</P>                  <P>There is a way you can install Time Manager tasks so the         callback is not deferred by VM; however, before using this         technique, you should be aware of its dangers. Because VM         does not defer these special Time Manager tasks, it is         possible for them to fire when paging is not safe. To avoid         fatal page faults, you must ensure: </P>                  <UL>            <LI>The <CODE>TMTask</CODE> record is held for the entire            time the Time Manager task is installed (see Listing 5).</li>                        <LI>The code for the timer task and any data it            references is held. If the code for your timer task is            stored in a code resource, you can use the snippet from            Listing 6 to make sure it is held. If your timer task            code is not in a code resource, it's very difficult to            ensure that it and its data are held.</li>                        <LI>You timer task code only calls system routines that            are guaranteed to meet the above requirement -- this            typically means only that routines that are known to be            interrupt-safe.</li>         </UL>         <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>HoldMemory(&amp;theTask, sizeof(TMTask));</pre>	</TD></TR><TR>	<td align="left"><P><b>Listing 5.</b> Holding the Time Managertask itself.</p>	</TD></TR></TABLE></CENTER>                  <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>// Ensure the code doesn't move in logical memoryHLock(ttaskCodeHandle);// Ensure the code is held in physical memory and cannot be paged to diskHoldMemory(*ttaskCodeHandle, GetResourceSizeOnDisk(ttaskCodeHandle));</pre>	</TD></TR><TR>	<td align="left"><P><b>Listing 6.</b> A source code listing showing some code that helps to explain my idea....</p>	</TD></TR></TABLE></CENTER>                                                      <BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>WARNING:</B><BR>If you fail to meet these requirements, you willcause a fatal page fault and crash the system.</P></TD></TR></TABLE></CENTER><BR>         <P>If you call <CODE>InsTime</CODE> or <CODE>InsXTime</CODE>         with the <CODE>qLink</CODE> field set to $65616461, the VM         patch on the Time Manager will recognize your special         requirements and execute your timer task as soon as it         fires, regardless of whether paging is safe or not.</P>                  <P><A HREF="#top">Back to top</A></P>                  <P><A NAME="NativeTimeManager"></A></P>                  <H2>The Native Time Manager         </H2>                  <P>In late 1999, Apple introduced a new         implementation of the Time Manager, known as the native Time         Manager. The native Time Manager has the following         features: </P>                  <UL>            <LI>It publishes the same            programming interface as the extended Time            Manager.</li>                        <LI>It is implemented as PowerPC            native code.</li>                        <LI>It uses the PowerPC Time Base            Register (TBR) and Decrementer register (DEC) as its time            source. Prior to the introduction of the native Time            Manager, all timing was done using the timer registers in            the VIA (6522 Versatile Interface Adapter) or, more            accurately, the VIA cell in the system's I/O ASIC. This            change yields both more accurate timing and faster            execution time.</li>                        <LI>The <CODE>Microseconds</CODE> call is also implemented in terms of            TBR, so the Time Manager and <CODE>Microseconds</CODE> are synchronized.</li>         </UL>                  <P>The native Time Manager is         available on all ROM-in-RAM CPUs running Mac OS 9 or later,         and on CPUs with the Uni-N ASIC running Mac OS 8.6. The best         way to detect the presence of the native Time Manager is to         call <CODE>Gestalt</CODE>         with the <CODE>gestaltTimeMgrVersion</CODE> selector and look for the result         <CODE>gestaltNativeTimeMgr</CODE>.</P>                  <BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>                  The definition of <CODE>gestaltNativeTimeMgr</CODE>, shown below, is missing from Universal Interfaces 3.3.2 and below[2474617].</P></TD></TR></TABLE></CENTER><BR>                  <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>enum {    gestaltNativeTimeMgr = 4  /* native Time Manager is present */};</pre>	</TD></TR><TR>	<td align="left"><P><b>Listing 7.</b> "Gestalt.h" additionsfor the native Time Manager.</p>	</TD></TR></TABLE></CENTER>	         <H3>Developer Consequences</H3>                  <P>The native Time Manager publishes         exactly the same programming interface as the extended Time         Manager, so the developer consequences of the new         implementation should be minimal. The following sections         describe the gotchas we have seen so far.</P>                  <H4>Testing for Time Manager         Features</H4>                  <P>When testing whether a particular         Time Manager feature is available, always compare the result         of <CODE>gestaltTimeMgrVersion</CODE> with the "greater than" operator rather         than the "equals" operator. For example, the code in Listing         8 tests whether the features of the extended Time Manager         are available. If you test for equality, your code will do         the wrong thing when the native Time Manager is         available.</P>                                    <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>static Boolean HaveExtendedTimeManager(void){    UInt32 response;&nbsp;    return (Gestalt(gestaltTimeMgrVersion,                    (SInt32 *) &amp;response) == noErr)            &amp;&amp; (response &gt;= gestaltExtendedTimeMgr);}</pre>	</TD></TR><TR>	<td align="left"><P><b>Listing 8.</b> Detecting the extended Time Manager.</p>	</TD></TR></TABLE></CENTER>                  <H4>Error Results</H4>                  <P>The native Time Manager can return         an error in cases where previous versions of the Time         Manager never did. It is important that you check and handle         error results from calls to the Time Manager. See         <A HREF="#TimeManagerErrors">Time Manager         Errors</A> for details.         </P>                  <P><A HREF="#top">Back to top</A></P>                  <P><A NAME="TimeManagerErrors"></A></P>                  <H2>Time Manager Errors</H2>                  <P>Since its initial release, the Time         Manager's routines have always been defined to return an         error result in register D0 (see <CITE>Inside Macintosh IV</CITE>, page 300). However, the high-level glue         for calling these routines has never exposed these error         results. This is particularly problematic for the native         Time Manager, which can return an error in cases where         previous versions of the Time Manager never did.</P>                  <P>Apple has addressed this problem by         defining new high-level interfaces for the Time Manager. The         prototypes for the new routines are shown below.</P>                                    <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>extern pascal OSErr InstallTimeTask (QElemPtr tmTaskPtr);extern pascal OSErr InstallXTimeTask(QElemPtr tmTaskPtr);extern pascal OSErr PrimeTimeTask   (QElemPtr tmTaskPtr, long count);extern pascal OSErr RemoveTimeTask  (QElemPtr tmTaskPtr);</pre>	</TD></TR><TR>	<td align="left"><P><b>Listing 9.</b> New Time Manager high-level glue.</p>	</TD></TR></TABLE></CENTER>                           <P>These routines are identical to the         original Time Manager routines except that they return an         error result. The routines were first exported by in         Universal Interfaces 3.3, however they were only callable         from 68K code. Calling these routines from PowerPC code         required two extra steps.</P>                  <UL>            <LI><A HREF="tn1194.html">Mac            OS 9.0.4</A> exports these            routines from InterfaceLib.</li>                        <LI>A future version (post-UI            3.3.2) of Universal Interfaces will include an            InterfaceLib stub library that includes these            routines.</li>         </UL>                  <P>You can simulate these routines for         PowerPC code running on earlier systems by writing your own         CFM glue. See DTS Technote 1127 <A HREF="tn1127.html">In         Search of Missing Links</A> for         the gory details. However, an easier solution is to use the         glue provided by the MoreInterfaceLib module of the DTS         sample code library <a href="http://developer.apple.com/samplecode/Sample_Code/Overview/MoreIsBetter.htm">MoreIsBetter</A>.</P>                  <P><A HREF="#top">Back to top</A></P>                  <P><A NAME="Summary"></A></P>                  <H2>Summary</H2>                  <P>The following points explain what you should and should         not do in working with the Time Manager.</P>                  <UL>            <LI>Always follow the <A HREF="#BasicRules">basic            rules</A>.</li>                        <LI>Always set            <CODE><A HREF="#tmReserved">tmReserved</A></CODE> to 0            before calling <CODE>InsXTime</CODE>.</li>                        <LI>Set <CODE><A HREF="#tmWakeup">tmWakeUp</A></CODE> to            0 before the first call to <CODE>InsXTime</CODE>, never            look at it or modify it (except to set it to 0 in some            cases, no other value is acceptable) afterwards.</li>                        <LI><CODE>tmCount</CODE> is only valid after a call to            <CODE>RmvTime</CODE>.</li>                        <LI>Always clear <CODE>qLink</CODE> before calling            <CODE>InsXTime</CODE>.</li>                        <LI><CODE><A HREF="#Microseconds">Microseconds</A></CODE>            is good alternate way to measure elapsed time.</li>                        <LI>Always check Time Manager error            results.</li>         </UL>                  <P><A NAME="References"></A></P>                  <H2>References</H2>                  <P><a href="http://developer.apple.com/documentation/mac/Processes/Processes-53.html"><I>Inside         Macintosh: Processes</I>, Chapter 3, The Time Manager</A>         </P>                  <P><A HREF="http://rajsky.psych.nyu.edu/VideoToolbox/">Denis         G. Pelli's Web page</A></P>                  <P>DTS Technote 1127 <A HREF="tn1127.html">In         Search of Missing Links</A></P>                  <P>DTS Technote 1194 <A HREF="tn1194.html">Mac         OS 9.0.4</A></P>                  <P><A HREF="#top">Back to top</A></P>                  <P></P>                  <P><A NAME="Changes"></A></P>                  <H2>Change History</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH=544>            <TR>               <td width=100 align=left>                  <P ALIGN=CENTER>September 1996</p>               </TD><td align="left">                  <P>Originally written to elaborate on                  <CODE><A HREF="#tmReserved">tmReserved</A></CODE>                  and <CODE><A HREF="#tmWakeup">tmWakeUp</A></CODE>.</p>               </TD></TR>            <TR>               <td width=100 align=left>                  <P ALIGN=CENTER>March 1999</p>               </TD><td align="left">                  <P>Updated to include information about                  <A HREF="#UndeferredTasks">undeferred Time Manager                  tasks</A>.</p>               </TD></TR>            <TR>               <td width=100 align=left>                  <P ALIGN=CENTER>September 1999</p>               </TD><td align="left">                  <P>Updated to reiterate some                  <A HREF="#BasicRules">basic Time Manager rules</A>.                  Also made some minor clarifications and cosmetic                  changes.</p>               </TD></TR>            <TR>               <td width=100 align=left>                  <P ALIGN=CENTER>July                  2000</p>               </TD><td align="left">                  <P>Updated to describe the                  <A HREF="#NativeTimeManager">native                  Time Manager</A> and                  <A HREF="#TimeManagerErrors">Time                  Manager errors</A>.</p>               </TD></TR>         </table><br>         <P><A HREF="#top">Back to top</A></P>         <P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="500">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (64K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tn1063.pdf">Download</A></P>               </TD>            </TR></TABLE><P><A HREF="#top">Back to top</A></P></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1063.html%3Fid%3DDTS10002904-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1063.html%3Fid%3DDTS10002904-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1063.html%3Fid%3DDTS10002904-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>