<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Opening and Closing a Document Containing Sections(IM:IC)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING30></A>



<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="IAC-29.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="IAC-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="IAC-529.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="IAC-31.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="IAC-2.html"><B>Interapplication Communication</B></A> / <BR><DD><A HREF="IAC-23.html"><B>Chapter 2 - Edition Manager</B></A> / <A HREF="IAC-26.html"><B>Using the Edition Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING30-0></A>
<H2><A NAME=MARKER-9-121></A><A NAME=MARKER-21-122></A>Opening and Closing a Document Containing Sections</H2>
 When opening a document that contains sections, your application should use the <CODE>GetResource</CODE> function to get the section record and the alias record for each publisher and subscriber. Set the <CODE>alias</CODE> field of the section record to be the handle to the alias. See the chapter "Resource Manager" in <I><A HREF="../MoreToolbox/MoreToolbox-2.html">Inside Macintosh: More Macintosh Toolbox</A></I> for detailed information on the <CODE>GetResource</CODE> function.<P>
 You also need to register each section using the <CODE>RegisterSection</CODE> function. The <CODE>RegisterSection</CODE> function informs the Edition Manager that a section exists.<A NAME=MARKER-2-298></A><P>
<PRE>
err := RegisterSection(sectionDocument, sectionH,
                       aliasWasUpdated);
</PRE>
 The <CODE>RegisterSection</CODE> function adds the section record to the Edition Manager's list of registered sections. This function assumes that the <CODE>alias</CODE> field of each section record is a handle to the alias record. The alias record is a reference to the edition container from the section's document. If the <CODE>RegisterSection</CODE> function successfully locates the edition container for a particular section, the section is registered through a shared control block. The control block is a private field in the section record.<A NAME=MARKER-9-466></A><P>
 If the <CODE>RegisterSection</CODE> function cannot find the edition container for a particular subscriber, <CODE>RegisterSection</CODE> returns the <CODE>containerNotFoundWrn</CODE> result code. If the <CODE>RegisterSection</CODE> function cannot find the edition container for a particular publisher, <CODE>RegisterSection</CODE> creates an empty edition container for the publisher in the last place the edition was located. The Edition Manager sends your application a Section Write event for that section. <A NAME=MARKER-2-467></A><P>
 When a user attempts to open a document that contains multiple publishers to the same edition, you should warn the user by displaying an alert box (see <A HREF=IAC-525.html#MARKER-9-421>"Duplicating Publishers and Subscribers" on page 2-58</A>).<P>
 When a user opens a document that contains a subscriber (with an update mode set to automatic), receives a new edition, and then closes the document without making any changes to the file, you should update the document and simply allow the user to close it. You do not need to prompt the user to save changes to the file.<P>
 When closing a document that contains sections, you must unregister each section (using the <CODE>UnRegisterSection</CODE> function) and dispose of each corresponding section record and alias record.<A NAME=MARKER-2-167></A><P>
<PRE>
err := UnRegisterSection(sectionH);
</PRE>
 The <CODE>UnRegisterSection</CODE> function removes the section record from the list of registered sections and unlinks itself from the shared control block.<P>
 <A HREF=#MARKER-9-127>Listing 2-3</A> illustrates how to open an existing file that contains sections. As described earlier, you should retrieve the section and alias resources, connect the pair through the <CODE>alias</CODE> field of the section record, and register the section with the Edition Manager. There are many different techniques for retrieving resources; this listing shows one technique. If an alias was out of date and was updated by the Alias Manager during the resolve, the Edition Manager sets the <CODE>aliasWasUpdated</CODE> parameter of the <CODE>RegisterSection</CODE> function to <CODE>TRUE</CODE>. This means that you should save the document. Additionally, your application must maintain its own list of registered sections for each open document that contains sections. You use this list to write out new editions for updated publishers within a document.<P>
<B>Listing 2-3  <A NAME=MARKER-9-127></A><A NAME=MARKER-21-128></A>Opening a document containing sections</B><P>
<PRE>
PROCEDURE MyOpenExistingDocument(thisDocument: MyDocumentInfoPtr);
VAR
   sectionH:            SectionHandle;
   aliasH:              AliasHandle;
   aliasWasUpdated:     Boolean;
   registerErr:         OSErr;
   resID:               Integer;
   theResType:          ResType;
   thisone:             Integer;
   numberOfSections:    Integer;
   aName:               Str255;
BEGIN
   UseResFile(thisDocument^.resForkRefNum);
   {find out the number of section resources}
   numberOfSections := Count1Resources(rSectionType);
   FOR thisone := 1 TO numberOfSections DO
   BEGIN
      sectionH := SectionHandle(Get1IndResource(rSectionType,
                                              thisone));
      IF sectionH = NIL THEN  {something could be wrong with }
         MySectionErr;        { the file, handle appropriately} 
      {get resource ID of the section &amp; use same ID for alias}
      GetResInfo(Handle(sectionH), resID, theResType, aName);
      {detaching is not necessary, but it is convenient}
      DetachResource(Handle(sectionH));
      {get the alias}
      aliasH := AliasHandle(Get1Resource(rAliasType, resID));
      IF aliasH = NIL THEN    {something could be wrong with }
         MyAliasErr;          { the file, handle appropriately} 
      DetachResource(Handle(aliasH));

      {connect section and alias together}
      sectionH^^.alias := aliasH;
      {register the section}
      registerErr := RegisterSection(thisDocument^.fileSpec,
                                     sectionH, aliasWasUpdated);
      {The RegisterSection function may return an error if }
      { a section is not registered. This is not a fatal error. }
      { Continue looping to register remaining sections.}
      {add this section/alias pair to your internal bookkeeping}
      MyAddSectionAliasPair(thisDocument, sectionH, resID);
      IF aliasWasUpdated THEN 
         {If alias has changed, make a note of this. }
         { It's important to know this when you save.}
         MyAliasHasChanged(sectionH);
   END; {end of FOR}
END;  
</PRE>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="IAC-29.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="IAC-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="IAC-529.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="IAC-31.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="IAC-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
