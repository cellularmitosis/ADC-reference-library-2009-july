<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Accessing Application Global Variables in a VBL Task (IM: Pr)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING84></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Processes-83.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Processes-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Processes-171.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Processes-85.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html"><B>Inside Macintosh:</B></A> <A HREF="Processes-2.html"><B>Processes</B></A><BR><DD><A HREF="Processes-74.html"><B>Chapter 4 - Vertical Retrace Manager</B></A> / <A HREF="Processes-81.html"><B>Using the Vertical Retrace Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING84-0></A>
<H2><A NAME=MARKER-9-98></A>Accessing Application Global Variables in a VBL Task<A NAME=MARKER-2-99></A><A NAME=MARKER-2-100></A></H2>
 <A NAME=MARKER-2-101></A>The Operating System stores the address of the boundary between the current application's global variables and its application parameters in the<DFN> </DFN>microprocessor's <DFN>A5</DFN> register. For this reason, most compilers generate references to application global variables as offsets from the address contained in the A5 register. Therefore, if<DFN> the value in register A5</DFN> does not point to the boundary between your application's global variables and its application parameters, your attempts to access your application's global variables will fail.<P>
 Ordinarily, applications do not need to keep track of the value in<DFN> </DFN>the <DFN>A5</DFN> register. Although all applications share the register, the Process Manager keeps track of the address of your application's A5 world when a major or minor switch causes your application to yield the CPU to other processes, and it restores that value when your application regains access to the CPU. The A5 register is guaranteed to be correct for all code that your application executes directly (that is, for all code that is not executed in response to an interrupt or by a Toolbox or Operating System routine).<P>
 Because VBL tasks are interrupt routines, they might be executed when the value in the A5 register does not point to the A5 world of your application. As a result, if you want to access your application's global variables in a VBL task, you need to set the A5 register to its correct value when your VBL task begins executing and restore the previous value upon exit.<A NAME=MARKER-2-102></A><P>
<DL>
<DT><B>Note</B>
<DD>For a more complete discussion of the A5 register, see the chapter "Memory Management Utilities" in <I><A HREF="../Memory/Memory-2.html">Inside Macintosh: Memory</A></I>.<B></B>  <B>&#183;</B>
</DL>
 The solution to this problem is to find a memory location that both the main program and the VBL task can access. The main program can store the value of<DFN> register A5</DFN> <BR>there, and the VBL task can set<DFN> A5</DFN> correctly by reading that value. The functions <CODE>SetCurrentA5</CODE> and <CODE>SetA5</CODE> can be used for this purpose. The application can store the value of its<DFN> A5</DFN> register by calling <CODE>SetCurrentA5</CODE>. Then, at interrupt time, the task can begin by calling <CODE>SetA5</CODE> to set the register to that value and end by calling <CODE>SetA5</CODE> again, this time to restore the register to its initial value, the one used by the main program.<A NAME=MARKER-2-103></A><A NAME=MARKER-2-104></A><P>
 The only memory location that a VBL task has access to is the address of the task record, as explained in the previous section, <A HREF=Processes-83.html#MARKER-9-91>"Accessing a Task Record at Interrupt Time."</A> So, if your application stores the value of<DFN> A5</DFN> directly following the task record in memory, it can locate the value of<DFN> A5</DFN> by first locating the task record. You can do this by defining a new data type (called <CODE>VBLRec</CODE> in <A HREF=#MARKER-9-106>Listing 4-6</A>) whose first field contains the VBL task and whose second field contains a long integer specifying the value of the<DFN> A5</DFN> register.<A NAME=MARKER-2-105></A><P>
<B>Listing 4-6  <A NAME=MARKER-9-106></A>Storing the value of the A5 register directly after the task record in memory</B><P>
<PRE>
TYPE VBLRec =
   RECORD
      myVBLTask:     VBLTask;    {the actual VBL task record}
      vblA5:         LongInt;    {saved value of application's A5}
   END;

   VBLRecPtr = ^VBLRec;
</PRE>
 Now you can modify the application-defined procedure that installs a VBL task so that it stores the value of<DFN> register A5</DFN> in the <CODE>vblA5</CODE> field of the <CODE>VBLRec</CODE>, as illustrated in <BR><A HREF=#MARKER-9-107>Listing 4-7</A>.<P>
<B>Listing 4-7  <A NAME=MARKER-9-107></A>Saving the value of the A5 register when installing a VBL task</B><P>
<PRE>
FUNCTION InstallVBL: OSErr;
CONST
   kInterval = 6;                   {frequency in interrupts}
BEGIN
   WITH gMyVBLRec.myVBLTask DO      {initialize the VBL task}
      BEGIN
         qType := ORD(vType);       {set queue type}
         vblAddr := @DoVBL;         {set address of VBL task}
         vblCount := kInterval;     {set task frequency}
         vblPhase := 0;             {no phase}
      END;
   myVBLRec.vblA5 := SetCurrentA5;  {get our A5}

   InstallVBL := VInstall(@gMyVBLRec.myVBLTask);
END;
</PRE>
 You must also modify the VBL task so that it sets and restores the value of<DFN> register A5</DFN> correctly. <A HREF=#MARKER-9-108>Listing 4-8</A> illustrates a simple VBL task that increments the global variable <CODE>gCounter</CODE> and then resets itself to run again after the specified number of interrupts.<P>
<B>Listing 4-8  <A NAME=MARKER-9-108></A>Setting up the A5 register and modifying a global variable in a VBL task</B><P>
<PRE>
PROCEDURE DoVBL;
CONST
   kInterval = 6;                   {frequency in interrupts}
VAR
   curA5:   LongInt;                {stored value of A5}
   recPtr:  VBLRecPtr;              {pointer to task record}
BEGIN
   recPtr := VBLRecPtr(GetVBLRec);  {get address of task record}
   curA5 := SetA5(recPtr^.vblA5);   {set our application's A5 }
                                    { and store old A5 in curA5}
   gCounter := gCounter + 1;        {modify a global variable}

   {Reset vblCount so that this procedure executes again.}
   recPtr^.myVBLTask.vblCount := kInterval;

   curA5 := SetA5(curA5);           {restore the old A5 value}
END;
</PRE>
 Because of the optimizations performed by some compilers, the actual work of the VBL task and the setting and restoring of<DFN> the A5</DFN> register might have to be placed in separate procedures. If necessary, you can define a routine <CODE>DoVBL</CODE> that loads the proper value of<DFN> A5</DFN>, calls another routine called <CODE>RunVBL</CODE>, and then restores the old value of<DFN> A5</DFN>. The <CODE>RunVBL</CODE> routine does the work of the VBL task and resets the task record's <CODE>vblCount</CODE> field so that the <CODE>DoVBL</CODE> routine executes again. <A HREF=#MARKER-9-109>Listing 4-9</A> illustrates a sample definition of the <CODE>RunVBL</CODE> function that modifies an application global variable.<P>
<B>Listing 4-9  <A NAME=MARKER-9-109></A>Modifying application global variables in a VBL task</B><P>
<PRE>
PROCEDURE RunVBL (aRecPtr: VBLRecPtr);
CONST
   kInterval = 6;                   {frequency in interrupts}
BEGIN
   gCounter := gCounter + 1;        {modify global variable}

   {Reset vblCount so that this procedure executes again.}
   aRecPtr^.myVBLTask.vblCount := kInterval;
END;
</PRE>
 <A HREF=#MARKER-9-110>Listing 4-10</A> shows how to call <CODE>RunVBL</CODE> from the VBL task.<P>
<B>Listing 4-10  <A NAME=MARKER-9-110></A>Setting up and restoring the A5 register in a VBL task</B><P>
<PRE>
PROCEDURE DoVBL;
VAR
   curA5:   LongInt;                {stored value of A5}
   recPtr:  VBLRecPtr;              {pointer to task record}
BEGIN
   recPtr := VBLRecPtr(GetVBLRec);  {get address of task record}
   curA5 := SetA5(recPtr^.vblA5);   {set our application's A5 }
                                    { and store old A5 in curA5}
   RunVBL(recPtr);                  {run the actual VBL task}
   curA5 := SetA5(curA5);           {restore the old A5 value}
END;
</PRE>
 If this separation of routines is necessary, you must make sure that the two routines (<CODE>DoVBL</CODE> and <CODE>RunVBL</CODE>) are in the same code segment.<A NAME=MARKER-2-6></A><A NAME=MARKER-2-112></A><A NAME=MARKER-2-25></A><A NAME=MARKER-2-114></A><P>
</BLOCKQUOTE><P>
<HR>
<center>
<A HREF="Processes-83.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Processes-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Processes-171.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Processes-85.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Processes-3.html">&copy; Apple Computer, Inc.</A><br>17 JUN 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
