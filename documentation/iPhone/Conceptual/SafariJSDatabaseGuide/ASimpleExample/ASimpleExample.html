<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Safari JavaScript Database Programming Guide: Database Example: A Simple Text Editor</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Database Example: A Simple Text Editor"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP40007256-CH4" title="Database Example: A Simple Text Editor"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../../InternetWeb/index.html#//apple_ref/doc/uid/TP30000440-TP30000469" target="_top">Internet &amp; Web</a> &gt; <a href="../../../../InternetWeb/Scripting-date.html#//apple_ref/doc/uid/TP30000440-TP30000469-TP30000569" target="_top">Scripting &amp; Automation</a> &gt; <a href="../Introduction/Introduction.html#//apple_ref/doc/uid/TP40007256-CH1-SW1">Safari JavaScript Database Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../UsingtheJavascriptDatabase/UsingtheJavascriptDatabase.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../Introduction/RevisionHistory.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP40007256-CH4-SW4" title="Database Example: A Simple Text Editor"></a><h1>Database Example: A Simple Text Editor</h1><p>This example shows a practical, real-world example of how to use the SQL database support. This example contains a very simple HTML editor that stores its content in a local database. This example also demonstrates how to tell Safari about unsaved edits to user-entered content.</p><p>This example builds upon the example in the sample code project <em><a href="../../../../../samplecode/FancyEditingToolbar/index.html#//apple_ref/doc/uid/DTS10004383" target="_top">HTML Editing Toolbar</a></em>, available from the ADC Reference Library. To avoid code duplication, the code from that example is not repeated here. The HTML Editing Toolbar creates an editable region in an HTML page and displays a toolbar with various editing controls.</p><p>To create this example, do the following steps:</p><ol class="ol"><li class="li"><p>Download the <em><a href="../../../../../samplecode/FancyEditingToolbar/index.html#//apple_ref/doc/uid/DTS10004383" target="_top">HTML Editing Toolbar</a></em> sample and extract the contents of the archive.</p></li><li class="li"><p>From the toolbar project folder, copy the files <code>FancyToolbar.js</code> and <code>FancyToolbar.css</code> into a new folder. </p><p>Also copy the folder <code>FancyToolbarImages</code>.</p><p>You do not need to copy the <code>index.html</code> or <code>content.html</code> files provided by that project.</p></li><li class="li"><p>Add a save button in the toolbar. This change is described in <span class="content_text"><a href="ASimpleExample.html#//apple_ref/doc/uid/TP40007256-CH4-SW1">“Adding a Save Button to FancyToolbar.js.”</a></span></p></li><li class="li"><p>Add the <code>index.html</code> and <code>SQLStore.js</code> files into the same directory. You can find listings for these files in <span class="content_text"><a href="ASimpleExample.html#//apple_ref/doc/uid/TP40007256-CH4-SW2">“Creating the index.html File”</a></span> and <span class="content_text"><a href="ASimpleExample.html#//apple_ref/doc/uid/TP40007256-CH4-SW3">“Creating the SQLStore.js File.”</a></span></p></li></ol><p>To use the editor, open the <code>index.html</code> file in Safari. Click the Create New File link to create a new “file”. Edit as desired, and click the save button in the toolbar.</p><p>Next, reload the <code>index.html</code> page. You should see the newly created file in the list of available files. If you click on its name, you will see the text you just edited.</p><a name="//apple_ref/doc/uid/TP40007256-CH4-SW1" title="Adding a Save Button to FancyToolbar.js"></a><h2>Adding a Save Button to FancyToolbar.js</h2><p>In the the <code>FancyToolbar.js</code> (which you should have copied from the HTML Editing Toolbar sample previously), you need to add a few lines of code to add a Save button to the toolbar it displays.</p><p>Immediately <em>before</em> the following line, which is near the bottom of the function <code>setupIfNeeded</code>:</p><div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    this.toolbarElement.appendChild(toolbarArea);<span></span></pre></td></tr></table></div><p>add the following block of code:</p><a name="//apple_ref/doc/uid/TP40007256-CH4-SW5" title="Listing A-1Additions to FancyToolbar.js"></a><p class="codesample"><strong>Listing A-1&nbsp;&nbsp;</strong>Additions to FancyToolbar.js</p><div class="codesample"><table><tr><td scope="row"><pre>    this.saveButton = document.createElement("button");<span></span></pre></td></tr><tr><td scope="row"><pre>    this.saveButton.appendChild(document.createTextNode("Save"));<span></span></pre></td></tr><tr><td scope="row"><pre>    this.saveButton.className = "fancy-toolbar-button fancy-toolbar-button-save";<span></span></pre></td></tr><tr><td scope="row"><pre>    this.saveButton.addEventListener("click", function(event) { saveFile() }, false);<span></span></pre></td></tr><tr><td scope="row"><pre>    toolbarArea.appendChild(this.saveButton);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40007256-CH4-SW2" title="Creating the index.html File"></a><h2>Creating the index.html File</h2><p>This file provides some basic HTML elements that are used by the JavaScript code to display text and accept user input. Save the following as <code>index.html</code> (or any other name you choose):</p><a name="//apple_ref/doc/uid/TP40007256-CH4-SW8" title="Listing A-2index.html"></a><p class="codesample"><strong>Listing A-2&nbsp;&nbsp;</strong>index.html</p><div class="codesample"><table><tr><td scope="row"><pre>&lt;html>&lt;head>&lt;title>JavaScript SQL Text Editor&lt;/title><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;script language="javascript" type="text/javascript" src="FancyToolbar.js">&lt;/script><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;script language="javascript" type="text/javascript" src="SQLStore.js">&lt;/script><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;link rel="stylesheet" type="text/css" href="FancyToolbar.css"><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>&lt;style><span></span></pre></td></tr><tr><td scope="row"><pre>body {<span></span></pre></td></tr><tr><td scope="row"><pre>    // margin: 80px;<span></span></pre></td></tr><tr><td scope="row"><pre>    // background-color: rgb(153, 255, 255);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>iframe.editable {<span></span></pre></td></tr><tr><td scope="row"><pre>    width: 80%;<span></span></pre></td></tr><tr><td scope="row"><pre>    height: 300px;<span></span></pre></td></tr><tr><td scope="row"><pre>    margin-top: 60px;<span></span></pre></td></tr><tr><td scope="row"><pre>    margin-left: 20px;<span></span></pre></td></tr><tr><td scope="row"><pre>    margin-right: 20px;<span></span></pre></td></tr><tr><td scope="row"><pre>    margin-bottom: 20px;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>table.filetable {<span></span></pre></td></tr><tr><td scope="row"><pre>    border-collapse: collapse;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>tr.filerow {<span></span></pre></td></tr><tr><td scope="row"><pre>    border-collapse: collapse;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>td.filelinkcell {<span></span></pre></td></tr><tr><td scope="row"><pre>    border-collapse: collapse;<span></span></pre></td></tr><tr><td scope="row"><pre>    border-right: 1px solid #808080;<span></span></pre></td></tr><tr><td scope="row"><pre>    border-bottom: 1px solid #808080;<span></span></pre></td></tr><tr><td scope="row"><pre>    border-top: 1px solid #808080;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>td.filenamecell {<span></span></pre></td></tr><tr><td scope="row"><pre>    border-collapse: collapse;<span></span></pre></td></tr><tr><td scope="row"><pre>    padding-right: 20px;<span></span></pre></td></tr><tr><td scope="row"><pre>    border-bottom: 1px solid #808080;<span></span></pre></td></tr><tr><td scope="row"><pre>    border-top: 1px solid #808080;<span></span></pre></td></tr><tr><td scope="row"><pre>    border-left: 1px solid #808080;<span></span></pre></td></tr><tr><td scope="row"><pre>    padding-left: 10px;<span></span></pre></td></tr><tr><td scope="row"><pre>    padding-right: 30px;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre>&lt;/style><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>&lt;/head>&lt;body onload="initDB(); setupEventListeners(); chooseDialog();"><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>&lt;div id="controldiv">&lt;/div><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;iframe id="contentdiv" style="display: none" class="editable">&lt;/iframe><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>&lt;div id="origcontentdiv" style="display: none">&lt;/div><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;div id="tempdata">&lt;/div><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>&lt;/body><span></span></pre></td></tr><tr><td scope="row"><pre>&lt;/html><span></span></pre></td></tr></table></div>	<a name="//apple_ref/doc/uid/TP40007256-CH4-SW3" title="Creating the SQLStore.js File"></a><h2>Creating the SQLStore.js File</h2><p>This script contains all of the database functionality for this example. The functions here are called from <code>index.html</code> and <code>FancyToolbar.js</code>.</p><p>The major functions are:</p><ul class="ul"><li class="li"><p><code>initDB</code>—opens a connection to the database and calls <code>createTables</code> to create tables if needed.</p></li><li class="li"><p><code>createTables</code>—creates tables in the database if they do not exist.</p></li><li class="li"><p><code>chooseDialog</code>—displays a “file” selection dialog</p></li><li class="li"><p><code>deleteFile</code>—displays a deletion confirmation dialog</p></li><li class="li"><p><code>reallyDelete</code>—flags a “file” for deletion</p></li><li class="li"><p><code>createNewFileAction</code>—creates a new “file” entry</p></li><li class="li"><p><code>saveFile</code>—saves a “file” into the database.</p></li><li class="li"><p><code>loadFile</code>—loads a “file” from the database.</p></li></ul><p>In addition to these functions, this example contains several other functions that serve minor roles in modifying the HTML content or handling results and errors.</p><p>The function <code>saveChangesDialog</code> is also interesting to web application developers. It demonstrates one way to determine whether a user has made unsaved changes to user-entered content and to display a dialog allowing the user to choose whether to leave the page in such a state.</p><p>Save the following file as <code>SQLStore.js</code> (or modify the <code>index.html</code> file to refer to the name you choose):</p><a name="//apple_ref/doc/uid/TP40007256-CH4-SW9" title="Listing A-3SQLStore.js"></a><p class="codesample"><strong>Listing A-3&nbsp;&nbsp;</strong>SQLStore.js</p><div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>var systemDB;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! Initialize the systemDB global variable. */<span></span></pre></td></tr><tr><td scope="row"><pre>function initDB()<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>try {<span></span></pre></td></tr><tr><td scope="row"><pre>    if (!window.openDatabase) {<span></span></pre></td></tr><tr><td scope="row"><pre>        alert('not supported');<span></span></pre></td></tr><tr><td scope="row"><pre>    } else {<span></span></pre></td></tr><tr><td scope="row"><pre>        var shortName = 'mydatabase';<span></span></pre></td></tr><tr><td scope="row"><pre>        var version = '1.0';<span></span></pre></td></tr><tr><td scope="row"><pre>        var displayName = 'My Important Database';<span></span></pre></td></tr><tr><td scope="row"><pre>        var maxSize = 65536; // in bytes<span></span></pre></td></tr><tr><td scope="row"><pre>        var myDB = openDatabase(shortName, version, displayName, maxSize);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        // You should have a database instance in myDB.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>} catch(e) {<span></span></pre></td></tr><tr><td scope="row"><pre>    // Error handling code goes here.<span></span></pre></td></tr><tr><td scope="row"><pre>    if (e == INVALID_STATE_ERR) {<span></span></pre></td></tr><tr><td scope="row"><pre>        // Version number mismatch.<span></span></pre></td></tr><tr><td scope="row"><pre>    alert("Invalid database version.");<span></span></pre></td></tr><tr><td scope="row"><pre>    } else {<span></span></pre></td></tr><tr><td scope="row"><pre>    alert("Unknown error "+e+".");<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    return;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// alert("Database is: "+myDB);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>createTables(myDB);<span></span></pre></td></tr><tr><td scope="row"><pre>systemDB = myDB;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! Format a link to a document for display in the "Choose a file" pane. */<span></span></pre></td></tr><tr><td scope="row"><pre>function docLink(row)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    var name = row['name'];<span></span></pre></td></tr><tr><td scope="row"><pre>    var files_id = row['id'];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return "&lt;tr class='filerow'>&lt;td class='filenamecell'>"+name+"&lt;/td>&lt;td class='filelinkcell'>(&lt;a href='#' onClick=loadFile("+files_id+")>edit&lt;/a>)&amp;nbsp;(&lt;a href='#' onClick=deleteFile("+files_id+")>delete&lt;/a>)&lt;/td>&lt;/tr>\n";<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! If a deletion resulted in a change in the list of files, redraw the "Choose a file" pane. */<span></span></pre></td></tr><tr><td scope="row"><pre>function deleteUpdateResults(transaction, results)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    if (results.rowsAffected) {<span></span></pre></td></tr><tr><td scope="row"><pre>        chooseDialog();<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! Mark a file as "deleted". */<span></span></pre></td></tr><tr><td scope="row"><pre>function reallyDelete(id)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    // alert('delete ID: '+id);<span></span></pre></td></tr><tr><td scope="row"><pre>    var myDB = systemDB;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    myDB.transaction(<span></span></pre></td></tr><tr><td scope="row"><pre>        new Function("transaction", "transaction.executeSql('UPDATE files set deleted=1 where id=?;', [ "+id+" ], /* array of values for the ? placeholders */"+<span></span></pre></td></tr><tr><td scope="row"><pre>            "deleteUpdateResults, errorHandler);")<span></span></pre></td></tr><tr><td scope="row"><pre>    );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! Ask for user confirmation before deleting a file. */<span></span></pre></td></tr><tr><td scope="row"><pre>function deleteFile(id)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    var myDB = systemDB;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    myDB.transaction(<span></span></pre></td></tr><tr><td scope="row"><pre>        new Function("transaction", "transaction.executeSql('SELECT id,name from files where id=?;', [ "+id+" ], /* array of values for the ? placeholders */"+<span></span></pre></td></tr><tr><td scope="row"><pre>            "function (transaction, results) {"+<span></span></pre></td></tr><tr><td scope="row"><pre>                "if (confirm('Really delete '+results.rows.item(0)['name']+'?')) {"+<span></span></pre></td></tr><tr><td scope="row"><pre>                    "reallyDelete(results.rows.item(0)['id']);"+<span></span></pre></td></tr><tr><td scope="row"><pre>                "}"+<span></span></pre></td></tr><tr><td scope="row"><pre>            "}, errorHandler);")<span></span></pre></td></tr><tr><td scope="row"><pre>    );<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! This prints a list of "files" to edit. */<span></span></pre></td></tr><tr><td scope="row"><pre>function chooseDialog()<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    var myDB = systemDB;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    myDB.transaction(<span></span></pre></td></tr><tr><td scope="row"><pre>        function (transaction) {<span></span></pre></td></tr><tr><td scope="row"><pre>        transaction.executeSql("SELECT * from files where deleted=0;",<span></span></pre></td></tr><tr><td scope="row"><pre>            [ ], // array of values for the ? placeholders<span></span></pre></td></tr><tr><td scope="row"><pre>            function (transaction, results) {<span></span></pre></td></tr><tr><td scope="row"><pre>                var string = '';<span></span></pre></td></tr><tr><td scope="row"><pre>                var controldiv = document.getElementById('controldiv');<span></span></pre></td></tr><tr><td scope="row"><pre>                for (var i=0; i&lt;results.rows.length; i++) {<span></span></pre></td></tr><tr><td scope="row"><pre>                    var row = results.rows.item(i);<span></span></pre></td></tr><tr><td scope="row"><pre>                    string = string + docLink(row);<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>                if (string == "") {<span></span></pre></td></tr><tr><td scope="row"><pre>                    string = "No files.&lt;br />\n";<span></span></pre></td></tr><tr><td scope="row"><pre>                } else {<span></span></pre></td></tr><tr><td scope="row"><pre>                    string = "&lt;table class='filetable'>"+string+"&lt;/table>";<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>                controldiv.innerHTML="&lt;H1>Choose a file to edit&lt;/H1>"+string+linkToCreateNewFile();<span></span></pre></td></tr><tr><td scope="row"><pre>            }, errorHandler);<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! This prints a link to the "Create file" pane. */<span></span></pre></td></tr><tr><td scope="row"><pre>function linkToCreateNewFile()<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return "&lt;p>&lt;button onClick='createNewFile()'>Create New File&lt;/button>";<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! This creates a new "file" in the database. */<span></span></pre></td></tr><tr><td scope="row"><pre>function createNewFileAction()<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    var myDB = systemDB;<span></span></pre></td></tr><tr><td scope="row"><pre>    var name = document.getElementById('createFilename').value<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // alert('Name is "'+name+'"');<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    myDB.transaction(<span></span></pre></td></tr><tr><td scope="row"><pre>        function (transaction) {<span></span></pre></td></tr><tr><td scope="row"><pre>            var myfunc = new Function("transaction", "results", "/* alert('insert ID is'+results.insertId); */ transaction.executeSql('INSERT INTO files (name, filedata_id) VALUES (?, ?);', [ '"+name+"', results.insertId], nullDataHandler, killTransaction);");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                transaction.executeSql('INSERT INTO filedata (datablob) VALUES ("");', [],<span></span></pre></td></tr><tr><td scope="row"><pre>                myfunc, errorHandler);<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    chooseDialog();<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! This saves the contents of the file. */<span></span></pre></td></tr><tr><td scope="row"><pre>function saveFile()<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    var myDB = systemDB;<span></span></pre></td></tr><tr><td scope="row"><pre>    // alert("Save not implemented.\n");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    var contentdiv = document.getElementById('contentdiv');<span></span></pre></td></tr><tr><td scope="row"><pre>    var contents = contentdiv.contentDocument.body.innerHTML;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // alert('file text is '+contents);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    myDB.transaction(<span></span></pre></td></tr><tr><td scope="row"><pre>        function (transaction) {<span></span></pre></td></tr><tr><td scope="row"><pre>            var contentdiv = document.getElementById('contentdiv');<span></span></pre></td></tr><tr><td scope="row"><pre>            var datadiv = document.getElementById('tempdata');<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            var filedata_id = datadiv.getAttribute('lfdataid');<span></span></pre></td></tr><tr><td scope="row"><pre>            var contents = contentdiv.contentDocument.body.innerHTML;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            transaction.executeSql("UPDATE filedata set datablob=? where id=?;",<span></span></pre></td></tr><tr><td scope="row"><pre>                [ contents, filedata_id ], // array of values for the ? placeholders<span></span></pre></td></tr><tr><td scope="row"><pre>                nullDataHandler, errorHandler);<span></span></pre></td></tr><tr><td scope="row"><pre>            // alert('Saved contents to '+filedata_id+': '+contents);<span></span></pre></td></tr><tr><td scope="row"><pre>            var origcontentdiv = document.getElementById('origcontentdiv');<span></span></pre></td></tr><tr><td scope="row"><pre>            origcontentdiv.innerHTML = contents;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>            alert('Saved.');<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>    );<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! This displays the "Create file" pane. */<span></span></pre></td></tr><tr><td scope="row"><pre>function createNewFile()<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    var myDB = systemDB;<span></span></pre></td></tr><tr><td scope="row"><pre>    var controldiv = document.getElementById('controldiv');<span></span></pre></td></tr><tr><td scope="row"><pre>    var string = "";<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    string += "&lt;H1>Create New File&lt;/H1>\n";<span></span></pre></td></tr><tr><td scope="row"><pre>    string += "&lt;form action='javascript:createNewFileAction()'>\n";<span></span></pre></td></tr><tr><td scope="row"><pre>    string += "&lt;input id='createFilename' name='name'>Filename&lt;/input>\n";<span></span></pre></td></tr><tr><td scope="row"><pre>    string += "&lt;input type='submit' value='submit' />\n";<span></span></pre></td></tr><tr><td scope="row"><pre>    string += "&lt;/form>\n";<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    controldiv.innerHTML=string;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! This processes the data read from the database by loadFile and sets up the editing environment. */<span></span></pre></td></tr><tr><td scope="row"><pre>function loadFileData(transaction, results)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    var controldiv = document.getElementById('controldiv');<span></span></pre></td></tr><tr><td scope="row"><pre>    var contentdiv = document.getElementById('contentdiv');<span></span></pre></td></tr><tr><td scope="row"><pre>    var origcontentdiv = document.getElementById('origcontentdiv');<span></span></pre></td></tr><tr><td scope="row"><pre>    var datadiv = document.getElementById('tempdata');<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // alert('loadFileData called.');<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    var data = results.rows.item(0);<span></span></pre></td></tr><tr><td scope="row"><pre>    var filename = data['name'];<span></span></pre></td></tr><tr><td scope="row"><pre>    var filedata = data['datablob'];<span></span></pre></td></tr><tr><td scope="row"><pre>    datadiv.setAttribute('lfdataid', parseInt(data['filedata_id']));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    document.title="Editing "+filename;<span></span></pre></td></tr><tr><td scope="row"><pre>    controldiv.innerHTML="";<span></span></pre></td></tr><tr><td scope="row"><pre>    contentdiv.contentDocument.body.innerHTML=filedata;<span></span></pre></td></tr><tr><td scope="row"><pre>    origcontentdiv.innerHTML=filedata;<span></span></pre></td></tr><tr><td scope="row"><pre>    contentdiv.style.border="1px solid #000000";<span></span></pre></td></tr><tr><td scope="row"><pre>    contentdiv.style['min-height']='20px';<span></span></pre></td></tr><tr><td scope="row"><pre>    contentdiv.style.display='block';<span></span></pre></td></tr><tr><td scope="row"><pre>    contentdiv.contentDocument.contentEditable=true;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! This loads a "file" from the database and calls loadFileData with the results. */<span></span></pre></td></tr><tr><td scope="row"><pre>function loadFile(id)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    // alert('Loading file with id '+id);<span></span></pre></td></tr><tr><td scope="row"><pre>    var datadiv = document.getElementById('tempdata');<span></span></pre></td></tr><tr><td scope="row"><pre>    datadiv.setAttribute('lfid', parseInt(id));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    myDB = systemDB;<span></span></pre></td></tr><tr><td scope="row"><pre>    myDB.transaction(<span></span></pre></td></tr><tr><td scope="row"><pre>        function (transaction) {<span></span></pre></td></tr><tr><td scope="row"><pre>            var datadiv = document.getElementById('tempdata');<span></span></pre></td></tr><tr><td scope="row"><pre>            var id = datadiv.getAttribute('lfid');<span></span></pre></td></tr><tr><td scope="row"><pre>            // alert('loading id' +id);<span></span></pre></td></tr><tr><td scope="row"><pre>            transaction.executeSql('SELECT * from files, filedata where files.id=? and files.filedata_id = filedata.id;', [id ], loadFileData, errorHandler);<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! This creates the database tables. */<span></span></pre></td></tr><tr><td scope="row"><pre>function createTables(db)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/* To wipe out the table (if you are still experimenting with schemas,<span></span></pre></td></tr><tr><td scope="row"><pre>   for example), enable this block. */<span></span></pre></td></tr><tr><td scope="row"><pre>if (0) {<span></span></pre></td></tr><tr><td scope="row"><pre>    db.transaction(<span></span></pre></td></tr><tr><td scope="row"><pre>        function (transaction) {<span></span></pre></td></tr><tr><td scope="row"><pre>        transaction.executeSql('DROP TABLE files;');<span></span></pre></td></tr><tr><td scope="row"><pre>        transaction.executeSql('DROP TABLE filedata;');<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    );<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>db.transaction(<span></span></pre></td></tr><tr><td scope="row"><pre>    function (transaction) {<span></span></pre></td></tr><tr><td scope="row"><pre>        transaction.executeSql('CREATE TABLE IF NOT EXISTS files(id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, name TEXT NOT NULL, filedata_id INTEGER NOT NULL, deleted INTEGER NOT NULL DEFAULT 0);', [], nullDataHandler, killTransaction);<span></span></pre></td></tr><tr><td scope="row"><pre>        transaction.executeSql('CREATE TABLE IF NOT EXISTS filedata(id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, datablob BLOB NOT NULL DEFAULT "");', [], nullDataHandler, errorHandler);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! When passed as the error handler, this silently causes a transaction to fail. */<span></span></pre></td></tr><tr><td scope="row"><pre>function killTransaction(transaction, error)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    return true; // fatal transaction error<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! When passed as the error handler, this causes a transaction to fail with a warning message. */<span></span></pre></td></tr><tr><td scope="row"><pre>function errorHandler(transaction, error)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    // Error is a human-readable string.<span></span></pre></td></tr><tr><td scope="row"><pre>    alert('Oops.  Error was '+error.message+' (Code '+error.code+')');<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Handle errors here<span></span></pre></td></tr><tr><td scope="row"><pre>    var we_think_this_error_is_fatal = true;<span></span></pre></td></tr><tr><td scope="row"><pre>    if (we_think_this_error_is_fatal) return true;<span></span></pre></td></tr><tr><td scope="row"><pre>    return false;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! This is used as a data handler for a request that should return no data. */<span></span></pre></td></tr><tr><td scope="row"><pre>function nullDataHandler(transaction, results)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! This returns a string if you have not yet saved changes.  This is used by the onbeforeunload<span></span></pre></td></tr><tr><td scope="row"><pre>    handler to warn you if you are about to leave the page with unsaved changes. */<span></span></pre></td></tr><tr><td scope="row"><pre>function saveChangesDialog(event)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    var contentdiv = document.getElementById('contentdiv');<span></span></pre></td></tr><tr><td scope="row"><pre>    var contents = contentdiv.contentDocument.body.innerHTML;<span></span></pre></td></tr><tr><td scope="row"><pre>    var origcontentdiv = document.getElementById('origcontentdiv');<span></span></pre></td></tr><tr><td scope="row"><pre>    var origcontents = origcontentdiv.innerHTML;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // alert('close dialog');<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (contents == origcontents) {<span></span></pre></td></tr><tr><td scope="row"><pre>    return NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return "You have unsaved changes."; //   CMP "+contents+" TO "+origcontents;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/*! This sets up an onbeforeunload handler to avoid accidentally navigating away from the<span></span></pre></td></tr><tr><td scope="row"><pre>    page without saving changes. */<span></span></pre></td></tr><tr><td scope="row"><pre>function setupEventListeners()<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    window.onbeforeunload = function () {<span></span></pre></td></tr><tr><td scope="row"><pre>    return saveChangesDialog();<span></span></pre></td></tr><tr><td scope="row"><pre>    };<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>	

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../UsingtheJavascriptDatabase/UsingtheJavascriptDatabase.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../Introduction/RevisionHistory.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2009 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2009-01-06<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/iPhone/Conceptual/SafariJSDatabaseGuide/ASimpleExample/ASimpleExample.html%3Fid%3DTP40007256-1.1&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/iPhone/Conceptual/SafariJSDatabaseGuide/ASimpleExample/ASimpleExample.html%3Fid%3DTP40007256-1.1&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/iPhone/Conceptual/SafariJSDatabaseGuide/ASimpleExample/ASimpleExample.html%3Fid%3DTP40007256-1.1&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>