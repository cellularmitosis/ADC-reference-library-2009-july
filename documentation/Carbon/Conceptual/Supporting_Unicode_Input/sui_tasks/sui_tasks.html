<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Supporting Unicode Input: Supporting Unicode Input in Applications and Input Methods</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Supporting Unicode Input in Applications and Input Methods"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30000194" title="Supporting Unicode Input in Applications and Input Methods"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000420" target="_top">Carbon</a> &gt; <a href="../../../TextFonts-date.html#//apple_ref/doc/uid/TP30000440-TP30000420-TP30000461" target="_top">Text &amp; Fonts</a> &gt; <a href="../sui_intro/sui_intro.html#//apple_ref/doc/uid/TP30000192-DontLinkElementID_6">Supporting Unicode Input</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../sui_concepts/sui_concepts.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../sui_docrevhx/sui_docrevhx.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30000194-DontLinkElementID_7" title="Supporting Unicode Input in Applications and Input Methods"></a><h1><a name="//apple_ref/doc/uid/TP30000194-BCIDHIFH" title="Supporting Unicode Input in Applications and Input Methods"></a>Supporting Unicode Input in Applications and Input Methods</h1><p>This chapter describes how applications and input methods can support Unicode input by using Text Services Manager and Unicode Utilities.</p><ul class="ul"><li class="li"><p>Application developers should read <span class="content_text"><a href="sui_tasks.html#//apple_ref/doc/uid/TP30000194-BAJEBFII">“Supporting Unicode Input in Applications”</a></span> to learn about the steps required for an application to support Unicode input.</p></li><li class="li"><p>Input method developers should read <span class="content_text"><a href="sui_tasks.html#//apple_ref/doc/uid/TP30000194-BAJCHFHB">“Providing Unicode Support in Input Methods”</a></span> to learn about the steps required for an input method to support Unicode input.</p></li><li class="li"><p>Typically the Text Services Manager calls the <code><a href="../../../Reference/Unicode_Utilities_Ref/Reference/reference.html#//apple_ref/doc/c_ref/UCKeyTranslate" target="_top">UCKeyTranslate</a></code> function when needed. However, there are occasions when your application or input method may need to call this function directly. See <span class="content_text"><a href="sui_tasks.html#//apple_ref/doc/uid/TP30000194-BAJDHACJ">“Using the UCKeyTranslate Function”</a></span> for more details.</p></li></ul><a name="//apple_ref/doc/uid/TP30000194-BAJEBFII" title="Supporting Unicode Input in Applications"></a><h2>Supporting Unicode Input in Applications</h2><p>To support Unicode input, an application must both support the Text Services Manager and request Unicode input. Applications that do not support Unicode input fall in two categories: those that do not support the Text Services Manager, and those that do, but which do not request Unicode input. In both cases, these applications do receive some of the benefit of text input from Unicode input sources which can take the form of either Unicode keyboard layouts (specified by <code>'uchr'</code> resources) or Unicode input methods and text services.</p><p>However, the kinds of Unicode input available to applications that do not support Unicode input are restricted. These applications receive only input from partial Unicode input sources, that is sources that generate only Unicode characters that are all within the repertoire of a single Mac encoding, usually the Mac encoding determined by the current keyboard script. This is because text from partial Unicode input sources is automatically converted by the Text Services Manager to a Mac OS encoding for delivery to these applications. Full Unicode input sources—that is, those which either generate characters within the repertoire of several Mac encodings or outside the repertoire of any Mac encoding—are not available to these applications and appear disabled in the Keyboard menu.</p><p>You application can support the Text Services Manager in one of the two following ways:</p><ul class="ul"><li class="li"><p>Implement Carbon events for text handlers. This is the preferred way because the performance advantages of using Carbon events over Apple events are significant. In additoin, you can target Carbon events at either the application or control and window level, whereas Apple events are targeted only at the application level. For information on implementing Carbon events for text handlers, see <em><a href="../../UnderstandTextInput_TSM/index.html#//apple_ref/doc/uid/TP40000957" target="_top">Understanding Text Input and the Text Services Manager in Carbon</a></em>.</p></li><li class="li"><p>Provide Apple event handlers for he full suite of Text Services Manager Apple events in order to support inline input of text. While input can be handled using the bottomline method, this mode of input does not support full Unicode input sources, but only those input sources whose output can be converted to a given Mac encoding (that is, partial Unicode input sources). </p><p>Implementing a set of Apple event handlers for the Text Services Manager suite, for the purpose of supporting inline input in general and Unicode input in particular, greatly enhances the text input experience for users of your applications in a variety of existing input sources as well as new Unicode input sources. Even if the majority of existing input methods are associated with a particular Mac script system (and therefore a particular Mac encoding), your application will automatically support these input sources because the Text Services Manager converts all text from Mac OS encoding input sources to Unicode for delivery to applications that have requested Unicode input.</p><p>See <span class="content_text"><a href="sui_tasks.html#//apple_ref/doc/uid/TP30000194-BAJFJFHG">“Using Apple Events to Handle Unicode Text”</a></span> for more information.</p></li></ul><div class="notebox"><a name="//apple_ref/doc/uid/TP30000194-DontLinkElementID_8" title="Note"></a><p><strong>Note:</strong>&nbsp;TSMTE does not currently support Unicode input. If an application does rely on TSMTE for input, its input sources will be limited to those which generate input within the repertoire of individual Mac OS encodings.</p></div><a name="//apple_ref/doc/uid/TP30000194-TPXREF125" title="Identifying an Application as Supporting Unicode"></a><h3>Identifying an Application as Supporting Unicode</h3><p>Text Services Manager client applications must create an internal record called a TSM document (defined by the <code>TSMDocument</code> data type) before they can use any services provided through the Text Services Manager. A TSM document is a private data structure that your application associates with each of its documents that use a text service.</p><p>You use the TSM document type <code>kUnicodeDocument</code> (<code>'udoc'</code>) to request Unicode input. When a Unicode-input TSM document is active, the associated application receives input in Unicode. The application can receive input from all input types: full Unicode, partial Unicode, and Mac OS encodings.</p><p>Non-Unicode (Mac OS encoded) input is converted to Unicode before being delivered to a Unicode-input TSM document.</p><p>When non-Unicode TSM documents are active or when the current application is not a Text Services Manager client, the application receives Mac OS encoded input. In these cases, full Unicode input sources are disabled in the Keyboard menu and cannot be used, and input from partial Unicode sources is automatically converted to the current keyboard script (a Mac OS encoding) by the Text Services Manager.</p><p>Your application creates a Unicode TSM document by specifying the <code>kUnicodeDocument</code> (<code>'udoc'</code>) type in the <code>supportedInterfaceTypes</code> parameter of the function <code><a href="../../../Reference/Text_Services_Manager/Reference/reference.html#//apple_ref/doc/c_ref/NewTSMDocument" target="_top">NewTSMDocument</a></code>.</p><a name="//apple_ref/doc/uid/TP30000194-BAJFJFHG" title="Using Apple Events to Handle Unicode Text"></a><h3>Using Apple Events to Handle Unicode Text</h3><p>Text Services Manager uses a Unicode Apple event that allows applications with Unicode TSM documents to streamline their event handling.</p><p>In this Apple event model of text event handling, your application calls <code>WaitNextEvent</code> and passes low-level keyboard events to the Text Services Manager through the function <code><!--a-->TSMEvent<!--/a--></code>. The function <code><!--a-->TSMEvent<!--/a--></code> always returns true, to indicate that the key event was processed, either by an input method (and delivered through the standard Text Services Manager Apple events) or by means of direct delivery to the application (through the <code>kUnicodeNotFromInputMethod</code> Apple event). Because the <code>kUnicodeNotFromInputMethod</code> Apple event contains both the Unicode character code(s) and a copy of the original low-level key event record, your application can now consolidate all of its keyboard input processing in a single logical unit in its Apple event handlers, rather than in an event loop.</p><p>This section provides details on how to modify existing Text Services Manager Apple event handlers and discusses the Text Services Manager Apple event required to support Unicode input. If your application already supports the Text Services Manager, these changes are minimal. If your application does not currently support the Text Services Manager, you should first implement support for the Text Services Manager.</p><a name="//apple_ref/doc/uid/TP30000194-TPXREF126" title="Modifying Existing Apple Event Handlers for Unicode"></a><h4>Modifying Existing Apple Event Handlers for Unicode</h4><p>When the active TSM document is of type <code>kUnicodeDocument</code>, the Text Services Manager delivers all text content in Text Services Manager Apple events as Unicode text, in a descriptor whose keyword continues to be <code>keyAETheData</code>, but whose descriptor type is type<code>UnicodeText</code>.</p><p>When known data structures accompanying the Unicode text contain offsets to text, these offsets are also converted, if needed, to Unicode (byte) offsets to match the encoding of the text delivered to the application’s Apple event handler. This delivery of text (and accompanying byte offsets) in Unicode occurs regardless of the type of input source. If the input source is a Unicode input method, text and offsets are passed through by the Text Services Manager to the application’s handler unchanged, but if the input source generates text in a Mac encoding, the generated text is converted to Unicode automatically by the Text Services Manager.</p><p>Text is converted between Unicode and Mac OS encodings as necessary. Text from Unicode input sources is automatically converted to Mac encodings for delivery to applications that don’t use Unicode TSM documents. Text from Mac OS encoding input sources is converted to Unicode for delivery to applications using Unicode TSM documents. Similarly, application text requested by an input method (with the Apple event ID <code>kGetSelectedText</code>) is converted as necessary.</p><a name="//apple_ref/doc/uid/TP30000194-TPXREF127" title="The Update Active Input Area Event"></a><h5>The Update Active Input Area Event</h5><p>Your application’s Apple event handler for the <code>kUpdateActiveInputArea</code> Apple event must obtain the <code>keyAETheData</code> parameter using the descriptor type <code>typeUnicodeText</code> to obtain the Unicode content of the active input area. The <code>keyAEFixLength</code>, <code>keyAEHiliteRange</code>, <code>keyAEUpdateRange</code>, and <code>keyAEClauseOffsets</code> parameters all contain byte offsets into the Unicode text.</p><a name="//apple_ref/doc/uid/TP30000194-TPXREF128" title="The Position To Offset Event"></a><h5>The Position To Offset Event</h5><p>Your application’s Apple event handler for the <code>kPos2Offset</code> Apple event must reply with the <code>keyAEOffset</code> parameter containing a Unicode text (byte) offset. If the text service requesting the offset is associated with a Mac OS encoding, the Text Service Manager converts the text offset from Unicode to that of the Mac OS encoding.</p><a name="//apple_ref/doc/uid/TP30000194-TPXREF129" title="The Offset To Position Event"></a><h5>The Offset To Position Event</h5><p>Your application’s Apple event handler for the <code>kOffset2Pos</code> Apple event must treat the <code>keyAEOffset</code> parameter as a Unicode text (byte) offset. If the text service specifying the text offset is associated with a Mac OS encoding, the Text Services Manager converts the text offset from the Mac OS encoding to Unicode before forwarding the Apple event to the application.</p><a name="//apple_ref/doc/uid/TP30000194-TPXREF130" title="The Get Selected Text Event "></a><h5>The Get Selected Text Event </h5><p>Your application’s Apple event handler for the <code>kGetSelectedText</code> Apple event must return the current text selection as Unicode text. If the text service specifying the text offset is associated with a Mac OS encoding, the Text Services Manager will convert the Unicode text to the Mac OS encoding before forwarding the Apple event to the text service. Supporting this event is optional, but recommended.</p><a name="//apple_ref/doc/uid/TP30000194-TPXREF131" title="Supporting the Unicode (Not From Input Method) Apple Event"></a><h4>Supporting the Unicode (Not From Input Method) Apple Event</h4><p>To support Unicode input through the Text Services Manager, your application must provide a handler for the Text Services Manager Unicode Apple event whose event ID is <code>kUnicodeNotFromInputMethod</code>. When the user generates Unicode input that does not originate from an input method (that is, the Unicode text may be generated by a keyboard layout or is simply not handled by an input method) the Text Services Manager forwards the generated input to your application as Unicode text in the <code>kUnicodeNotFromInputMethod</code> Apple event.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000194-DontLinkElementID_9" title="Note"></a><p><strong>Note:</strong>&nbsp;Unicode text resulting from input method interactions is delivered using the <code>UpdateActiveInputArea</code> Apple event, as is the case for non-Unicode text.</p></div><p>The <code>kUnicodeNotFromInputMethod</code> Apple event contains the Unicode text, a copy of the original low-level key event, and a <code>ScriptLanguageRecord</code> structure that identifies the current keyboard script. Your application’s event handler for the <code>kUnicodeNotFromInputMethod</code> Apple event must obtain the <code>keyAETheData</code> parameter using the descriptor type t<code>ypeUnicodeText</code> to obtain the input as Unicode text.</p><p>Your application’s Apple event handler can also obtain the original low-level key event from a parameter whose keyword is <code>keyAETSMEventRecord</code> and whose descriptor type is <code>typeLowLevelEventRecord</code>. If the current keyboard layout is determined by a <code>'KCHR'</code> resource, you can pass the virtual key code and modifiers to the function <code><a href="../../../Reference/Event_Manager/Reference/reference.html#//apple_ref/doc/c_ref/KeyTranslate" target="_top">KeyTranslate</a></code> to produce a Mac OS encoding character code. Otherwise, if a Unicode keyboard layout is being used (that is, if the keyboard layout is determined by a <code>'uchr'</code> resource), you can use the <code><a href="../../../Reference/Unicode_Utilities_Ref/Reference/reference.html#//apple_ref/doc/c_ref/UCKeyTranslate" target="_top">UCKeyTranslate</a></code> function. Typically, you do not need to perform either action.</p><p>The application’s Apple event handler for the <code>kUnicodeNotFromInputMethod</code> event should always fully process the input and return <code>noErr</code>. Returning any error or not providing a handler causse the <code><!--a-->TSMEvent<!--/a--></code> function to indicate that the low-level key event was not handled, in which case your application may not be able to generate the correct text, depending on whether the input source is a Unicode keyboard layout and whether a dead-key sequence is in progress.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000194-DontLinkElementID_10" title="Note"></a><p><strong>Note:</strong>&nbsp;In most cases, the Text Services Manager Apple event contains two required parameters, one of which is the <code>keyAEServerInstance</code> parameter, which identifies the component that is sending the Apple event. However, in the case of the <code>kUnicodeNotFromInputMethod</code> Apple event, this parameter is not included because the event only pertains to cases where a component (such as, an input method) is not handling the data.</p></div><dl class="table-display"><dt>Class</dt><dd><code>kTextServiceClass</code></dd><dt>ID</dt><dd><code>kUnicodeNotFromInputMethod</code></dd><dt>Requested action </dt><dd>Accept Unicode text.</dd></dl><p class="clear"></p><p>The required parameters are as follows:</p><dl class="table-display"><dt>Keyword</dt><dd><code>keyAETheData</code></dd><dt>Descriptor type</dt><dd><code>typeUnicodeText</code></dd><dt>Data</dt><dd>Unicode text. Note that this text data has not been processed in any way by a text servcie component.</dd></dl><p class="clear"></p><dl class="table-display"><dt>Keyword</dt><dd><code>keyAETSMEventRecord</code></dd><dt>Descriptor type</dt><dd><code>typeLowLevelEventRecord</code></dd><dt>Data</dt><dd>A copy of the original low-level key event record.</dd></dl><p class="clear"></p><dl class="table-display"><dt>Keyword</dt><dd><code>keyAETSMDocumentRefcon</code></dd><dt>Descriptor type</dt><dd><code>typeLongInteger</code></dd><dt>Data</dt><dd>A TSMdocument specfier (reference constant0 supplied by the appcliation in a prior call to the function <code><a href="../../../Reference/Text_Services_Manager/Reference/reference.html#//apple_ref/doc/c_ref/NewTSMDocument" target="_top">NewTSMDocument</a></code>. This value is associated with the TSM document that receives the Unicode text input.</dd></dl><p class="clear"></p><dl class="table-display"><dt>Keyword</dt><dd><code>keyAETSMScriptTag</code></dd><dt>Descriptor type</dt><dd><code>typeIntlWritingCode</code></dd><dt>Data</dt><dd>A <code>ScriptLangagueRecord</code> structure that identifies the script code and language code associated with the text returned in the <code>keyAETheData</code> parameter. If the current input source is partial Unicode, this contains a Mac OS script code. If the current input source is full Unicode, it is 0x7E (<code>smUnicodeScript</code>).</dd></dl><p class="clear"></p><p>There are no optional parameters.</p><p>The return parameter is the following:</p><dl class="table-display"><dt>Keyword</dt><dd><code>keyErrorNumber</code></dd><dt>Descriptor type</dt><dd><code>typeShortInteger</code></dd><dt>Data</dt><dd>Any errors that the application needs to return to the Text Services Manager to terminate processing of the key event that the application passed to <code><!--a-->TSMEvent<!--/a--></code>. The function <code><!--a-->TSMEvent<!--/a--></code> returns <code>false</code> to indicate to the applicatoin that the key even was not handled. The application can then attempt to process the event. Note that the character code data in the returned key event is not valid in general, but the virtual key code and modifier-key data can still be processed.</dd></dl><p class="clear"></p><a name="//apple_ref/doc/uid/TP30000194-TPXREF132" title="Handling Low-Level Keyboard Events for Applications"></a><h4>Handling Low-Level Keyboard Events for Applications</h4><p>While low-level keyboard events appear essentially unchanged with Unicode text input, there are certain differences which can affect how text is converted.</p><p>Whether or not a Unicode script system is present, the keyboard driver always uses a <code>'KCHR'</code> resource to generate the character codes that are posted in the low-level event. Even if the current keyboard layout is specified solely by a <code>'uchr'</code> resource, the Script Manager supplies the keyboard driver with the best approximation of an appropriate <code>'KCHR'</code> resource to use. However, the resulting character in the low-level event may have no relation to the actual Unicode character, as specified by the <code>'uchr'</code> resource. Also, in this case, when the current keyboard layout is specified by a <code>'uchr'</code> resource alone, the Text Services Manager disables driver dead-key processing for <code>'KCHR'</code> resources and performs all dead-key processing itself.</p><p>If the current keyboard layout is specified only by a partial Unicode <code>'uchr'</code> resource, and the current application is not using a Unicode TSM document, the Text Services Manager intercepts the key event posted by the driver before it is delivered to the application. The Text Services Manager uses the <code>'uchr'</code> resource with the function <code><a href="../../../Reference/Unicode_Utilities_Ref/Reference/reference.html#//apple_ref/doc/c_ref/UCKeyTranslate" target="_top">UCKeyTranslate</a></code> to map the virtual key code and modifiers in the event to a string of Unicode character codes. It then converts these to character codes in the appropriate Mac OS encoding and post these for delivery to the application in a series of keyboard events. While these appear to your application as normal keyboard events, you cannot automatically reproduce the characters in the events by using the (pre-Unicode) <code><a href="../../../Reference/Event_Manager/Reference/reference.html#//apple_ref/doc/c_ref/KeyTranslate" target="_top">KeyTranslate</a></code> function to convert the key code and modifiers in the event. Instead, you must check to see if a <code>'uchr'</code> resource is present to know whether to use <code><a href="../../../Reference/Event_Manager/Reference/reference.html#//apple_ref/doc/c_ref/KeyTranslate" target="_top">KeyTranslate</a></code> or <code><a href="../../../Reference/Unicode_Utilities_Ref/Reference/reference.html#//apple_ref/doc/c_ref/UCKeyTranslate" target="_top">UCKeyTranslate</a></code>.</p><p>If the current application is using a Unicode TSM document, the keyboard event posted by the driver is not modified before delivery to the application. Instead, the application is expected to pass the event to the Text Services Manager through the function <code><!--a-->TSMEvent<!--/a--></code>, which handles all necessary <code><a href="../../../Reference/Unicode_Utilities_Ref/Reference/reference.html#//apple_ref/doc/c_ref/UCKeyTranslate" target="_top">UCKeyTranslate</a></code> calls or conversion to Unicode.</p><p>For keyboard layouts that have <code>'uchr'</code> resources, <code><!--a-->TSMEvent<!--/a--></code> uses <code><a href="../../../Reference/Unicode_Utilities_Ref/Reference/reference.html#//apple_ref/doc/c_ref/UCKeyTranslate" target="_top">UCKeyTranslate</a></code> to convert the keycode and modifiers in the key event to a sequence of Unicode characters. For keyboard layouts that only have <code>'KCHR'</code> resources, <code><!--a-->TSMEvent<!--/a--></code> converts the Mac OS encoding character in the event to Unicode.</p><a name="//apple_ref/doc/uid/TP30000194-BAJCHFHB" title="Providing Unicode Support in Input Methods"></a><h2>Providing Unicode Support in Input Methods</h2><p>While existing applications process inline input text in Mac OS encodings, as applications adopt Unicode they will also support input from Unicode input methods, greatly increasing the characters available to the user in individual scripts and offering a convenient and comprehensive environment for multi-script or multilingual text entry. Also, because text contained in Apple events from Unicode input methods does not need to be converted by the Text Services Manager to Unicode for application delivery, the efficiency of inline input processing is greatly improved.</p><p>This section identifies the requirements for development of Unicode input methods. While the main requirement imposed by the Text Services Manager is that these input methods communicate externally using Unicode text, the Text Services Manager does not require that an input method perform its internal processing in Unicode nor that the input method images Unicode text in its user interface (input method palettes), although these features are assumed to be desirable or necessary for other reasons.</p><p>Text Services Manager defines two types of Unicode input methods: full Unicode input methods and partial Unicode input methods. A <strong>full Unicode input method</strong> is defined to be an input method which may generate Unicode characters outside of the repertoire of any given Mac OS encoding, in multiple Mac OS encoding repertoires, or both. A <strong>partial Unicode input method</strong> always adheres (externally) to the repertoire of the Mac OS encoding defined by the Mac OS script system to which it belongs.</p><p>Partial Unicode input methods appear in the Keyboard menu section for the script to which they belong. Full Unicode input methods and keyboard layouts appear in a new section near the bottom of the Keyboard menu, after the section for Mac OS encodings.</p><a name="//apple_ref/doc/uid/TP30000194-TPXREF133" title="Identifying an Input Method as Supporting Unicode"></a><h3>Identifying an Input Method as Supporting Unicode</h3><p>Both partial and full Unicode input methods continue to be Component Manager components, described by the <code>ComponentDescription</code> flags in the component <code>'thng'</code> resource. A partial Unicode input method specifies the Mac OS script code with which it is associated, while a full Unicode input method specifies the constant 0x7E (<code>smUnicodeScript</code>). Note that while a partial Unicode input method, like a non-Unicode (Mac OS encoding) input method, advertises itself as being associated with a Mac OS script code, it is distinguished by the contents of the <code>ScriptLanguageRecord</code> structure that it returns when it responds to a <code>GetScriptLanguageSupport</code> call.</p><p>The <code><a href="../../../Reference/Text_Services_Manager/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/doc/c_ref/GetScriptLanguageSupport" target="_top">GetScriptLanguageSupport</a></code> function is the mechanism used by the Text Services Manager to distinguish a Mac OS encoding input method from a partial Unicode input method. Since both of these input methods specify a Mac OS script code in the component description flags of the <code>'thng'</code> resource, a partial Unicode input method implements its <code><a href="../../../Reference/Text_Services_Manager/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/doc/c_ref/GetScriptLanguageSupport" target="_top">GetScriptLanguageSupport</a></code> function to return an array that includes a <code>ScriptLanguageRecord</code> structure with the proper Mac OS language code and a script code of <code>kTextEncodingUnicodeDefault</code> (<code>0x0100</code>).</p><p>Full Unicode input methods, similar to non-Unicode input methods, do not need to implement this function, although a full Unicode input method may wish to return an array of <code>ScriptLanguageRecord</code> structures, each specifying the <code>kTextEncodingUnicodeDefault</code> constant for the script code and the appropriate language code to identify those languages for which it is most suited.</p><p><span class="content_text">Table 3-1</span> shows the relationships of keyboard-layout resources and input methods to differing types of text input, including whether the input method must identify the script systems it supports in a <code>ScriptLanguageRecord</code> structure to respond to the Text Services Manager function <code><a href="../../../Reference/Text_Services_Manager/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/doc/c_ref/GetScriptLanguageSupport" target="_top">GetScriptLanguageSupport</a></code>.</p><a name="//apple_ref/doc/uid/TP30000194-DontLinkElementID_11" title="Table 2-1Text input types, keyboard layouts, and input method script systems"></a><div class="tableholder"><table class="graybox" border = "0" cellspacing="0" cellpadding="5"><caption class="tablecaption"><a name="//apple_ref/doc/uid/TP30000194-BAJIJICE" title="Table 2-1Text input types, keyboard layouts, and input method script systems"></a><strong>Table 2-1&nbsp;&nbsp;</strong>Text input types, keyboard layouts, and input method script systems</caption><tr><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Input type</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Keyboard layout (resourcetype, ID)</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Input method script systems (ComponentDescription flags)</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Input methd script systems (ScriptLanguageRecord structure)</p></th></tr><tr><td  scope="row"><p>Produces Mac OS encoded characters</p></td><td ><p>KCHR, >= 0</p></td><td ><p>Supply any Mac OS script code (0x00-0x20)</p></td><td ><p>Not necessary, but can supply any Mac OS script code (0x00-0x20)</p></td></tr><tr><td  scope="row"><p>Produces partial Unicode characters</p></td><td ><p>uchr, >=0</p></td><td ><p>Supply any Mac OS script code (0x00-0x20)</p></td><td ><p>Necessary; must supply the 16-bit Unicode script code (0x100 = <code>kTextEncodingUnicodeDefault</code>)</p></td></tr><tr><td  scope="row"><p>Produces full Unicode characters</p></td><td ><p>uchr, &lt; 0</p></td><td ><p>Supply the 7-bit Unicode script code (0x7E-s<code>mUnicodeScript</code>)</p></td><td ><p>Not necessary, but can supply the 16-bit Unicode script code (0x100 = <code>kTextEncodingUnicodeDefault</code>)</p></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000194-TPXREF134" title="Responding to the UCTextServiceEvent Function"></a><h3>Responding to the UCTextServiceEvent Function</h3><p>For any Unicode input method, the Text Services Manager always uses the <code><!--a-->UCTextServiceEvent<!--/a--></code> function. This function specifies the low-level event record, but it also contains the Unicode text stream resulting from the keypress. This is important because the keyboard layout being used may be a Unicode keyboard-layout (<code>'uchr'</code>) resource, which may generate more than one character as the result of a single keypress or no characters in the case of a dead-key sequence.</p><p>Note that the Text Services Manager forwards the key event to the input method in all cases, even when no output is produced by the <code>'uchr'</code> resource. Therefore, the input method should be prepared to be called by the <code><!--a-->UCTextServiceEvent<!--/a--></code> function with just the key event and no Unicode text (<code>unicodeString=NULL, unicodeStrLength=0</code>). This allows input methods to process Option-Shift equivalents without the need to override the keyboard layout data used by the keyboard driver, as sometimes has been necessary in the past.</p><a name="//apple_ref/doc/uid/TP30000194-TPXREF135" title="Supporting Unicode in Text Services Manager Apple Events"></a><h3>Supporting Unicode in Text Services Manager Apple Events</h3><p>A Unicode input method must transmit all text that is sent through Text Services Manager Apple events as Unicode text, in a descriptor whose keyword is <code>keyAETheData</code> and whose descriptor type is <code>typeUnicodeText</code>. All text offsets specified in these Apple events must specify byte offsets into the corresponding Unicode text. This applies to all currently defined Text Services Manager Apple events: Update Active Input Area, Offset To Position, Position To Offset, and Get Selected Text.</p><a name="//apple_ref/doc/uid/TP30000194-TPXREF136" title="Handling Low-Level Keyboard Events for Input Methods"></a><h3>Handling Low-Level Keyboard Events for Input Methods</h3><p>While low-level keyboard events appear essentially unchanged with Unicode text input, there are certain differences which can affect how text is converted. Whether or not a Unicode script system is present, the keyboard driver always uses a <code>'KCHR'</code> resource to generate the character codes that are posted in the low-level event. Even if the current keyboard layout is specified solely by a <code>'uchr'</code> resource, the Script Manager will supply the keyboard driver with the best approximation of an appropriate <code>'KCHR'</code> resource to use. However, in the latter case, the resulting character in the low-level event may have no relation to the actual Unicode character as specified by the <code>'uchr'</code> resource.</p><p>Because keyboard drivers are not equipped to handle a Unicode keyboard-layout (<code>'uchr'</code>) resource, which may generate more than one character as the result of a single keypress or no characters in the case of a dead-key sequence, there are three cases where the Text Services Manager disables keyboard driver dead-key processing and performs all dead-key processing itself:</p><ul class="spaceabove"><li class="li"><p>if an input method of any type is in use</p></li><li class="li"><p>if the current keyboard layout is specified solely by a <code>'uchr'</code> resource (that is, if no <code>'KCHR'</code> resource is available)</p></li><li class="li"><p>if the current document identifies itself as a Unicode TSM document and a 'uchr' resource is available</p></li></ul><p>In any of these cases, when the Text Services Manager disables dead-key processing in the keyboard driver, it passes each key event to the <code><a href="../../../Reference/Unicode_Utilities_Ref/Reference/reference.html#//apple_ref/doc/c_ref/UCKeyTranslate" target="_top">UCKeyTranslate</a></code> function, whose output is then forwarded to the input method. When a <code>'uchr'</code> is not available for input into a Unicode input method, the Text Services Manager relies on the Text Encoding Converter to generate the Unicode characters.</p><a name="//apple_ref/doc/uid/TP30000194-TPXREF137" title="Handling Compatibility Issues"></a><h3>Handling Compatibility Issues</h3><p>There are two main compatibility issues for Unicode input methods: </p><ul class="spaceabove"><li class="li"><p>running on systems with Text Services Manager 1.0 </p></li><li class="li"><p>providing support for applications that do not themselves support Unicode</p></li></ul><p>Unicode input methods of any kind cannot be selected, and are not loaded, on a system with Text Services Manager 1.0. While this is true of both full Unicode input methods and partial Unicode input methods, a partial Unicode input method could be implemented such that it behaves as a Mac OS encoding input method with Text Services Manager 1.0, and a partial Unicode input method with Text Services Manager 1.5. In the presence of Text Services Manager 1.0, the input method could continue to perform its internal processing in Unicode and convert text to Mac encoding using the Text Encoding Converter either for display in its own palettes (if ATSUI is not available) or for Apple event content. The input method’s component description flags specify the Mac script in either world, and, in the presence of Text Services Manager 1.5, the input method may respond to a <code><a href="../../../Reference/Text_Services_Manager/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/doc/c_ref/GetScriptLanguageSupport" target="_top">GetScriptLanguageSupport</a></code> call by returning an array that includes a <code>ScriptLanguageRecord</code> structure with the proper Mac OS script code and a language code of <code>kTextEncodingUnicodeDefault</code>.</p><p>Full Unicode input methods cannot be selected by the user unless the current application’s active TSM Document is created with the <code>kUnicodeDocument</code> interface type. Until Unicode is adopted to a greater extent, input methods may benefit from restricting Unicode output to the repertoire of a single Mac OS script system, and possibly generate Unicode outside of a Mac encoding’s repertoire only when it is certain that the current document is a Unicode TSM document.</p><a name="//apple_ref/doc/uid/TP30000194-BAJDHACJ" title="Using the UCKeyTranslate Function"></a><h2>Using the UCKeyTranslate Function</h2><p>In most cases, application and input methods do not need to use the <code><a href="../../../Reference/Unicode_Utilities_Ref/Reference/reference.html#//apple_ref/doc/c_ref/UCKeyTranslate" target="_top">UCKeyTranslate</a></code> function because the Text Services Manager automatically calls it when handling input from a Unicode keyboard layout. However, there may be some circumstances when you want to call the function <code><a href="../../../Reference/Unicode_Utilities_Ref/Reference/reference.html#//apple_ref/doc/c_ref/UCKeyTranslate" target="_top">UCKeyTranslate</a></code> directly.</p><p>For example, your application may need to determine what character code(s) would have been generated for the virtual key code in the current key-down event if a different modifier-key combination had been used. <span class="content_text">Listing 3-1</span> shows how your application can use the function <code><a href="../../../Reference/Unicode_Utilities_Ref/Reference/reference.html#//apple_ref/doc/c_ref/UCKeyTranslate" target="_top">UCKeyTranslate</a></code> to perform its own virtual key code to Unicode character code conversion. Note that this code is a fragment; the ellipses indicates code that you would need to add for your application. The code is intended for use in an application that has an event loop.</p><a name="//apple_ref/doc/uid/TP30000194-DontLinkElementID_12" title="Listing 2-1A code fragment that uses the function UCKeyTranslate in an event loop"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30000194-BAJIAJJG" title="Listing 2-1A code fragment that uses the function UCKeyTranslate in an event loop"></a><strong>Listing 2-1&nbsp;&nbsp;</strong>A code fragment that uses the function UCKeyTranslate in an event loop</p><div class="codesample"><table><tr><td scope="row"><pre>enum {<span></span></pre></td></tr><tr><td scope="row"><pre>    kMaxUnicodeInputStringLength = 16<span></span></pre></td></tr><tr><td scope="row"><pre>};<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> // Code fragment<span></span></pre></td></tr><tr><td scope="row"><pre>    EventRecord *eventPtr;<span></span></pre></td></tr><tr><td scope="row"><pre>    UCKeyboardLayout myKeyLayout;<span></span></pre></td></tr><tr><td scope="row"><pre>    UInt32 deadKeyState;<span></span></pre></td></tr><tr><td scope="row"><pre>    SInt16 currentKeyScript;<span></span></pre></td></tr><tr><td scope="row"><pre>    SInt16 lastKeyLayoutID;<span></span></pre></td></tr><tr><td scope="row"><pre>    UniChar unicodeInputString[kMaxUnicodeInputStringLength];<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // initialization<span></span></pre></td></tr><tr><td scope="row"><pre>    currentKeyScript = GetScriptManagerVariable(smKeyScript);<span></span></pre></td></tr><tr><td scope="row"><pre>    lastKeyLayoutID = GetScriptVariable(currentKeyScript, smScriptKeys);<span></span></pre></td></tr><tr><td scope="row"><pre>    deadKeyState = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>    myKeyLayout = GetResource('uchr', lastKeyLayoutID);<span></span></pre></td></tr><tr><td scope="row"><pre>    // …<span></span></pre></td></tr><tr><td scope="row"><pre>    // event loop<span></span></pre></td></tr><tr><td scope="row"><pre>    while(true)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        // get next event from WaitNextEvent, then<span></span></pre></td></tr><tr><td scope="row"><pre>        switch (eventPtr->what)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            //add other relevant cases here<span></span></pre></td></tr><tr><td scope="row"><pre>            case keyDown:<span></span></pre></td></tr><tr><td scope="row"><pre>            case keyUp:<span></span></pre></td></tr><tr><td scope="row"><pre>            case autoKey:<span></span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                SInt16 currentKeyLayoutID;<span></span></pre></td></tr><tr><td scope="row"><pre>                currentKeyScript = GetScriptManagerVariable(smKeyScript);<span></span></pre></td></tr><tr><td scope="row"><pre>                currentKeyLayoutID = GetScriptVariable(currentKeyScript,                                smScriptKeys);<span></span></pre></td></tr><tr><td scope="row"><pre>                if (currentKeyLayoutID != lastKeyLayoutID){<span></span></pre></td></tr><tr><td scope="row"><pre>                    // reset the dead key state<span></span></pre></td></tr><tr><td scope="row"><pre>                    // if the keyboard layout has changed<span></span></pre></td></tr><tr><td scope="row"><pre>                    deadKeyState = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>                    // attempt to get the handle for<span></span></pre></td></tr><tr><td scope="row"><pre>                    // the new keyboard layout’s 'uchr'<span></span></pre></td></tr><tr><td scope="row"><pre>                    myKeyLayout = GetResource('uchr', currentKeyLayoutID);<span></span></pre></td></tr><tr><td scope="row"><pre>                    lastKeyLayoutID = currentKeyLayoutID;<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>                // if there is a 'uchr' for the current keyboard layout,<span></span></pre></td></tr><tr><td scope="row"><pre>                // use it<span></span></pre></td></tr><tr><td scope="row"><pre>                if (myKeyLayout != NULL){<span></span></pre></td></tr><tr><td scope="row"><pre>                    UInt32 keyboardType;<span></span></pre></td></tr><tr><td scope="row"><pre>                    UInt32 modifierKeyState;<span></span></pre></td></tr><tr><td scope="row"><pre>                    UInt16 virtualKeyCode;<span></span></pre></td></tr><tr><td scope="row"><pre>                    UInt16 keyAction;<span></span></pre></td></tr><tr><td scope="row"><pre>                    UniCharCount actualStringLength;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                    virtualKeyCode = ((eventPtr->message) >> 8) &amp; 0xFF;<span></span></pre></td></tr><tr><td scope="row"><pre>                    keyAction = eventPtr->what - keyDown;<span></span></pre></td></tr><tr><td scope="row"><pre>                    modifierKeyState = ((eventPtr->modifiers) >> 8) &amp; 0xFF;<span></span></pre></td></tr><tr><td scope="row"><pre>                    keyboardType = LMGetKbdType();<span></span></pre></td></tr><tr><td scope="row"><pre>                    status = UCKeyTranslate(*myKeyLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                                virtualKeyCode, keyAction,<span></span></pre></td></tr><tr><td scope="row"><pre>                                modifierKeyState, keyboardType, 0,<span></span></pre></td></tr><tr><td scope="row"><pre>                                &amp;deadKeyState,<span></span></pre></td></tr><tr><td scope="row"><pre>                                kMaxUnicodeInputStringLength,<span></span></pre></td></tr><tr><td scope="row"><pre>                                &amp;actualStringLength, unicodeInputString);<span></span></pre></td></tr><tr><td scope="row"><pre>                    // now do something with status and unicodeInputString<span></span></pre></td></tr><tr><td scope="row"><pre>                    // add your code here<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>                else{<span></span></pre></td></tr><tr><td scope="row"><pre>                    // no 'uchr' resource, do something with 'KCHR'?<span></span></pre></td></tr><tr><td scope="row"><pre>                    // add your code here<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>            break;<span></span></pre></td></tr><tr><td scope="row"><pre>        } // end switch on eventPtr->what<span></span></pre></td></tr><tr><td scope="row"><pre>    } // end of while statement for event loop<span></span></pre></td></tr></table></div>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../sui_concepts/sui_concepts.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../sui_docrevhx/sui_docrevhx.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 1998, 2005 Apple Computer, Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2005-07-07<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Carbon/Conceptual/Supporting_Unicode_Input/sui_tasks/sui_tasks.html%3Fid%3DTP40000951-2.2&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Carbon/Conceptual/Supporting_Unicode_Input/sui_tasks/sui_tasks.html%3Fid%3DTP40000951-2.2&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Carbon/Conceptual/Supporting_Unicode_Input/sui_tasks/sui_tasks.html%3Fid%3DTP40000951-2.2&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>