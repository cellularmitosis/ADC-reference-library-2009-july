<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Using NetSprocket (GameSprockets)</TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000" ="A" NAME="HEADING231"></A>



<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="GameSprockets-230.html"><IMG ALIGN="BOTTOM" SRC="prev.gif" BORDER="none" HSPACE="20" ALT="Previous"></A> <A HREF="GameSprockets-2.html"><IMG ALIGN="BOTTOM" SRC="content.gif" BORDER="none" HSPACE="20" ALT="Book Contents"></A> <A HREF="GameSprockets-318.html"><IMG ALIGN="BOTTOM" SRC="index.gif" BORDER="none" HSPACE="20" ALT="Book Index"></A> <A HREF="GameSprockets-232.html"><IMG ALIGN="BOTTOM" SRC="next.gif" BORDER="none" HSPACE="20" ALT="Next"></A> </CENTER><P>
<FONT SIZE="-1"><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="GameSprockets-2.html"><B>Apple Game Sprockets Guide</B></A> / <BR><DD><A HREF="GameSprockets-229.html"><B>Chapter 4 - NetSprocket</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME="HEADING231-0"></A>
<H1>Using NetSprocket</H1>
 <A NAME="MARKER-2-23"></A>This section illustrates some of the basic ways you can use NetSprocket. It provides source code samples of a sample game that shows how you can<P>
<UL>
<LI>initialize NetSprocket for use in your game
<LI>host a game (optionally using the default human interface)
<LI>join a game
<LI>send and receive messages
<LI>end the game.<P>
</UL>
<DL>
<DT><B>Note</B>
<DD>The code examples shown in this section provide only very rudimentary error handling.<EM></EM>  <IMG ALIGN="BOTTOM" SRC="graphics/triangle.gif">
</DL>
<A NAME="HEADING231-8"></A>
<H2>Initializing NetSprocket<A NAME="MARKER-2-25"></A></H2>
 The NetSprocket shared library must be initialized by your application before you can use any NetSprocket functions. The library should be initialized once at application startup. <A HREF="#MARKER-9-26">Listing 4-1</A> shows you how to initialize NetSprocket.<P>
<B>Listing 4-1  <A NAME="MARKER-9-26"></A>Initializing NetSprocket</B><P>
<PRE>
   err = NSpInitialize(550, 20000, 100, 'nspx', 100);
   if (err != noErr)  HandleError();
</PRE>
<DL>
<DT><B>Note</B>
<DD>Be sure to check for an error from this function. If NetSprocket returns an error, you may not call any other NetSprocket functions.<EM></EM> <A NAME="MARKER-2-27"></A>  <IMG ALIGN="BOTTOM" SRC="graphics/triangle.gif">
</DL>
<A NAME="HEADING231-13"></A>
<H2>Hosting a Game<A NAME="MARKER-2-29"></A></H2>
 There are several things you must do to host a game, as detailed in the section below.<P>
<A NAME="HEADING231-15"></A>
<H3>Creating a Protocol Reference and Advertising Your Game</H3>
 First, you may optionally create protocol references. NetSprocket uses opaque protocol references and lists in order to insure that your game will function properly with transport protocols that are added to NetSprocket after your game is published. Since AppleTalk and TCP/IP are available on every Macintosh computer, you can specify default information for these protocols. <A HREF="#MARKER-9-31">Listing 4-2</A> illustrates how you can preconfigure AppleTalk with a default game name as it will appear to people browsing the AppleTalk network and create the protocol reference.<P>
 You do not have to create protocol references if you are going to use the default NetSprocket human interface. You only need to specify them if you want to set defaults yourself.<P>
<DL>
<DT><B>Note</B>
<DD>This is the default name only. This name can be modified by the user if you display the host dialog box prior to actually hosting the game on the network.<EM></EM>  <IMG ALIGN="BOTTOM" SRC="graphics/triangle.gif">
</DL>
<B>Listing 4-2  <A NAME="MARKER-9-31"></A>Establishing the Game's Name and Creating a Protocol Reference</B><P>
<PRE>
   NSpProtocolReference atRef, ipRef;

   // Do the dialog
   CopyPStr(gameName,   &quot;\pMyGame&quot;);
   CopyPStr(gameType,   &quot;\pExample10&quot;);

   // Set up our protocol list
   atRef = NSpProtocol_CreateAppleTalk(gameName, gameType, 0, 0);
</PRE>
<DL>
<DT><B>Note</B>
<DD>NetSprocket version 1.0 does not support the exclusion of players based on network speed or latency.<EM></EM>  <IMG ALIGN="BOTTOM" SRC="graphics/triangle.gif">
</DL>
 You can also create a TCP/IP protocol reference, as shown in <A HREF="#MARKER-9-32">Listing 4-3</A>.<P>
<B>Listing 4-3  <A NAME="MARKER-9-32"></A>Creating a TCP/IP Protocol Reference</B><P>
<PRE>
   ipRef = NSpProtocol_CreateIP(2002, 0, 0);
</PRE>
<DL>
<DT><B>Note</B>
<DD>There are a number of internet standards governing the assignment of ports. In general, ports 1-1023 are considered reserved, and should never be used by game developers. Ports 1024 and above are dynamic. Ports greater than 5000 are generally used for less-known services. Apple encourages you to choose a port greater than 5000 if you are going to assign a default port for your game. The port number is an unsigned 16 bit value from 0 to 65535.  <IMG ALIGN="BOTTOM" SRC="graphics/triangle.gif">
</DL>
<A NAME="HEADING231-26"></A>
<H3>Creating a Protocol List</H3>
 The reason for creating and maintaining a protocol list is that NetSprocket can support multiple protocols in a single game. Whether or not you created any protocol references, you must create a protocol list. This protocol list will be passed to the NSpDoModalHostDialog function, or to the <CODE>NSpGame_Host</CODE> function. <A HREF="#MARKER-9-33">Listing 4-4</A> shows you how to create a protocol list.<P>
<B>Listing 4-4  <A NAME="MARKER-9-33"></A>Creating a Protocol List</B><P>
<PRE>
   NSpProtocolListReferenceprotocolList;

   err = NSpProtocolList_New(NULL, &amp;protocolList);
   if (err != noErr)  HandleError();
</PRE>
<DL>
<DT><B>Note</B>
<DD>When you create a protocol list, you can optionally append a protocol reference by passing it as the first parameter.<EM></EM>  <IMG ALIGN="BOTTOM" SRC="graphics/triangle.gif">
</DL>
<A NAME="HEADING231-31"></A>
<H3>Adding Protocols to the <A NAME="MARKER-2-34"></A>Protocol List</H3>
 When you have created your protocol list, you should add the protocols you support to your protocol list, as show in <A HREF="#MARKER-9-35">Listing 4-5</A>.<P>
<B>Listing 4-5  <A NAME="MARKER-9-35"></A>Adding Supporting Protocols to a Protocol List</B><P>
<PRE>
   err = NSpProtocolList_Append(protocolList, atRef);
   if (err != noErr)  HandleError();
</PRE>
<DL>
<DT><B>Note</B>
<DD>Once a protocol reference has been added to a protocol list, the list owns the reference. You should not attempt to free the reference in your game.  <IMG ALIGN="BOTTOM" SRC="graphics/triangle.gif">
</DL>
<A NAME="HEADING231-36"></A>
<H3>Presenting the Host Dialog Box</H3>
 Once you've created your protocol list (and optionally set default information), you can present the default dialog box illustrated in <A HREF="GameSprockets-230.html#MARKER-9-20">Figure 4-4</A> for hosting a game by as shown in <A HREF="#MARKER-9-36">Listing 4-6</A>.<P>
<B>Listing 4-6  <A NAME="MARKER-9-36"></A>Displaying the Host Dialog Box</B><P>
<PRE>
   ok = NSpDoModalHostDialog(protocolList, gameName, playerName, 
password, NULL);
   if (!ok)  return;
</PRE>
<A NAME="HEADING231-40"></A>
<H3>Using the Host Function</H3>
 Now that you have obtained and set the necessary configuration information, you are ready to actually host your game. <A HREF="#MARKER-9-37">Listing 4-7</A> shows you how.<P>
<B>Listing 4-7  <A NAME="MARKER-9-37"></A>Hosting your game on the Network</B><P>
<PRE>
   NSpGameReferencegMyGame;

   err = NSpGame_Host(&amp;gMyGame, protocolList, 8, gameName, password, 
playerName, 0, kNSpClientServer, 0);
   if (err != noErr)  HandleError();
</PRE>
<A NAME="HEADING231-44"></A>
<H3>Disposing of the Protocol List</H3>
 When you have created the game reference, you can dispose of your protocol list. You do not need to dispose of each element you added to the list. You can just dispose of the list itself, as shown in <A HREF="#MARKER-9-38">Listing 4-8</A>.<P>
<B>Listing 4-8  <A NAME="MARKER-9-38"></A>Disposing of your Protocol List</B><P>
<PRE>
   NSpProtocolList_Dispose(protocolList);
</PRE>
<A NAME="HEADING231-48"></A>
<H2>Joining A Game<A NAME="MARKER-2-40"></A></H2>
 The NSpDoModalJoinDialog function may be used to allow a player to browse an AppleTalk network and join a game. The dialog box provided for you in NetSProcket is shown in <A HREF="GameSprockets-230.html#MARKER-9-21">Figure 4-5</A>.You may also develop your own join dialog box. <A HREF="#MARKER-9-41">Listing 4-9</A> shows you how to use the <CODE>NSpDoModalJoinDialog</CODE> function.<P>
<B>Listing 4-9  <A NAME="MARKER-9-41"></A>Calling the NSpDoModalJoinDialog function</B><P>
<PRE>
   CopyPStr(gameType,   &quot;\pExample10&quot;);
   address = NSpDoModalJoinDialog(gameType, &quot;\pAvailable Games:&quot;, 
playerName, password, NULL);
</PRE>
 The actual process of joining a game is show in <A HREF="#MARKER-9-42">Listing 4-10</A>. The address is the address reference returned by a call to the NSpDoModalJoinDialog function. Alternatively, you could get your own <CODE>OTAddress</CODE> through your own join dialog box, and then convert it into a NetSprocket address reference by calling <CODE>NSpConvertOTAddrToAddressReference</CODE>.<P>
 The player name, type, and password are sent to the host. If the host requires a password, and the password provided here is not correct, this function will succeed, but your first message you receive from NetSprocket will be a join denied message.<P>
<B>Listing 4-10  <A NAME="MARKER-9-42"></A>Joining the game</B><P>
<PRE>
   err = NSpGame_Join(&amp;gMyGame, address, playerName, password, 0, 0, 
NULL, 0);
   if (err != noErr)  HandleError();
</PRE>
 After executing the NSpGame_Join function, you should release the address reference, as shown in <A HREF="#MARKER-9-43">Listing 4-11</A><P>
<B>Listing 4-11  <A NAME="MARKER-9-43"></A>Releasing the address reference</B><P>
<PRE>
      NSpReleaseAddressReference(ad.dress);
</PRE>
<A NAME="HEADING231-59"></A>
<H2>Receiving Messages<A NAME="MARKER-2-45"></A> From Other Players</H2>
 Now that the game is in play, you will normally drop into your main event loop. In your event loop, you should send any messages you have, and receive any messages that may be pending. <A HREF="#MARKER-9-46">Listing 4-12</A> shows an example of how to receive message from other players.<P>
<B>Listing 4-12  <A NAME="MARKER-9-46"></A>sample game event loop</B><P>
<PRE>
void DoHandleMessages(void)
{
   NSpMessageHeader*message;
   
   while ((message = NSpMessage_Get(gMyGame)) != NULL)
   {
      switch(message-&gt;what)
      {
         case kNSpJoinApproved:
            DoJoinApproved((NSpJoinApprovedMessage *) message);
         break;
         case kNSpPlayerJoined:
            DoPlayerJoined((NSpPlayerJoinedMessage*) message);
         break;
         
         case kNSpPlayerLeft:
            DoPlayerLeft((NSpPlayerLeftMessage*) message);
         break;
         
         case kPlayerLocation:
            DoPlayerLocation((PlayerLocationMessage*) message);
         break;
      }
      
      NSpMessage_Release(gMyGame, message);
   }
}
</PRE>
<A NAME="HEADING231-64"></A>
<H2>Sending <A NAME="MARKER-2-47"></A>Messages <A NAME="MARKER-2-48"></A>to Other Players</H2>
 In the course of play, it is normal to send messages to other players. In <A HREF="#MARKER-9-49">Listing 4-13</A>, you see an example of sending a message to everyone but yourself.<P>
<B>Listing 4-13  <A NAME="MARKER-9-49"></A>Sending a message to all players</B><P>
<PRE>
   PlayerLocationMessagemessage;
   
   NSpClearMessageHeader(&amp;message.header);
   
   message.header.what = kPlayerLocation;
   message.header.to = kNSpAllPlayers;
   
   message.header.messageLen = sizeof(PlayerLocationMessage);
   message.where = where;
      
   NSpMessage_Send(gMyGame, &amp;message.header, kNSpSendFlag_Normal | 
kNSpSendFlag_SelfSend);
</PRE>
<A NAME="HEADING231-68"></A>
<H2><A NAME="MARKER-2-50"></A>Ending The Game<A NAME="MARKER-2-51"></A></H2>
 When it is time to end the game, you simply call the NSpGame_Dispose function, as shown in <A HREF="#MARKER-9-52">Listing 4-14</A>. If you specify the <CODE>kNSpGameFlag_ForceTerminateGame</CODE> flag when you call NSpGame_Dispose, the other players will be notified that the game is over, and it will be disposed. If you don't pass this flag, and you're the host, NetSprocket will attempt to negotiate a new host. If a new host cannot be found, the function will return an error and you should call it with the <CODE>kNSpGameFlag_ForceTerminateGame</CODE> flag if you want to force it to quit. If you're a client, the <CODE>kNSpGameFlag_ForceTerminateGame</CODE> is ignored<P>
<B>Listing 4-14  <A NAME="MARKER-9-52"></A>Terminating the game</B><P>
<PRE>
      NSpGame_Dispose(gMyGame, kNSpGameFlag_ForceTerminateGame);
</PRE>
 }<A NAME="MARKER-2-53"></A><P>
</BLOCKQUOTE>
<HR>
<CENTER>
<A HREF="GameSprockets-230.html"><IMG ALIGN="BOTTOM" SRC="prev.gif" BORDER="none" HSPACE="20" ALT="Previous"></A> <A HREF="GameSprockets-2.html"><IMG ALIGN="BOTTOM" SRC="content.gif" BORDER="none" HSPACE="20" ALT="Book Contents"></A> <A HREF="GameSprockets-318.html"><IMG ALIGN="BOTTOM" SRC="index.gif" BORDER="none" HSPACE="20" ALT="Book Index"></A> <A HREF="GameSprockets-232.html"><IMG ALIGN="BOTTOM" SRC="next.gif" BORDER="none" HSPACE="20" ALT="Next"></A> </CENTER><P>
<CENTER><FONT SIZE="-1"><A HREF="GameSprockets-3.html">&copy; Apple Computer, Inc.</A><BR>2 JUL 1996</CENTER></FONT><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML> 
