<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Writing a Desk Accessory(IM: D)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING16></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->




<!-- Main Body -->

<CENTER>
<P>
<A HREF="Devices-15.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Devices-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Devices-328.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Devices-17.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Devices-2.html"><B>Devices</B></A> / <BR><DD><A HREF="Devices-10.html"><B>Chapter 1 - Device Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING16-0></A>
<H1><A NAME=MARKER-9-199></A>Writing a Desk Accessory</H1>
 <A NAME=MARKER-2-142></A>Desk accessories are small applications designed like device drivers. Desk accessories typically provide a user interface with a window and a menu, perform some limited function, and are opened from the Apple menu. The Chooser is an example of a desk accessory.<P>
 Desk accessories were originally created for the Macintosh because they offered two distinct advantages over applications. They provided both a limited degree of multitasking and a primitive form of interapplication communication. However, modern Macintosh applications enjoy far more sophisticated versions of these capabilities. Users can even open applications from the Apple menu. For these reasons, you would be better served by writing a small application than by writing a desk accessory. <P>
 Control panels have largely replaced desk accessories as a user interface for device drivers. In addition to providing a more consistent and extensible interface, control panels can include an initialization (<CODE>'INIT'</CODE>) resource to load and execute your device driver at system startup. For more information about control panels, see the chapter "Control Panels" in <I><A HREF="../MoreToolbox/MoreToolbox-2.html">Inside Macintosh: More Macintosh Toolbox</A></I>.<P>
 If you're certain you need to write a desk accessory, you should read this section. You might also want to read the chapters "Event Manager," "Window Manager," "Dialog Manager," and "Menu Manager" in <I><A HREF ="../Toolbox/Toolbox-2.html">Inside Macintosh: Macintosh Toolbox Essentials</A></I>.<P>
<A NAME=HEADING16-5></A>
<H2>How Desk Accessories Work</H2>
 <A NAME=MARKER-2-249></A><A NAME=MARKER-2-143></A>When the user opens a desk accessory (or when an application calls the <CODE>OpenDeskAcc</CODE> function), the system performs a major context switch, loads the desk accessory into the system heap, and calls the desk accessory driver open routine. The desk accessory can respond by creating its window and menu. <P>
 When events occur, the Event Manager directs them to the desk accessory by calling its driver control routine. The Event Manager handles switching between applications and desk accessories in the system heap.<P>
 <A NAME=MARKER-2-144></A>When the user closes the desk accessory (by closing its window or choosing Quit from its menu) or an application closes the desk accessory (by calling the <CODE>CloseDeskAcc</CODE> function), the desk accessory disposes of its window and any other data structures associated with it.<P>
 In a single-application environment in System 6, and in a multiple-application environment in which the desk accessory is launched in the application's partition (for example, a desk accessory opened by the user from the Apple menu while holding down the Option key), the Event Manager handles events for desk accessories in a slightly different manner, although it still translates them into control requests. For details, see the chapter "Event Manager" in <I><A HREF="../Toolbox/Toolbox-2.html">Inside Macintosh: Macintosh Toolbox Essentials</A></I>.<P>
<A NAME=HEADING16-10></A>
<H2><A NAME=MARKER-2-155></A>Creating a Driver Resource for a Desk Accessory</H2>
 You create a desk accessory by creating a driver resource and storing it in a resource file, as described in <A HREF=Devices-14.html#MARKER-9-116>"Creating a Driver Resource," beginning on page 1-24</A>. Typically, you store your desk accessory driver resource in a file of type <CODE>'dfil'</CODE>, which the user places in the Apple Menu Items folder. <P>
 Three fields of the driver resource header are of particular importance to desk accessories:<P>
<UL>
<LI><A NAME=MARKER-2-145></A>The <CODE>drvrEMask</CODE> field. This field contains an event mask specifying which events your desk accessory can handle. If your desk accessory has a window, you should include keyboard, activate, update, and mouse-down events, but you should not include mouse-up events. When an event occurs, the Event Manager checks this field to determine whether the desk accessory can handle the type of event and, if so, calls the desk accessory driver control routine. See the chapter "Event Manager" in <I><A HREF="../Toolbox/Toolbox-2.html">Inside Macintosh: Macintosh Toolbox Essentials</A></I> for more information about events and event masks.
<LI><A NAME=MARKER-2-146></A>The <CODE>drvrMenu</CODE> field. This field contains the menu ID of your desk accessory's menu, if it has one, or any one of its menus, if it has more than one. Otherwise, it contains 0. A desk accessory menu ID must be negative and must be different from the menu ID for other desk accessories.
<LI>The <A NAME=MARKER-2-147></A><CODE>drvrDelay</CODE> field and the <CODE>dNeedTime</CODE> flag of the <CODE>drvrFlags</CODE> field. Desk accessories sometimes need to perform certain actions periodically. For example, a clock desk accessory might change the time it displays every second. If your desk accessory needs to perform a periodic action, set the <CODE>dNeedTime</CODE> flag and use the <CODE>drvrDelay</CODE> field to indicate how often the action should occur. <A HREF=Devices-14.html#MARKER-9-116>"Creating a Driver Resource," beginning on page 1-24</A>, describes these fields in more detail.<P>
</UL>
 All desk accessories must implement open, close, and control routines. Your desk accessory can implement a prime and status routine if needed.<P>
<A NAME=HEADING16-17></A>
<H2>Opening and Closing a Desk Accessory</H2>
 <A NAME=MARKER-2-148></A>When the user chooses an item from the Apple menu, the foreground application calls the <CODE>OpenDeskAcc</CODE> function, which determines whether the item is a desk accessory, application, or document, and schedules it for execution. Applications call the <CODE>CloseDeskAcc</CODE> function if the user chooses the Close menu item from the File menu when the foreground window does not belong to the application. These functions are described in <A HREF=Devices-17.html#MARKER-9-216>"Device Manager Reference," beginning on page 1-53</A>.<P>
 Opening a desk accessory is similar to launching an application. In your desk accessory driver open routine, you should do the following:<P>
<UL>
<LI>Create the desk accessory's window. You can do this with the Dialog Manager function <CODE>GetNewDialog</CODE> or <CODE>NewDialog</CODE>. You should specify that the window be invisible because the <CODE>OpenDeskAcc</CODE> function will display it. You should set the <CODE>windowKind</CODE> field of the <CODE>windowRecord</CODE> structure to the desk accessory's driver reference number, which you can find in the device control entry. You should also store a copy of the window pointer in the <CODE>dCtlWindow</CODE> field of the device control entry.<A NAME=MARKER-2-149></A><A NAME=MARKER-2-194></A>
<LI>Allocate private storage as you would for any device driver.
<LI>Create any menus needed by your desk accessory. You are responsible for adding your menus to the menu bar. See the chapter "Menu Manager" in <I><A HREF="../Toolbox/Toolbox-2.html">Inside Macintosh: Macintosh Toolbox Essentials</A></I> for more details.<P>
</UL>
 If your driver open routine is unable to complete its tasks (because of insufficient memory, for example), you should modify the code so it doesn't respond to events, and display an alert indicating failure.<P>
 As for all drivers, your close routine should undo the actions taken by the open routine, dispose of the desk accessory's window and private storage, clear the window pointer in the device control entry, and remove any menus that were added to the menu bar.<P>
<A NAME=HEADING16-25></A>
<H2><A NAME=MARKER-9-213></A>Responding to Events</H2>
 When the Event Manager determines an event has occurred that your desk accessory should handle, it checks the <CODE>drvrEMask</CODE> field of the driver header and, if that field indicates your desk accessory handles the event type, it passes the event to your desk accessory by calling your driver control routine.<P>
 The Event Manager passes one of nine values in the <CODE>csCode</CODE> field to indicate the action to take:
<TABLE BORDER="0" CELLPADDING=3><TH ALIGN=LEFT>Constant name<TH>Value<TH>Meaning<TR>
<TD>accEvent<TD>64<TD>Handle a given event<TR>
<TD>accRun<TD>65<TD>Time for periodic action<TR>
<TD>accCursor<TD>66<TD>Change cursor shape if appropriate<TR>
<TD>accMenu<TD>67<TD>Handle a given menu item<TR>
<TD>accUndo<TD>68<TD>Handle the Undo command<TR>
<TD>accCut<TD>70<TD>Handle the Cut command<TR>
<TD>accCopy<TD>71<TD>Handle the Copy command<TR>
<TD>accPaste<TD>72<TD>Handle the Paste command<TR>
<TD>accClear<TD>73<TD>Handle the Clear command</TABLE>
<P>
 Along with the <CODE>accEvent</CODE> message, the Event Manager sends a pointer to an event record in the <CODE>csParam</CODE> field. Your desk accessory can respond to the event in whatever way is appropriate. For example, when your desk accessory becomes active, it might install its menu in the menu bar. <P>
<DL>
<DT><B>Note</B>
<DD>If your desk accessory window is a modeless dialog box and you are calling the Dialog Manager function <CODE>IsDialogEvent</CODE> in response to the event, you should set the <CODE>windowKind</CODE> field of your window record to 2 before you call <CODE>IsDialogEvent</CODE>. Setting this field to 2 allows the Dialog Manager to recognize and handle the event properly. You should restore the original value of the <CODE>windowKind</CODE> field before returning from your control routine.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 The Event Manager periodically sends the <CODE>accRun</CODE> message if your desk accessory has requested time for background processing. To request this service, you set the <A NAME=MARKER-2-137></A><CODE>dNeedTime</CODE> flag in the <CODE>drvrFlags</CODE> field of your desk accessory driver header. See <A HREF=Devices-14.html#MARKER-9-160>"Writing Control and Status Routines," beginning on page 1-34</A>, for more information.<P>
 The <CODE>accCursor</CODE> message makes it possible to change the shape of the cursor when it is inside your desk accessory window and your desk accessory window is active. Your control routine should check whether the mouse location is in your window and, if so, should set the cursor appropriately by calling the QuickDraw function <CODE>InitCursor</CODE>. <P>
 If your desk accessory window is a dialog box, you should respond to the <CODE>accCursor</CODE> message by generating a null event (storing the event code for a null event in an event record) and passing it to the Dialog Manager function <CODE>DialogSelect</CODE>. This allows the Dialog Manager to blink the insertion point in <CODE>editText</CODE> items. <P>
 When the Event Manager sends an <CODE>accMenu</CODE> message, it provides the menu ID followed by the menu item number in the <CODE>csParam</CODE> field. You should take the appropriate action and then call the Menu Manager function <CODE>HiliteMenu</CODE> with a value of 0 for the <CODE>menuID</CODE> parameter to remove the highlighting from the menu bar.<P>
 You should respond to the last five messages, <CODE>accUndo</CODE> through <CODE>accClear</CODE>, by processing the corresponding editing command in the desk accessory window, if appropriate. The chapter "Scrap Manager" in <I><A HREF="../MoreToolbox/MoreToolbox-2.html">Inside Macintosh: More Macintosh Toolbox</A></I> contains information about cutting and pasting.<P>
 Your desk accessory routines should restore the current resource file and graphics port if it changes either one.<A NAME=MARKER-9-373></A><P>
<HR>
<B>Subtopics</B>
<B><!-- TOC --><DL>
<DT><A HREF="Devices-16.html#HEADING16-5">How Desk Accessories Work</A>
<DD>
<DT><A HREF="Devices-16.html#HEADING16-10">Creating a Driver Resource for a Desk Accessory</A>
<DD>
<DT><A HREF="Devices-16.html#HEADING16-17">Opening and Closing a Desk Accessory</A>
<DD>
<DT><A HREF="Devices-16.html#HEADING16-25">Responding to Events</A>
<DD>
</DL>
</B>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Devices-15.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Devices-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Devices-328.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Devices-17.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Devices-3.html">&copy; Apple Computer, Inc.</A><br>3 JUL 1996</center></font><P>
<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->
</BODY>
</HTML>  
