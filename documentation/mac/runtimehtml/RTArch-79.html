<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Classic 68K Code Originates the Call</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING79></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="RTArch-78.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="RTArch-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="RTArch-147.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="RTArch-80.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="RTArch-2.html"><B>Mac OS Runtime Architectures</B></A> / <BR><DD><A HREF="RTArch-75.html"><B>Chapter 6 - The Mixed Mode Manager</B></A> / <A HREF="RTArch-77.html"><B>Universal Procedure Pointers and Routine Descriptors </B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING79-0></A>
<H2>Classic 68K Code Originates the Call</H2>
 If classic 68K code initiates the call, then the calling routine is not required to take any action; it is never even aware that a mode switch might be necessary. <P>
 The calling routine must always pass a universal procedure pointer. If the called routine is also classic 68K code, the universal procedure pointer is simply a classic 68K pointer (that is, a pointer to the called routine). The Mixed Mode Manager is never invoked, and the call proceeds normally. <P>
 <A NAME=MARKER-2-24></A>If the called routine is CFM-based code, the universal procedure pointer cannot be a classic 68K pointer; it must therefore be a pointer to a routine descriptor. The classic 68K caller is not required to change, so the supplier of the CFM-based routine must provide the routine descriptor.<P>
<DL>
<DT><B>Note</B>
<DD>The routine descriptor is not part of the called routine. Rather, it is a shell or wrapper through which all external calls to the routine must pass.<EM></EM><EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
 The first instruction in the routine descriptor is an A-line instruction that invokes the Mixed Mode Manager. The Mixed Mode Manager handles the mode switch using the information stored in the routine descriptor and then calls the transition vector of the CFM-based code. <A HREF=#MARKER-9-25>Figure 6-1</A> shows the calling path from the classic 68K code to the CFM-based code.<P>
<B>Figure 6-1  <A NAME=MARKER-9-25></A>Calling path from classic 68K code to a CFM-based routine</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/RUN-70.jpg"> <P>
 After the call any return values are passed back to the classic 68K caller.<P>
 In order to satisfy the agreement to always pass universal procedure pointers, you must create routine descriptors for any CFM-based routines that may be called by classic 68K code. For example, if you supply a callback routine, you must take additional steps to anticipate a possible mode switch when the callback occurs. A classic 68K runtime function call such as <P>
<PRE>
AEInstallEventHandler (kCoreEventClass, kAEOpenApplication,
                     HandleOapp,0,false);
</PRE>
 must be changed to <P>
<PRE>
UniversalProcPtr myHandleOappProc;
myHandleOappProc = NewAEEventHandlerProc (HandleOapp);
AEInstallEventHandler (kCoreEventClass,kAEOpenApplication,
                     myHandleOappProc,0,false)
</PRE>
 The <CODE>NewAEEventHandlerProc</CODE> macro (defined in <CODE>AppleEvents.h</CODE>) calls the Mixed Mode Manager's <CODE>NewRoutineDescriptor</CODE> function to create a routine descriptor for <CODE>HandleOapp</CODE>.<P>
<DL>
<DT><B>Note</B>
<DD>In certain cases where you cannot modify the CFM-based code (if it is a third-party library whose source code is unavailable, for example), it is possible to construct routine descriptors in your classic 68K code.<EM></EM><EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="RTArch-78.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="RTArch-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="RTArch-147.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="RTArch-80.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="RTArch-3.html">&copy; Apple Computer, Inc.</A><br>11 MARCH 1997<P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML> 
