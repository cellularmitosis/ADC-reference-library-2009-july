<HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><script language="JavaScript" src="frametest.js"></script><TITLE> Driver Loading</TITLE></HEAD><BODY BGCOLOR="#ffffff"><DIV><a name="top"></a><!-- start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!-- start of path --><font face="Geneva,Helvetica,Arial" size="1"><b><br>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Documentation</a> &gt; <!-- a href="" target="_top" -->Hardware<!-- /a -->  <b>&gt; </b><a href="../../devicemgrs.html" target="_top">Device Managers and Drivers</a> <b>&gt; </b><a href="../pci_srvcs.html" target="_top">PCI Card Services</a> <b>&gt; </b>Designing PCI Cards and Drivers for Power Macintosh Computers</font><br><br><!-- end of path --><A HREF="PCI_BOOK.21d.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.21e.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.220.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><HR></DIV><H1 CLASS="H2.Heading2"><A NAME="pgfId=3372"> </A>Driver Loading</H1><P CLASS="T1.Text1"><A NAME="pgfId=3373"> </A>When a service requires the use of your driver, Open Transport will automatically load it and install it into the STREAMS module tables. In order to do this, your module must export a function named either <TT CLASS="cv">GetOTInstallInfo</TT> or <TT CLASS="cv">GetOT</TT><I CLASS="italics">xxxxx</I><TT CLASS="cv">InstallInfo</TT> (where <I CLASS="italics">xxxxx</I> is the name of the module or driver).</P><CODE CLASS="RD.RoutineDeclare"><A NAME="pgfId=14318"> </A>install_info* GetOTInstallInfo(void);</CODE><P CLASS="T1.Text1"><A NAME="pgfId=3376"> </A><A NAME="marker=14320"> </A>This function returns the installation information that Open Transport needs to install the driver into the STREAMS tables, using the following data structure:</P><CODE CLASS="Cv.Code"><A NAME="pgfId=14324"> </A>structure install_info<BR>{<BR>structure streamtab*&nbsp;&nbsp;&nbsp;&nbsp;install_str;<BR>UInt32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;install_flags;<BR>UInt32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;install_sqlvl;<BR>char*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;install_buddy;<BR>void*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ref_load;<BR>UInt32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ref_count;<BR>};</CODE><DL COMPACT><DT CLASS="DT.DefinitionTerm"><A NAME="pgfId=14326"> </A><TT CLASS="cv">install_str</TT></DT><DD CLASS="DD.DefinitionDef"><A NAME="pgfId=3378"> </A>This is a pointer to the driver's streamtab structure.</DD><DT CLASS="DT.DefinitionTerm"><A NAME="pgfId=14335"> </A><TT CLASS="cv">install_flags</TT></DT><DD CLASS="DD.DefinitionDef"><A NAME="pgfId=3379"> </A>This contains flags to inform Open Transport of your driver's STREAMS module type. The <TT CLASS="cv">install_flags</TT> should be set to <TT CLASS="cv">kOTModIsDriver</TT> | <TT CLASS="cv">kOTModIsPortDriver</TT> for STREAMS port drivers.</DD><DT CLASS="DT.DefinitionTerm"><A NAME="pgfId=14344"> </A><TT CLASS="cv">install_sqlvl</TT></DT><DD CLASS="DD.DefinitionDef"><A NAME="pgfId=3380"> </A>This flag is set to the type of reentrancy your driver can handle. Possible values are the following:</DD><TABLE border=1 cellpadding=3><TR><TD ROWSPAN="1" COLSPAN="1"><CODE CLASS="TbCv.TblCode"><A NAME="pgfId=4179"> </A><TT CLASS="cv">SQLVL_QUEUE</TT></CODE></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4181"> </A>The driver can be entered once from the upper queue and once from the lower queue at the same time.</FONT></TD></TR><TR><TD ROWSPAN="1" COLSPAN="1"><CODE CLASS="TbCv.TblCode"><A NAME="pgfId=4183"> </A><TT CLASS="cv">SQLVL_QUEUEPAIR</TT></CODE></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4185"> </A>The driver can be entered from either the upper queue or the lower queue, but not at the same time.</FONT></TD></TR><TR><TD ROWSPAN="1" COLSPAN="1"><CODE CLASS="TbCv.TblCode"><A NAME="pgfId=4187"> </A><TT CLASS="cv">SQLVL_MODULE</TT></CODE></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4189"> </A>The driver can be entered only once per port, regardless of which instance of the module is entered.</FONT></TD></TR><TR><TD ROWSPAN="1" COLSPAN="1"><CODE CLASS="TbCv.TblCode"><A NAME="pgfId=4191"> </A><TT CLASS="cv">SQLVL_GLOBAL</TT></CODE></TD><TD ROWSPAN="1" COLSPAN="1"><FONT CLASS="TbT.TblText"><A NAME="pgfId=4193"> </A>Among all modules that use <TT CLASS="cv">SQLVL_GLOBAL</TT> only one will be entered at a time.</FONT></TD></TR></TABLE><DT CLASS="DT.DefinitionTerm"><A NAME="pgfId=14353"> </A><TT CLASS="cv">install_buddy</TT></DT><DD CLASS="DD.DefinitionDef"><A NAME="pgfId=3406"> </A>This field is currently not support by Open Transport. It should be set to <TT CLASS="cv">NULL</TT>.</DD><DT CLASS="DT.DefinitionTerm"><A NAME="pgfId=14362"> </A><TT CLASS="cv">ref_load</TT></DT><DD CLASS="DD.DefinitionDef"><A NAME="pgfId=3407"> </A>This field keeps a load reference to the driver. It should be initialized to 0 and then never touched.</DD><DT CLASS="DT.DefinitionTerm"><A NAME="pgfId=14371"> </A><TT CLASS="cv">ref_count</TT></DT><DD CLASS="DD.DefinitionDef"><A NAME="pgfId=3408"> </A>This field monitors when a driver is first loaded and last unloaded. It should be initialized to 0 and then never touched. </DD></DL COMPACT><P CLASS="T1.Text1"><A NAME="pgfId=3409"> </A>Whenever Open Transport loads your module or driver, and the <TT CLASS="cv">ref_count</TT> field of the <TT CLASS="cv">install_info</TT> structure is 0, Open Transport will call an optional initialization function exported by the module. This function must be named either <TT CLASS="cv">InitStreamModule</TT> or <TT CLASS="cv">Init</TT><I CLASS="italics">xxxxx</I><TT CLASS="cv">StreamModule</TT> (where <I CLASS="italics">xxxxx</I> is the name of the module or driver).</P><CODE CLASS="Cv.Code"><A NAME="pgfId=14382"> </A>&nbsp;&nbsp;&nbsp;&nbsp;Boolean InitStreamModule (void* systemDependent);</CODE><P CLASS="T1.Text1"><A NAME="pgfId=3412"> </A><A NAME="marker=14384"> </A>If <TT CLASS="cv">InitStreamModule</TT> returns <TT CLASS="cv">false</TT> to Open Transport, then the loading of the module will be aborted and an <TT CLASS="cv">ENXIO</TT> error will be returned to the client. Otherwise, the module will be loaded and installed into a stream.</P><P CLASS="T1.Text1"><A NAME="pgfId=3413"> </A>The <TT CLASS="cv">systemDependent</TT> parameter is a pointer to the <TT CLASS="cv">cookie</TT> value used when registering the port. For drivers loaded using the System registry, its value is <TT CLASS="cv">RegEntryIDPtr</TT>.</P><P CLASS="T1.Text1"><A NAME="pgfId=3414"> </A>If the PCI device supports changing power levels, the <TT CLASS="cv">InitStreamModule</TT> function should set the power level for normal operation.</P><P CLASS="T1.Text1"><A NAME="pgfId=3415"> </A>Whenever Open Transport removes the last instance of a module or driver from the system, it calls an optional termination function exported by the module. This function must be named either <TT CLASS="cv">TerminateStreamModule</TT> or <TT CLASS="cv">Terminate</TT><I CLASS="italics">xxxxx</I><TT CLASS="cv">StreamModule</TT> (where <I CLASS="italics">xxxxx</I> is the name of the module or driver).</P><CODE CLASS="Cv.Code"><A NAME="pgfId=14388"> </A>&nbsp;&nbsp;&nbsp;&nbsp;void TerminateStreamModule (void);</CODE><P CLASS="T1.Text1"><A NAME="pgfId=3418"> </A><A NAME="marker=14390"> </A>If the PCI device supports changing power levels, the <TT CLASS="cv">TerminateStreamModule</TT> function should set the power level to low power or no power, as appropriate.</P><P CLASS="T1.Text1"><A NAME="pgfId=3419"> </A>Of course, modules and drivers may also use the initialization and termination features of their DLL technology. Both CFM and ASLM allow initialization and termination routines. However, only a call to <TT CLASS="cv">InitStreamModule</TT> implies that the module is about to be loaded into a stream. Open Transport often loads a module just to call the <TT CLASS="cv">GetOTInstallInfo</TT> information.</P><P CLASS="T1.Text1"><A NAME="pgfId=3420"> </A>All memory allocations that do not use the Open Transport allocation routines (<TT CLASS="cv">OTAllocMem</TT> and <TT CLASS="cv">OTFreeMem</TT>) or any interrupt-safe allocators supplied by the interrupt subsystem must be performed from within the initialization and termination routines--that is, <TT CLASS="cv">PoolAllocateResident</TT> and <TT CLASS="cv">PoolDeallocate</TT> may be called only from them.</P><P CLASS="T1.Text1"><A NAME="pgfId=3421"> </A>Once your port driver has been loaded, all communication with it will be through STREAMS messages and the entry points in the <TT CLASS="cv">streamtab</TT>.</P><DIV><blockquote><p CLASS="NoteHead"><b><A NAME="pgfId=14392"> </A>Note</b></p><P CLASS="Note"><A NAME="pgfId=3422"> </A>Native drivers usually require a <TT CLASS="cv">DoDriverIO</TT> export. Drivers that only support Open Transport do not need this export, and all references to it in the driver documentation may be safely ignored. </P></blockquote></DIV><HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 26 March 99)<P><A HREF="PCI_BOOK.21d.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.21e.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.220.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>