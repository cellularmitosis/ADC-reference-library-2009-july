<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Matching Colors Using the Low-Level Functions</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING68></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->




<!-- Main Body -->

<CENTER>
<P>
<A HREF="ACI-67.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="ACI-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="ACI-122.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="ACI-69.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="ACI-2.html"><B>Advanced Color Imaging on the Mac OS</B></A> / <BR><DD><A HREF="ACI-55.html"><B>Chapter 4 - Developing ColorSync-Supportive Applications</B></A> / <A HREF="ACI-60.html"><B>Developing Your ColorSync-Supportive Application</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING68-0></A>
<H2><A NAME=MARKER-9-83></A>Matching Colors Using the Low-Level Functions</H2>
 Using the low-level <A NAME=MARKER-11-84></A><CODE>CWMatchPixMap</CODE> or <A NAME=MARKER-11-85></A><CODE>CWMatchBitmap</CODE> ColorSync Manager function, your application can match the colors of a pixel image or a bitmap image to the display's color gamut and display the image without relying on QuickDraw. <P>
 Color matching occurs relatively quickly, but for a session involving a large pixel image or bitmap image, the color-matching process may take some time. To keep your user informed, you can provide a progress-reporting function. For example, your function can display an indicator, such as a thermometer, to depict how much of the matching has been done and how much remains. Your function can also allow the user to interrupt the color-matching process. <P>
 When your application calls either the <CODE>CWMatchPixMap</CODE> function or the <CODE>CWMatchBitmap</CODE> function, you can pass the function a pointer to your callback progress-reporting function and a reference constant containing data, such as the thermometer dialog box's window reference. When the CMM used to match the colors calls your progress-reporting function, it passes the reference constant to it. If you provide a progress-reporting function, here is how you should declare the function if you were to name it <CODE>MyCMBitmapCallBackProc:</CODE><P>
<PRE>
pascal Boolean MyCMBitmapCallBackProc (long progress, void *refCon);
</PRE>
 For a complete description of the progress-reporting function declaration, see MyCMBitmapCallBackProc <A HREF=#nonexistent-marker>(page 3-170)</A> in <I>Advanced Color Imaging Reference</I>. <P>
 To use the <CODE>CWMatchPixMap</CODE> and <CODE>CWMatchBitmap</CODE> functions, your application must first set up a color world that specifies the profiles involved in the color-matching session. The color world establishes how matching will take place between the profiles. For information on how to create a color world, see <A HREF=ACI-67.html#MARKER-9-74>"Creating a Color World for Color Matching and Checking Using the Low-Level Functions" (page 4-25)</A>. <A HREF=#MARKER-9-90>Listing 4-5</A> shows how to match the colors of a pixel map or a bitmap using the ColorSync Manager low-level functions that take a color world. <P>
 The ColorSync Manager uses the <CODE>PixMap</CODE> data type defined by Color QuickDraw. The ColorSync Manager defines and uses the <CODE>cmBitmap</CODE> data type, based on the classic QuickDraw <CODE>Bitmap</CODE> data type.<P>
<A NAME=HEADING68-8></A>
<H3><A NAME=MARKER-9-86></A>Matching the Colors of a Pixel Map to the Display's Color Gamut</H3>
 Your application can call the <CODE>CWMatchPixMap</CODE> function to match the colors of a pixel <A NAME=MARKER-2-87></A>image to the display's color gamut using a color world that you have previously created. The color world must be based on the source profile for the device used to create the pixel image and the system profile for the system's display. <P>
 To match the colors of a pixel image to the display's color gamut, the source profile for the color world must specify a data color space of RGB as its <CODE>dataColorSpace</CODE> element value to correspond to the pixel map data type, which is implicitly RGB. If the source profile you specify for the color world is the original source profile used to create the pixel image, most likely these values match. However, if you want to verify that the source profile's <CODE>dataColorSpace</CODE> element specifies RGB, you can use the <CODE>CMGetProfileHeader</CODE> function to obtain the profile header. The profile header contains the <CODE>dataColorSpace</CODE> element field. For a pixel image, the display profile's <CODE>dataColorSpace</CODE> element must also be set to RGB; this is the color space commonly used for displays. <P>
 If the source profile is embedded in the document containing the pixel map, your application can extract the profile and open a reference to it before you create the color world. For information on how to extract an embedded profile, see <A HREF=ACI-70.html#MARKER-9-108>"Extracting Profiles Embedded in Pictures" (page 4-37)</A>. If the source profile is installed in the ColorSync(TM) Profiles folder, your application can display a list of profiles to the user to allow the user to select the appropriate one. <P>
 <A HREF=#MARKER-9-90>Listing 4-5</A> shows how to set up a color world for color matching of either a pixel map or a bitmap. After setting up the color world, the <CODE>MyMatchImage</CODE> function calls the <CODE>CWMatchPixMap</CODE> function to match the pixel map in place.<P>
<A NAME=HEADING68-13></A>
<H3>Matching the Colors of a Bitmap Image to the Display's Color Gamut</H3>
 Matching <A NAME=MARKER-2-88></A>the colors of a bitmap image to the current system's display is similar to the process of matching a pixel map's colors, except that the data type of a bitmap image is explicitly stated in the <CODE>space</CODE> field of the bitmap. You can specify a bitmap image using any of the following data types: <CODE>cmGraySpace</CODE>, <CODE>cmGrayASpace</CODE>, <CODE>cmRGB16Space</CODE>, cmRGB24Space, <CODE>cmRGB32Space</CODE>, <CODE>cmARGB32Space</CODE>, <CODE>cmCMYK32Space</CODE>, <CODE>cmHSV32Space</CODE>, <CODE>cmHLS32Space</CODE>, <CODE>cmYXY32Space</CODE>, <CODE>cmXYZ32Space</CODE>, <CODE>cmLUV32Space</CODE>, <CODE>cmLAB24Space</CODE>, <CODE>cmLAB32Space</CODE>, cmNamedIndexed32Space, cmMCFive8Space, cmMCSix8Space, cmMCSeven8Space, or cmMCEight8Space. The data type of the source bitmap image must correspond to the data color space specified by the color world's source profile. <P>
 When you call the <CODE>CWMatchBitmap</CODE> function, you can pass it a pointer to a bitmap to hold the resulting image. In this case, you must allocate the pixel buffer pointed to by the <CODE>image</CODE> field of the <CODE>CMBitmap</CODE> structure. Because the <CODE>CWMatchBitmap</CODE> function allows you to specify a separate bitmap to hold the resulting color-matched image, you must ensure that the data type you specify in the <CODE>space</CODE> field of the resulting bitmap matches the destination's color data space. On input, the color space of the source profile must match the color space of the bitmap. On successful output, ColorSync will change the <CODE>space</CODE> field of the bitmap based on the color space of the destination profile.<P>
 Rather than create a bitmap for the color-matched image, you can match the bitmap in place. To do so, you specify <CODE>NULL</CODE> instead of passing a pointer to a resulting bitmap.<P>
 The latter portion of the <A NAME=MARKER-2-89></A>code in <A HREF=#MARKER-9-90>Listing 4-5</A> shows how to set up a bitmap for the resulting color-matched image before calling the <CODE>CWMatchBitmap</CODE> function to perform the color matching. The <CODE>MyMatchImage</CODE> function, depicted in this sample listing, uses the profile of the device that produced the image as the source profile and the system profile as the destination profile. <P>
<B>Listing 4-5  <A NAME=MARKER-9-90></A>Matching the colors of a pixel map or a bitmap using a color world</B><P>
<PRE>
void MyMatchImage (void)
{
   CMError     cmErr;
   CMProfileRefsourceProf;
   CMProfileRefsysProf;
   CMWorldRef  cw;
   CMBitmap    bitmap;
   /* set up a color world */
   cmErr = MyGetImageSourceProfile(&amp;sourceProf);
   if (cmErr == noErr)
   {
      cmErr = CMGetSystemProfile(&amp;sysProf);
   }

   if (cmErr == noErr)
   {
      cmErr = NCWNewColorWorld(&amp;cw, sourceProf, sysProf);

      /* close profiles after setting up color world */
      (void) CMCloseProfile(sourceProf);
      (void) CMCloseProfile(sysProf);
   }

   /* match pixmap */
   if (cmErr == noErr)
   {
      cmErr = CWMatchPixMap(cw, gpPixMap, (CMBitmapCallBackUPP) NULL, NULL);
   }
   /* match CMBitmap */
   if (cmErr == noErr)
   {
   /* CMBitmaps corresponding to QD 16 &amp; 32 bit/pixel, RGBDirect
      pixmaps are supported by the ColorSync Manager */
      if ((*gpPixMap).pixelType != RGBDirect)
      {
         cmErr = paramErr;
      }
   }
   if (cmErr == noErr)
   {
      /* set local CMBitmap structure so that it describes the 
         pixmap */
      bitmap.image = (*gpPixMap).baseAddr;
      bitmap.width = (*gpPixMap).bounds.right - (*gpPixMap).bounds.left;
      bitmap.height = (*gpPixMap).bounds.bottom - (*gpPixMap).bounds.top;
      /* mask QD rowBytes flag bits */
      bitmap.rowBytes = (*gpPixMap).rowBytes &amp; 0x3ffe;

      switch ((*gpPixMap).pixelSize)
      {
         case 16:
         bitmap.pixelSize = 16;
         bitmap.space = cmRGB16Space;
         break;
         case 32:
         bitmap.pixelSize = 32;
         bitmap.space = cmRGB32Space;
         break;
         default:
         cmErr = paramErr;
         break;
      }
      /* CMBitmap fields not used by the ColorSync Manager */
      bitmap.user1 = 0;
      bitmap.user2 = 0;
   }
   if (cmErr == noErr)
   {
      /* match in place */
      cmErr = CWMatchBitmap(cw, &amp;bitmap, (CMBitmapCallBackUPP) NULL, NULL,
                      (CMBitmap*) NULL);

      /* dispose of the colorworld */
      CWDisposeColorWorld(cw);
   }
}
</PRE>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="ACI-67.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="ACI-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="ACI-122.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="ACI-69.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="ACI-3.html">&copy; Apple Computer, Inc.</A><br>13 NOV 1996<P>
<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->
</BODY>
</HTML> 
