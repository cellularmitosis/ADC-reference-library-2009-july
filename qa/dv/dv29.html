<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!--Template 06-20-02--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Q&amp;A DV29: SCSI ID from vRefNum</title>		<meta name="keywords" content="Mac OS 7/8 SCSI ID vRefNum disk volume.">	<meta name="Description" content="Technical Q&amp;A DV29: Q&amp;A gives 2 ways of identifying the IDof a SCSI disk volume. Q&amp;A then goes through the step bystep process, including code snippets, of identifying a diskvolume."><meta name="categories" content="Devices"><meta name="week-posted" content="May 19, 1997 - May 23, 1997"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10001170" title="SCSI ID from vRefNum"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalqas/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/idxAccessibility-date.html" target="_blank">Hardware & Drivers > Accessibility</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A DV29</div>
<div id="pageheadsub">SCSI ID from vRefNum</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><!-- begin_content --> <CENTER><TABLE BORDER=0 CELLPADDING=0 WIDTH=600><TR> <td align="left"><hr width=500 align=center><p id=p2>Q:I would like to obtain the SCSI-ID of a disk volume where a certain file is located. What is the way to do it?</p><p id=p4>A: I assume you've already thought ahead to the cases where the drive inquestion is not SCSI (e.g., floppy, IDE, RAM disk, etc.)</p><p id=p4>There are two answers to this question, depending upon whether SCSIManager 4.3 is present or not.  If SCSI Manager 4.3 is not present, yourely on the fact that SCSI devices are at a particular place in the unittable.  To summarize <i>Inside Macintosh:Devices</i>, SCSI drivers go in slots32-40 in the unit table in order, so the driver for SCSI 0 is in slot32, SCSI 1 is in slot 1, etc.</P><TABLE BORDER=0 CELLPADDING=5 WIDTH=550> <TR> <td bgcolor="#e6e6e6" align=left><pre>     slot number = -(refnum-1)</pre> </td></tr> </table> <BR> <p id=p4>So the driver for SCSI 0 has refnum -33, SCSI 1 has refnum -34, etc.</P><p id=p4>If SCSI Manager 4.3 is installed, you call the routine<code>SCSILookupRefNumXRef()</code> as documented in <a href="../../documentation/mac/Devices/Devices-185.html">Inside Macintosh:Devices on page 4-52 and 4-53</A>.</p><p id=p4>To detect the presence of SCSI Manager 4.3, check that the trap_SCSIAtomic is unimplemented, as demonstrated in <a href="../../documentation/mac/OSUtilities/OSUtilities-171.html#HEADING171-5">Inside Macintosh:Operating System Utilities on page 8-21 through8-23</A>.  You also want to read the "I Am Curious SCSI" note in theSCSI Samples 1.0 folder on the Tool Chest developer CD</P><p id=p4>Given that you have a volume reference number, you need to obtain thedriver reference number. You get this by calling <code>PBHGetVInfo()</code>,documented in <a href="../../documentation/mac/Files/Files-178.html">Inside Macintosh:Files on page 2-144</A>.</P><TABLE BORDER=0 CELLPADDING=5 WIDTH=550> <TR> <td bgcolor="#e6e6e6" align=left><pre>OSErr   GetDRefNumFromVRefNum(short vRefNum, short *dRefNum){    HParamBlockRec  pb;    Str27           volName;    OSErr           result;    pb.volumeParam.ioVRefNum = vRefNum;    pb.volumeParam.ioNamePtr = volName;    pb.volumeParam.ioVolIndex = 0;  /* use ioVRefNum only,                                        return volume name */    result = PBHGetVInfoSync(&amp;pb);    if (result == noErr)        *dRefNum = pb.volumeParam.ioVDrvInfo;    return result;}</pre> </td></tr> </table> <BR> <p id=p4>Given the driver reference number, use the code below (from "I AmCurious SCSI").</P><TABLE BORDER=0 CELLPADDING=5 WIDTH=550> <TR> <td bgcolor="#e6e6e6" align=left><pre>/* * Get the SCSI Bus ID for a particular driver reference number. This is * valid for the original SCSI Manager. Under the asynchronous SCSI Manager, * it is needed if the driver did not register with the SCSI Manager. */#define DriverRefNumToSCSI(x)  ((signed short) (~(x) - 32)) /* * Return the DeviceIdent for a particular driver by searching the list of * registered devices. Return noErr on success, or nsvErr if there is none */OSErrDriverRefNumToDeviceID(        short        driverRefNum,        DeviceIdent  *deviceIdentPtr    ){    OSErr            status, scsiStatus;    SCSI_DriverPB    pb;    short            targetID;    status = nsvErr;    if (AsynchronousSCSIManagerPresent()) {        /*         * Scan the list of registered drivers for         * this driverRefNum.         */        ClearMemory((ptr) &amp;pb, sizeof pb);        pb.scsiPBLength = sizeof (SCSI_Driver_PB);        pb.scsiCompletion = NULL;        pb.scsiFlags = 0;        pb.scsiFunctionCode = SCSILookupRefNumXref;        /* Initialize the DeviceIdent to an         * &quot;impossible&quot; value to start the scan         * process. SCSIAction will return the         * current device in pb.scsiDevice and the         * next registered device in         * pb.scsiNextDevice. The do loop examines         * each registered device in turn. The loop         * exits when the next device is on an         * illegal bus. Note that the test must         * ignore the first value as the current         * bus (pb.scsiDevice.bus ) contains the         * &quot;illegal&quot; designation.         */         *((long *) &amp;pb.scsiDevice) = -1L;         do {            scsiStatus = SCSIAction((SCSI_PB *) &amp;pb);            if (scsiStatus != noErr) {                status = scsiStatus;                break;            }            if (pb.scsiDriver == driverRefNum /* Is this the driver we want? */             &amp;&amp; pb.scsiDevice.bus != 0xFF) {  /* Is this a real bus? */                *deviceIdentPtr = pb.scsiDevice;                status = noErr;                break;            }            pb.scsiDevice = pb.scsiNextDevice;        } while (pb.scsiDevice.bus != 0xFF);    }    if (status == nsvErr) {        /*         * The asynchronous SCSI Manager is missing or the         * driver didn't register with the SCSI Manager.*/        targetID = DriverRefNumToSCSI(driverRefNum);        if (targetID &gt;= 0 &amp;&amp; targetID &lt;= 6) {            deviceIdentPtr-&gt;diReserved = 0;            deviceIdentPtr-&gt;diBus = 0;            deviceIdentPtr-&gt;targetID = targetID;            deviceIdentPtr-&gt;LUN = 0;            status = noErr;        }    }    return (status);}</pre> </td></tr> </table> <BR> </td></tr></table></CENTER><!-- end_content --><!-- begin_date --><H4 ALIGN=center>[May 23 1997]</H4><!-- end_date --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/dv/dv29.html%3Fid%3DDTS10001170-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/dv/dv29.html%3Fid%3DDTS10001170-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/dv/dv29.html%3Fid%3DDTS10001170-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --> <hr width=500 align=center> </BODY> </HTML>