<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-August-01 --><!-- Includes revisions to graphics tags --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="Stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TN2051: Mac OS X QuickDraw Performance</title><meta name="keywords" content="QuickDraw performance Mac OS X double buffer LockPortBits dirty region flush"><meta name="Description" content="Technical Note TN2051: This technote will discuss some ofthe trouble spots inthe Mac OS X windowing system and explainhow to avoid them."><meta name="categories" content="Overview and QuickDraw"><meta name="week-posted" content="Apr 29, 2002 - May 3, 2002"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10003082" title="Mac OS X QuickDraw Performance"></a><A NAME="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/Carbon/index.html">Carbon</a> &gt; <a href="../../technicalnotes/Carbon/idxGraphicsImaging-date.html">Graphics & Imaging</a> &gt; </p><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN2051</div>
<div id="pageheadsub">Mac OS X QuickDraw Performance</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                            <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext">                  <A HREF="#Section1">Avoid triple buffering</A><BR>                  <BR>                  <A HREF="#Section2">Simplify dirty region updates</A><BR>                  <BR>                  <A HREF="#Section4">Don't flush to the screen more often than necessary</A><BR>                  <BR>                                    <A HREF="#Summary">Summary</A><BR>                  <BR>                                <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><p id="introtext">The windowing system on Mac OS X is different from that of previous Mac OS versions in several fundamental ways.  The primary difference where QuickDraw is concerned is that drawing in a window port ends up in the window's back buffer and not on the screen.  This shift and the underlying changes in QuickDraw necessary to make it possible have affected the performance characteristics of QuickDraw drawing code in some new and interesting ways.  This technote will discuss some of the trouble spots and explain how to avoid them.</P><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Feb 13 2003]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content --><A NAME=Section1></A><H2>Avoid triple buffering</H2>         <P>Because drawing occurs in the window back buffer and not directly on the screen, most of the motivation for doing your own double buffering is no longer present.  In the past, it was sometimes necessary to composite your drawing into an offscreen <code>GWorld</code> and then copy it onto the screen in one <code>CopyBits</code> operation in order to avoid flickering and tearing.  With Mac OS X, that extra buffer is not only unnecessary, it will actually degrade performance due to the extra copy required to move content from your offscreen to the window back buffer.  Don't double buffer on Mac OS X.</P><P><A HREF="#top">Back to top</A></P><BR><BR>                           <a name="Section2"></a><H2>Simplify dirty region updates</h2>                  <p>In order for QuickDraw to know which parts of the window back buffer to flush to the screen, every call to QuickDraw needs to record the region it dirties.  When a drawing sequence consists of a number of small items contained within a well-known larger area, it is usually best to dirty the whole region at once rather than having every QuickDraw routine incrementally add to the dirty region.  This way, you short-circuit the dirty region updating code inside each QuickDraw routine.</p><p>Assuming all the small QuickDraw operations are enclosed in a bigger rectangular region (<code>bigRectRegion</code>), calling <code>QDSetDirtyRegion(port, bigRectRegion)</code> before making the first QuickDraw drawing operation dirties the whole rectangle at once, eliminating the need for the smaller QuickDraw calls to update the dirty region.</p><P>Setting the dirty region to a large rectangular region accomplishes two goals.  First, it makes sure that the dirty region is rectangular, which greatly simplifies any subsequent region operations.  Second, the large region encompasses all of the regions dirtied by the individual QuickDraw drawing calls, thus turning their dirty region updates into trivial intersection checks of the regions' bounding rectangles.</p><p>This technique is particularly handy for speeding up the drawing of complex vector graphics.</p><P><A HREF="#top">Back to top</A></P><BR><BR>         <A NAME=Section4></A><H2>Don't flush to the screen more often than necessary</H2>         <P>For most applications, there is no need to flush more than 30 frames per second to obtain smooth animation.  Flushing more often only results in additional CPU overhead and may end up slowing down the desired animation.</p><P>To control when flushing occurs you want to use a time-based strategy aimed at providing 30 fps:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>//  AbsoluteTime and UInt64 are in MacTypes.h//  The AbsoluteDeltaToNanoseconds call is in DriverServices.h//	The U64xyz APIs are in Math64.h//	QDFlushPortBuffer is in QuickDraw.h//	All are included in ApplicationServices.h#include &lt;ApplicationServices/ApplicationServices.h&gt;    /* for about 30 frames/sec */const UInt32 kMinNanosecsBetweenFlushes = 1E9 / 30;static AbsoluteTime sLastFlush = { 0, 0 };void framerateLimitedFlush ( CGrafPtr port ){	AbsoluteTime curTime = UpTime();	Nanoseconds  delta = AbsoluteDeltaToNanoseconds( curTime, sLastFlush );	if ( U64Compare( UnsignedWideToUInt64(delta),          U64SetU(kMinNanosecsBetweenFlushes)) &gt; 0)	{		sLastFlush = curTime;		QDFlushPortBuffer(port, NULL);	}}</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><BR><BR><A NAME=Summary></A><H2>Summary</H2>         <P>Mac OS X introduced some new performance characteristics for QuickDraw drawing, but the information presented here will help developers eliminate their graphics performance bottlenecks.</P>         <P><A HREF="#top">Back to top</A></P>         <BR><BR>                  <A NAME=Downloads></A><H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (36K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tn2051.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR>         <P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn2051.html%3Fid%3DDTS10003082-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn2051.html%3Fid%3DDTS10003082-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn2051.html%3Fid%3DDTS10003082-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>