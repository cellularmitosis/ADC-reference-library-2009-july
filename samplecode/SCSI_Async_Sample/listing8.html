<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>SCSI Async Sample - /Src/GetDevicesToTest.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; <A HREF="javascript:location.replace('index.html');">SCSI Async Sample</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/idxSCSI-date.html" target="_blank">Hardware & Drivers > SCSI</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">SCSI Async Sample</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/Src/GetDevicesToTest.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/Src/AsyncSCSIPresent.c</option>
<option value="listing2.html">/Src/ContinueTesting.c</option>
<option value="listing3.html">/Src/DialogUtilities.c</option>
<option value="listing4.html">/Src/DialogUtilities.h</option>
<option value="listing5.html">/Src/DisplayTestParameters.c</option>
<option value="listing6.html">/Src/DisplayTestResults.c</option>
<option value="listing7.html">/Src/DoSCSISynchronousIO.c</option>
<option value="listing8.html">/Src/GetDevicesToTest.c</option>
<option value="listing9.html">/Src/GetSCSICDBLength.c</option>
<option value="listing10.html">/Src/LogManager.c</option>
<option value="listing11.html">/Src/LogManager.h</option>
<option value="listing12.html">/Src/MicrosecondDelta.c</option>
<option value="listing13.html">/Src/MicrosecondTrap.h</option>
<option value="listing14.html">/Src/MicrosecondTrapPresent.c</option>
<option value="listing15.html">/Src/NewSCSIManagerPresent.c</option>
<option value="listing16.html">/Src/NumericFilter.c</option>
<option value="listing17.html">/Src/scsi.h</option>
<option value="listing18.html">/Src/SCSIAsyncSample.h</option>
<option value="listing19.html">/Src/SCSIAsyncSample.r</option>
<option value="listing20.html">/Src/SCSIAsyncSampleMain.c</option>
<option value="listing21.html">/Src/SCSIBusInquiry.c</option>
<option value="listing22.html">/Src/SCSIDefinitions.h</option>
<option value="listing23.html">/Src/SpinCursor.c</option>
<option value="listing24.html">/Src/StringFormat.c</option>
<option value="listing25.html">/Src/WindowUtilities.c</option></select>
				</p>
				</form>
				<p><strong><a href="SCSI_Async_Sample.zip">Download Sample</a></strong> (&#147;SCSI_Async_Sample.zip&#148;, 105.5K)<BR>
<strong><a href="SCSI_Async_Sample.dmg">Download Sample</a></strong> (&#147;SCSI_Async_Sample.dmg&#148;, 169.7K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*                GetDevicesToTest.c                *//* * GetDevicesToTest.c * Copyright &copy; 93 Apple Computer Inc. All Rights Reserved. * * Run the dialog until the user has had enough. */#include &quot;SCSIAsyncSample.h&quot;#include &quot;DialogUtilities.h&quot;#include &quot;SCSIDefinitions.h&quot;void            SetupDialog(void);void            MakeNewInfoRecord(void);void            RefreshParamBlock(void);void            RefreshDeviceInfo(void);Boolean            CheckInfoRecord(void);void            SaveInfoRecord(void);OSErr            SetupGetSCSIParamBlock(void);OSErr            SetupDeviceInquiry(void);OSErr            SetupReadCapacity(void);void            StoreDeviceString(    unsigned char      *dst,    unsigned char      *src,    short          srcLength  );unsigned long        GetFourBytes(    unsigned char      *src  );/* * These are state flags that are valid only for the current * dialog. */DialogPtr          gDialog;InfoPtr            gCurrentInfoPtr;#define INFO        (*gCurrentInfoPtr)short            gThreadIndex;voidGetDevicesToTest(void){    GrafPtr              savePort;    short              itemHit;    Boolean              needNewInfoRecord;    Boolean              needToRefreshDeviceInfo;    Boolean              needToRefreshParamBlock;    Boolean              needToUpdateDialogValues;        GetPort(&amp;savePort);    gDialog = GetNewDialog(DLOG_Query, NULL, (WindowPtr) -1L);    SetCheckBox(gDialog, kQueryEnableAsync, FALSE);    SetCheckBox(gDialog, kQueryEnableDisconnect, FALSE);    SetDialogValue(gDialog, kQueryTotalRequests, 100);    /*     * For my system: prime the device to point to the CD-Rom     */    SetDialogValue(gDialog, kQueryHostBus, 1);    SetDialogValue(gDialog, kQueryTargetID, 3);    /* */    ShowWindow(gDialog);    SetPort(gDialog);    gThreadIndex = 0;    needNewInfoRecord = TRUE;    InitCursor();    for (;;) {      if (needNewInfoRecord) {        MakeNewInfoRecord();        needNewInfoRecord = FALSE;        needToRefreshParamBlock = TRUE;        needToUpdateDialogValues = TRUE;      }      if (needToRefreshParamBlock) {        RefreshParamBlock();        needToRefreshParamBlock = FALSE;        needToRefreshDeviceInfo = (INFO.pb != NULL);        needToUpdateDialogValues = TRUE;      }      if (needToRefreshDeviceInfo) {        RefreshDeviceInfo();        needToRefreshDeviceInfo = FALSE;        needToUpdateDialogValues = TRUE;      }      if (needToUpdateDialogValues) {        SetupDialog();        needToUpdateDialogValues = FALSE;      }      ModalDialog(NumericFilter, &amp;itemHit);      switch (itemHit) {      case kQueryTest:        if (CheckInfoRecord()) {          SaveInfoRecord();          needNewInfoRecord = TRUE;        }        break;      case kQueryFinished:        if (gCurrentInfoPtr != NULL)          DisposePtr((Ptr) gCurrentInfoPtr);        goto exit;      case kQueryHostBus:        INFO.deviceIdent.bus = GetDialogValue(gDialog, kQueryHostBus);        needToRefreshParamBlock = TRUE;        break;      case kQueryTargetID:        INFO.deviceIdent.targetID = GetDialogValue(gDialog, kQueryTargetID);        needToRefreshDeviceInfo = TRUE;        break;      case kQueryEnableAsync:        SelectCheckBox(gDialog, kQueryEnableAsync, &amp;INFO.enableAsync);        break;      case kQueryEnableDisconnect:        SelectCheckBox(gDialog, kQueryEnableDisconnect, &amp;INFO.enableDisconnect);        break;      case kQueryRandomSeek:        SelectCheckBox(gDialog, kQueryRandomSeek, &amp;INFO.enableRandomSeek);        break;      case kQueryTotalRequests:        INFO.totalTransfers = GetDialogValue(gDialog, kQueryTotalRequests);        break;      case kQueryBlocksPerTransfer:        INFO.transferSizeBlocks = GetDialogValue(gDialog, kQueryBlocksPerTransfer);        break;      case kQueryTimeout:        INFO.completionTimeout = GetDialogValue(gDialog, kQueryTimeout);      default:        break;      }    }exit:  ;    DisposDialog(gDialog);    SetPort(savePort);}/* * MakeNewInfoRecord creates a new, empty, InfoRecord and sets state flags * so that the first call to SetupDialog fills in the information. */voidMakeNewInfoRecord(void){    Str255            work;        gCurrentInfoPtr = (InfoPtr) NewPtrClear(sizeof (InfoRecord));    if (gCurrentInfoPtr == NULL)      FatalError(MemError(), &quot;\pCan't make new InfoRecord&quot;);    ++gThreadIndex;    INFO.threadIndex = gThreadIndex;    INFO.deviceActive = FALSE;    INFO.testCompleted = FALSE;    INFO.completionTimeout = (60L * 15L);      /* 15 seconds      */    /*     * Copy the current dialog parameters into the new info record.     */    INFO.deviceIdent.bus = GetDialogValue(gDialog, kQueryHostBus);    INFO.deviceIdent.targetID = GetDialogValue(gDialog, kQueryTargetID);    INFO.totalTransfers = GetDialogValue(gDialog, kQueryTotalRequests);    INFO.transferSizeBlocks = GetDialogValue(gDialog, kQueryBlocksPerTransfer);    INFO.completionTimeout = GetDialogValue(gDialog, kQueryTimeout);    INFO.enableAsync = GetDialogButton(gDialog, kQueryEnableAsync) == kCheckedButton;    INFO.enableDisconnect = GetDialogButton(gDialog, kQueryEnableDisconnect) == kCheckedButton;    INFO.enableRandomSeek = GetDialogButton(gDialog, kQueryRandomSeek) == kCheckedButton;    GetDateTime(&amp;INFO.randomSeed);    INFO.randomSeed ^= TickCount();    NumToString(INFO.threadIndex, work);    pstrcat(work, &quot;\p Thread index&quot;);    SetDialogText(gDialog, kQueryThreadNumber, work);}/* * SetupDialog is executed each time through the dialog loop to enable and * disable editable items and to get information about the active device. */voidSetupDialog(void){        EnableDialogItem(gDialog, kQueryTest, INFO.validDevice);    EnableDialogItem(gDialog, kQueryTotalRequests, INFO.validDevice);    EnableDialogItem(gDialog, kQueryBlocksPerTransfer, INFO.validDevice);    EnableDialogItem(gDialog, kQueryTimeout, INFO.validDevice);    EnableDialogItem(gDialog, kQueryEnableAsync, INFO.validDevice);    EnableDialogItem(gDialog, kQueryEnableDisconnect, INFO.validDevice);    if (INFO.validDevice) {      SetDialogValue(gDialog, kQueryBlocksPerTransfer, INFO.transferSizeBlocks);      SetDialogValue(gDialog, kQueryTimeout, INFO.completionTimeout);      SetDialogText(gDialog, kQueryVendorID, (StringPtr) INFO.vendor);      SetDialogText(gDialog, kQueryProduct, (StringPtr) INFO.product);      SetDialogValue(gDialog, kQueryLogicalBlockLength, INFO.logicalBlockLength);      SetDialogValue(gDialog, kQueryBlocksOnDevice, INFO.totalLogicalBlocks);    }    else {      SetDialogText(gDialog, kQueryBlocksPerTransfer, &quot;\p&quot;);      SetDialogText(gDialog, kQueryTimeout, &quot;\p&quot;);      SetDialogText(gDialog, kQueryVendorID, &quot;\p&quot;);      SetDialogText(gDialog, kQueryProduct, &quot;\p&quot;);      SetDialogText(gDialog, kQueryLogicalBlockLength, &quot;\p&quot;);      SetDialogText(gDialog, kQueryBlocksOnDevice, &quot;\p&quot;);    }}voidRefreshDeviceInfo(void){    OSErr        status;        if (INFO.pb != NULL) {      status = SetupDeviceInquiry();      if (status == noErr)        status = SetupReadCapacity();      INFO.validDevice = (status == noErr);    }}/* * Return TRUE if the InfoRecord is valid - this allocates the data buffer. */BooleanCheckInfoRecord(void){    Str15          work;        if (INFO.validDevice == FALSE)      return (FALSE);    else {      INFO.totalTransfers = GetDialogValue(gDialog, kQueryTotalRequests);      INFO.transferSizeBlocks = GetDialogValue(gDialog, kQueryBlocksPerTransfer);      INFO.completionTimeout = GetDialogValue(gDialog, kQueryTimeout);      INFO.bufferLength = (INFO.transferSizeBlocks * INFO.logicalBlockLength);      INFO.bufferPtr = NewPtr(INFO.bufferLength);      if (INFO.bufferPtr == NULL) {        NumToString(INFO.bufferLength, work);        ParamText(work, &quot;\p&quot;, &quot;\p&quot;, &quot;\p&quot;);        StopAlert(ALRT_NoMemory, NULL);        return (FALSE);      }      /* To do: read one block to verify that everything is in place */      return (TRUE);    }}/* * SaveInfoRecord links this InfoRecord into the active queue. */voidSaveInfoRecord(void){    Enqueue((QElemPtr) gCurrentInfoPtr, &amp;infoPtrQueue);    gCurrentInfoPtr = NULL;    }/* * Get the SCSI 4.3 Exec I/O parameter block. If this succeeds, * INFO.pb points to the parameter block, and INFO.pbSize has * its length. On failure, INFO.pb is NULL and INFO.pbSize zero. */voidRefreshParamBlock(void){    OSErr          status;    SCSIBusInquiryPB    pb;    CLEAR(pb);    pb.scsiPBLength = sizeof pb;    pb.scsiFunctionCode = SCSIBusInquiry;    pb.scsiCompletion = NULL;    pb.scsiFlags = 0;    pb.scsiDevice = INFO.deviceIdent;    SCSIAction((SCSI_PB *) &amp;pb);    status = pb.scsiResult;    if (status == noErr) {      if (INFO.pb != NULL &amp;&amp; INFO.pbSize != pb.scsiIOpbSize) {        DisposePtr((Ptr) INFO.pb);        INFO.pb = NULL;        INFO.pbSize = 0;      }      if (INFO.pb == NULL) {        INFO.pb = (SCSIExecIOPB *) NewPtr(pb.scsiIOpbSize);        if (INFO.pb == NULL)          status = MemError();        else {          INFO.pbSize = pb.scsiIOpbSize;        }      }    }    if (status != noErr) {      NonFatalError(status, &quot;\pCan't allocate SCSI Parameter Block&quot;);      if (INFO.pb != NULL) {        DisposePtr((Ptr) INFO.pb);        INFO.pb = NULL;        INFO.pbSize = 0;      }    }}/* * Get the Device Inquiry (vendor, product) data. Return error status. */OSErrSetupDeviceInquiry(void){    OSErr            status;    SCSI_Inquiry_Data      inquiryData;    const SCSI_6_Byte_Command  inquiryCmd = {      kScsiCmdInquiry, 0, 0, 0, sizeof inquiryData, 0    };    status = DoSCSISynchronousIO(          gCurrentInfoPtr,          /* -&gt; INFO        */          (SCSI_CommandPtr) &amp;inquiryCmd,    /* Command        */          scsiDirectionIn,          /* Reading from device  */          (Ptr) &amp;inquiryData,          /* -&gt; data buffer    */          sizeof inquiryData          /* data buffer size    */        );    if (status == noErr) {      StoreDeviceString(INFO.vendor, inquiryData.vendor, sizeof inquiryData.vendor);      StoreDeviceString(INFO.product, inquiryData.product, sizeof inquiryData.product);    }     return (status);}/* * Get the drive capacity (blocks, logical block length) for the device. * Return error status. */OSErrSetupReadCapacity(void){    OSErr            status;    SCSI_Capacity_Data      capacityData;    const SCSI_10_Byte_Command  capacityCmd = {      kScsiCmdReadCapacity, 0, 0, 0, 0, 0, 0, 0, 0, 0    };    status = DoSCSISynchronousIO(          gCurrentInfoPtr,          /* -&gt; INFO        */          (SCSI_CommandPtr) &amp;capacityCmd,    /* Command        */          scsiDirectionIn,          /* Reading from device  */          (Ptr) &amp;capacityData,        /* -&gt; data buffer    */          sizeof capacityData          /* data buffer size    */        );    if (status == noErr) {      INFO.totalLogicalBlocks = GetFourBytes(&amp;capacityData.lbn4);      INFO.logicalBlockLength = GetFourBytes(&amp;capacityData.len4);    }     return (status);}voidStoreDeviceString(    unsigned char        *dst,    unsigned char        *src,    short            srcLength  ){    short            i;    for (i = srcLength; i &gt; 0 &amp;&amp; src[i - 1] == ' '; --i)       ;    BlockMove(src, &amp;dst[1], i);    dst[0] = i;}unsigned longGetFourBytes(    unsigned char        *src  ){    register unsigned long    result;        result = src[0] &amp; 0xFF;    result &lt;&lt;= 8;    result |= (src[1] &amp; 0xFF);    result &lt;&lt;= 8;    result |= (src[2] &amp; 0xFF);    result &lt;&lt;= 8;    result |= (src[3] &amp; 0xFF);    return (result);}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/SCSI_Async_Sample/listing8.html%3Fid%3DDTS10000022-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/SCSI_Async_Sample/listing8.html%3Fid%3DDTS10000022-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/SCSI_Async_Sample/listing8.html%3Fid%3DDTS10000022-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>