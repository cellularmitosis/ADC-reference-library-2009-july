<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Creating a Subscriber(IM:IC)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING33></A>



<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="IAC-32.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="IAC-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="IAC-529.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="IAC-34.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="IAC-2.html"><B>Interapplication Communication</B></A> / <BR><DD><A HREF="IAC-23.html"><B>Chapter 2 - Edition Manager</B></A> / <A HREF="IAC-26.html"><B>Using the Edition Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING33-0></A>
<H2><A NAME=MARKER-21-188></A>Creating a Subscriber</H2>
 You need to create a Subscribe To menu command in the Edit menu. When a user chooses Subscribe To from this menu, your application should display the subscriber dialog box on the user's screen.<A NAME=MARKER-2-400></A><P>
 Use the <CODE>NewSubscriberDialog</CODE> function to display the subscriber dialog box on the user's screen. This function is similar to the <CODE>CustomGetFile</CODE> procedure described in the chapter "Standard File Package" in <I><A HREF="../Files/Files-2.html">Inside Macintosh: Files</A></I>.<P>
 To create a subscriber, you must get information from the user, such as the name of the edition being subscribed to. The dialog box displays a listing of all available editions and allows the user to see a preview (thumbnail sketch) of the edition selected. <A HREF=#MARKER-9-192>Figure 2-12</A> shows a sample subscriber dialog box.<A NAME=MARKER-9-82></A><A NAME=MARKER-21-106></A><P>
<B>Figure 2-12  <A NAME=MARKER-9-192></A><A NAME=MARKER-21-193></A>A sample subscriber dialog box</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/ED-S-12.gif"><P>
 The subscriber dialog box allows the user to choose an edition to subscribe to. The <CODE>NewSubscriberDialog</CODE> function handles all user interaction until a user clicks Subscribe or Cancel. When a user selects an edition container, the Edition Manager accesses the preview for the edition container (if it is available) and displays it.<A NAME=MARKER-9-101></A><P>
 You pass a new subscriber reply record as a parameter to the <CODE>NewSubscriberDialog</CODE> function.<A NAME=MARKER-2-187></A><A NAME=MARKER-2-188></A><P>
<PRE>
TYPE  NewSubscriberReply =
      RECORD
         canceled:   Boolean;    {user clicked Cancel}
         formatsMask:SignedByte; {formats required}
         container:  EditionContainerSpec;{initially, default }
                                 { name &amp; location of edition }
                                 { to subscribe to; on return, }
                                 { edition name &amp; location }
                                 { chosen by the user}
      END;
</PRE>
 The <CODE>canceled</CODE> field returns a Boolean value of <CODE>TRUE</CODE> if the user clicked Cancel. To indicate which edition format types (text, graphics, or sound) your application can read, you set the <CODE>formatsMask</CODE> field to one or more of these constants:<P>
<PRE>
CONST kPICTformatMask   = 1;           {can subscribe to 'PICT'} 
      kTEXTformatMask   = 2;           {can subscribe to 'TEXT'}
      ksndFormatMask    = 4;           {can subscribe to 'snd '}
</PRE>
 To support a combination of formats, add the constants together. For example, a <CODE>formatsMask</CODE> of 3 displays both graphics and text edition format types in the subscriber dialog box.<A NAME=MARKER-2-229></A><P>
 The <CODE>container</CODE> field is of data type <CODE>EditionContainerSpec</CODE>. You must initialize the <CODE>container</CODE> field with the default edition volume reference number, directory ID, filename, and part. To do so, use the <CODE>GetLastEditionContainerUsed</CODE> function to obtain the name of the last edition displayed in the dialog box.<A NAME=MARKER-2-309></A><P>
<PRE>
err := GetLastEditionContainerUsed(container);
</PRE>
 This function returns the last edition container for which a new section was created using the <CODE>NewSection</CODE> function. If there is no last edition, or if the edition was deleted, <CODE>GetLastEditionContainerUsed</CODE> still returns the correct volume reference number and directory ID to use, but leaves the filename blank and returns the <CODE>fnfErr</CODE> result code.<P>
 The <CODE>container</CODE> field is of data type <CODE>EditionContainerSpec</CODE>.<A NAME=MARKER-21-61></A><P>
<PRE>
TYPE EditionContainerSpec = 
   RECORD
      theFile:          FSSpec;        {file containing edition }
                                       { data}
      theFileScript:    ScriptCode;    {script code of filename}
      thePart:          LongInt;       {which part of file, }
                                       { always kPartsNotUsed}
      thePartName:      Str31;         {reserved}
      thePartScript:    ScriptCode;    {reserved}
   END;
</PRE>
 The field <CODE>theFile</CODE> is of type <CODE>FSSpec</CODE>. See <I><A HREF="../Files/Files-2.html">Inside Macintosh: Files</A></I> for further information on file system specification records.<A NAME=MARKER-2-34></A><P>
 After filling in the fields of the new subscriber reply record, pass it as a parameter to the <CODE>NewSubscriberDialog</CODE> function, which displays the subscriber dialog box.<A NAME=MARKER-9-86></A><A NAME=MARKER-9-117></A><P>
<PRE>
err := NewSubscriberDialog(reply);
</PRE>
 After displaying the subscriber dialog box, call the <CODE>NewSection</CODE> function to create the section record and the alias record. See <A HREF=IAC-28.html#MARKER-9-87>"Creating the Section Record and Alias Record" beginning on page 2-15</A> for detailed information.<A NAME=MARKER-9-16></A><P>
 If the subscriber is set up to receive new editions automatically (not manually), the Edition Manager sends your application a Section Read event. Whenever your application receives a Section Read event, it should read the contents of the edition into the subscriber.<P>
 <A HREF=#MARKER-9-205>Listing 2-6</A> illustrates how to create a subscriber. As described earlier, you must set up and display the subscriber dialog box to allow the user to subscribe to any of the available editions. After your application creates a subscriber, your application receives a Section Read event to read in the data being subscribed to. Be sure to add the newly created section to your list of sections for this file. There are many different techniques for creating subscribers and unique IDs; this listing displays one technique.<A NAME=MARKER-2-204></A><P>
<B>Listing 2-6  <A NAME=MARKER-9-205></A><A NAME=MARKER-21-206></A>Creating a subscriber</B><P>
<PRE>
PROCEDURE DoNewSubscriber(thisDocument: MyDocumentInfoPtr);
VAR
   getLastErr:    OSErr;
   dialogErr:     OSErr;
   sectionErr:    OSErr;
   resID:         Integer;
   thisSectionH:  SectionHandle;
   reply:         NewSubscriberReply;
BEGIN
   {put default edition name into reply record}
   getLastErr := GetLastEditionContainerUsed(reply.container);
   {can subscribe to pictures or text}
   reply.formatsMask := kPICTformatMask + kTEXTformatMask;
   {display dialog box &amp; let user select edition to subscribe to}
   dialogErr := NewSubscriberDialog(reply);
   IF dialogErr &lt;&gt; noErr THEN 
      MyErrHandler(dialogErr);   {handle error and exit}
   IF reply.canceled THEN        
      EXIT(DoNewSubscriber);     {do nothing if user canceled}
   {Advance counter to make a new unique sectionID for this }
   { document. It is not necessary to equate section IDs with }
   { resources.}
   thisDocument^.nextSectionID := thisDocument^.nextSectionID + 1;
   {create a subscriber section}
   sectionErr := NewSection(reply.container,
                            thisDocument^.fileSpecPtr,
                            stSubscriber, 
                            thisDocument^.nextSectionID,
                            sumAutomatic, thisSectionH);
   IF sectionErr &lt;&gt; noErr THEN
      MyErrHandler(sectionErr);{handle error and exit}
   resID := thisDocument^.nextSectionID;
   {add this section/alias pair to app's internal bookkeeping}
   MyAddSectionAliasPair(thisDocument, thisSectionH, resID);
   {Remember that you will receive a Section Read event to read }
   { in the edition that you just subscribed to because the }
   { initial mode is set to sumAutomatic.}
   {Remember that the section and alias records need to be saved } 
   { as resources when the user saves the document.}
END; 
</PRE>
<A NAME=HEADING33-25></A>
<H3><A NAME=MARKER-9-207></A><A NAME=MARKER-21-208></A>Opening an Edition Container to Read Data</H3>
 Before reading data from an edition, you must use the <CODE>OpenEdition</CODE> function. Your application should only use this function for a subscriber. Use this function to initiate the reading of data from an edition.<A NAME=MARKER-9-125></A><A NAME=MARKER-2-210></A><P>
<PRE>
err := OpenEdition(subscriberSectionH, refNum);
</PRE>
 As a precaution, you should retain the old data until the user can no longer undo. This allows you to undo changes if the user requests it.<P>
 Your application can supply a procedure such as <CODE>DoReadEdition</CODE> to read in data from the edition to a subscriber. When your application opens a document containing a subscriber that is set up to receive new editions automatically, the Edition Manager sends you a Section Read event if the edition has been updated. The Section Read event supplies the handle to the section that requires updating. <A HREF=#MARKER-9-218>Listing 2-7</A>, shown in the next section, provides an example of reading data from an edition.<A NAME=MARKER-9-90></A><A NAME=MARKER-2-201></A><P>
<A NAME=HEADING33-30></A>
<H3><A NAME=MARKER-9-213></A><A NAME=MARKER-21-214></A>Choosing Which Edition Format to Read</H3>
 After your application opens the edition container for a subscriber, it can look in the edition for formats that it understands. To accomplish this, use the <CODE>EditionHasFormat</CODE> function.<A NAME=MARKER-9-255></A><P>
<PRE>
err := EditionHasFormat(whichEdition, whichFormat, formatSize);
</PRE>
 The <CODE>EditionHasFormat</CODE> function returns the <CODE>noTypeErr</CODE> result code if a requested format is not available. If the requested format is available, this function returns the <CODE>noErr</CODE> result code, and the <CODE>formatSize</CODE> parameter contains the size of the data in the specified format or <CODE>kFormatLengthUnknown</CODE> (-1), which signifies that the size is unknown.<P>
<DL>
<DT><B>Note</B>
<DD><A NAME=MARKER-2-236></A>The Translation Manager (if it is available) attempts implicit translation under certain circumstances. For instance, it does so when your application attempts to read from an edition a format type that is not in the edition. In this case, the Translation Manager attempts to translate the data into the requested format. For more information, see the chapter "Translation Manager" in <I><A HREF="../MoreToolbox/MoreToolbox-2.html">Inside Macintosh: More Macintosh Toolbox</A></I>.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
 After your application opens the edition container and determines which formats it wants to read, call the <CODE>ReadEdition</CODE> function to read in the edition data. See <A HREF=IAC-31.html#MARKER-9-146>"Reading and Writing Edition Data" on page 2-27</A> for detailed information.<P>
 After you have completed writing the edition data into the subscriber section, call the <CODE>CloseEdition</CODE> function to close the edition. See <A HREF=IAC-31.html#MARKER-9-156>"Closing an Edition" on page 2-28</A> for detailed information.<A NAME=MARKER-9-155></A><P>
 <A HREF=#MARKER-9-218>Listing 2-7</A> illustrates how to read data from an edition. As described earlier, you must open the edition, determine which formats to read, use the <CODE>ReadEdition</CODE> function to read in data, and then use the <CODE>CloseEdition</CODE> function to close the edition. This listing shows how to read only text.<P>
<B>Listing 2-7  <A NAME=MARKER-9-218></A><A NAME=MARKER-21-219></A>Reading in edition data</B><P>
<PRE>
PROCEDURE DoReadEdition(theSubscriber: SectionHandle);
VAR
   eRefNum:          EditionRefNum;
   openErr:          OSErr;
   readErr:          OSErr;
   closeErr:         OSErr;
   thisDocument:     MyDocumentInfoPtr;
   textHandle:       Handle;
   formatLen:        Size;
BEGIN
   {find out which document this section belongs to}
   thisDocument := MyFindDocument(theSubscriber);
   {open the edition for reading}
   openErr := OpenEdition(theSubscriber, eRefNum);
   IF openErr &lt;&gt; noErr THEN
      MyErrHandler(openErr);  {handle error and exit}
   {look for 'TEXT' format}
   IF EditionHasFormat(eRefNum, 'TEXT', formatLen) = noErr THEN
   BEGIN
      {get the handle of location to read to}
      textHandle := MyGetTextInSection(theSubscriber, 
                                      thisDocument);
      SetHandleSize(textHandle, formatLen);
      HLock(textHandle);
      readErr := ReadEdition(eRefNum, 'TEXT', textHandle^, 
                             formatLen);
      MyUpdateSubscriberText(theSubscriber, textHandle, readErr);
      HUnLock(textHandle);
      IF readErr = noErr THEN
      BEGIN 
         {The read was successful; now close the edition. When }
         { successful = TRUE, the section data = edition data.}
         closeErr := CloseEdition(eRefNum, TRUE);
         EXIT(DoReadEdition);
      END;                                
   END;  {of EditionHasFormat}
   {'TEXT' format wasn't found or read error; just close }
   { the edition. FALSE tells the Edition Manager that your }
   { application did not get the latest edition.}
   closeErr := CloseEdition(eRefNum, FALSE);
END; 
</PRE>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="IAC-32.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="IAC-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="IAC-529.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="IAC-34.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="IAC-3.html">&copy; Apple Computer, Inc.</A><br>7 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
