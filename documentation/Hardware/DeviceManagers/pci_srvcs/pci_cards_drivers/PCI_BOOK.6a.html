<HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><script language="JavaScript" src="frametest.js"></script><TITLE> Sample FCode Drivers</TITLE></HEAD><BODY BGCOLOR="#ffffff"><DIV><a name="top"></a><!-- start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!-- start of path --><font face="Geneva,Helvetica,Arial" size="1"><b><br>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Documentation</a> &gt; <!-- a href="" target="_top" -->Hardware<!-- /a -->  <b>&gt; </b><a href="../../devicemgrs.html" target="_top">Device Managers and Drivers</a> <b>&gt; </b><a href="../pci_srvcs.html" target="_top">PCI Card Services</a> <b>&gt; </b>Designing PCI Cards and Drivers for Power Macintosh Computers</font><br><br><!-- end of path --><A HREF="PCI_BOOK.59.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.69.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.6b.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><HR></DIV><H1 CLASS="H1.Heading1"><A NAME="pgfId=4182"> </A><A NAME="16082"> </A>Sample FCode Drivers</H1><P CLASS="T1.Text1"><A NAME="pgfId=4186"> </A><A HREF="PCI_BOOK.6a.html#15984" CLASS="XRef">Listing&nbsp;5-2</A> shows an example of minimal FCode support for a PCI SCSI card. The FCode in the example provides identifying information in its device node and creates a property that contains the run-time driver to be loaded into the Macintosh system heap by the Expansion Bus Manager.<A NAME="marker=4187"> </A></P><P CLASS="L.Listing"><B><A NAME="pgfId=15176"> </A>Listing&nbsp;5-2	<A NAME="15984"> </A>Minimal PCI SCSI card FCode support</B></P><CODE CLASS="CvF.CodeFull"><A NAME="pgfId=15177"> </A>/ push arguments on the stack for pci-header:<BR>/ *** THESE MUST MATCH THE CONFIG REGISTERS FOR YOUR ***<BR>/ *** FCODE TO BE RECOGNIZED BY OPEN FIRMWARE ***<BR>/ vendor #, device #, class-code = SCSI bus controller<BR><BR>/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vendorID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;deviceID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;classCode<BR>&nbsp;&nbsp;&nbsp;&nbsp;tokenizer[ hex&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0003&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;010000 ]tokenizer<BR><BR>/ generate proper PCI image header<BR>&nbsp;&nbsp;&nbsp;&nbsp;pci-header<BR><BR>/ generate proper FCode header (within PCI image)<BR>&nbsp;&nbsp;&nbsp;&nbsp;fcode-version2<BR>&nbsp;&nbsp;&nbsp;&nbsp;hex<BR><BR>/ encode name property<BR>/ refer to IEEE 1275-1994, page 162<BR>/ refer to PCI bus binding to IEEE 1275-1994 Revision 2.0,<BR>/ Section 2.5 FCode Evaluation Semantics, page 9, line 36<BR>&nbsp;&nbsp;&nbsp;&nbsp;&quot;AAPL,scsi&quot; encode-string &quot; name&quot; property<BR><BR>/ encode compatibility property<BR>/ refer to IEEE 1275-1995, page 127<BR>/ refer to Open Firmware Recommended Pratice, Generic Names, version 1.4,<BR>/ Section 3 Generic Names, page 5, Guidline 2<BR>&nbsp;&nbsp;&nbsp;&nbsp;&quot;APPL,SYN53C875J&quot; encode-string &quot; compatibility&quot; property<BR><BR>/ encode device_type property<BR>/ refer to IEEE Std 1275-1994 : page 208<BR>&quot; scsi-2&quot; encode-string &quot; device_type&quot; property<BR><BR>/ encode reg property<BR>/ refer to IEEE Std 1275-1994 : page 174<BR>/ refer to Writting FCode Programs For PCI : page 84<BR><BR>/ generate a &quot;reg&quot; property which lists our configuration space at the start<BR>/ of the assigned space. with 0 size (as required by the PCI Binding<BR>/ Supplement)<BR><BR>/ PCI Configuration Space entry of the reg property<BR>my-address my-space encode-phys configuration space<BR>0 encode-int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 encode-int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\ size ( 0 )<BR><BR>/ Base Address Zero entry of the reg property<BR>my-address my-space 01000010 or encode-phys&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\ I/O space<BR>0 encode-int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;100 encode-int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\ size ( 256 )<BR><BR>/ Base Address One entry of the reg property<BR>my-address my-space 02000014 or encode-phys&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\ memory space<BR>0 encode-int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;100 encode-int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\ size ( 256 )<BR><BR>/ Base Address Two entry of the reg property<BR>my-address my-space 02000018 or encode-phys&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\ memory space<BR>0 encode-int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1000 encode-int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\ size ( 4K )<BR><BR>/ PCI Expansion ROM entry of the reg property<BR>my-address my-space 02000030 or encode-phys&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\ expansion rom<BR>0 encode-int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10000 encode-int&nbsp;&nbsp;&nbsp;&nbsp;encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\ size ( 64K )<BR><BR>&quot; reg&quot; property<BR><BR>/ &quot;power-consumption&quot; property which lists standby and full-on power<BR>/ consumtion for various power rails in microwatts goes here; if you<BR>/ don't create this property, Open Firmware creates one by filling in the<BR>/ &quot;unspecified&quot; rail entries from the PRSNT pins (if you don't know the<BR>/ power consumption values, you can fill the &quot;unspecified&quot; entries with<BR>/ zeros)<BR><BR>0 encode-int 0 encode-int encode+ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ &quot;unspecified&quot;<BR>d# 7500000 encode-int d# 7500000 encode-int encode+ encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ +5V<BR>0 encode-int 0 encode-int encode+ encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ +3V<BR>d# 8100000 encode-int d# 8100000 encode-int encode+ encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ I/Opower<BR>/ remaining entries are 0 and can be omitted<BR>0 encode-int 0 encode-int encode+ encode+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ reserved<BR><BR>&quot;power-consumption&quot; property<BR><BR>/ the following properties will automatically be generated for this card by<BR>/ Open Firmware from the PCI Configuration Space Header.<BR>/ Ref : PCI Bus Binding to : IEEE Std 1275-1994 Revision 2.0, Section 2.5,<BR>/ FCode Evaluation Semantics : page 8 : lines 14 - 57.<BR><BR>/ &quot;has-fcode&quot;<BR>/ &quot;vendor-id&quot;<BR>/ &quot;device-id&quot;<BR>/ &quot;revision-id&quot;<BR>/ &quot;class-code&quot;<BR>/ &quot;interrupts&quot;<BR>/ &quot;min-grant&quot; - unless header is type 01h<BR>/ &quot;max-latency&quot; - unless header is type 01h<BR>/ &quot;devsel-speed&quot;<BR>/ &quot;fast-back-to-back&quot;<BR>/ &quot;subsystem-id&quot;<BR>/ &quot;cache-line-size&quot;<BR>/ &quot;66MHz-capable&quot;<BR>/ &quot;udf-supported&quot;<BR>/ &quot;assigned-addresses&quot;<BR><BR>/ there is enough information for the runtime driver to be able to locate the card,<BR>/ however a complete FCode implementation would also provide boot-time I/O services<BR><BR>/ include an image of the runtime driver, and have it assigned as the value of a<BR>/ property that the Mac OS will read at startup<BR><BR>code-end&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ end FCode header<BR>pci-end&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ end PCI header</CODE><P CLASS="L.Listing"><B><A NAME="pgfId=15178"> </A>Listing&nbsp;5-3	Minimal network FCode driver support</B></P><CODE CLASS="CvF.CodeFull"><A NAME="pgfId=15143"> </A>/ Network drivers should support the <BR>/ TFTP Booting Extension Recommened Pratice<BR>/ [promiscous], [speed= n], [duplex= mode], [bootp], [siaddr], [filename], <BR>/ [ciaddr], [giaddr], [bootp-retries], [tftp-retries]<BR>/ See the PCI DDK 3.0 for a complete Network driver example</CODE><CODE CLASS="CvF.CodeFull"><A NAME="pgfId=15147"> </A>&quot; ethernet&quot; device-name<BR>&quot; network&quot; device-type<BR>&quot; ethernet&quot; encode-string &quot; network-type&quot; property<BR>&quot; network&quot; encode-string &quot; removable&quot; property<BR>&quot; net&quot; encode-string &quot; category&quot; property</CODE><P CLASS="L.Listing"><B><A NAME="pgfId=4585"> </A>Listing&nbsp;5-4	Minimal display FCode driver support</B></P><CODE CLASS="CvF.CodeFull"><A NAME="pgfId=15151"> </A>/ See the PCI DDK 3.0 for a complete display driver example<BR>&quot; display&quot; device-type &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ defines the device type as display</CODE><CODE CLASS="CvF.CodeFull"><A NAME="pgfId=15155"> </A><br><br>: my-open ( -- )<BR>&nbsp;&nbsp;&nbsp;&nbsp;... initialize device&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ your device initialization<BR>&nbsp;&nbsp;&nbsp;&nbsp;... monitor sense&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ monitor sense code<BR>&nbsp;&nbsp;&nbsp;&nbsp;;<BR>: my-close ( -- )<BR>&nbsp;&nbsp;&nbsp;&nbsp;... &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ close code goes here<BR>&nbsp;&nbsp;&nbsp;&nbsp;;</CODE><CODE CLASS="CvF.CodeFull"><A NAME="pgfId=15160"> </A><br><br>[`] my-open is-install<BR>&nbsp;&nbsp;&nbsp;&nbsp;/ You could put fcode in this area that puts up boot time options or a logo<BR>&nbsp;&nbsp;&nbsp;&nbsp;/ in a terminal emulator. <BR>&nbsp;&nbsp;&nbsp;&nbsp;/ here is a prototype example<BR>&nbsp;&nbsp;&nbsp;&nbsp;: open ( -- true )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my-open<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<BR>&nbsp;&nbsp;&nbsp;&nbsp;: write ( adr len -- actual )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<BR>&nbsp;&nbsp;&nbsp;&nbsp;: draw-logo ( l# a w h -- )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<BR>&nbsp;&nbsp;&nbsp;&nbsp;: restore<BR>&nbsp;&nbsp;&nbsp;&nbsp;;<BR>['] my-close is-remove<BR>&nbsp;&nbsp;&nbsp;&nbsp;: close ( -- )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my-close<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<BR>/ If you want to draw with color, you should support the <BR>/ Open Firmware 8-bit graphics extensions recommended pratice. See also, <BR>/ &quot;Terminal Emulation in Graphics Drivers&quot; on page&nbsp;5-cxxvi.<BR>/ The basic requirements are:<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ draw-rectangle ( adr x y w h -- )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ fill-rectangle ( index x y w h -- )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ read-rectangle ( adr x y w h -- )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ color! ( r g b index -- )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ color@ ( index -- r g b )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ set-colors ( adr index #indices -- )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ get-colors ( adr index #indices -- )<BR></CODE><CODE CLASS="CvF.CodeFull"><A NAME="pgfId=4219"> </A></CODE><HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 26 March 99)<P><A HREF="PCI_BOOK.59.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.69.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.6b.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>