<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note OS02: Giving the (Desk)Hook to INITs</title><meta name="keywords" content="Mac OS 8 clear DeskHook DragHook INIT dialogs"><meta name="Description" content="Technical Note OS02: This Technical Note details how to clearDeskHook and DragHook at INIT time, so that Macintoshes beforethe Mac II can display dialogs during INIT time. TechnicalNote also gives a strong warning against displaying dialogsduring INIT time.">                                       <meta name="categories" content="Operating System"><meta name="week-posted" content="Jul 31, 1989 - Aug 4, 1989"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002588" title="Giving the (Desk)Hook to INITs"></a><A NAME="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/index.html" target="_blank">Reference Library</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note OS02</div>
<div id="pageheadsub">Giving the (Desk)Hook to INITs</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Section1">Introduction</A><BR><br><A HREF="#Section2">Watch out for this guy too</A><BR><br><A HREF="#Section3">* Asterisk</A><BR><br><A HREF="#References">References</A><BR>                  <BR>                                    <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><p id="introtext">This Technical Note discusses INIT evils, the foremost of which deals withclearing <code>DeskHook</code> and <code>DragHook</code> at INIT time.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>Aug 01 1989</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content -->          <P><A NAME=Section1></A></P>          <h2>Introduction</h2><p>If you've survived the typical DTS Tirade<b>*</b> and still feel the need todisplay a dialog box or window in an INIT, you need to be aware of a problemthat exists on Macintoshes earlier than the Macintosh II (remember those?).There is a low-memory global named <code>DeskHook</code> ($A6C), which can containa pointer to a routine responsible for painting the Macintosh desktop.  If itis <code>NIL</code>, which is usually the case, the System paints the desktop withthe standard pattern.</p><p>When you start displaying dialog boxes or windows that obscure the desktop inyour INIT (this is really hard <b>not</b> to do, so keep reading and don't letus catch you skipping ahead to another Technical Note with pictures of humangenetic experiments gone sour - you know which one I'm talking about), theSystem looks at <code>DeskHook</code> for a desktop updating routine.  Since theMacintosh II, the System has cleared this hook prior to calling your INIT;however, on machines before the Macintosh II, this hook is not cleared beforethe System calls your INIT, so there is usually some junk hex lounging about inthere.  Since <code>DeskHook</code> is not <code>NIL</code>, when the System tries touse and perform a <code>JSR</code> to this "address," it blows big chunks.</p><p>So unless you like big chunks, the easy way to fix this problem is to clear<code>DeskHook</code> before doing any window drawing.  The most logical time to dothis is during your initialization:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>PEA     thePort(A6)        ; initialize own grafPort off A6    _InitGraf    _InitFonts    _InitWindows    _TEInit    CLR.L     -(A7)    _InitDialogs    CLR.L     $A6C            ; DeskHook</pre>	</TD></TR></TABLE></CENTER>    <p>For you high-level types, this translates into:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>procedure ClearDeskHook;    inline     $42B8, $0A6C;        { CLR.L $A6C ; DeskHook }</pre>	</TD></TR></TABLE></CENTER><p>It doesn't hurt to clear it on newer machines either, even if it is alreadyclear (you'll just have to trust me on this one), so go ahead and clear it allthe time.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>Some INITs might actually use <code>DeskHook</code>.  However, thepopular ones that paint a picture on the desktop, which you might think use it,do not.  They use other methods.  (We know, we checked.  We have the technology.)  For those of you who have seen a real procedure pointer in location $A6C on earlier Macintoshes, don't worry.  The system does not actually set <code>DeskHook</code> for its own use until the first application loads, so clearing it while INITs load is okay.</p></TD></TR></TABLE></CENTER><BR>    <p>If there is some daring INIT out there which sets <code>DeskHook</code>, wehaven't heard about it.  As is the case with many low-memory globals, using<code>DeskHook</code> has never been supported.</p><P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>Watch Out For This Guy Too</h2><p>It should also be noted that <code>DragHook</code> ($9F6) is not cleared duringINIT time on early Macintoshes either, and it will probably contain $FFFFFFFF.I guess no one in early Macintosh System Software wanted <code>DeskHook</code> tobe lonely.  <code>DragHook</code> can contain a pointer to a procedure that iscalled continuously while the mouse button is down.  If you have a userinterface at INIT time that ultimately calls <code>_TrackGoAway</code> for windowsor <code>_TrackControl </code>for controls, look out.  If the control is of thetype to allow one of its parts to be dragged with an outline, like a scrollbar's thumb, it calls <code>_DragTheRgn</code>, which checks to see if<code>DragHook</code> is <code>NIL</code>, and if it is not, it tries to perform a<code>JSR</code> to whatever address is there.  <code>_TrackGoAway</code> also tries toperform a JSR to that address if it's not <code>NIL</code>.  So make sure<code>DragHook</code> is clear before you attempt to use one of these routines.</p><p>In fact, if you've got a lot of spare time, like you're on the Voyager 7project waiting to come into contact with Black Lectroids and you have an oldMacintosh 512KE or Plus lying around, why not try randomly clearing out<b>all</b> low-memory globals and see what does and doesn't crash?  Sure to bean ice breaker at parties.</p><P><A HREF="#top">Back to top</A></P><a name="Section3"></a><h2> * (Asterisk)</h2><p>What am I yakking about?  If you've ever written to DTS about getting help withdisplaying some kind of modal monster at INIT time (remember this for the laterquiz kids, that's the time before this sort of thing should normally happen),you know of what I yak.</p><p>We have this pet peeve with INITs that interrupt the boot process with a modaldialog box which asks us to enter our name then proceeds to ask us how many characters we just entered and what we had for dinner, especially when we've left the desk to go get a fix of a highly caffeinated substance.  INITs were created for developers (and us) to install system patches and device drivers and make the occasional rude startup sound to annoy the person occupying thecube next to ours.  INITs were <b>not</b> developed to ask for personal (asexual) histories.</p><p>We do not mean to say that we don't like all graphics at boot time.  TheShowINIT icon mechanism that was popularized by Paul Mercer is great.  In fact,we encourage its use and we gladly give out the ShowINIT MPW object file, withinstallation help, to anyone who asks for it.  This is an excellent method fora developer to inform a user whether a ROM patch or device driver has beensuccessfully installed (show the red X through the icon on the rare occasionwhen things go wrong).  Of course, this doesn't work if some non-social INITmakes an <code>_InitWindows</code> call, which wipes clean the entire screen (andwith it all previous ShowINIT icons).  You may argue that having the <code>_InitWindows</code>trap wipe out the entire screen at INIT time is a bad Macintosh OS INIT-time design, but this is one of our biggest complaints with the whole INIT look-at-my-fancy-splash-screen-or-complete-my-insanely-great-modal-dialog-box phenomenon.</p><p>If you feel the need to notify the user of an important occurrence during boottime, initialize a notification request with the Notification Manager in yourINIT code (see M.TB.Notification Manager, and yes, it is perfectly legal to useat INIT time), and the system will notify the user after the boot process, whenthe event mechanism starts.  The now alerted user can then activate your deskaccessory, application, or whatever and you can perform whatever kind of pyrotechnics you want.</p><p>If you are going, "But, but, but..." because various Apple products are guiltyof INIT evils, then you should realize that we are giving Apple engineers thesame, if not more, grief to cleanse their acts as well.</p><p>It's not that we're telling you that you cannot put up a modal dialog box atINIT time if you feel like it's really-absolutely-positively-it-was-your-dying-mother's last-wish-necessary.It's just that DTS would like to see a cleaner Macintosh interface (as I'm sure you all would), and a more uniform boot time appearance can help achieve this goal.</p><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><p><A HREF = "../tb/tb_17.html">M.TB.Notification Manager</a></p> <P><A HREF="#top">Back to top</A></P>         <P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (48K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/os_02.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/os/os_02.html%3Fid%3DDTS10002588-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/os/os_02.html%3Fid%3DDTS10002588-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/os/os_02.html%3Fid%3DDTS10002588-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>