<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TN1023: Understanding PackBits</title>    <meta name="keywords" content="Mac OS 8 PackBits data format flag-counter byte PICT">    <meta name="Description" content="Technical Note TN1023: This Technical Note describes theformat of data packed by the Toolbox utility PackBits anddocuments a change to the srcBytes limit and to the possibleworst case. "><meta name="categories" content="QuickDraw"><meta name="week-posted" content="Jan 29, 1996 - Feb 2, 1996"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002865" title="Understanding PackBits"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/index.html" target="_blank">Reference Library</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1023</div>
<div id="pageheadsub">Understanding PackBits</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"> <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr><td width=300 valign="top" align=left scope="row">    <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td></tr><tr bgcolor="#e6e6e6">    <td background="images/tnmenubody.gif" width=300 align=left><span id="menutitle">    CONTENTS     <BR>    <BR></span>    </td></tr><tr bgcolor="#e6e6e6">    <td background="images/tnmenubody.gif" width=300 align=left><!-- begin_toc --><P id = "menutext"><A HREF = "#RTFToC1">Describing the Interface to the PackBits Routine</a><br><br><A HREF = "#RTFToC2">Using PackBits</a><br><br><A HREF = "#Changes">Change History</a><br><br><A HREF = "#References">References</a><br><br><A HREF="#Downloads">Downloadables</A></P>   <!-- end_toc -->  </td></tr><tr>    <td width=300 align=left scope="row"><img src="images/tnmenubottom.gif" alt="" width=300 height=16>    </td></tr>    </table></td><td width=300 valign="top" align=left><!-- begin_intro_text -->  <P id = "introtext">This Technote describes the format of data packed by the Toolbox utility PackBits and documents a change to the srcBytes limit and to the possible worst case.</p><P id = "introtext">Although you can simply unpack this data using UnPackBits, Apple provides this information for the terminally curious and for those manipulating PICT files by hand.</p><P id = "introtext">See also the "Mathmatical and Logical Utilities" chapter in <a href="http://developer.apple.com/documentation/mac/OSUtilities/OSUtilities-38.html#HEADING38-0"><i>Inside Macintosh, Operating System Utilities</i></A>.</p><BR><TABLE BORDER=0 WIDTH=275><TR><td bgcolor="#E6E6E6" align=left><P id = "introtext"><B>WARNING: </B><BR>This format information is subject to change.</P></TD></TR></TABLE><!-- end_intro_text --><!-- begin_date --><h3 align=center>&nbsp;[Feb 1 1996]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR> <!-- begin_content --><br><a name="RTFToC1"></a><h2>Describing the Interface to the PackBits Routine</h2><P>The "Mathmatical and Logical Utilities" chapter of <a href="http://developer.apple.com/documentation/mac/OSUtilities/OSUtilities-38.html#HEADING38-0"><i>Inside Macintosh: Operating System Utilities</i></A> describes the interface to the PackBits routine as follows: </p> <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>PackBits(Ptr*srcPtr, Ptr*dstPtr, short srcBytes);</pre>	</TD></TR></TABLE></CENTER><P>The accompanying text states that srcBytes, the length of your uncompressed data, should not be greater than 127, and that in the worst case, the compressed data can be srcBytes + 1. To pack more than 127 bytes, you had to break the data up into 127-byte groups and call PackBits on each group. Beginning with system software version 6.0.2, this limit of 127 bytes is no longer valid. The new limit is 32,767 bytes, which is the maximum positive number that srcBytes can hold. The worst case can be determined according to the following formula: </p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>MaxdestBytes = (srcBytes + (srcBytes+126) DIV 127)</pre>	</TD></TR></TABLE></CENTER><P>which is comparable to breaking up the data into 127-byte groups and picking up an  additional byte for each group.</p><h3>Specifying the Flag-counter Byte</h3><P>The first byte is a flag-counter byte that specifies whether or not the following data is packed, and the number of bytes involved.</p><P>If this first byte is a negative number, the following data is packed and the number is a zero-based count of the number of times the data byte repeats when expanded. There is one data byte following the flag-counter byte in packed data; the byte after the data byte is the next flag-counter byte.</p><P>If the flag-counter byte is a positive number, then the following data is unpacked and the number is a zero-based count of the number of incompressible data bytes that follow. There are (flag-counter+1) data bytes following the flag-counter byte. The byte after the last data byte is the next flag-counter byte.</p><P>Given a pointer to the start of packed data, there is no way to know when you have reached the end of the packed data. Because UnPackBits requires the length of the unpacked data, you need to know either the length of the packed or unpacked data before you start unpacking.</p><a name="RTFToC2"></a><h2>Using PackBits</h2><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>WARNING: </B><BR>PackBits never generates the value -128 ($80) as a flag-counter byte, but a few PackBits-like routines that are built into some applications do. UnpackBits handles this situation by skipping any flag-counter byte with this value and interpreting the next byte as the next flag-counter byte. If you're writing your own UnpackBits-like routine, make sure it handles this situation in the same way. </P></TD></TR></TABLE></CENTER><BR><P>Consider the following example: </p><P>Unpacked data: </p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>AA AA AA 80 00 2A AA AA AA AA 80 00 2A 22 AA AA AA AA AA AA AA AA AA AA</pre>	</TD></TR></TABLE></CENTER><P>After being packed by PackBits: </p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    FE AA                    ; (-(-2)+1) = 3 bytes of the pattern $AA    02 80 00 2A              ; (2)+1 = 3 bytes of discrete data    FD AA                    ; (-(-3)+1) = 4 bytes of the pattern $AA    03 80 00 2A 22           ; (3)+1 = 4 bytes of discrete data    F7 AA                    ; (-(-9)+1) = 10 bytes of the pattern $AA</pre>	</TD></TR></TABLE></CENTER><P>or</P><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    FE AA 02 80 00 2A FD AA 03 80 00 2A 22 F7 AA    *     *           *     *              *</pre>	</TD></TR></TABLE></CENTER><P>The bytes with the asterisk (*) under them are the flag-counter bytes. PackBits packs the data only when there are three or more consecutive bytes with the same data; otherwise it just copies the data byte for byte (and adds the count byte).</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note: </B><BR>The data associated with some PICT opcodes, $0098 (PackBitsRect) and $0099 (PackBitsRgn), contain PixData which is basically made of PackBits data. It should be noted, though, that the format for PixData includes a byteCount or length in addition to the data described in this Note.</P></TD></TR></TABLE></CENTER><BR><P>For example, the following is the result of decoding a sample PICT2: </p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>data 'PICT' (25534) {    0936 0000 0000 0007 001E        /* pic size, picFrame */    0011 02FF                /* pict2              */    0C00                    /* header             */        FFFF FFFF 0000 0000 0000 0000 001E 0000 0007 0000 0000 0000    001E                    /* def hilite         */    0001                    /* clipRgn            */        000A 0000 0000 0007 001E    0098                    /* PackBitsRect       */        801E                /* rowbytes of 30     */        0000 0000 0007 001E        /* Bounds             */        0000                /* packType           */        0000                /* version            */        0000 0000            /* packSize           */        0048 0000            /* hRes               */        0048 0000            /* vRes               */        0000                /* pixelType          */        0008                /* pixelSize          */        0001                /* cmpCount           */        0008                /* cmpSize            */        0000 0000            /* planeBytes         */        0000 1F10            /* pmTable            */        0000 0000            /* pmReserved         */        /*color table*/            0000 4CBC        /* ctSeed             */            8000            /* ctFlags            */            00FF            /* ctSize             */                0000 FFFF FFFF FFFF                ...        /* 254 ColorSpec's omitted */                0000 0000 0000 0000        0000 0000 0007 001E        /* srcRect            */        0000 0000 0007 001E        /* dstRect            */        0000                /* srcCopy            */        /* Now we have the scan line data packed as follows:        [bytecount for current scan line] [data as defined above]        If rowBytes is &gt; 250 then byteCount is a word else is a byte        (in this case, byteCount is a byte)        note that each unpacked row adds to 30 rowBytes        */        /* line 1, byte count is 2 (best case for a row)   */        02            E3 FF        /* -(-29) + 1 = 30 FF's    */        /* line 2, byte count is 19 (0x13)                 */        13            01 FF 23    /* 1+1 data bytes          */            FE 00        /* -(-2)+1 0's             */            FC 23        /* -(-4)+1 0x23's          */            FE 00        /* 3 0's                   */            FC 23        /* 5 0x23's                */            FE 00        /* 3 0's                   */            FC 23        /* 5 0x23's                */            FE 00        /* 3 0's                   */            00 FF        /* 1 data byte             */        /* line 3, byte count is 28                        */        1C            02 FF 00 23    /* 3 data bytes            */            FE 00        /* 3 0's                   */            FE 23        /* 3 0x23's                */            01 00 23    /* 2 data bytes            */            FE 00        /* 3 0's                   */            FE 23        /* 3 0x23's                */            01 00 23    /* 2 data bytes            */            FE 00        /* 3 0's                   */            FE 23        /* 3 0x23's                */            04 00 23 00 00 FF    /* 5 data bytes            */        /* line 4, byte count is 31 (worst case for a row) */        1F            03 FF 00 00 23    /* 4 data bytes            */            FE 00        /* 3 0's                   */            00 23        /* 1 data byte             */            FE 00        /* 3 0's                   */            00 23        /* 1 data byte             */            FE 00        /* 3 0's                   */            00 23        /* 1 data byte             */            FE 00        /* 3 0's                   */            00 23        /* 1 data byte             */            FE 00        /* 3 0's                   */            00 23        /* 1 data byte             */            FE 00        /* 3 0's                   */            02 23 00 FF    /* 3 data bytes            */        /* line 5, byte count is 28                        */        1C            01 FF 00    /* 2 data bytes            */            FE 23        /* 3 0x23's                */            01 00 23    /* 2 data bytes            */            FE 00        /* 3 0's                   */            FE 23        /* 3 0x23's                */            01 00 23    /* 2 data bytes            */            FE 00        /* 3 0's                   */            FE 23        /* 3 0x23's                */            01 00 23    /* 2 data bytes            */            FE 00        /* 3 0's                   */            FE 23        /* 3 0x23's                */            00 FF        /* 1 data byte             */        /* line 6, byte count is 18                        */        12            00 FF        /* 1 data byte             */            FC 23        /* 5 0x23's                */            FE 00        /* 3 0's                   */            FC 23        /* 5 0x23's                */            FE 00        /* 3 0's                   */            FC 23        /* 5 0x23's                */            FE 00        /* 3 0's                   */            FD 23        /* 4 0x23's                */            00 FF        /* 1 data byte             */        /* line 7, byte count is 2 (best case for a row)   */        02            E3 FF        /* 30 0xFF's               */        00  /* pad so next command starts at word boundary */00FF                    /*end of pic               */};</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><P><a href="http://developer.apple.com/documentation/mac/OSUtilities/OSUtilities-38.html#HEADING38-0"><CITE>Inside Macintosh: Operating System Utilities</CITE></A>   Mathematical and Logical Utilities</p><p> <A HREF = "../pt/pt_24.html">Technical Note PT 24, "MacPaint Document Format"</A></p><P><A HREF="#top">Back to top</A></P><a name="Changes"></a><H2>Change History</h2><TABLE BORDER=0 CELLPADDING=3 WIDTH=544>            <TR>               <td width=100 align=left>                  <P ALIGN=center>01-November-1987</P>               </TD>               <td align="left">                  <P>Originally written</P>               </TD>            </TR>            <TR>               <td width=100 align=left>                  <P ALIGN=center>01-November-1990</P>               </TD>               <td align="left">                  <P>Warning added about the handling of a flag-counter byte value of -128.</P>               </TD>            </TR></table><P><A HREF="#top">Back to top</A></P>          <A NAME=Downloads></A>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (48K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tn1023.pdf">Download</A></P>               </TD>            </TR>         </TABLE>         <BR><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER>		<!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1023.html%3Fid%3DDTS10002865-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1023.html%3Fid%3DDTS10002865-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1023.html%3Fid%3DDTS10002865-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>