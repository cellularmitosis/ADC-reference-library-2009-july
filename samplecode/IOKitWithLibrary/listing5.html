<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>IOKitWithLibrary - /Read Me.txt</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/Darwin/index.html">Darwin</a> &gt; <a href="../../samplecode/Darwin/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; <A HREF="javascript:location.replace('index.html');">IOKitWithLibrary</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">IOKitWithLibrary</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/Read Me.txt</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/IOKitPart.cpp</option>
<option value="listing2.html">/IOKitPart.h</option>
<option value="listing3.html">/LibraryPart.c</option>
<option value="listing4.html">/LibraryPart.h</option>
<option value="listing5.html">/Read Me.txt</option></select>
				</p>
				</form>
				<p><strong><a href="IOKitWithLibrary.zip">Download Sample</a></strong> (&#147;IOKitWithLibrary.zip&#148;, 61.2K)<BR>
<strong><a href="IOKitWithLibrary.dmg">Download Sample</a></strong> (&#147;IOKitWithLibrary.dmg&#148;, 121.2K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">Read Me About IOKitWithLibrary1.0IOKitWithLibrary is a trivial I/O Kit
sample that shows how an I/O Kit driver can link with a C library that resides
in a separate kernel extension. Some developers find this technique useful
because it allows them to share some core functionality between many different
I/O Kit drivers.The sample should work on all versions of Mac OS X, but has
only been tested on Mac OS X 10.2.x.Packing ListThe sample contains the
following items:* Read Me About IOKitWithLibrary \xD1 This document.*
IOKitWithLibrary.pbproj \xD1 A Project Builder project for the sample.* build \xD1 A
folder containing pre-built versions of the I/O Kit driver and, embedded within
it, the library KEXT.* English.lproj \xD1 Localised resources.* IOKitPart.h \xD1
Interface to the I/O Kit driver.* IOKitPart.cpp \xD1 Implementation of the I/O
Kit driver.* LibraryPart.h \xD1 Interface to the library KEXT.* LibraryPart.c \xD1
Implementation of the library KEXT.Using the SampleTo use the sample, you
have to first install the I/O Kit driver. To start, change into the directory
containing the sample\xC9[guy-smiley:~] quinn% cd PathToSample\xC9 then change
into the build directory.[guy-smiley:IOKitWithLibrary] quinn% cd buildYou
can now copy the I/O Kit driver into the Extensions folder.[guy-smiley:build]
quinn% sudo cp -r IOKitWithLibrary.kext /System/Library/ExtensionsPassword:
********At this point, it's possible to load the I/O Kit driver and have the
system automatically load the library it depends on.  The -t flag causes
kextload to validate the KEXT before it loads it.[guy-smiley:build] quinn%
sudo kextload -t /System/Library/Extensions/IOKitWithLibrary.kextkextload:
extension /System/Library/Extensions/IOKitWithLibrary.kext appears to be
validkextload: notice: extension
/System/Library/Extensions/IOKitWithLibrary.kext has debug properties
setkextload: /System/Library/Extensions/IOKitWithLibrary.kext loaded
successfullyIf you look at the end of the system log file, you'll see that
the I/O Kit driver is actually linked to the library and can call functions
within the library (for example, the log entry &quot;LibraryFunction&quot; is printed by
code in the library).[guy-smiley:build] quinn% tail /var/log/system.logAug 
7 16:56:45 mr-hoots sshd[439]: Accepted password for quinn from 10.0.40.2 port
56692 ssh2Aug  7 16:57:09 mr-hoots sudo:    quinn : TTY=ttyp1 ;
PWD=/Users/quinn ; USER=root ; COMMAND=/bin/cp -r IOKitPart.kext
/System/Library/ExtensionsAug  7 16:57:19 mr-hoots sudo:    quinn : TTY=ttyp1
; PWD=/Users/quinn ; USER=root ; COMMAND=/bin/cp -r IOKitWithLibrary.kext
/System/Library/ExtensionsAug  7 16:57:44 mr-hoots sudo:    quinn : TTY=ttyp1
; PWD=/Users/quinn ; USER=root ; COMMAND=/sbin/kextload -t
/System/Library/Extensions/IOKitWithLibrary.kextAug  7 16:57:48 mr-hoots
mach_kernel: Matching service count = 1Aug  7 16:57:48 mr-hoots mach_kernel:
Calling library functionAug  7 16:57:48 mr-hoots mach_kernel:
LibraryFunctionAug  7 16:57:48 mr-hoots mach_kernel: Returned from libraryAug
 7 16:57:48 mr-hoots mach_kernel:
com_apple_dts_driver_IOKitWithLibrary::probe(IOResources)Aug  7 16:57:48
mr-hoots mach_kernel: com_apple_dts_driver_IOKitWithLibrary::start(IOResources)
&lt;1&gt;Finally, you can unload the I/O Kit driver and the library
KEXT\xC9[guy-smiley:build] quinn% sudo kextunload
/System/Library/Extensions/IOKitWithLibrary.kextunload kext
/System/Library/Extensions/IOKitWithLibrary.kext succeeded (any personalities
also unloaded)[guy-smiley:build] quinn% sudo kextunload -b
com.apple.dts.library.IOKitWithLibraryunload id
com.apple.dts.library.IOKitWithLibrary succeeded (any personalities also
unloaded)\xC9 and delete the I/O Kit driver from the Extensions
folder.[guy-smiley:build] quinn% sudo rm -r
/System/Library/Extensions/IOKitWithLibrary.kextBuilding the SampleThe
sample was built on Mac OS X version 10.2.6 using Project Builder 2.1 from the
Dec 2002 developer tools.  To build the project, open the project, make sure
that the &quot;IOKitWithLibrary&quot; target is selected, and choose Build from the Build
menu.The project contains two targets, &quot;IOKitLibrary&quot; and &quot;LibraryPart&quot;.
Building the first target also builds the second and runs a &quot;copy&quot; build phase
to copy the &quot;LibraryPart.kext&quot; KEXT into the &quot;PlugIns&quot; folder within
&quot;IOKitWithLibrary.kext&quot;. The end result is that the library KEXT is embedded
within the driver KEXT. This guarantees that the driver and library will never
be separated, which has a number of advantages.* It guarantees that the
library will never be missing when the driver is loaded.* It guarantees that
the library and driver will always be in sync.* It makes the KEXT easier to
install and remove.This technique may not be approach for all projects, but
we encourage you to use it when it is.How it WorksThe kernel has a single
level namespace, so the process of linking between one KEXT and another is very
simple: just declare a function in a common header, defined the function in one
KEXT, and call it in another.On the other hand, setting up the KEXT packaging
so that one KEXT declares a dependency on another can be tricky.  The following
is a list of items that I had to get right in order for IOKitLibrary to work
properly.Source CodeCheck that I/O Kit driver header and source have the
correct class name (com_apple_dts_driver_IOKitWithLibrary), and that it matches
the class name in the IOKitPersonalities entry within the plist.Check that
functions exported from the library aren't going to collide with other kernel
symbols. In this example I used the name
com_apple_dts_library_IOKitWithLibrary_LibraryFunction.  Remember that the
kernel has a single-level namespace, so if you export a function and the kernel
or some other KEXT exports a function of the same name, bad things will happen.
The best way to avoid this problem is to use reverse DNS notation for your
function names, as shown in this example. For more information about this
issue, see the &quot;Standard C Naming Conventions&quot; section of &quot;Inside Mac OS X:
Kernel
Programming&quot;.&lt;http://developer.apple.com/documentation/Darwin/Conceptual/KernelProgramming/index.html&gt;Check
that the library start and stop routines are uniquely named
(com_apple_dts_library_IOKitWithLibrary_start,
com_apple_dts_library_IOKitWithLibrary_stop).For C exports, make sure the
exports are bracketed with the following guards, otherwise C++ code won't be
able to access the symbols because the C++ compiler will mangle the
names.#ifdef __cplusplus  extern &quot;C&quot; {#endif// your declarations
here#ifdef __cplusplus  }#endifLibraryPart target, Settings, Expert
ViewCheck that KERNEL_MODULE is defined to YES.Check that MODULE_IOKIT is
not defined.Check that MODULE_NAME matches the name in CFBundleIdentifier in
the plist (com.apple.dts.library.IOKitWithLibrary).Check that MODULE_START
and MODULE_STOP match the names used in the source
(com_apple_dts_library_IOKitWithLibrary_start,
com_apple_dts_library_IOKitWithLibrary_stop).Check that MODULE_VERSION
matches CFBundleVersion in plist (1.0).Check that PRODUCT_NAME reflects the
name of the bundle in the file system and that it matches CFBundleExecutable in
the plist (LibraryPart).Check that WRAPPER_EXTENSION is kext.LibraryPart
target, Info.plist, Expert ViewCheck that CFBundleExecutable matches
PRODUCT_NAME in settings (LibraryPart).Check that CFBundleIdentifier matches
MODULE_NAME in settings (com.apple.dts.library.IOKitWithLibrary).Check that
CFBundlePackageType is KEXT.Check that CFBundleVersion matches MODULE_VERSION
in settings (1.0).Check that OSBundleCompatibleVersion is present and correct
(1.0).Check that OSBundleLibraries reflects correct dependencies. 
com.apple.kernel.iokit   = 1.1  com.apple.kernel.libkern = 1.1 
com.apple.kernel.mach    = 1.1IOKitWithLibrary target, Settings, Expert
ViewCheck that KERNEL_MODULE is defined to YES.Check that MODULE_IOKIT is
defined to YES.Check that MODULE_NAME matches the name in CFBundleIdentifier
in the plist (com.apple.dts.driver.IOKitWithLibrary).Check that MODULE_START
and MODULE_STOP are not defined.Check that MODULE_VERSION matches
CFBundleVersion in plist (1.0).Check that PRODUCT_NAME reflects name of the
bundle in the file system and that it matches CFBundleExecutable in plist
(IOKitWithLibrary).Check that WRAPPER_EXTENSION is kext.IOKitWithLibrary
target, Info.plist, Expert ViewCheck that CFBundleExecutable matches
PRODUCT_NAME in settings (IOKitWithLibrary).Check that CFBundleIdentifier
matches MODULE_NAME in settings (com.apple.dts.driver.IOKitWithLibrary).Check
that CFBundlePackageType is KEXT.Check that CFBundleVersion matches
MODULE_VERSION in settings (1.0).Check that IOKitPersonalities is set
correctly.  There should be at least one entry, named by a suitably mnemonic
key.  Check the following within that entry.* Check that CFBundleIdentifier
matches identifier in plist (com.apple.dts.driver.IOKitWithLibrary).*\xCACheck
that IOClass matches class name in source
(com_apple_dts_driver_IOKitWithLibrary).* If debugging, set IOKitDebug to the
number 65535.* Set IOProviderClass to class of your provider
(IOResources).*\xCASet other matching properties.    IOMatchCategory =
IOKitWithLibrary    IOResourceMatch = IOKitCheck that OSBundleLibraries
reflects correct dependencies.  com.apple.dts.library.IOKitWithLibrary = 1.0
 com.apple.kernel.iokit                 = 1.1  com.apple.kernel.libkern        
      = 1.1  com.apple.kernel.mach                  = 1.1Clean All Targets
and RebuildProject Builder does not correctly update all dependencies when
you change the above settings, so make sure that you clean all targets and
rebuild after you change them.Credits and Version HistoryIf you find any
problems with this sample, mail &lt;DTS@apple.com&gt; and I'll try to fix them
up.1.0 (Aug 2003) was the first shipping version.Share and Enjoy.Apple
Developer Technical SupportNetworking, Communications, Hardware14 Aug 2003</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/IOKitWithLibrary/listing5.html%3Fid%3DDTS10000446-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/IOKitWithLibrary/listing5.html%3Fid%3DDTS10000446-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/IOKitWithLibrary/listing5.html%3Fid%3DDTS10000446-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>