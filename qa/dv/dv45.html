<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!--Template 06-20-02--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Q&amp;A DV45: Coordinating Deferred Tasks and Secondary Interrupts</title>			<meta name="keywords" content="deferred tasks, secondary interrupts, USB, networking">						<meta name="Description" content="Technical Q&amp;A DV45: This Q&amp;A discusses issues with mixingcode that runs at secondary interrupt time  		with code thatruns at deferred task time.  A common example of  		thisis a USB network device driver."><meta name="categories" content="Devices"><meta name="week-posted" content="Nov 6, 2000 - Nov 10, 2000"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10001186" title="Coordinating Deferred Tasks and Secondary Interrupts"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalqas/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/index.html" target="_blank">Reference Library > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A DV45</div>
<div id="pageheadsub">Coordinating Deferred Tasks and Secondary Interrupts</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><!-- begin_content --><CENTER><TABLE BORDER=0 CELLPADDING=0 WIDTH=600>  <TR> <td align="left"><hr width=500 align=center>         <P id=p2>Q: I'm writing a driver for a USB network device.         USB callbacks happen at secondary interrupt level. Many Open         Transport calls can only be called from deferred task level.         How do I get from one to the other?</P>                  <P id=p4>A: The answer to this question is simple, although         the background is very complex and needs some explanation. I         will start with the basics and then fill in the details for         the relentlessly curious.</P>                                   <P id=p4>Deferred Task to Secondary Interrupt</p>                  <p id=p4>To get from deferred task level to secondary         interrupt level, use the DriverServicesLib call         <CODE>QueueSecondaryInterruptHandler</CODE>.</P>                  <CENTER><TABLE BORDER=0 CELLPADDING=3 WIDTH=550>            <TR>               <td bgcolor="#e6e6e6" align=left>                  <p id=p4><B>WARNING:</B><BR>                  Do not use                  <CODE>CallSecondaryInterruptHandler2</CODE>.                  Depending on the system version this call will                  either do the wrong thing or fail with an error                  code if you call it from a deferred task. See the                  detailed explanation later in this document.</P>               </TD>            </TR>         </TABLE>         </CENTER>                  <P id=p4>Secondary Interrupt to Deferred Task</p>                  <P id=p4>To get from secondary interrupt level to deferred         task level, use the standard <CODE>DTInstall</CODE> system         call. On some systems (see the explanation below), calling         <CODE>DTInstall</CODE> from a secondary interrupt can result         in the deferred task being called immediately (that is,         before <CODE>DTInstall</CODE> returns). If this is a problem         for your software, you can force the Deferred Task Manager         to always queue your deferred task using the code from         Listing 1.</P>                  <CENTER><TABLE BORDER=0 CELLPADDING=0 WIDTH=550>            <TR>               <td align="left">                  <p id=p4>&nbsp;<B>Listing 1</B>. Forcing a deferred task                  to always be queued.</P>                                    <TABLE BORDER=0 CELLPADDING=5 WIDTH=550>                     <TR>                        <td bgcolor="#e6e6e6" align=left>                           <pre>static OSStatus MySecondaryInterruptHandler(void *p1, void *p2){    OSStatus junk;    UInt16 oldInterruptMask;    oldInterruptMask = SetInterruptMask(7);    junk = DTInstall(&amp;gDeferredTask);    MoreAssertQ(junk == noErr);    (void) SetInterruptMask(oldInterruptMask);    return noErr;}</pre>                        </TD>                     </TR>                  </TABLE>                                </TD>            </TR>         </TABLE>         </CENTER>                  <P id=p4>Listing 1 uses the routines from         InterruptDisableLib, as described in DTS Technote 1137         <a href="../../technotes/tn/tn1137.html">Disabling         Interrupts on the Traditional Mac OS</A>.</P>                    <P id=p4>The Full Story</p>                  <P id=p4>As explained in DTS Q&amp;A DV 43 <a href="dv43.html">InterfaceLib         and Native Drivers</A>, DriverServicesLib defines a model         that is somewhat out of sync with the reality of traditional         Mac OS. This is not a big problem if your software works         entirely within the DriverServicesLib model, but it can         cause problems if you write code that operates in both         worlds. An example of this is a USB network driver, which         must use both deferred tasks (Open Transport) and secondary         interrupts (USB).</P>                  <P id=p4>The biggest problem with calling DriverServicesLib         routines from a deferred task is that many of its routines         rely internally on the value returned by         <CODE>CurrentExecutionLevel</CODE>. As explained in Technote         1104 <a href="../../technotes/tn/tn1104.html">Interrupt-Safe         Routines</A>, <CODE>CurrentExecutionLevel</CODE> does not         always yield accurate results when called from         non-DriverServicesLib environments (such as deferred tasks).         If <CODE>CurrentExecutionLevel</CODE> returns the wrong         result, DriverServicesLib does the wrong thing.</P>                  <CENTER><TABLE BORDER=0 CELLPADDING=3 WIDTH=550>            <TR>               <td bgcolor="#e6e6e6" align=left>                  <p id=p4><B>IMPORTANT:</B><BR>                  A specific example of this problem is                  <CODE>CallSecondaryInterruptHandler2</CODE>. This                  routine calls <CODE>CurrentExecutionLevel</CODE>                  and uses the result to either:</P>                                    <UL >                     <LI>return an error (if the execution level is                     <CODE>kHardwareInterruptLevel</CODE>), or</LI>                                          <LI>call the secondary interrupt handler                     directly                     (<CODE>kSecondaryInterruptLevel</CODE>), or</LI>                                          <LI>enter secondary interrupt level and run all                     secondary interrupts                     (<CODE>kTaskLevel</CODE>).</LI>                  </UL>                                    <P id=p4>It has never been legal to call                  <CODE>CallSecondaryInterruptHandler2</CODE> from a                  deferred task, however the old                  <CODE>CurrentExecutionLevel</CODE> algorithm masked                  this error. This mislead some developers into                  thinking that it was OK to call                  <CODE>CallSecondaryInterruptHandler2</CODE> from a                  deferred task. When                  <CODE>CurrentExecutionLevel</CODE> was updated to                  return more accurate results, these developers'                  products broke.</P>                                    <p id=p4>When calling                  <CODE>CallSecondaryInterruptHandler2</CODE> from a                  deferred task there are three cases to                  consider.</P>                                    <OL>                     <LI>On older systems (those with the old                     <CODE>CurrentExecutionLevel</CODE> algorithm),                     <CODE>CallSecondaryInterruptHandler2</CODE>                     would treat deferred task level the same as                     system task level. Calling                     <CODE>CallSecondaryInterruptHandler2</CODE> from                     a deferred task would run the handler (and any                     other queued secondary interrupt handlers) and                     return <CODE>noErr</CODE>.</LI>                                          <LI>On CPUs running Mac OS 9.0.4 with the new                     <CODE>CurrentExecutionLevel</CODE> algorithm                     (<a href="../../technotes/tn/tn1104.html">Technote                     1104</A> explains how to detect the presence of                     the new algorithm),                     <CODE>CallSecondaryInterruptHandler2</CODE>                     would return an error if called from a deferred                     task.</LI>                                          <LI>Because this caused some compatibility                     problems, Mac OS 9.1 was changed                     [2529860] to include a special case                     'hack' that restores the old behavior of                     <CODE>CallSecondaryInterruptHandler2</CODE>                     without undoing the fix to                     <CODE>CurrentExecutionLevel</CODE>.</LI>                  </OL>                                    <p id=p4>In summary, your software should not call                  <CODE>CallSecondaryInterruptHandler2</CODE> from a                  deferred task because it defined to be illegal. It                  might work, but that doesn't make it right!</P>               </TD>            </TR>         </TABLE>         </CENTER>                          <P id=p4>Likewise, calling the Deferred Task Manager from a         secondary interrupt yields strange results. Because of its         heritage, the Deferred Task Manager uses the 68K interrupt         mask to detect whether to queue the deferred task or call it         immediately. However, the 68K interrupts mask is zero while         secondary interrupts execute (this is, after all, the         purpose of secondary interrupts), so if you call         <CODE>DTInstall</CODE> from a secondary interrupt the         Deferred Task Manager gets confused and typically executes         the deferred task immediately. This exact behavior is         dependent on the system version and the presence of VM and         is shown in Table 1.</P>                  <CENTER><TABLE BORDER=0 CELLPADDING=0 WIDTH=550>            <TR>               <td align="left">                  <p id=p4>&nbsp;<B>Table 1</B>. Behavior of                  <CODE>DTInstall</CODE> when called from a secondary                  interrupt.</P>                                    <TABLE BORDER=1 WIDTH="100%">                     <TR>                        <TH>                           <P ALIGN=left>Mac OS Version</P>                        </TH>                        <TH>                           <P ALIGN=left>VM On</P>                        </TH>                        <TH>                           <P ALIGN=left>VM Off</P>                        </TH>                     </TR>                     <TR>                        <td align="left">                           <p id=p4>9.0 and earlier</P>                        </TD>                        <td align="left">                           <p id=p4>immediate &bull;</P>                        </TD>                        <td align="left">                           <p id=p4>immediate &bull;</P>                        </TD>                     </TR>                     <TR>                        <td align="left">                           <p id=p4>9.0.1 through 9.0.4</P>                        </TD>                        <td align="left">                           <p id=p4>queued</P>                        </TD>                        <td align="left">                           <p id=p4>immediate &bull;</P>                        </TD>                     </TR>                     <TR>                        <td align="left">                           <p id=p4>9.1 and later</P>                        </TD>                        <td align="left">                           <p id=p4>queued</P>                        </TD>                        <td align="left">                           <p id=p4>queued</P>                        </TD>                     </TR>                  </TABLE>                                                     <ul type="disc">	<li><p id=p4>The deferred task is only executed immediately if it isn't blocked in some other way, for example, if an another deferred task is already running, or paging is unsafe.</p></li></ul>               </TD>            </TR>         </TABLE>         </CENTER>                          <P id=p4>The behavior of <CODE>DTInstall</CODE> explains why         the code in Listing 1 always forces the deferred task to be         queued. By artificially (and temporarily) raising the         interrupt mask to 7, it convinces the Deferred Task Manager         that it is being called from a hardware interrupt, and hence         must queue the deferred task.</P>                  <CENTER><TABLE BORDER=0 CELLPADDING=3 WIDTH=550>            <TR>               <td bgcolor="#e6e6e6" align=left>                  <p id=p4><B>IMPORTANT:</B><BR>                  As you can see from this discussion, the 68K                  interrupt mask is not a good indication of the                  current execution level. In fact, there is no                  general way to determine the current execution                  level. Technote 1104 <a href="../../technotes/tn/tn1104.html">Interrupt-Safe                  Routines</A> has a <a href="../../technotes/tn/tn1104.html#DeterminingExecutionLevel">section</A>                  describing the various common attempts to solve                  this problem, and their various flaws.</P>               </TD>            </TR>         </TABLE>         </CENTER>                          <p id=p4>In summary, problems can arise when you mix native driver         model execution levels with older execution levels. You can         avoid these problems using the techniques described at the         beginning of this Q&amp;A.</P>                 </td>       </tr></table></CENTER><!-- end_content --><!-- begin_date --><H4 ALIGN=center>[Nov 08 2000]</H4><!-- end_date --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/dv/dv45.html%3Fid%3DDTS10001186-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/dv/dv45.html%3Fid%3DDTS10001186-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/dv/dv45.html%3Fid%3DDTS10001186-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --> <hr width=500 align=center> </BODY> </HTML>