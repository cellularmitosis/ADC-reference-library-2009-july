<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><!--Includes revisions to code listings--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note DV19: Drivers &amp; DAs in Need of (a Good) Time</title><meta name="keywords" content="Mac OS 8 Desk Accesory DA accRun _BitClr _BitSet reentrancy"><meta name="Description" content="Technical Note DV19: This Technical Note describes a fewcomplications which appear when a desk accessory or driverneeds periodic time. It also presents a few solutions towork around these problems and make life easier. Complicationsinclude a DA trying to allocate memory or create a windowduring accRun time and reentrancy problems when a DA displaysa modal dialog.">                                       <meta name="categories" content="Devices"><meta name="week-posted" content="Jul 31, 1989 - Aug 4, 1989"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002409" title="Drivers & DAs in Need of (a Good) Time"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/idxAccessibility-date.html" target="_blank">Hardware & Drivers > Accessibility</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxAppleHardware-date.html" target="_blank">Hardware & Drivers > Apple Hardware</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxATA-date.html" target="_blank">Hardware & Drivers > ATA</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxPCIandPCCard-date.html" target="_blank">Hardware & Drivers > PCI and PC Card</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxSCSI-date.html" target="_blank">Hardware & Drivers > SCSI</a></li>
		<li><a href="../../referencelibrary/HardwareDrivers/idxMassStorageDevices-date.html" target="_blank">Hardware & Drivers > Storage</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note DV19</div>
<div id="pageheadsub">Drivers &amp; DAs in Need of (a Good) Time</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                   <td background="images/tnmenubody.gif" width=300 align=left>                        <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->					<p id="menutext"> <a href="#Section1">See Jane's Heap, See accRun...</a><BR><BR> <a href="#Section2">"Houston, We've Got a Re-Entry Problem"</a><BR><BR> <a href="#Section3">One More Thing...</a><BR><BR> <a href="#references">References</a><BR><BR><A href="#downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>		<td width=300 valign="top" align=left>	<!-- begin_intro_text --><P id = "introtext">This Technical Note describes a few complications which rear their rather uglylittle heads when a desk accessory or driver needs periodic time.  It alsopresents a few solutions to work around these problems and make life easier, atleast periodically.</p><!-- end_intro_text --><!-- begin_date --><h3>Updated: [Aug 01 1989]</h3><!-- end_date -->                </TD>             </TR>          </TABLE> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><a name="Section1"></a><h2>See Jane's Heap, See accRun...</h2><p>MultiFinder is our friend.  Our friend, that is, until a driver or deskaccessory is called when in an unknown heap.  Then things get complicated.When a driver is called at <code>accRun</code> time under MultiFinder, one cannever be exactly sure of the heap in which it will find itself.  When a DAreceives an open call, or any other messages besides accRun, under MultiFinder,the system heap is switched in as the current heap.* (*NOTE: This is trueunless a user "force" switched the DA into an application heap by holding downthe Option key when opening the DA. In this particular case, the application'sheap will be switched in.)</p><p>During the <code>accRun</code> cycle, whatever heap is currently switched in willbe the driver's heap as well, and surprise, surprise, that heap may not be thesystem heap.</p><p>This situation could be a real problem if your DA allocates memory or creates awindow during that <code>accRun</code> period.  Why?  What if the application whoseheap the DA is in suddenly slips a bit and decides to call it quits before theDA?  You'd be stuck with allocated blocks in a zone that suddenly doesn'texist.  Eventually, your DA would go belly up, and whoever bought your DA ordriver would be on the phone to a local dealer demanding retribution.</p><p>So what's the solution?  The easiest way out of this situation is to simply notdo any memory allocation or display any newly created windows or dialog boxesduring <code>accRun</code>.  So what if it's a cop out, it's easy to implement.</p><p>Being the good souls that we are in DTS, we're not going to leave you hangingthere with nowhere to go.  We prefer you heed the previous solution, but werealize that there may be rare times when you might need a window during<code>accRun</code>.  We've devised a solution, albeit a bit strange, but onethat's easy enough to use.</p><p>The basic problem is that the DA needs to know in which heap it should beallocating it's new storage.  It would be nice if the DA knew in which heap itwas opened and could allocate the new stuff there, and it's easy enough to do,so here is what you need to know to do it.</p><p>Switching from the current heap to the "preferred" heap is fairly simple.  Whenyou feel the need to allocate memory or create a window during <code>accRun</code>,first save the current heap zone with <code>_GetZone</code>.  Now, get the handleto the actual driver for the DA.  You can do this by looking at the<code>dCtlDriver</code> offset of the DAs device control entry (DCE).  The DCE isalways in register <code>A1</code> when a control call to the DA is made.  Use<code>_HandleZone</code> on the handle to the DAs driver to give you a pointer tothe heap in which the driver resides.  Pass that value to <code>_SetZone</code>.Once you have switched in the correct heap, do whatever memory allocation orwindow creation you need, and then make sure to set the current zone back tothe saved zone with <code>_SetZone</code>.</p><p>The following short routine, borrowed, in part, from an MPW sample DA, showsone way to set up the correct zone.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>pascal short DRVRControl(CntrlParam *ctlPB, DCtlPtr dCtl){    extern    void    doCtlEvent();    extern    void    doPeriodic();    THz     driverZone;    THz    savedZone;    /*     * The current grafPort is saved &amp; restored by the Desk Manager     */    switch (ctlPB-&gt;csCode) {        case ACCEVENT:            /* accEvent */            HLock(dCtl-&gt;dCtlStorage);    /* Lock handle since it will                               be dereferenced */            doCtlEvent( *((EventRecord **) &amp;ctlPB-&gt;csParam[0]),                    (Globals *)(*dCtl-&gt;dCtlStorage));            HUnlock(dCtl-&gt;dCtlStorage);            break;        /*         * Hey!  Look here!         */        case ACCRUN:                /* periodicEvent */            savedZone = GetZone();    /* save a pointer to current heap     */            driverZone = HandleZone(dCtl-&gt;dCtlDriver); /* get the heap our                                       driver resides in */            SetZone(driverZone);        /* use that as the current heap */            doPeriodic(dCtl);        /* go do your periodic stuff */            SetZone(savedZone);        /* restore the old heap */            break;        default:            break;    }    return 0;}</pre>	</TD></TR></TABLE></CENTER><p>One note of caution:  Watch out for changes in the resource chain when in<code>accRun</code>, as it may not be what you expect when MultiFinder is active.</p><P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>"Houston, We've Got a Re-Entry Problem"</h2><p>Displaying an alert or other modal dialog box is a common occurrence inMacintosh programming, even in DAs.  But since DAs are not applications, modaldialog boxes pose other problems when displayed under MultiFinder.  Thisproblem is reentrancy.  If your DA or driver asks for periodic time, itcontinues to receive it when it display a modal dialog box<i>.</i>  Bummer.Your modal dialog routine might even be called again, and again, and again, andagain, and you get the idea.  This problem occurs because <code>_ModalDialog</code>calls the <code>_SystemTask</code> trap, which in turn calls drivers which askedfor time, including yours.  There is no internal check by the System for thispossible problem, so it's up to you and your driver to be prepared.</p><p>We realize that some DAs and drivers expect, and depend upon, thisfunctionality.  We're just  taking this opportunity to inform the rest of youthat this is a situation about which you should be aware.</p><p>An easy way to avoid this issue is to simply tell the Device Manager not tocall your DA when you display an alert or other modal dialog box.  Rememberthat <code>dNeedTime</code> bit you set when you opened your DA so you'd get time?Just clear it before your call to <code>_Alert</code> or <code>_ModalDialog</code>.  Aslong as the bit is clear, your DA does not receive any periodic time.  Rememberto reset it once you are done with your <code>_Alert</code> or <code>_ModalDialog</code> trap call.</p><p>The <code>_BitClr</code> and <code>_BitSet</code> Toolbox utilities are a mite on thebrain-damaged side, and the bits are the reverse of conventional 680x0 numbering (numbering starts from the high-order bit instead of the low-order bit). This difference necessitates a calculation for figuring out the correct bit as shown in the following example:  (I think whoever wrote these Toolbox utilities did this just to see if anyone was paying attention.)</p><p><b>Pascal</b></p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>BitClr(@dce^.dCtlFlags, 2);        { clear bit 5/dNeedTime bit. IM I-471 }BitSet(@dce^.dCtlFlags, 2);        { set bit 5/dNeedTime bit.  IM I-471 }or the kind of more efficient, but less efficient than C:CONSTdNeedTime = $2000;            { Bit 5 of high-order byte of word }dce^.dCtlFlags := BAND(dce^.dCtlFlags, BNOT(dNeedTime));    { clear bit 5/dNeedTime bit. }dce^.dCtlFlags := BOR(dce^.dCtlFlags, dNeedTime);        { set bit 5/dNeedTime bit. }</pre>	</TD></TR></TABLE></CENTER><p><b>C</b></p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>BitClr(&amp;dce-&gt;dCtlFlags, 2);        /* clear bit 5/dNeedTime bit. IM I-471 */BitSet(&amp;dce-&gt;dCtlFlags, 2);        /* set bit 5/dNeedTime bit.  IM I-471 */</pre>	</TD></TR></TABLE></CENTER><p>or the somewhat more efficient:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>#define dNeedTime 0x2000        /* Bit 5 of high-order byte of word */dce-&gt;dCtlFlags &amp;= ~dNeedTime;    /* clear bit 5/dNeedTime bit. */dce-&gt;dCtlFlags |= dNeedTime;    /* set bit 5/dNeedTime bit.  */</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="Section3"></a><h2>One More Thing...</h2><p>We cannot overemphasize our viewpoint that if you are writing a DA and theresult looks and acts more like an application, then <b>write an application</b> instead and save us all a lot of headaches.</p><P><A HREF="#top">Back to top</A></P><a name="references"></a><h2>References</h2><P><i>Inside Macintosh</i>, Volume II, The Memory Manager</p><P>Technical Note M.TB.MultifinderMisc -- <u><A HREF = "../tb/tb_35.html">MultiFinder Miscellanea</a></u></p><P><A HREF="#top">Back to top</A></P>         <a name="downloads"></a>         <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center>                                    <img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (44K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/dv_19.pdf">Download</A></P>               </TD>            </TR>         </TABLE>         <BR>                  <P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/dv/dv_19.html%3Fid%3DDTS10002409-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/dv/dv_19.html%3Fid%3DDTS10002409-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/dv/dv_19.html%3Fid%3DDTS10002409-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --><hr width=500 align=center></BODY></HTML>