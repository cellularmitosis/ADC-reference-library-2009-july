<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Installing a Persistent VBL Task (IM: Pr)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING86></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Processes-85.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Processes-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Processes-171.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Processes-87.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html"><B>Inside Macintosh:</B></A> <A HREF="Processes-2.html"><B>Processes</B></A><BR><DD><A HREF="Processes-74.html"><B>Chapter 4 - Vertical Retrace Manager</B></A> / <A HREF="Processes-81.html"><B>Using the Vertical Retrace Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING86-0></A>
<H2><A NAME=MARKER-9-127></A>Installing a Persistent VBL Task</H2>
 <A NAME=MARKER-2-128></A><A NAME=MARKER-2-129></A>A <B>persistent VBL task</B> continues to be executed even when the Process Manager switches out the application that installed it and that application is no longer in control of the CPU. If you want to install a persistent system-based VBL task, you need to load its VBL task record into the system partition. (Slot-based VBL tasks are always persistent, no matter where you put the task record.) <A HREF=#MARKER-9-131>Listing 4-15</A> illustrates a simple way to load a VBL task record into the system heap.<A NAME=MARKER-2-130></A><P>
<B>Listing 4-15  <A NAME=MARKER-9-131></A>Installing a persistent VBL task</B><P>
<PRE>
FUNCTION InstallPersistentVBL (VAR theVBLRec: VBLTask): OSErr;
TYPE
   ProcPtrPtr = ^ProcPtr;                       {a pointer to a ProcPtr}
CONST
   kJMPInstr = $4EF9;                           {this is an absolute JMP}
   kJMPSize = 6;                                {size of an absolute JMP}
VAR
   myErr:      OSErr;
   SysHeapPtr: Ptr;
   tempPtr:    Ptr;
BEGIN
   SysHeapPtr := NewPtrSys(kJMPSize);           {get a block in system heap}
   myErr := MemError;
   IF myErr &lt;&gt; noErr THEN                       {make sure we have the block}
      BEGIN
         InstallPersistentVBL := myErr;
         Exit(InstallPersistentVBL);
      END;
   IntegerPtr(SysHeapPtr)^ := kJMPInstr;        {move in the JMP instruction}
   tempPtr := Ptr(ORD(SysHeapPtr)+SizeOf(Integer));
   ProcPtrPtr(tempPtr)^ := theVBLRec.vblAddr;   {move in the JMP address}
   theVBLRec.vblAddr := ProcPtr(SysHeapPtr);    {point record at sys heap}
   InstallPersistentVBL := VInstall(@theVBLRec);{install the VBL task record}
END;
</PRE>
 The <CODE>InstallPersistentVBL</CODE> function defined in <A HREF=#MARKER-9-131>Listing 4-15</A> allocates enough bytes in the system heap to hold an integer that encodes an assembly-language <CODE>JMP</CODE> instruction together with the absolute address to which to jump. It loads into that space the assembly-language instruction and the address of the original VBL task, which is extracted from the VBL task record passed to it as a parameter. Then <CODE>InstallPersistentVBL</CODE> replaces the address of the original VBL task in that record with the address of the block in the system heap. The net result is that the <CODE>vblAddr</CODE> field of the VBL task record now contains an address in the system partition, making the VBL task persistent.<A NAME=MARKER-2-132></A><P>
</BLOCKQUOTE><P>
<HR>
<center>
<A HREF="Processes-85.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Processes-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Processes-171.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Processes-87.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Processes-3.html">&copy; Apple Computer, Inc.</A><br>17 JUN 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
