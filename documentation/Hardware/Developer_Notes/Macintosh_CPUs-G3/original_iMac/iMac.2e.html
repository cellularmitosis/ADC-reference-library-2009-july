<HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><script language="JavaScript" src="frametest.js"></script><TITLE> What Is Different</TITLE></HEAD><BODY BGCOLOR="#ffffff"><a name="top"></a><!-- start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!-- start of path --><table border="0" cellpadding="0" cellspacing="2" width="432">		<tr>	<td scope="row"><font face="Geneva,Helvetica,Arial" size="1">	<b>PATH<img src="../../../images/space.gif" width="6" height="12"></b><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Documentation</a> &gt; <!-- a href="" target="_top" -->Hardware<!-- /a --> 	<b>&gt;</b> Original iMac Developer Note		</font></td>	</tr>	</table><br><!-- end of path --><DIV><!-- top navigation --><P><A HREF="iMac.27.html"><img src="images/up.gif" border="0" alt="Up"></A> <A HREF="iMac.2d.html"><img src="images/previous.gif" border="0" alt="Previous"></A> <A HREF="iMac.2f.html"><img src="images/next.gif" border="0" alt="Next"></A> <!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></a></div><!-- end top navigation --><hr><H1 CLASS="H1.Heading1"><A NAME="pgfId=3414"> </A>What Is Different<A NAME="marker=3413"> </A></H1><P CLASS="T1.Text1"><A NAME="pgfId=3415"> </A>Even though ROM-in-RAM involves a fundamental change to the construction of the product-specific part of the Mac OS, the changes in the code and its execution are not that large. Many components are in changed locations, but their functions with respect to boot time and run time have not greatly changed. Many Mac OS components remain untouched. </P><DIV><H2 CLASS="H2nb.Heading2"><A NAME="pgfId=3417"> </A>Interrupt Handling<A NAME="marker=3416"> </A></H2><P CLASS="T1.Text1"><A NAME="pgfId=3418"> </A>Interrupt handling is very different with the NewWorld approach. The interrupt code has been rewritten to allow for dynamic creation of the interrupt layout. The new code has two features that did not exist in the old code. One is that interrupt latency has been reduced to such an extent as to make it negligible. The other is that the interrupt handling code no longer requires changes to support a new machine, unless it has new interrupt controller hardware. The description of the interrupt layout is now part of an Open Firmware interrupt tree that is interlaced within the Open Firmware device tree. The Trampoline code uses this interrupt tree to build the Mac OS native interrupt tree.</P></DIV><DIV><H2 CLASS="H2nb.Heading2"><A NAME="pgfId=3420"> </A>Outmoded Resources <A NAME="marker=3419"> </A></H2><P CLASS="T1.Text1"><A NAME="pgfId=3421"> </A>Prior to NewWorld, many resources in the ROM exist in the System Folder as well, often as replacements that fix or enhance those in the ROM, but sometimes because the ROM resources have not yet been removed from the ROM. With the NewWorld approach, any resources that are not needed early in the boot sequence are no longer in the ToolBox ROM Image, and only the resources from the System Folder are in use.</P></DIV><DIV><H2 CLASS="H2nb.Heading2"><A NAME="pgfId=3423"> </A>RAM Footprint<A NAME="marker=3422"> </A></H2><P CLASS="T1.Text1"><A NAME="pgfId=3424"> </A>NewWorld puts the ToolBox ROM Image in RAM, and marks it read-only. Although the image is 4 megabytes in size, not all of it is in use. The portion that is not used is returned to Mac OS for use as part of system RAM. At the time this document was written, less than 3 megabytes of the 4 megabyte ToolBox ROM Image are in use, allowing more than 1 megabyte to be returned to Mac OS. </P></DIV><DIV><H2 CLASS="H2nb.Heading2"><A NAME="pgfId=3426"> </A>RTAS<A NAME="marker=3425"> </A></H2><P CLASS="T1.Text1"><A NAME="pgfId=3427"> </A>Certain hardware devices differ from machine to machine, but provide similar functions. RTAS ( Run-time Abstraction Services) provides such hardware-specific functions, including functions for accessing the real-time clock, non-volatile RAM (NV-RAM), restart, shutdown, and PCI configuration cycles. The I/O primitives for these functions in the ToolBox ROM Image for NewWorld use RTAS.</P></DIV><DIV><H2 CLASS="H2nb.Heading2"><A NAME="pgfId=3429"> </A>NV-RAM<A NAME="marker=3428"> </A></H2><P CLASS="T1.Text1"><A NAME="pgfId=3430"> </A>Instead of using hard-coded offsets to locations in NV-RAM for Mac OS NV-RAM and other information, the Trampoline code breaks NV-RAM into variable-sized partitions that are used by Mac OS, Open Firmware, and any other client. PRAM resides in the Mac OS partition. The partitioning scheme is part of the CHRP specification.</P></DIV><DIV><H2 CLASS="H2nb.Heading2"><A NAME="pgfId=3432"> </A>NanoKernel<A NAME="marker=3431"> </A></H2><P CLASS="T1.Text1"><A NAME="pgfId=3433"> </A>The previous version of the NanoKernel has code that is processor-specific to create data structures. Under NewWorld, the Trampoline code creates these data structures from information in the Open Firmware Device Tree.</P><P CLASS="T1.Text1"><A NAME="pgfId=3434"> </A>NanoKernel is typically no longer changed to support a new CPU. Support for new processors has moved to POST, which is responsible for configuring all processor-specific registers. Run-time cache control is part of RTAS.</P></DIV><DIV><H2 CLASS="H2nb.Heading2"><A NAME="pgfId=3436"> </A>Startup Disk Control Panel<A NAME="marker=3435"> </A></H2><P CLASS="T1.Text1"><A NAME="pgfId=3667"> </A>Open Firmware now bears responsibility for locating a startup device. This is very different from previous Mac OS systems where the Mac OS ROM had responsibility for locating the startup device. On the iMac computer, the Mac OS ROM image itself comes from the startup disk, so decisions regarding startup device must be made earlier in the startup process. Open Firmware recreates as much as possible the user experience of earlier systems but the implemention is very different.</P><P CLASS="T1.Text1"><A NAME="pgfId=3718"> </A>Previous systems stored the user's selected startup device in PRAM. The startup device was set in PRAM when the user selected a device in the Startup Disk control panel. This device was honored by the Mac OS ROM unless the selected device was unavailable or was overridden by the user.</P><P CLASS="T1.Text1"><A NAME="pgfId=3719"> </A>The startup disk routine for the iMac, rather than setting Mac OS PRAM, sets an Open Firmware config variable called <TT CLASS="cv">boot-device</TT>. This setting is honored by Open Firmware unless the selected device was unavailable or was overridden by the user. </P><P CLASS="T1.Text1"><A NAME="pgfId=3740"> </A>The following keys can be used to override the selected startup device.</P><UL><LI CLASS="B1.Bullet1"><A NAME="pgfId=3746"> </A>Key combination Command-Option-Shift-Delete: ignore the boot-device setting and scan for alternate devices.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3747"> </A>C key: force the internal CD-ROM drive to be the startup device</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3748"> </A>D key: force the internal hard disk to be the startup device</LI></UL><P CLASS="T1.Text1"><A NAME="pgfId=3723"> </A>Once Open Firmware locates a startup device and successfully loads a Mac OS ROM, image it passes information about the chosen device in the <TT CLASS="cv">bootpath</TT> variable. This information, rather than that previously set in PRAM, is subsequently used by the Mac OS ROM to locate the device containing the startup System Folder. </P><P CLASS="I.Important"><A NAME="pgfId=3724"> </A>The previous API for controlling the startup device selection, using <TT CLASS="cv">_GetDefaultStartup</TT> and<TT CLASS="cv"> _SetDefaultStartup</TT>, is not effective on the iMac.  </P></DIV><DIV><H2 CLASS="H2nb.Heading2"><A NAME="pgfId=3439"> </A>Open Firmware and the Device Tree<A NAME="marker=3438"> </A></H2><P CLASS="T1.Text1"><A NAME="pgfId=3440"> </A>NewWorld relies heavily on a functioning Open Firmware with a complete device tree.</P></DIV><DIV><H2 CLASS="H2nb.Heading2"><A NAME="pgfId=3442"> </A>Interrupt Layout<A NAME="marker=3441"> </A></H2><P CLASS="T1.Text1"><A NAME="pgfId=3443"> </A>The interrupt layout is determined by information in the device tree. An interrupt tree overlays the other information in the device tree to describe how the interrupts are configured. The Trampoline code traverses this device tree interrupt tree and builds data structures that are used to dispatch interrupts. The device tree interrupt tree is defined in the <I CLASS="italics">Open Firmware Recommended Practice: Interrupt Mapping</I>. It is not necessary to change any of the interrupt dispatching code, either 68K or native. All the necessary information is retrieved from the device tree. </P><P CLASS="T1.Text1"><A NAME="pgfId=3444"> </A>This interrupt dispatch code has drastically reduced latency times as compared to all previous PCI Macintosh computers.</P></DIV><DIV><H2 CLASS="H2nb.Heading2"><A NAME="pgfId=3446"> </A>Machine Identification<A NAME="marker=3445"> </A></H2><P CLASS="T1.Text1"><A NAME="pgfId=3447"> </A>Applications can find out which machine they are running on by calling the Gestalt Manager. The gestaltMachineType value returned for the iMac is 406 (196 hexadecimal). </P><P CLASS="T1.Text1"><A NAME="pgfId=3448"> </A>Because NewWorld uses the same Universal and ProductInfo tables for all computer models that it runs on, those computers all have the same Box Flag. All those computers use the same enablers, and no patches are made to the ToolBox ROM Image, so sharing the same Box Flag is not an issue for those areas. <A NAME="marker=3449"> </A></P><P CLASS="I.Important"><A NAME="pgfId=3450"> </A>Programs such as control panels and installers that use Box Flag to verify that this is a valid CPU on which to execute need to be changed to verify the existence of the hardware they require. Developers should look for the features they need, rather than reading the Box Flag and then making assumptions about the computer's features.  </P><P CLASS="T1.Text1"><A NAME="pgfId=3456"> </A><A NAME="marker=3454"> </A><A NAME="marker=3455"> </A>Asset management software that reports the kind of machine it is run on should check the name registry for the value of the property at <TT CLASS="cv">Devices:device-tree:model</TT>. For the current iMac, the property value is <TT CLASS="cv">iMac,1</TT>. </P></DIV><HR>\xA9 1998 Apple Computer, Inc. <P><A HREF="iMac.27.html"><img src="images/up.gif" border="0" alt="Up"></A> <A HREF="iMac.2d.html"><img src="images/previous.gif" border="0" alt="Previous"></A> <A HREF="iMac.2f.html"><img src="images/next.gif" border="0" alt="Next"></A>  <!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!-- document.write(frameLink);//--></script><!-- end Show/Hide frames --></a></P> <!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>