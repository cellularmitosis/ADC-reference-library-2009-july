<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Using ATP </TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING74></A>
<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->

<!-- Main Body -->

<CENTER>
<P>
<A HREF="NetworkingWOT-73.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="NetworkingWOT-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="NetworkingWOT-491.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A>  <A HREF="NetworkingWOT-75.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html"><B>Inside Macintosh:</B></A> <A HREF="NetworkingWOT-2.html"><B>Networking With Open Transport </B></A> / <A HREF="NetworkingWOT-10.html"><B>Part 1 - Open Transport Essentials</B></A><BR><DD><A HREF="NetworkingWOT-72.html"><B>Chapter 17 - AppleTalk Transaction Protocol (ATP)</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING74-0></A>
<H1>Using ATP </H1>
 In order for two applications to use ATP, each application must have opened and bound an ATP endpoint. The requester initiates a transaction by making a request. When the responder receives the request, it accepts the request, formulates a response that includes any data required by the requester, and sends that response to the requester. When the requester receives the response, the transaction is complete. You can define how often ATP is to retry each request and how long it is to wait between each retry attempt by using the retry count and interval options, described in <A HREF=#MARKER-9-37>"Specifying ATP Options"</A>.<P>
<A NAME=HEADING74-2></A>
<H2><A NAME=MARKER-13-30></A>At-Least-Once and Exactly-Once Transactions</H2>
 In the course of a transmission, a request might be lost, a response might be lost or delayed, or the responder might fail to acknowledge or accept a request. In any of these situations, the transaction cannot complete. To complete the transaction and assure <A NAME=MARKER-13-31></A>reliable delivery of data, ATP is responsible for waiting a predetermined amount of time and then retrying the request until it is able to conclude the transaction. If it cannot conclude the transaction, ATP must let the requester know that the attempt has failed. In order to perform these services, ATP supports two types of transactions: at-least-once transactions and exactly-once transactions. <P>
<UL>
<P><LI>An at-least-once transaction ensures that the responder receives every request directed to it at least once, but this does not prevent the responder from receiving a request more than once. These are also referred to as <A NAME=MARKER-13-32></A><I>ALO transactions</I>.
<P><LI>An exactly-once transaction ensures that the responder receives a specific request only once. These are also referred to as <I><A NAME=MARKER-13-33></A>XO transactions</I>. PAP uses this type of ATP transaction. <P>
</UL>
 Open Transport ATP provides XO transaction support for a request transaction when you set the <A NAME=MARKER-13-38></A><CODE>T_ACKNOWLEDGED</CODE> bit in the option flags for the <CODE>OTSndURequest</CODE> function. This kind of support is appropriate in those cases where harm could be done if a request is satisfied multiple times; for example, if you are appending data to the end of a file.<P>
 In those cases where no harm is done if a request is satisfied multiple times (for example, when the requester asks the responding node to identify itself) you can select ALO transactions by clearing the <CODE>T_ACKNOWLEDGED</CODE> bit in the option flags for the <CODE>OTSndURequest</CODE> function. <P>
<A NAME=HEADING74-8></A>
<H2><A NAME=MARKER-13-35></A>Sending and Receiving ATP Data</H2>
 Typically, a requester sends a small amount of data requesting the remote endpoint to take some action or to send back data in reply. The amount of data that the responder can reply with can be quite large. A requester can send only a single ATP packet of 578 bytes, but a responder can return up to eight packets of 578 bytes each, totalling a maximum of 4624 bytes. ATP does not support zero-length packets.<P>
 To accomodate the restrictions that a particular network may place on sending that much data at a time, ATP uses the <A NAME=MARKER-13-36></A><CODE>T_MORE</CODE> flag to communicate to the awaiting requester endpoint when all of the reply data has been accumulated. A single reply may have up to eight packets, and each packet in the reply except for the very last has the <CODE>T_MORE</CODE> flag set. The reply data is held at the receiving requester endpoint until a packet arrives that does not have the <CODE>T_MORE</CODE> flag set. When this happens, ATP knows that all the reply data has arrived, and it releases the entire reply to the awaiting requester endpoint. <P>
<A NAME=HEADING74-11></A>
<H2><A NAME=MARKER-9-37></A>Specifying <A NAME=MARKER-13-38></A>ATP Options</H2>
 There are several ATP-specific options and you can use the generic Open Transport options, <A NAME=MARKER-13-145></A><CODE>OPT_INTERVAL</CODE> and <A NAME=MARKER-13-144></A><CODE>OPT_RETRYCNT</CODE>. <A HREF=#MARKER-9-1>Table 17-1</A> summarizes their definitions and default values. All of these options, except <CODE>ATP_OPT_TRANID</CODE>, can be set both globally (for the endpoint setting the option) with the <CODE>OptionManagement</CODE> function and locally by setting option flags for an individual transaction. The <CODE>ATP_OPT_TRANID</CODE> option can only be set globally.<P>

<B>Table 17-1   ATP option definitions and default values</B>
<TABLE BORDER="0" CELLPADDING=3>
<CAPTION><A NAME=MARKER-9-1></A></CAPTION>
<TH>Option<TH>Default<TH>Description<TR>
<TD><CODE>OPT_RETRYCNT</CODE><TD>8 retries<TD>Sets the number of times ATP retries a request before returning an error to the client. <TR>
<TD><CODE>OPT_INTERVAL</CODE><TD>2 seconds<TD>Sets the interval for ATP to wait between retries.<TR>
<TD><CODE><A NAME=MARKER-13-2></A>ATP_OPT_RELTIMER&nbsp;&nbsp;</CODE><TD>30 seconds&nbsp;&nbsp;<TD>Sets the amount of time the responder must wait for a transaction release packet before it purges a request entry from its transactions list. Acceptable values are 0 (30 seconds), 1 (1 minute), 2 (2 minutes), 3 (4 minutes), 4 (8 minutes). <TR>
<TD><CODE><A NAME=MARKER-13-3></A>ATP_OPT_REPLYCNT</CODE><TD>8 replies<TD>Specifies the number of replies (1-8) to expect in reply to a request.<TR>
<TD><CODE><A NAME=MARKER-13-4></A>ATP_OPT_DATALEN</CODE><TD>578 bytes<TD>Sets maximum individual packet size.<TR>
<TD><CODE><A NAME=MARKER-13-141></A>ATP_OPT_TRANID</CODE><TD><CODE>true</CODE><TD>Requests a transaction ID. </TABLE>
<P>
<A NAME=HEADING74-13></A>
<H3>The Retry Count and Interval Options</H3>
 After transmitting a transaction request, ATP waits for the interval of time specified by the requester's defined <CODE>OPT_INTERVAL</CODE> option (default is 2 seconds). If the requester still hasn't received a response from the responder, it retransmits the request. It repeats this process for the number of times defined by the requester's <CODE>OPT_RETRYCNT</CODE> option (default is 8 retries). Once these maximums have been reached without any response, ATP informs the requester that the responder is unavailable. <P>
<A NAME=HEADING74-15></A>
<H3>The Release Timer Option</H3>
 With ALO transactions, a responder can receive duplicate requests; with XO transactions, ATP uses additional processing to ensure that a responder receives a request only once. To handle XO transactions safely, the responder maintains a transactions list of all recently received requests. When it receives a request, the responder searches through this list to determine whether it is a new request or a duplicate request. If the request is new, the responder inserts it in the transactions list, time stamping the entry with its time of insertion. If it is a duplicate request and a reply has gone out, ATP automatically retransmits the reply without the intervention of the responder application. If it is a duplicate request and a reply has not yet been sent out, ATP discards the request. <P>
 When a requester receives a reply from the responder, it sends a transaction release packet to the responder to signal that the transaction has successfully completed, and the responder can now release the transaction from its transactions list. If this transaction release packet is lost, however, the responder would never be able to release the transaction from its list. Because the responder time stamped each new request when it inserted the request into its transactions list, the responder can check the list periodically and eliminate all requests that are older than the time defined by the <CODE>ATP_OPT_RELTIMER</CODE> option (default is 30 seconds), assuming that these requests remain in the list because the transaction release packet has been lost.<P>
<A NAME=HEADING74-18></A>
<H3>Other ATP-Specific Options</H3>
 When a reply starts to arrive, the requester needs to know how many packets are in a given reply so that it knows when to stop waiting for more packets. The <CODE>ATP_OPT_REPLYCNT</CODE> option allows you to define a number between 0 and 8 (the default is 8 packets). You can set this globally for the endpoint, with the <CODE>OptionManagement</CODE> function, or locally for an individual request. <P>
 The <CODE>ATP_OPT_DATALEN</CODE> option allows you to set the maximum length of an individual packet up to a length of 578 bytes (the default). In most cases, you can leave this at the default. PAP servers, which use a maximum packet size of 512 bytes, can use this option to restrict the ATP packet size. You can set this globally for the endpoint, with the <CODE>OptionManagement</CODE> function, or locally for an individual request.<P>
 The <CODE>ATP_OPT_TRANID</CODE> option is a Boolean value that, when set to <CODE>true</CODE>, requests Open Transport to add an option to every request that contains the ATP transaction ID. You can only set this option globally, with the <CODE>OptionManagement</CODE> function; you cannot set it locally. <A NAME=MARKER-13-41></A><P>
<A NAME=HEADING74-22></A>
<H2>Using the <A NAME=MARKER-13-42></A>ATP Packet Header User Bytes</H2>
 The first 4 bytes of the ATP packet header contain information that allows Open Transport to identify whether an <A NAME=MARKER-13-43></A>ATP packet is a request or a response, to specify the sequential position of a response packet, and to identify the transaction. The second 4 bytes of the header are called <I>user bytes</I>, and are available for your use. Your application could use the user bytes, for example, to create a simple header for a higher-level protocol. <P>
 ATP takes the first 4 bytes of data that the requester specifies and places them in the user bytes portion of the outgoing request. If you do not specify at least 4 bytes of data in the request, ATP pads the user bytes with zeros. <P>
 On the responder side, ATP takes the data in the first reply packet's user bytes and puts them into the first 4 bytes of the reply packet's data. ATP ignores the user bytes in all reply packets except for the first packet. <P>
 For more information on ATP packets and their header field definitions, refer to <I>Inside AppleTalk</I>, second edition. <P>
<A NAME=HEADING74-27></A>
<H2><A NAME=MARKER-13-139></A><A NAME=MARKER-9-45></A>Using General Open Transport Functions With ATP</H2>
 This section describes any special considerations you must take into account for Open Transport functions when you use them with the Open Transport ATP implementation. You must be familiar with the descriptions of these functions in the chapter "Endpoints"<A HREF=NetworkingWOT-26.html#MARKER-9-43></A> in this book before reading this section. <P>
<A NAME=HEADING74-29></A>
<H3><A NAME=MARKER-13-46></A><A NAME=MARKER-9-47></A>OTSndURequest</H3>
 A client of a connectionless transaction-based protocol such as ATP can use the <CODE>OTSndURequest</CODE> function to send an ATP request packet to an ATP responder endpoint.<P>
 To indicate XO transactions, set the <A NAME=MARKER-13-38></A><CODE>T_ACKNOWLEDGED</CODE> bit in the <CODE>OTSndURequest</CODE> function's <CODE>reqFlags</CODE> parameter. To indicate ALO transactions, clear this bit. ATP request packets can have up to 578 bytes, and zero-length TSDUs are not supported.<P>
<A NAME=HEADING74-32></A>
<H3><A NAME=MARKER-13-49></A><A NAME=MARKER-9-50></A>OTRcvURequest</H3>
 A client of a connectionless transaction-based protocol such as ATP can use the <CODE>OTRcvURequest</CODE> function to receive an incoming ATP request packet from an ATP requester endpoint.<P>
 On XO transaction packets, the <A NAME=MARKER-13-38></A><CODE>T_ACKNOWLEDGED</CODE> bit in the <CODE>OTRcvURequest</CODE> function's <CODE>reqFlags</CODE> parameter is set. On ALO transactions, this bit is clear. ATP request packets can have up to 578 bytes, and zero-length TSDUs are not supported.<P>
<A NAME=HEADING74-35></A>
<H3><A NAME=MARKER-13-52></A><A NAME=MARKER-9-53></A>OTSndUReply</H3>
 A client of a connectionless transaction-based protocol such as ATP can use the <CODE>OTSndUReply</CODE> function to send an ATP reply packet to an ATP requester endpoint. ATP reply packets can have up to eight packets (4624 bytes), and zero-length TSDUs are not supported.<P>
<A NAME=HEADING74-37></A>
<H3><A NAME=MARKER-13-54></A><A NAME=MARKER-9-55></A>OTRcvUReply</H3>
 A client of a connectionless transaction-based protocol such as ATP can use the <CODE>OTRcvUReply</CODE> function to receive an incoming ATP reply packet from an ATP requester endpoint. ATP reply packets can have up to eight packets (4624 bytes), and zero-length TSDUs are not supported.<P>
 <A NAME=MARKER-13-56></A><P>
 <P>
<HR>
<B>Subtopics</B>
<B><!-- TOC --><DL>
<DT><A HREF="NetworkingWOT-74.html#HEADING74-2">At-Least-Once and Exactly-Once Transactions</A>
<DD>
<DT><A HREF="NetworkingWOT-74.html#HEADING74-8">Sending and Receiving ATP Data</A>
<DD>
<DT><A HREF="NetworkingWOT-74.html#HEADING74-11">Specifying ATP Options</A>
<DD>
<DT><A HREF="NetworkingWOT-74.html#HEADING74-13">The Retry Count and Interval Options</A>
<DD>
<DT><A HREF="NetworkingWOT-74.html#HEADING74-15">The Release Timer Option</A>
<DD>
<DT><A HREF="NetworkingWOT-74.html#HEADING74-18">Other ATP-Specific Options</A>
<DD>
<DT><A HREF="NetworkingWOT-74.html#HEADING74-22">Using the ATP Packet Header User Bytes</A>
<DD>
<DT><A HREF="NetworkingWOT-74.html#HEADING74-27">Using General Open Transport Functions With ATP</A>
<DD>
<DT><A HREF="NetworkingWOT-74.html#HEADING74-29">OTSndURequest</A>
<DD>
<DT><A HREF="NetworkingWOT-74.html#HEADING74-32">OTRcvURequest</A>
<DD>
<DT><A HREF="NetworkingWOT-74.html#HEADING74-35">OTSndUReply</A>
<DD>
<DT><A HREF="NetworkingWOT-74.html#HEADING74-37">OTRcvUReply</A>
<DD>
</DL>
</B>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="NetworkingWOT-73.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="NetworkingWOT-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="NetworkingWOT-491.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A>  <A HREF="NetworkingWOT-75.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="NetworkingWOT-4.html">&copy; Apple Computer, Inc.</A><br>15 JAN 1998<P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML> 
