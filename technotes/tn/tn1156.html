<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-05-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1156: Scribbling Into AWT Components</title>    <meta name="keywords" content="Mac OS 8 Java drawing AWT Components QuickDraw DrawingSurface WindowPtr">    <meta name="Description" content="Technical Note TN1156: This Technical Note  describes how
to draw into a java 1.1.x AWT Component by means other than the Java
AWT Graphics API. It uses as an example calling on QuickDraw
to draw inside the AWT Component on Mac OS Classic."><meta name="categories" content="Java"><meta name="week-posted" content="Feb 1, 1999 - Feb 5, 1999"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002995" title="Scribbling Into AWT Components"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxJava-date.html">Java</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/Java/idxGraphicsImaging-date.html" target="_blank">Java > Graphics & Imaging</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1156</div>
<div id="pageheadsub">Scribbling Into AWT Components</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left">   <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">     <tr><td width=300 valign="top" align=left scope="row">    <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>            <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>  </tr>  <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left> <span id="menutitle">CONTENTS   <br>  <br> </span>   </td>  </tr>  <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left> <!-- begin_toc --><P id = "menutext"><A HREF = "#Section1">Introduction to Impure         Drawing</A><BR>         <BR>         <A HREF = "#Section2">How To Do It</A><BR>         <BR>         <A HREF = "#Section3">Compatibility</A><BR>         <BR>         <A HREF = "#References">References</A><BR>         <BR>         <A HREF="#Downloads">Downloadables</A></p>       <!-- end_toc --></td>  </tr>  <tr>   <td width=300 align=left scope="row"> <img src="images/tnmenubottom.gif" alt="" width=300 height=16>   </td>  </tr>    </table></td>  <td width=300 valign="top" align=left>            <!-- begin_intro_text --><P id = "introtext">This Technote         describes how to draw into an AWT Component by means other         than the Java AWT Graphics API. In particular, by         discovering the QuickDraw <code>GrafPort</code>, origin, and clipping         Region corresponding to the Component's visible area, you         can use any means at your disposal (most likely QuickDraw)         to draw things inside the Component.</p>         <!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Mar 1 1999]</h3><!-- end_date --></TD> </TR>    </TABLE> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR>      <!-- begin_content -->               <A NAME=Section1></A>                  <H2>Introduction to Impure         Drawing</H2>                  <P>Most Java applications are content (if sometimes         grudgingly so) to use normal "100% Pure Java" APIs to draw         their user interface. They use a combination of existing AWT         control components like Button or Checkbox, and custom         Component subclasses that use the graphics primitives         provided by the AWT Graphics class to draw themselves. (They         may also use components provided by higher-level class         libraries such as Swing or IFC, which in turn use         Graphics.)</P>                  <P>However, some Java code needs to use drawing services         provided by the platform's toolbox. Such code will usually         be a Java library whose goal is to provide a Java API for         features provided by the platform's toolbox -- Apple's         QuickTime For Java is one such example; another would be         an OpenGL interface for Java.</P>                  <P>Such code will need to use either native methods or         <CODE>JDirect</CODE> to make calls to the toolbox. Both of these         mechanisms are documented elsewhere. When it comes time         to draw, though, the problem appears: How does the drawing code         acquire the resources it needs to draw into the Component?         For instance, before making QuickDraw calls, you'd need to         know the right <code>GrafPort</code> to use, and set up the <code>GrafPort</code>'s         origin and clipping.</P>                  <P>This is an issue that applies to any platform, not just         the Mac OS (although the details of the resources necessary         are of course platform-specific.) Sun Microsystems, therefore, defined an         API collectively referred to as <B>DrawingSurface</B> that         can be used to map from a Component object to native-window         system resources.</P>      <BR><P><A HREF = "#top">Back to top</A></P>         <H2><A NAME=Section2></A>How To Do         It</H2>                  <P>First, use the right kind of Component as your drawing         surface. You need a Component with a native peer, so         lightweight Components won't work. And doing your own         drawing into components that AWT itself already draws into         -- like Button or Choice -- is discouraged. The Component         types that work best, then, are Canvas, Panel and any of the         Window types (Window, Frame, Dialog.)</P>                  <H3>Getting to the DrawingSurface</H3>                  <P>The interface <Code>sun.awt.DrawingSurface</Code> is used to         access native drawing surface information. This interface is         implemented by non-lightweight component peers and by Images         created for offscreen graphics. The interface contains only         a single method, <Code>getInfo</Code>, which returns a         <CODE>DrawingSurfaceInfo</CODE> object. This is the main object you'll         need to use.</P>                  <P>Here's a Java snippet that shows how to get the         <CODE>DrawingSurfaceInfo</CODE> for the Component         <Code>theComponent</Code>:</P>                  <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>import sun.awt.*;...DrawingSurface ds = (DrawingSurface)theComponent.getPeer();DrawingSurfaceInfo dsi = ds.getDrawingSurfaceInfo();</pre></TD></TR></TABLE></CENTER><BR><BR>                  <P>(You can do the same thing from native code using JNI;         it's just more awkward.)</P>                  <H3>How to Draw</H3>                  <P>You need to call the <CODE>DrawingSurfaceInfo</CODE>'s <Code>lock</Code>         method before you start drawing, and its <Code>unlock</Code>         method after you stop drawing. The <Code>lock</Code> method sets         up QuickDraw's state and ensures the <code>GrafPort</code> is in         decent shape for you to draw into it.</P>                  <P>To prevent AWT code running on other threads from messing         with the port (or other global Toolbox state) while you're         drawing, you need to synchronize against the <I>Toolbox         lock</I> before you call the <CODE>DrawingSurfaceInfo</CODE>'s         <Code>lock</Code> method. This is described in detail in         <A HREF = "tn1153.html">Technote 1153, <I>Thread-Safe Toolbox Access From MRJ</I></A>.         The next snippet below shows how to do this.</P>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>IMPORTANT:</B><BR>                  Synchronizing against the Toolbox lock acquires a                  central AWT semaphore which prevents other Java                  threads, as well as the native host application,                  from accessing the Toolbox until your                  <Code>synchronized</Code> block exits. This means                  that</P>                                    <UL>                     <LI>You should lock for as short a time as                     possible -- get in, do your drawing, then get                     out.</LI>                                          <LI>You should not make any other AWT calls                     while the drawing surface is locked (nor should                     the thread doing the drawing do anything that                     could block against other threads of yours that                     need to make AWT calls, or you could                     deadlock).</LI>                                          <LI>You should make absolutely sure that you                     unlock on the way out, by putting the                     <Code>unlock</Code> call in a finally clause.</LI>                  </UL></TD></TR></TABLE></CENTER><BR><BR>                          <P>Now that you've locked the drawing surface, QuickDraw is         all set to draw into the Component. Its <code>GrafPort</code> is the         current port, the local coordinate (0,0) is at the top         left of the Component, and the <CODE>clipRgn</CODE> is set to the visible         region of the Component (which will not include the regions         occupied by any non-lightweight child Components.)</P>                  <P>You can get the Component's bounding box in local         coordinate by calling the method         <Code>DrawingSurfaceInfo.getBounds</Code>. It's safe to make         this call while the <CODE>DrawingSurface</CODE> is locked.</P>                  <P>When you're done drawing, you don't need to restore the         previous <code>GrafPort</code>. However, you must restore any state you         changed in the Component's <code>GrafPort</code> (clipping, colors, etc.)         And of course you need to unlock the drawing surface.</P>                  <P>It looks like this, continuing the above snippet:</P>                  <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>import QuickdrawFunctions;   // from JDirect Sample Code in SDKimport com.apple.mrj.macos.toolbox.Toolbox;...synchronized( Toolbox.LOCK ) {    dsi.lock();    try{        Rectangle bounds = dsi.getBounds();        QuickdrawFunctions.<B>MoveTo</B>(bounds.left, bounds.top);        QuickdrawFunctions.<B>LineTo</B>(bounds.width-1, bounds.height-1);    }finally{        dsi.unlock();    }}</pre></TD></TR></TABLE></CENTER><BR><BR>                          <H3>Accessing the WindowPtr</H3>                  <P>In some circumstances (e.g., if messing with the         Palette Manager) you may need to find the Mac OS <CODE>WindowPtr</CODE>         of the window the Component is in. This is <I>not</I> the         same as the Component's <code>GrafPort</code>; MRJ 2.1 creates its own         <code>GrafPorts</code> and never uses the <CODE>WindowPtr</CODE> directly for drawing.         If you do access the <CODE>WindowPtr</CODE>, you should not use it for         drawing -- use the <CODE>DrawingSurface</CODE>'s <code>GrafPort</code> instead.</P>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>IMPORTANT:</B><BR>                  The <CODE>GetWindow</CODE> method was added in MRJ 2.1; it is                  not implemented in MRJ 2.0 and thus MRJ 2.0 will                  throw an error when trying to call this method.</P></TD></TR></TABLE></CENTER><BR><BR>                          <P>You get the <CODE>WindowPtr</CODE> by doing the following. Note that you can also get the <code>GrafPort</code> and <CODE>GDevice</CODE> in the same         way:</P>                  <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>MacDrawingSurface mds = (MacDrawingSurface) dsi.getSurface();int windowPtr = mds.getWindow();  // WindowPtr cast to intint grafPtr = mds.getPort();      // CGrafPtr cast to intint gdevice = mds.getDevice();    // GDHandle cast to int</pre></TD></TR></TABLE></CENTER><BR><BR>                          <P>Don't hang onto these values for too long -- they will         not be valid after the Component's peer has been disposed,         that is, after the Component or a parent is hidden or the         window closed. For safety's sake you should only get and         access them while the <CODE>DrawingSurfaceInfo</CODE> is locked.</P>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>IMPORTANT:</B><BR>                  There is a bug in MRJ 2.1 that makes it essential                  that you call <Code>getWindow</Code>, <Code>getPort</Code>,                  or <Code>getDevice</Code> at least once on any                  <CODE>DrawingSurface</CODE> you ever draw into, if you plan on mixing native and Java-based (using                  <Code>java.awt.Graphics</Code>) drawing in the same                  Component or Image. Until one of these methods is                  called, MRJ 2.1 doesn't realize that native drawing                  is taking place, and it won't fully synchronize the                  Java drawing with the native calls.</P></TD></TR></TABLE></CENTER><BR><BR><BR><P><A HREF = "#top">Back to top</A></P>         <H2><A NAME=Section3></A>Compatibility</H2>                  <P>The <CODE>DrawingSurface</CODE> API is implemented in MRJ 2.0 and         later, although the implementation in MRJ 2.1 is more         robust.</P>                  <P>The method <Code>MacDrawingSurface.getWindow</Code> was added         in MRJ 2.1; it is not implemented in MRJ 2.0, and thus in MRJ         2.0 the class-loader will throw an error when trying to load         a class that calls this method.</P>                  <P>Not all Java implementations on all platforms support         <CODE>DrawingSurface</CODE> -- Sun <A HREF = "http://java.sun.com/products/jdk/faq/faq-sun-packages.html">explicitly         points out</A> that sun.* classes are not part of the         supported Java API set. Sun's JDK 1.1 and later do support         <CODE>DrawingSurface</CODE>. Naturally, the exact OS calls you'll need to         make to draw are platform specific, and the         MacDrawingSurface class will not exist. You'll need to get         documentation from the vendor of any other Java         implementation to find out how to use <CODE>DrawingSurfaces</CODE> with         it.</P>     <BR><P><A HREF = "#top">Back to top</A></P><A NAME="References"></A>         <H2>References</H2>         <p><A HREF = "tn1153.html">Technote 1153: <I>Thread-Safe Toolbox Access FromMRJ.</I></A>  Describes the "Toolbox lock" and how to use it. A must-read if you're going to use the Mac Toolbox for drawing.</p>         <BR><p><A HREF = "#top">Back to top</a></p><A NAME="Downloads"></A> <h2>Downloadables</h2><center><TABLE BORDER=0 CELLPADDING=3 WIDTH="600"> <TR> <td width=50 align=left>   <P ALIGN=center><img src="images/acrobatsmall.gif" align=middle alt="Acrobat" width=22 height=23></P></TD><td align="left">   <p>Acrobat version of this Note (52K).</P></TD><td width=60 align=left>   <p><A HREF="pdf/tn1156.pdf">Download</A></P></TD>  </TR> </table></center><BR><p><a href="#top">Back to top</a></p></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1156.html%3Fid%3DDTS10002995-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1156.html%3Fid%3DDTS10002995-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1156.html%3Fid%3DDTS10002995-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>