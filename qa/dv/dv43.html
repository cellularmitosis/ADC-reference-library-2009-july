<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!--Template 06-20-02--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Q&amp;A DV43: InterfaceLib and Native Drivers</title><meta name="keywords" content="have creator list relevant keywords here"><meta name="Description" content="Technical Q&amp;A DV43: This Q&amp;A discusses the difference betweenDriverServicesLib and InterfaceLib."><meta name="categories" content="Devices"><meta name="week-posted" content="Sep 18, 2000 - Sep 22, 2000"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10001184" title="InterfaceLib and Native Drivers"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalqas/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/index.html" target="_blank">Reference Library > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A DV43</div>
<div id="pageheadsub">InterfaceLib and Native Drivers</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><!-- begin_content --><CENTER><TABLE BORDER=0 CELLPADDING=0 WIDTH=600>  <TR> <td align="left"><hr width=500 align=center>                           <P id=p2>Q: Is it legal to call         system functionality exported by InterfaceLib from a native         driver (<CODE>'ndrv'</CODE>)? <a href="http://developer.apple.com/documentation/hardware/DeviceManagers/pci_srvcs/pci_cards_drivers/index.html">Designing         PCI Cards and Drivers for Power Macintosh Computers</A>         indicates that this is illegal, but some drivers (for         example, disk drivers) can't be written without using         InterfaceLib routines.</P>                  <P id=p4>A: It depends on your definition of "legal".         <CITE>Designing PCI Cards and Drivers for Power Macintosh         Computers</CITE> describes a model for native disk drivers         (the DriverServicesLib model). The original intention was         that drivers written to the model would be binary compatible         with future generations of Mac OS (specifically, a long-deceased         project known as Copland). However, in current         systems this model has a number of flaws.</P>                  <UL>            <LI>There are significant areas where the model does not            match the actual implementation on traditional Mac OS            (System 7.5.2 through Mac OS            9.x). DTS has documented a number of these            problems over the years (examples include Technote 1104            <a href="../../technotes/tn/tn1104.html">Interrupt-Safe            Routines</A> and Q&amp;A DV 32 <a href="dv32.html"><CODE>PrepareMemoryForIO</CODE>            and Execution Levels</A>), but they continue to crop            up.</LI>                        <LI>In many areas <CITE>Designing PCI Cards and Drivers            for Power Macintosh Computers</CITE> is confusing because            it is trying to document the model rather than the            underlying implementation.</LI>                        <LI>Because of changes in the design of Copland, the            DriverServicesLib model does not even match the            implementation that shipped            on the pre-release versions of that system.</LI>                        <LI>Certain device drivers, for example disk drivers,            can't be written within the bounds of the DriverServicesLib model.            However, it is advantageous to write such drivers as            native drivers because it simplifies the development            process (and may yield performance enhancements).</LI>                        <LI>The DriverServicesLib model duplicates functionality            provided by InterfaceLib routines. For example, it is            possible to schedule a timer callback using either            <CODE>SetInterruptTimer</CODE> (from DriverServicesLib)            or <CODE>InsTime</CODE> (from InterfaceLib). The old            routines still work just fine, but the model strongly            discourages developers from using them.</LI>         </UL>                  <P id=p4>So, you might ask, why doesn't Apple abandon the         DriverServicesLib model and officially recommend that         developers link their native drivers with InterfaceLib? The         reason is compatibility. If your driver sticks vigorously to         the DriverServicesLib model, it may be possible for future         system software to run it in some sort of compatibility         environment. This is good for both Apple and you.</P>         <TABLE BORDER=0 CELLPADDING=5 WIDTH=550> <TR> <td bgcolor="#e6e6e6" align=left>                  <P id=p4><B>Note:</B><BR>                  An example of this is the video <CODE>'ndrv'</CODE>                  support in Mac OS X. Mac OS X can load and run                  native video drivers from the ROM of PCI video                  cards. This allows Mac OS X to provide basic video                  functionality on any card that supports traditional                  Mac OS boot-time video, without having a real Mac                  OS X video driver available.                  In order for this to work                  your video driver must:</P>                                    <UL>                     <LI>link with only the                     standard libraries (DriverServicesLib,                     NameRegistryLib, VideoServicesLib, and                     PCILib)</LI>                                          <LI>not access low-memory                     globals</LI>                                          <LI>recognize that it's                     possible for the logical and physical addresses                     of its PCI hardware to be different, and always                     access the appropriate addresses through the                     appropriate Name Registry                     properties.</LI>                  </UL>               </TD>            </TR>         </TABLE>                  <P id=p4>On the other hand, if there's no way to implement your         class of driver within the DriverServicesLib model, you have         no choice: you must link with InterfaceLib.</P>                  <P id=p4>The decisions are trickier if DriversServicesLib and         InterfaceLib offer two different flavors of the same         functionality (for example, <CODE>PrepareMemoryForIO</CODE>         versus <CODE>LockMemory</CODE> and         <CODE>GetPhysical</CODE>). To allow         for future compatibility we recommend that you favor         the DriverServicesLib routines over their InterfaceLib         equivalents. However, there may be factors that prevent you         from using the DriverServicesLib routines. For example, the         DriverServicesLib timer interrupt facility,         <CODE>SetInterruptTimer</CODE>, is limited to 32 outstanding         timer requests across the entire         system. The Time Manager, however, can handle         a much larger number of timer         requests, as long as you pre-allocate the memory for each         (the <CODE>TMTask</CODE> structure). If you find that your         driver is using so many timers that it encounters the         <CODE>SetInterruptTimer</CODE> limit, you may consider         switching to the Time Manager. An even better solution, of         course, would be to architect your driver to use fewer         timers.</P>                 <TABLE BORDER=0 CELLPADDING=5 WIDTH=550> <TR> <td bgcolor="#e6e6e6" align=left>                  <p id=p4><B>IMPORTANT:</B><BR>                  If you decide to switch from using a                  DriverServicesLib service to an InterfaceLib                  service, you must be aware that their may be subtle                  differences between the services. To continue the                  example above, the <CODE>SetInterruptTimer</CODE>                  routine calls you back at secondary interrupt                  level, whereas the Time Manager calls you back at                  hardware interrupt level. Technote 1104                  <a href="../../technotes/tn/tn1104.html#ExecutionLevels">Interrupt-Safe                  Routines</A> discusses                  the differences between these execution                  environment.</P>               </TD>            </TR>         </TABLE>                  <P id=p4>Another factor to consider is whether your driver         is to be placed in non-flashable ROM on a PCI card. If so, you         should try harder to conform to the DriverServicesLib model         because there's no way to change your code after it has         shipped. In any case you should attempt to keep a ROM-based         driver as simple, and as compatible, as possible. One good         technique is to burn a simple driver in the ROM on your card         and then provide an enhanced driver for the System Folder         that replaces the simple ROM driver during system startup.         This allows for both plug'n'play installation and easy         maintenance.</P>                  <P id=p4>In summary, if your native driver can only achieve its         goals by calling InterfaceLib, it is legal to link with and         call InterfaceLib. It will work just fine, but may present         some compatibility issues in the future.</P>                  <P id=p4>The above is not carte blanche for you to use a native         driver for all the old sleazy hacks that 68K drivers         (<CODE>'DRVR'</CODE>s) were used for. For example, your         native driver should not put up         dialogs boxes! Drivers should be used to drive hardware (or         at least virtual hardware), not as mini-applications or as a         poor man's shared library mechanism. This rule is simply         good software design: splitting your code into a hardware         component and a user interface component will make it more         maintainable (especially with respect to new system software         developments, such as Mac OS X).</P>                  <P id=p4>If you do link your native driver to DriverServicesLib         and InterfaceLib, make sure that you link with         DriverServicesLib first and InterfaceLib second. Some         symbols, such as <CODE>UpTime</CODE>, are now available in         both stub libraries. However, older versions of the system         do not export those symbols from InterfaceLib. If your         driver is installed on such a system it will not load         because the symbols are missing from the runtime copy of         InterfaceLib (despite the fact that the symbol is available         in DriverServicesLib). Linking with DriverServicesLib first         will ensure that your driver gets these duplicate symbols         from DriverServicesLib, and thus loads on older systems. For         example, if your driver calls <CODE>UpTime</CODE> and links         with InterfaceLib before DriverServicesLib, it will not run         on systems prior to Mac OS 8.5. InterfaceLib on Mac OS 8.1         and earlier did not export the <CODE>UpTime</CODE>         symbol.</P>                        </td>       </tr></table></CENTER><!-- end_content --><!-- begin_date --><H4 ALIGN=center>[Sep 22 2000]</H4><!-- end_date --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/dv/dv43.html%3Fid%3DDTS10001184-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/dv/dv43.html%3Fid%3DDTS10001184-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/dv/dv43.html%3Fid%3DDTS10001184-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --> <hr width=500 align=center> </BODY> </HTML>