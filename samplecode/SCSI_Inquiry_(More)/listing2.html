<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>SCSI Inquiry (More) - /SCSI Inquiry(Asynch)/SCSIInquiry(asynch).c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; <A HREF="javascript:location.replace('index.html');">SCSI Inquiry (More)</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/idxSCSI-date.html" target="_blank">Hardware & Drivers > SCSI</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">SCSI Inquiry (More)</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/SCSI Inquiry(Asynch)/SCSIInquiry(asynch).c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/SCSI Inquiry(Asynch)/DoSCSICommand.c</option>
<option value="listing2.html">/SCSI Inquiry(Asynch)/SCSIInquiry(asynch).c</option>
<option value="listing3.html">/SCSI Inquiry(Asynch)/SCSIInquiry.h</option>
<option value="listing4.html">/SCSI Inquiry(Simple)/DoSCSICommand.c</option>
<option value="listing5.html">/SCSI Inquiry(Simple)/SCSIInquiry(simple).c</option>
<option value="listing6.html">/SCSI Inquiry(Simple)/SCSIInquiry.h</option>
<option value="listing7.html">/SCSI Inquiry(Synch)/DoSCSICommand.c</option>
<option value="listing8.html">/SCSI Inquiry(Synch)/SCSIInquiry(synch).c</option>
<option value="listing9.html">/SCSI Inquiry(Synch)/SCSIInquiry.h</option></select>
				</p>
				</form>
				<p><strong><a href="SCSI_Inquiry_%28More%29.zip">Download Sample</a></strong> (&#147;SCSI_Inquiry_(More).zip&#148;, 56.0K)<BR>
<strong><a href="SCSI_Inquiry_%28More%29.dmg">Download Sample</a></strong> (&#147;SCSI_Inquiry_(More).dmg&#148;, 119.2K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*  File:    SCSIInquiry(asynch).c  Contains:  This is a minimal sample to illustrate the Asynchronous SCSI Manager.          Note: this program will crash if the asynchronous SCSI Manager is        not installed. SCSI Simple Sample shows how to test for the presence        of the asynchronous SCSI Manager.  Written by: Martin Minow    Copyright:  Copyright &copy; 1994-1999 by Apple Computer, Inc., All Rights Reserved.        You may incorporate this Apple sample source code into your program(s) without        restriction. This Apple sample source code has been provided &quot;AS IS&quot; and the        responsibility for its operation is yours. You are not permitted to redistribute        this Apple sample source code as &quot;Apple sample source code&quot; after having made        changes. If you're going to re-distribute the source, we require that you make        it clear in the source that the code was descended from Apple sample source        code, but that you've made changes.  Change History (most recent first):        7/15/1999  Karl Groethe  Updated for Metrowerks Codewarror Pro 2.1        */#define ASYNCHRONOUS#include &quot;SCSIInquiry.h&quot;#ifndef THINK_C        /* MPW includes      */#include &lt;Errors.h&gt;#include &lt;Script.h&gt;#include &lt;Types.h&gt;#include &lt;Files.h&gt;#include &lt;Resources.h&gt;#include &lt;QuickDraw.h&gt;#include &lt;Fonts.h&gt;#include &lt;Events.h&gt;#include &lt;Windows.h&gt;#include &lt;ToolUtils.h&gt;#include &lt;Memory.h&gt;#include &lt;Menus.h&gt;#include &lt;Lists.h&gt;#include &lt;Printing.h&gt;#include &lt;Dialogs.h&gt;#include &lt;StandardFile.h&gt;#include &lt;Packages.h&gt;#include &lt;TextUtils.h&gt;#endif/* * Include the O.S. files in a specific order to make sure that we have * a definition for the _SCSIAtomic trap. */#include &lt;Traps.h&gt;#ifndef _SCSIAtomic#define _SCSIAtomic  0xA089#endif/* * As of this writing, the Asynchronous SCSI Manager definitions have * not been added to the standard header distribution. This include * references a working version that is stored in the application * folder hierarchy. */#include &quot;SCSI.h&quot;DeviceIdent        gTargetDevice = { 0, 0, 0, 0 };  /* Target ID 0  *//* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * SCSI Definitions */#define  kScsiCmdInquiry      0x12    /* Device inquiry command  */struct SCSI_6_Byte_Command {        /* Six-byte command      */  unsigned char    opcode;        /*  0            */  unsigned char    lbn3;        /*  1 lbn in low 5      */  unsigned char    lbn2;        /*  2            */  unsigned char    lbn1;        /*  3            */  unsigned char    len;        /*  4            */  unsigned char    ctrl;        /*  5            */};typedef struct SCSI_6_Byte_Command SCSI_6_Byte_Command;struct SCSI_Inquiry_Data {          /* Inquiry returns this    */  unsigned char    devType;      /*  0 Device type,      */  unsigned char    devTypeMod;      /*  1 Device type modifier  */  unsigned char    version;      /*  2 ISO/ECMA/ANSI version  */  unsigned char    format;        /*  3 Response data format  */  unsigned char    length;        /*  4 Additional Length    */  unsigned char    reserved5;      /*  5 Reserved        */  unsigned char    reserved6;      /*  6 Reserved        */  unsigned char    flags;        /*  7 Capability flags    */  unsigned char    vendor[8];      /*  8-15 Vendor-specific  */  unsigned char    product[16];    /* 16-31 Product id      */  unsigned char    revision[4];    /* 32-35 Product revision  */  unsigned char    vendorSpecific[20]; /* 36-55 Vendor stuff    */  unsigned char    moreReserved[40];  /* 56-95 Reserved      */};typedef struct SCSI_Inquiry_Data SCSI_Inquiry_Data;SCSI_Inquiry_Data      gInquiryData;  /* Inquiry data goes here  */unsigned long        gInquirySize;  /* Number of bytes read    *//* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * gSCSICommand is the command that we send to the device. */SCSI_6_Byte_Command      gSCSICommand = {    kScsiCmdInquiry,          /* Command          */    0,                  /* LBN 3 -- unused      */    0,                  /* LBN 2 -- unused      */    0,                  /* LBN 1 -- unused      */    sizeof (SCSI_Inquiry_Data),      /* Returned buffer length  */    0                  /* Flags -- must be zero  */  };/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * The SCSIBusInquiry command returns the number of bytes in the parameter * block. We then allocate a block of the correct size. Note that the * block is cleared to zero when it is allocated. */SCSIBusInquiryPB      gSCSIBusInquiryPB;SCSIExecIOPB        *gSCSIExecIOPB;unsigned long        gSCSIExecIOPBSize;Boolean            gSCSICommandComplete;#define kCompletionTimeout  (250)        /* 250 Msec total time  *//* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * Local functions and administrative variables. */#ifdef __powercQDGlobals        qd;#endifvoid            DisplayError(    OSErr          errorStatus,    ConstStr255Param    errorMessage  );OSErr            DoSCSICommand(    unsigned short      targetID,    const Ptr        scsiCommand,    SCSIInstr        *requestTIB  );void            DisplaySCSIInquiry(    long          actualTransferCount  );pascal void          MySCSICallbackProc(    void          *ioPtr  );/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * Local functions and administrative variables. */voidmain(void){    short          i;    OSErr          status;    EventRecord        eventRecord;    long          actualTransferCount;          MaxApplZone();        InitGraf(&amp;qd.thePort);    InitFonts();    InitWindows();    InitMenus();    TEInit();    InitDialogs(0);    for (i = 0; i &lt; 3; i++)      EventAvail(everyEvent, &amp;eventRecord);    /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *     * Call the SCSIBusInquiry command to determine the length of the     * command block for the actual transfer.     */    gSCSIBusInquiryPB.scsiPBLength = sizeof gSCSIBusInquiryPB;    gSCSIBusInquiryPB.scsiFunctionCode = SCSIBusInquiry;    gSCSIBusInquiryPB.scsiDevice = gTargetDevice;    SCSIAction((SCSI_PB *) &amp;gSCSIBusInquiryPB);    status = gSCSIBusInquiryPB.scsiResult;    if (status != noErr) {      DisplayError(status, &quot;\pSCSIBusInquiry failed&quot;);      ExitToShell();    }    gSCSIExecIOPBSize = gSCSIBusInquiryPB.scsiIOpbSize;    gSCSIExecIOPB = (SCSIExecIOPB *) NewPtrClear(gSCSIExecIOPBSize);    if (gSCSIExecIOPB == NULL) {      DisplayError(MemError(), &quot;\pNo memory for param. block&quot;);      ExitToShell();    }    /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *     * Setup the parameter block for the user's request.     */    gSCSIExecIOPB-&gt;scsiPBLength = gSCSIExecIOPBSize;    gSCSIExecIOPB-&gt;scsiFunctionCode = SCSIExecIO;    gSCSIExecIOPB-&gt;scsiTimeout = kCompletionTimeout;    gSCSIExecIOPB-&gt;scsiDevice = gTargetDevice;    /*     * Copy the command block into the SCSI ExecIO Parameter block to     * centralize everything for debugging.     */    BlockMove(      &amp;gSCSICommand,      &amp;gSCSIExecIOPB-&gt;scsiCDB,      sizeof gSCSICommand    );    gSCSIExecIOPB-&gt;scsiCDBLength = sizeof gSCSICommand;    /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *     * Specify the transfer direction, if any, and set the other SCSI     * operation flags. scsiSIMQNoFreeze prevents the SCSI Manager from     * blocking further operation if an error is detected.     */    gSCSIExecIOPB-&gt;scsiFlags =          scsiSIMQNoFreeze      /* Don't stop on errors  */          | scsiDirectionIn      /* We're reading    */          | scsiDisableAutosense    /* No Request Sense    */          | scsiDontDisconnect;    /* No disconnect    */    gSCSIExecIOPB-&gt;scsiDataPtr = (unsigned char *) &amp;gInquiryData;    gSCSIExecIOPB-&gt;scsiDataLength = sizeof gInquiryData;    gSCSIExecIOPB-&gt;scsiDataType = scsiDataBuffer;    /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *     * For polled transfers, turn off select with attention so     * the device doesn't disconnect. This is inefficient, but     * is useful for the Device Identity, Mode Sense, and     * some other administrative commands.     */    gSCSIExecIOPB-&gt;scsiHandshake[0] = 0;  /* Not used for polled  */    gSCSIExecIOPB-&gt;scsiIOFlags |= scsiDisableSelectWAtn;    gSCSIExecIOPB-&gt;scsiTransferType = scsiTransferPolled;    /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *     * Now, call the SCSI Command manager     */#ifdef ASYNCHRONOUS    gSCSIExecIOPB-&gt;scsiCompletion = NewSCSICallbackProc(MySCSICallbackProc);    gSCSICommandComplete = false;#else    gSCSIExecIOPB-&gt;scsiCompletion = NULL;  /* Synchronous      */#endif    status = SCSIAction((SCSI_PB *) gSCSIExecIOPB);#ifdef ASYNCHRONOUS    /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *     * In application that take advantage of the asynchronous SCSI     * Manager, the mainline code would handle user interaction and     * display management, while all SCSI and file I/O would be carried     * out by I/O completion routines. This is a dummy event loop     * that waits until the SCSIAction call completes by calling     * MySCSICallbackProc. Note that we do not wait if the original     * call to SCSIAction failed, presumably because of a bad     * parameter.     *     * Note: if your application calls the SCSI Manager asynchronously     * and SCSIAction returns noErr, your code MUST NOT examine any     * field within the SCSI parameter block, or any memory that it     * references until your completion routine has been called. Thus,     * this sample DOES NOT examine gSCSIExecIOPB-&gt;scsiResult until     * the global &quot;completion flag&quot; has been set.     */    if (status == noErr) {      while (status == noErr &amp;&amp; gSCSICommandComplete == false)        EventAvail(everyEvent, &amp;eventRecord);      status = gSCSIExecIOPB-&gt;scsiResult;    }#endif    /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *     * If the device returned less data than we requested, the SCSI     * Manager will return an error status. We check that we actually     * received some data and cancel the error if this is the case.     */    actualTransferCount = gSCSIExecIOPB-&gt;scsiDataLength          - gSCSIExecIOPB-&gt;scsiDataResidual;    if (status == scsiDataRunError &amp;&amp; actualTransferCount &gt; 0)      status = noErr;    if (status != noErr)      DisplayError(status, &quot;\pSCSIAction&quot;);    else {      DisplaySCSIInquiry(actualTransferCount);    }    ExitToShell();}/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * This completion routine is called by the SCSI Manager when the * SCSIAction procedure completes. */pascal voidMySCSICallbackProc(    void          *ioPtr  ){    #pragma unused (ioPtr)    gSCSICommandComplete = true;}/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * Display the inquiry result. */static voidStoreString(    const unsigned char    *textPtr,    Size          textLength,    StringPtr        result  ){    register short      i;        for (i = textLength; i &gt; 0; --i) {      if (textPtr[i - 1] != ' ' &amp;&amp; textPtr[i - 1] != 0)        break;    }    BlockMove(textPtr, &amp;result[1], i);    result[0] = i;}voidDisplaySCSIInquiry(    long          actualTransferCount  ){    Str255          inquirySize;    Str255          vendorName;    Str255          productName;    Str255          revisionLevel;        NumToString(actualTransferCount, inquirySize);    StoreString(      gInquiryData.vendor,      sizeof gInquiryData.vendor,      vendorName    );    StoreString(      gInquiryData.product,      sizeof gInquiryData.product,      productName    );    StoreString(      gInquiryData.revision,      sizeof gInquiryData.revision,      revisionLevel    );    ParamText(inquirySize, vendorName, productName, revisionLevel);    NoteAlert(ALRT_Info, NULL);}/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * Display an error alert. */voidDisplayError(    OSErr          errorStatus,    ConstStr255Param    errorMessage  ){    Str255          work;        NumToString(errorStatus, work);    ParamText(work, errorMessage, &quot;\p&quot;, &quot;\p&quot;);    InitCursor();    StopAlert(ALRT_Error, NULL);}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/SCSI_Inquiry_(More)/listing2.html%3Fid%3DDTS10000026-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/SCSI_Inquiry_(More)/listing2.html%3Fid%3DDTS10000026-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/SCSI_Inquiry_(More)/listing2.html%3Fid%3DDTS10000026-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>