<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>ATSUI Programming Guide: Basic Tasks: Working With Objects and Drawing Text</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Basic Tasks: Working With Objects and Drawing Text"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30000030" title="Basic Tasks: Working With Objects and Drawing Text"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000420" target="_top">Carbon</a> &gt; <a href="../../../TextFonts-date.html#//apple_ref/doc/uid/TP30000440-TP30000420-TP30000461" target="_top">Text &amp; Fonts</a> &gt; <a href="../atsui_chap1/atsui_intro.html#//apple_ref/doc/uid/TP30000027-TP1">ATSUI Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../atsui_chap3/atsui_concepts2.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../atsui_chap5/atsui_interact_tasks.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30000030-TP1" title="Basic Tasks: Working With Objects and Drawing Text"></a><h1>Basic Tasks: Working With Objects and Drawing Text</h1><p>This chapter provides general guidelines for using ATSUI and provides step-by-step instructions for the basic tasks you can perform with ATSUI. These tasks are described in the following sections:</p><ul class="ul"><li class="li"><p><span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF178">“Creating Style Objects and Setting Attributes”</a></span> shows how to use ATSUI functions to create a style object and provides instructions for associating one or more style attributes with an object.</p></li><li class="li"><p><span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF154">“Creating a Text Layout Object and Setting Attributes”</a></span> describes how to create a text layout object, set layout attributes to control the text associated with the text layout object, and associate style objects with the text layout.</p></li><li class="li"><p><span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF186">“Determining Paragraphs in a Unicode Text Block”</a></span> provides an example of how to find paragraph separators in a block of text. </p></li><li class="li"><p><span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF184">“Drawing Horizontal Text”</a></span> shows how to use ATSUI to render horizontal text.</p></li><li class="li"><p><span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF183">“Drawing Text Using a Quartz Context”</a></span> details how to use a Quartz drawing context in conjunction with ATSUI.</p></li><li class="li"><p><span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-BCIDEAIA">“Drawing Equations”</a></span> shows how to use style attributes to draw equations that contain subscripts and superscripts.</p></li><li class="li"><p><span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-BCIJAHHE">“Drawing Vertical Text”</a></span> describes how to use ATSUI to renter vertical text.</p></li><li class="li"><p><span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF159">“Breaking Lines”</a></span> shows how to set soft line breaks programmatically and how to use ATSUI’s batch line-breaking function.</p></li><li class="li"><p><span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF155">“Measuring Text”</a></span> provides information on the functions to use to obtain text measurements.</p></li><li class="li"><p><span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF194">“Calculating Line Height”</a></span> discusses the preferred method for setting line height in Mac OS X version 10.2 and describes what to you if your application runs in an earlier version of the Mac OS.</p></li><li class="li"><p><span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF139">“Flowing Text Around a Graphic ”</a></span> shows the preferred way to draw text so that it flows around an image.</p></li><li class="li"><p><span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF193">“Setting Up a Tab Ruler”</a></span> provides step-by-step instructions for setting up a tab ruler for a text layout object. </p></li></ul><p>Before you read this chapter, you should be familiar with the concepts discussed in <span class="content_text"><a href="../atsui_chap2/atsui_concepts.html#//apple_ref/doc/uid/TP30000028-TP1">“Typography Concepts”</a></span> and <span class="content_text"><a href="../atsui_chap3/atsui_concepts2.html#//apple_ref/doc/uid/TP30000029-TP1">“ATSUI Style and Text Layout Objects,”</a></span> <span class="content_text"><a href="../atsui_chap3/atsui_concepts2.html#//apple_ref/doc/uid/TP30000029-TP1">“ATSUI Style and Text Layout Objects.”</a></span></p><p>This chapter provides a number of code samples to illustrate how to use ATSUI. You can obtain the sample applications from which this code is taken, as well as additional code samples, from the developer sample code website:</p><p><span class="content_text"><a href="http://developer.apple.com/samplecode/" target="_top">http://developer.apple.com/samplecode/</a></span></p><a name="//apple_ref/doc/uid/TP30000030-TPXREF167" title="Guidelines for Using ATSUI"></a><h2>Guidelines for Using ATSUI</h2><p>There are a number of guidelines<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_896"></a> you should follow to assure optimal performance and efficient memory use when you use ATSUI. This section summarizes them. The sample code in this and the other task chapters follows these guidelines.</p><ul class="ul"><li class="li"><p>Once you have created a style object<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_897"></a>, keep it until you no longer need it. That is, do not dispose of a style object and then recreate it each time you need to draw using that style. See <span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF178">“Creating Style Objects and Setting Attributes.”</a></span></p></li><li class="li"><p>Associate a text layout object with a paragraph of text. If you associate a text layout object<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_898"></a> with a smaller unit of text such as a word, line, or style run, ATSUI won’t be able to lay out text efficiently. In addition, text may not be laid out properly. Using a unit of text that is longer than one paragraph may cause extra coding on your part if you want to treat the last line of a paragraph separately from the other lines (for example, justifying everything except the last line in a paragraph). See <span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF154">“Creating a Text Layout Object and Setting Attributes.”</a></span></p></li><li class="li"><p>Keep a text layout object around even when the text associated with it is altered. Call the functions <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUSetTextPointerLocation" target="_top">ATSUSetTextPointerLocation</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_899"></a>, <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUTextDeleted" target="_top">ATSUTextDeleted</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_900"></a>, or <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUTextInserted" target="_top">ATSUTextInserted</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_901"></a> to manage the altered text. </p></li><li class="li"><p>Use the QuickDraw functions <code><a href="../../../Reference/QuickDraw_Ref/Reference/reference.html#//apple_ref/doc/c_ref/QDBeginCGContext" target="_top">QDBeginCGContext</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_902"></a> and <code><a href="../../../Reference/QuickDraw_Ref/Reference/reference.html#//apple_ref/doc/c_ref/QDEndCGContext" target="_top">QDEndCGContext</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_903"></a> to do Quartz drawing instead of the function <code><a href="../../../Reference/QuickDraw_Ref/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/doc/c_ref/CreateCGContextForPort" target="_top">CreateCGContextForPort</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_904"></a>. See <span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF183">“Drawing Text Using a Quartz Context.”</a></span></p></li><li class="li"><p>Use the same Quartz context (<code>CGContext</code>) until all drawing is completed. Don’t create and destroy the context each time you draw unless it is absolutely necessary. See <span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF183">“Drawing Text Using a Quartz Context.”</a></span></p></li><li class="li"><p>Call the function <code>ATSUGetGlyphBounds</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_905"></a> to get the ascent and descent of a line and the typographic bounds after layout. Don’t call <code>ATSUGetUnjustifiedBounds</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_906"></a> for these measurements because that function might need to perform a separate layout. See <span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF155">“Measuring Text.”</a></span></p></li><li class="li"><p>Set soft line breaks programmatically rather than manually. You can set line breaks by calling the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBreakLine" target="_top">ATSUBreakLine</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_907"></a> with the <code>iUseAsSoftLineBreak</code> parameter. See <span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF159">“Breaking Lines.”</a></span></p></li><li class="li"><p>When you have text that must flow around a graphic, use one text layout object per paragraph. Flow the text around the graphic by varying the line width for each line appropriately rather than using multiple layouts to flow the text around a graphic. See <span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF139">“Flowing Text Around a Graphic ,”</a></span></p></li><li class="li"><p>Use font fallback objects (<code>ATSUFontFallbacks</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_908"></a>) instead of the global font fallbacks, as global font fallbacks will be deprecated. A font fallback object works with a specific text layout object. See <span class="content_text"><a href="../atsui_chap6/atsui_adv_tasks.html#//apple_ref/doc/uid/TP30000032-TPXREF138">“Using Font Fallback Objects.”</a></span></p></li><li class="li"><p>Keep font fallback objects<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_909"></a> (<code>ATSUFontFallbacks</code>) around as long as possible, and share them between text layout objects. See <span class="content_text"><a href="../atsui_chap6/atsui_adv_tasks.html#//apple_ref/doc/uid/TP30000032-TPXREF138">“Using Font Fallback Objects.”</a></span></p></li><li class="li"><p>Create a standard Carbon Font menu or build a Font menu<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_910"></a> or list when your application first starts up. Get the font selection from the menu instead of calling the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUFindFontFromName" target="_top">ATSUFindFontFromName</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_911"></a> to find a font. </p></li></ul><a name="//apple_ref/doc/uid/TP30000030-TPXREF178" title="Creating Style Objects and Setting Attributes"></a><h2>Creating Style Objects and Setting Attributes</h2><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_912"></a><p>ATSUI style objects are opaque objects that represent a collection of stylistic attributes. Each attribute is defined by three values (a triple): </p><ul class="ul"><li class="li"><p>an attribute tag </p></li><li class="li"><p>the size of the attribute value associated with the tag</p></li><li class="li"><p>the value for the attribute specified by the tag</p></li></ul><p>To create an ATSUI style object, you must do the following:</p><ol class="ol"><li class="li"><p>Declare storage for the style.</p><p>For example:</p><div class="codesample"><table><tr><td scope="row"><pre>ATSUStyle       gDefaultStyle;<span></span></pre></td></tr></table></div></li><li class="li"><p>Create the style object.</p><p>You can use the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUCreateStyle" target="_top">ATSUCreateStyle</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_913"></a>. For example:</p><div class="codesample"><table><tr><td scope="row"><pre>OSStatus       status = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>status = ATSUCreateStyle (&amp;gDefaultStyle);<span></span></pre></td></tr></table></div></li><li class="li"><p>Set up a triple (tag, size, value) for each attribute associated with the style.</p><p>Typically, you declare three parallel arrays, one for attribute tags, one for sizes, and the third array for the value of the attribute. ATSUI supplies constants that specify attribute tags. For example, the following code sets up two attributes—a font size (<code>kATSUSizeTag</code>) and style (<code>kATSUQDBoldfaceTag</code>):</p><div class="codesample"><table><tr><td scope="row"><pre>ATSUAttributeTag  theTags[] =  {kATSUSizeTag, kATSUQDBoldfaceTag};<span></span></pre></td></tr><tr><td scope="row"><pre>ByteCount        theSizes[] = {sizeof(Fixed), sizeof(Boolean)};<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>Fixed   atsuSize = Long2Fix (12);<span></span></pre></td></tr><tr><td scope="row"><pre>Boolean isBold = TRUE;<span></span></pre></td></tr><tr><td scope="row"><pre>ATSUAttributeValuePtr theValues[] = {&amp;atsuSize, &amp;isBold};<span></span></pre></td></tr></table></div><p>See <span class="content_text"><a href="../atsui_chap3/atsui_concepts2.html#//apple_ref/doc/uid/TP30000029-TPXREF175">“Style Objects”</a></span> for more information on the attribute tags that are available in ATSUI.</p></li><li class="li"><p>Associate the attributes with the style object.</p><p>You can use the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUSetAttributes" target="_top">ATSUSetAttributes</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_914"></a>. You pass in the number of attributes you want to set and the three parallel arrays that represent the attribute tags, sizes of the values, and the values themselves, as shown in the following code:</p><div class="codesample"><table><tr><td scope="row"><pre>status = ATSUSetAttributes (gDefaultStyle,<span></span></pre></td></tr><tr><td scope="row"><pre>                            2,<span></span></pre></td></tr><tr><td scope="row"><pre>                            theTags,<span></span></pre></td></tr><tr><td scope="row"><pre>                            theSizes,<span></span></pre></td></tr><tr><td scope="row"><pre>                            theValues);<span></span></pre></td></tr></table></div></li></ol><p>Note that a style object is not associated with any text; it simply specifies a collection of attributes. You can set up style objects for your application once, and then reuse them over and over as needed. For example, you could set up style objects to define such styles as emphasis, heading level, superscript, subscript, and bold. </p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_16" title="Tip"></a><p><strong>Tip:</strong>&nbsp;Once you have created an ATSUI style object, keep it until you no longer need it. You can use it again and again, whenever your application needs to draw some text using the style defined by that object.</p></div><p>You can create a style object by copying another style object using the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUCreateAndCopyStyle" target="_top">ATSUCreateAndCopyStyle</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_915"></a>. Copying a style object is useful if you want to make a set of related styles. For example, if you have already created a style object to define a default font, font size, and font color, you could make an italic style based on the default by calling the following function:</p><div class="codesample"><table><tr><td scope="row"><pre>ATSUStyle       italicStyle;<span></span></pre></td></tr><tr><td scope="row"><pre>ATSUCreateAndCopyStyle (defaultStyle, &amp;italicStyle);<span></span></pre></td></tr></table></div><p>Then you would set up a triple for the italic attribute:</p><div class="codesample"><table><tr><td scope="row"><pre>ATSUAttributeTag    theTags[] =  {kATSUQDItalicTag};<span></span></pre></td></tr><tr><td scope="row"><pre>ByteCount           theSizes[] = {sizeof(Boolean)};<span></span></pre></td></tr><tr><td scope="row"><pre>Boolean             isItalic = TRUE;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ATSUAttributeValuePtr theValues[] = {&amp;isItalic};<span></span></pre></td></tr></table></div><p>Finally, you associate the italic attribute with the <code>italicStyle</code> object:</p><div class="codesample"><table><tr><td scope="row"><pre>status = ATSUSetAttributes (gItalicStyle,<span></span></pre></td></tr><tr><td scope="row"><pre>                            1,<span></span></pre></td></tr><tr><td scope="row"><pre>                            theTags,<span></span></pre></td></tr><tr><td scope="row"><pre>                            theSizes,<span></span></pre></td></tr><tr><td scope="row"><pre>                            theValues);<span></span></pre></td></tr></table></div><p>By using the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUCreateAndCopyStyle" target="_top">ATSUCreateAndCopyStyle</a></code>, the <code>italicStyle</code> object inherits the attributes of the <code>defaultStyle</code> object and has any other attributes you set by calling the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUSetAttributes" target="_top">ATSUSetAttributes</a></code>.</p><p>When you are done using a style object, you must call the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUDisposeStyle" target="_top">ATSUDisposeStyle</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_916"></a> to dispose of it. For example, to dispose of the <code>italicStyle</code> object, you’d use the following line of code:</p><div class="codesample"><table><tr><td scope="row"><pre>ATSUDisposeStyle (italicStyle);<span></span></pre></td></tr></table></div><p>Remember, it’s best to reuse styles rather than to create and dispose of a style each time you need them in your application. You can create all the common styles you need when your application starts up, and dispose of them when your application quits. <span class="content_text">Listing 3-1</span> shows code that creates styles prior to the application event loop and disposes of styles when the application event loop terminates. </p><a name="//apple_ref/doc/uid/TP30000030-TPXREF171" title="Listing 3-1Code that keeps style objects around until the application quits"></a><p class="codesample"><strong>Listing 3-1&nbsp;&nbsp;</strong>Code that keeps style objects around until the application quits</p><div class="codesample"><table><tr><td scope="row"><pre>MyMakeStyles();<span></span></pre></td></tr><tr><td scope="row"><pre>RunApplicationEventLoop();<span></span></pre></td></tr><tr><td scope="row"><pre>MyDisposeStyles();<span></span></pre></td></tr></table></div><p>Once you have created a style object<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_917"></a>, you can pass it to any ATSUI function that takes a style object as a parameter, such as the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUSetRunStyle" target="_top">ATSUSetRunStyle</a></code>. You can pass an array of style objects to such functions as <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUCreateTextLayoutWithTextPtr" target="_top">ATSUCreateTextLayoutWithTextPtr</a></code> to define the attributes for style runs in a text layout object.<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_918"></a></p><a name="//apple_ref/doc/uid/TP30000030-TPXREF154" title="Creating a Text Layout Object and Setting Attributes"></a><h2>Creating a Text Layout Object and Setting Attributes</h2><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_919"></a><p>ATSUI text layout objects are opaque objects that contain a pointer or handle to a block of Unicode text, style run information, and line and layout controls for the block of text. </p><p>To create an ATSUI text layout object, you must do the following:</p><ol class="ol"><li class="li"><p>Declare storage for the text layout.</p><p>For example:</p><div class="codesample"><table><tr><td scope="row"><pre>ATSUTextLayout  myTextLayout;<span></span></pre></td></tr></table></div></li><li class="li"><p>Create the text layout object by calling the functions <code>ATSUCreateTextLayout</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_920"></a> or <code>ATSUCreateTextLayoutWithTextPtr</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_921"></a>.</p><p>For example, the following code creates a text layout object (<code>myTextLayout</code>) for an entire text buffer (<code>myTextBlock</code>):</p><div class="codesample"><table><tr><td scope="row"><pre>OSStatus       status = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>UniCharCount length = kATSUToTextEnd;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>status = ATSUCreateTextLayoutWithTextPtr ((UniChar*) myTextBlock,<span></span></pre></td></tr><tr><td scope="row"><pre>                kATSUFromTextBeginning,  // offset from beginning<span></span></pre></td></tr><tr><td scope="row"><pre>                kATSUToTextEnd,         // length of text range<span></span></pre></td></tr><tr><td scope="row"><pre>                myTextBlockLength,      // length of text buffer<span></span></pre></td></tr><tr><td scope="row"><pre>                1,                      // number of style runs<span></span></pre></td></tr><tr><td scope="row"><pre>                &amp;length,         // length of the style run<span></span></pre></td></tr><tr><td scope="row"><pre>                &amp;myArrayOfStyleObjects,<span></span></pre></td></tr><tr><td scope="row"><pre>                &amp;myTextLayout);<span></span></pre></td></tr></table></div><p>On output, <code>myTextLayout</code> refers to the newly created text layout object. Note that you own the text in the buffer you pass to the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUCreateTextLayoutWithTextPtr" target="_top">ATSUCreateTextLayoutWithTextPtr</a></code>.</p><p>Each ATSUI text layout can have no more than 64,000 different styles. </p></li><li class="li"><p>Set up a triple (tag, size, value) for each line and layout attribute associated with the text layout.</p><p>Typically, you declare three parallel arrays, one for attribute tags, one for sizes, and the third array for the value of the attribute. ATSUI supplies constants that specify attribute tags. For example, the following code sets up two attributes—flushness (<code>kATSULineFlushFactorTag</code>) and justification (<code>kATSULineJustificationFactorTag</code>):</p><div class="codesample"><table><tr><td scope="row"><pre>ATSUAttributeTag  theTags[] =  {kATSULineFlushFactorTag,<span></span></pre></td></tr><tr><td scope="row"><pre>                            kATSULineJustificationFactorTag};<span></span></pre></td></tr><tr><td scope="row"><pre>ByteCount   theSizes[] = {sizeof(Fract), sizeof(Fract)};<span></span></pre></td></tr><tr><td scope="row"><pre>Fract   myFlushFactor = kATSUStartAlignment;<span></span></pre></td></tr><tr><td scope="row"><pre>Fract   myJustFactor = kATSUFullJustification;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ATSUAttributeValuePtr theValues[] = {&amp;myFlushFactor, &amp;myJustFactor};<span></span></pre></td></tr></table></div><p>See <span class="content_text"><a href="../atsui_chap3/atsui_concepts2.html#//apple_ref/doc/uid/TP30000029-TPXREF165">“Line and Layout Attributes ”</a></span> for more information on the attribute tags available in ATSUI.</p></li><li class="li"><p>Associate the line and layout attributes with the text layout object by calling the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUSetLayoutControls" target="_top">ATSUSetLayoutControls</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_922"></a>.</p><p>For example:</p><div class="codesample"><table><tr><td scope="row"><pre>status = ATSUSetLayoutControls (myTextLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                            2,<span></span></pre></td></tr><tr><td scope="row"><pre>                            theTags,<span></span></pre></td></tr><tr><td scope="row"><pre>                            theSizes,<span></span></pre></td></tr><tr><td scope="row"><pre>                            theValues);<span></span></pre></td></tr></table></div></li></ol><p>You can also create a text layout object by calling the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUCreateAndCopyTextLayout" target="_top">ATSUCreateAndCopyTextLayout</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_923"></a>. This function is useful if you want all text layout objects in your application to use the same line and layout attributes. After you have created the new text layout object, you can call the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUSetTextPointerLocation" target="_top">ATSUSetTextPointerLocation</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_924"></a> to associate the new text layout object with the appropriate block of text. <a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_925"></a></p><a name="//apple_ref/doc/uid/TP30000030-TPXREF186" title="Determining Paragraphs in a Unicode Text Block"></a><h2>Determining Paragraphs in a Unicode Text Block</h2><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_926"></a><p>This section shows you how to find a <a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_927"></a>paragraph within a block of Unicode text. Although determining paragraphs is not a task that uses ATSUI functions, breaking a block of text into paragraph-sized chunks is important if you want to use ATSUI efficiently. Once the text is broken into paragraphs, you can create a text layout object<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_928"></a> for each paragraph.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_17" title="Tip"></a><p><strong>Tip:</strong>&nbsp;To get the best performance from ATSUI, a text layout object should be associated with a paragraph of text.</p></div><p>To find a paragraph, you can write code that performs steps similar to the following:</p><ol class="ol"><li class="li"><p>Define Unicode characters that act as paragraph separators. Exactly what you choose to define as a paragraph separator depends on the needs of your specific application. For example, these five character sequences can be used to separate paragraphs:</p><ul class="ul"><li class="li"><p>ASCII newline '\n' </p></li><li class="li"><p>ASCII return '\r'</p></li><li class="li"><p>ASCII return followed by ASCII newline</p></li><li class="li"><p>Unicode line separator</p></li><li class="li"><p>Unicode paragraph separator</p></li></ul></li><li class="li"><p>Iterate through the block of text until you find a paragraph separator.</p></li></ol><p>The code in <span class="content_text">Listing 3-2</span> shows a <code><!--a-->MyFindParagraph<!--/a--></code> function that takes a block of Unicode text, the total length of the text block, and an offset into the text. The function finds the next paragraph separator and returns whether or not the function reached the end of the text block. A detailed explanation for each numbered line of code appears following the listing.</p><a name="//apple_ref/doc/uid/TP30000030-BCIIFFCD" title="Listing 3-2A function to find a paragraph in a block of Unicode text"></a><p class="codesample"><strong>Listing 3-2&nbsp;&nbsp;</strong>A function to find a paragraph in a block of Unicode text</p><div class="codesample"><table><tr><td scope="row"><pre>Boolean MyFindParagraph (UniChar *theText,<span></span></pre></td></tr><tr><td scope="row"><pre>                    UniCharCount theTextLength,<span></span></pre></td></tr><tr><td scope="row"><pre>                    UniCharArrayOffset paragraphStart,<span></span></pre></td></tr><tr><td scope="row"><pre>                    UniCharArrayOffset *paragraphEnd)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    UniChar         CR   = 0x000D;  <span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    UniChar         LF   = 0x000A;  <span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    UniChar         LSEP = 0x2028;  <span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    UniChar         PSEP = 0x2029;  <span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    UniChar         NL   = 0x0085;<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>    UniCharCount    currentPosition;<span></span></pre></td></tr><tr><td scope="row"><pre>    UniChar         currentChar;<span></span></pre></td></tr><tr><td scope="row"><pre>    Boolean         endOfText = false;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (theText == NULL) <span>// 6</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        *paragraphEnd = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>        return true;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    for (currentPosition=paragraphStart; (currentPosition &lt; theTextLength);<span></span></pre></td></tr><tr><td scope="row"><pre>                                currentPosition++) <span>// 7</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        currentChar = theText[currentPosition];<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        if ( (currentChar == PSEP) || (currentChar ==  LSEP) ||<span></span></pre></td></tr><tr><td scope="row"><pre>                            (currentChar ==  LF) || (currentChar ==  NL))<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            break;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        if ( currentChar == CR )<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            if ( currentPosition &lt; (theTextLength - 1) )<span></span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                if ( theText[currentPosition + 1] == LF ) <span>// 8</span></pre></td></tr><tr><td scope="row"><pre>                    currentPosition++;<span></span></pre></td></tr><tr><td scope="row"><pre>             }<span></span></pre></td></tr><tr><td scope="row"><pre>            break;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (currentPosition == theTextLength)<span></span></pre></td></tr><tr><td scope="row"><pre>                    currentPosition--;<span>// 9</span></pre></td></tr><tr><td scope="row"><pre>    if (currentPosition == (theTextLength - 1))<span></span></pre></td></tr><tr><td scope="row"><pre>                    endOfText = true;<span>// 10</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    *paragraphEnd = currentPosition + 1;<span>// 11</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return endOfText;<span>// 12</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Declares a variable to represent the ASCII return character.</p></li><li class="li"><p>Declares a variable to represent the ASCII newline character.</p></li><li class="li"><p>Declares a variable to represent the Unicode line separator character.</p></li><li class="li"><p>Declares a variable to represent the Unicode paragraph separator character.</p></li><li class="li"><p>Declares a variable to represent the Unicode next line character that is a C1 control used by XML for line breaks.</p></li><li class="li"><p>Checks to see if there is text to process. If the pointer is <code>NULL</code>, returns from the function.</p></li><li class="li"><p>Iterates through the block of text until it finds a character sequence that indicates the end of a paragraph.</p></li><li class="li"><p>Treats the ASCII new line and ASCII return combination as if it were a single entity, by advancing through the text buffer accordingly.</p></li><li class="li"><p>Checks for the special case of reaching the end of the text without finding a paragraph. In this case, the current position must be decremented by one.</p></li><li class="li"><p>Checks to see if it reached the end of the text buffer.</p></li><li class="li"><p>Returns the position just after the end of the paragraph. This position is returned because an ATSUI-style offset is between array elements (an edge offset). See <span class="content_text"><a href="../atsui_chap2/atsui_concepts.html#//apple_ref/doc/uid/TP30000028-TP1">“Typography Concepts”</a></span> for information on edge offsets in ATSUI.</p></li><li class="li"><p>Returns a Boolean value to indicate whether the end of text was reached (<code>true</code>) or not (<code>false</code>).<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_929"></a><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_930"></a></p></li></ol><a name="//apple_ref/doc/uid/TP30000030-TPXREF184" title="Drawing Horizontal Text"></a><h2>Drawing Horizontal Text</h2><p>Drawing tex<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_931"></a>t is easy once you have created a text layout object and associated text with the object. You call the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUDrawText" target="_top">ATSUDrawText</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_932"></a>, as shown in the following code:</p><div class="codesample"><table><tr><td scope="row"><pre>ATSUDrawText (myTextLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>            kATSUFromTextBeginning,<span></span></pre></td></tr><tr><td scope="row"><pre>            kATSUToTextEnd,<span></span></pre></td></tr><tr><td scope="row"><pre>            myXLocation,<span></span></pre></td></tr><tr><td scope="row"><pre>            myYLocation);<span></span></pre></td></tr></table></div><p>The function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUDrawText" target="_top">ATSUDrawText</a></code> take five parameters:</p><ul class="ul"><li class="li"><p>A text layout object. See <span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF154">“Creating a Text Layout Object and Setting Attributes”</a></span> for information on how to create a text layout object.</p></li><li class="li"><p>The offset from the beginning of the text to the first character that should be rendered.</p></li><li class="li"><p>The length of the text range to render. The constant <code>kATSUToTextEnd</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_933"></a> specifies to render to the end of the text buffer.</p></li><li class="li"><p>The x-coordinate of the origin at which to render the text. You specify QuickDraw or Quartz 2D coordinates, depending on whether you are using a QuickDraw port or a Quartz graphics context (<code>CGContext</code>). Coordinates must be specified as <code>Fixed</code> values.</p></li><li class="li"><p>The y-coordinate of the origin at which to render the text. </p></li></ul><div class="notebox"><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_18" title="Note"></a><p><strong>Note:</strong>&nbsp;If you want to draw highlighted text, see <span class="content_text"><a href="../atsui_chap5/atsui_interact_tasks.html#//apple_ref/doc/uid/TP30000031-TPXREF149">“Highlighting Selected Text .”</a></span></p></div><a name="//apple_ref/doc/uid/TP30000030-TPXREF183" title="Drawing Text Using a Quartz Context"></a><h2>Drawing Text Using a Quartz Context</h2><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_934"></a><p>With Mac OS X version 10.2, ATSUI renders text through Quartz, even if you do not attach a <code>CGContext</code> to a text layout object. In this default case, ATSUI retrieves the internal canonical <code>CGContext</code> of the current port, and renders to that port using Quartz at an anti-aliasing setting that simulates QuickDraw rendering. That is, a 4-bit pixel-aligned anti-aliasing. With this method of rendering, the origins of the glyphs always fall on integer positions and can lead to less-than-ideal glyph placements even after ATSUI makes fine adjustments to the integer positioning. This section shows you how to you set up ATSUI to instead use an <a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_935"></a>8-bit, subpixel rendering. Using this method of rendering, glyph origins are positioned on fractional points, resulting in superior rendering compared to ATSUI’s default 4-bit pixel-aligned rendering.</p><p>To set up ATSUI to use an 8-bit, subpixel rendering through Quartz, you must perform the following tasks:</p><ol class="ol"><li class="li"><p>Set up a Quartz context (<code>CGContext</code>) for your application by using the QuickDraw function <code><a href="../../../Reference/QuickDraw_Ref/Reference/reference.html#//apple_ref/doc/c_ref/QDBeginCGContext" target="_top">QDBeginCGContext</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_936"></a>. When you are done using the <code>CGContext</code>, you must call the function <code><a href="../../../Reference/QuickDraw_Ref/Reference/reference.html#//apple_ref/doc/c_ref/QDEndCGContext" target="_top">QDEndCGContext</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_937"></a>.</p><p>You need to call the function <code><a href="../../../Reference/QuickDraw_Ref/Reference/reference.html#//apple_ref/doc/c_ref/QDBeginCGContext" target="_top">QDBeginCGContext</a></code> only once in your application, as you should use the same <code>CGContext</code> until all drawing is completed.</p></li><li class="li"><p>Set the Quartz context as a layout attribute for the text layout object whose text you want to draw, using the tag <code>kATSUCGContextTag</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_938"></a>, and by calling the function <code>ATSUSetLayoutControls</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_939"></a>.</p><p>For example, if you already set up a Quartz context named <code>myCGContext</code>, you use the following code to set the Quartz context as an attribute of a text layout object (<code>myTextLayout</code>) you created previously:</p><div class="codesample"><table><tr><td scope="row"><pre>ATSUAttributeTag        theTags[0] = kATSUCGContextTag;<span></span></pre></td></tr><tr><td scope="row"><pre>ByteCount               theSizes[0] = sizeof (CGContextRef);<span></span></pre></td></tr><tr><td scope="row"><pre>ATSUAttributeValuePtr   theValues[] = &amp;myCGContext;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ATSUSetLayoutControls (myTextLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                    1,<span></span></pre></td></tr><tr><td scope="row"><pre>                    theTags,<span></span></pre></td></tr><tr><td scope="row"><pre>                    theSizes,<span></span></pre></td></tr><tr><td scope="row"><pre>                    theValues);<span></span></pre></td></tr></table></div></li></ol><p>When you use Quartz<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_940"></a> with ATSUI, you can use all the effects available through Quartz 2D. You can rotate the Quartz context to achieve a number of effects, such as the angled text as shown in <span class="content_text">Figure 3-1</span> and the rotated text shown in <span class="content_text">Figure 3-2</span>. </p><p><span class="content_text">Listing 3-3</span> shows the code necessary to draw rotated text using Quartz 2D. First, you call the Quartz 2D function <code><a href="../../../../GraphicsImaging/Reference/CGContext/Reference/reference.html#//apple_ref/doc/c_ref/CGContextRotateCTM" target="_top">CGContextRotateCTM</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_941"></a> to rotate the Quartz context by a specified angle. Then, when you call the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUDrawText" target="_top">ATSUDrawText</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_942"></a>, the text is drawn into the rotated context. The text appears on the screen when you call the function <code><a href="../../../../GraphicsImaging/Reference/CGContext/Reference/reference.html#//apple_ref/doc/c_ref/CGContextFlush" target="_top">CGContextFlush</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_943"></a>. </p><br/><div><a name="//apple_ref/doc/uid/TP30000030-TPXREF168" title="Figure 3-1Text drawn at an angle"></a><p><strong>Figure 3-1&nbsp;&nbsp;</strong>Text drawn at an angle</p><img src = "../art/angledasiantext.gif" alt = "Text drawn at an angle" width="254" height="334"></div><br/><a name="//apple_ref/doc/uid/TP30000030-BCIDEBDG" title="Listing 3-3Using a Quartz context to rotate text"></a><p class="codesample"><strong>Listing 3-3&nbsp;&nbsp;</strong>Using a Quartz context to rotate text</p><div class="codesample"><table><tr><td scope="row"><pre>CGContextRotateCTM (myCGContext, myAngle);<span></span></pre></td></tr><tr><td scope="row"><pre>ATSUDrawText (myTextLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>            kATSUFromTextBeginning,<span></span></pre></td></tr><tr><td scope="row"><pre>            kATSUToTextEnd,<span></span></pre></td></tr><tr><td scope="row"><pre>            myXLocation,<span></span></pre></td></tr><tr><td scope="row"><pre>            myXLocation);<span></span></pre></td></tr><tr><td scope="row"><pre>CGContextFlush (myCGContext);<span></span></pre></td></tr></table></div><div class="notebox"><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_19" title="Tip"></a><p><strong>Tip:</strong>&nbsp;You can draw more than once into a Quartz context without calling the function <code><a href="../../../../GraphicsImaging/Reference/CGContext/Reference/reference.html#//apple_ref/doc/c_ref/CGContextFlush" target="_top">CGContextFlush</a></code>. This is the most optimal way to do batch drawing using a Quartz context.</p></div><br/><div><a name="//apple_ref/doc/uid/TP30000030-BCIFIHIB" title="Figure 3-2Rotated text"></a><p><strong>Figure 3-2&nbsp;&nbsp;</strong>Rotated text</p><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_944"></a><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_945"></a><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_946"></a><img src = "../art/rotatedtext.gif" alt = "Rotated text" width="337" height="337"></div><br/><a name="//apple_ref/doc/uid/TP30000030-BCIDEAIA" title="Drawing Equations"></a><h2>Drawing Equations</h2><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_947"></a><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_948"></a><p><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_949"></a>Drawing scientific and mathematical equations often requires drawing subscripts and superscripts, such as those shown in <span class="content_text">Figure 3-3</span>. You can draw characters as subscripts or a superscripts by applying the tag <code>kATSUCrossStreamShiftTag</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_950"></a> to the characters. For horizontal text, a positive cross-stream value shifts a glyph upwards, whereas a negative cross-stream value shifts a glyph downwards. You also need to adjust the font size of the subscripts and superscripts appropriately, as these characters are usually drawn with a smaller font size than that used for the main characters of the equation.</p><br/><div><a name="//apple_ref/doc/uid/TP30000030-TPXREF158" title="Figure 3-3A scientific equation drawn by adjusting cross-stream shift values"></a><p><strong>Figure 3-3&nbsp;&nbsp;</strong>A scientific equation drawn by adjusting cross-stream shift values</p><img src = "../art/bigequation.gif" alt = "A scientific equation drawn by adjusting cross-stream shift values" width="235" height="53"></div><br/><p>You can create styles for subscripts and superscripts when your application launches, and use the styles whenever you need to draw an equation. You need to perform the following steps to set up subscript and superscript styles:</p><ol class="ol"><li class="li"><p>Allocate space for the ATSUI style objects.</p><p>The subscript and superscript styles are based on a default style object.</p><div class="codesample"><table><tr><td scope="row"><pre>ATSUStyle       myDefaultStyle.<span></span></pre></td></tr><tr><td scope="row"><pre>                mySubscriptStyle,<span></span></pre></td></tr><tr><td scope="row"><pre>                mySuperscriptStyle;<span></span></pre></td></tr></table></div></li><li class="li"><p>Create and set attributes for the default style.</p><p>As for any style, you must set up a triple (tag, size, value) for each attribute and call the function <code>ATSUSetAttributes</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_951"></a> to apply the attributes to the style.</p><div class="codesample"><table><tr><td scope="row"><pre>ATSUCreateStyle (&amp;myDefaultStyle);<span></span></pre></td></tr><tr><td scope="row"><pre>ATSUAttributeTag  theTags[] =  {kATSUSizeTag, kATSUQDItalicTag};<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ByteCount theSizes[] = {sizeof (Fixed), sizeof (Boolean)};<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>Fixed       myFontSize = Long2Fix (myDefaultSize);<span></span></pre></td></tr><tr><td scope="row"><pre>Boolean     isItalic = FALSE;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ATSUAttributeValuePtr theValues[] = {&amp;myFontSize, &amp;isItalic};<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>status = ATSUSetAttributes (gDefaultStyle, 2,<span></span></pre></td></tr><tr><td scope="row"><pre>                            theTags, theSizes, theValues);<span></span></pre></td></tr></table></div></li><li class="li"><p>Create and set attributes for the subscript style.<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_952"></a></p><div class="codesample"><table><tr><td scope="row"><pre>ATSUCreateAndCopyStyle (myDefaultStyle, &amp;mySubScriptStyle);<span></span></pre></td></tr><tr><td scope="row"><pre>ATSUAttributeTag  theTags[] =  { kATSUSizeTag,<span></span></pre></td></tr><tr><td scope="row"><pre>                                kATSUCrossStreamShiftTag};<span></span></pre></td></tr><tr><td scope="row"><pre>ByteCount theSizes[] = {sizeof(Fixed),<span></span></pre></td></tr><tr><td scope="row"><pre>                        sizeof(Fixed)};<span></span></pre></td></tr><tr><td scope="row"><pre>Fixed    mySubScriptSize = Long2Fix (myDefaultSize - 2);<span></span></pre></td></tr><tr><td scope="row"><pre>Fixed    mySubScriptShift = Long2Fix (-6);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ATSUAttributeValuePtr theValues[] = {&amp;mySubScriptSize,<span></span></pre></td></tr><tr><td scope="row"><pre>                                     &amp;mySubScriptShift};<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>status = ATSUSetAttributes (mySubScriptStyle, 2,<span></span></pre></td></tr><tr><td scope="row"><pre>                            theTags, theSizes, theValues);<span></span></pre></td></tr></table></div></li><li class="li"><p>Create and set attributes for the superscript style.</p><div class="codesample"><table><tr><td scope="row"><pre>ATSUCreateAndCopyStyle (myDefaultStyle, &amp;mySuperScriptStyle);<span></span></pre></td></tr><tr><td scope="row"><pre>ATSUAttributeTag  theTags[] =  { kATSUSizeTag,<span></span></pre></td></tr><tr><td scope="row"><pre>                                 kATSUCrossStreamShiftTag};<span></span></pre></td></tr><tr><td scope="row"><pre>ByteCount theSizes[] = {sizeof(Fixed), sizeof(Fixed)};<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>Fixed    mySuperScriptSize = Long2Fix (myDefaultSize - 2);<span></span></pre></td></tr><tr><td scope="row"><pre>Fixed    mySuperScriptShift = Long2Fix (6);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ATSUAttributeValuePtr theValues[] = {&amp;mySuperScriptSize,<span></span></pre></td></tr><tr><td scope="row"><pre>                                     &amp;mySuperScriptShift};<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>status = ATSUSetAttributes (mySuperScriptStyle, 2,<span></span></pre></td></tr><tr><td scope="row"><pre>                            theTags, theSizes, theValues);<span></span></pre></td></tr></table></div></li></ol><p>You should keep these styles around as long as you need them. Style objects are independent of text; you can use them over and over.</p><p>You can apply the subscript and superscript styles to the appropriate characters in an equation by following these steps:<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_953"></a><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_954"></a></p><ol class="ol"><li class="li"><p>Create a text layout object for the equation text.<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_955"></a></p><p>Use the default style on the entire text string to create the text layout object.</p><div class="codesample"><table><tr><td scope="row"><pre>length = sizeof(myPhysicsEquation)/sizeof(UniChar);<span></span></pre></td></tr><tr><td scope="row"><pre>status = ATSUCreateTextLayoutWithTextPtr ((UniChar*) myPhysicsEquation,<span></span></pre></td></tr><tr><td scope="row"><pre>                            0,<span></span></pre></td></tr><tr><td scope="row"><pre>                            length,<span></span></pre></td></tr><tr><td scope="row"><pre>                            length,<span></span></pre></td></tr><tr><td scope="row"><pre>                            1,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;length,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;myDefaultStyle,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;myEquationLayout);<span></span></pre></td></tr></table></div></li><li class="li"><p>You may need to set up transient font matching to assure that the glyphs in the equation are rendered appropriately. </p><div class="codesample"><table><tr><td scope="row"><pre>status = ATSUSetTransientFontMatching (myEquationLayout, true);<span></span></pre></td></tr></table></div></li><li class="li"><p>Set the subscript and superscript styles.</p><p>You apply the subscript and superscript styles to the appropriate characters by calling the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUSetRunStyle" target="_top">ATSUSetRunStyle</a></code>. You must specify the starting character to which the style applies and specify the number of characters in the style run.<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_956"></a></p><div class="codesample"><table><tr><td scope="row"><pre>status = ATSUSetRunStyle (myEquationLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                        mySubScriptStyle,<span></span></pre></td></tr><tr><td scope="row"><pre>                        myStartofSubScript,<span></span></pre></td></tr><tr><td scope="row"><pre>                        myCharsInSubScript);<span></span></pre></td></tr><tr><td scope="row"><pre> status = ATSUSetRunStyle (myEquationLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                        mySuperScriptStyle,<span></span></pre></td></tr><tr><td scope="row"><pre>                        myStartofSuperScript,<span></span></pre></td></tr><tr><td scope="row"><pre>                        myCharsInSubScript);<span></span></pre></td></tr></table></div></li><li class="li"><p>Draw the equation.<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_957"></a><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_958"></a></p><div class="codesample"><table><tr><td scope="row"><pre>ATSUDrawText (myEquationLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                kATSUFromTextBeginning,<span></span></pre></td></tr><tr><td scope="row"><pre>                sizeof(myPhysicsEquation)/sizeof(UniChar),<span></span></pre></td></tr><tr><td scope="row"><pre>                Long2Fix (myXPenLocation),<span></span></pre></td></tr><tr><td scope="row"><pre>                Long2Fix (myYPenLocation));<span></span></pre></td></tr></table></div></li></ol><a name="//apple_ref/doc/uid/TP30000030-BCIJAHHE" title="Drawing Vertical Text"></a><h2>Drawing Vertical Text</h2><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_959"></a><p><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_960"></a>If you want to draw text vertically—for example Chinese, Japanese, or Korean text—you must set up ATSUI to use vertical forms of the glyphs and rotate the line. The vertical form of a glyph is a style attribute; whereas line rotation is a line and layout attribute. If you simply rotate a line without also setting up ATSUI to use vertical forms of the glyphs<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_961"></a>, you get a result similar to that shown in <span class="content_text">Figure 3-4</span>. If you use vertical forms of the glyphs and then rotate the line, you get results similar to that shown in <span class="content_text">Figure 3-5</span>. Compare the glyphs in the center of the third column in <span class="content_text">Figure 3-5</span> with <span class="content_text">Figure 3-4</span> to see the effect of rotating both the glyphs and the line.</p><br/><div><a name="//apple_ref/doc/uid/TP30000030-BCIGDDHH" title="Figure 3-4A rotated line of text that does not use vertical forms of the glyphs"></a><p><strong>Figure 3-4&nbsp;&nbsp;</strong>A rotated line of text that does not use vertical forms of the glyphs</p><img src = "../art/unrotatedglyph.gif" alt = "A rotated line of text that does not use vertical forms of the glyphs" width="25" height="134"></div><br/><br/><div><a name="//apple_ref/doc/uid/TP30000030-BCIDFBGD" title="Figure 3-5A rotated line of text that uses vertical forms of the glyphs"></a><p><strong>Figure 3-5&nbsp;&nbsp;</strong>A rotated line of text that uses vertical forms of the glyphs</p><img src = "../art/verticaltext.gif" alt = "A rotated line of text that uses vertical forms of the glyphs" width="106" height="400"></div><br/><p>To draw vertical text (rotated line and rotated glyphs), perform the following steps:</p><ol class="ol"><li class="li"><p>Create a style object and set it to use vertical forms.</p><p>You can base this style object on a default style object that you’ve already created for your application. </p><p>As for any style, you must set up a triple (tag, size, value) for each attribute and call the function <code>ATSUSetAttributes</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_962"></a> to apply the attributes to the style.<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_963"></a></p><div class="codesample"><table><tr><td scope="row"><pre>ATSUCreateAndCopyStyle(myDefaultStyle, &amp;myVerticalStyle);<span></span></pre></td></tr><tr><td scope="row"><pre>ATSUVerticalCharacterType verticalType = kATSUStronglyVertical;<span></span></pre></td></tr><tr><td scope="row"><pre>theTags[0] = kATSUVerticalCharacterTag;<span></span></pre></td></tr><tr><td scope="row"><pre>theSizes[0] = sizeof (ATSUVerticalCharacterType);<span></span></pre></td></tr><tr><td scope="row"><pre>theValues[0] = &amp;verticalType;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ATSUSetAttributes (myVerticalStyle, 1,<span></span></pre></td></tr><tr><td scope="row"><pre>                    theTags, theSizes, theValues);<span></span></pre></td></tr></table></div></li><li class="li"><p>Rotate the line by setting line rotation as a layout attribute.</p><p>As for any line or layout attribute, you must set up a triple (tag, size, value) for each attribute and call the function <code>ATSUSetLayoutControls</code> to apply the attributes to the text layout object.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_20" title="Note"></a><p><strong>Note:</strong>&nbsp;It is also possible to rotate the line by setting up a Quartz context and then rotating it. However, you should use ATSUI line rotation if you need to perform hit-testing on the text.</p></div><div class="codesample"><table><tr><td scope="row"><pre>ATSUCreateTextLayoutWithTextPtr(<span></span></pre></td></tr><tr><td scope="row"><pre>                (UniChar *) myTextString,<span></span></pre></td></tr><tr><td scope="row"><pre>                myOffset,<span></span></pre></td></tr><tr><td scope="row"><pre>                length,<span></span></pre></td></tr><tr><td scope="row"><pre>                totalLength,<span></span></pre></td></tr><tr><td scope="row"><pre>                styleRunCount,<span></span></pre></td></tr><tr><td scope="row"><pre>                &amp;length,<span></span></pre></td></tr><tr><td scope="row"><pre>                &amp;myVerticalStyle,<span></span></pre></td></tr><tr><td scope="row"><pre>                &amp;myTextLayout);<span></span></pre></td></tr><tr><td scope="row"><pre>Fixed myAngleToRotateText = FloatToFixed (-90.0); // degrees<span></span></pre></td></tr><tr><td scope="row"><pre>theTags[0] = kATSULineRotationTag;<span></span></pre></td></tr><tr><td scope="row"><pre>theSizes[0] = sizeof (Fixed);<span></span></pre></td></tr><tr><td scope="row"><pre>theValues[0] = &amp;myAngleToRotateText;<span></span></pre></td></tr><tr><td scope="row"><pre>ATSUSetLayoutControls (myTextLayout, 1,<span></span></pre></td></tr><tr><td scope="row"><pre>                        theTags, theSizes, theValuePtrs);<span></span></pre></td></tr></table></div></li><li class="li"><p>Draw the text.<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_964"></a><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_965"></a></p><div class="codesample"><table><tr><td scope="row"><pre>ATSUDrawText (myTextLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                kATSUFromTextBeginning,<span></span></pre></td></tr><tr><td scope="row"><pre>                sizeof(myTextString)/sizeof(UniChar),<span></span></pre></td></tr><tr><td scope="row"><pre>                Long2Fix (myXPenLocation),<span></span></pre></td></tr><tr><td scope="row"><pre>                Long2Fix (myYPenLocation));<span></span></pre></td></tr></table></div></li></ol><a name="//apple_ref/doc/uid/TP30000030-TPXREF159" title="Breaking Lines"></a><h2>Breaking Lines</h2><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_966"></a><p>ATSUI provides two functions for calculating and setting soft line breaks programmatically: <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBreakLine" target="_top">ATSUBreakLine</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_967"></a> and <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBatchBreakLines" target="_top">ATSUBatchBreakLines</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_968"></a>. Calling the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBatchBreakLines" target="_top">ATSUBatchBreakLines</a></code> is equivalent to repeatedly calling the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBreakLine" target="_top">ATSUBreakLine</a></code>, as shown in <span class="content_text">Listing 3-4</span>. It’s preferable that you use <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBatchBreakLines" target="_top">ATSUBatchBreakLines</a></code> because this function performs more efficiently than repeated calls to <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBreakLine" target="_top">ATSUBreakLine</a></code>. </p><p>The code fragment in <span class="content_text">Listing 3-4</span> compares batch line breaking to calculating breaks on a line-by-line basis. A detailed explanation for each numbered line of code appears following the listing. If you’ve used the <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBreakLine" target="_top">ATSUBreakLine</a></code> function before, you’ll see that replacing it with <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBatchBreakLines" target="_top">ATSUBatchBreakLines</a></code> reduces your code by a few lines and improves the performance of your application. </p><a name="//apple_ref/doc/uid/TP30000030-BAJFAABI" title="Listing 3-4A code fragment that performs line breaking"></a><p class="codesample"><strong>Listing 3-4&nbsp;&nbsp;</strong>A code fragment that performs line breaking</p><div class="codesample"><table><tr><td scope="row"><pre>ATSUTextLayout       myTextLayout;<span></span></pre></td></tr><tr><td scope="row"><pre>Fixed                myLineBreakWidth;<span></span></pre></td></tr><tr><td scope="row"><pre>ItemCount            myNumSoftBreaks;<span></span></pre></td></tr><tr><td scope="row"><pre>UniCharCount         myTextLength;<span></span></pre></td></tr><tr><td scope="row"><pre>UniCharArrayOffset   *mySoftBreaks,<span></span></pre></td></tr><tr><td scope="row"><pre>                     myStarting Offset,<span></span></pre></td></tr><tr><td scope="row"><pre>                     myCurrentStart,<span></span></pre></td></tr><tr><td scope="row"><pre>                     myCurrentEnd;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> /* Insert your code to set up the text layout object<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#if USE_BATCHBREAKLINES <span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    ATSUBatchBreakLines (myTextLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                            myStartingOffset,<span></span></pre></td></tr><tr><td scope="row"><pre>                            myTextLength,<span></span></pre></td></tr><tr><td scope="row"><pre>                            myLineBreakWidth,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;myNumSoftBreaks);<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>#else<span></span></pre></td></tr><tr><td scope="row"><pre>    myCurrentStart = myStartingOffset;<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    myCurrentEnd = myTextLength;<span></span></pre></td></tr><tr><td scope="row"><pre>    do<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        status = ATSUBreakLine (myTextLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                            myCurrentStart,<span></span></pre></td></tr><tr><td scope="row"><pre>                            myLineBreakWidth,<span></span></pre></td></tr><tr><td scope="row"><pre>                            true,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;myCurrentEnd);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>        myCurrentStart = myCurrentEnd;<span></span></pre></td></tr><tr><td scope="row"><pre>    } while (myCurrentEnd &lt; myTextLength);<span></span></pre></td></tr><tr><td scope="row"><pre>#endif<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ATSUGetSoftLineBreaks (myTextLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>            kATSUFromTextBeginning,<span></span></pre></td></tr><tr><td scope="row"><pre>            kATSUToTextEnd,<span></span></pre></td></tr><tr><td scope="row"><pre>            0, NULL, &amp;myNumSoftBreaks);<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>mySoftBreaks = (UniCharArrayOffset *) malloc(myNumSoftBreaks *<span></span></pre></td></tr><tr><td scope="row"><pre>                     sizeof(UniCharArrayOffset));<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>ATSUGetSoftLineBreaks (myTextLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>            kATSUFromTextBeginning,<span></span></pre></td></tr><tr><td scope="row"><pre>            kATSUToTextEnd,<span></span></pre></td></tr><tr><td scope="row"><pre>            myNumSoftBreaks, mySoftBreaks, &amp;myNumSoftBreaks);<span>// 7</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> // Insert your code here to loop over all the soft breaks and draw them<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>free (mySoftBreaks);<span>// 8</span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Checks to see if batch line breaking should be used. This code is here only to illustrate the difference between batch line breaking and using the older function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBreakLine" target="_top">ATSUBreakLine</a></code>.</p></li><li class="li"><p>Calls the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBatchBreakLines" target="_top">ATSUBatchBreakLines</a></code>. You must supply the text layout object that is associated with the text you want to process. You must also supply a starting offset, the length of the text, and a line width. ATSUI returns the number of soft breaks that are calculated. </p></li><li class="li"><p>If batch line breaking isn’t used, sets up variables for the starting and ending offsets of the text for which you want to calculate line breaks.</p></li><li class="li"><p>Calls the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBreakLine" target="_top">ATSUBreakLine</a></code> to calculate line breaks. The parameter <code>iUseAsSoftLineBreak</code> is set to <code>true</code> to indicate that ATSUI should automatically set the line break to the value returned by the <code>oLineBreak</code> parameter (<code>myCurrentEnd</code>). You must also provide as parameters the first character of the text range associated with the text layout object and the line width.</p></li><li class="li"><p>Calls the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetSoftLineBreaks" target="_top">ATSUGetSoftLineBreaks</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_969"></a> to obtain the number of soft line breaks calculated by ATSUI. This is a function you typically call twice. The first time, pass <code>NULL</code> for the <code>oBreaks</code> parameter to obtain the number of line breaks. Then, allocate memory for the line break array and call the function again to obtain the array, as shown in the next two steps.</p></li><li class="li"><p>Allocates the appropriate amount of memory for the line break array.</p></li><li class="li"><p>Calls the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetSoftLineBreaks" target="_top">ATSUGetSoftLineBreaks</a></code> a second time, but this time passes an array of the appropriate size. On output, the array contains offsets from the beginning of the text buffer to each of the soft line breaks in the text range.</p></li><li class="li"><p>Frees the previously allocated memory.</p></li></ol><p>Although it is possible for you to set soft line breaks instead of letting ATSUI do it for you (by passing <code>false</code> for the parameter <code>iUseAsSoftLineBreak</code>), you shouldn’t do so unless it is absolutely necessary. See <span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF139">“Flowing Text Around a Graphic ”</a></span> for an example of using the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBreakLine" target="_top">ATSUBreakLine</a></code> to set line breaks.<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_970"></a></p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_21" title="Tip"></a><p><strong>Tip:</strong>&nbsp;You get better performance from ATSUI when you set soft line breaks programmatically.</p></div><a name="//apple_ref/doc/uid/TP30000030-TPXREF155" title="Measuring Text"></a><h2>Measuring Text</h2><p>The trick with measuring text<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_971"></a> is to choose the appropriate function to obtain text measurements. In most cases, an application needs to obtain the typographic bounds of a line of text after final layout. After-layout typographic bounds take into account rotation and other layout attributes that have been applied to the line. If these are the measurements you need, call the function <code>ATSUGetGlyphBounds</code>. See <span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF139">“Flowing Text Around a Graphic ”</a></span> for an example of how the function <code>ATSUGetGlyphBounds</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_972"></a> is used to get ascent and descent values. The obtained values are then used to set pen location prior to drawing a line of text.</p><p>In rare cases, an application may need to obtain the typographic bounds of a line of text prior to final layout. For example, before–justification/alignment typographic bounds can be used when you need to determine your own line breaks or the leading and line space to impose on a line. Before–justification/alignment typographic bounds ignore any previously–set line attributes such as line rotation, alignment, justification, ascent, and descent. If you need before–justification/alignment measurements, call the function <code>ATSUGetUnjustifiedBounds</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_973"></a>.</p><p>For more information on typographic bounds, see <span class="content_text"><a href="../atsui_chap2/atsui_concepts.html#//apple_ref/doc/uid/TP30000028-TPXREF138">“Text Measurements.”</a></span> See <em>Inside Mac OS X: ATSUI Reference</em> for documentation on the functions <code>ATSUGetGlyphBounds</code> and <code>ATSUGetUnjustifiedBounds</code>.</p><a name="//apple_ref/doc/uid/TP30000030-TPXREF194" title="Calculating Line Height"></a><h2>Calculating Line Height</h2><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_974"></a><p>Your application needs to space lines<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_975"></a> appropriately when it draws text. When you calculate line spacing, you should use the ascent, descent, and leading values. (Line height = ascent + descent + leading) The line/layout descent value combines the font’s descent and leading values, as both values refer to measurements below the baseline.</p><p>You can use either of these two functions to determine line height:</p><ul class="ul"><li class="li"><p><code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetLineControl" target="_top">ATSUGetLineControl</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_976"></a>. You can use this function to obtain line ascent and descent values in Mac OS X version 10.2 and later, even if the values were not explicitly set. The code fragment in <span class="content_text">Listing 3-5</span> demonstrates how to obtain line height using the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetLineControl" target="_top">ATSUGetLineControl</a></code>.</p></li><li class="li"><p><code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetGlyphBounds" target="_top">ATSUGetGlyphBounds</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_977"></a>. You can use this function to obtain the trapezoid that represents the typographic bounds of a line after the final layout. You must use this function if your application runs in CarbonLib and Mac OS 8 and 9. The code fragment in <span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-BAJHHCFB">Listing 3-6</a></span> demonstrates how to obtain line height using the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetGlyphBounds" target="_top">ATSUGetGlyphBounds</a></code>.</p></li></ul><div class="notebox"><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_22" title="Note"></a><p><strong>Note:</strong>&nbsp;Although the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetUnjustifiedBounds" target="_top">ATSUGetUnjustifiedBounds</a></code> (formerly named <code><a href="../../../Reference/ATSUI_Reference/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/doc/c_ref/ATSUMeasureText" target="_top">ATSUMeasureText</a></code>) returns the typographical ascent and descent values, using this function to obtain ascent and descent values might degrade performance. You should not use <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetUnjustifiedBounds" target="_top">ATSUGetUnjustifiedBounds</a></code> to obtain these values. </p></div><p>A detailed explanation for each numbered line of code appears following the listing.</p><a name="//apple_ref/doc/uid/TP30000030-BAJEGGJH" title="Listing 3-5Calculating line height in Mac OS X version 10.2"></a><p class="codesample"><strong>Listing 3-5&nbsp;&nbsp;</strong>Calculating line height in Mac OS X version 10.2</p><div class="codesample"><table><tr><td scope="row"><pre>ATSUTextLayout          myTextLayout;<span></span></pre></td></tr><tr><td scope="row"><pre>ATSUTextMeasurement     myAscent, myDescent;<span></span></pre></td></tr><tr><td scope="row"><pre>ByteCount               actualSize;<span></span></pre></td></tr><tr><td scope="row"><pre>UniCharArrayOffset      myStartingOffset;<span>// 1</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Your code to set up the text layout object and associate it with with<span></span></pre></td></tr><tr><td scope="row"><pre>// text<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ATSUGetLineControl (myTextLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                    myStartingOffset,<span></span></pre></td></tr><tr><td scope="row"><pre>                    kATSULineAscentTag,<span></span></pre></td></tr><tr><td scope="row"><pre>                    sizeof (ATSUTextMeasurement),<span></span></pre></td></tr><tr><td scope="row"><pre>                    &amp;myAscent,<span></span></pre></td></tr><tr><td scope="row"><pre>                    &amp;actualSize);<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>ATSUGetLineControl (myTextLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                    myStartingOffset,<span></span></pre></td></tr><tr><td scope="row"><pre>                    kATSULineDescentTag,<span></span></pre></td></tr><tr><td scope="row"><pre>                    sizeof(ATSUTextMeasurement),<span></span></pre></td></tr><tr><td scope="row"><pre>                    &amp;myDescent,<span></span></pre></td></tr><tr><td scope="row"><pre>                    &amp;actualSize);<span>// 3</span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Declares the variable <code>myStartingOffset</code>. The value of this variable should be the offset that corresponds to the beginning of the line you want to measure. You can obtain the starting offset by calling the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetSoftLineBreaks" target="_top">ATSUGetSoftLineBreaks</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_978"></a> to obtain all the soft line breaks set for the text you want to render. The offset for each soft line break also denotes the starting offset for a line. See <span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF159">“Breaking Lines”</a></span> for information on getting soft line breaks.</p></li><li class="li"><p>Calls the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetLineControl" target="_top">ATSUGetLineControl</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_979"></a> to obtain the ascent for the line whose starting offset is specified by the <code>myStartingOffset</code> value. You must pass the <code>kATSULineAscentTag</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_980"></a> attribute tag to specify that you want to obtain the line ascent. On output, the <code>myAscent</code> parameter contains the line ascent value, and the <code>actualSize</code> parameter points to the size in bytes of the attribute value.</p></li><li class="li"><p>Calls the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetLineControl" target="_top">ATSUGetLineControl</a></code> to obtain the descent for the line whose starting offset is specified by the <code>myStartingOffset</code> value. You must pass the <code>kATSULineDescentTag</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_981"></a> attribute tag to specify that you want to obtain the line descent. On output, the <code>myDescent</code> parameter contains a value that is the line descent plus the leading, and the <code>actualSize</code> parameter points to the size in bytes of the attribute value. </p></li></ol><div class="notebox"><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_23" title="Note"></a><p><strong>Note:</strong>&nbsp;The attribute tags <code>kATSUAscentTag</code> and <code>kATSUDescentTag</code> can be used to obtain the ascent and descent values associated with an <code>ATSUStyle</code> object. In this case, you’d call the function <code>ATSUGetAttribute</code>. However, when you use these tags to obtain style attributes, the leading value is not included as part of the descent. To obtain the leading value for an <code>ATSUStyle</code> object, you must use the attribute tag <code>kATSULeadingTag</code>.</p></div><a name="//apple_ref/doc/uid/TP30000030-BAJHHCFB" title="Listing 3-6Calculating line height in Mac OS 8, Mac OS 9, and CarbonLib"></a><p class="codesample"><strong>Listing 3-6&nbsp;&nbsp;</strong>Calculating line height in Mac OS 8, Mac OS 9, and CarbonLib</p><div class="codesample"><table><tr><td scope="row"><pre>ATSUTextLayout          myTextLayout;<span></span></pre></td></tr><tr><td scope="row"><pre>ATSUTextMeasurement     myAscent, myDescent;<span></span></pre></td></tr><tr><td scope="row"><pre>UniCharArrayOffset      myStartingOffset; <span>// 1</span></pre></td></tr><tr><td scope="row"><pre>UniCharCount            myLineLength <span>// 2</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ATSTrapezoid            theBounds;<span></span></pre></td></tr><tr><td scope="row"><pre>ItemCount               numBounds;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Your code to set up the text layout object and associate it with text<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ATSUGetGlyphBounds (myTextLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                    0,<span></span></pre></td></tr><tr><td scope="row"><pre>                    0,<span></span></pre></td></tr><tr><td scope="row"><pre>                    myStartingOffset,<span></span></pre></td></tr><tr><td scope="row"><pre>                    myLineLength,<span></span></pre></td></tr><tr><td scope="row"><pre>                    kATSUseFractionalOrigins,<span></span></pre></td></tr><tr><td scope="row"><pre>                    1,<span></span></pre></td></tr><tr><td scope="row"><pre>                    &amp;theBounds,<span></span></pre></td></tr><tr><td scope="row"><pre>                    &amp;numBounds); <span>// 3</span></pre></td></tr><tr><td scope="row"><pre>myAscent = - theBounds.upperLeft.y; <span>// 4</span></pre></td></tr><tr><td scope="row"><pre>myDescent = theBounds.lowerLeft.y; <span>// 5</span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Declares the variable <code>myStartingOffset</code>. The value of this variable should be the offset that corresponds to the beginning of the line you want to measure. You can obtain the starting offset by calling the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetSoftLineBreaks" target="_top">ATSUGetSoftLineBreaks</a></code> to obtain all the soft line breaks set for the text you want to render. The offset for each soft line break also denotes the starting offset for a line. See <span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TPXREF159">“Breaking Lines”</a></span> for information on getting soft line breaks.</p></li><li class="li"><p>Declares the variable <code>myLineLength</code>. The value of this variable should be the length of the line you want to measure. You can obtain the line length by subtracting the starting offset for the line you want to measure from the starting offset for the next line in the text layout.</p></li><li class="li"><p>Calls the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetGlyphBounds" target="_top">ATSUGetGlyphBounds</a></code> to obtain the typographic bounds of a line of glyphs after the final layout. On output, <code>theBounds</code> points to an <code>ATSTrapezoid</code> structure that contains the line ascent and descent values. When you call this function on an entire line, only one trapezoid is returned.</p></li><li class="li"><p>Extracts the ascent value from the trapezoid returned by the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetGlyphBounds" target="_top">ATSUGetGlyphBounds</a></code>.</p></li><li class="li"><p>Extracts the descent value from the trapezoid returned by the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetGlyphBounds" target="_top">ATSUGetGlyphBounds</a></code>. The <code>theBounds.lowerLeft.y</code> value is the sum of the descent and the leading values.<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_982"></a></p></li></ol><a name="//apple_ref/doc/uid/TP30000030-TPXREF139" title="Flowing Text Around a Graphic "></a><h2>Flowing Text Around a Graphic </h2><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_983"></a><p>This section shows you how to embed a graphic<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_984"></a> in text by flowing text around it, as shown in <span class="content_text">Figure 3-6</span>. To flow text around a graphic, you use one text layout object per paragraph, then vary the width of the lines in the text layout object so the text flows around the graphic appropriately.</p><br/><div><a name="//apple_ref/doc/uid/TP30000030-BCIEGGJH" title="Figure 3-6Text flowed around a graphic"></a><p><strong>Figure 3-6&nbsp;&nbsp;</strong>Text flowed around a graphic</p><img src = "../art/graphicsflow.gif" alt = "Text flowed around a graphic" width="351" height="271"></div><br/><p>The following steps outline what you must do for each paragraph of text for which you want to flow text around a graphic. The steps assume that you have already set up a text layout object for each paragraph of text and that you obtained the coordinates of the image around which you need to flow text. </p><ol class="ol"><li class="li"><p>Determine the current line breaking width. It should be the full line width, the line width for lines on the left side of the image, or the line width for lines on the right side of the image.</p></li><li class="li"><p>Set the line width as part of the line attributes for the text layout object.</p></li><li class="li"><p>Measure the text to get the ascent and descent of the laid-out line. You need the ascent and the descent to calculate the y-coordinate of the pen position.</p></li><li class="li"><p>Set the x and y coordinates of the pen position. If you are drawing a full-width line or a line that is on the left side of the image, you should use the left-side margin value for the x-coordinate. </p><p>If you are drawing a line that is on the right side of the image, you should use the value calculated for the x-coordinate of the right side of the image plus any whitespace you want between the image and the text.</p><p>You also need to set the y-coordinate. Make sure you transform the y-coordinate appropriately if you are using Quartz 2D.</p></li><li class="li"><p>Check to see if the text will collide with the image; if not, draw the text.</p></li><li class="li"><p>Prepare to draw the next line by adjusting variables accordingly. For example, if you’ve just drawn a line of text that does not flow around the graphic, then you need to adjust the coordinates of the pen location. If you’ve just drawn a line of text on the left side of the graphic, you need to adjust only the x-coordinate of the pen location so the second part of the line starts just right of the graphic, and so forth.</p></li></ol><p><span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-BCICCHIE">Figure 3-7</a></span> shows the variables you need to define before you write the code that flows a paragraph a text around an image. These are the variables:</p><ul class="ul"><li class="li"><p><code>theMargin.left</code>, the left-side margin. This is the left-side page (or window) boundary plus the space you’ve defined to be the margin.</p></li><li class="li"><p><code>theMargin.right</code>, the right-side margin. This is the right-side page (or window) boundary minus the space you’ve defined to be the margin.</p></li><li class="li"><p><code>thePortBounds.bottom</code>, the y-coordinate that defines the page (or window) boundary. For a Quartz 2D context, the y-coordinate is <code>0</code>; for a QuickDraw port, the y-coordinate is the maximum y-value.</p></li><li class="li"><p><code>myImageRect</code>, the rectangle that defines the boundary of the graphic around which you want the text to flow. You need to define where the image is placed before you start to flow text around it.</p></li><li class="li"><p><code>myBoxRect</code>, the rectangle that defines the boundary of the graphic plus the amount of white space you want between the image and the text. This is the rectangle that you use to calculate the line widths for text that flows around the graphic.</p></li><li class="li"><p><code>myLeftSide</code>, the area between <code>theMargin.left</code> and the left side of the rectangle specified by <code>myBoxRect</code>.</p></li><li class="li"><p><code>myRightSide</code>, the area between <code>theMargin.right</code> and the right side of the rectangle specified by <code>myBoxRect</code>.</p></li><li class="li"><p><code>myFullLineBreakWidth</code>, the length of a line that spans from <code>theMargin.left</code> to <code>theMargin.right</code>. That is, a line that does not flow around the image.</p></li><li class="li"><p><code>myLeftSideLineWidth</code>, the length of a line that spans from <code>theMargin.left</code> to the left side of the rectangle specified by <code>myBoxRect</code>.</p></li><li class="li"><p><code>myRightSideLineWidth</code>, the length of a line that spans from <code>theMargin.right</code> to the right side of the rectangle specified by <code>myBoxRect</code>.</p></li></ul><br/><div><a name="//apple_ref/doc/uid/TP30000030-BCICCHIE" title="Figure 3-7Variables needed for line breaking"></a><p><strong>Figure 3-7&nbsp;&nbsp;</strong>Variables needed for line breaking</p><img src = "../art/linebreakvariables.gif" alt = "Variables needed for line breaking" width="413" height="381"></div><br/><p>Once you have defined these variables, implementing the code that carries out the six steps outlined previously is fairly straightforward. The code in <span class="content_text">Listing 3-7</span> shows sample code that draws one paragraph of text. This code is a loop that iterates through one paragraph of text, using the same text layout object throughout. In the context of an application, this code would be part of a routine to draw a page of text. You can download the sample application ATSUILineBreak from <span class="content_text"><a href="http://developer.apple.com/samplecode" target="_top">http://developer.apple.com/samplecode</a></span> to see how the code in <span class="content_text">Listing 3-7</span> works in the context of a complete application.</p><p>As you look through the sample code in <span class="content_text">Listing 3-7</span>, keep the following caveats in mind:</p><ul class="ul"><li class="li"><p>If end-of-line effects such as swashes are applied to the text, the effects show up at the end of each part of the line that flows around the graphic.</p></li><li class="li"><p>Runs of bidirectional text are treated as though they are on two successive lines, rather than two parts of the same line.</p></li></ul><p>A detailed explanation for each numbered line of code follows the listing. Note that the variable declarations are not shown in <span class="content_text">Listing 3-7</span>. These variables must be declared prior to the start of the loop, as part of the page drawing routine.</p><a name="//apple_ref/doc/uid/TP30000030-BCIFFGGJ" title="Listing 3-7Code that flows text around a graphic"></a><p class="codesample"><strong>Listing 3-7&nbsp;&nbsp;</strong>Code that flows text around a graphic</p><div class="codesample"><table><tr><td scope="row"><pre>do<span>// 1</span></pre></td></tr><tr><td scope="row"><pre> {<span></span></pre></td></tr><tr><td scope="row"><pre>    if (myFlowTextAroundGraphics) <span>// 2</span></pre></td></tr><tr><td scope="row"><pre>        myCurrentLineBreakWidth = (myRightSide) ? myRightSideLineWidth :<span></span></pre></td></tr><tr><td scope="row"><pre>                                             myLeftSideLineWidth;<span></span></pre></td></tr><tr><td scope="row"><pre>    else<span></span></pre></td></tr><tr><td scope="row"><pre>         myCurrentLineBreakWidth = myFullLineBreakWidth;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    verify_noerr (status);<span></span></pre></td></tr><tr><td scope="row"><pre>    theTags[0] = kATSULineWidthTag;<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    mySizes[0] = (ByteCount) sizeof(Fixed);<span></span></pre></td></tr><tr><td scope="row"><pre>    myValues[0] = (ATSUAttributeValuePtr) &amp;myCurrentLineBreakWidth;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status = ATSUClearLineControls myLayout, myCurrentStart, 1, myTags);    <span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    status = ATSUSetLineControls (myLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                            myCurrentStart, 1,<span></span></pre></td></tr><tr><td scope="row"><pre>                            myTags, mySizes, myValues);<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>    require_noerr (status, CleanUpAndExit);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (mySetManualSoftBreaks) <span>// 6</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        status = ATSUBreakLine (myLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                        myCurrentStart,<span></span></pre></td></tr><tr><td scope="row"><pre>                        myCurrentLineBreakWidth,<span></span></pre></td></tr><tr><td scope="row"><pre>                        false,<span></span></pre></td></tr><tr><td scope="row"><pre>                        &amp;myCurrentEnd);<span></span></pre></td></tr><tr><td scope="row"><pre>        require (((status == noErr) || (status == kATSULineBreakInWord)),<span></span></pre></td></tr><tr><td scope="row"><pre>                                     CleanUpAndExit);<span></span></pre></td></tr><tr><td scope="row"><pre>        status = ATSUSetSoftLineBreak (myLayout, myCurrentEnd);<span></span></pre></td></tr><tr><td scope="row"><pre>        require_noerr (status, CleanUpAndExit);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        status = ATSUBreakLine (myLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                            myCurrentStart,<span></span></pre></td></tr><tr><td scope="row"><pre>                            myCurrentLineBreakWidth, true,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;myCurrentEnd);<span></span></pre></td></tr><tr><td scope="row"><pre>        require (((status == noErr) || (status == kATSULineBreakInWord)),<span></span></pre></td></tr><tr><td scope="row"><pre>                                     CleanUpAndExit );<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status = ATSUGetGlyphBounds (myLayout, 0, 0,<span></span></pre></td></tr><tr><td scope="row"><pre>                            myCurrentStart,<span></span></pre></td></tr><tr><td scope="row"><pre>                            myCurrentEnd - myCurrentStart,<span></span></pre></td></tr><tr><td scope="row"><pre>                            kATSUseDeviceOrigins, 1,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;myGlyphBounds,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;myNumGlyphBounds);<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>    require_noerr (status, CleanUpAndExit);<span></span></pre></td></tr><tr><td scope="row"><pre>    myAscent = 0 - myGlyphBounds.upperLeft.y;<span>// 8</span></pre></td></tr><tr><td scope="row"><pre>    myDescent = myGlyphBounds.lowerLeft.y;<span>// 9</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (myFlowTextAroundGraphics) <span>// 10</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        if (myRightSide)<span></span></pre></td></tr><tr><td scope="row"><pre>            penX = myRightSideBoxRect;<span></span></pre></td></tr><tr><td scope="row"><pre>        else<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            penX = Long2Fix (theMargin.left);<span></span></pre></td></tr><tr><td scope="row"><pre>            if (firstWrappedLine)<span></span></pre></td></tr><tr><td scope="row"><pre>                firstWrappedLine = false;<span></span></pre></td></tr><tr><td scope="row"><pre>            else<span></span></pre></td></tr><tr><td scope="row"><pre>                penY += myAscent;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        penX = Long2Fix (theMargin.left);<span></span></pre></td></tr><tr><td scope="row"><pre>        penY += myAscent;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    CGawarePenY = (myUseQuartzContext ) ? Long2Fix (thePortBounds.bottom -<span></span></pre></td></tr><tr><td scope="row"><pre>                                            Fix2X(penY)) : penY;                                                                    <span>// 11</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (! myBoxRectCleared) <span>// 12</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        if (! myFlowTextAroundGraphics)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            if ((penY + myDescent) > myBoxRectTop)<span></span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                myFlowTextAroundGraphics = true;<span></span></pre></td></tr><tr><td scope="row"><pre>                firstWrappedLine = true;<span></span></pre></td></tr><tr><td scope="row"><pre>                myRightSide = false;<span></span></pre></td></tr><tr><td scope="row"><pre>                continue;<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    endOfPage = ((penY + myDescent) > pageBoundary) ? true : false;<span>// 13</span></pre></td></tr><tr><td scope="row"><pre>    require_noerr (status, CleanUpAndExit);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (! endOfPage) <span>// 14</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        status = ATSUDrawText (myLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                                myCurrentStart,<span></span></pre></td></tr><tr><td scope="row"><pre>                                myCurrentEnd - myCurrentStart,<span></span></pre></td></tr><tr><td scope="row"><pre>                                 penX,<span></span></pre></td></tr><tr><td scope="row"><pre>                                 CGawarePenY);<span></span></pre></td></tr><tr><td scope="row"><pre>        require_noerr (status, CleanUpAndExit);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (myFlowTextAroundGraphics) <span>// 15</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        if (myRightSide)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            penY += myDescent;<span></span></pre></td></tr><tr><td scope="row"><pre>            secondHalf = false;<span></span></pre></td></tr><tr><td scope="row"><pre>            if (penY > myBoxRectBottom)<span></span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                 myFlowTextAroundGraphics = false;<span></span></pre></td></tr><tr><td scope="row"><pre>                 myBoxRectCleared = true;<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        else<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            if (myCurrentEnd >= myCurrentLength)<span></span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                if (penY > myBoxRectBottom)<span></span></pre></td></tr><tr><td scope="row"><pre>                {<span></span></pre></td></tr><tr><td scope="row"><pre>                    myFlowTextAroundGraphics = false;<span></span></pre></td></tr><tr><td scope="row"><pre>                    myBoxRectCleared = true;<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>             myRightSide = true;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else <span>// 16</span></pre></td></tr><tr><td scope="row"><pre>        penY += myDescent;<span></span></pre></td></tr><tr><td scope="row"><pre>        myCurrentStart = myCurrentEnd;<span></span></pre></td></tr><tr><td scope="row"><pre>} while ((myCurrentStart &lt; myCurrentLength) &amp;&amp; (!endOfPage)) ; <span>// 17</span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Begins the paragraph loop. Each pass through the loop processes a line of text in the paragraph. </p></li><li class="li"><p>Checks to see if the text should flow around a graphic. On entering the loop, the <code>myFlowTextAroundGraphics</code> variable has a value of <code>false</code>, as the first line should be drawn over the graphic. </p><p>For the case in which the text should flow around a graphic, checks to see if the line is on the right side, then sets the line width accordingly.</p><p>For the case in which the text should not flow around a graphic, sets the line width to the full line length.</p></li><li class="li"><p>Sets up a triple (attribute tag, size, value) for the line width attribute.</p></li><li class="li"><p>Calls the ATSUI function <code>ATSUClearLineControls</code> to clear the line width attribute set previously. The variable <code>myCurrentStart</code> is the offset that specifies the start of the current line in the text buffer associated with the text layout object <code>myLayout</code>.</p></li><li class="li"><p>Calls the ATSUI function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUSetLineControls" target="_top">ATSUSetLineControls</a></code> to set the line width attribute to the value of the current line width that was set in step 2.</p></li><li class="li"><p>Checks to see if manual soft line breaks are to be used. </p><p>If manual soft line breaks are to be used, calls the ASTUI function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBreakLine" target="_top">ATSUBreakLine</a></code> with the <code>iUseAsSoftLineBreak</code> parameter set to <code>false</code>. The code then calls the ATSUI function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUSetSoftLineBreak" target="_top">ATSUSetSoftLineBreak</a></code> to set a soft line break using the value returned in the previous call to the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBreakLine" target="_top">ATSUBreakLine</a></code>. In most cases you should not use manual soft line breaks. If you choose to set line breaks yourself, then you must make sure you unset any line breaks that have already been set by ATSUI. </p><p>If manual soft line breaks are not to be used, calls the ATSUI function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUSetSoftLineBreak" target="_top">ATSUSetSoftLineBreak</a></code> to set a soft line break using the value returned in the previous call to the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBreakLine" target="_top">ATSUBreakLine</a></code>.</p></li><li class="li"><p>Calls the ATSUI function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetGlyphBounds" target="_top">ATSUGetGlyphBounds</a></code> to obtain the ascent and descent of the laid-out line. These values are returned in the parameter <code>myGlyphBounds</code>.</p></li><li class="li"><p>Calculates the ascent value and assigns it to the variable <code>myAscent</code>. </p></li><li class="li"><p>Assigns the descent value to the variable <code>myDecent</code>. </p></li><li class="li"><p>Checks to see if the text should flow around a graphic.</p><p>If the text should flow around a graphic and if the text is to be drawn on the right side of the graphic, sets the x-coordinate of the pen location to the right of the image. There is no need to set the y-coordinate of the pen location, as it should be the same as that used to draw the line on the left side of the graphic.</p><p>If the text should flow around a graphic and if the text is to be drawn on the left side of the graphic, sets the x-coordinate of the pen location to the left margin and sets the y-coordinate accordingly. If this is the first line of the page, you do not need to set the y-coordinate for the pen location, as it is correct when the loop is first entered.</p><p>If the text does not flow around a graphic, sets the x-coordinate of the pen location to the left margin and increments the y-coordinate of the pen to take the ascent of the line into account.</p></li><li class="li"><p>If the text is drawn using a Quartz context, adjusts the value of the y-coordinate to the pen location. Up to now, we’ve been using QuickDraw coordinates. Quartz coordinates have their origin (0,0) in the lower-left corner rather than the upper-left corner as QuickDraw does.</p></li><li class="li"><p>If the text is not clear of the box rectangle and if the text does not flow around the graphic, checks to see if the y-coordinate of the pen location added to the descent is greater than the location of the top of the image. If so, sets the variable <code>myFlowTextAroundGraphics</code> to <code>true</code>, sets the variable <code>firstWrappedLine</code> to <code>true</code>, sets the <code>myRightSide</code> variable to <code>false</code>. This is the case in which there is text on the left side of the graphic, but not on the right side.</p></li><li class="li"><p>Checks to see if the end of the page has been reached, and exits if it has.</p></li><li class="li"><p>If the end of the page has not been reached, calls the ATSUI function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUDrawText" target="_top">ATSUDrawText</a></code> to draw the line of text in the current pen location.</p></li><li class="li"><p>Checks to see if the text should flow around a graphic.</p><p>If the text should flow around a graphic, and if the line is on the right-side of the graphic, sets the y-coordinate of the pen location to take into account the descent of the line that was just drawn. This is in preparation for the next pass through the loop. Sets the <code>myRightSide</code> variable to <code>false</code>.</p><p>If the text should flow around a graphic, and if the line is on the left side of the graphic, checks to see if the current end of the line is greater than or equal to the current length of the line.</p><p>If the current end of the line is greater than or equal to the current length of the line, checks to see if the y-coordinate of the pen location is greater than the y-coordinate of the bottom of the box. If it is, sets the variable <code>myFlowTextAroundGraphics</code> to <code>false</code> and sets the variable <code>myBoxRectCleared</code> to <code>true</code>. The next time though the loop, the full line width will be used. </p><p>If the line is on the left side of the graphic, sets the variable <code>myRightSide</code> to <code>true</code>, in preparation for the next trip through the loop.</p></li><li class="li"><p>If the text does not flow around the graphics, sets the y-coordinate of the pen location to take the descent of the line into account. Then sets the current starting offset to the ending offset in preparation to draw the next line of text.</p></li><li class="li"><p>Checks to see if the paragraph or the end of the page has been reached. If so, the paragraph loop terminates.<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_985"></a></p></li></ol><div class="notebox"><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_24" title="Note"></a><p><strong>Note:</strong>&nbsp;Although it is not shown in this code fragment, you should make sure you set the line layout attribute (<code>kATSULineLayoutOptionsTag</code>) so that the last line of a paragraph is not justified<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_986"></a> (<code>kATSLineLastNoJustification</code>). </p></div><a name="//apple_ref/doc/uid/TP30000030-TPXREF193" title="Setting Up a Tab Ruler"></a><h2>Setting Up a Tab Ruler</h2><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_987"></a><p>Support for tabs is available starting in Mac OS X version 10.2. You can set up a tab ruler for a text layout object<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_988"></a> by specifying an array of tab values and passing this array as a parameter to the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUSetTabArray" target="_top">ATSUSetTabArray</a></code>. When a tab ruler<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_989"></a> is set for a text layout object, ATSUI automatically aligns text such that any tabs in the text are laid out to follow the settings specified by the tab ruler. </p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_25" title="Note"></a><p><strong>Note:</strong>&nbsp;If you want to use tabs<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_990"></a> and you also want to use the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUBatchBreakLines" target="_top">ATSUBatchBreakLines</a></code>, you must set tabs by calling the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUSetTabArray" target="_top">ATSUSetTabArray</a></code>.</p></div><p>There are three types of tabs<a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_991"></a>:</p><ul class="ul"><li class="li"><p>left (<code>kATSULeftTab</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_992"></a>), which specifies that the left side of the tabbed text should be flush against the tab stop</p></li><li class="li"><p>center (<code>kATSUCenterTab</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_993"></a>), which specifies that the tabbed text should be centered on the tab stop</p></li><li class="li"><p>right (<code>kATSURightTab</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_994"></a>), which specifies that the right side of the tabbed text should be flush against the tab stop</p></li></ul><p><span class="content_text"><a href="atsui_tasks.html#//apple_ref/doc/uid/TP30000030-BAJFHAHG">Listing 3-8</a></span> shows a code fragment that creates an array of tab values and then calls the function <code>ATSUSetTabArray</code> to set a tab ruler for a text layout object. A detailed explanation for each numbered line of code appears following the listing.</p><a name="//apple_ref/doc/uid/TP30000030-BAJFHAHG" title="Listing 3-8Setting tab values for a text layout object"></a><p class="codesample"><strong>Listing 3-8&nbsp;&nbsp;</strong>Setting tab values for a text layout object</p><div class="codesample"><table><tr><td scope="row"><pre>#define     MYTABCOUNT 20<span></span></pre></td></tr><tr><td scope="row"><pre>#define     MYTABINCREMENT 50<span></span></pre></td></tr><tr><td scope="row"><pre>Fixed       cumulative;<span></span></pre></td></tr><tr><td scope="row"><pre>ATSUTab     myTabArray[MYTABCOUNT];<span></span></pre></td></tr><tr><td scope="row"><pre>ATSUTextLayout  myTextLayout;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Your code to create a text layout and associate it with a text buffer<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>cumulative = Long2Fix(0);<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>for (i=0; i &lt; MYTABCOUNT; i++) <span>// 2</span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    cumulative += Long2Fix (MYTABINCREMENT);<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    myTabArray[i].tabType = kATSULeftTab;<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    myTabArray[i].tabPosition = cumulative;<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre>verify_noerr (ATSUSetTabArray (myTextLayout, myTabArray, TABCOUNT));<span>// 6</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Initializes the <code>cumulative</code> variable to <code>0</code>. This value must be a <code>Fixed</code> data type.</p></li><li class="li"><p>Sets up a loop for the number of tabs. </p></li><li class="li"><p>Increments the <code>cumulative</code> variable by a set amount.</p></li><li class="li"><p>Assigns a tab position type to the <code>tabType</code> field of the tab array. A tab ruler can contain tabs of more than one type, even though this example uses only left tabs.</p></li><li class="li"><p>Assigns a position value to the <code>tabPosition</code> field of the tab array. The tabs in the example are evenly spaced; tab spacing does not need to be even. Your code should assign tab values appropriate for your application. </p></li><li class="li"><p>Calls the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUSetTabArray" target="_top">ATSUSetTabArray</a></code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_995"></a> to associate the array of tab values with the text layout object.</p></li></ol><p>You can retrieve a previously set tab ruler by calling the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetTabArray" target="_top">ATSUGetTabArray</a></code>, as shown in <span class="content_text">Listing 3-9</span>. A detailed explanation for each numbered line of code appears following the listing.</p><a name="//apple_ref/doc/uid/TP30000030-BAJIGAFF" title="Listing 3-9Obtaining an array of tab values"></a><p class="codesample"><strong>Listing 3-9&nbsp;&nbsp;</strong>Obtaining an array of tab values</p><div class="codesample"><table><tr><td scope="row"><pre>ATSUTab         *myGetTabArray;<span></span></pre></td></tr><tr><td scope="row"><pre>ItemCount       myNumTabs;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>verify_noerr (ATSUGetTabArray (myTextLayout, 0, NULL, &amp;myNumTabs));<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>myGetTabArray = (ATSUTab *) malloc(sizeof(ATSUTab) * myNumTabs);<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>verify_noerr (ATSUGetTabArray (myTextLayout, myNumTabs,<span></span></pre></td></tr><tr><td scope="row"><pre>                                myGetTabArray, &amp;myNumTabs) );<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>free(getTabArray);<span>// 4</span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Calls the function <code>ATSUGetTabArray</code><a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_996"></a> to obtain the number of tab values set for the text layout object. When you pass <code>NULL</code> as the tab array, ATSUI returns the number of tab values in the <code>oTabCount</code> (<code>myNumTabs</code>) parameter. </p><p>The macro <code><!--a-->verify_noerr<!--/a--></code> checks for errors that could be returned by <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetTabArray" target="_top">ATSUGetTabArray</a></code>.</p></li><li class="li"><p>Calls the function <code><!--a-->malloc<!--/a--></code> to allocate an array large enough to hold the tab values previously set for the text layout object.</p></li><li class="li"><p>Calls the function <code>ATSUGetTabArray</code> to obtain the tab array to the text layout object. </p></li><li class="li"><p>Calls the function <code><!--a-->free<!--/a--></code> to dispose of the array when it is no longer needed. <a name="//apple_ref/doc/uid/TP30000030-DontLinkElementID_997"></a></p></li></ol>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../atsui_chap3/atsui_concepts2.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../atsui_chap5/atsui_interact_tasks.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2002, 2007 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2007-07-10<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Carbon/Conceptual/ATSUI_Concepts/atsui_chap4/atsui_tasks.html%3Fid%3DTP30000984-2.6&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Carbon/Conceptual/ATSUI_Concepts/atsui_chap4/atsui_tasks.html%3Fid%3DTP30000984-2.6&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Carbon/Conceptual/ATSUI_Concepts/atsui_chap4/atsui_tasks.html%3Fid%3DTP30000984-2.6&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>