<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TN1025: Driver Loader Library Call GetDriverInformation: A Bug &amp; Workaround</title>    <meta name="keywords" content="Mac OS 7 GetDriverInformation bug Driver Loader Library">    <meta name="Description" content="Technical Note TN1025: This Technical Note describes a workaroundto a bug in the first version of the Driver Loader Libraryin System 7.5.2 and System Update 7.5.3. There is a bug inthe routine GetDriverInformation that can possibly causean overwriting past the end of the name string that is passedin. Included is sample code that uses GetDriverInformationto iterate over the Driver Unit Table"><meta name="categories" content="Devices"><meta name="week-posted" content="Jan 29, 1996 - Feb 2, 1996"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002867" title="Driver Loader Library Call GetDriverInformation: A Bug & Workaround"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/index.html" target="_blank">Reference Library > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1025</div>
<div id="pageheadsub">Driver Loader Library Call GetDriverInformation: A Bug &amp; Workaround</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"> <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr><td width=300 valign="top" align=left scope="row">    <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td></tr><tr bgcolor="#e6e6e6">    <td background="images/tnmenubody.gif" width=300 align=left><span id="menutitle">    CONTENTS     <BR>    <BR></span>    </td></tr><tr bgcolor="#e6e6e6">    <td background="images/tnmenubody.gif" width=300 align=left><!-- begin_toc --><P id = "menutext"><A HREF = "#RTFToC1">Defining the Problem</a><br><br><A HREF = "#RTFToC2">Solving the Problem</a><br><br><A HREF = "#RTFToC3">Sample Code Using GetDriverInformation To Iterate Over the Driver Unit Table</a><br><br><A HREF = "#RTFToC4">Reference for GetDriverInformation</a><br><br><A HREF = "#Summary">Summary</a><br><br><A HREF="#Downloads">Downloadables</A></P>   <!-- end_toc -->  </td></tr><tr>    <td width=300 align=left scope="row"><img src="images/tnmenubottom.gif" alt="" width=300 height=16>    </td></tr>    </table></td><td width=300 valign="top" align=left><!-- begin_intro_text -->  <p id = "introtext">This Technote describes a workaround to a bug in the first version of theDriver Loader Library in System 7.5.2 and System Update 7.5.3. (The bug shouldbe fixed in later versions of the Mac OS.) As of this writing, the DriverLoader Library is only available on Power Macintoshes that support PCI cards(for example: Power Mac 7200, 7500, 8500 and 9500). There is a bug in theroutine <code>GetDriverInformation</code> that can possibly cause an overwriting past theend of the name string that is passed in.</p><p id = "introtext">This Technote is directed primarily at writers or family experts and especiallyapplications that get information about drivers.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>&nbsp;[Feb 1 1996]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR> <!-- begin_content --><a name="RTFToC1"></a><h2>Defining the Problem</h2><P>In the Driver Loader Library, there is a bug in the routineGetDriverInformation that can possibly cause an overwriting past the end of thename string that is passed in.</p><P>This bug surfaces only when calling <code>GetDriverInformation()</code> for a driver thathas had its Device Control Entry fields zeroed when it was closed (the Chooserdriver has been observed to exhibit this behavior). The bug occurs because<code>GetDriverInformation()</code> does not check for zeroed fields before using the<code>dCtlDriver</code> field to reference the driver's name; instead, it copies a garbagestring from low memory into the name string passed as a parameter to<code>GetDriverInformation()</code>.</p><P>If the first byte of this garbage string is larger than the number bytes ofstorage allocated by the caller for the name string, then the caller's datalocated just past the end of name's storage will be overwritten with garbage.</p><P>You can see the zeroing out of fields for the Chooser's driver by followingthese steps using any version of MacsBug: </p>    <P>1.    Open the Chooser.</p>        <P>2.    Drop into MacsBug and type: </p>    <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    drvr      &lt;return&gt;</pre>	</TD></TR></TABLE></CENTER>        <P>3.    Look down the list of drivers in the Driver column of the drvr display and see the Chooser (on my machine it's at<code> dNum 0xF</code>). To see what the Chooser's DCE fields look like before the zeroing type: </p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    dm    xxxxx    dctlentry    &lt;return&gt;</pre>	</TD></TR></TABLE></CENTER>    <P>(where <code>xxxxx</code> is the hexidecimal number in the Chooser's row in the "DCE at" column in the drvr display)</p>   <P> 4.    Exit Macsbug by hitting Command-G.</p>        <P>5.    Close the Chooser window.</p>        <P>6.    Drop into MacsBug and type: </p>    <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    drvr   &lt;return&gt;</pre>	</TD></TR></TABLE></CENTER>    <P>You'll see that name Chooser is replace by blanks in the row that it was in.</p>   <P> 7.    To see the zeroing of DCE fields type: </p>    <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    dm    xxxxx    dctlentry    &lt;return&gt;</pre>	</TD></TR></TABLE></CENTER>    <P>(again, where <code>xxxxx</code> is the hexidecimal number in the Chooser's row in the "DCE at" column in the drvr display).</p><P>You'll see that all fields except the <code>RefNum</code> field have been zeroed.</p><P>It's doubtful that any expert code will encounter this problem if the expertcode executes pre-Finder; applications that execute <b>after</b> the Finderboots are the most likely victims. If your code calls <code>GetDriverInformation()</code>after a user has a chance to close one of these "zeroed-out" drivers (and theDCE fields are thus zeroed), then you will need this workaround. If you call<code>GetDriverInformation</code> only for a driver that you know doesn't have its DeviceControl Entry fields zeroed upon closing, then you don't need this workaroundbecause the bug will not appear. It is only when you traverse the unit table,calling <code>GetDriverInformation</code> for unknown drivers, that you need to be aware ofthe workaround.</p><h3>GetDriverInformation</h3><P>Here is the declaration for <code>GetDriverInformation</code> as gleaned from the universalheaders file, Devices.h: </p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>extern OSErrGetDriverInformation (DriverRefNum refNum,            UnitNumber *unitNum,            DriverFlags *flags,            DriverOpenCount *count,            StringPtr name,    // ** this is the field we are                            concerned with//            RegEntryID *device,            CFragHFSLocator *driverLoadLocation,            CFragConnectionID *fragmentConnID,            DriverEntryPointPtr *fragmentMain,            DriverDescription *driverDesc);</pre>	</TD></TR></TABLE></CENTER><P>It is the StringPtr name parameter that we are concerned with. If you allocate,for example, a Str31 to use to pass in as the <code>StringPtr</code>, then (if the erroneousbyte <code>GetDriverInformation</code> thinks is the length byte of the garbage string isgreater than <code>0x1f</code>, or 31 decimal) <code>GetDriverInformation</code> will unwittingly copyall the garbage bytes to your code without regard to the actual location of theend of the name string.</p><P><A HREF="#top">Back to top</A></P><a name = "RTFToC2"></a><h2>Solving the Problem</h2><P>The workaround is simple: allocate a String255 for the name parameter passedinto <code>GetDriverInformation()</code> rather than some shorter-length string. This meansany garbage copied to the string will be contained in that string rather thanany other data. If you're familiar with GetDriverInformation, that's all youneed to know: use a Str255 for the name parameter rather than a shorter stringand you're protected. If you're not familiar with <code>GetDriverInformation</code> andwould like to see some code to traverse the unit table, sample code is providedhere for your information. You also have to take precautions about using thegarbage string data as well (if you were going to display the driver name in anapplication, you would probably want to check for non-printing characters ifdisplaying them would cause problems in your code. You might want to make surethe garbage length of the name string isn't too long for your code tohandle).</p><P><A HREF="#top">Back to top</A></P><a name = "RTFToC3"></a><h2>Sample Code Using GetDriverInformation To Iterate Over the Driver Unit Table</h2><P>To drive the point home about using a Str255, and also to alert you to anothermandatory initializing of the <code>FSSpec</code> field of the driverLoadLocation struct,(another input of <code>GetDriverInformation</code>), here is some barebones sample code.Note that traversing the unit table using <code>GetDriverInformation()</code> is not themost efficient way to discover which units are empty and which are full. Usethe Driver Loader Library routine, <code>LookupDrivers()</code> for that.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>void TraverseDrivers(){    OSErr                err = noErr;    DriverRefNum            refNum;    UnitNumber            unitNum;    DriverFlags            flags;    DriverOpenCount            count;    RegEntryID            device;    CFragHFSLocator            driverLoadLocation;    DriverDescription        driverDesc;    // Str63            theName; // BAD, not long enough    Str255                theName;  // GOOD: THIS IS THE WORKAROUND!    FSSpec                loadLocSpec;    short i;//  this is another caveat about using GetDriverInformation();  you must//  initialize the FSSpec ptr field of the driverLoadLocation struct to//  point to an allocated FSSpec because GetDriverInformation assumes you//  have.  This is done is the next line below.      driverLoadLocation.u.onDisk.fileSpec = &amp;loadLocSpec;    for( i = 0;  i &lt;= HighestUnitNumber(); ++i ){        refNum = ~i;  // convert the unit number to a driver refNum.        err =     GetDriverInformation(    refNum,                        &amp;unitNum,                        &amp;flags,                        &amp;count,                        theName,                        &amp;device,                        &amp;driverLoadLocation,                        &amp;fragmentConnID,                        &amp;fragmentMain,                        &amp;driverDesc);        if( err != noErr ){ // there's a driver for this refNum            // Do whatever it was you wanted to do with the information            //  BEWARE: If the driver is a non-native driver, that is a            //  68k driver of pre-PCI-supporting Macintosh, the device,            //  driverLoadLocation, fragmentConnID, fragmentMain, and            //  driverDesc inputs above will be set to nil after the call            //  because these fields don't apply to 68k drivers.        }    } // for}  //  end  TraverseDrivers()</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="RTFToC4"></a><h2>Reference for GetDriverInformation</h2><h3>GetDriverInformation</h3><P><code>GetDriverInformation</code> returns a number of pieces of information about aninstalled driver.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>OSErr GetDriverInformation    (DriverRefNum        refNum,    UnitNumber        *unitNum,    DriverFlags        *flags,    DriverOpenCount        *count,    StringPtr        name,    RegEntryID        *device,    CFragHFSLocator        *driverLoadLocation,    CFragConnectionID    *fragmentConnID,    DriverEntryPointPtr    *fragmentMain,    DriverDescription    *driverDesc);</pre>	</TD></TR></TABLE></CENTER><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>refNum                refNum of driver to examineunit                resulting unit numberflags                resulting DCE flag bitscount                number of times driver has been openedname                resulting driver namedevice                resulting Name Registry device specificationdriverLocation        resulting CFM fragment locator (from which the driver                     was loaded)fragmentConnID        resulting CFM connection IDfragmentMain        resulting pointer to DoDriverIOdriverDesc            resulting pointer to DriverDescription</pre>	</TD></TR></TABLE></CENTER><h5>DESCRIPTION</h5><P><code>GetDriverInformation</code> is used by driver experts in PCI-bus-supportingmachines, software that makes decisions about which driver to load for aparticular device -- or by any software that needs to get information about adriver for a device.    </p><P>Given the Unit Table reference number of an installed driver,GetDriverInformation returns the driver's unit number in unit, its DCE flags inflags, the number of times it has been opened in count, its name in name, its<code>RegEntryID</code> value in device, its CFM fragment locator in driverLocation, its CFMconnection ID in fragmentConnID, its <code>DoDriverIO</code> entry point in <code>fragmentMain</code>,and its Driver Description in <code>driverDesc</code>.</P><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note: </B><BR>With 68K drivers, <code>GetDriverInformation</code> returns meaningfulinformation in only the unit, flags, count, and name parameters. </P></TD></TR></TABLE></CENTER><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Warning: </B><BR> You must allocate the <code>FSSpec</code> field of the <code>CFragHFSLocator</code> *<code>driverLocation</code> before passing it in to <code>GetDriverInformation()</code>. </P></TD></TR></TABLE></CENTER><BR><h5>RESULT CODES</h5><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    noErr          0    No error    badUnitErr    -21    Bad unit number    unitEmptyErr    -22    Empty unit number</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="Summary"></a><h2>Summary</h2><P>To protect yourself against having GetDriverInformation copy garbage into thepassed <i>StringPtr</i> name parameter when a driver has its Device ControlEntry (DCE) fields zeroed upon closing (the Chooser, for example), allocate alarge enough string (for example, String255) for the name parameter. This willassure that any garbage copied to the string will be contained in thatstring.<BR><br>See <i>Designing PCI Cards and Drivers for Power Macintosh Computers</i> forfurther documentation on GetDriverInformation or any other Driver LoaderLibrary calls.</P><P><A HREF="#top">Back to top</A></P>          <A NAME=Downloads></A>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (64K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tn1025.pdf">Download</A></P>               </TD>            </TR>         </TABLE>         <BR><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER>		<!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1025.html%3Fid%3DDTS10002867-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1025.html%3Fid%3DDTS10002867-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1025.html%3Fid%3DDTS10002867-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>