<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Dynamic Library Programming Topics: Creating Dynamic Libraries</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Creating Dynamic Libraries"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP40002073" title="Creating Dynamic Libraries"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../../Darwin/index.html#//apple_ref/doc/uid/TP30000440-TP30000422" target="_top">Darwin</a> &gt; <a href="../../../../Darwin/RuntimeArchitecture-date.html#//apple_ref/doc/uid/TP30000440-TP30000422-TP30000459" target="_top">Runtime Architecture</a> &gt; <a href="../index.html" target="_top">Dynamic Library Programming Topics</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="DynamicLibraryUsageGuidelines.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="UsingDynamicLibraries.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>
        
        
        <a name="//apple_ref/doc/uid/TP40002073-SW1" title="Creating Dynamic Libraries"></a><hr /><H1>Creating Dynamic Libraries</H1><p>When you create or update dynamic libraries, it’s important to consider the library’s ease of use by developers who incorporate them in their products. It’s also important to give these developers flexibility by allowing their products to work with earlier or later versions of the libraries they used while developing their products.</p><p>This article demonstrates how to write a dynamic library so that it’s easy to use by developers who want to take advantage of it in their own development. This article also describes how to update existing libraries and manage their version information to maximize client compatibility.</p>
<!-- This template is being used for both PDF and HTML. -->

    
    <!-- TopicBook.pm uses this template for its miniTOCs, but needs a different title. -->
    <h4>Contents:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW19">Creating Libraries</a>
				
			<br/>
			
        
			
			
				<a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW24">Updating Libraries</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP40002073-SW19" title="Creating Libraries"></a><h2>Creating Libraries</h2><p>When creating a dynamic library, you should perform these tasks:</p><ul class="ul"><li class="li"><p>Define the library’s purpose: This information provides the focus required to define the library’s public interface.</p></li><li class="li"><p>Define the library’s interface (header files): This is the interface through which the library’s clients access its functionality.</p></li><li class="li"><p>Implement the library (implementation files): This is where you define the public functions that the library’s clients use. You may also need to define private variables and functions needed to implement the interface but not required by clients.</p></li><li class="li"><p>Set the library’s version information: The library’s version information is divided in three parts: major, minor, and compatibility. You specify all the parts of the library’s version information when you create the <code>.dylib</code> file. See <span class="content_text"><a href="DynamicLibraryDesignGuidelines.html#//apple_ref/doc/uid/TP40002013-SW20">“Managing Client Compatibility With Dependent Libraries”</a></span> for details.</p></li><li class="li"><p>Test the library: At the very least, you should define a test for each of the public functions your library exposes, to ensure that they perform the correct action given particular test inputs or after performing a specific set of operations.</p></li></ul><p>The following sections provide an example of the process taken to develop a simple dynamic library, called Ratings. The files mentioned in the following sections are included in <code>Ratings/1.0</code> in this document’s companion-file package.</p><a name="//apple_ref/doc/uid/TP40002073-SW21" title="Defining the Library&acirc;&#128;&#153;s Purpose"></a><h3>Defining the Library’s Purpose</h3><p>The purpose of the Ratings library is to provide a ratings analyzer to its clients. Ratings are strings made up of asterisks (*) that represent levels of satisfaction for a particular item. For example, in Apple’s iTunes application, you can specify whether you like a particular song a lot with a five-star rating  (*****) or not at all with a one-star rating (*).</p><p>The initial release of the library provides a way for clients to add ratings, get a count of the ratings they have added, get the mean rating, and clear the rating set.</p><a name="//apple_ref/doc/uid/TP40002073-SW17" title="Defining the Library&acirc;&#128;&#153;s Interface"></a><h3>Defining the Library’s Interface</h3><p>Before you implement the library, you must define the interface the library’s clients use to interact with it. You should carefully specify each function’s semantics. A clear definition benefits you because it makes clear the purpose of each public function. It also benefits developers who use your library because it tells them exactly what to expect when they call each function in their code.</p><p>This is an example of a list of interface functions with each function’s semantic meaning:</p><ul class="spaceabove"><li class="li"><p><code>void addRating(char* rating)</code>: Adds a rating value to the set kept by the library. The rating argument is a string; it must not be NULL. Each character in the string represents one rating point. For example, an empty string (<code>""</code>) is equivalent to a rating of 0, <code>"*"</code> means 1, <code>"**"</code> means 2, and so on. The actual characters used in the string are immaterial. Therefore, <code>" "</code> means 1 and <code>"3456"</code> means 4. Each call to this function increments the value returned by the ratings function.</p></li><li class="li"><p><code>int ratings(void)</code>: Returns the number of rating values in the set. This function has no side effects.</p></li><li class="li"><p><code>char* meanRatings(void)</code>: Returns the mean rating in the rating set as a string, using one asterisk per rating point. This function has no side effects.</p></li><li class="li"><p><code>clearRatings(void)</code>: Clears the rating set. After calling this function (with no subsequent calls to <code>addRating</code>), the <code>ratings</code> function returns <code>0</code>.</p></li></ul><p><span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW2">Listing 1</a></span> shows the header file that the Ratings library’s clients include to access its interface.</p><a name="//apple_ref/doc/uid/TP40002073-SW2" title="Listing 1 Interface to Ratings 1.0"></a><p class="codesample"><strong>Listing 1&nbsp;&nbsp;</strong> Interface to Ratings 1.0</p><div class="codesample"><table><tr><td scope="row"><pre>/* File: Ratings.h<span></span></pre></td></tr><tr><td scope="row"><pre> * Interface to libRatings.A.dylib 1.0.<span></span></pre></td></tr><tr><td scope="row"><pre> *************************************/<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/* Adds 'rating' to the set.<span></span></pre></td></tr><tr><td scope="row"><pre> *      rating: Each character adds 1 to the numeric rating<span></span></pre></td></tr><tr><td scope="row"><pre> *              Example: "" = 0, "*" = 1, "**" = 2, "wer " = 4.<span></span></pre></td></tr><tr><td scope="row"><pre> */<span></span></pre></td></tr><tr><td scope="row"><pre>void addRating(char* rating);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/* Returns the number of ratings in the set.<span></span></pre></td></tr><tr><td scope="row"><pre> */<span></span></pre></td></tr><tr><td scope="row"><pre>int ratings(void);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/* Returns the mean rating of the set.<span></span></pre></td></tr><tr><td scope="row"><pre> */<span></span></pre></td></tr><tr><td scope="row"><pre>char* meanRating(void);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/* Clears the set.<span></span></pre></td></tr><tr><td scope="row"><pre> */<span></span></pre></td></tr><tr><td scope="row"><pre>void clearRatings(void);<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP40002073-SW22" title="Implementing the Library"></a><h3>Implementing the Library</h3><p>The interface declared in <span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW17">“Defining the Library’s Interface”</a></span> is implemented in <code>Ratings.c</code> , shown in <span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW3">Listing 2</a></span>.</p><a name="//apple_ref/doc/uid/TP40002073-SW3" title="Listing 2Implementation of Ratings 1.0"></a><p class="codesample"><strong>Listing 2&nbsp;&nbsp;</strong>Implementation of Ratings 1.0</p><div class="codesample"><table><tr><td scope="row"><pre>/* File: Ratings.c<span></span></pre></td></tr><tr><td scope="row"><pre> * Compile with -fvisibility=hidden.                        // 1<span></span></pre></td></tr><tr><td scope="row"><pre> **********************************/<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#include "Ratings.h"<span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;stdio.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;string.h><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#define EXPORT __attribute__((visibility("default")))<span></span></pre></td></tr><tr><td scope="row"><pre>#define MAX_NUMBERS 99<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>static int _number_list[MAX_NUMBERS];<span></span></pre></td></tr><tr><td scope="row"><pre>static int _numbers = 0;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Initializer.<span></span></pre></td></tr><tr><td scope="row"><pre>__attribute__((constructor))<span></span></pre></td></tr><tr><td scope="row"><pre>static void initializer(void) {                             // 2<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] initializer()\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Finalizer.<span></span></pre></td></tr><tr><td scope="row"><pre>__attribute__((destructor))<span></span></pre></td></tr><tr><td scope="row"><pre>static void finalizer(void) {                               // 3<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] finalizer()\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Used by meanRating, middleRating, frequentRating.<span></span></pre></td></tr><tr><td scope="row"><pre>static char* _char_rating(int rating) {<span></span></pre></td></tr><tr><td scope="row"><pre>    char result[10] = "";<span></span></pre></td></tr><tr><td scope="row"><pre>    int int_rating = rating;<span></span></pre></td></tr><tr><td scope="row"><pre>    for (int i = 0; i &lt; int_rating; i++) {<span></span></pre></td></tr><tr><td scope="row"><pre>        strncat(result, "*", sizeof(result) - strlen(result) - 1);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    return strdup(result);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Used by addRating.<span></span></pre></td></tr><tr><td scope="row"><pre>void _add(int number) {                                     // 4<span></span></pre></td></tr><tr><td scope="row"><pre>    if (_numbers &lt; MAX_NUMBERS) {<span></span></pre></td></tr><tr><td scope="row"><pre>        _number_list[_numbers++] = number;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Used by meanRating.<span></span></pre></td></tr><tr><td scope="row"><pre>int _mean(void) {<span></span></pre></td></tr><tr><td scope="row"><pre>    int result = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>    if (_numbers) {<span></span></pre></td></tr><tr><td scope="row"><pre>        int sum = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>        int i;<span></span></pre></td></tr><tr><td scope="row"><pre>        for (i = 0; i &lt; _numbers; i++) {<span></span></pre></td></tr><tr><td scope="row"><pre>            sum += _number_list[i];<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        result = sum / _numbers;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>EXPORT<span></span></pre></td></tr><tr><td scope="row"><pre>void addRating(char* rating) {                            // 5<span></span></pre></td></tr><tr><td scope="row"><pre>    if (rating != NULL) {<span></span></pre></td></tr><tr><td scope="row"><pre>        int numeric_rating = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>        int pos = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>        while (*rating++ != '\0' &amp;&amp; pos++ &lt; 5) {<span></span></pre></td></tr><tr><td scope="row"><pre>            numeric_rating++;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        _add(numeric_rating);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>EXPORT<span></span></pre></td></tr><tr><td scope="row"><pre>char* meanRating(void) {<span></span></pre></td></tr><tr><td scope="row"><pre>    return _char_rating(_mean());<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>EXPORT<span></span></pre></td></tr><tr><td scope="row"><pre>int ratings(void) {<span></span></pre></td></tr><tr><td scope="row"><pre>    return _numbers;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>EXPORT<span></span></pre></td></tr><tr><td scope="row"><pre>void clearRatings(void) {<span></span></pre></td></tr><tr><td scope="row"><pre>    _numbers = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>The following list describes the tagged lines.</p><ol class="ol"><li class="li"><p>This comment is only to remind the library’s developers to compile this file with the <code>gcc -fvisibility=hidden</code> option, so that only the symbols with the <code>visibility("default")</code> attribute are exported.</p></li><li class="li"><p>This initializer is defined only to show at which point of a client’s execution the library’s initializers are called by the dynamic loader.</p></li><li class="li"><p>This finalizer is defined only to show at which point of client’s execution the library’s finalizers are called by the dynamic loader.</p></li><li class="li"><p>The <code>_add</code> function is an example of an internal function. Clients don’t need to know about it and, therefore, it’s not exported. Also, because internal calls are trusted, no validation is performed. However, there’s no requirement that internal-use functions lack validation.</p></li><li class="li"><p>The <code>addRating</code> function is an example of an exported function. To ensure that only correct ratings are added, the function’s input parameter is validated.</p></li></ol><a name="//apple_ref/doc/uid/TP40002073-SW20" title="Setting the Library&acirc;&#128;&#153;s Version Information"></a><h3>Setting the Library’s Version Information</h3><p>When you compile the library’s source files into a <code>.dylib</code> file, you set version information that specifies whether clients can use versions of the library earlier or later than the version they were linked against. When the client is loaded into a process, the dynamic loader looks for the <code>.dylib</code> file in the library search paths and, if it finds it, compares the version information of the <code>.dylib</code> file with the version information recorded in the client image. If the client is not compatible with the <code>.dylib</code> file, the dynamic loader doesn’t load the client into the process. In effect, the client’s load process is aborted because the dynamic loader was unable to locate a compatible dependent library.</p><p><span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW4">Listing 3</a></span> shows the command used to generate version 1.0 of the Ratings library.</p><a name="//apple_ref/doc/uid/TP40002073-SW4" title="Listing 3Generating version 1.0 of the Ratings dynamic library"></a><p class="codesample"><strong>Listing 3&nbsp;&nbsp;</strong>Generating version 1.0 of the Ratings dynamic library</p><div class="codesample"><table><tr><td scope="row"><pre>[Ratings/1.0]% make dylib<span></span></pre></td></tr><tr><td scope="row"><pre>gcc -dynamiclib -std=gnu99 Ratings.c -current_version 1.0 -compatibility_version 1.0 -fvisibility=hidden -o libRatings.A.dylib<span></span></pre></td></tr></table></div><p>This list indicates where the major version, minor version, and compatibility version are specified:</p><ul class="spaceabove"><li class="li"><p>The major version number is specified in the library’s filename as “A” in <code>-o libRatings.A.dylib</code>.</p></li><li class="li"><p>The minor version number is specified in <code>-current_version 1.0</code>.</p></li><li class="li"><p>The compatibility version number is specified in <code>-compatibility_version 1.0</code>.</p></li></ul><div class="notebox"><a name="//apple_ref/doc/uid/TP40002073-SW28" title="Note"></a><p><strong>Note:</strong>&nbsp;You can use <code><a href="../../../../Darwin/Reference/ManPages/man1/libtool.1.html#//apple_ref/doc/man/1/libtool" target="_top">libtool</a></code> to create a dynamic library from a set of object files.</p></div><a name="//apple_ref/doc/uid/TP40002073-SW23" title="Testing the Library"></a><h3>Testing the Library</h3><p>Before publishing a dynamic library, you should test its public interface to ensure that it performs as you specified in the interface’s documentation (see <span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW17">“Defining the Library’s Interface.”</a></span> To provide maximum flexibility to clients, you should make sure that your library can be used as a dependent library (clients link against it, and the library is loaded when the client is loaded) or as a runtime-loaded library (clients don’t link against it and use dlopen to load it).</p><p><span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW5">Listing 4</a></span> shows an example of a test client that uses the Ratings library as a dependent library.</p><a name="//apple_ref/doc/uid/TP40002073-SW5" title="Listing 4Testing Ratings 1.0 as a dependent library"></a><p class="codesample"><strong>Listing 4&nbsp;&nbsp;</strong>Testing Ratings 1.0 as a dependent library</p><div class="codesample"><table><tr><td scope="row"><pre>/* Dependent.c<span></span></pre></td></tr><tr><td scope="row"><pre> * Tests libRatings.A.dylib 1.0 as a dependent library.<span></span></pre></td></tr><tr><td scope="row"><pre> *****************************************************/<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;stdio.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;string.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include "Ratings.h"<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#define PASSFAIL "Passed":"Failed"<span></span></pre></td></tr><tr><td scope="row"><pre>#define UNTST "Untested"<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>int main(int argc, char** argv) {<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[start_test]\n");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Setup.<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating(NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("*");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("**");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("***");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("*****");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("*****");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // ratings.<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] ratings(): %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>        __FILE__, (ratings() == 6? PASSFAIL));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // meanRating.<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] meanRating(): %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>        __FILE__, (strcmp(meanRating(), "**") == 0)? PASSFAIL);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // clearRatings.<span></span></pre></td></tr><tr><td scope="row"><pre>    clearRatings();<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] clearRatings(): %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>        __FILE__, (ratings() == 0? PASSFAIL));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[end_test]\n");<span></span></pre></td></tr><tr><td scope="row"><pre>    return 0;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>The following command generates the Dependent client application. Note that <code>libRatings.A.dylib</code> is included in the compile line.</p><div class="codesample"><table><tr><td scope="row"><pre>gcc Dependent.c libRatings.A.dylib -o Dependent<span></span></pre></td></tr></table></div><p>The Dependent application produces output that shows whether calling each of the library’s exported functions produces the expected results. In addition, the <code>initializer</code> and <code>finalizer</code> functions defined in the library produce output lines that indicate when they are invoked in relation to the application’s normal process. This output is shown in <span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW6">Listing 5</a></span>.</p><a name="//apple_ref/doc/uid/TP40002073-SW6" title="Listing 5Test results for Ratings 1.0 as a dependent library"></a><p class="codesample"><strong>Listing 5&nbsp;&nbsp;</strong>Test results for Ratings 1.0 as a dependent library</p><div class="codesample"><table><tr><td scope="row"><pre>> ./Dependent<span></span></pre></td></tr><tr><td scope="row"><pre>[Ratings.c] initializer()<span></span></pre></td></tr><tr><td scope="row"><pre>[start_test]<span></span></pre></td></tr><tr><td scope="row"><pre>[Dependent.c] ratings(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Dependent.c] meanRating(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Dependent.c] clearRatings(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[end_test]<span></span></pre></td></tr><tr><td scope="row"><pre>[Ratings.c] finalizer()<span></span></pre></td></tr></table></div><p>Notice that <code>initializer</code> is called before the <code>main</code> function. The finalizer function, on the other hand, is called after exiting the <code>main</code> function.</p><p>Testing the Ratings library as a runtime-loaded library requires another test application, Runtime. <span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW8">Listing 6</a></span> shows its source file.</p><a name="//apple_ref/doc/uid/TP40002073-SW8" title="Listing 6Testing Ratings 1.0 as a runtime-loaded library"></a><p class="codesample"><strong>Listing 6&nbsp;&nbsp;</strong>Testing Ratings 1.0 as a runtime-loaded library</p><div class="codesample"><table><tr><td scope="row"><pre>/* Runtime.c<span></span></pre></td></tr><tr><td scope="row"><pre> * Tests libRatings.A.dylib 1.0 as a runtime-loaded library.<span></span></pre></td></tr><tr><td scope="row"><pre> ***********************************************************/<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;stdio.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;stdlib.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;dlfcn.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;string.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include "Ratings.h"<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#define PASSFAIL "Passed":"Failed"<span></span></pre></td></tr><tr><td scope="row"><pre>#define UNTST "Untested"<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>int main(int argc, char** argv) {<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[start_test]\n");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Open the library.<span></span></pre></td></tr><tr><td scope="row"><pre>    char* lib_name = "./libRatings.A.dylib";<span></span></pre></td></tr><tr><td scope="row"><pre>    void* lib_handle = dlopen(lib_name, RTLD_NOW);<span></span></pre></td></tr><tr><td scope="row"><pre>    if (lib_handle) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlopen(\"%s\", RTLD_NOW): Successful\n", __FILE__, lib_name);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to open library: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>        exit(EXIT_FAILURE);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Get the symbol addresses.<span></span></pre></td></tr><tr><td scope="row"><pre>    void (*addRating)(char*) = dlsym(lib_handle, "addRating");<span></span></pre></td></tr><tr><td scope="row"><pre>    if (addRating) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlsym(lib_handle, \"addRating\"): Successful\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to get symbol: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>        exit(EXIT_FAILURE);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    char* (*meanRating)(void) = dlsym(lib_handle, "meanRating");<span></span></pre></td></tr><tr><td scope="row"><pre>    if (meanRating) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlsym(lib_handle, \"meanRating\"): Successful\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to get symbol: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>        exit(EXIT_FAILURE);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    void (*clearRatings)(void) = dlsym(lib_handle, "clearRatings");<span></span></pre></td></tr><tr><td scope="row"><pre>    if (clearRatings) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlsym(lib_handle, \"clearRatings\"): Successful\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to get symbol: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>        exit(EXIT_FAILURE);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    int (*ratings)(void) = dlsym(lib_handle, "ratings");<span></span></pre></td></tr><tr><td scope="row"><pre>    if (ratings) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlsym(lib_handle, \"ratings\"): Successful\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to get symbol: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>        exit(EXIT_FAILURE);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Setup.<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating(NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("*");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("**");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("***");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("*****");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("*****");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // ratings.<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] ratings(): %s\n", __FILE__, (ratings() == 6? PASSFAIL));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // meanRating.<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] meanRating(): %s\n", __FILE__, (strcmp(meanRating(), "**") == 0)? PASSFAIL);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // clearRatings.<span></span></pre></td></tr><tr><td scope="row"><pre>    clearRatings();<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] clearRatings(): %s\n", __FILE__, (ratings() == 0? PASSFAIL));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Close the library.<span></span></pre></td></tr><tr><td scope="row"><pre>    if (dlclose(lib_handle) == 0) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlclose(lib_handle): Successful\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to open close: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[end_test]\n");<span></span></pre></td></tr><tr><td scope="row"><pre>    return 0;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>	<p>The Runtime application is very similar to the Dependent application. However, Runtime must load <code>libRuntime.A.dylib</code> using the <code><a href="../../../Reference/MachOReference/Reference/reference.html#//apple_ref/c/func/dlopen" target="_top">dlopen</a></code> function. After that, it must get the address of each function exported by the library using <code><a href="../../../Reference/MachOReference/Reference/reference.html#//apple_ref/c/func/dlsym" target="_top">dlsym</a></code> before using it.</p><p>The following command generates the Runtime client application.</p><div class="codesample"><table><tr><td scope="row"><pre>[Ratings/1.0]% make runtime<span></span></pre></td></tr><tr><td scope="row"><pre>gcc Runtime.c -o Runtime<span></span></pre></td></tr></table></div><p><span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW18">Listing 7</a></span> shows the output produced by Runtime.</p><a name="//apple_ref/doc/uid/TP40002073-SW18" title="Listing 7Test results for Ratings 1.0 as a runtime-loaded library"></a><p class="codesample"><strong>Listing 7&nbsp;&nbsp;</strong>Test results for Ratings 1.0 as a runtime-loaded library</p><div class="codesample"><table><tr><td scope="row"><pre>> ./Runtime<span></span></pre></td></tr><tr><td scope="row"><pre>[start_test]<span></span></pre></td></tr><tr><td scope="row"><pre>[Ratings.c] initializer()<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlopen("./libRatings.A.dylib", RTLD_NOW): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlsym(lib_handle, "addRating"): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlsym(lib_handle, "meanRating"): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlsym(lib_handle, "clearRatings"): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlsym(lib_handle, "ratings"): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] ratings(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] meanRating(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] clearRatings(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlclose(lib_handle): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[end_test]<span></span></pre></td></tr><tr><td scope="row"><pre>[Ratings.c] finalizer()<span></span></pre></td></tr></table></div><p>Note that the Ratings library’s initializer function is called within the main function execution before the call to <code>dlopen</code> returns, which differs from its execution point in the Dependent application <span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW6">Listing 5</a></span>. The <code>finalizer</code> function, however, is called after <code>main</code> has exited, the same point at which it’s called in Dependent’s execution. You should consider this when writing dynamic library initializers and finalizers.</p><a name="//apple_ref/doc/uid/TP40002073-SW24" title="Updating Libraries"></a><h2>Updating Libraries</h2><p>Making revisions to a previously published dynamic library is a delicate task. If you want existing clients to be able to use the library (that is, load the new version of the <code>.dylib</code> file without recompilation), you must ensure that the API those clients know about is unchanged, including its semantic meaning.</p><p>When you can guarantee that the API of the new version of the library is compatible with the API that clients linked against earlier versions know about, you can deem the new version a minor revision. When you want to publish a minor revision of a dynamic library to users of the library’s clients (for example, the users of an application that uses your library) the only version information item you need to change is the library’s current version. The major version (filename) and compatibility version of the library must remain the same. When end users replace the early version of the library with the new version in their computers, the library’s clients use the new version without any problems. <span class="content_text"><a href="DynamicLibraryDesignGuidelines.html#//apple_ref/doc/uid/TP40002013-SW20">“Managing Client Compatibility With Dependent Libraries.”</a></span></p><a name="//apple_ref/doc/uid/TP40002073-SW25" title="Making Compatible Changes"></a><h3>Making Compatible Changes</h3><p>From the point of view of a client image, there are two sides to compatibility with the dynamic libraries it uses: compatibility with versions of a library later than the one the client knows about, known as forward compatibility, and compatibility with versions of a library earlier than the one the client is familiar with, known as backward compatibility. You maintain forward compatibility by ensuring that the library’s API remains compatible across revisions. You facilitate backward compatibility by exporting new functions as weak references. In turn, your library’s clients must ensure that weakly imported functions actually exist before using them.</p><p>The Ratings library, introduced in <span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW19">“Creating Libraries,”</a></span> has a second version, 1.1. <span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW7">Listing 8</a></span> shows the updated header for the Ratings library.</p><a name="//apple_ref/doc/uid/TP40002073-SW7" title="Listing 8Interface to Ratings 1.1"></a><p class="codesample"><strong>Listing 8&nbsp;&nbsp;</strong>Interface to Ratings 1.1</p><div class="codesample"><table><tr><td scope="row"><pre>/* File: Ratings.h<span></span></pre></td></tr><tr><td scope="row"><pre> * Interface to libRatings.A.dylib 1.1.<span></span></pre></td></tr><tr><td scope="row"><pre> *************************************/<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#define WEAK_IMPORT __attribute__((weak_import))<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/* Adds 'rating' to the set.<span></span></pre></td></tr><tr><td scope="row"><pre> *      rating: Each character adds 1 to the numeric rating<span></span></pre></td></tr><tr><td scope="row"><pre> *      Example: "" = 0, "*" = 1, "**" = 2, "wer " = 4.<span></span></pre></td></tr><tr><td scope="row"><pre> */<span></span></pre></td></tr><tr><td scope="row"><pre>void addRating(char* rating);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/* Returns the number of ratings in the set.<span></span></pre></td></tr><tr><td scope="row"><pre> */<span></span></pre></td></tr><tr><td scope="row"><pre>int ratings(void);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/* Returns the mean rating of the set.<span></span></pre></td></tr><tr><td scope="row"><pre> */<span></span></pre></td></tr><tr><td scope="row"><pre>char* meanRating(void);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/* Returns the medianRating of the set.<span></span></pre></td></tr><tr><td scope="row"><pre> */<span></span></pre></td></tr><tr><td scope="row"><pre>WEAK_IMPORT<span></span></pre></td></tr><tr><td scope="row"><pre>char* medianRating(void);                       // 1<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/* Returns the most frequent rating of the set.<span></span></pre></td></tr><tr><td scope="row"><pre> */<span></span></pre></td></tr><tr><td scope="row"><pre>WEAK_IMPORT<span></span></pre></td></tr><tr><td scope="row"><pre>char* frequentRating(void);                     // 2<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/* Clears the set.<span></span></pre></td></tr><tr><td scope="row"><pre> */<span></span></pre></td></tr><tr><td scope="row"><pre>void clearRatings(void);<span></span></pre></td></tr></table></div><p>The tagged lines declare the new functions. Notice that both declarations include the <code>weak_import</code> attribute, informing client developers that the function is weakly linked. Therefore, clients must make sure the function exists before calling it.</p><p><span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW30">Listing 9</a></span> shows the library’s new implementation file.</p><a name="//apple_ref/doc/uid/TP40002073-SW30" title="Listing 9Implementation of Ratings 1.1"></a><p class="codesample"><strong>Listing 9&nbsp;&nbsp;</strong>Implementation of Ratings 1.1</p><div class="codesample"><table><tr><td scope="row"><pre>/* File: Ratings.c<span></span></pre></td></tr><tr><td scope="row"><pre> * Compile with -fvisibility=hidden.<span></span></pre></td></tr><tr><td scope="row"><pre> **********************************/<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#include "Ratings.h"<span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;Averages.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;stdio.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;string.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;float.h><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#define EXPORT __attribute__((visibility("default")))<span></span></pre></td></tr><tr><td scope="row"><pre>#define MAX_NUMBERS 99<span></span></pre></td></tr><tr><td scope="row"><pre>//#define MAX_NUMERIC_RATING 10               // published in Ratings.h<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>static char* _char_rating(float rating) {<span></span></pre></td></tr><tr><td scope="row"><pre>    char result[10] = "";<span></span></pre></td></tr><tr><td scope="row"><pre>    int int_rating = (int)(rating + 0.5);<span></span></pre></td></tr><tr><td scope="row"><pre>    for (int i = 0; i &lt; int_rating; i++) {<span></span></pre></td></tr><tr><td scope="row"><pre>        strncat(result, "*", sizeof(result) - strlen(result) - 1);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    return strdup(result);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>EXPORT<span></span></pre></td></tr><tr><td scope="row"><pre>void addRating(char* rating) {<span></span></pre></td></tr><tr><td scope="row"><pre>    if (rating != NULL) {<span></span></pre></td></tr><tr><td scope="row"><pre>        int numeric_rating = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>        int pos = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>        while (*rating++ != '\0' &amp;&amp; pos++ &lt; 5) {<span></span></pre></td></tr><tr><td scope="row"><pre>            numeric_rating++;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        add((float)numeric_rating);     // libAverages.A:add()<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>EXPORT<span></span></pre></td></tr><tr><td scope="row"><pre>char* meanRating(void) {<span></span></pre></td></tr><tr><td scope="row"><pre>    return _char_rating(mean());        // libAverages.A:mean()<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>EXPORT<span></span></pre></td></tr><tr><td scope="row"><pre>char* medianRating(void) {<span></span></pre></td></tr><tr><td scope="row"><pre>    return _char_rating(median());      // libAverages.A:median()<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>EXPORT<span></span></pre></td></tr><tr><td scope="row"><pre>char* frequentRating(void) {<span></span></pre></td></tr><tr><td scope="row"><pre>    int lib_mode = mode();                // libAverages.A:mode()<span></span></pre></td></tr><tr><td scope="row"><pre>    return _char_rating(lib_mode);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>EXPORT<span></span></pre></td></tr><tr><td scope="row"><pre>int ratings(void) {<span></span></pre></td></tr><tr><td scope="row"><pre>    return count();                     // libAverages.A:count()<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>EXPORT<span></span></pre></td></tr><tr><td scope="row"><pre>void clearRatings(void) {<span></span></pre></td></tr><tr><td scope="row"><pre>    clear();                            // libAverages.A:clear()<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>/* Ratings.c revision history<span></span></pre></td></tr><tr><td scope="row"><pre> * 1. First version.<span></span></pre></td></tr><tr><td scope="row"><pre> * 2. Added medianRating, frequentRating.<span></span></pre></td></tr><tr><td scope="row"><pre> *    Removed initializer, finalizer.<span></span></pre></td></tr><tr><td scope="row"><pre> */<span></span></pre></td></tr></table></div><p><span class="content_text">Listing 10</span> shows the updated source code for the Runtime program that tests the Ratings 1.1 library.</p><a name="//apple_ref/doc/uid/TP40002073-SW9" title="Listing 10Testing Ratings 1.1 as a runtime-loaded library"></a><p class="codesample"><strong>Listing 10&nbsp;&nbsp;</strong>Testing Ratings 1.1 as a runtime-loaded library</p><div class="codesample"><table><tr><td scope="row"><pre>/* Runtime.c<span></span></pre></td></tr><tr><td scope="row"><pre> * Tests libRatings.A.dylib 1.1 as a runtime-loaded library.<span></span></pre></td></tr><tr><td scope="row"><pre> **********************************************************/<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;stdio.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;stdlib.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;dlfcn.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;string.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include "Ratings.h"<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#define PASSFAIL "Passed":"Failed"<span></span></pre></td></tr><tr><td scope="row"><pre>#define UNTST "Untested"<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>int main(int argc, char** argv) {<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[start_test]\n");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Open the library.<span></span></pre></td></tr><tr><td scope="row"><pre>    char* lib_name = "./libRatings.A.dylib";<span></span></pre></td></tr><tr><td scope="row"><pre>    void* lib_handle = dlopen(lib_name, RTLD_NOW);<span></span></pre></td></tr><tr><td scope="row"><pre>    if (lib_handle) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlopen(\"%s\", RTLD_NOW): Successful\n", __FILE__, lib_name);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to open library: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>        exit(EXIT_FAILURE);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Get the function addresses.<span></span></pre></td></tr><tr><td scope="row"><pre>    void (*addRating)(char*) = dlsym(lib_handle, "addRating");<span></span></pre></td></tr><tr><td scope="row"><pre>    if (addRating) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlsym(lib_handle, \"addRating\"): Successful\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to get symbol: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>        exit(EXIT_FAILURE);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    char* (*meanRating)(void) = dlsym(lib_handle, "meanRating");<span></span></pre></td></tr><tr><td scope="row"><pre>    if (meanRating) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlsym(lib_handle, \"meanRating\"): Successful\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to get symbol: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>        exit(EXIT_FAILURE);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    void (*clearRatings)(void) = dlsym(lib_handle, "clearRatings");<span></span></pre></td></tr><tr><td scope="row"><pre>    if (clearRatings) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlsym(lib_handle, \"clearRatings\"): Successful\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to get symbol: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>        exit(EXIT_FAILURE);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    int (*ratings)(void) = dlsym(lib_handle, "ratings");<span></span></pre></td></tr><tr><td scope="row"><pre>    if (ratings) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlsym(lib_handle, \"ratings\"): Successful\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to get symbol: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>        exit(EXIT_FAILURE);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    char* (*medianRating)(void) = dlsym(lib_handle, "medianRating");        // weak import<span></span></pre></td></tr><tr><td scope="row"><pre>    char* (*frequentRating)(void) = dlsym(lib_handle, "frequentRating");    // weak import<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Setup.<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating(NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("*");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("**");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("***");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("*****");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("*****");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // ratings.<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] ratings(): %s\n", __FILE__, (ratings() == 6? PASSFAIL));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // meanRating.<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] meanRating(): %s\n", __FILE__, (strcmp(meanRating(), "**") == 0)? PASSFAIL);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // medianRating.<span></span></pre></td></tr><tr><td scope="row"><pre>    if (medianRating) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] medianRating(): %s\n", __FILE__, (strcmp(medianRating(), "**") == 0? PASSFAIL));<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] medianRating(): %s\n", __FILE__, UNTST);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // frequentRating.<span></span></pre></td></tr><tr><td scope="row"><pre>    if (frequentRating) {<span></span></pre></td></tr><tr><td scope="row"><pre>        char* mfr = "*****";<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] frequentRating(): %s\n", __FILE__, strncmp(mfr, frequentRating(), sizeof(mfr)) == 0? PASSFAIL);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] mostFrequentRating(): %s\n", __FILE__, UNTST);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // clearRatings.<span></span></pre></td></tr><tr><td scope="row"><pre>    clearRatings();<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] clearRatings(): %s\n", __FILE__, (ratings() == 0? PASSFAIL));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Close the library.<span></span></pre></td></tr><tr><td scope="row"><pre>    if (dlclose(lib_handle) == 0) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlclose(lib_handle): Successful\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to open close: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[end_test]\n");<span></span></pre></td></tr><tr><td scope="row"><pre>    return 0;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>	<a name="//apple_ref/doc/uid/TP40002073-SW26" title="Updating the Library&acirc;&#128;&#153;s Version Information"></a><h3>Updating the Library’s Version Information</h3><p><span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW10">Listing 11</a></span> shows the command used to generate version 1.1 of the Ratings library.</p><a name="//apple_ref/doc/uid/TP40002073-SW10" title="Listing 11Generating version 1.1 of the Ratings dynamic library"></a><p class="codesample"><strong>Listing 11&nbsp;&nbsp;</strong>Generating version 1.1 of the Ratings dynamic library</p><div class="codesample"><table><tr><td scope="row"><pre>[Ratings/1.1]% make dylib<span></span></pre></td></tr><tr><td scope="row"><pre>gcc -dynamiclib -std=gnu99 Ratings.c /usr/local/lib/libAverages.dylib -current_version 1.1 -compatibility_version 1.0 -fvisibility=hidden -o libRatings.A.dylib<span></span></pre></td></tr></table></div>	<p>Notice that this time the library’s current version is set to 1.1 but its compatibility version remains 1.0. When a client is linked against version 1.1 of this library, the compatibility version is encoded in the client image. Therefore, the dynamic loader loads the client image whether it finds version 1.1 or 1.0 of <code>libRatings.A.dylib</code>. That is, the client is backwards compatible with version 1.0 of the library. For details on why <code> /usr/local/lib/libAverages.dylib</code> was added to the compile line, see <span class="content_text"><a href="UsingDynamicLibraries.html#//apple_ref/doc/uid/TP40002182-SW11">“Using Dependent Libraries.”</a></span></p><div class="notebox"><a name="//apple_ref/doc/uid/TP40002073-SW29" title="Note"></a><p><strong>Note:</strong>&nbsp;Weak references are a feature of Mac OS X v10.2 and later. Therefore, when using weak references, your library can be used only by applications running in Mac OS X v10.2 or later.</p></div><a name="//apple_ref/doc/uid/TP40002073-SW27" title="Testing the New Version of the Library"></a><h3>Testing the New Version of the Library</h3><p>Similar to creating initial versions of a library, updating libraries require thorough testing. You should at least add tests for each function you added to your test applications. If you used weak references, your test applications should ensure the existence of the new functions before calling them.</p><p>The <code>Ratings/1.1</code> directory in this document’s companion-file package contains the source files for the Ratings 1.1 library. <span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW11">Listing 12</a></span> shows an updated version of the Dependent application. The tagged lines show how to check for the presence of a function before using it.</p><a name="//apple_ref/doc/uid/TP40002073-SW11" title="Listing 12Testing Ratings 1.1 as a dependent library"></a><p class="codesample"><strong>Listing 12&nbsp;&nbsp;</strong>Testing Ratings 1.1 as a dependent library</p><div class="codesample"><table><tr><td scope="row"><pre>/* Dependent.c<span></span></pre></td></tr><tr><td scope="row"><pre> * Tests libRatings.A.dylib 1.1 as a dependent library.<span></span></pre></td></tr><tr><td scope="row"><pre> *****************************************************/<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;stdio.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;string.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include "Ratings.h"<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#define PASSFAIL "Passed":"Failed"<span></span></pre></td></tr><tr><td scope="row"><pre>#define UNTST "Untested"<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>int main(int argc, char** argv) {<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[start_test]\n");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Setup.<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating(NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("*");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("**");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("***");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("*****");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("*****");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // ratings.<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] ratings(): %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>        __FILE__, (ratings() == 6? PASSFAIL));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // meanRating.<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] meanRating(): %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>        __FILE__, (strcmp(meanRating(), "**") == 0)? PASSFAIL);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // medianRating.<span></span></pre></td></tr><tr><td scope="row"><pre>    if (medianRating) {                         // 1<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] medianRating(): %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, (strcmp(medianRating(), "**") == 0? PASSFAIL));<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] medianRating(): %s\n", __FILE__, UNTST);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // frequentRating.<span></span></pre></td></tr><tr><td scope="row"><pre>    if (frequentRating) {                         // 2<span></span></pre></td></tr><tr><td scope="row"><pre>        char* mfr = "*****";<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] frequentRating(): %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, strncmp(mfr, frequentRating(),<span></span></pre></td></tr><tr><td scope="row"><pre>            sizeof(mfr)) == 0? PASSFAIL);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] mostFrequentRating(): %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, UNTST);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // clearRatings.<span></span></pre></td></tr><tr><td scope="row"><pre>    clearRatings();<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] clearRatings(): %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>        __FILE__, (ratings() == 0? PASSFAIL));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[end_test]\n");<span></span></pre></td></tr><tr><td scope="row"><pre>    return 0;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Ratings 1.1 depends on Averages 1.1. Therefore, to build the library as well as the test applications, <code>libAverages.A.dylib</code> must be installed in <code>/usr/local</code>. To accomplish this, run this command after opening this document’s companion-file package:</p><div class="codesample"><table><tr><td scope="row"><pre>[Avarages/1.0]% make install<span></span></pre></td></tr></table></div><p>To compile the new version of the library as well as the Dependent application, you must set the <code>MACOSX_DEPLOYMENT_TARGET</code> environment variable to 10.2 or later. These are commands needed to compile the library and the test applications from the <code>Ratings/1.1</code> directory using <code>tsch</code>:</p><div class="codesample"><table><tr><td scope="row"><pre>[Ratings/1.1]% setenv MACOSX_DEPLOYMENT_TARGET 10.4<span></span></pre></td></tr><tr><td scope="row"><pre>[Ratings/1.1]% make<span></span></pre></td></tr><tr><td scope="row"><pre>gcc -dynamiclib -std=gnu99 Ratings.c /usr/local/lib/libAverages.dylib -current_version 1.1 -compatibility_version 1.0 -fvisibility=hidden -o libRatings.A.dylib<span></span></pre></td></tr><tr><td scope="row"><pre>gcc Dependent.c libRatings.A.dylib /usr/local/lib/libAverages.dylib -o Dependent<span></span></pre></td></tr><tr><td scope="row"><pre>gcc Runtime.c -o Runtime<span></span></pre></td></tr></table></div>	<p>The output the application produces is shown in <span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW12">Listing 13</a></span>.</p><a name="//apple_ref/doc/uid/TP40002073-SW12" title="Listing 13Test results for Ratings 1.1 used as a dependent library"></a><p class="codesample"><strong>Listing 13&nbsp;&nbsp;</strong>Test results for Ratings 1.1 used as a dependent library</p><div class="codesample"><table><tr><td scope="row"><pre>> ./Dependent<span></span></pre></td></tr><tr><td scope="row"><pre>[start_test]<span></span></pre></td></tr><tr><td scope="row"><pre>[Dependent.c] ratings(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Dependent.c] meanRating(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Dependent.c] medianRating(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Dependent.c] frequentRating(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Dependent.c] clearRatings(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[end_test]<span></span></pre></td></tr></table></div><p>Applications that use dlopen to load your library should not fail if they are unable to obtain an address for your weakly exported functions with dlsym. Therefore, the application that test your library as a runtime-loaded library, should allow for the absence of weakly imported functions.</p><p><span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW13">Listing 14</a></span> shows an updated version of the Runtime application. Notice that it uses dlsym to try get the addresses of the new functions but doesn’t exit with an error if they are unavailable. However, just before the application uses the new functions, it determines whether they actually exists. If they don’t exist, it doesn’t perform the test.</p><a name="//apple_ref/doc/uid/TP40002073-SW13" title="Listing 14Testing Ratings 1.1 as a runtime-loaded library"></a><p class="codesample"><strong>Listing 14&nbsp;&nbsp;</strong>Testing Ratings 1.1 as a runtime-loaded library</p><div class="codesample"><table><tr><td scope="row"><pre>/* Runtime.c<span></span></pre></td></tr><tr><td scope="row"><pre> * Tests libRatings.A.dylib 1.1 as a runtime-loaded library.<span></span></pre></td></tr><tr><td scope="row"><pre> **********************************************************/<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;stdio.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;stdlib.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;dlfcn.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;string.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include "Ratings.h"<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#define PASSFAIL "Passed":"Failed"<span></span></pre></td></tr><tr><td scope="row"><pre>#define UNTST "Untested"<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>int main(int argc, char** argv) {<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[start_test]\n");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Open the library.<span></span></pre></td></tr><tr><td scope="row"><pre>    char* lib_name = "./libRatings.A.dylib";<span></span></pre></td></tr><tr><td scope="row"><pre>    void* lib_handle = dlopen(lib_name, RTLD_NOW);<span></span></pre></td></tr><tr><td scope="row"><pre>    if (lib_handle) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlopen(\"%s\", RTLD_NOW): Successful\n", __FILE__, lib_name);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to open library: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>        exit(EXIT_FAILURE);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Get the function addresses.<span></span></pre></td></tr><tr><td scope="row"><pre>    void (*addRating)(char*) = dlsym(lib_handle, "addRating");<span></span></pre></td></tr><tr><td scope="row"><pre>    if (addRating) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlsym(lib_handle, \"addRating\"): Successful\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to get symbol: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>        exit(EXIT_FAILURE);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    char* (*meanRating)(void) = dlsym(lib_handle, "meanRating");<span></span></pre></td></tr><tr><td scope="row"><pre>    if (meanRating) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlsym(lib_handle, \"meanRating\"): Successful\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to get symbol: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>        exit(EXIT_FAILURE);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    void (*clearRatings)(void) = dlsym(lib_handle, "clearRatings");<span></span></pre></td></tr><tr><td scope="row"><pre>    if (clearRatings) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlsym(lib_handle, \"clearRatings\"): Successful\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to get symbol: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>        exit(EXIT_FAILURE);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    int (*ratings)(void) = dlsym(lib_handle, "ratings");<span></span></pre></td></tr><tr><td scope="row"><pre>    if (ratings) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlsym(lib_handle, \"ratings\"): Successful\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to get symbol: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>        exit(EXIT_FAILURE);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    char* (*medianRating)(void) = dlsym(lib_handle, "medianRating");        // weak import<span></span></pre></td></tr><tr><td scope="row"><pre>    char* (*frequentRating)(void) = dlsym(lib_handle, "frequentRating");    // weak import<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Setup.<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating(NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("*");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("**");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("***");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("*****");<span></span></pre></td></tr><tr><td scope="row"><pre>    addRating("*****");<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // ratings.<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] ratings(): %s\n", __FILE__, (ratings() == 6? PASSFAIL));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // meanRating.<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] meanRating(): %s\n", __FILE__, (strcmp(meanRating(), "**") == 0)? PASSFAIL);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // medianRating.<span></span></pre></td></tr><tr><td scope="row"><pre>    if (medianRating) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] medianRating(): %s\n", __FILE__, (strcmp(medianRating(), "**") == 0? PASSFAIL));<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] medianRating(): %s\n", __FILE__, UNTST);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // frequentRating.<span></span></pre></td></tr><tr><td scope="row"><pre>    if (frequentRating) {<span></span></pre></td></tr><tr><td scope="row"><pre>        char* mfr = "*****";<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] frequentRating(): %s\n", __FILE__, strncmp(mfr, frequentRating(), sizeof(mfr)) == 0? PASSFAIL);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] mostFrequentRating(): %s\n", __FILE__, UNTST);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // clearRatings.<span></span></pre></td></tr><tr><td scope="row"><pre>    clearRatings();<span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[%s] clearRatings(): %s\n", __FILE__, (ratings() == 0? PASSFAIL));<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Close the library.<span></span></pre></td></tr><tr><td scope="row"><pre>    if (dlclose(lib_handle) == 0) {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] dlclose(lib_handle): Successful\n", __FILE__);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else {<span></span></pre></td></tr><tr><td scope="row"><pre>        printf("[%s] Unable to open close: %s\n",<span></span></pre></td></tr><tr><td scope="row"><pre>            __FILE__, dlerror());<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    printf("[end_test]\n");<span></span></pre></td></tr><tr><td scope="row"><pre>    return 0;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>	<p><span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW14">Listing 15</a></span> shows the output produced by Runtime.</p><a name="//apple_ref/doc/uid/TP40002073-SW14" title="Listing 15Test results for Ratings 1.1 used as a runtime-loaded library"></a><p class="codesample"><strong>Listing 15&nbsp;&nbsp;</strong>Test results for Ratings 1.1 used as a runtime-loaded library</p><div class="codesample"><table><tr><td scope="row"><pre>[Ratings/1.1]% ./Runtime<span></span></pre></td></tr><tr><td scope="row"><pre>[start_test]<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlopen("./libRatings.A.dylib", RTLD_NOW): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlsym(lib_handle, "addRating"): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlsym(lib_handle, "meanRating"): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlsym(lib_handle, "clearRatings"): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlsym(lib_handle, "ratings"): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] ratings(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] meanRating(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] medianRating(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] frequentRating(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] clearRatings(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlclose(lib_handle): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[end_test]<span></span></pre></td></tr></table></div><p>To ensure that clients linked against version 1.0 of libRatings.A.dylib can use version 1.1 of the library, you can copy <code>Ratings/1.1/libRatings.A.dylib</code> to <code>Ratings/1.0</code>. When you run the first Dependent application, its output is the identical to the output it produced when it used version 1.0 of the library. The first Dependent application knows nothing about the functions introduces in version 1.1 of the Ratings library; therefore, it doesn’t call them.</p><p>A more interesting test, however, is making sure that clients linked against version 1.1 of the Ratings library can run when their copy of the library is replaced with version 1.0. To test this, execute the following commands in Terminal:</p><div class="codesample"><table><tr><td scope="row"><pre>[           ]% cd <em>companion_dir</em>/Ratings/1.1<span></span></pre></td></tr><tr><td scope="row"><pre>[Ratings/1.1]% make<span></span></pre></td></tr><tr><td scope="row"><pre>[Ratings/1.1]% cd ../1.0<span></span></pre></td></tr><tr><td scope="row"><pre>[Ratings/1.0]% make<span></span></pre></td></tr><tr><td scope="row"><pre>[Ratings/1.0]% cp libRatings.A.dylib ../1.1<span></span></pre></td></tr><tr><td scope="row"><pre>[Ratings/1.0]% cd ../1.1<span></span></pre></td></tr></table></div><p><span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW15">Listing 16</a></span> shows the output produced by the second version Dependent, linked against Ratings 1.1, when it loads version 1.0 instead of version 1.1.</p><a name="//apple_ref/doc/uid/TP40002073-SW15" title="Listing 16Test results for Ratings 1.0 used as a dependent library by a client linked against Ratings 1.1"></a><p class="codesample"><strong>Listing 16&nbsp;&nbsp;</strong>Test results for Ratings 1.0 used as a dependent library by a client linked against Ratings 1.1</p><div class="codesample"><table><tr><td scope="row"><pre>[Ratings/1.1]% ./Dependent<span></span></pre></td></tr><tr><td scope="row"><pre>[Ratings.c] initializer()<span></span></pre></td></tr><tr><td scope="row"><pre>[start_test]<span></span></pre></td></tr><tr><td scope="row"><pre>[Dependent.c] ratings(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Dependent.c] meanRating(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Dependent.c] medianRating(): Untested<span></span></pre></td></tr><tr><td scope="row"><pre>[Dependent.c] mostFrequentRating(): Untested<span></span></pre></td></tr><tr><td scope="row"><pre>[Dependent.c] clearRatings(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[end_test]<span></span></pre></td></tr><tr><td scope="row"><pre>[Ratings.c] finalizer()<span></span></pre></td></tr></table></div><p>The second version of the Runtime test application produces similar output when using Ratings 1.0, as shown in <span class="content_text"><a href="CreatingDynamicLibraries.html#//apple_ref/doc/uid/TP40002073-SW16">Listing 17</a></span>.</p><a name="//apple_ref/doc/uid/TP40002073-SW16" title="Listing 17Test results for Ratings 1.0 used as a runtime-loaded library by a client developed against Ratings 1.1 when using Ratings 1.0"></a><p class="codesample"><strong>Listing 17&nbsp;&nbsp;</strong>Test results for Ratings 1.0 used as a runtime-loaded library by a client developed against Ratings 1.1 when using Ratings 1.0</p><div class="codesample"><table><tr><td scope="row"><pre>[Ratings/1.1]% ./Runtime<span></span></pre></td></tr><tr><td scope="row"><pre>[start_test]<span></span></pre></td></tr><tr><td scope="row"><pre>[Ratings.c] initializer()<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlopen("./libRatings.A.dylib", RTLD_NOW): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlsym(lib_handle, "addRating"): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlsym(lib_handle, "meanRating"): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlsym(lib_handle, "clearRatings"): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlsym(lib_handle, "ratings"): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] ratings(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] meanRating(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] medianRating(): Untested<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] mostFrequentRating(): Untested<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] clearRatings(): Passed<span></span></pre></td></tr><tr><td scope="row"><pre>[Runtime.c] dlclose(lib_handle): Successful<span></span></pre></td></tr><tr><td scope="row"><pre>[end_test]<span></span></pre></td></tr><tr><td scope="row"><pre>[Ratings.c] finalizer()<span></span></pre></td></tr></table></div>

        <br/><br/> 

        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="DynamicLibraryUsageGuidelines.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="UsingDynamicLibraries.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2009 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2009-02-26<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/DeveloperTools/Conceptual/DynamicLibraries/100-Articles/CreatingDynamicLibraries.html%3Fid%3DTP40001869-1.6&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/DeveloperTools/Conceptual/DynamicLibraries/100-Articles/CreatingDynamicLibraries.html%3Fid%3DTP40001869-1.6&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/DeveloperTools/Conceptual/DynamicLibraries/100-Articles/CreatingDynamicLibraries.html%3Fid%3DTP40001869-1.6&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>
