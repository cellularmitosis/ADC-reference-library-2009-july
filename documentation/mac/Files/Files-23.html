<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>Opening a File (IM: F)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING23></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="Files-22.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Files-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Files-390.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Files-24.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Files-2.html"><B>Files</B></A> / <BR><DD><A HREF="Files-12.html"><B>Chapter 1 - Introduction to File Management</B></A> / <A HREF="Files-19.html"><B>Using Files</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING23-0></A>
<H2>Opening a File</H2>
 <A NAME=MARKER-9-198></A><A NAME=MARKER-9-88></A>Your application might need to open a file in several different situations. For example, if the user launches your application by double-clicking one of its document icons in the Finder, the Finder provides your application with information about the selected file (if your application receives high-level events, the Finder sends it an Open Documents event). At that point, you want to create a new window for the document and read the document data from the file into the window.<P>
 <A NAME=MARKER-2-139></A>Your application also opens files after the user chooses the Open command in the File menu. In this case, you need to determine which file to open. You can use the Standard File Package to present a standard dialog box that allows the user to navigate the file system hierarchy (if necessary) and select a file of the appropriate type. Once you get the necessary information from the Standard File Package, you can then create a new window for the document and read the document data from the file into the window.<A NAME=MARKER-2-245></A><P>
 As you can see, it makes sense to divide the process of opening a document into several different routines. You can have a routine that elicits a file selection from the user and another routine that creates a window and reads the file data into it. In the sample listings given here, the function <CODE>DoOpenCmd</CODE> handles the interaction with the user and <CODE>DoOpenFile</CODE> reads a file into a new window.<P>
 <A HREF=Files-23.html#MARKER-9-87>Listing 1-6</A> shows one way to handle the Open command in the File menu. It uses the Standard File Package routine <CODE>StandardGetFile</CODE> to determine which file the user wants to open.<P>
<B>Listing 1-6  <A NAME=MARKER-9-87></A>Handling the Open menu command</B><P>
<PRE>
FUNCTION DoOpenCmd: OSErr;
VAR
   myReply:    StandardFileReply;   {Standard File reply record}
   myTypes:    SFTypeList;          {types of files to display}
   myErr:      OSErr;
BEGIN
   myErr := noErr;
   myTypes[0] := 'TEXT';            {display text files only}
   StandardGetFile(NIL, 1, myTypes, myReply);
   IF myReply.sfGood THEN
      myErr := DoOpenFile(myReply.sfFile)
   ELSE
      myErr := usrCanceledErr;
   DoOpenCmd := myErr;
END;
</PRE>
 The <CODE>StandardGetFile</CODE> procedure requires a list of file types to display in an Open dialog box, as in <A HREF=Files-304.html#MARKER-9-13>Figure 1-7</A>. In this case, only text files are to be listed.<P>
<B>Figure 1-7  <A NAME=MARKER-9-13></A>The default Open dialog box</B><P>
<IMG ALIGN = BOTTOM SRC = "graphics/Default_Open.jpg"> <p>
 The user can scroll through the list of files in the current directory, change the current directory, select a file to open, or cancel the operation altogether. When the user clicks either the Cancel or the Open button, <CODE>StandardGetFile</CODE> fills out the Standard File reply record you pass to it, which has this structure:<P>
<PRE>
TYPE StandardFileReply =
   RECORD
      sfGood:        Boolean;    {TRUE if user did not cancel}
      sfReplacing:   Boolean;    {TRUE if replacing file with same name}
      sfType:        OSType;     {file type}
      sfFile:        FSSpec;     {selected item}
      sfScript:      ScriptCode; {script of selected item's name}
      sfFlags:       Integer;    {Finder flags of selected item}
      sfIsFolder:    Boolean;    {selected item is a folder}
      sfIsVolume:    Boolean;    {selected item is a volume}
      sfReserved1:   LongInt;    {reserved}
      sfReserved2:   Integer;    {reserved}
   END;
</PRE>
 In this situation, the relevant fields of the reply record are the <CODE>sfGood</CODE> and <CODE>sfFile</CODE> fields. If the user selects a file to open, the <CODE>sfGood</CODE> field is set to <CODE>TRUE</CODE> and the <CODE>sfFile</CODE> field contains an <CODE>FSSpec</CODE> record for the selected file. In <A HREF=Files-307.html#MARKER-9-87>Listing 1-6</A>, the returned <CODE>FSSpec</CODE> record is passed directly to the application-defined function <CODE>DoOpenFile</CODE>. <A HREF=#MARKER-9-143>Listing 1-7</A> illustrates a way to define the <CODE>DoOpenFile</CODE> function.<P>
<B>Listing 1-7  <A NAME=MARKER-9-143></A>Opening a file</B><P>
<PRE>
FUNCTION DoOpenFile (mySpec: FSSpec): OSErr;
VAR
   myWindow:      WindowPtr;           {window for file data}
   myData:        MyDocRecHnd;         {handle to window data}
   myFileRefNum:  Integer;             {file reference number}
   myErr:         OSErr;
BEGIN
   {Create a new window, but don't show it yet.}
   myErr := DoNewDocWindow(FALSE, myWindow);
   IF (myErr &lt;&gt; noErr) OR (myWindow = NIL) THEN
      BEGIN
         DoOpenFile := myErr;
         Exit(DoOpenFile);
      END;

   SetWTitle(myWindow, mySpec.name);   {set window's title}
   MySetWindowPosition(myWindow);      {set window position}
   {Open the file's data fork for reading and writing.}
   myErr := FSpOpenDF(mySpec, fsRdWrPerm, myFileRefNum);
   IF myErr &lt;&gt; noErr THEN
      BEGIN
         DisposeWindow(myWindow);
         DoOpenFile := myErr;
         Exit(DoOpenFile);
      END;

   {Retrieve handle to window's data record.}
   myData := MyDocRecHnd(GetWRefCon(myWindow));
   myData^^.fileRefNum := myFileRefNum;{save file information}
   myData^^.fileFSSpec := mySpec;

   myErr := DoReadFile(myWindow);      {read in file data}
   ShowWindow(myWindow);               {now show the window}
   DoOpenFile := myErr;
END;
</PRE>
 This function is relatively simple because much of the real work is done by the two functions DoNewDocWindow and <CODE>DoReadFile</CODE>. The <CODE>DoReadFile</CODE> function is responsible for actually reading the file data from the disk into the TextEdit record associated with the document window. See the next section, <A HREF=Files-24.html#MARKER-9-152>"Reading File Data,"</A> for a sample definition of <CODE>DoReadFile</CODE>.<P>
 In <A HREF=#MARKER-9-143>Listing 1-7</A>, the key step is the call to <CODE>FSpOpenDF</CODE>, which opens the data fork of the specified file. A file reference number--which indicates an <B>access path</B> to the open file--is returned in the third parameter. As you can see, this reference number is saved in the document record, from where it can easily be retrieved for future calls to the <CODE>FSRead</CODE> and <CODE>FSWrite</CODE> functions.<A NAME=MARKER-2-144></A><P>
 The second parameter in a call to the <CODE>FSpOpenDF</CODE> function specifies the <B>access mode</B> for opening the file. For each file, the File Manager maintains access mode information that determines what type of access is available. Most applications support one of two types of access:<A NAME=MARKER-2-145></A><A NAME=MARKER-2-146></A><A NAME=MARKER-9-382></A><P>
<UL>
<LI>A single user is allowed to read from and write to a file.
<LI>Multiple users are allowed to read from a file, but no one can write to it.<P>
</UL>
 Your application can use the following constants to specify these types of access:<P>
<PRE>
CONST
   fsCurPerm      =  0;    {whatever permission is allowed}
   fsRdPerm       =  1;    {read permission}
   fsWrPerm       =  2;    {write permission}
   fsRdWrPerm     =  3;    {exclusive read/write permission}
   fsRdWrShPerm   =  4;    {shared read/write permission}
</PRE>
 To open a file with exclusive read/write access, you can specify <CODE>fsRdWrPerm</CODE>. To open a file with read-only access, specify <CODE>fsRdPerm</CODE>. If you want to open a file and don't know or care which type of access is available, specify <CODE>fsCurPerm</CODE>. When you specify <CODE>fsCurPerm</CODE>, if no access paths are already open, the file is opened with exclusive read/write access. If other access paths are already open, but they are read-only, another read-only path is opened.<A NAME=MARKER-2-246></A><A NAME=MARKER-2-149></A><A NAME=MARKER-2-409></A><A NAME=MARKER-2-383></A><P>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="Files-22.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Files-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Files-390.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Files-24.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Files-3.html">&copy; Apple Computer, Inc.</A><br>2 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
