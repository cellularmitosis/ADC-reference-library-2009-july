<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-05-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1157: Don't println to a Socket</title>    <meta name="keywords" content="Mac OS 8 Java MRJ deadlock client server socket println">    <meta name="Description" content="Technical Note TN1157: This Technical Note
for jdk 1.1.x on Mac OS Classic describes a common
cause of deadlocks in client-server Java applications when
running on a Mac OS. This problem stems from improper use
of the println method when writing to an OutputStream connected
to a socket. A solution to this problem is also provided."><meta name="categories" content="Java"><meta name="week-posted" content="Feb 1, 1999 - Feb 5, 1999"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002996" title="Don't println to a Socket"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxJava-date.html">Java</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/Java/idxPorting-date.html" target="_blank">Java > Porting</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1157</div>
<div id="pageheadsub">Don't println to a Socket</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=500><TR><td align="left">   <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">     <tr><td width=300 valign="top" align=left scope="row">    <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>            <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>  </tr>  <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left> <span id="menutitle">CONTENTS   <br>  <br> </span>   </td>  </tr>  <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left> <!-- begin_toc --><P id = "menutext"><A HREF = "#Section1">Does This Ring a Bell?</A><BR>         <BR>         <A HREF = "#Section2"><CODE>println</CODE> Considered Harmful</A><BR>         <BR>         <A HREF = "#Section3">The Easy Fix</A><BR>         <BR><A HREF="#Downloads">Downloadables</A></p>       <!-- end_toc --></td>  </tr>  <tr>   <td width=300 align=left scope="row"> <img src="images/tnmenubottom.gif" alt="" width=300 height=16>   </td>  </tr>    </table></td>  <td width=300 valign="top" align=left>            <!-- begin_intro_text -->         <P id = "introtext">A common cause of         deadlocks in client-server Java applications when running on         Mac OS stems from improper use of the <CODE>println</CODE>         method when writing to an <CODE>OutputStream</CODE> connected to a         Socket. Here's why, and what you can do about it.</p>        <!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Mar 1 1999]</h3><!-- end_date --></TD> </TR>    </TABLE> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR>      <!-- begin_content -->               <P><A NAME=Section1></A></P>                  <H2>Does This Ring A Bell?</H2>                  <P>You've written a networked client application or applet         that communicates with a server using either a standard         Internet protocol like HTTP or FTP, or a custom protocol         that uses a similar line-oriented syntax. Your application         works fine on Windows and Unix, but when you run it on a Mac,         the client gets stuck when it tries to receive a response         from the server. If you check the server, you find that the         thread communicating with your app is similarly blocked         reading a command from the client.</P>                  <P>Chances are you've just run into a little-known Java         networking gotcha (we've seen many reports of this from         developers.) The bad news is that it's a bug in your app,         not in MRJ. The good news is that it's easy to work         around.</P><P><A HREF = "#top">Back to top</A></P>         <H2><A NAME=Section2></A>println         Considered Harmful</H2>                  <P>The underlying problem is a confusion between different         line-breaking conventions. Line-based Internet protocols         almost universally use CRLF as a line break -- that is, an         ASCII carriage return (<CODE>'\r'</CODE> or hex <CODE>0D</CODE>)         followed by a linefeed (<CODE>'\n'</CODE> or hex <CODE>0A</CODE>).         If you're using Java's excellent stream classes to send         commands using such a protocol, the temptation is to use a         <CODE>PrintStream</CODE> or <CODE>PrintWriter</CODE> object and call its         <CODE>println</CODE> method to send commands, since         <CODE>println</CODE> sends a line break. Right?</P>                  <P>The problem is that <CODE>println</CODE> was designed for use with         file streams, and the line break it appends is <I>the local         platform's line break</I>. On Windows this is a CRLF, on         Unix it's an LF, and on Mac OS it's a CR. (The exact line         break string is read from the system <CODE>line.separator</CODE>         property.) This is clearly the right thing to do when         writing to a local file, but it can cause problems when         communicating with a server.</P>                  <P>Here's what happens: Your client calls</P>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>out.println("HELO foo@bar.com");</pre></TD></TR></TABLE></CENTER><BR><BR>                  <P>When running in MRJ, this sends the bytes:</P>                         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>HELO foo@bar.com\r</pre></TD></TR></TABLE></CENTER><BR><BR>                               <P>The server receives the text and the CR, then expects a         LF to follow the CR and waits to receive one. Actually, most         servers are smart enough that if the character received         following the CR is <I>not</I> an LF, they'll understand the         nonstandard line break and treat the second character as the         start of the next line. But in any case, the server         typically waits for the second character before processing         the command.</P>                  <P>Meanwhile, the client waits to receive a response line         from the server before sending any more text. Both sides are         blocked in <CODE>InputStream.read</CODE> calls ... a classic         case of deadlock.</P>     <P><A HREF = "#top">Back to top</A></P>         <H2><A NAME=Section3></A>The Easy         Fix</H2>                  <P>The lesson here is not to use <CODE>println</CODE> when you need to         generate a specific line break sequence. Instead, do it         yourself. The above example should correctly have read:</P>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>out.print("HELO foo@bar.com\r\n");</pre></TD></TR></TABLE></CENTER><BR><BR>                  <P>This is pretty simple, but unfortunately requires         changing all of the <CODE>println</CODE> calls in your code.</P>                  <H3>The really nice fix that won't work</H3>                  <P>There's a really nice fix that is, unfortunately, not         possible. If you look at the source to the         <CODE>java.awt.PrintStream</CODE> and         <CODE>java.awt.PrintWriter</CODE> classes, you'll note that they         use a <CODE>newLine</CODE> method to send the actual line break.         It would be very elegant to make your own subclass of         <CODE>PrintStream</CODE> or <CODE>PrintWriter</CODE> that overrode <CODE>newLine</CODE> to         send an explicit CRLF. Unfortunately, due to a bit of         misdesign, the <CODE>newLine</CODE> method was made private, not         protected, so it's impossible to override. Oh well.</P>                  <H3>Fixing the server</H3>                  <P>If you happen to be developing the server as well, and can         make changes to its code, then there's an even better fix         you can make on the server side instead of changing the         client. In the previous section, I described how the server         blocks waiting for a character to follow the CR so it can         tell whether it's an LF or not. A more intelligent way to         handle nonstandard line breaks is for the server to process         the input line immediately once it receives the CR, but to         set a flag that indicates that if the next character         received is an LF it should be ignored.</P>                  <P>This way the server will not block after it receives the         CR, will process the command and return a response, and the         client code will receive the response and continue running.         No deadlock.</P><BR><p><A HREF = "#top">Back to top</a></p><A NAME="Downloads"></A> <h2>Downloadables</h2><center><TABLE BORDER=0 CELLPADDING=3 WIDTH="600"> <TR> <td width=50 align=left>   <P ALIGN=center><img src="images/acrobatsmall.gif" align=middle alt="Acrobat" width=22 height=23></P></TD><td align="left">   <p>Acrobat version of this Note (40K).</P></TD><td width=60 align=left>   <p><A HREF="pdf/tn1157.pdf">Download</A></P></TD>  </TR> </table></center><BR><p><a href="#top">Back to top</a></p></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1157.html%3Fid%3DDTS10002996-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1157.html%3Fid%3DDTS10002996-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1157.html%3Fid%3DDTS10002996-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>