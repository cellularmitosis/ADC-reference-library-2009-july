<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>qtstreaming.win - /IMAAudioRTP/RTPMPIMAAudio/Sources/IMAAudioQueue.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/QuickTime/index.html">QuickTime</a> &gt; <a href="../../samplecode/QuickTime/idxStreaming-date.html">Streaming</a> &gt; <A HREF="javascript:location.replace('index.html');">qtstreaming.win</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">qtstreaming.win</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/IMAAudioRTP/RTPMPIMAAudio/Sources/IMAAudioQueue.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/ComponentVideoRTP/RTPMPComponentVideo/Headers/ComponentVideoPayload.h</option>
<option value="listing2.html">/ComponentVideoRTP/RTPMPComponentVideo/Headers/ComponentVideoRTP.h</option>
<option value="listing3.html">/ComponentVideoRTP/RTPMPComponentVideo/Headers/ComponentVideoRTPResources.h</option>
<option value="listing4.html">/ComponentVideoRTP/RTPMPComponentVideo/Headers/RTPDefines.h</option>
<option value="listing5.html">/ComponentVideoRTP/RTPMPComponentVideo/Headers/RTPMPComponentVideo.h</option>
<option value="listing6.html">/ComponentVideoRTP/RTPMPComponentVideo/Headers/RTPMPComponentVideoDispatch.h</option>
<option value="listing7.html">/ComponentVideoRTP/RTPMPComponentVideo/Headers/RTPMPComponentVideoResources.h</option>
<option value="listing8.html">/ComponentVideoRTP/RTPMPComponentVideo/Sources/ComponentThing.r</option>
<option value="listing9.html">/ComponentVideoRTP/RTPMPComponentVideo/Sources/ComponentVideoPayload.c</option>
<option value="listing10.html">/ComponentVideoRTP/RTPMPComponentVideo/Sources/RTPMPComponentVideo.c</option>
<option value="listing11.html">/ComponentVideoRTP/RTPMPComponentVideo/Sources/RTPMPComponentVideo.r</option>
<option value="listing12.html">/ComponentVideoRTP/RTPRssmComponentVideo/Headers/ComponentVideoPayload.h</option>
<option value="listing13.html">/ComponentVideoRTP/RTPRssmComponentVideo/Headers/ComponentVideoRTP.h</option>
<option value="listing14.html">/ComponentVideoRTP/RTPRssmComponentVideo/Headers/ComponentVideoRTPResources.h</option>
<option value="listing15.html">/ComponentVideoRTP/RTPRssmComponentVideo/Headers/RTPDefines.h</option>
<option value="listing16.html">/ComponentVideoRTP/RTPRssmComponentVideo/Headers/RTPRssmComponentVideo.h</option>
<option value="listing17.html">/ComponentVideoRTP/RTPRssmComponentVideo/Headers/RTPRssmComponentVideoDispatch.h</option>
<option value="listing18.html">/ComponentVideoRTP/RTPRssmComponentVideo/Headers/RTPRssmComponentVidResources.h</option>
<option value="listing19.html">/ComponentVideoRTP/RTPRssmComponentVideo/Sources/ComponentThing.r</option>
<option value="listing20.html">/ComponentVideoRTP/RTPRssmComponentVideo/Sources/ComponentVideoPayload.c</option>
<option value="listing21.html">/ComponentVideoRTP/RTPRssmComponentVideo/Sources/RTPRssmComponentVideo.c</option>
<option value="listing22.html">/ComponentVideoRTP/RTPRssmComponentVideo/Sources/RTPRssmComponentVideo.r</option>
<option value="listing23.html">/IMAAudioRTP/RTPMPIMAAudio/Headers/IMAAudioPayload.h</option>
<option value="listing24.html">/IMAAudioRTP/RTPMPIMAAudio/Headers/IMAAudioQueue.h</option>
<option value="listing25.html">/IMAAudioRTP/RTPMPIMAAudio/Headers/IMAAudioRTP.h</option>
<option value="listing26.html">/IMAAudioRTP/RTPMPIMAAudio/Headers/IMAAudioRTPResources.h</option>
<option value="listing27.html">/IMAAudioRTP/RTPMPIMAAudio/Headers/RTPDefines.h</option>
<option value="listing28.html">/IMAAudioRTP/RTPMPIMAAudio/Headers/RTPMPIMAAudio.h</option>
<option value="listing29.html">/IMAAudioRTP/RTPMPIMAAudio/Headers/RTPMPIMAAudioDispatch.h</option>
<option value="listing30.html">/IMAAudioRTP/RTPMPIMAAudio/Headers/RTPMPIMAAudioResources.h</option>
<option value="listing31.html">/IMAAudioRTP/RTPMPIMAAudio/Headers/TCycle.h</option>
<option value="listing32.html">/IMAAudioRTP/RTPMPIMAAudio/Headers/TQueue.h</option>
<option value="listing33.html">/IMAAudioRTP/RTPMPIMAAudio/Sources/ComponentThing.r</option>
<option value="listing34.html">/IMAAudioRTP/RTPMPIMAAudio/Sources/IMAAudioPayload.c</option>
<option value="listing35.html">/IMAAudioRTP/RTPMPIMAAudio/Sources/IMAAudioQueue.c</option>
<option value="listing36.html">/IMAAudioRTP/RTPMPIMAAudio/Sources/RTPMPIMAAudio.c</option>
<option value="listing37.html">/IMAAudioRTP/RTPMPIMAAudio/Sources/RTPMPIMAAudio.r</option>
<option value="listing38.html">/IMAAudioRTP/RTPMPIMAAudio/Sources/TCycle.c</option>
<option value="listing39.html">/IMAAudioRTP/RTPMPIMAAudio/Sources/TQueue.c</option>
<option value="listing40.html">/IMAAudioRTP/RTPRssmIMAAudio/Headers/IMAAudioPayload.h</option>
<option value="listing41.html">/IMAAudioRTP/RTPRssmIMAAudio/Headers/IMAAudioRTP.h</option>
<option value="listing42.html">/IMAAudioRTP/RTPRssmIMAAudio/Headers/IMAAudioRTPResources.h</option>
<option value="listing43.html">/IMAAudioRTP/RTPRssmIMAAudio/Headers/RTPDefines.h</option>
<option value="listing44.html">/IMAAudioRTP/RTPRssmIMAAudio/Headers/RTPRssmIMAAudio.h</option>
<option value="listing45.html">/IMAAudioRTP/RTPRssmIMAAudio/Headers/RTPRssmIMAAudioDispatch.h</option>
<option value="listing46.html">/IMAAudioRTP/RTPRssmIMAAudio/Headers/RTPRssmIMAAudioResources.h</option>
<option value="listing47.html">/IMAAudioRTP/RTPRssmIMAAudio/Sources/ComponentThing.r</option>
<option value="listing48.html">/IMAAudioRTP/RTPRssmIMAAudio/Sources/IMAAudioPayload.c</option>
<option value="listing49.html">/IMAAudioRTP/RTPRssmIMAAudio/Sources/RTPRssmIMAAudio.c</option>
<option value="listing50.html">/IMAAudioRTP/RTPRssmIMAAudio/Sources/RTPRssmIMAAudio.r</option>
<option value="listing51.html">/Readme.txt</option></select>
				</p>
				</form>
				<p><strong><a href="qtstreaming.win.zip">Download Sample</a></strong> (&#147;qtstreaming.win.zip&#148;, 323.7K)<BR>
<strong><a href="qtstreaming.win.dmg">Download Sample</a></strong> (&#147;qtstreaming.win.dmg&#148;, 629.7K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*
  File:    IMAAudioQueue.c

  Contains:  Definition of operations for IMAAudioQueue, a queue datatype
        for IMA audio sample data.

  Copyright:  &copy; 1997-1999 by Apple Computer, Inc., all rights reserved.

*/



#include &quot;IMAAudioQueue.h&quot;
#include &quot;IMAAudioPayload.h&quot;
#include &lt;Math64.h&gt;



static
RTPMPSampleDataParams **
__CopySampleDataParams(
  const RTPMPSampleDataParams *  inSampleDataParams )
{
  RTPMPSampleDataParams **  theResult;
  
  
  theResult =
    REINTERPRET_CAST( RTPMPSampleDataParams ** )(
      NewHandle( sizeof( *inSampleDataParams ) ) );
  
  **theResult = *inSampleDataParams;
  
  return( theResult );
}



static
RTPMPSampleDataParams *
__LockSampleDataParams(
  RTPMPSampleDataParams **  inSampleDataParams )
{
  Handle  theHandle = REINTERPRET_CAST( Handle )( inSampleDataParams );
  
  
  if( HandleZone( theHandle ) == SystemZone() )
    HLock( theHandle );
  else
    HLockHi( theHandle );
  
  return( *inSampleDataParams );
}



static
void
__DisposeSampleDataParams(
  RTPMPSampleDataParams **  inSampleDataParams )
{
  DisposeHandle( REINTERPRET_CAST( Handle )( inSampleDataParams ) );
}



static
UInt64
__ConsumedDuration(
  IMAAudioQueue *    inQueue,
  UInt32        inChannel )
{
  UInt32  theFrameCount;
  UInt64  theSampleCount;
  UInt64  theResult;
  
  
  theFrameCount =
    ( inQueue-&gt;__itsConsumedFrameCount + inQueue-&gt;__itsChannelCount - inChannel - 1 ) /
      inQueue-&gt;__itsChannelCount;
  
  theSampleCount =
    U64Multiply(
      U64SetU( theFrameCount ), U64SetU( kIMAAudioPayloadFrameSampleCount ) );
  
  theResult =
    S64Div(
      U64Multiply(
        theSampleCount,
        U64SetU( STATIC_CAST( UInt32 )( kIMAAudioPayloadRTPTimeScale ) &lt;&lt; 16 ) ),
      S64SetU( inQueue-&gt;__itsIncomingSampleRate ) );
  
  return( theResult );
}



static
UInt64
__DequeuedDuration(
  IMAAudioQueue *    inQueue,
  UInt32        inChannel )
{
  UInt32  theFrameCount;
  UInt64  theSampleCount;
  UInt64  theResult;
  
  
  theFrameCount =
    ( inQueue-&gt;__itsDequeuedFrameCount + inQueue-&gt;__itsChannelCount - inChannel - 1 ) /
      inQueue-&gt;__itsChannelCount;
  
  theSampleCount =
    U64Multiply(
      U64SetU( inQueue-&gt;__itsDequeuedFrameCount / inQueue-&gt;__itsChannelCount ),
      U64SetU( kIMAAudioPayloadFrameSampleCount ) );
  
  theResult =
    S64Div(
      U64Multiply(
        theSampleCount,
        U64SetU( STATIC_CAST( UInt32 )( kIMAAudioPayloadRTPTimeScale ) &lt;&lt; 16 ) ),
      S64SetU( inQueue-&gt;__itsOutgoingSampleRate ) );
  
  return( theResult );
}



static
void
__GetNextFrame(
  IMAAudioQueue *      inQueue,
  IMAAudioQueueElement *  outElement )
{
  RTPMPSampleDataParams **  theSampleDataParams;
  
  
  theSampleDataParams =
    STATIC_CAST( RTPMPSampleDataParams ** )( QueueHead( &amp;inQueue-&gt;__itsQueue ) );
  
  if( inQueue-&gt;__itsCurrentOffset &gt;= ( **theSampleDataParams ).dataLength )
  {
    inQueue-&gt;__itsCurrentOffset = 0;
    
    QueueDequeue( &amp;inQueue-&gt;__itsQueue );
    __DisposeSampleDataParams( theSampleDataParams );
    
    theSampleDataParams =
      STATIC_CAST( RTPMPSampleDataParams ** )( QueueHead( &amp;inQueue-&gt;__itsQueue ) );
  }
  
  if( inQueue-&gt;__itsCurrentOffset == 0 )
    __LockSampleDataParams( theSampleDataParams );
  
  outElement-&gt;itsChannel = inQueue-&gt;__itsConsumedFrameCount % inQueue-&gt;__itsChannelCount;
  
  outElement-&gt;itsTimestamp =
    S64Add(
      inQueue-&gt;__itsStartTime,
      __DequeuedDuration( inQueue, outElement-&gt;itsChannel ) );
  
  outElement-&gt;itsSampleDataParams = *theSampleDataParams;
  outElement-&gt;itsOffset = inQueue-&gt;__itsCurrentOffset;
  
  inQueue-&gt;__itsCurrentOffset += sizeof( IMAAudioFrame );
  --inQueue-&gt;__itsFrameCount;
  inQueue-&gt;__itsConsumedFrameCount++;
}



static
void
__Reset(
  IMAAudioQueue *    inQueue )
{
  QueueInitialize( &amp;inQueue-&gt;__itsQueue );
  inQueue-&gt;__itsStartTime = S64SetU( 0 );
  inQueue-&gt;__itsFrameCount = 0;
  inQueue-&gt;__itsCurrentOffset = 0;
  inQueue-&gt;__itsConsumedFrameCount = 0;
  inQueue-&gt;__itsDequeuedFrameCount = 0;
}



extern
void
IMAAudioQueueInitialize(
  IMAAudioQueue *    inQueue )
{
  __Reset( inQueue );
  
  IMAAudioQueueSetFlowControl( inQueue, 0, 0, 1 );
}



extern
UnsignedFixed
IMAAudioQueueSetFlowControl(
  IMAAudioQueue *    inQueue,
  UnsignedFixed    inIncomingSampleRate,
  UnsignedFixed    inOutgoingSampleRate,
  UInt16        inChannelCount )
{
  UnsignedFixed  theResult;
  
  
  if( inIncomingSampleRate &gt;= inOutgoingSampleRate )
    theResult = inOutgoingSampleRate;
  else
    theResult = inIncomingSampleRate;
  
  if( inQueue-&gt;__itsFrameCount )
  {
    if(
      inIncomingSampleRate != inQueue-&gt;__itsIncomingSampleRate  ||
      theResult != inQueue-&gt;__itsOutgoingSampleRate )
    {
      IMAAudioQueueFlush( inQueue );
    }
  }
  
  inQueue-&gt;__itsIncomingSampleRate = inIncomingSampleRate;
  inQueue-&gt;__itsOutgoingSampleRate = theResult;
  inQueue-&gt;__itsChannelCount = inChannelCount;
  
  return( theResult );
}



extern
UInt32
IMAAudioQueueCount(
  const IMAAudioQueue *  inQueue )
{
  UInt32  theResult;
  UInt64  theIncomingFrameCount;
  UInt64  theIncomingSampleRate;
  UInt64  theDequeuedFrameCount;
  UInt64  theOutgoingSampleRate;
  UInt64  thePendingTime;
  
  
  if( inQueue-&gt;__itsIncomingSampleRate  &amp;&amp;  inQueue-&gt;__itsFrameCount )
  {
    theIncomingFrameCount =
      U64SetU( inQueue-&gt;__itsConsumedFrameCount + inQueue-&gt;__itsFrameCount );
    
    theIncomingSampleRate = U64SetU( inQueue-&gt;__itsIncomingSampleRate );
    theDequeuedFrameCount = U64SetU( inQueue-&gt;__itsDequeuedFrameCount );
    theOutgoingSampleRate = U64SetU( inQueue-&gt;__itsOutgoingSampleRate );
    
    thePendingTime =
      U64Subtract(
        U64Multiply( theOutgoingSampleRate, theIncomingFrameCount ),
        U64Multiply( theIncomingSampleRate, theDequeuedFrameCount ) );
    
    theResult = U32SetU( U64Div( thePendingTime, theIncomingSampleRate ) );
    
    if( U64Mod( thePendingTime, theIncomingSampleRate ) )
      theResult++;
  }
  
  else
  {
    theResult = 0;
  }
  
  return( theResult );
}



extern
RTPMPSampleDataParams *
IMAAudioQueueEnqueue(
  IMAAudioQueue *          inQueue,
  const RTPMPSampleDataParams *  inSampleDataParams )
{
  RTPMPSampleDataParams *    theResult;
  
  
  theResult =
    ( RTPMPSampleDataParams * ) QueueEnqueue(
      &amp;inQueue-&gt;__itsQueue, __CopySampleDataParams( inSampleDataParams ) );
  
  if( theResult )
  {
    if( inQueue-&gt;__itsFrameCount == 0  &amp;&amp;  inQueue-&gt;__itsConsumedFrameCount == 0 )
      inQueue-&gt;__itsStartTime = inSampleDataParams-&gt;timeStamp;
    
    inQueue-&gt;__itsFrameCount +=
      inSampleDataParams-&gt;dataLength / sizeof( IMAAudioFrame );
  }
  
  return( theResult );
}



extern
Boolean
IMAAudioQueueDequeue(
  IMAAudioQueue *      inQueue,
  IMAAudioQueueElement *  outElement )
{
  Boolean    theResult = false;
  UInt32    theInitialFrameCount = inQueue-&gt;__itsFrameCount;
  
  
  while( inQueue-&gt;__itsFrameCount  &amp;&amp; !theResult )
  {
    __GetNextFrame( inQueue, outElement );
    
    theResult =
      U64Compare(
        __ConsumedDuration( inQueue, outElement-&gt;itsChannel ),
        __DequeuedDuration( inQueue, outElement-&gt;itsChannel ) ) &gt; 0;
  }
  
  if( theInitialFrameCount &gt; inQueue-&gt;__itsFrameCount  &amp;&amp; theResult )
    inQueue-&gt;__itsDequeuedFrameCount++;
  else
    theResult = false;
  
  return( theResult );
}



extern
void
IMAAudioQueueFlush(
  IMAAudioQueue *    inQueue )
{
  UInt32            theCount;
  RTPMPSampleDataParams **  theSampleDataParams;
  
  
  for( theCount = QueueCount( &amp;inQueue-&gt;__itsQueue ); theCount; --theCount )
  {
    theSampleDataParams =
      STATIC_CAST( RTPMPSampleDataParams ** )( QueueDequeue( &amp;inQueue-&gt;__itsQueue ) );
    
    __DisposeSampleDataParams( theSampleDataParams );
  }
  
  __Reset( inQueue );
}
</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/qtstreaming.win/listing35.html%3Fid%3DDTS10001052-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/qtstreaming.win/listing35.html%3Fid%3DDTS10001052-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/qtstreaming.win/listing35.html%3Fid%3DDTS10001052-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>