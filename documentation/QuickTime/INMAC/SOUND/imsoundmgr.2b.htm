<!-- legacy work start --><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"        "http://www.w3.org/TR/html4/loose.dtd"><!-- legacy work end --><HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><TITLE> Writing a Doubleback Procedure (deprecated)</title><!-- legacy work start -->        <META NAME="Generator" CONTENT="manual">        <META http-equiv="content-type" CONTENT="text/html;charset=utf-8">        <META NAME = "Copyright" CONTENT="Copyright 2007 Apple Inc. All Rights Reserved.">        <META NAME="IndexTitle" CONTENT="Sound Input Manager (Not Recommended)">        <meta name="xcode-display" content="render">        <LINK REL="stylesheet" TYPE="text/css" HREF="../../../Resources/CSS/frameset_styles.css"> <!-- before submitting, globally replace ".." with "developer.apple.com" -->        <script type="text/javascript" language="JavaScript" src="../../../Resources/JavaScript/page.js"></script><!-- legacy work end --></HEAD><BODY BGCOLOR="#ffffff"><!-- start of header --><!--#include virtual="/includes/framesetheader" --><!-- end of header --><!-- path goes here --><!-- QTnavbar start --><P><I>Inside Macintosh: Sound</I><P>| <A target="doc" HREF="imsoundmgr.2a.htm">Previous</A> | <A target="doc" HREF="imsoundmgr.1.htm">Chapter contents</A> | <A target="doc" HREF="imsoundmgr.htm">Chapter top</A> | <A target="doc" HREF="imsoundmgr.29.htm">Section top</A> | <A target="doc" HREF="imsoundmgr.2c.htm">Next</a> | <!-- QTnavbar end --><!-- legacy work start --><script type="text/javascript"> placeWatermark()</script><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox" style="position: relative;"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b><i>Sound Input Manager</i> is deprecated as of Mac OS X v10.5. For new audio development in Mac OS X, use Core Audio. See the <a href="http://developer.apple.com/referencelibrary/MusicAudio/" target="_top">Audio</a> page in the ADC Reference Library.</p></div></div></div><!-- legacy work end --><H1 CLASS="H3.Heading3"><A NAME="pgfId=3727"> </A>Writing a Doubleback Procedure<A NAME="marker=808"> </A></H1><P CLASS="T0.Text0"><A NAME="pgfId=3728"> </A><A NAME="marker=810"> </A>The <TT CLASS="cv">dbhDoubleBack</TT> field of a double buffer header specifies the address of a doubleback procedure, an application-defined procedure that is called when the double buffers are switched and the exhausted buffer needs to be refilled. The doubleback procedure should have this format:<A NAME="marker=172"> </A></P><CODE CLASS="Cv.Code"><A NAME="pgfId=10019"> </A>PROCEDURE MyDoubleBackProc (chan: SndChannelPtr; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exhaustedBuffer: SndDoubleBufferPtr);<BR></CODE><P CLASS="T1.Text1"><A NAME="pgfId=3653"> </A>The primary responsibility of the doubleback procedure is to refill an exhausted buffer of&nbsp;samples and to mark the newly filled buffer as ready for processing. <A target="doc" HREF="imsoundmgr.2b.htm#36932" CLASS="XRef">Listing 1-45</A> illustrates how to define a doubleback procedure. Note that the sound channel pointer passed to the doubleback procedure is not used in this procedure.</P><P CLASS="T1.Text1"><A NAME="pgfId=3731"> </A>This doubleback procedure extracts the address of its local variables from the <TT CLASS="cv">dbUserInfo</TT> field of the double buffer record passed to it. These variables are used to keep track of how many total bytes need to be copied and how many bytes have been copied so far. Then the procedure copies at most a bufferfull of bytes into the empty buffer and updates several fields in the double buffer record and in the structure containing the local variables. Finally, if all the bytes to be copied have been copied, the&nbsp;buffer is marked as the last buffer.</P><P CLASS="Note"><A NAME="pgfId=3732"> </A>Because the doubleback procedure is called at interrupt time, it cannot make any calls that move memory either directly or indirectly. (Despite its name, the <TT CLASS="cv">BlockMove</TT> procedure does not cause blocks of memory to move or be purged, so you can safely call it in your doubleback procedure, as illustrated in <A target="doc" HREF="imsoundmgr.2b.htm#36932" CLASS="XRef">Listing 1-45</A>.) <A NAME="marker=1641"> </A><A NAME="marker=1642"> </A> <A NAME="marker=811"> </A></P><P CLASS="L.Listing"><A NAME="pgfId=3686"> </A>Listing&nbsp;45 <A NAME="36932"> </A>Defining a doubleback procedure</P><CODE CLASS="CvF.CodeFull"><A NAME="pgfId=10023"> </A>PROCEDURE MyDoubleBackProc (chan: SndChannelPtr; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doubleBuffer: SndDoubleBufferPtr);<BR>VAR<BR>&nbsp;&nbsp;&nbsp;&nbsp;myVarsPtr:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LocalVarsPtr;<BR>&nbsp;&nbsp;&nbsp;&nbsp;myNumBytes:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LongInt;<BR>BEGIN<BR>&nbsp;&nbsp;&nbsp;&nbsp;{Get pointer to my local variables.}<BR>&nbsp;&nbsp;&nbsp;&nbsp;myVarsPtr := LocalVarsPtr(doubleBuffer^.dbUserInfo[0]);<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;{Get number of bytes left to copy.}<BR>&nbsp;&nbsp;&nbsp;&nbsp;myNumBytes := myVarsPtr^.bytesTotal - myVarsPtr^.bytesCopied;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;{If the amount left is greater than double buffer size, limit the number }<BR>&nbsp;&nbsp;&nbsp;&nbsp;{ of bytes to copy to the size of the buffer.}<BR>&nbsp;&nbsp;&nbsp;&nbsp;IF myNumBytes &gt; kDoubleBufferSize THEN<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;myNumBytes := kDoubleBufferSize;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;{Copy samples to double buffer.}<BR>&nbsp;&nbsp;&nbsp;&nbsp;BlockMove(myVarsPtr^.dataPtr, @doubleBuffer^.dbSoundData[0], myNumBytes);<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;{Store number of samples in buffer and mark buffer as ready.}<BR>&nbsp;&nbsp;&nbsp;&nbsp;doubleBuffer^.dbNumFrames := myNumBytes;<BR>&nbsp;&nbsp;&nbsp;&nbsp;doubleBuffer^.dbFlags := BOR(doubleBuffer^.dbFlags, dbBufferReady);<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;{Update data pointer and number of bytes copied.}<BR>&nbsp;&nbsp;&nbsp;&nbsp;myVarsPtr^.dataPtr := Ptr(ORD4(myVarsPtr^.dataPtr) + myNumBytes);<BR>&nbsp;&nbsp;&nbsp;&nbsp;myVarsPtr^.bytesCopied := myVarsPtr^.bytesCopied + myNumBytes;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;{If all samples have been copied, then this is the last buffer.}<BR>&nbsp;&nbsp;&nbsp;&nbsp;IF myVarsPtr^.bytesCopied = myVarsPtr^.bytesTotal THEN<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doubleBuffer^.dbFlags := BOR(doubleBuffer^.dbFlags, dbLastBuffer);<BR>END;<BR></CODE><hr>&#169; 1999 Apple Computer, Inc.<!-- QTnavbar start --><P><I>Inside Macintosh: Sound</I><P>| <A target="doc" HREF="imsoundmgr.2a.htm">Previous</A> | <A target="doc" HREF="imsoundmgr.1.htm">Chapter contents</A> | <A target="doc" HREF="imsoundmgr.htm">Chapter top</A> | <A target="doc" HREF="imsoundmgr.29.htm">Section top</A> | <A target="doc" HREF="imsoundmgr.2c.htm">Next</a> | <!-- QTnavbar end --><!-- legacy work start --><script type="text/javascript"> placeWatermark()</script><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox" style="position: relative;"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b><i>Sound Input Manager</i> is deprecated as of Mac OS X v10.5. For new audio development in Mac OS X, use Core Audio. See the <a href="http://developer.apple.com/referencelibrary/MusicAudio/" target="_top">Audio</a> page in the ADC Reference Library.</p></div></div></div><!-- legacy work end --></DIV></DIV></DIV></DIV></DIV></DIV></DIV></DIV></DIV></DIV><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></BODY></HTML>