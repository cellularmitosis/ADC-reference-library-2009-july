<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Kernel Extension Programming Topics: Hello I/O Kit: Creating a Device Driver With Xcode</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Hello I/O Kit: Creating a Device Driver With Xcode"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/20002366" title="Hello I/O Kit: Creating a Device Driver With Xcode"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000422" target="_top">Darwin</a> &gt; <a href="../../../Kernel-date.html#//apple_ref/doc/uid/TP30000440-TP30000422-TP30000532" target="_top">Kernel</a> &gt; <a href="../index.html" target="_top">Kernel Extension Programming Topics</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../KEXTConceptKEXT/hello_kext.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../KEXTConceptDebugger/hello_debugger.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>
        
        
        <a name="//apple_ref/doc/uid/20002366-CIHECHHE" title="Hello I/O Kit: Creating a Device Driver With Xcode"></a><hr /><H1>Hello I/O Kit: Creating a Device Driver With Xcode</H1>

<p>This tutorial describes how to write an I/O Kit device driver for Mac OS X. The driver you’ll create is a simple driver that prints text messages, but doesn’t actually control any hardware. The tutorial assumes that you are working in a Mac OS X development environment.</p><div class="importantbox"><a name="//apple_ref/doc/uid/20002366-DontLinkElementID_18" title="Important:"></a><p><strong>Important:</strong>&nbsp;This tutorial does not show you how to build a universal I/O Kit device driver. If you need to do this, you first should work through the tutorial to learn the basics of driver development on Mac OS X. Then, to find out how to configure your Xcode project to build a universal driver, see <span class="content_text"><a href="../../../../../technotes/tn2006/tn2163.html" target="_top">Technical Note TN2163: Building Universal I/O Kit Drivers</a></span>. </p><p>For information on issues related to building a universal device driver, see <span class="content_text"><a href="../../../../DeviceDrivers/Conceptual/WritingDeviceDriver/UBDeviceDriver/UBDeviceDriver.html#//apple_ref/doc/uid/TP40002800" target="_top">Developing a Device Driver to Run on an Intel-Based Macintosh</a></span>; for information on building universal binaries in general, see <em><a href="../../../../MacOSX/Conceptual/universal_binary/index.html#//apple_ref/doc/uid/TP40002217" target="_top">Universal Binary Programming Guidelines, Second Edition</a></em>.</p><p></p></div>

<!-- This template is being used for both PDF and HTML. -->

    
    <!-- TopicBook.pm uses this template for its miniTOCs, but needs a different title. -->
    <h4>Contents:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="hello_iokit.html#//apple_ref/doc/uid/20002366-97636">Anatomy of a Device Driver</a>
				
			<br/>
			
        
			
			
				<a href="hello_iokit.html#//apple_ref/doc/uid/20002366-97908">Roadmap</a>
				
			<br/>
			
        
			
			
				<a href="hello_iokit.html#//apple_ref/doc/uid/20002366-98013-CHDHHFBB">Create an I/O Kit Project using Xcode</a>
				
			<br/>
			
        
			
			
				<a href="hello_iokit.html#//apple_ref/doc/uid/20002366-98200-CHDCHHEF">Create an I/O Kit Extension Project</a>
				
			<br/>
			
        
			
			
				<a href="hello_iokit.html#//apple_ref/doc/uid/20002366-98320-CHDHAEDI">Edit the Driver’s Property List</a>
				
			<br/>
			
        
			
			
				<a href="hello_iokit.html#//apple_ref/doc/uid/20002366-99759-CHDBIAED">Edit the Driver’s Build Settings</a>
				
			<br/>
			
        
			
			
				<a href="hello_iokit.html#//apple_ref/doc/uid/20002366-100120-CHDGHGFJ">Implement the Header File</a>
				
			<br/>
			
        
			
			
				<a href="hello_iokit.html#//apple_ref/doc/uid/20002366-100582-CHDCBEGG">Implement the Driver’s Entry Points</a>
				
			<br/>
			
        
			
			
				<a href="hello_iokit.html#//apple_ref/doc/uid/20002366-101431-CHDJCJCB">Build the Project</a>
				
			<br/>
			
        
			
			
				<a href="hello_iokit.html#//apple_ref/doc/uid/20002366-101567">Fix Any Errors</a>
				
			<br/>
			
        
			
			
				<a href="hello_iokit.html#//apple_ref/doc/uid/20002366-101599-CHDECIDA">Test the Device Driver</a>
				
			<br/>
			
        
			
			
				<a href="hello_iokit.html#//apple_ref/doc/uid/20002366-102251-CIHGGEGI">Load the Driver</a>
				
			<br/>
			
        
			
			
				<a href="hello_iokit.html#//apple_ref/doc/uid/20002366-103105">Using Console Mode</a>
				
			<br/>
			
        
			
			
				<a href="hello_iokit.html#//apple_ref/doc/uid/20002366-103309">Where to Go Next</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/20002366-97636" title="Anatomy of a Device Driver"></a><h2>Anatomy of a Device Driver</h2>
<p>An I/O Kit device driver is a special type of kernel extension (KEXT) that tells the kernel how to handle a particular device or family of devices. In Mac OS X, all kernel extensions are implemented as <em>bundles</em>, folders that the Finder treats as single files. Kernel extensions have names ending in <code>.kext</code>. In addition, all kernel extensions contain the following:</p>
<ul class="ul"><li class="li"><p>A <em>property list </em>(plist)—a text file (in XML, Extensible Markup Language, format) that describes the driver’s contents, settings, and requirements. This is a required file. A KEXT need contain nothing more than a property list file. </p></li>
<li class="li"><p>A <em>KEXT binary </em>—Generally, a KEXT has one binary file, but it can have none (locally). However, if it has none, its property list must reference another KEXT and change its default settings. In this way, one KEXT can override or change the behavior of another KEXT. A KEXT binary is also sometimes called a kernel module.</p></li>
<li class="li"><p>Optional <em>Resources</em>—Resources are useful if your driver needs to display an icon.</p></li></ul>
<p>In addition, a device driver has several special requirements that other KEXTs do not. Specifically:</p>
<ul class="ul"><li class="li"><p>You must create a Personality dictionary for I/O Kit drivers. See <span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-98320">“Edit the Driver’s Property List”</a></span> for details.</p></li>
<li class="li"><p>The I/O Kit provides the initialization and termination routines for drivers; you need not (and should not) specify these routines in your source code or in the driver’s Info.plist Entries.</p></li>
<li class="li"><p>You must create a header file for a driver. See <span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-100120">“Implement the Header File.”</a></span></p></li>
<li class="li"><p>The I/O Kit requires several specific entry points, described in the section, <span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-100582">“Implement the Driver’s Entry Points.”</a></span> These must be included in your driver’s code.</p></li>
<li class="li"><p>The source code for a driver must reference two macros that are defined by I/O Kit and generate runtime type identification information for I/O Kit:</p><ul class="nested"><li class="nested li"><p><code>OSDeclareDefaultStructors</code></p></li>
<li class="nested li"><p><code>OSDefineMetaClassAndStructors</code></p></li></ul><p>If you don’t include these macros in your code, or you include them in the wrong places, your driver will not work properly. See <span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-100120">“Implement the Header File”</a></span> and <span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-100582">“Implement the Driver’s Entry Points”</a></span> for examples of the correct placement of these macros in your code.</p></li>
<li class="li"><p>In Mac OS X, kernel-resident device drivers are written in C++. However, it is possible to wrap plain C code inside a C++ class if you need to use non-object-oriented code from another platform or from Mac OS 9.</p></li></ul>
<a name="//apple_ref/doc/uid/20002366-97908" title="Roadmap"></a><h2>Roadmap</h2>
<p>Here are the steps you’ll follow to create the HelloIOKit device driver:</p>
<ol class="ol"><li class="li"><p><span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-98013">“Create an I/O Kit Project using Xcode”</a></span></p></li>
<li class="li"><p><span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-101431">“Build the Project”</a></span></p></li>
<li class="li"><p><span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-101599">“Test the Device Driver”</a></span></p></li></ol>
<p>You’ll use the Xcode application to create and build your driver. You’ll use the Terminal application to type the commands to load and test your driver and view the results.</p>
<p>If you have not used Xcode much, you may wish to read <em><a href="../../../../DeveloperTools/Conceptual/XcodeQuickTour/index.html#//apple_ref/doc/uid/TP30000890" target="_top">Xcode Quick Tour for Mac OS X</a></em>.</p>
<a name="//apple_ref/doc/uid/20002366-98013" title="Create an I/O Kit Project using Xcode"></a><a name="//apple_ref/doc/uid/20002366-98013-CHDHHFBB" title="Create an I/O Kit Project using Xcode"></a><h2>Create an I/O Kit Project using Xcode</h2>
<p>This section describes how to create the project that will be used in writing your device driver. A project is a document that contains all of your files and targets. Targets are the things you can build from your project’s files. A simple project has just one target that builds an application. A complex project may contain several targets.</p>
<p>The parts of your project can be found later in your Desktop. These parts include the source files, as well as the targets (your KEXT). Xcode does not store these files in any special format, so you can view or edit the source files with another editing program if you wish. For now, however, we recommend using Xcode.</p>
<p>Here’s how you’ll create the device driver project:</p>
<ol class="ol"><li class="li"><p><span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-98200">“Create an I/O Kit Extension Project”</a></span></p></li>
<li class="li"><p><span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-99759">“Edit the Driver’s Build Settings”</a></span></p></li>
<li class="li"><p><span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-98320">“Edit the Driver’s Property List”</a></span></p></li>
<li class="li"><p><span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-100120">“Implement the Header File”</a></span></p></li></ol>
<p>The examples below assume that you will be logging in as an administrator of your machine. The account name in the examples is <code>admin</code>. If you use a different login account, be sure to substitute accordingly. Some of the commands you will be using require <code>root</code> privileges so you will be using the <strong>sudo</strong> command. The <strong>sudo</strong> command allows permitted users (such as an <code>admin</code> user) to execute a given command with <code>root</code> privileges. An admin user is a user who has “Allow user to administer this computer” checked in the Security view of the Accounts system preference. If you use a different login account, make sure it has administrative access.</p>
<a name="//apple_ref/doc/uid/20002366-98200" title="Create an I/O Kit Extension Project"></a><a name="//apple_ref/doc/uid/20002366-98200-CHDCHHEF" title="Create an I/O Kit Extension Project"></a><h2>Create an I/O Kit Extension Project</h2>
<p>Device drivers are created and edited in Xcode, Apple’s Integrated Development Environment (IDE).</p>
<p>From a Desktop Finder window, locate and launch the Xcode application, found at <code>/Developer/Applications/Xcode</code>. If this is the first time Xcode has been run, you’ll see the new user Assistant. The Assistant asks you to make some decisions about your environment. For now, choose the defaults.</p>
<p>When you have finished with the Assistant, choose New Project from the File menu. In the New Project Assistant, scroll down to the Kernel Extension section and choose IOKit Driver. Click Next. </p>
<p>For the Project Name, enter “HelloIOKit”. The default location is your home directory; however, if you create many projects, you should make a directory to hold them. Edit the Location to specify a “Projects” subdirectory, for example:</p>
<div class="codesample"><table><tr><td scope="row"><pre>/Users/admin/Projects<span></span></pre></td></tr></table></div>
<p>When you click Finish, Xcode creates the new project and displays its project window, as shown in <span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-110713-CIHDCDCE">Figure 1</a></span>. Notice that the new project contains several files already, including two source files — <code>HelloIOKit.h</code> and <code>HelloIOKit.cpp</code>.</p>
<br/><div><a name="//apple_ref/doc/uid/20002366-110713-CIHDCDCE" title="Figure 1The new HelloIOKit driver project in Xcode"></a><p><a name="//apple_ref/doc/uid/20002366-110713" title="Figure 1The new HelloIOKit driver project in Xcode"></a><strong>Figure 1&nbsp;&nbsp;</strong>The new HelloIOKit driver project in Xcode</p><img src = "../art/hello_iokit_project.jpg" alt = "" ></div><br/>
<a name="//apple_ref/doc/uid/20002366-98320" title="Edit the Driver&acirc;&#128;&#153;s Property List"></a><a name="//apple_ref/doc/uid/20002366-98320-CHDHAEDI" title="Edit the Driver&acirc;&#128;&#153;s Property List"></a><h2>Edit the Driver’s Property List</h2>
<p>Your kernel extension contains a property list, or <em>plist</em>, which tells the operating system what your KEXT contains and what it needs. If viewed from a text editor, the property list would be in XML format. However, you will be viewing and editing the plist information from within Xcode, so you don’t need to worry about the underlying format.</p>
<p>Each element of a property list has a name, or <em>key</em>, a Class type (for example, String, Number, <em>Dictionary</em>, and so forth), and a value. A Dictionary is a collection of zero or more objects, each of which is associated with a name. Objects may be added, removed, or located in a Dictionary by their name.</p>
<p>By default, Xcode allows you to edit your driver’s property list as plain XML text in the Xcode editor window. However, it’s easier to view and edit the property list file with the Property List Editor application. You can tell Xcode to open property list files using Property List Editor by following these steps:</p>
<ol class="ol"><li class="li"><p>Choose Xcode > Preferences and click the File Types icon. The File Types pane lists all the folder and file types that Xcode handles and the preferred editor for each type.</p></li>
<li class="li"><p>Click the disclosure triangle for file. Then click the disclosure triangle for text.</p></li>
<li class="li"><p>Select text.xml and click Default (Plain Text File) in the Preferred Editor column.</p></li>
<li class="li"><p>Choose External Editor and select Other from the menu that appears.</p></li>
<li class="li"><p>Select Property List Editor in <code>/Developer/Applications/Utilities/Property List Editor</code> and click OK.</p></li>
<li class="li"><p>Now Xcode lists External Editor (Currently Property List Editor) in the Preferred Editor column for text.xml. Click OK to close the Xcode Preferences window.</p></li></ol>
<p>Now you can edit your driver’s <code>Info.plist</code> file using Property List Editor:</p>
<ol class="ol"><li class="li"><p>Select HelloIOKit in the Groups &amp; Files view. Double-click Info.plist in the Xcode project window. Xcode starts Property List Editor, which displays the <code>Info.plist</code> file. (If Property List Editor displays a second editing window named Untitled, dismiss it by clicking the red close button in the upper left.)</p></li>
<li class="li"><p>In Property List Editor, click the disclosure triangle next to Root. You should see the elements of the property list file, as shown in <span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-105609-CHDBBEEJ">Figure 2</a></span>.</p><div class="item_figure"><a name="//apple_ref/doc/uid/20002366-105609-CHDBBEEJ" title="Figure 2Info.plist entries"></a><p><a name="//apple_ref/doc/uid/20002366-105609" title="Figure 2Info.plist entries"></a><strong>Figure 2&nbsp;&nbsp;</strong>Info.plist entries</p><img src = "../art/hello_iokit_expert.jpg" alt = "" ></div></li>
<li class="li"><p>Change the value of the <code>CFBundleIdentifier</code> property from the default chosen by Xcode.</p><p>Apple has adopted a “reverse-DNS” naming convention to avoid namespace collisions. This is important because all kernel extensions share a single “flat” namespace.</p><p>By default, Xcode names a new I/O Kit driver <code>com.yourcompany.driver.</code><em>&lt;projname></em>, where <em>&lt;projname></em> is the name you chose for your project. You should replace the first two parts of this name with your actual reverse-DNS prefix (for example: <code>com.apple</code>, <code>ecu.ucsd</code>, and so forth). For this tutorial, you will use the prefix <code>com.MyTutorial</code>.</p><p>On the line for <code>CFBundleIdentifier</code>, double-click on <code>com.yourcompany.driver.HelloIOKit</code> in the Value field. Double-click on <code>yourcompany</code> and change this string to <code>MyTutorial</code>.</p></li>
<li class="li"><p>The <code>CFBundleVersion</code> property contains the version number of your driver in the <code>‘vers’</code> resource style (for more information on this, see <span class="content_text"><a href="../../../../../documentation/mac/Toolbox/Toolbox-454.html" target="_top">http://developer.apple.com/documentation/mac/Toolbox/Toolbox-454.html</a></span> and <span class="content_text"><a href="../../../../../technotes/tn/tn1132.html" target="_top">Technical Note TN1132</a></span>).</p><p>By default, Xcode assigns new kernel extensions the version number <code>1.0.0d1</code>. You can change this value if you wish, but your driver must declare <em>some</em> version in the <code>‘vers’</code> resource style to be loaded successfully.</p><p>For this tutorial, leave the <code>CFBundleVersion</code> property set to the default value <code>1.0.0d1</code>.</p></li>
<li class="li"><p>Darwin/Mac OS X requires every KEXT to declare its dependencies on other loadable extensions or in-kernel components in the <code>OSBundleLibraries</code> dictionary at the top level of its plist. Because every KEXT is linked against the kernel, every KEXT must at least declare its dependence on the kernel itself. However, it is often better to declare dependence on specific kernel subcomponents rather than on the kernel as a whole. For more information on dependencies and to find out how to determine the dependencies of other KEXTs you may write, see <span class="content_text"><a href="../KEXTConceptDependencies/kext_dependencies.html#//apple_ref/doc/uid/20002370-BABFGHCJ">“Kernel Extension Dependencies.”</a></span> For this tutorial, you will add three elements to the <code>OSBundleLibraries</code> dictionary to declare your driver’s dependence on the kernel subcomponents <code>com.apple.kernel.iokit</code>, <code>com.apple.kernel.libkern</code>, and <code>com.apple.kernel.mach</code>.</p><p>Click on the line for <code>OSBundleLibraries</code> and click the disclosure triangle at the beginning of the line. The button previously labeled New Sibling should change to New Child. If not, check to be sure the disclosure triangle next to <code>OSBundleLibraries</code> is pointing down.</p><p>Click the button that now says New Child (as soon as you do, it will change back to New Sibling). A new item will appear below <code>OSBundleLibraries</code>. Change the name from <code>New item</code> to <code>com.apple.kernel.iokit</code>. Leave the Class set to <code>String</code> and double-click on the Value field and enter 6.9.9.</p><p>Clicking the New Sibling button each time, add two more elements to the <code>OSBundleLibraries</code> dictionary.</p>
<div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>com.apple.kernel.libkern String 6.9.9<span></span></pre></td></tr><tr><td scope="row"><pre>com.apple.kernel.mach String 6.9.9<span></span></pre></td></tr></table></div></li>
<li class="li"><p>Note that <code>IOKitPersonalities</code> is a Dictionary. Specifically, <code>IOKitPersonalities</code> is a representation of an <code>OSDictionary</code>, serialized into XML property list format. This Dictionary defines personalities for your driver; each personality contains properties for matching and loading a driver. You will implement one personality, named <code>HelloIOKit</code>, within the <code>IOKitPersonalities</code> Dictionary. The <code>HelloIOKit</code> personality is also a Dictionary, containing additional elements with various types.</p><p>Click on the line for <code>IOKitPersonalities</code> and click the disclosure triangle at the beginning of the line. The button previously labeled New Sibling should change to say New Child. If not, check to be sure the disclosure triangle next to <code>IOKitPersonalities</code> is pointing down.</p><p>Click the button that now says New Child (as soon as you do, it will change back to New Sibling). A new item will appear below <code>IOKitPersonalities</code>. Change the name from <code>New item</code> to <code>HelloIOKit</code>. Click on the Class field for this new item (it currently says <code>String</code>). In the popup menu, select <code>Dictionary</code>.</p><p>With the line for <code>HelloIOKit</code> selected, click the disclosure triangle at the beginning of the line. The button previously labeled New Sibling changes to say New Child.</p><p>Click the New Child Button (as soon as you do, it will change back to New Sibling). A new item will appear below <code>HelloIOKit</code>. Change the name from <code>New item</code> to <code>CFBundleIdentifier</code> (you can copy and paste the name from above in the property list). For the value, type (or copy and paste) <code>com.MyTutorial.driver.HelloIOKit</code>.</p><p>Click the button that now says New Sibling. A new item will appear within the <code>HelloIOKit</code> dictionary. Change the name from <code>New item</code> to <code>IOClass</code>. Edit the value to be <code>com_MyTutorial_driver_HelloIOKit</code>. Note that this is the same name used before as the CFBundleIdentifier, except that you must use underbars, “_”, rather than dots, “.”, in the class name. Again, Apple recommends this “reverse-DNS” convention for naming your class, to ensure consistency and reduce name collisions among drivers.</p><div class="importantbox"><a name="//apple_ref/doc/uid/20002366-DontLinkElementID_19" title="Important:"></a><p><strong>Important:</strong>&nbsp;

Be sure that the value field of <code>IOClass</code> contains underbars, “_”, rather than dots, “.”, as used in <code>CFBundleIdentifier</code>. This string will be used to create the class for your device driver.</p><p></p></div><p>Now you will create the property list elements that define a successful match for your driver, so that it can be loaded. You’ll also add the <code>IOKitDebug</code> property to help in debugging driver matching.</p><div class="notebox"><a name="//apple_ref/doc/uid/20002366-DontLinkElementID_20" title="Note"></a><p><strong>Note:</strong>&nbsp;If you include the <code>IOKitDebug</code> property with a nonzero value in your driver’s property list, it will provide information about your driver’s matching and loading. When you write a functional driver following the guidelines in this tutorial, however, you should give the <code>IOKitDebug</code> property a zero value because a nonzero value will prevent your driver from loading into the kernel during a safe-boot. For more information on safe booting, see <span class="content_text"><a href="../KEXTConceptLoading/loading_kexts.html#//apple_ref/doc/uid/20002369-BABEJEIB" target="_self">Loading Kernel Extensions at Boot Time</a></span>.</p></div><div class="importantbox"><a name="//apple_ref/doc/uid/20002366-DontLinkElementID_21" title="Important:"></a><p><strong>Important:</strong>&nbsp;
<code>IOMatchCategory</code> is a special property list element that allows multiple drivers to match on a single nub. The presence of <code>IOMatchCategory</code> allows <code>HelloIOKit</code> to match on <code>IOResources</code> (a special nub at the root of the I/O Registry that provides system-wide resources) without preventing other drivers from matching on it. When you write a functional driver following the guidelines in this tutorial, you should <em>not</em> include the <code>IOMatchCategory</code> element in your driver’s property list at all unless there is a valid reason for your driver to match on the same device nub at the same time as another driver (for example, a serial port with multiple devices attached to it).</p><p>The vast majority of drivers should not match on <code>IOResources</code>. A rare exception to this is a driver for a virtual device, because a virtual device does not produce its own nub in the I/O Registry. If you’re developing such a driver, you must include the <code>IOMatchCategory</code> property to make sure your driver doesn’t claim <code>IOResources</code> and prevent other drivers from matching on it. To ensure your driver’s <code>IOMatchCategory</code> value is unique, use your driver’s class name, in reverse-DNS notation and with underbars instead of dots (for example, <code>com_MyTutorial_driver_HelloIOKit</code>).</p><p></p></div><p>Clicking the button that says New Sibling each time, add the following property list elements. Be sure to change the class of the first, <code>IOKitDebug</code>, from a string to a number using the popup menu. Be sure to enter the names and values exactly as shown below.</p><a name="//apple_ref/doc/uid/20002366-109317" title="Table 1HelloIOKit personality dictionary values"></a><div class="tableholder"><table class="graybox" border = "0" cellspacing="0" cellpadding="5">
<caption class="tablecaption"><strong>Table 1&nbsp;&nbsp;</strong>HelloIOKit personality dictionary values</caption>

<tr>
<th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Name</p></th>
<th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Class</p></th>
<th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Value</p></th>
</tr>


<tr>
<td  scope="row"><p><code>IOKitDebug</code></p></td>
<td ><p>Number</p></td>
<td ><p><code>65535</code></p></td>
</tr>
<tr>
<td  scope="row"><p><code>IOMatchCategory</code></p></td>
<td ><p>String</p></td>
<td ><p><code>com_MyTutorial_driver_HelloIOKit</code></p></td>
</tr>
<tr>
<td  scope="row"><p><code>IOProviderClass</code></p></td>
<td ><p>String</p></td>
<td ><p><code>IOResources</code></p></td>
</tr>
<tr>
<td  scope="row"><p><code>IOResourceMatch</code></p></td>
<td ><p>String</p></td>
<td ><p><code>IOKit</code></p></td>
</tr>

</table></div><div class="importantbox"><a name="//apple_ref/doc/uid/20002366-DontLinkElementID_22" title="Important:"></a><p><strong>Important:</strong>&nbsp;
If you insert these elements in a different order, Property List Editor immediately rearranges the list to be alphabetical. As you add or edit each element, pay careful attention to be sure you are editing the line you think!</p><p></p></div><p>When you have finished adding property list elements, the screen should look like the example shown in <span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-109453-CHDFJBEI">Figure 3</a></span>.</p><div class="item_figure"><a name="//apple_ref/doc/uid/20002366-109453-CHDFJBEI" title="Figure 3Info.plist entries after additions"></a><p><a name="//apple_ref/doc/uid/20002366-109453" title="Figure 3Info.plist entries after additions"></a><strong>Figure 3&nbsp;&nbsp;</strong>Info.plist entries after additions</p>
<img src = "../art/hello_iokit_personality.jpg" alt = "" ></div></li>
<li class="li"><p>Click File > Save in the Property List Editor menu to save your changes. Then choose Property List Editor > Quit Property List Editor to return to your project in Xcode.</p></li></ol>
<a name="//apple_ref/doc/uid/20002366-99759" title="Edit the Driver&acirc;&#128;&#153;s Build Settings"></a><a name="//apple_ref/doc/uid/20002366-99759-CHDBIAED" title="Edit the Driver&acirc;&#128;&#153;s Build Settings"></a><h2>Edit the Driver’s Build Settings</h2>
<p>Xcode defines several settings that contain information about your KEXT that get compiled into its executable. You will be editing a few of these settings to make sure they correspond to elements in the driver’s plist.</p>
<ol class="ol"><li class="li"><p>On the left, in the Groups &amp; Files view, click the disclosure triangle next to Targets and select HelloIOKit (you don’t have to click the disclosure triangle next to HelloIOKit).</p></li>
<li class="li"><p>Click the Get Info button in the tool bar (it’s the round blue button with an “i” in the middle).</p></li>
<li class="li"><p>Select the Build view and be sure Customized Settings is selected in the Collection pop-up menu. Scroll down to the bottom of the Customized Settings list and change the name of the module from the default chosen by Xcode (the value of the <code>MODULE_NAME</code> setting). </p><p>Click on the line for <code>MODULE_NAME</code> and double-click on <code>com.yourcompany.driver.HelloIOKit</code> in the Value field. Double-click on <code>yourcompany</code> and change this string to <code>MyTutorial</code>. Be sure that the <code>MODULE_NAME</code> value matches the value of the <code>CFBundleIdentifier</code> you entered in your driver’s <code>Info.plist</code> file or your driver will not run.</p></li>
<li class="li"><p>Note that the <code>MODULE_START</code> and <code>MODULE_STOP</code> settings are not listed. The I/O Kit provides the initialization and termination routines for drivers; you need not (and should not) specify these methods in your source code or in the driver’s build settings.</p></li>
<li class="li"><p>The value of the <code>MODULE_VERSION</code> setting is in the <code>‘vers’</code> resource style and must be numerically identical to the <code>CFBundleVersion</code> value in the driver’s plist or your driver may not load.</p><p>For this tutorial, make sure <code>MODULE_VERSION</code> has the value <code>1.0.0d1</code>.</p><div class="importantbox"><a name="//apple_ref/doc/uid/20002366-DontLinkElementID_23" title="Important:"></a><p><strong>Important:</strong>&nbsp;
You must make sure that the <code>MODULE_VERSION</code> value in the Customized Settings panel is numerically equal to the <code>CFBundleVersion</code> string in the <code>Info.plist</code> file or your driver may not load. You must also make sure the <code>MODULE_NAME</code> value in the Customized Settings panel matches the <code>CFBundleIdentifier</code> string in the <code>Info.plist</code> file or your driver will not run.</p><p></p></div></li></ol>
<p>Before going on to the next section, you might want to go back to the Property List Editor view of the <code>Info.plist</code> file and copy the string <code>com_MyTutorial_driver_HelloIOKit</code>; you’ll need it for the next few steps. To do this, click the disclosure triangle next to HelloIOKit in the Groups &amp; Files view, click the disclosure triangle next to Resources, and double-click Info.plist. View the Info.plist file by clicking the disclosure triangle next to Root. Select <code>com_MyTutorial_driver_HelloIOKit</code> in the Value field for the <code>IOClass</code> member of the HelloIOKit personality and choose Copy from the Edit menu. Then choose Property List Editor > Quit Property List Editor to return to Xcode.</p>
<a name="//apple_ref/doc/uid/20002366-100120" title="Implement the Header File"></a><a name="//apple_ref/doc/uid/20002366-100120-CHDGHGFJ" title="Implement the Header File"></a><h2>Implement the Header File</h2>
<p>With the disclosure triangle next to HelloIOKit pointing down, click on the disclosure triangle next to Source. Double-click on <code>HelloIOKit.h</code> to display the header file. The default header file does nothing. You need to add code before it does anything useful. <span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-106376-CHDGFICE">Figure 4</a></span> shows where you will find the <code>HelloIOKit.h</code> file in the project window.</p>
<br/><div><a name="//apple_ref/doc/uid/20002366-106376-CHDGFICE" title="Figure 4Viewing source code in Xcode"></a><p><a name="//apple_ref/doc/uid/20002366-106376" title="Figure 4Viewing source code in Xcode"></a><strong>Figure 4&nbsp;&nbsp;</strong>Viewing source code in Xcode</p>
<img src = "../art/hello_iokit_source.jpg" alt = "" ></div><br/>
<p>Edit the contents of <code>HelloIOKit.h</code> to match the code in <span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-106631-CHDFCDFD">Listing 1</a></span>, pasting the string you copied from the <code>Info.plist</code> file (<code>com_MyTutorial_driver_HelloIOKit</code>) where shown.</p>
<p>Notice that the first line of <code>HelloIOKit.h</code> includes the header file <code>IOService.h</code>. This header file defines many of the methods and services on which device drivers depend. The header file is located in the <code>IOKit</code> folder of <code>Kernel.framework</code>. When you develop your own driver, be sure only to include header files from <code>Kernel.framework</code> (in addition to header files you create) because only these files have meaning in the kernel environment. If you include other header files, your driver might compile but the functions and services defined in those header files would not be available in the kernel.</p>
<p>Pay special attention to the lines that contain the string <code>com_MyTutorial_driver_HelloIOKit</code>. If this were not a tutorial, the actual name of your driver’s class (as copied and pasted) would go here.</p>
<div class="importantbox"><a name="//apple_ref/doc/uid/20002366-DontLinkElementID_24" title="Important:"></a><p><strong>Important:</strong>&nbsp;
Be very sure that this string is exactly as entered for the value of <code>IOClass</code> in the <code>Info.plist</code> file. Other than changing dots to underbars, this name should also be identical to the CFBundleIdentifier defined in the <code>Info.plist</code> file and to the <code>MODULE_NAME</code> in the Customized Settings panel. If these strings do not match, your driver will not load and run properly.</p><p></p></div>
<p>Aside from the importance of the class name, the <code>OSDeclareDefaultStructors</code> macro used in this file is very important. If you don’t use this macro correctly, or in the proper place, your driver won’t run.</p>
<p>In the header file, the <code>OSDeclareDefaultStructors</code> macro must be the first line in the class’s declaration. It takes one argument: the class’s name. It declares the class’s constructors and destructors for you, in the manner the I/O Kit expects. </p>
<p>Edit <code>HelloIOKit.h</code> to match the code below:</p>
<a name="//apple_ref/doc/uid/20002366-106631-CHDFCDFD" title="Listing 1HelloIOKit.h"></a><p class="codesample"><a name="//apple_ref/doc/uid/20002366-106631" title="Listing 1HelloIOKit.h"></a><strong>Listing 1&nbsp;&nbsp;</strong>HelloIOKit.h</p>
<div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;IOKit/IOService.h><span></span></pre></td></tr><tr><td scope="row"><pre>class com_MyTutorial_driver_HelloIOKit : public IOService<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>OSDeclareDefaultStructors(com_MyTutorial_driver_HelloIOKit)<span></span></pre></td></tr><tr><td scope="row"><pre>public:<span></span></pre></td></tr><tr><td scope="row"><pre>    virtual bool init(OSDictionary *dictionary = 0);<span></span></pre></td></tr><tr><td scope="row"><pre>    virtual void free(void);<span></span></pre></td></tr><tr><td scope="row"><pre>    virtual IOService *probe(IOService *provider, SInt32 *score);<span></span></pre></td></tr><tr><td scope="row"><pre>    virtual bool start(IOService *provider);<span></span></pre></td></tr><tr><td scope="row"><pre>    virtual void stop(IOService *provider);<span></span></pre></td></tr><tr><td scope="row"><pre>};<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr></table></div>
<p>When you have finished editing <code>HelloIOKit.h</code>, copy the class name string (<code>com_MyTutorial_driver_HelloIOKit</code>) again; you will need it in the next step. Then double-click on <code>HelloIOKit.cpp</code> in the Groups &amp; Files view of the Xcode project window. Again, the default file does nothing. You will need to add code before it can do anything useful. </p>
<a name="//apple_ref/doc/uid/20002366-100582" title="Implement the Driver&acirc;&#128;&#153;s Entry Points"></a><a name="//apple_ref/doc/uid/20002366-100582-CHDCBEGG" title="Implement the Driver&acirc;&#128;&#153;s Entry Points"></a><h2>Implement the Driver’s Entry Points</h2>
<p>The following list describes some of the entry points that the I/O Kit uses. You will need to implement these entry points in your driver’s source file.</p>
<p>Most of the methods come in pairs: one performs some action and creates some data structures, the other undoes that action and releases those data structures. Generally a module must define only the <code>probe</code>, <code>start</code> and <code>stop</code> methods, using its superclass’s definitions for the rest. </p>
<ul class="ul"><li class="li"><p>The <code>init</code> method is the first instance method called on each instance of your driver class. By convention, the first call to any newly created object is <code>init</code>; this method will only be called once on each instance. The <code>free</code> method is the last one called on any object. Any resources allocated in <code>init</code> should be disposed of in <code>free</code>. A driver is unloaded as a result of all its objects being freed. Note that the <code>init</code> method operates on objects; this is your opportunity to prepare an object to receive calls. Use <code>probe</code> or <code>start</code> to do the real driver work.</p></li>
<li class="li"><p>The <code>probe</code> method is called if your driver needs to talk to the hardware to determine whether there’s a match. This method must leave the hardware in a good state when it returns, as other drivers may probe it as well. </p></li>
<li class="li"><p>The <code>start</code> method is the first one called in the actual driver life cycle; it tells the driver to start driving hardware. After <code>start</code> is called, the driver can begin publishing nubs and vending services. The <code>stop</code> method is the first to be called before your driver is unloaded. When <code>stop</code> is called, your driver should unpublish all existing nubs; no more nubs will be published and the driver stops vending services. The <code>start</code> and <code>stop</code> methods talk to the hardware via your driver’s provider.</p></li></ul>
<div class="importantbox"><a name="//apple_ref/doc/uid/20002366-DontLinkElementID_25" title="Important:"></a><p><strong>Important:</strong>&nbsp;
Be very sure that the class name is exactly the same string you used in <code>HelloIOKit.h</code> and entered for the value of the <code>IOClass</code> member of the HelloIOKit personality. Other than changing dots to underbars, this name should also be identical to the CFBundleIdentifier defined in the <code>Info.plist</code> file and to the <code>MODULE_NAME</code> in the Customized Settings panel. If these strings do not match, your driver will not load and run properly.</p><p></p></div>
<p>Aside from the importance of the class name, the <code>OSDefineMetaClassAndStructors</code> macro used in this file is very important. If you don’t use this macro correctly, or in the proper place, your driver won’t run.</p>
<p>In the C++ source file, the <code>OSDefineMetaClassAndStructors</code> macro must appear before you define any of your class’s methods. This macro takes two arguments: your class’s name and the name of your class’s superclass. The macro defines the class’s constructors, destructors, and several other methods I/O Kit requires.</p>
<p>Notice that <code>HelloIOKit.cpp</code> includes only <code>Kernel.framework</code> header files, in addition to <code>HelloIOKit.h</code>. Aside from header files you define, you should include only header files from <code>Kernel.framework</code> in your driver.</p>
<p>Edit <code>HelloIOKit.cpp</code> to match the code below:</p>
<a name="//apple_ref/doc/uid/20002366-107182" title="Listing 2HelloIOKit.cpp"></a><p class="codesample"><strong>Listing 2&nbsp;&nbsp;</strong>HelloIOKit.cpp</p>
<div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;IOKit/IOLib.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include "HelloIOKit.h"<span></span></pre></td></tr><tr><td scope="row"><pre>extern "C" {<span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;pexpert/pexpert.h>//This is for debugging purposes ONLY<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Define my superclass<span></span></pre></td></tr><tr><td scope="row"><pre>#define super IOService<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// REQUIRED! This macro defines the class's constructors, destructors,<span></span></pre></td></tr><tr><td scope="row"><pre>// and several other methods I/O Kit requires. Do NOT use super as the<span></span></pre></td></tr><tr><td scope="row"><pre>// second parameter. You must use the literal name of the superclass.<span></span></pre></td></tr><tr><td scope="row"><pre>OSDefineMetaClassAndStructors(com_MyTutorial_driver_HelloIOKit, IOService)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>bool com_MyTutorial_driver_HelloIOKit::init(OSDictionary *dict)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    bool res = super::init(dict);<span></span></pre></td></tr><tr><td scope="row"><pre>    IOLog("Initializing\n");<span></span></pre></td></tr><tr><td scope="row"><pre>    return res;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>void com_MyTutorial_driver_HelloIOKit::free(void)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    IOLog("Freeing\n");<span></span></pre></td></tr><tr><td scope="row"><pre>    super::free();<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>IOService *com_MyTutorial_driver_HelloIOKit::probe(IOService *provider, SInt32<span></span></pre></td></tr><tr><td scope="row"><pre>*score)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    IOService *res = super::probe(provider, score);<span></span></pre></td></tr><tr><td scope="row"><pre>    IOLog("Probing\n");<span></span></pre></td></tr><tr><td scope="row"><pre>    return res;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>bool com_MyTutorial_driver_HelloIOKit::start(IOService *provider)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    bool res = super::start(provider);<span></span></pre></td></tr><tr><td scope="row"><pre>    IOLog("Starting\n");<span></span></pre></td></tr><tr><td scope="row"><pre>    return res;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>void com_MyTutorial_driver_HelloIOKit::stop(IOService *provider)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    IOLog("Stopping\n");<span></span></pre></td></tr><tr><td scope="row"><pre>    super::stop(provider);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr></table></div>
<p>The <code>IOLog</code> method is similar to <code>printf</code>, but runs faster and flushes its output more frequently.</p>
<p>Two additional methods are implemented by I/O Kit and rarely, if ever, should be overridden by your driver code. <code>attach</code> is called by your driver’s provider after a successful match; it causes your driver to be added to the I/O Registry. <code>detach</code> is called after an unsuccessful <code>probe</code>, or when a driver is removed from the I/O Registry.</p>
<p>Save your changes by choosing File > Save in the Xcode menu.</p>
<a name="//apple_ref/doc/uid/20002366-101431" title="Build the Project"></a><a name="//apple_ref/doc/uid/20002366-101431-CHDJCJCB" title="Build the Project"></a><h2>Build the Project</h2>
<p>Click the Build button (it looks like a hammer) in the upper left corner of the Xcode editor window or select Build from the Build menu.</p>
<p>If you didn’t save earlier, Xcode asks you whether to save some modified files. If this is the case, select all the files and click “Save All”. <span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-107342-CHDDAFBG">Figure 5</a></span> shows the Save dialog.</p>
<br/><div><a name="//apple_ref/doc/uid/20002366-107342-CHDDAFBG" title="Figure 5Save before building"></a><p><a name="//apple_ref/doc/uid/20002366-107342" title="Figure 5Save before building"></a><strong>Figure 5&nbsp;&nbsp;</strong>Save before building</p>
<img src = "../art/hello_iokit_save.gif" alt = "" width="354" height="285"></div><br/>
<p>Xcode starts building your project. It stops if it reaches an error in the code.</p>
<a name="//apple_ref/doc/uid/20002366-101567" title="Fix Any Errors"></a><h2>Fix Any Errors</h2>
<p>If you made any errors typing in the code, Xcode will stop and show you the errors, in both the editor window (if you haven’t closed it) and the main project window. In the project window, click the disclosure triangle next to Errors and Warnings in the Groups &amp; Files view to reveal the files that contain errors. If you select a file listed under Errors and Warnings, Xcode lists the errors in that file, each accompanied by a short description of the problem. Double-click the file name to open an editor window and edit the source code. Correct any errors and build the project again.</p>
<a name="//apple_ref/doc/uid/20002366-101599" title="Test the Device Driver"></a><a name="//apple_ref/doc/uid/20002366-101599-CHDECIDA" title="Test the Device Driver"></a><h2>Test the Device Driver</h2>
<p>This section shows how to test the driver. You’ll load your driver using the <strong>kextload</strong> command, you’ll use the <strong>kextstat</strong> command to see that the driver has been loaded, and finally, you’ll unload your driver from the kernel using the <strong>kextunload</strong> command.</p>
<p>You’ll use the Terminal application to type the commands to load and unload your module. You’ll view the results as they are written to the system log file, <code>/var/log/system.log</code>.</p>
<div class="notebox"><a name="//apple_ref/doc/uid/20002366-DontLinkElementID_26" title="Note"></a><p><strong>Note:</strong>&nbsp;This tutorial uses the “<code>%</code>” prompt when it shows the commands you type in the Terminal application. This is the default prompt of the <code>tcsh</code> shell. If you’re using a different shell, you may see a different prompt. The prompt in the <code>bash</code> shell, which is the default shell in Mac OS X version 10.3, is “<code>$</code>”.</p></div>
<p>Note that you use <strong>kextload</strong> and <strong>kextunload</strong> only when testing a driver. When a KEXT is fully installed under Darwin/Mac OS X, the Kernel Extension Manager takes care of loading and running (and unloading) drivers.</p>
<p>The following sections show you how to test your driver.</p>
<a name="//apple_ref/doc/uid/20002366-107513" title="Getting Root Privileges"></a><h3>Getting Root Privileges</h3>
<p>To use the <strong>kextload</strong> and <strong>kextunload</strong> commands you must have <code>root</code> or super user privileges. Instead of logging in as <code>root</code>, for this tutorial you will use the <strong>sudo</strong> command which gives permitted users the ability to execute a given command as <code>root</code>.</p>
<p>By default, Darwin/Mac OS X allows <code>admin</code> and <code>root</code> users to use the <strong>sudo</strong> command, so make sure you are currently logged in to an <code>admin</code> account before using <strong>sudo</strong>. Recall that an admin user is a user who has “Allow user to administer this computer” checked in the Security view of the Accounts system preference. </p>
<a name="//apple_ref/doc/uid/20002366-107632" title="Start the Terminal Application"></a><h3>Start the Terminal Application</h3>
<ol class="ol"><li class="li"><p>Start the Terminal application. From a Desktop Finder window, locate and launch the Terminal application, found at <code>/Applications/Utilities/Terminal</code>. </p></li>
<li class="li"><p>To view the system log file, enter the following command at the Terminal prompt:</p><div class="codesample"><table><tr><td scope="row"><pre>% tail -f /var/log/system.log<span></span></pre></td></tr></table></div></li>
<li class="li"><p>Open a second window in the Terminal application. Choose File > New Shell from the Terminal menu. Position this window so that you can view both windows easily. You will load your driver from the second window. </p></li>
<li class="li"><p>In the second Terminal window, move to the directory that contains your driver. Xcode stores your driver in the <code>Debug</code> folder of the <code>build</code> directory of your project location (unless you’ve set a different location for build products using Xcode’s Preferences dialog).</p><p>Use the <strong>cd</strong> command to move to the appropriate directory. For example:</p><div class="codesample"><table><tr><td scope="row"><pre>% cd Projects/HelloIOKit/build/Debug<span></span></pre></td></tr></table></div><p>This directory contains your KEXT. You can use the <strong>ls</strong> command to view the contents of this directory. For example:</p>
<div class="codesample"><table><tr><td scope="row"><pre>% ls<span></span></pre></td></tr><tr><td scope="row"><pre>HelloIOKit.kext<span></span></pre></td></tr></table></div><p>Your KEXT should have the name <code>HelloIOKit.kext</code>. Note that this name is formed from the Project name and a suffix, <code>.kext</code>. </p><div class="importantbox"><a name="//apple_ref/doc/uid/20002366-DontLinkElementID_27" title="Important:"></a><p><strong>Important:</strong>&nbsp;
For purposes of packaging, distribution, and installation, the filename of the KEXT (apart from the suffix) does not matter. However, the name of the KEXT binary and the KEXT’s class (stored in the KEXT’s property list) should be unique, using the recommended “reverse-DNS” naming convention.</p><p></p></div><p>From a Desktop Finder window, a KEXT appears as a single file (look for it from the Desktop if you like). From the Terminal application, however, a KEXT appears as a directory. The KEXT directory contains the contents of your KEXT, including the plist (<code>Contents/Info.plist</code>) and the KEXT binary (<code>Contents/MacOS/HelloIOKit</code>).</p></li>
<li class="li"><p>View the contents of the KEXT directory. Use the <strong>find</strong> command.</p><p>For example:</p><div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>% find HelloIOKit.kext<span></span></pre></td></tr><tr><td scope="row"><pre>HelloIOKit.kext<span></span></pre></td></tr><tr><td scope="row"><pre>HelloIOKit.kext/Contents<span></span></pre></td></tr><tr><td scope="row"><pre>HelloIOKit.kext/Contents/Info.plist<span></span></pre></td></tr><tr><td scope="row"><pre>HelloIOKit.kext/Contents/MacOS<span></span></pre></td></tr><tr><td scope="row"><pre>HelloIOKit.kext/Contents/MacOS/HelloIOKit<span></span></pre></td></tr><tr><td scope="row"><pre>HelloIOKit.kext/Contents/Resources<span></span></pre></td></tr><tr><td scope="row"><pre>HelloIOKit.kext/Contents/Resources/English.lproj<span></span></pre></td></tr><tr><td scope="row"><pre>HelloIOKit.kext/Contents/Resources/English.lproj/InfoPlist.strings<span></span></pre></td></tr><tr><td scope="row"><pre>HelloIOKit.kext/Contents/Resources/Info.plist<span></span></pre></td></tr></table></div></li></ol>
<p>You are now ready to load and run (and then unload) your driver.</p>
<a name="//apple_ref/doc/uid/20002366-102251" title="Load the Driver"></a><a name="//apple_ref/doc/uid/20002366-102251-CIHGGEGI" title="Load the Driver"></a><h2>Load the Driver</h2>
<p>Because kernel extensions contain code and data that are loaded into the kernel, the most protected environment in the operating system, their file ownership and permissions must be set to prevent unauthorized tampering. All KEXT bundles (all files and folders in the KEXT, including the KEXT binary) must be owned by the user <code>root</code> and the group <code>wheel</code>. In addition, the folders and files of the KEXT bundle must have their permissions set so that they are not writable by any user other than the super user.</p>
<p>For development purposes, however, you can make a <code>root</code>-owned copy of your KEXT binary to load and test. You should not change the ownership and permissions of any of your KEXT files in your own directory, because you will no longer be able to save them after working on them. For this tutorial, you will use the <strong>sudo</strong> command to copy the KEXT binary (<code>HelloIOKit.kext</code>) to the <code>/tmp</code> directory and load and unload the KEXT from there. Using <strong>sudo</strong> to copy the KEXT binary gives the KEXT the super user’s ownership and permissions and leaves the original KEXT alone so you can revise and save it as you choose.</p><div class="notebox"><a name="//apple_ref/doc/uid/20002366-DontLinkElementID_28" title="Note"></a><p><strong>Note:</strong>&nbsp;Every time you make changes to your KEXT and rebuild it, you need to repeat the following steps to copy the new version to the <code>/tmp</code> directory to load and test it.</p></div>
<ol class="ol"><li class="li"><p>At the prompt, you’ll use the <strong>cp -R</strong> command with the <strong>sudo</strong> command to copy your driver to <code>/tmp</code>. The <strong>cp</strong> command copies files from one place to another and the <code>-R</code> option tells <strong>cp</strong> to copy a directory and its entire subtree (like <code>HelloIOKit.kext</code>). When prompted for a password, enter your <code>admin</code> password. (Note that nothing is displayed as you type the password.)</p><div class="warningbox"><img src="../../../../Resources/Images/icon_warning.gif" alt="!" width="20" height="20" border="0" class="warningicon" /><a name="//apple_ref/doc/uid/20002366-DontLinkElementID_29" title="Warning:"></a><p><strong>Warning:</strong>&nbsp;
If you use tab-completion to avoid typing all of <code>HelloIOKit.kext</code>, you’ll get a “/” after the KEXT name. Be sure to delete this slash before you press Return. If you don’t, the <strong>cp</strong> command will copy only the <em>contents</em> of the <code>HelloIOKit.kext</code> directory to <code>/tmp</code>, instead of copying the directory and its entire subtree.</p><p></p><div class="clear"></div></div><p>Type the following to copy your driver to <code>/tmp</code>:</p>
<div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>% sudo cp -R HelloIOKit.kext /tmp<span></span></pre></td></tr><tr><td scope="row"><pre>Password:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr></table></div><p>Check the ownership and permissions of your driver by moving to the <code>/tmp</code> directory and using the <strong>ls -l</strong> command:</p>
<div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    % cd /tmp<span></span></pre></td></tr><tr><td scope="row"><pre>    % ls -l<span></span></pre></td></tr><tr><td scope="row"><pre>    drwxr-xr-x 3 root wheel 102 Jun 19 10:30 HelloIOKit.kext<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr></table></div><p>The <code>-l</code> makes the <strong>ls</strong> command display extra information about the files in a directory.</p></li>
<li class="li"><p>From the <code>/tmp</code> directory, use the <strong>kextload</strong> command with the <strong>sudo</strong> command; this loads your driver, runs its initialization (<code>start</code>) method, and registers it with the kernel. Note that you may not have to re-enter your password this time. This is because you’re allowed to continue to use <strong>sudo</strong> for a short period (usually about 5 minutes) without reauthenticating.</p><p>For example:</p>
<div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>% sudo kextload -v HelloIOKit.kext<span></span></pre></td></tr><tr><td scope="row"><pre>kextload: extension HelloIOKit.kext appears to be valid<span></span></pre></td></tr><tr><td scope="row"><pre>kextload: notice: extension HelloIOKit.kext has debug properties set<span></span></pre></td></tr><tr><td scope="row"><pre>kextload: loading extension HelloIOKit.kext<span></span></pre></td></tr><tr><td scope="row"><pre>kextload: HelloIOKit.kext loaded successfully<span></span></pre></td></tr><tr><td scope="row"><pre>kextload: loading personalities named:<span></span></pre></td></tr><tr><td scope="row"><pre>kextload:   HelloIOKit<span></span></pre></td></tr><tr><td scope="row"><pre>kextload: sending 1 personality to the kernel<span></span></pre></td></tr><tr><td scope="row"><pre>kextload: matching started for HelloIOKit.kext<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr></table></div><p>The <code>-v</code> is optional; it makes <strong>kextload</strong> provide more verbose information.</p></li>
<li class="li"><p>In the other Terminal window, view the system log. In a few moments, several lines will appear, for example: </p>
<div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>Matching service count = 1<span></span></pre></td></tr><tr><td scope="row"><pre>Initializing<span></span></pre></td></tr><tr><td scope="row"><pre>com_MyTutorial_driver_HelloIOKit::probe(IOResources)<span></span></pre></td></tr><tr><td scope="row"><pre>Probing<span></span></pre></td></tr><tr><td scope="row"><pre>com_MyTutorial_driver_HelloIOKit::start(IOResources) &lt;1><span></span></pre></td></tr><tr><td scope="row"><pre>Starting<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr></table></div></li>
<li class="li"><p>Use the <strong>kextstat</strong> command to check the status of the driver. This command displays the status of all dynamically-loaded kernel modules. Enter the command: </p><div class="codesample"><table><tr><td scope="row"><pre>% kextstat<span></span></pre></td></tr></table></div><p>You’ll see several lines of output, including a line for your driver (at the end).</p><div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>Id  Refs AddressSizeWiredName (Version) &lt;Linked Against><span></span></pre></td></tr><tr><td scope="row"><pre> 1  0   0x4b940000x170000x16000ATIR128 (0.1)<span></span></pre></td></tr><tr><td scope="row"><pre> 2  2   0x4bbb0000x100000xf000com.apple.IOAudioFamily (0.1a)<span></span></pre></td></tr><tr><td scope="row"><pre>10  0   0x4d180000x70000x6000SIP-NKE (0.1a)<span></span></pre></td></tr><tr><td scope="row"><pre>11  0   0x50c0000 0x40000x3000 com.MyTutorial.driver.HelloIOKit (1.0.0d1) &lt;10><span></span></pre></td></tr><tr><td scope="row"><pre>...<span></span></pre></td></tr></table></div></li>
<li class="li"><p>Unload the driver. Use the <strong>kextunload</strong> command with the <strong>sudo</strong> command. This unloads your driver by running its termination (<code>stop</code>) function.</p><p>For example, from the <code>/tmp</code> directory:</p>
<div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>% sudo kextunload HelloIOKit.kext<span></span></pre></td></tr><tr><td scope="row"><pre>unload kext HelloIOKit.kext succeeded<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr></table></div><p>Note that you may have to enter your <code>admin</code> password this time if it’s been more than a few minutes since the last time you entered your password.</p></li>
<li class="li"><p>View the system log. In a few moments, several lines will appear, for example:</p><div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>Stopping<span></span></pre></td></tr><tr><td scope="row"><pre>Freeing<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr></table></div></li>
<li class="li"><p>Stop the system log display. The <strong>tail -f</strong> command you used to view the system log will continue to run until you stop it.</p><p>In the Terminal window displaying the system log, press the <code>control</code> key and the <code>c</code> key at the same time.</p></li></ol>
<a name="//apple_ref/doc/uid/20002366-103105" title="Using Console Mode"></a><h2>Using Console Mode</h2>
<p>As an alternative to the Terminal application, you can load and test your KEXT from console mode. In console mode, all system messages (such as this kernel extension’s message “Probing”) are written directly to your monitor screen. Messages appear much more quickly than when they are written to the system log file.</p>
<p>However, you should keep in mind that console mode is not as flexible as the Terminal application. There are no windows, you cannot view your code in Xcode or run other applications at the same time, and you cannot use copy or paste.</p>
<p>To use console mode, follow these steps:</p>
<ol class="ol"><li class="li"><p>Log out of your account.</p><p>From the Desktop, choose Log Out from the Finder menu.</p></li>
<li class="li"><p>From the login screen, log in to console mode.</p><p>Type <code>>console</code> as the user name, leave the password blank, and press Return. Be sure to include the <code>></code> character at the beginning of the name. The screen turns black and looks like an old ASCII “glass terminal”. This is console mode. </p></li>
<li class="li"><p>At the prompt, log in to your <code>admin</code> account. </p></li>
<li class="li"><p>Move to the directory that contains your KEXT. Use the <strong>cd</strong> command. </p><p>For example:</p><div class="codesample"><table><tr><td scope="row"><pre>cd /Users/admin/Projects/HelloIOKit/build<span></span></pre></td></tr></table></div></li>
<li class="li"><p>Follow the instructions given in <span class="content_text"><a href="hello_iokit.html#//apple_ref/doc/uid/20002366-102251">“Load the Driver.”</a></span></p></li>
<li class="li"><p>Remember that the console messages will come directly to your screen; you do not need to view the system log file.</p></li>
<li class="li"><p>When you have finished, log out of console mode by entering the command <strong>logout</strong>.</p></li></ol>
<a name="//apple_ref/doc/uid/20002366-103309" title="Where to Go Next"></a><h2>Where to Go Next</h2>
<p>Congratulations! You’ve now written, built, loaded, and unloaded a device driver. In the next tutorial in this series, <span class="content_text"><a href="../KEXTConceptDebugger/hello_debugger.html#//apple_ref/doc/uid/20002367-CHDIHFDI">“Hello Debugger: Debugging a Device Driver With GDB,”</a></span> you’ll learn how to debug your driver using a two-machine debugging environment.</p>
<p>If you’re interested, you can use the <strong>man</strong> command to read the manual pages for <strong>kextload</strong>, <strong>kextstat</strong>, and <strong>kextunload</strong>. For example, from a Terminal window, enter the command</p>
<div class="codesample"><table><tr><td scope="row"><pre>man kextstat<span></span></pre></td></tr></table></div>
<p>More information about the ‘vers’ resource can be found in the “Finder Interface” chapter of <em>Inside Macintosh—Files</em>, or online at <span class="content_text"><a href="../../../../../documentation/mac/Toolbox/Toolbox-454.html" target="_top">http://developer.apple.com/documentation/mac/Toolbox/Toolbox-454.html</a></span>.</p>
<p>Additional useful reference material can be found in <span class="content_text"><a href="../../../../../documentation/CoreFoundation/index.html" target="_top">Core Foundation Documentation</a></span>. Look here for documentation about Bundles, Property Lists, Collections (such as Dictionaries) and more.</p><p>As you become more experienced in driver development, you should also read the articles in this document that cover more advanced topics, such as how to declare dependencies so that your driver targets the appropriate version of Mac OS X. The following articles provide more information on these topics:</p><ul class="simple"><li><p><span class="content_text"><a href="../KEXTConceptLoading/loading_kexts.html#//apple_ref/doc/uid/20002369-BABEJEIB">“Loading Kernel Extensions at Boot Time”</a></span></p></li><li><p><span class="content_text"><a href="../KEXTConceptDependencies/kext_dependencies.html#//apple_ref/doc/uid/20002370-BABFGHCJ">“Kernel Extension Dependencies”</a></span></p></li><li><p><span class="content_text"><a href="../Articles/kext_permissions_ownership.html#//apple_ref/doc/uid/TP40005417-SW1">“Kernel Extension Ownership and Permissions”</a></span></p></li></ul><p>In addition, you might want to read Technical Note TN2163, “Building Universal I/O Kit Drivers” to learn the steps you need to take to configure an Xcode I/O Kit driver project to produce a universal driver. </p>

        <br/><br/> 

        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../KEXTConceptKEXT/hello_kext.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../KEXTConceptDebugger/hello_debugger.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2003, 2007 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2007-10-31<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Darwin/Conceptual/KEXTConcept/KEXTConceptIOKit/hello_iokit.html%3Fid%3DTP40001063-3.7&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Darwin/Conceptual/KEXTConcept/KEXTConceptIOKit/hello_iokit.html%3Fid%3DTP40001063-3.7&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Darwin/Conceptual/KEXTConcept/KEXTConceptIOKit/hello_iokit.html%3Fid%3DTP40001063-3.7&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>
