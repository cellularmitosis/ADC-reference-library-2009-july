<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-05-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1186: How To Be a Good Multiple Users Citizen</title>       <meta name="keywords" content="Mac OS 9, Multiple Users, access privileges">    <meta name="Description" content="Technical Note TN1186: have creator write a brief descriptionhere."><meta name="categories" content="System Releases and Overview"><meta name="week-posted" content="May 29, 2000 - Jun 2, 2000"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10003025" title="How To Be a Good Multiple Users Citizen"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/Carbon/index.html">Carbon</a> &gt; <a href="../../technicalnotes/Carbon/idxDesignGuidelines-date.html">Design Guidelines</a> &gt; </p><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1186</div>
<div id="pageheadsub">How To Be a Good Multiple Users Citizen</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left">   <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">     <tr><td width=300 valign="top" align=left scope="row">    <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr><td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>  </tr>  <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left> <span id="menutitle">CONTENTS   <br>  <br> </span>   </td>  </tr>  <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left> <!-- begin_toc -->   <P id ="menutext"><A HREF = "#Section1">Where is that Folder?</A><BR><BR><A HREF = "#Section2">Not All Users are Equal</A><BR><BR><A HREF = "#Section3">Not All Applications are Equal</A><BR><BR><A HREF = "#Section4">Is Multiple Users Installed?</A><BR><BR><A HREF = "#Section5">Is Multiple Users Running?</A><BR><BR><A HREF = "#Section6">Who is Logged In?</A><BR><BR><A HREF = "#Section7">User Names and Passwords</A><BR><BR><A HREF = "#Section8">Additional Notes &amp; Warnings</A><BR><BR><A HREF = "#Summary">Summary</A><BR><BR><A HREF = "#References">References</A><BR><BR><A HREF = "#Downloads">Downloadables</A></p> <!-- end_toc --></td>  </tr>  <tr>   <td width=300 align=left scope="row"> <img src="images/tnmenubottom.gif" alt="" width=300 height=16>   </td>  </tr>    </table></td>  <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">This Technotedescribes the new APIs provided by the Multiple Userstechnology introduced in Mac OS 9.0. It also answers themost frequent questions from developers and provides a fewworkarounds for commonly encountered problems.</P><P id = "introtext">This Note is directed at application developers who areaccessing folders within the System Folder or using the<CODE>FindFolder</CODE> API and need to pay extra attentionto the access privileges of those folders.</P><P id = "introtext">At Ease and Macintosh Manager were previous similarproducts and all the information provided in this Note isalso relevant for those technologies.</P>      <!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Jun 1 2000]</h3><!-- end_date --></TD> </TR>    </TABLE> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR><!-- begin_content --><P><A NAME=Section1></A></P><H2>Where is that Folder?</H2><BR><P>The <a href="../../documentation/mac/Toolbox/Toolbox-472.html"><CODE>FindFolder</CODE></A>routine allows callers to determine the location of foldersthat have a special purpose. For example,<CODE>FindFolder</CODE> can be used to locate thePreferences folder&emdash;the appropriate location forapplications to store their preference files. In thebeginning, <CODE>FindFolder</CODE>'s main utility wasthe fact that it would always find the appropriate foldereven when a different language system was in effect: inthese cases, folder names were often spelled differently ormay have been named using non-Roman character encodings.Now, with the advent of Multiple Users, not only may thefolders returned by <CODE>FindFolder</CODE> be named in manydifferent ways according to the language in effect, buttheir location may be different than what is expected.</P><P>The Multiple Users technology manages a group ofredirected folders associated with each User who may belogged in. If the Owner of the computer is logged in, thenno redirection occurs and all folders are accessed as if theMultiple Users technology was not there. However, if anyother User is logged in then those redirected (one of eachper User) folders are accessible with the<CODE>FindFolder</CODE> API using the constants:</P><UL><LI><CODE>kDesktopFolderType</CODE>,</LI><LI><CODE>kTrashFolderType</CODE>,</LI><LI><CODE>kPrintMonitorDocsFolderType</CODE>,</LI><LI><CODE>kStartupFolderType</CODE>,</LI><LI><CODE>kAppleMenuFolderType</CODE>,</LI><LI><CODE>kPreferencesFolderType</CODE>,</LI><LI><CODE>kLauncherItemsFolderType</CODE>,</LI><LI><CODE>kShutdownItemsFolderType</CODE>,</LI><LI><CODE>kStartupItemsDisabledFolderType</CODE>,</LI><LI><CODE>kShutdownItemsDisabledFolderType</CODE>,</LI><LI><CODE>kInternetSearchSitesFolder</CODE>,</LI><LI><CODE>kControlStripModulesFolder</CODE>,</LI><LI><CODE>kDesktopPicturesFolderType</CODE>,</LI><LI><CODE>kFavoritesFolderType</CODE>,</LI><LI><CODE>kALMLocationsFolderType</CODE>,</LI><LI><CODE>kSpeakableItemsFolderType</CODE>,</LI><LI><CODE>kKeychainFolderType</CODE>,</LI></UL><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>      In the case of remote access (i.e., when using      Macintosh Manager), the desktop folder      (<CODE>kDesktopFolderType</CODE>) and the      PrintMonitor folder      (<CODE>kPrintMonitorDocsFolderType</CODE>) will be      redirected to the local startup volume instead of      the remote volume where user preferences would      normally be. Thus, when logged into Macintosh      Manager, the preference structure would look like      this:<BR>      <BR>      Startup Volume<BR>      &nbsp;&nbsp;&nbsp;&nbsp;Users<BR>      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;username&gt;<BR>      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Desktop      Folder<BR>      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PrintMonitor      Documents<BR>      Remote Volume<BR>      &nbsp;&nbsp;&nbsp;&nbsp;Users<BR>      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;username&gt;<BR>      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Preferences      Folder<BR>      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Startup      Items<BR>      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;etc<BR>      <BR>      However, developers should never assume that the      location of the desktop folder is at a certain      location as this may change in the future. Instead      use the <CODE>vRefNum</CODE> and <CODE>dirID</CODE>      from the <CODE>FindFolder</CODE> call to locate all      redirected folders.</P></TD></TR></TABLE></CENTER><BR><BR><P>If you need to access the non-redirected folders (not allof them are accessible), you may do so using the followingconstants:</P><UL><LI><CODE>kSystemDesktopFolderType</CODE></LI><LI><CODE>kSystemTrashFolderType</CODE></LI><LI><CODE>kSystemPreferencesFolderType</CODE></LI></UL><P>Additionally, there are new constants defined to locatethe User's folders:</P><UL><LI><CODE>kUsersFolderType</CODE>: "Users"folder, contains one folder for each user.</LI><LI><CODE>kCurrentUserFolderType</CODE>: The folder forthe currently logged on user.</LI><LI><CODE>kCurrentUserRemoteFolderLocation</CODE>: Theremote folder for the currently logged on user</LI><LI><CODE>kCurrentUserRemoteFolderType</CODE>: The remotefolder location for the currently logged on user</LI><LI><CODE>kSharedUserDataFolderType</CODE>: A Shared"Documents" folder, readable &amp; writable byall users</LI><LI><CODE>kVolumeSettingsFolderType</CODE>: Volumespecific user information goes here</LI></UL><P>However, location of those special folders isunfortunately not the last word of the story...</P><P><A HREF = "#top">Back to top</A></P><br><P><A NAME=Section2></A></P><H2>Not All Users are Equal</H2><P>After the boot process completes, Multiple Users displaysa login dialog. To login, a user must have an account(usually set up by the owner of the computer). The user mayhave to enter a password to login. While the login dialog isdisplayed, background-only applications (i.e., type<CODE>'appe'</CODE>, or any application with thebackground-only bit set in the <CODE>SIZE</CODE> resource)are allowed to run, but normal applications are not.</P><P>When the user is finished, they choose <B>Logout</B> fromthe <B>Special</B> menu. This begins the logout process.First, all normal applications are sent quit Apple Eventsuntil they quit. (Note that once the user has confirmed thelogout, there is no way to abort it&emdash;an applicationwill be sent a quit event every few seconds until itactually quits.) Next, a logout notification is sent to allregistered programs. Finally, the Folder Manager is told tostop redirecting the per-user folders. Once logout iscomplete, the login dialog is displayed.</P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>      If the user chooses <B>Restart</B> or      <B>Shutdown</B> from the <B>Special</B> menu, the      logout notifications will also occur in the same      manner.</P></TD></TR></TABLE></CENTER><BR><BR><P>Applications usually need to write two different kinds ofdata: the user data, such as documents, or user'spreferences, and application data, such as hardwareconfiguration, or dictionaries. The former typically needsto be stored in one of the redirected folder, the latterneeds a non-redirected folder. The problem comes from thefact that some environments (Limited and Panels) will forbidwrite-access to all non-redirected folders but one: theApplication Support folder that you can locate through theconstant: <CODE>kApplicationSupportFolderType</CODE>.</P><P>Therefore, if your application is currently writing datain any other folder, you will have to make that change inorder to be compatible with the Multiple Users technology.In particular, as with Netboot, you can't even be surethat your application's folder is going to bewritable.</P><P>To determine if you have write access to a given folder,check the <CODE>ioACUser</CODE> field in the<CODE>CInfoPBRec</CODE> struct after a call to<CODE>PBGetCatInfo</CODE>. There is one exception to thatrule, though. To provide some level of security for theApplication Support folder and its subfolders and to preventthe Finder, Panels, Standard File Package, and NavigationServices to write to the Application Support folder, andsince those processes check for it,<CODE>PBGetCatInfo</CODE> will always return that youdon't have write access to those folders. But, in fact,just for those folders, and since most of the currentapplications never bother to check the permissions first,you can write to them. That means that you should alwayscheck for write permission for a folder except for theApplication Support folder and its subfolders.</P><P>Or, if you prefer, do not check in advance if you canwrite to a folder, but be ready to handle<CODE>afpAccessDenied</CODE> (<CODE>-5000</CODE>) errorswhen you attempt to read from or write to any folder.</P><P>You also have to pay attention to the<CODE>foundVRefNum</CODE> value returned by<CODE>FindFolder</CODE> because it may not be the same asthe <CODE>vRefNum</CODE> value you passed in. Some of theredirected folders may be on another volume and even on aremote volume. So always use both the<CODE>foundVRefNum</CODE> and <CODE>foundDirID</CODE> valuesreturned.</P><P><A HREF = "#top">Back to top</A></P><br><P><A NAME=Section3></A></P><H2>Not All Applications are Equal</H2><P>If you're writing a classic Macintosh application, asidefrom using <CODE>FindFolder</CODE> to locate the folders youneed and checking the write access of those folders,it's business as usual. The Multiple Users technologyredirects the folders and that's fairly transparent.These applications never "see" the login, and theyreceive the <CODE>'quit'</CODE> Apple Event whenever thereis a logout.</P><P>But if you're writing a background-only application (type<CODE>'appe'</CODE>) or some kind of system extension whichis always loaded, then you have to be aware of thelogin/logouts as they occur.</P><P>All the following APIs are found in Folders.h.</P><P>You can register for the following notifications:</P>      <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>kFolderManagerNotificationMessageUserLogIn</pre></TD></TR></TABLE></CENTER><BR><BR>  <P>Sent when a user has logged in. When you receive thismessage <CODE>FindFolder</CODE> will return the<CODE>vRefNum</CODE> and <CODE>dirID</CODE> of theuser's redirected folders (see list of redirectedfolders, above) until the user logs out. This message can beused to load the new user's preferences.</p><BR>      <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>kFolderManagerNotificationMessagePreUserLogIn</pre></TD></TR></TABLE></CENTER><BR><BR> <P>Sent just prior to redirecting <CODE>FindFolder</CODE> tothe user's folders. Calling <CODE>FindFolder</CODE>when receiving this notification will return the<CODE>vRefNum</CODE> and <CODE>dirID</CODE> of the systemfolders. This message can be used to update the owner'spreference files prior to <CODE>FindFolder</CODE> beingredirected.</p><BR>      <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>kFolderManagerNotificationMessageUserLogOut</pre></TD></TR></TABLE></CENTER><BR><BR>   <P>Sent when a user has logged out. This is the last time<CODE>FindFolder</CODE> will return user'sfolders&emdash;after this notification<CODE>FindFolder</CODE> will return the <CODE>vRefNum</CODE>and <CODE>dirID</CODE> of system folders. This message canbe used to update a user's preference files duringlogout.</p><BR>      <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>kFolderManagerNotificationMessagePostUserLogOut</pre></TD></TR></TABLE></CENTER><BR><BR>  <P>Sent just after <CODE>FindFolder</CODE> has been restoredto return the <CODE>vRefNum</CODE> and <CODE>dirID</CODE> ofsystem folders. This message can be used to load theowner's preferences.</p><BR><P>Use the following APIs to register and unregister yournotifications:</P>      <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>OSErr FolderManagerRegisterNotificationProc(FolderManagerNotificationUPP notifyProc,void * refCon,UInt32 options);OSErr FolderManagerUnregisterNotificationProc(FolderManagerNotificationUPP notifyProc,void * refCon);</pre></TD></TR></TABLE></CENTER><BR><BR><P>Use <CODE>FolderManagerRegisterNotificationProc</CODE> toregister your notification function with the Folder Manager.The <CODE>notifyProc</CODE> parameter is the pointer or UPPto your notification function. The <CODE>refCon</CODE>parameter is for your own use&emdash;this value will bepassed to your notification function each time it is called.The options parameter specifies registration options.</P><P>Currently, the only option is specified by the<CODE>kDoNotRemoveWhenCurrentApplicationQuitsBit</CODE>constant. By setting this bit, you tell the Folder Managerto not remove your notification function when the currentapplication quits. Otherwise, a notification functionregistered within an application's context will beautomatically removed when that application quits. Programsthat register notifications at system startup should setthis bit. Most likely you will need to set this bit, sinceapplications won't normally need to receive FolderManager notifications.</P><P>Use <CODE>FolderManagerUnregisterNotificationProc</CODE>to remove your notification function from the FolderManager's queue. The <CODE>notifyProc</CODE> parameteris the pointer or UPP to your notification function that youpassed to the<CODE>FolderManagerRegisterNotificationProc</CODE> function.The <CODE>refCon</CODE> parameter should be the same valuethat you passed to the<CODE>FolderManagerRegisterNotificationProc</CODE>function.</P><P>The prototype of your notification function shouldbe:</P>      <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>typedef OSStatus (*FolderManagerNotificationProcPtr)(OSType message,void * arg,void * userRefCon);</pre></TD></TR></TABLE></CENTER><BR><BR><P>This function will be called for all Folder Managernotifications. The message parameter will contain the typeof notification (user login, user logout, etc.), the<CODE>arg</CODE> parameter will contain a pointer toadditional information (if any), and the<CODE>userRefCon</CODE> parameter is a value provided whenthe function was registered. The <CODE>userRefCon</CODE> isfor your own use and can be any value you want (such as apointer to your globals or other state information).</P><P>In the case of the four notifications cited above, thearg parameter is a pointer to a<CODE>FindFolderUserRedirectionGlobals structure</CODE>:</P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>struct <CODE>FindFolder</CODE>UserRedirectionGlobals {    UInt32 version;    UInt32 flags;    Str31  userName;    short  userNameScript;    short  currentUserFolderVRefNum;    long   currentUserFolderDirID;    short  remoteUserFolderVRefNum;    long   remoteUserFolderDirID;};</pre></TD></TR></TABLE></CENTER><BR><BR><P>There is an additional fifth notification which is verydifferent from the first four and will be of use only to afew developers:</P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>kFolderManagerNotificationDiscardCachedData</pre></TD></TR></TABLE></CENTER><BR><BR><P>Sent by third-party software when the entire FolderManager cache should be flushed</P><P>In that case, <CODE>arg</CODE> is undefined.</P><P><A HREF = "#top">Back to top</A></P><br><P><A NAME=Section4></A></P><H2>Is Multiple Users Installed?</H2><P>If you wish to be more than just compatible with theMultiple Users technology then it is crucial to know whetherit is installed on your users system of not. In order tocheck, use the <CODE>Gestalt</CODE> API and the definedconstant <CODE>gestaltMultipleUsersState</CODE>(<CODE>'mfdr'</CODE>):</P>      <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>GestaltRecHand result;if ( Gestalt(gestaltMultipleUsersState, (long*) &amp;result) == noErr &amp;&amp;     (*result)-&gt;giVersion &gt; 0)      {      // do stuff      }</pre></TD></TR></TABLE></CENTER><BR><BR><P>Note that the result of the <CODE>Gestalt</CODE> call isa handle to the following structure. Do <B>not</B> disposeof this handle.</P><P>The current version of the <CODE>GestaltRecHand</CODE>structure for Multiple Users is 6(<CODE>gestaltMultipleUsersStateVers</CODE>) and thestructure itself is defined as:</P>      <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>#pragma options align=mac68ktypedef struct { // gestalt info structure // Version 1 fields. shortgiVersion;  // structure version;   // (0 = invalid) shortgiReserved0;// [OBSOLETE] shortgiReserved1;// [OBSOLETE] shortgiReserved2;// [OBSOLETE] shortgiReserved3;// [OBSOLETE] FSSpec        giReserved4;// [OBSOLETE] // Version 2 fields. shortgiDocsVRefNum; // vrefnum of user's documents   // location (only valid if not   // on floppy) long giDocsDirID;// directory id of user's   // documents folder (only valid   // if not on floppy) shortgiForceSaves;  // true if user is forced to   // save to their documents   // folder shortgiForceOpens;  // true if user is forced to   // open from their documents   // folder Str31giWorkgroupName;        // name of current workgroup   // (for Macintosh Manager) Str31giUserName; // name of current user Str31giFrontAppName;// name of the frontmost   // application shortgiReserved5;// [OBSOLETE] shortgiIsOn;     // true if Multiple Users or   // Macintosh Manager is on   // right now // Version 3 fields. - There were no additional fields for version 3 // Version 4 fields. shortgiUserLoggedInType;     // logged in user type char giUserEncryptPwd[16];   // encrypted user password   // (our digest form) shortgiUserEnvironment;      // environment that user has   // logged into long giReserved6;// [OBSOLETE] long giReserved7;// [OBSOLETE] Boolean       giDisableScrnShots;     // true if screen shots are not   // allowed // Version 5 fields. Boolean       giSupportsAsyncFSCalls; // Finder uses this to tell if   // our patches support async   // trap patches shortgiPrefsVRefNum;// vrefnum of preferences long giPrefsDirID;  // dirID of the At Ease Items   // folder on preferences volume unsigned long giUserLogInTime;        // time in seconds when user   // logged in (0 or 1 mean not   // logged in) Boolean       giUsingPrintQuotas;     // true if logged in user is   // using printer quotas Boolean       giUsingDiskQuotas;      // true if logged in user has   // disk quotas active // Version 6 fields Boolean       giInSystemAccess;       // true if system is in System   // Access (i.e., owner logged   // in) Boolean       giUserFolderEnabled;    // true if <CODE>FindFolder</CODE> is   // redirecting folders (uses   // giUserName for user) shortgiReserved8;// [OBSOLETE] long giReserved9;// [OBSOLETE] Boolean       giInLoginScreen;        // true if no user has logged   // in (including owner) // // May have more fields added in future, // so never check for sizeof(GestaltRec) //} GestaltRec, *GestaltRecPtr, **GestaltRecHand;#pragma options align=reset// Possible values for giUserLoggedInType// (only applicable for AEFW/MM, not Multiple Users)enum { kMUUserTypeNormal      = 0, // default is a normal user kMUUserTypeWGAdmin     = 1, // Workgroup Administrator type kMUUserTypeGlobalAdmin = 2  // Global Administrator type (superuser)};// Possible values for giUserEnvironmentenum { kMUEnvironmentPanels       = 0, // Panels environment kMUEnvironmentFinder       = 1, // Normal (or Unrestricted Finder)// environment kMUEnvironmentFinderSecure = 2  // Limited (or Restricted Finder)// environment}; </pre></TD></TR></TABLE></CENTER><BR><BR><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>      At Ease and the Macintosh Manager also register the      <CODE>'mfdr' Gestalt</CODE> constant but use      earlier versions of the <CODE>GestaltRec</CODE>      structure. Be sure to always check its version      (<CODE>giVersion</CODE>) field before accessing the      other fields.</P></TD></TR></TABLE></CENTER><BR><BR><P><A HREF = "#top">Back to top</A></P><br><P><A NAME=Section5></A></P><H2>Is Multiple Users Running?</H2><P>In order to determine whether Multiple Users is active onyour users machine, check for the existence of the MultipleUsers <CODE>Gestalt</CODE> and look at the<CODE>giIsOn</CODE> field to see if Multiple Users isactive.</P>      <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>Boolean IsMultipleUsersOn (void){ GestaltRecHand result; if (Gestalt (gestaltMultipleUsersState, (long *) &amp;result) == noErr &amp;&amp;     (*result)-&gt;giVersion &gt;= 2 &amp;&amp; (*result)-&gt;giIsOn)     return true; else     return false;}</pre></TD></TR></TABLE></CENTER><BR><BR><P><A HREF = "#top">Back to top</A></P><br><P><A NAME=Section6></A></P><H2>Who is Logged In?</H2><P><B>How can I tell if no user is currently loggedin?</B></P><P>You should make sure Multiple Users is active and thenlook at the <CODE>giInLoginScreen</CODE> field to see if themachine is currently in the login screen. Or register yournotification function, and in between a login notificationand a logout notification, you know that a user is loggedin.</P><P><B>How can I tell if a User other than the Owner islogged in?</B></P><P>Use the <CODE>Gestalt</CODE> API as described above. If<CODE>giUserLogInTime</CODE> is &gt; 1 then a User otherthan the Owner is logged in. If the Owner is logged in, then<CODE>giUserLogInTime</CODE> will be 0 and<CODE>giInSystemAccess</CODE> will be true.</P>      <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>Boolean IsUserLoggedIn (void){ GestaltRecHand result; if (Gestalt (gestaltMultipleUsersState, (long *) &amp;result) == noErr &amp;&amp;     (*result)-&gt;giVersion &gt;= 5 &amp;&amp; (*result)-&gt;giIsOn &amp;&amp;     (*result)-&gt;giUserLogInTime &gt; 1)     return true; else     return false;}</pre></TD></TR></TABLE></CENTER><BR><BR>  <P><A HREF = "#top">Back to top</A></P><br><P><A NAME=Section7></A></P><H2>User Names and Passwords</H2><P>Many developers may be interested in knowing what theiruser's name and password are, and how secure thepassword is.</P><P>In order to get the user name, check the<CODE>giUserLoginTime</CODE> field to make sure it'sgreater than 1. If so, then check the<CODE>giUserName</CODE> field to obtain the user'sname. Alternatively, you can register your notificationfunction and catch the login notification, which willindicate the user name in the<CODE>FindFolderUserRedirectionGlobals</CODE>. However, youshould note that when the owner logs in, the globalsstructure will indicate an empty string for the user name inthis case.</P>      <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>void GetUserName (Str255 userName){ GestaltRecHand result; userName [0] = 0; if (Gestalt (gestaltMultipleUsersState, (long *) &amp;result) == noErr &amp;&amp;     (*result)-&gt;giVersion &gt;= 5 &amp;&amp; (*result)-&gt;giIsOn &amp;&amp;     (*result)-&gt;giUserLogInTime &gt; 1)     BlockMoveData ((*result)-&gt;giUserName, userName,        (*result)-&gt;giUserName [0] + 1);}</pre></TD></TR></TABLE></CENTER><BR><BR>      <P>With regards to the security of the password, it isstored hashed in the Multiple User database and is never ina form that can be decrypted.</P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>The user's password is not      available.</P></TD></TR></TABLE></CENTER><BR><BR>  <P><A HREF = "#top">Back to top</A></P><br><A NAME=Section8></A><H2>Additional Notes &amp; Warnings</H2><UL><LI>If you are a good NetBoot citizen (see <A HREF = "tn1151.html">Technote1151</A>) then you have a good chance to be a goodMultiple Users citizen.<BR><BR></LI><LI>The following is not a Multiple Users problem per sebut is important to all applications. The very firstapplication launched by the system after the boot can beeither the Finder, At Ease, Login, or Panels and isreferred hereby as the shell:<UL type=CIRCLE>   <LI>Some processes are allocating memory to store data   or code in the shell's heap, or in some cases,   the heap of the first process to launch, or making a   copy of state variables, such as the <CODE>A5</CODE>   value of this other process.</LI>      <LI>Usually, this particular process is the Finder and   it does not go away until the User chooses   <B>Restart</B> or <B>Shut Down</B> which is why this   practice hasn't been a huge problem in the   past.<BR>   </LI>      <LI>When Multiple Users is running, the shell or the   first process to launch is going to go away as soon as   the User logs in.</LI>      <LI>So any memory allocated in that heap is going to   be purged. If data is stored there, it's going to   be lost, if code is stored there, it's going to   cause a crash as soon as the process who installed it   is going to try to execute it.</LI>      <LI>Therefore, allocate memory only in your heap if   it's going to be around long enough, or in the   System heap if you can't help it but do NOT   allocate memory in the shell or in the first process   to launch any more and do not assume that you can keep   a valid copy of state variables of this process.</LI></UL></LI><LI>When using Macintosh Manager, the Preferences folderis redirected to a server volume. All connected machinesmay not be using the same version of a particularapplication. The different versions of that applicationmay be using a different preferences file format. Thatfile is going to be rewritten each time by the differentversions. That file is also going to be read by thedifferent versions. That means that the application hasto be ready to deal gracefully, not only with previousformats but also with newer formats.</LI></UL>      <P><A HREF = "#top">Back to top</A></P><br><P><A NAME=Summary></A></P><H2>Summary</H2><P>To be compatible with the Multiple Users technology,always use the <CODE>FindFolder</CODE> API (using allreturned values) and either be ready to handle<CODE>afpAccessDenied</CODE> (<CODE>-5000</CODE>) errorswhen you attempt I/O calls, or test beforehand theread/write permission of the folder. Additionally, do notassume that the Finder is always running, or that any Finderinformation you got at one time is still valid later on.</P><P>To take advantage of the Multiple Users technology,register the new notification functions, and use the Gestaltcall with the <CODE>gestaltMultipleUsersState</CODE>parameter.</P><a name="References"></a><H2>References</H2><p><A HREF = "tn1151.html">Technote 1151: Creating NetBootServer-Friendly Applications</A></p><p><A HREF = "tn1134.html">Technote 1134: The PreferencesProblem</A></p><p><A HREF = "#top">Back to top</a> </p><BR><A NAME="Downloads"></A> <h2>Downloadables</h2><center><TABLE BORDER=0 CELLPADDING=3 WIDTH="600"> <TR> <td width=50 align=left>   <P ALIGN=center><img src="images/acrobatsmall.gif" align=middle alt="Acrobat" width=22 height=23></P></TD><td align="left">   <p>Acrobat version of this Note (116K).</P></TD><td width=60 align=left>   <p><A HREF="pdf/tn1186.pdf">Download</A></P></TD>  </TR> </table></center><BR><BR><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1186.html%3Fid%3DDTS10003025-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1186.html%3Fid%3DDTS10003025-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1186.html%3Fid%3DDTS10003025-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>