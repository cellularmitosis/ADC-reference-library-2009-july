<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Mass Storage Device Driver Programming Guide: Subclassing Logical Unit Drivers</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Subclassing Logical Unit Drivers"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30000737" title="Subclassing Logical Unit Drivers"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../../HardwareDrivers/index.html#//apple_ref/doc/uid/TP30000440-TP40003576" target="_top">Hardware &amp; Drivers</a> &gt; <a href="../../../../HardwareDrivers/MassStorageDevices-date.html#//apple_ref/doc/uid/TP30000440-TP40003576-TP30001039" target="_top">Storage</a> &gt; <a href="../01_Introduction/Introduction.html#//apple_ref/doc/uid/TP30000733-TPXREF101">Mass Storage Device Driver Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../05_Universal_Binary/MS_UniversalBinary.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../07_SCSI_Example/MS_SCSI_Example.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30000737-SW1" title="Subclassing Logical Unit Drivers"></a><h1><a name="//apple_ref/doc/uid/TP30000737-TPXREF101" title="Subclassing Logical Unit Drivers"></a>Subclassing Logical Unit Drivers</h1><p><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_262"></a><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_263"></a><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_264"></a>The SCSI Architecture Model defines several shared command set specifications, each associated with a peripheral device type. These specifications document how SCSI commands are processed by a device’s firmware. If your device does not conform with the shared command set specification for its peripheral device type in some way, either because it processes commands differently or because it services additional commands, you need to subclass the appropriate Apple logical unit driver to provide the support your device requires.</p><div class="importantbox"><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_9" title="Important:"></a><p><strong>Important:</strong>&nbsp;Do not send <code>READ</code> or <code>WRITE</code> commands from your custom logical unit driver to a device. If you send these commands, you open a security hole that malicious code can take advantage of by using your driver to read or destroy data on a device that the user has protected by setting access permissions.</p><p></p></div><p>This chapter describes how to subclass an Apple-provided logical unit driver to address SCSI command set implementation issues. The sample code in this chapter is generic and emphasizes the form your driver should take, rather than the code required to implement a specific command. Because the sample drivers are generic, they will not attach to a particular device. To test them with your device, replace the generic values for parameters such as vendor or product identification with values that identify your device. For more information on how to develop kernel extensions in general and I/O Kit drivers in particular, see <em><a href="../../../../Darwin/Conceptual/KEXTConcept/index.html#//apple_ref/doc/uid/TP40001063" target="_top">Kernel Extension Programming Topics</a></em> and <em><a href="../../WritingDeviceDriver/index.html#//apple_ref/doc/uid/TP30000694" target="_top">I/O Kit Device Driver Design Guidelines</a></em>.</p><p>This chapter also contains code that shows how your driver can use a <code>SCSITask</code> object to send a command to a device and how to use the SCSI Architecture Model family’s command-builder functions to build a custom CDB.</p><div class="importantbox"><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_10" title="Important:"></a><p><strong>Important:</strong>&nbsp;The sample code in this chapter is designed to work with Mac OS X version 10.1 and later. It will not work with earlier versions.</p><p></p></div>
<!-- This template is being used for both PDF and HTML. -->

    
    <h4>In this section:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="MS_LUD_Example.html#//apple_ref/doc/uid/TP30000737-TPXREF102">Setting Up Your Project</a>
				
			<br/>
			
        
			
			
				<a href="MS_LUD_Example.html#//apple_ref/doc/uid/TP30000737-TPXREF105">Creating Your Driver</a>
				
			<br/>
			
        
			
			
				<a href="MS_LUD_Example.html#//apple_ref/doc/uid/TP30000737-TPXREF108">Testing Your Driver</a>
				
			<br/>
			
        
			
			
				<a href="MS_LUD_Example.html#//apple_ref/doc/uid/TP30000737-DontLinkElementID_6">Creating and Sending SCSI Commands</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP30000737-TPXREF102" title="Setting Up Your Project"></a><h2>Setting Up Your Project</h2><p>This section describes how to create your driver project and edit your driver’s information property list (<code>Info.plist</code> file). The sample driver in this chapter is a logical unit driver for a generic CD-ROM device so it is a subclass of the Apple-provided <code>IOSCSIPeripheralDeviceType05</code> driver.</p><p>The sample project uses <code>MyLogicalUnitDriver</code> for the name of the driver and generic values such as <code>MySoftwareCompany</code> for the developer name. You should replace these names and values with your own information in order to test this code with your device.</p><a name="//apple_ref/doc/uid/TP30000737-TPXREF103" title="Create a New Project"></a><h3>Create a New Project</h3><p>Open the Xcode application and create a new I/O Kit driver project named <code>MyLogicalUnitDriver</code>. Specify a directory for the new project or accept the default.</p><p>When you create a new I/O Kit driver project, Xcode supplies several files, including two empty source files—<code>MyLogicalUnitDriver.h</code> and <code>MyLogicalUnitDriver.cpp</code>. Before you add any code to these files, however, you should edit your driver’s information property list.</p><a name="//apple_ref/doc/uid/TP30000737-TPXREF104" title="Edit Your Driver&acirc;&#128;&#153;s Property List"></a><h3>Edit Your Driver’s Property List</h3><p><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_265"></a><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_266"></a><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_267"></a>Every driver has an <code>Info.plist</code> file that contains information about the driver and what it needs, including its personalities. As described in <span class="content_text"><a href="../04_Matching/MS_Matching.html#//apple_ref/doc/uid/TP30000736-BBIDJJGD">“Driver Personalities and the Matching Process,”</a></span> a driver’s personality contains the matching information the I/O Kit uses to determine the appropriate driver for a device. To make sure your driver loads for your device, you add several properties to its personality dictionary that identify the device or type of device it supports.</p><p>In Xcode, a driver’s <code>Info.plist</code> file is listed in the Groups &amp; Files view in the project. You can edit the property list file as plain XML text in the Xcode editor window or you can choose a different application (such as Property List Editor) to use. For more information on how to select another editor, see <span class="content_text"><a href="../../../../Darwin/Conceptual/KEXTConcept/KEXTConceptIOKit/hello_iokit.html#//apple_ref/doc/uid/20002366" target="_top">Hello I/O Kit: Creating a Driver With Xcode</a></span>.</p><p><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_268"></a>The <code>IOKitPersonalities</code> dictionary in the driver’s <code>Info.plist</code> file can contain multiple personality dictionaries, one for each device or type of device your driver supports. The sample driver in this chapter implements only one personality dictionary but you can create additional dictionaries if your driver can support more than one device or device type.</p><p>The sample code uses the following six property keys:</p><ul class="spaceabove"><li class="li"><p><code>CFBundleIdentifier</code></p></li><li class="li"><p><code>IOClass</code></p></li><li class="li"><p><code>IOProviderClass</code></p></li><li class="li"><p><code>Peripheral Device Type</code></p></li><li class="li"><p><code>Vendor Identification</code></p></li><li class="li"><p><code>Product Identification</code></p></li></ul><p>If you are developing a driver for a particular version of your device, you can add the product revision identification key to the personality for even more specific matching.</p><p>Using your chosen editing environment, create a new child of the <code>IOKitPersonalities</code> dictionary. Make the name of this new child <code>MyLogicalUnitDriver</code> and set its class to Dictionary.</p><p>Create six new children of the <code>MyLogicalUnitDriver</code> dictionary, one for each of the six properties you’ll be adding. <span class="content_text"><a href="MS_LUD_Example.html#//apple_ref/doc/uid/TP30000737-CAHFJDDE">Table 5-1</a></span> shows the properties, along with their classes and values. To test the sample code with your device, replace values such as <code>MyProductIdentification</code> with actual values for your device.</p><a name="//apple_ref/doc/uid/TP30000737-CAHFJDDE" title="Table 5-1Personality properties for MyLogicalUnitDriver"></a><div class="tableholder"><table class="graybox" border = "0" cellspacing="0" cellpadding="5"><caption class="tablecaption"><strong>Table 5-1&nbsp;&nbsp;</strong>Personality properties for MyLogicalUnitDriver</caption><tr><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Property</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Class</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Value</p></th></tr><tr><td  scope="row"><p><code>CFBundleIdentifier</code></p></td><td ><p>String</p></td><td ><p><code>com.MySoftwareCompany.driver.MyLogicalUnitDriver</code></p></td></tr><tr><td  scope="row"><p><code>IOClass</code></p></td><td ><p>String</p></td><td ><p><code>com_MySoftwareCompany_driver_MyLogicalUnitDriver</code></p></td></tr><tr><td  scope="row"><p><code>IOProviderClass</code></p></td><td ><p>String</p></td><td ><p><code>IOSCSIPeripheralDeviceNub</code></p></td></tr><tr><td  scope="row"><p><code>Peripheral Device Type</code></p></td><td ><p>Number</p></td><td ><p><code>5</code></p></td></tr><tr><td  scope="row"><p><code>Vendor Identification</code></p></td><td ><p>String</p></td><td ><p><code>MyProductIdentification</code></p></td></tr><tr><td  scope="row"><p><code>Product Identification</code></p></td><td ><p>String</p></td><td ><p><code>MyVendorIdentification</code></p></td></tr></table></div><p><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_269"></a>A driver declares its dependencies on other loadable kernel extensions and in-kernel components in the <code>OSBundleLibraries</code> dictionary. Each dependency has a string value that declares the earliest version of the dependency the driver is compatible with.</p><p>The sample driver depends on two loadable extensions from the <code>IOSCSIArchitectureModel</code> family. To add these dependencies to the <code>OSBundleLibraries</code> dictionary, you create a new child for each dependency. <span class="content_text"><a href="MS_LUD_Example.html#//apple_ref/doc/uid/TP30000737-CAHIDEDD">Table 5-2</a></span> shows the dependencies you add for the sample driver.</p><a name="//apple_ref/doc/uid/TP30000737-CAHIDEDD" title="Table 5-2Dependencies for MyLogicalUnitDriver"></a><div class="tableholder"><table class="graybox" border = "0" cellspacing="0" cellpadding="5"><caption class="tablecaption"><strong>Table 5-2&nbsp;&nbsp;</strong>Dependencies for MyLogicalUnitDriver</caption><tr><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Property</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Class</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Value</p></th></tr><tr><td  scope="row"><p><code>com.apple.iokit.IOSCSIArchitectureModelFamily</code></p></td><td ><p>String</p></td><td ><p><code>1.0.0</code></p></td></tr><tr><td  scope="row"><p><code>com.apple.iokit.IOSCSIMultimediaCommandsDevice</code></p></td><td ><p>String</p></td><td ><p><code>1.0.0</code></p></td></tr></table></div><p>Because the driver of a CD-ROM drive must be able to mount root on a local volume, you add the <code>OSBundleRequired</code> property to the top level of its <code>Info.plist</code> file. In other words, the new <code>OSBundleRequired</code> property is a sibling of the <code>IOKitPersonalities</code> and <code>OSBundleLibraries</code> dictionaries, not a child. Edit the new element to match the following: <a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_270"></a><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_271"></a><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_272"></a></p><div class="codesample"><table><tr><td scope="row"><pre>OSBundleRequired        String  Local-Root<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000737-TPXREF105" title="Creating Your Driver"></a><h2>Creating Your Driver</h2><p>This section describes some of the elements that must be included in your driver’s source files. To demonstrate the process of subclassing, the sample driver simply overrides the <code>GetConfiguration</code> method and prints a message. You should replace this trivial function with your own code that supports your device’s particular command implementations.</p><p>In Xcode, the driver’s source files are listed in the Groups &amp; Files pane, revealed by the discosure triangle next to the <code>MyLogicalUnitDriver</code> project and the disclosure triangle next to the Source folder.</p><a name="//apple_ref/doc/uid/TP30000737-TPXREF106" title="Edit the Header File"></a><h3>Edit the Header File</h3><p>The header file provides access to external declarations and supporting type definitions needed by the functions and objects in the C++ file. The header for the sample driver is simple because it includes only one method declaration. Edit the <code>MyLogicalUnitDriver.h</code> file to match the code in <span class="content_text"><a href="MS_LUD_Example.html#//apple_ref/doc/uid/TP30000737-CJDJIGJB">Listing 5-1</a></span>.</p><a name="//apple_ref/doc/uid/TP30000737-CJDJIGJB" title="Listing 5-1The MyLogicalUnitDriver header file"></a><p class="codesample"><strong>Listing 5-1&nbsp;&nbsp;</strong>The MyLogicalUnitDriver header file</p><div class="codesample"><table><tr><td scope="row"><pre>#ifndef _MyLogicalUnitDriver_H_<span></span></pre></td></tr><tr><td scope="row"><pre>#define _MyLogicalUnitDriver_H_<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Because the sample driver is a subclass of the Apple-provided<span></span></pre></td></tr><tr><td scope="row"><pre>// peripheral device type 05 driver, it must include that driver's<span></span></pre></td></tr><tr><td scope="row"><pre>// header file.<span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;IOKit/scsi-commands/IOSCSIPeripheralDeviceType05.h><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Here, the sample driver declares its inheritance and the method<span></span></pre></td></tr><tr><td scope="row"><pre>// it overrides.<span></span></pre></td></tr><tr><td scope="row"><pre>class com_MySoftwareCompany_driver_MyLogicalUnitDriver : public<span></span></pre></td></tr><tr><td scope="row"><pre>        IOSCSIPeripheralDeviceType05<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSDeclareDefaultStructors (<span></span></pre></td></tr><tr><td scope="row"><pre>                com_MySoftwareCompany_driver_MyLogicalUnitDriver )<span></span></pre></td></tr><tr><td scope="row"><pre>protected:<span></span></pre></td></tr><tr><td scope="row"><pre>    virtual IOReturn GetConfiguration ( void );<span></span></pre></td></tr><tr><td scope="row"><pre>};<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>#endif /* _MyLogicalUnitDriver_H_ */<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000737-TPXREF107" title="Edit the C++ File"></a><h3>Edit the C++ File</h3><p>The C++ file provides the code to override the chosen methods. The sample driver’s C++ file contains all the elements required for a subclassed driver even though it accomplishes nothing more substantial than a message sent to the system log file, <code>/var/log/system.log</code>.</p><p>Edit the <code>MyLogicalUnitDriver.cpp</code> file to match the code in <span class="content_text"><a href="MS_LUD_Example.html#//apple_ref/doc/uid/TP30000737-CJDJJBDG">Listing 5-2</a></span>.</p><a name="//apple_ref/doc/uid/TP30000737-CJDJJBDG" title="Listing 5-2The MyLogicalUnitDriver C++ file"></a><p class="codesample"><strong>Listing 5-2&nbsp;&nbsp;</strong>The MyLogicalUnitDriver C++ file</p><div class="codesample"><table><tr><td scope="row"><pre>// Include the header file you created<span></span></pre></td></tr><tr><td scope="row"><pre>#include "MyLogicalUnitDriver.h"<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// This definition allows you to use the more convenient "super" in<span></span></pre></td></tr><tr><td scope="row"><pre>// place of "IOSCSIPeripheralDeviceType05", where appropriate.<span></span></pre></td></tr><tr><td scope="row"><pre>#define super IOSCSIPeripheralDeviceType05<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// This macro must appear before you define any of your class's methods.<span></span></pre></td></tr><tr><td scope="row"><pre>// Note that you must use the literal name of the superclass here, not<span></span></pre></td></tr><tr><td scope="row"><pre>// "super" as defined above.<span></span></pre></td></tr><tr><td scope="row"><pre>OSDefineMetaClassAndStructors (<span></span></pre></td></tr><tr><td scope="row"><pre>        com_MySoftwareCompany_driver_MyLogicalUnitDriver,<span></span></pre></td></tr><tr><td scope="row"><pre>        IOSCSIPeripheralDeviceType05 );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Define the method to override.<span></span></pre></td></tr><tr><td scope="row"><pre>IOReturn<span></span></pre></td></tr><tr><td scope="row"><pre>com_MySoftwareCompany_driver_MyLogicalUnitDriver::GetConfiguration ( void )<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    IOLog( "MyLogicalUnitDriver overriding GetConfiguration\n" );<span></span></pre></td></tr><tr><td scope="row"><pre>// You can add code that accesses your device here.<span></span></pre></td></tr><tr><td scope="row"><pre>// Call super's GetConfiguration method before returning.<span></span></pre></td></tr><tr><td scope="row"><pre>    return super::GetConfiguration();<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000737-TPXREF108" title="Testing Your Driver"></a><h2>Testing Your Driver</h2><p>This section presents some advice on testing<a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_273"></a> your driver. You cannot use <code>kextload</code> to load and test your driver “by hand” because there are generic drivers that will always load in its place at boot time. Therefore, you need to make sure you have multiple bootable disks or partitions so you can remove your driver if it behaves badly and reboot the disk or partition.</p><p>Because the <code>OSBundleRequired</code> property in the sample driver’s <code>Info.plist</code> file is set to <code>Local-Root</code>, the BootX booter will automatically load it when the system is restarted (for more information on this process, see <span class="content_text"><a href="../../../../Darwin/Conceptual/KEXTConcept/KEXTConceptLoading/loading_kexts.html#//apple_ref/doc/uid/20002369" target="_top">Loading Kernel Extensions at Boot Time</a></span>).</p><p>For help with debugging, you can open a window in the Terminal application (located at <code>/Applications/Utilities/Terminal</code>) and type the following line to view the system log:<a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_274"></a><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_275"></a><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_276"></a></p><div class="codesample"><table><tr><td scope="row"><pre>tail -f /var/log/system.log<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_6" title="Creating and Sending SCSI Commands"></a><h2>Creating and Sending SCSI Commands</h2><p><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_277"></a><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_278"></a>As described in <span class="content_text"><a href="../02_Overview/MS_Overview.html#//apple_ref/doc/uid/TP30000734-BJGEJCJJ">“The Transport Driver Layer,”</a></span> a logical unit driver subclass creates a <code>SCSITask</code> object to contain a command descriptor block (or CDB) and various status indicators related to the execution of a SCSI command. To create a command to put into a <code>SCSITask</code> object, you can use the built-in command-creation functions or you can build a custom CDB. The built-in command-creation functions are appropriate when you need to send standard SCSI commands, such as <code><!--a-->INQUIRY<!--/a--></code>, <code><!--a-->TEST_UNIT_READY<!--/a--></code>, and <code><!--a-->REPORT_SENSE<!--/a--></code>. When you need to send a vendor-specific SCSI command, you use the <code><!--a target="_top" -->SetCommandDescriptorBlock<!--/a--></code> function to build an appropriately sized CDB. Note that <code><!--a-->SetCommandDescriptorBlock<!--/a--></code> and the built-in command-creation functions are defined in <code>IOSCSIPrimaryCommandsDevice.h</code>. The sample code in this section shows both ways to build and send SCSI commands.</p><p>The code in this section shows a simple logical unit driver for a block commands device, specifically, a subclass of <code>IOSCSIPeripheralDeviceType00</code>. It shows how to use one of the built-in command-creation functions and it demonstrates how to set up your own command-creation function to build a custom command. It also shows how to check the command response and the status of the <code>SCSITask</code> object. <span class="content_text">Listing 5-3</span> shows the header file for the sample driver.</p><a name="//apple_ref/doc/uid/TP30000737-SW2" title="Listing 5-3Header file for a driver that sends standard and custom SCSI commands"></a><p class="codesample"><strong>Listing 5-3&nbsp;&nbsp;</strong>Header file for a driver that sends standard and custom SCSI commands</p><div class="codesample"><table><tr><td scope="row"><pre>#ifndef _SampleINQUIRYDriver_H_<span></span></pre></td></tr><tr><td scope="row"><pre>#define _SampleINQUIRYDriver_H_<span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;IOKit/scsi/IOSCSIPeripheralDeviceType00.h><span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>class com_MySoftwareCompany_driver_SampleINQUIRYDriver : public IOSCSIPeripheralDeviceType00<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSDeclareDefaultStructors ( com_MySoftwareCompany_driver_SampleINQUIRYDriver )<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>protected:<span></span></pre></td></tr><tr><td scope="row"><pre>    bool    InitializeDeviceSupport ( void );<span></span></pre></td></tr><tr><td scope="row"><pre>    void    SendBuiltInINQUIRY ( void );<span></span></pre></td></tr><tr><td scope="row"><pre>    void    SendCreatedINQUIRY ( void );<span></span></pre></td></tr><tr><td scope="row"><pre>    bool    BuildINQUIRY ( SCSITaskIdentifier    request,<span></span></pre></td></tr><tr><td scope="row"><pre>                           IOBufferMemoryDescriptor *    buffer,<span></span></pre></td></tr><tr><td scope="row"><pre>                           SCSICmdField1Bit      CMDDT,<span></span></pre></td></tr><tr><td scope="row"><pre>                           SCSICmdField1Bit      EVPD,<span></span></pre></td></tr><tr><td scope="row"><pre>                           SCSICmdField1Byte     PAGE_OR_OPERATION_CODE,<span></span></pre></td></tr><tr><td scope="row"><pre>                           SCSICmdField1Byte     ALLOCATION_LENGTH,<span></span></pre></td></tr><tr><td scope="row"><pre>                           SCSICmdField1Byte     CONTROL );<span></span></pre></td></tr><tr><td scope="row"><pre>};<span></span></pre></td></tr><tr><td scope="row"><pre>#endif /* _SampleINQUIRYDriver_H_ */<span></span></pre></td></tr></table></div>	<p><span class="content_text">Listing 5-4</span> shows the implementation of the sample driver. Although there is some error handling shown, you should add more extensive error-handling code when you use this sample as the basis for an actual driver.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_11" title="Note"></a><p><strong>Note:</strong>&nbsp;The sample driver’s custom command-building function builds an <code>INQUIRY</code> command instead of a hypothetical custom command. In a real driver, you use a built-in command-building function to build a standard command such as <code>INQUIRY</code>; you do not write custom functions to build standard commands.</p></div><a name="//apple_ref/doc/uid/TP30000737-SW3" title="Listing 5-4Implementation of a driver that sends standard and custom SCSI commands"></a><p class="codesample"><strong>Listing 5-4&nbsp;&nbsp;</strong>Implementation of a driver that sends standard and custom SCSI commands</p><div class="codesample"><table><tr><td scope="row"><pre>#include &lt;IOKit/IOBufferMemoryDescriptor.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;IOKit/scsi/SCSICmds_INQUIRY_Definitions.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;IOKit/scsi/SCSICommandOperationCodes.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include &lt;IOKit/scsi/SCSITask.h><span></span></pre></td></tr><tr><td scope="row"><pre>#include "SampleINQUIRYDriver.h"<span></span></pre></td></tr><tr><td scope="row"><pre>#define super IOSCSIPeripheralDeviceType00<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>OSDefineMetaClassAndStructors ( com_MySoftwareCompany_driver_SampleINQUIRYDriver, IOSCSIPeripheralDeviceType00 );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>bool<span></span></pre></td></tr><tr><td scope="row"><pre>com_MySoftwareCompany_driver_SampleINQUIRYDriver::InitializeDeviceSupport ( void )<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    bool    result = false;<span></span></pre></td></tr><tr><td scope="row"><pre>    result = super::InitializeDeviceSupport ( );<span></span></pre></td></tr><tr><td scope="row"><pre>    if ( result == true ) {<span></span></pre></td></tr><tr><td scope="row"><pre>        SendBuiltInINQUIRY ( );<span></span></pre></td></tr><tr><td scope="row"><pre>        SendCreatedINQUIRY ( );<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>void<span></span></pre></td></tr><tr><td scope="row"><pre>com_MySoftwareCompany_driver_SampleINQUIRYDriver::SendBuiltInINQUIRY ( void )<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    // The Service Response represents the execution status of a service request.<span></span></pre></td></tr><tr><td scope="row"><pre>    SCSIServiceResponse                serviceResponse = kSCSIServiceResponse_SERVICE_DELIVERY_OR_TARGET_FAILURE;<span></span></pre></td></tr><tr><td scope="row"><pre>    IOBufferMemoryDescriptor *         buffer  = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    SCSITaskIdentifier                 request = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    UInt8 *                            ptr     = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    // Get a new IOBufferMemoryDescriptor object with a buffer large enough<span></span></pre></td></tr><tr><td scope="row"><pre>    // to hold the SCSICmd_INQUIRY_StandardData structure (defined<span></span></pre></td></tr><tr><td scope="row"><pre>    // in SCSICmds_INQUIRY_Definitions.h).<span></span></pre></td></tr><tr><td scope="row"><pre>    buffer = IOBufferMemoryDescriptor::withCapacity ( sizeof ( SCSICmd_INQUIRY_StandardData ), kIODirectionIn, false );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    require ( ( buffer != NULL ), ErrorExit );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Get the address of the beginning of the buffer and zero-fill the buffer.<span></span></pre></td></tr><tr><td scope="row"><pre>    ptr = ( UInt8 * ) buffer->getBytesNoCopy ( );<span></span></pre></td></tr><tr><td scope="row"><pre>    bzero ( ptr, buffer->getLength ( ) );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Create a new SCSITask object; if unsuccessful, release<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    request = GetSCSITask ( );<span></span></pre></td></tr><tr><td scope="row"><pre>    require ( ( request != NULL ), ReleaseBuffer );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Prepare the buffer for an I/O transaction. This call must be<span></span></pre></td></tr><tr><td scope="row"><pre>    // balanced by a call to the complete method (shown just before<span></span></pre></td></tr><tr><td scope="row"><pre>    // ReleaseTask).<span></span></pre></td></tr><tr><td scope="row"><pre>    require ( ( buffer->prepare ( ) == kIOReturnSuccess ), ReleaseTask );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Use the INQUIRY method to assemble the command. Then use the<span></span></pre></td></tr><tr><td scope="row"><pre>    // SendCommand method to synchronously issue the request.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if ( INQUIRY (  request,<span></span></pre></td></tr><tr><td scope="row"><pre>                    buffer,<span></span></pre></td></tr><tr><td scope="row"><pre>                    0,<span></span></pre></td></tr><tr><td scope="row"><pre>                    0,<span></span></pre></td></tr><tr><td scope="row"><pre>                    0x00,<span></span></pre></td></tr><tr><td scope="row"><pre>                    buffer->getLength ( ),<span></span></pre></td></tr><tr><td scope="row"><pre>                    0 ) == true )<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        serviceResponse = SendCommand ( request, kTenSecondTimeoutInMS );<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Check the SendCommand method's return value and the status of the SCSITask object.<span></span></pre></td></tr><tr><td scope="row"><pre>    if ( ( serviceResponse == kSCSIServiceResponse_TASK_COMPLETE ) &amp;&amp;<span></span></pre></td></tr><tr><td scope="row"><pre>           GetTaskStatus ( request ) == kSCSITaskStatus_GOOD )<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        IOLog ( "INQUIRY succeeded\n" );<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        IOLog ( "INQUIRY failed\n" );<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Complete the processing of this buffer after the I/O transaction<span></span></pre></td></tr><tr><td scope="row"><pre>    // (this call balances the earlier call to prepare).<span></span></pre></td></tr><tr><td scope="row"><pre>    buffer->complete ( );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>// Clean up before exiting.<span></span></pre></td></tr><tr><td scope="row"><pre>ReleaseTask:<span></span></pre></td></tr><tr><td scope="row"><pre>    require_quiet ( ( request != NULL ), ReleaseBuffer );<span></span></pre></td></tr><tr><td scope="row"><pre>    ReleaseSCSITask ( request );<span></span></pre></td></tr><tr><td scope="row"><pre>    request = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ReleaseBuffer:<span></span></pre></td></tr><tr><td scope="row"><pre>    require_quiet ( ( buffer != NULL ), ErrorExit );<span></span></pre></td></tr><tr><td scope="row"><pre>    buffer->release ( );<span></span></pre></td></tr><tr><td scope="row"><pre>    buffer = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ErrorExit:<span></span></pre></td></tr><tr><td scope="row"><pre>    return;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>void<span></span></pre></td></tr><tr><td scope="row"><pre>com_MySoftwareCompany_driver_SampleINQUIRYDriver::SendCreatedINQUIRY ( void )<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    SCSIServiceResponse                serviceResponse = kSCSIServiceResponse_SERVICE_DELIVERY_OR_TARGET_FAILURE;<span></span></pre></td></tr><tr><td scope="row"><pre>    IOBufferMemoryDescriptor *        buffer            = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    SCSITaskIdentifier                request            = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    UInt8 *                            ptr                = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Get a new IOBufferMemoryDescriptor object with a buffer large enough<span></span></pre></td></tr><tr><td scope="row"><pre>    // to hold the SCSICmd_INQUIRY_StandardData structure (defined in<span></span></pre></td></tr><tr><td scope="row"><pre>    // SCSICmds_INQUIRY_Definitions.h).<span></span></pre></td></tr><tr><td scope="row"><pre>    buffer = IOBufferMemoryDescriptor::withCapacity ( sizeof ( SCSICmd_INQUIRY_StandardData ), kIODirectionIn, false );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Return immediately if the buffer wasn't created.<span></span></pre></td></tr><tr><td scope="row"><pre>    require ( ( buffer != NULL ), ErrorExit );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Get the address of the beginning of the buffer and zero-fill the buffer.<span></span></pre></td></tr><tr><td scope="row"><pre>    ptr = ( UInt8 * ) buffer->getBytesNoCopy ( );<span></span></pre></td></tr><tr><td scope="row"><pre>    bzero ( ptr, buffer->getLength ( ) );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Create a new SCSITask object; if unsuccessful, release the buffer and return.<span></span></pre></td></tr><tr><td scope="row"><pre>    request = GetSCSITask ( );<span></span></pre></td></tr><tr><td scope="row"><pre>    require ( ( request != NULL ), ReleaseBuffer );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Prepare the buffer for an I/O transaction. This call must be<span></span></pre></td></tr><tr><td scope="row"><pre>    // balanced by a call to the complete method (shown just before<span></span></pre></td></tr><tr><td scope="row"><pre>    // ReleaseTask).<span></span></pre></td></tr><tr><td scope="row"><pre>    require ( ( buffer->prepare ( ) == kIOReturnSuccess ), ReleaseTask );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // The BuildINQUIRY function shows how you can design and use a<span></span></pre></td></tr><tr><td scope="row"><pre>    // command-building function to create a custom command to send<span></span></pre></td></tr><tr><td scope="row"><pre>    // to your device. Although the BuildINQUIRY function builds a standard INQUIRY<span></span></pre></td></tr><tr><td scope="row"><pre>    // command from the passed-in values, you do not create a custom function to<span></span></pre></td></tr><tr><td scope="row"><pre>    // build a standard command in a real driver. Instead, you use the SCSI<span></span></pre></td></tr><tr><td scope="row"><pre>    // Architecture Model family's built-in command-building functions. The<span></span></pre></td></tr><tr><td scope="row"><pre>    // BuildINQUIRY function uses INQUIRY as an example merely because<span></span></pre></td></tr><tr><td scope="row"><pre>    // it is a well-understood command.<span></span></pre></td></tr><tr><td scope="row"><pre>    if ( BuildINQUIRY ( request,<span></span></pre></td></tr><tr><td scope="row"><pre>                        buffer,<span></span></pre></td></tr><tr><td scope="row"><pre>                        0x00, // CMDDT (Command support data)<span></span></pre></td></tr><tr><td scope="row"><pre>                        0x00, // EVPD  (Vital product data)<span></span></pre></td></tr><tr><td scope="row"><pre>                        0x00, // PAGE_OR_OPERATION_CODE<span></span></pre></td></tr><tr><td scope="row"><pre>                        buffer->getLength ( ), // ALLOCATION_LENGTH<span></span></pre></td></tr><tr><td scope="row"><pre>                        0x00 )  // CONTROL<span></span></pre></td></tr><tr><td scope="row"><pre>                == true)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        serviceResponse = SendCommand ( request, kTenSecondTimeoutInMS );<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    if ( ( serviceResponse == kSCSIServiceResponse_TASK_COMPLETE ) &amp;&amp;<span></span></pre></td></tr><tr><td scope="row"><pre>           GetTaskStatus ( request ) == kSCSITaskStatus_GOOD )<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        IOLog ( "Vendor-created INQUIRY command succeeded\n" );<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        IOLog ( "Vendor-created INQUIRY command failed\n" );<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    buffer->complete ( );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ReleaseTask:<span></span></pre></td></tr><tr><td scope="row"><pre>    require_quiet ( ( request != NULL ), ReleaseBuffer );<span></span></pre></td></tr><tr><td scope="row"><pre>    ReleaseSCSITask ( request );<span></span></pre></td></tr><tr><td scope="row"><pre>    request = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ReleaseBuffer:<span></span></pre></td></tr><tr><td scope="row"><pre>    require_quiet ( ( buffer != NULL ), ErrorExit );<span></span></pre></td></tr><tr><td scope="row"><pre>    buffer->release ( );<span></span></pre></td></tr><tr><td scope="row"><pre>    buffer = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ErrorExit:<span></span></pre></td></tr><tr><td scope="row"><pre>    return;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>bool<span></span></pre></td></tr><tr><td scope="row"><pre>com_MySoftwareCompany_driver_SampleINQUIRYDriver::BuildINQUIRY (<span></span></pre></td></tr><tr><td scope="row"><pre>                                            SCSITaskIdentifier    request,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            IOBufferMemoryDescriptor *    dataBuffer,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            SCSICmdField1Bit     CMDDT,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            SCSICmdField1Bit     EVPD,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            SCSICmdField1Byte     PAGE_OR_OPERATION_CODE,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            SCSICmdField1Byte     ALLOCATION_LENGTH,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            SCSICmdField1Byte     CONTROL )<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    bool result = false;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Validate the parameters here.<span></span></pre></td></tr><tr><td scope="row"><pre>    require ( ( request != NULL ), ErrorExit );<span></span></pre></td></tr><tr><td scope="row"><pre>    require ( ResetForNewTask ( request ), ErrorExit );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // The helper functions ensure that the parameters fit within the<span></span></pre></td></tr><tr><td scope="row"><pre>    // CDB fields and that the buffer passed in is large enough for<span></span></pre></td></tr><tr><td scope="row"><pre>    // the transfer length.<span></span></pre></td></tr><tr><td scope="row"><pre>    require ( IsParameterValid ( CMDDT, kSCSICmdFieldMask1Bit ), ErrorExit );<span></span></pre></td></tr><tr><td scope="row"><pre>    require ( IsParameterValid ( EVPD, kSCSICmdFieldMask1Bit ), ErrorExit );<span></span></pre></td></tr><tr><td scope="row"><pre>    require ( IsParameterValid ( PAGE_OR_OPERATION_CODE, kSCSICmdFieldMask1Byte ), ErrorExit );<span></span></pre></td></tr><tr><td scope="row"><pre>    require ( IsParameterValid ( ALLOCATION_LENGTH, kSCSICmdFieldMask1Byte ), ErrorExit );<span></span></pre></td></tr><tr><td scope="row"><pre>    require ( IsParameterValid ( CONTROL, kSCSICmdFieldMask1Byte ), ErrorExit );<span></span></pre></td></tr><tr><td scope="row"><pre>    require ( IsMemoryDescriptorValid ( dataBuffer, ALLOCATION_LENGTH ), ErrorExit );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // Check the validity of the PAGE_OR_OPERATION_CODE parameter, when using both the CMDDT and EVPD parameters.<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if ( PAGE_OR_OPERATION_CODE != 0 )<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        if ( ( ( CMDDT == 1 ) &amp;&amp; ( EVPD == 1 ) ) || ( ( CMDDT == 0 ) &amp;&amp; ( EVPD == 0 ) ) )<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            goto ErrorExit;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // This is a 6-byte command: fill out the CDB appropriately<span></span></pre></td></tr><tr><td scope="row"><pre>    SetCommandDescriptorBlock ( request,<span></span></pre></td></tr><tr><td scope="row"><pre>                                kSCSICmd_INQUIRY,<span></span></pre></td></tr><tr><td scope="row"><pre>                                ( CMDDT &lt;&lt; 1 ) | EVPD,<span></span></pre></td></tr><tr><td scope="row"><pre>                                PAGE_OR_OPERATION_CODE,<span></span></pre></td></tr><tr><td scope="row"><pre>                                0x00,<span></span></pre></td></tr><tr><td scope="row"><pre>                                ALLOCATION_LENGTH,<span></span></pre></td></tr><tr><td scope="row"><pre>                                CONTROL );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    SetDataTransferDirection ( request, kSCSIDataTransfer_FromTargetToInitiator );<span></span></pre></td></tr><tr><td scope="row"><pre>    SetTimeoutDuration ( request, 0 );<span></span></pre></td></tr><tr><td scope="row"><pre>    SetDataBuffer ( request, dataBuffer );<span></span></pre></td></tr><tr><td scope="row"><pre>    SetRequestedDataTransferCount ( request, ALLOCATION_LENGTH );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    result = true;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>ErrorExit:<span></span></pre></td></tr><tr><td scope="row"><pre>    return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div>	<a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_279"></a><a name="//apple_ref/doc/uid/TP30000737-DontLinkElementID_280"></a>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../05_Universal_Binary/MS_UniversalBinary.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../07_SCSI_Example/MS_SCSI_Example.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2002, 2007 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2007-04-03<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/DeviceDrivers/Conceptual/MassStorage/06_LUD_Example/MS_LUD_Example.html%3Fid%3DTP40000974-4.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/DeviceDrivers/Conceptual/MassStorage/06_LUD_Example/MS_LUD_Example.html%3Fid%3DTP40000974-4.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/DeviceDrivers/Conceptual/MassStorage/06_LUD_Example/MS_LUD_Example.html%3Fid%3DTP40000974-4.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>