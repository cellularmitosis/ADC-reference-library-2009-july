<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Supporting Printing in Your Carbon Application: Printing Tasks</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Printing Tasks"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30000046" title="Printing Tasks"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000420" target="_top">Carbon</a> &gt; <a href="../../../Printing-date.html#//apple_ref/doc/uid/TP30000440-TP30000420-TP30000455" target="_top">Printing</a> &gt; <a href="../cpm_chap1/cpm_intro.html#//apple_ref/doc/uid/TP30000044-DontLinkElementID_1">Supporting Printing in Your Carbon Application</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../cpm_chap2/cpm_concepts.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../cpm_chap4/cpm_adopt.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_15" title="Printing Tasks"></a><h1><a name="//apple_ref/doc/uid/TP30000978-TP30000046-TP9" title="Printing Tasks"></a>Printing Tasks</h1><p><span class="content_text"><a href="../cpm_chap2/cpm_concepts.html#//apple_ref/doc/uid/TP30000978-TP30000045-TP9">“Chapter 2, Printing Concepts for Carbon Developers,”</a></span> discussed the high-level tasks required to support printing in a Carbon application: setting up the page format, setting up the print settings, and printing the print job. This chapter shows you how to implement each of those tasks for a document-based Carbon application, such as a text editor or drawing application. This chapter describes the following tasks:</p><ul class="ul"><li class="li"><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF23">“Setting Up the Page Format.”</a></span> Your application must make sure valid page format settings exist for a document.</p></li><li class="li"><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF24">“Setting Up the Print Settings.”</a></span> Your application must make sure valid print settings exist for a print job.</p></li><li class="li"><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BAJGABDA">“Printing the Job.”</a></span> Your application must determine how many pages are in the print job and draw each page.</p></li><li class="li"><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF14">“Handling Errors.”</a></span> Errors can occur at many points during the printing process. Your application should provide a function to post error messages, should they occur.</p></li><li class="li"><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BAJGEBID">“Saving a Document as a PDF File.”</a></span> Saving a document as a portable document format (PDF) file in Mac OS X uses code similar to the code you need to print a document to a printer. With very little effort on your part, your application can provide users with the ability to save their documents to a file that uses this popular format.</p></li><li class="li"><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BAJECEEI">“Printing One Copy.”</a></span> Your application can provide a shortcut command (Print One Copy) to allow users to print a single copy of a document using default settings without requiring them to open the Page Setup and Print dialogs.</p></li><li class="li"><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BCIGECAI">“Printing Multiple Copies.”</a></span> The printing system handles printing multiple copies for you.</p></li></ul><p>This chapter contains sample code to illustrate each task you need to do to support printing. See <span class="content_text"><a href="../../../../../samplecode/Printing/idxCarbon-date.html#//apple_ref/doc/uid/TP30000925-TP30000432-TP30000494" target="_top">Printing Carbon Sample Code</a></span> for the sample application on which the code is based. </p><p>If you’ve installed the Mac OS X Developer Tools CD you can find additional sample applications in the following directory that show how to support printing in Mac OS X. You can compile and run the sample applications in Project Builder.</p><p><code>/Developer/Examples/Printing/App/</code></p><p>As you go through the sample code in this chapter, note that any function, data type, or constant your application must supply has the prefix <code>My</code>, except for global constants, which use the prefix <code>gMy</code>. Application-defined constants have the prefix <code>kMy</code>. Carbon Printing Manager functions use the prefix <code>PM.</code> If a line of code contains a commented number, an explanation for that line of code follows the listing. </p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_16" title="Note"></a><p><strong>Note:</strong>&nbsp;If your application has very simple printing needs and you are using Multilingual Text Engine (MLTE), you should investigate using the MLTE functions <code><a href="../../../Reference/Multilingual_Text_Engine/Reference/reference.html#//apple_ref/doc/c_ref/TXNPageSetup" target="_top">TXNPageSetup</a></code> and <code><a href="../../../Reference/Multilingual_Text_Engine/Reference/reference.html#//apple_ref/doc/c_ref/TXNPrint" target="_top">TXNPrint</a></code> instead of using Carbon Printing Manager functions. The MLTE functions call through to the Carbon Printing Manager, elminating the need for you to write the code described in this chapter.</p></div><a name="//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF23" title="Setting Up the Page Format "></a><h2>Setting Up the Page Format </h2><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_166"></a><p>Most Carbon applications that print allow the user to choose the Page Setup command from the File menu to set options that control the page format for a document. This section shows you how to set up the page format in response to the Page Setup command. It discusses the following tasks that your application needs to perform to set up the page format for a document:</p><ul class="ul"><li class="li"><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF7">“Responding to the Page Setup Command”</a></span></p></li><li class="li"><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BAJGCAIB">“Setting Up a Page Format Object”</a></span></p></li><li class="li"><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BAJJDEFJ">“Handling Dismissal of the Page Setup Dialog”</a></span></p></li></ul><p>This section also shows how to flatten page format data so you can save it with a document and unflatten saved data to use it. See <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF17">“Saving and Retrieving Page Format Data”</a></span> for information on how to perform these optional tasks.</p><a name="//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF7" title="Responding to the Page Setup Command "></a><h3>Responding to the Page Setup Command </h3><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_167"></a><p>When the user chooses Page Setup from the File menu your application needs to perform the following operations:</p><ol class="ol"><li class="li"><p>Create a printing session object. </p></li><li class="li"><p>Make sure there is a valid page format object for the document by performing one of the following actions: </p><p>If no page format object exists for the document, your application must create one and set it to default values for this session. (The page format object is not usable until it has default values.) </p><p>If the page format object already exists, validate the object against the printing session object. Validation updates any fields in the page format object that need to be calculated, such as the adjusted page and paper rectangles.</p><p>If the page format object doesn’t exist, but the document has page format data saved with it, your application needs to unflatten the saved data to create a page format object that contains the saved settings.</p></li><li class="li"><p>Call the function<a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_168"></a><code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionUseSheets" target="_top">PMSessionUseSheets</a></code> to indicate that the Page Setup dialog should use sheets<a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_169"></a>. Although sheets are not available in Mac OS 9 and earlier, you should call this function if your application runs in Mac OS X as well as Mac OS 9. In Mac OS 9, the function returns a result code that indicates sheets are not available. </p></li><li class="li"><p>Call <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionPageSetupDialog" target="_top">PMSessionPageSetupDialog</a></code> to display the Page Setup dialog so the user can specify settings such as paper size and orientation. In Mac OS X, the dialog is displayed as a sheet as long as you called the function <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionUseSheets" target="_top">PMSessionUseSheets</a></code>.</p></li><li class="li"><p>Preserve page setup information. Users expect page setup information to persist with the document. Your application should save the page format data with the document.</p></li><li class="li"><p>Release the printing session object and handle errors, if any occur.</p></li></ol><p>One of the major design decisions you must make for your application is how to handle the page format object for the document. The page format should persist with the document after the user has dismissed the Page Setup dialog. In other words, the next time the user opens the Page Setup dialog for the document, the settings should be the same as they were when the user last closed the Page Setup dialog for that document. The settings should persist when the user quits the application, launches it again, and then opens the document.</p><p>There are a variety of ways you can handle page format data for a document. The sample code in this chapter stores the page format object in a structure and attaches it to a document window as a property. The structure is simple; it contains only two items. Most document-based applications use a larger structure to store all information about the document, including printing-related information. You need to handle the page format data in a way that’s best for your application.</p><p>The sample code assumes the following structure is defined:</p><div class="codesample"><table><tr><td scope="row"><pre>typedef struct MyDocData<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPageFormat             pageFormat;<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPrintSettings          printSettings;<span></span></pre></td></tr><tr><td scope="row"><pre>}MyDocData;<span></span></pre></td></tr></table></div><p>The structure <code>MyDocData</code> contains two fields, one of type <code>PMPageFormat</code> and another of type <code>PMPrintSettings</code>. Although it is important for the page format data to persist with the document, it is not recommended that print settings data persist. However, as you’ll see in <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF24">“Setting Up the Print Settings,”</a></span> using the structure <code>MyDocData</code> provides a convenient way to pass the print settings object from one function to another; the print settings are not saved with the document after the print job is cancelled or sent to a print queue.</p><p>The function <code><!--a-->MyDoPageSetup<!--/a--></code> in <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF106">Listing 3-1</a></span> shows how your application can respond to the Page Setup command. Following this listing is a detailed explanation for each line of code that has a numbered comment.</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_17" title="Listing 2-1A function that responds to the Page Setup command"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF106" title="Listing 2-1A function that responds to the Page Setup command"></a><strong>Listing 2-1&nbsp;&nbsp;</strong>A function that responds to the Page Setup command</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_170"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_171"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_172"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_173"></a><div class="codesample"><table><tr><td scope="row"><pre>OSStatus MyDoPageSetup (WindowRef documentWindow,<span></span></pre></td></tr><tr><td scope="row"><pre>                            MyDocData *docDataP)<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus err = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (docDataP)<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        PMPrintSession printSession;<span></span></pre></td></tr><tr><td scope="row"><pre>        PMPageFormat pageFormat = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>        err = PMCreateSession (&amp;printSession);<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>        if (!err)<span></span></pre></td></tr><tr><td scope="row"><pre>         {<span></span></pre></td></tr><tr><td scope="row"><pre>            Boolean accepted;<span></span></pre></td></tr><tr><td scope="row"><pre>            err = MySetupPageFormatForPrinting (printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            docDataP, &amp;pageFormat);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>            if (!err)<span></span></pre></td></tr><tr><td scope="row"><pre>             {<span></span></pre></td></tr><tr><td scope="row"><pre>                Boolean sheetsAreAvailable = true;<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>                err = PMSessionUseSheets (printSession, documentWindow,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            gMyPageSetupDoneProc); <span>// 6</span></pre></td></tr><tr><td scope="row"><pre>                if (err == kPMNotImplemented)<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>                {<span></span></pre></td></tr><tr><td scope="row"><pre>                        err = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>                        sheetsAreAvailable = false;<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>                if (!err)<span></span></pre></td></tr><tr><td scope="row"><pre>                {<span></span></pre></td></tr><tr><td scope="row"><pre>                     err = PMSessionPageSetupDialog (printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                                pageFormat, &amp;accepted);<span>// 8</span></pre></td></tr><tr><td scope="row"><pre>                    if (err == noErr &amp;&amp; !sheetsAreAvailable)<span></span></pre></td></tr><tr><td scope="row"><pre>                    MyPageSetupDoneProc (printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            window, accepted);<span>// 9</span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>            if (err)<span></span></pre></td></tr><tr><td scope="row"><pre>                (void) PMRelease (printSession);<span>// 10</span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    MyPostPrintingError (err, kMyPrintErrorFormatStrKey);<span>// 11</span></pre></td></tr><tr><td scope="row"><pre>    return err;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF106">Listing 3-1</a></span> does:</p><ol class="ol"><li class="li"><p>Passes a reference to the document window and a pointer to the data structure that contains the page format object (<code>PMPageFormat</code>) for the document. Your application can get the pointer (<code>docDataP</code>) to pass to your <code><!--a-->MyDoPageSetup<!--/a--></code> function by calling the Window Manager function <code><a href="../../../Reference/Window_Manager/Reference/reference.html#//apple_ref/doc/c_ref/GetWindowProperty" target="_top">GetWindowProperty</a></code>. This assumes that you have already set up the data structure and set it as a property of the window using the Window Manager function <code><a href="../../../Reference/Window_Manager/Reference/reference.html#//apple_ref/doc/c_ref/SetWindowProperty" target="_top">SetWindowProperty</a></code>.</p></li><li class="li"><p>Makes sure the pointer is valid.</p></li><li class="li"><p>Calls the Carbon Printing Manager function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMCreateSession" target="_top">PMCreateSession</a></code> to create a printing session object that is used for the page format code that follows. </p></li><li class="li"><p>Calls your application’s function to set up a page format object. See <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BAJGCAIB">“Setting Up a Page Format Object.”</a></span> Pass the printing session, the pointer to the structure <code>MyDocData</code>, and a pointer to the local page format object.</p></li><li class="li"><p>Sheets are not available in Mac OS 8 and 9. If you plan to run your application in Mac OS 8 and 9 as well as in Mac OS X, you need to write your code so it acts properly in both situations. This code demonstrates how you can support each operating system. First, create a variable <code>sheetsAreAvailable</code> and set it to <code>true</code>. </p></li><li class="li"><p>Calls the Carbon Printing Manager function <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionUseSheets" target="_top">PMSessionUseSheets</a></code><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_174"></a> to specify that a printing dialog (in this case the Page Setup dialog) should be displayed as a sheet<a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_175"></a>. </p><p>You need to pass the current printing session, the window that contains the document to be printed, and a pointer to your page setup done function. When using sheets in Mac OS X, the Carbon Printing Manager calls your function when the user dismisses the Page Setup dialog. This code assumes the application already declared a global variable:</p><div class="codesample"><table><tr><td scope="row"><pre>gMyPageSetupDoneProc = NewPMSheetDoneUPP (MyPageSetupDoneProc);<span></span></pre></td></tr></table></div><p>If your application runs in Mac OS 8 or 9, calling the function <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionUseSheets" target="_top">PMSessionUseSheets</a></code> returns the error <code>kPMNotImplemented</code>, and the function has no effect.</p></li><li class="li"><p>Checks for the error <code>kPMNotImplemented</code>. If it is returned, that means your application is running in Mac OS 8 or 9, and that you are responsible for calling your procedure to handle dismissal of the Page Setup dialog. Set the constant <code>sheetsAreAvailable</code> to <code>false</code>.</p></li><li class="li"><p>Calls the Carbon Printing Manager function <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionPageSetupDialog" target="_top">PMSessionPageSetupDialog</a></code> to display the Page Setup dialog. Pass the current printing session, the page format object that was set up in a previous step, and a pointer to a Boolean value. You call this function regardless of the version of the operating system. If your application is running in Mac OS X, the dialog appears as a sheet.</p><p>The following is true if you are using sheets:</p><ul class="ul"><li class="li"><p>When the user dismisses the Page Setup dialog, the Carbon Printing Manager calls the function specified by the constant <code><!--a-->gMyPageSetupDoneUPP<!--/a--></code> in the previous call to <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionUseSheets" target="_top">PMSessionUseSheets</a></code>.</p></li><li class="li"><p>When using sheets, the <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionPageSetupDialog" target="_top">PMSessionPageSetupDialog</a></code> function returns immediately and the Boolean value returned in the <code>accepted</code> parameter is irrelevant because it is your Page Setup dialog done function that is called when the dialog is dismissed.  If your application needs to perform additional tasks after the user dismisses the Page Setup dialog, it can do so in the <code>MyPageSetupDoneProc</code> function, which is called when the user dismisses the Page Setup dialog.</p></li><li class="li"><p>If the user clicks the OK button in the Page Setup dialog, the page format object is updated with the user’s changes (if any) and the value <code>true</code> is returned to the <code>MyPageSetupDoneProc</code> function. If the user clicks the Cancel button, the page format object is unchanged and the value <code>false</code> is returned to the <code>MyPageSetupDoneProc</code> function.</p></li></ul><p>The following is true if you are not using sheets:</p><ul class="ul"><li class="li"><p>The <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionPageSetupDialog" target="_top">PMSessionPageSetupDialog</a></code> function does not return until the user dismisses the Page Setup dialog.</p></li><li class="li"><p>The Boolean value returned in the <code>accepted</code> variable is <code>true</code> if the user clicks OK and <code>false</code> if the user clicks Cancel.</p></li></ul></li><li class="li"><p>If there is no error, and sheets are not available, then your application must call its Page Setup dialog done function (<code><!--a-->MyPageSetupDoneProc<!--/a--></code>) to process the results of the Page Setup dialog and do any necessary clean up.</p></li><li class="li"><p>If an error is returned from the Page Setup dialog or prior to showing the dialog, then you must release the printing session here. Otherwise you should release the printing session in your Page Setup dialog done function (<code><!--a-->MyPageSetupDoneProc<!--/a--></code>).</p></li><li class="li"><p>Calls your application’s function to display an error message. See <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF14">“Handling Errors”</a></span> for more information. If there is no error, the function does nothing.<a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_176"></a></p></li></ol><a name="//apple_ref/doc/uid/TP30000978-TP30000046-BAJGCAIB" title="Setting Up a Page Format Object"></a><h3>Setting Up a Page Format Object</h3><p>The function <code><!--a-->MySetupPageFormatForPrinting<!--/a--></code>, shown in <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BAJFGJEB">Listing 3-2</a></span>, makes sure there is a valid page format object for a document. The advantage to creating a separate function to take care of the page format object is that your application can call the function when it handles the Page Setup command and when it handles the Print command. <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BAJCJCHB">“Responding to the Print Command”</a></span> describes how to handle the Print command.</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_18" title="Listing 2-2A function that sets up a page format object"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30000978-TP30000046-BAJFGJEB" title="Listing 2-2A function that sets up a page format object"></a><strong>Listing 2-2&nbsp;&nbsp;</strong>A function that sets up a page format object</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_177"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_178"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_179"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_180"></a><div class="codesample"><table><tr><td scope="row"><pre>static OSStatus MySetupPageFormatForPrinting (<span></span></pre></td></tr><tr><td scope="row"><pre>                                PMPrintSession printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                                MyDocData *docDataP,<span></span></pre></td></tr><tr><td scope="row"><pre>                                PMPageFormat *pageFormatP)<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPageFormat pageFormat = docDataP->pageFormat;<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    if (pageFormat == NULL)<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        status = PMCreatePageFormat (&amp;pageFormat);<span></span></pre></td></tr><tr><td scope="row"><pre>        if (status == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            status = PMSessionDefaultPageFormat (printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                                                pageFormat);<span></span></pre></td></tr><tr><td scope="row"><pre>            if (status == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>                docDataP->pageFormat = pageFormat;<span></span></pre></td></tr><tr><td scope="row"><pre>            else<span></span></pre></td></tr><tr><td scope="row"><pre>             {<span></span></pre></td></tr><tr><td scope="row"><pre>                (void) PMRelease (pageFormat);<span></span></pre></td></tr><tr><td scope="row"><pre>                pageFormat = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    else<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        status = PMSessionValidatePageFormat (printSession, pageFormat,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        kPMDontWantBoolean);<span></span></pre></td></tr><tr><td scope="row"><pre>        if (status)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            docDataP->pageFormat = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>            (void) PMRelease (pageFormat);<span></span></pre></td></tr><tr><td scope="row"><pre>            pageFormat = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    *pageFormatP = pageFormat;<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>    return status;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Passes the current printing session object (created either in <code><!--a-->MyDoPageSetup<!--/a--></code> or <code><!--a-->MyDoPrint<!--/a--></code>), a pointer to the <code>MyDocData</code> structure, and a pointer to a page format object (created either in <code><!--a-->MyDoPageSetup<!--/a--></code> or <code><!--a-->MyDoPrint<!--/a--></code>). </p></li><li class="li"><p>Declares a local variable to hold a page format object and set its value to the document’s page format.</p></li><li class="li"><p>If the local page format is <code>NULL</code>, calls the Carbon Printing Manager function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMCreatePageFormat" target="_top">PMCreatePageFormat</a></code> to allocate the page format object, and then do the following:</p><ul class="ul"><li class="li"><p>Sets the newly allocated page format object to default values by calling the Carbon Printing Manager function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionDefaultPageFormat" target="_top">PMSessionDefaultPageFormat</a></code>.</p></li><li class="li"><p>If setting up defaults for the local page format object is successful, then sets the document’s page format object to the local page format object. If it isn’t successful, you need to release the local page format object and set it to <code>NULL</code>.</p></li></ul></li><li class="li"><p>If the local page format is not <code>NULL</code>, then validates the local page format object within the context of the current printing session. Validating updates any values in the page format object that need to be calculated, such as the adjusted page and paper rectangles. </p><p>If the validation does not succeed, you need to set the document’s page format object to <code>NULL</code>, release the local page format object, and set the local page format object to <code>NULL</code>.</p></li><li class="li"><p>If the code is successful so far, you need to assign the local page format object to the storage (<code>pageFormatP</code>) you passed to your <code><!--a-->MySetupPageFormatForPrinting<!--/a--></code> function.</p></li></ol><a name="//apple_ref/doc/uid/TP30000978-TP30000046-BAJJDEFJ" title="Handling Dismissal of the Page Setup Dialog "></a><h3>Handling Dismissal of the Page Setup Dialog </h3><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_181"></a><p>You need to provide a function to handle dismissal of the Page Setup dialog. If your application uses sheets, the Carbon Printing Manager calls this function when the user dismisses the Page Setup dialog. Otherwise, your application needs to call this function.</p><p>At a minimum this function should release the current printing session object, which shouldn’t be saved after the user dismisses the Page Setup dialog. If your application has more complicated printing needs, it may need to include code to perform other operations here. For example, your application may need to reformat pages to reflect changes the user made to scaling or paper size options in the Page Setup dialog.</p><p>The function <code><!--a-->MyPageSetupDoneProc<!--/a--></code> in <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BACIGIFG">Listing 3-3</a></span> shows how you can handle dismissal of the Page Setup dialog in your application. The function takes three parameters: the current printing session object, a reference to the document window, and a Boolean to indicate whether the user accepted or cancelled the Page Setup dialog. The function does two things: releases the printing session object and calls your application’s function to post a printing error, should one occur. See <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF14">“Handling Errors”</a></span> for information on the error-posting function.</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_19" title="Listing 2-3A function to handle dismissal of the Page Setup dialog"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30000978-TP30000046-BACIGIFG" title="Listing 2-3A function to handle dismissal of the Page Setup dialog"></a><strong>Listing 2-3&nbsp;&nbsp;</strong>A function to handle dismissal of the Page Setup dialog</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_182"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_183"></a><div class="codesample"><table><tr><td scope="row"><pre>static pascal void MyPageSetupDoneProc (PMPrintSession printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                        WindowRef documentWindow,<span></span></pre></td></tr><tr><td scope="row"><pre>                        Boolean accepted)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    #pragma unused (documentWindow, accepted)<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus err = PMRelease (printSession);<span></span></pre></td></tr><tr><td scope="row"><pre>    if (err)<span></span></pre></td></tr><tr><td scope="row"><pre>        MyPostPrintingError (err, kMyPrintErrorFormatStrKey);<span></span></pre></td></tr><tr><td scope="row"><pre>    return;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF17" title="Saving and Retrieving Page Format Data"></a><h3>Saving and Retrieving Page Format Data</h3><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_184"></a><p>When the user saves a document, most applications save the page format data with it, which consists of choices made by the user in the Page Setup dialog. Because a page format object is an opaque data type, you need to flatten<a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_185"></a> the object before you can save it. When you want to use the data, you need to unflatten<a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_186"></a> it to restore the original page format object.</p><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BAJCIIGC">Listing 3-4</a></span> shows an example of how you can flatten a page format object so it can be saved with the document. The <code>MyFlattenAndSavePageFormat</code> function assumes the caller passes a validated page format object. The function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/doc/c_ref/PMFlattenPageFormat" target="_top">PMFlattenPageFormat</a></code> flattens a page format object to a handle before the application writes it to a document or other location. </p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_20" title="Listing 2-4Saving page format data"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30000978-TP30000046-BAJCIIGC" title="Listing 2-4Saving page format data"></a><strong>Listing 2-4&nbsp;&nbsp;</strong>Saving page format data</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_187"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_188"></a><div class="codesample"><table><tr><td scope="row"><pre>OSStatus MyFlattenAndSavePageFormat (PMPageFormat pageFormat)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus    status = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>    Handle      flatFormatHandle = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (pageFormat != kPMNoPageFormat)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>         status = PMFlattenPageFormat (pageFormat, &amp;flatFormatHandle);<span></span></pre></td></tr><tr><td scope="row"><pre>         if (status == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>            //  In this sample code we simply put it in a global variable.<span></span></pre></td></tr><tr><td scope="row"><pre>            //  Replace this line with your code to write the data to a file.<span></span></pre></td></tr><tr><td scope="row"><pre>            gflatPageFormat = flatFormatHandle;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    return status;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BEIDCHDA">Listing 3-5</a></span> shows a function—<code><!--a-->MyLoadAndUnflattenPageFormat<!--/a--></code>—that gets flattened page format data and returns a page format object. The function <code><!--a-->PMUnFlattenPageFormat<!--/a--></code> converts the flattened data to a page format object.</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_21" title="Listing 2-5Retrieving page format data"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30000978-TP30000046-BEIDCHDA" title="Listing 2-5Retrieving page format data"></a><strong>Listing 2-5&nbsp;&nbsp;</strong>Retrieving page format data</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_189"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_190"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_191"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_192"></a><div class="codesample"><table><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>OSStatus    MyLoadAndUnflattenPageFormat (PMPageFormat* pageFormat)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus    status;<span></span></pre></td></tr><tr><td scope="row"><pre>    Handle  flatFormatHandle = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    //  This sample code copies flattened data from a global.<span></span></pre></td></tr><tr><td scope="row"><pre>    //  Replace this line with your code to obtain the flattened data<span></span></pre></td></tr><tr><td scope="row"><pre>    //  from your document.<span></span></pre></td></tr><tr><td scope="row"><pre>    flatFormatHandle = gflatPageFormat;<span></span></pre></td></tr><tr><td scope="row"><pre>    status = PMUnflattenPageFormat (flatFormatHandle, pageFormat);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return status;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF24" title="Setting Up the Print Settings "></a><h2>Setting Up the Print Settings </h2><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_193"></a><p>Most Carbon applications that support printing allow the user to choose Print from the File menu to set options that control how a document is printed. This section shows you how to respond to the Print command issued when the user chooses Print from the File menu. It discusses the following tasks that your application needs to do to set up print settings for a document:</p><ul class="ul"><li class="li"><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BAJCJCHB">“Responding to the Print Command”</a></span></p></li><li class="li"><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF20">“Handling Dismissal of the Print Dialog”</a></span></p></li></ul><p>The sample code assumes the following structure is defined:</p><div class="codesample"><table><tr><td scope="row"><pre>typedef struct MyDocData<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPageFormat             pageFormat;<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPrintSettings          printSettings;<span></span></pre></td></tr><tr><td scope="row"><pre>}MyDocData;<span></span></pre></td></tr></table></div><p>See <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF23">“Setting Up the Page Format”</a></span> for more information about this structure.</p><a name="//apple_ref/doc/uid/TP30000978-TP30000046-BAJCJCHB" title="Responding to the Print Command "></a><h3>Responding to the Print Command </h3><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_194"></a><p>When the user chooses Print from the File menu, your application needs to do the following:</p><ol class="ol"><li class="li"><p>Create a printing session object.</p></li><li class="li"><p>Check for a valid page format object; if there isn’t one, create it.</p></li><li class="li"><p>Create a print settings object and set it to default values for this session. A print settings object (<code>PMPrintSettings</code>) is an opaque object that stores information such as the number of copies and range of pages. An application creates an instance of this object by calling the function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMCreatePrintSettings" target="_top">PMCreatePrintSettings</a></code>. Apple recommends that you do not save the print settings object with the document, as it is intended to describe print settings for a specific printing session.</p></li><li class="li"><p>Call the function <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionUseSheets" target="_top">PMSessionUseSheets</a></code><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_195"></a> to indicate that the Print dialog should use sheets. Although sheets are not available in Mac OS 9 and earlier, you should call this function if your application runs in Mac OS X as well as Mac OS 9. In Mac OS 9, the function returns a result code that indicates sheets are not available.</p></li><li class="li"><p>Call the Carbon Printing Manager function <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionPrintDialog" target="_top">PMSessionPrintDialog</a></code><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_196"></a> to display the Print dialog so the user can specify settings such as page range and number of copies before printing. In Mac OS X, the dialog is displayed as a sheet as long as you called the function <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionUseSheets" target="_top">PMSessionUseSheets</a></code>.</p></li><li class="li"><p>Release the printing session object, set the print settings object to <code>NULL</code>, and handle errors, if any occur. Apple recommends that your application does not save print settings from one session to the next, which is why you need to set the print settings object to <code>NULL</code>. </p></li></ol><p>The function <code><!--a-->MyDoPrint<!--/a--></code> in <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF21">Listing 3-6</a></span> shows how your application can respond to the Print command. Following this listing is a detailed explanation for each line of code that has a numbered comment.</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_22" title="Listing 2-6A function that responds to the Print command"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF21" title="Listing 2-6A function that responds to the Print command"></a><strong>Listing 2-6&nbsp;&nbsp;</strong>A function that responds to the Print command</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_197"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_198"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_199"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_200"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_201"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_202"></a><div class="codesample"><table><tr><td scope="row"><pre>OSStatus MyDoPrint (WindowRef documentWindow,<span></span></pre></td></tr><tr><td scope="row"><pre>                            MyDocData *docDataP)<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status = noErr;<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    PMPrintSettings printSettings = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPageFormat pageFormat = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    UInt32 minPage = 1, maxPage;<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPrintSession printSession;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status = PMCreateSession (&amp;printSession);<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    if (status == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>     {<span></span></pre></td></tr><tr><td scope="row"><pre>        status = MySetupPageFormatForPrinting (printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        docDataP, &amp;pageFormat);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>        if (status == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            status = PMCreatePrintSettings (&amp;printSettings);<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>            if (status == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                status = PMSessionDefaultPrintSettings (printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        printSettings);<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>                if (status == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>                {<span></span></pre></td></tr><tr><td scope="row"><pre>                    CFStringRef windowTitleRef;<span></span></pre></td></tr><tr><td scope="row"><pre>                    status = CopyWindowTitleAsCFString (documentWindow,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    &amp;windowTitleRef);<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>                    if (status == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>                    {<span></span></pre></td></tr><tr><td scope="row"><pre>                        status = PMSetJobNameCFString (printSettings,<span></span></pre></td></tr><tr><td scope="row"><pre>                                                    windowTitleRef);<span>// 8</span></pre></td></tr><tr><td scope="row"><pre>                        CFRelease (windowTitleRef);<span>// 9</span></pre></td></tr><tr><td scope="row"><pre>                    }<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>            if (status == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                maxPage = MyGetDocumentNumPagesInDoc (docDataP);<span>// 10</span></pre></td></tr><tr><td scope="row"><pre>                status = PMSetPageRange (printSettings, <span>// 11</span></pre></td></tr><tr><td scope="row"><pre>                                            minPage, maxPage);<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>            if (status == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                 Boolean accepted;<span></span></pre></td></tr><tr><td scope="row"><pre>                 Boolean sheetsAreAvailable = true;<span>// 12</span></pre></td></tr><tr><td scope="row"><pre>                 docDataP->printSettings = printSettings;<span>// 13</span></pre></td></tr><tr><td scope="row"><pre>                 status = PMSessionUseSheets (printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            documentWindow,<span></span></pre></td></tr><tr><td scope="row"><pre>                                            gMyPrintDialogDoneProc);<span>// 14</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                if (status == kPMNotImplemented)<span>// 15</span></pre></td></tr><tr><td scope="row"><pre>                {<span></span></pre></td></tr><tr><td scope="row"><pre>                    status = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>                    sheetsAreAvailable = false;<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>                if (status == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>                {<span></span></pre></td></tr><tr><td scope="row"><pre>                    status = PMSessionPrintDialog (printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                                                printSettings,<span></span></pre></td></tr><tr><td scope="row"><pre>                                                pageFormat,<span></span></pre></td></tr><tr><td scope="row"><pre>                                                &amp;accepted);<span>// 16</span></pre></td></tr><tr><td scope="row"><pre>                     if (status == noErr &amp;&amp; !sheetsAreAvailable)<span>// 17</span></pre></td></tr><tr><td scope="row"><pre>                                    MyPrintDialogDoneProc (printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                                                parentWindow, accepted);<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        if (status != noErr)<span>// 18</span></pre></td></tr><tr><td scope="row"><pre>         {<span></span></pre></td></tr><tr><td scope="row"><pre>            if (printSettings)<span></span></pre></td></tr><tr><td scope="row"><pre>             {<span></span></pre></td></tr><tr><td scope="row"><pre>                docDataP->printSettings = NULL;<span>// 19</span></pre></td></tr><tr><td scope="row"><pre>                (void) PMRelease (printSettings);<span></span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>            (void) PMRelease (printSession);    <span>// 20</span></pre></td></tr><tr><td scope="row"><pre>         }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    MyPostPrintingError (status, kMyPrintErrorFormatStrKey);<span>// 21</span></pre></td></tr><tr><td scope="row"><pre>    return status;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_203"></a>Here’s what <a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_204"></a>the code <a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_205"></a>in <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF21">Listing 3-6</a></span> does:</p><ol class="ol"><li class="li"><p>Passes a reference to the document window and a pointer to the data structure that contains the page format and print settings structures for the document. Your application can get the pointer (<code>docDataP</code>) to pass to your <code><!--a-->MyDoPrint<!--/a--></code> function by calling the Window Manager function <code><a href="../../../Reference/Window_Manager/Reference/reference.html#//apple_ref/doc/c_ref/GetWindowProperty" target="_top">GetWindowProperty</a></code>. This assumes that you have already set up the data structure and set it as a property of the window using the Window Manager function <code><a href="../../../Reference/Window_Manager/Reference/reference.html#//apple_ref/doc/c_ref/SetWindowProperty" target="_top">SetWindowProperty</a></code>. </p></li><li class="li"><p>Sets up the local variables you need for this function. You need to declare local variable to hold print settings and page format objects and set them to <code>NULL</code>. You need two variables—<code>minPage</code> and <code>maxPage</code>—for getting and setting the page range. You need to declare a variable to hold a printing session object.</p></li><li class="li"><p>Calls the Carbon Printing Manager function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMCreateSession" target="_top">PMCreateSession</a></code> to create a printing session object. </p></li><li class="li"><p>Calls your application’s function to set up a page format object. See <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BAJGCAIB">“Setting Up a Page Format Object.”</a></span> Pass the printing session, the pointer to the structure <code>MyDocData</code>, and a pointer to storage for the local page format object.</p></li><li class="li"><p>Calls the Carbon Printing Manager function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMCreatePrintSettings" target="_top">PMCreatePrintSettings</a></code> to allocate a local print settings object.</p></li><li class="li"><p>Sets default values for the print settings object for the current printing session. </p></li><li class="li"><p>Calls the Window Manager function <code><a href="../../../Reference/Window_Manager/Reference/reference.html#//apple_ref/doc/c_ref/CopyWindowTitleAsCFString" target="_top">CopyWindowTitleAsCFString</a></code>. This example uses the document’s window title as the name of the print job.</p></li><li class="li"><p>Calls the Carbon Printing Manager function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/doc/c_ref/PMSetJobNameCFString" target="_top">PMSetJobNameCFString</a></code> to set the name of the print job. </p></li><li class="li"><p>Makes sure you call the Core Foundation Base Services function <code><a href="../../../../CoreFoundation/Reference/CFTypeRef/Reference/reference.html#//apple_ref/doc/c_ref/CFRelease" target="_top">CFRelease</a></code> to release the <code>CFStringRef</code> you created for the document’s window title.</p></li><li class="li"><p>Calls your application’s function to determine the number of pages in the document. See <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF13">“Calculating the Maximum Number of Pages to Print.”</a></span></p></li><li class="li"><p>Calls the Carbon Printing Manager function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSetPageRange" target="_top">PMSetPageRange</a></code> to specify the actual range of pages in the document. In Mac OS X, the minimum allowable page (<code>minPage</code>) appears in the From field in the Copies &amp; Pages pane of the Print dialog and the maximum allowable page (<code>maxPage</code>) appears in the To field. If the user enters a value outside of this range in the Print dialog the Carbon Printing Manager displays an alert message. The page range cannot be enforced automatically in Mac OS 8 and 9.</p></li><li class="li"><p>Sheets are not available in Mac OS 8 and 9. If you plan to run your application in Mac OS 8 and 9 as well as in Mac OS X, you need to write your code so it acts properly in both situations. This code demonstrates how you can support each operating system. First, create a variable <code>sheetsAreAvailable</code> and set it to <code>true</code>.</p></li><li class="li"><p>Writes the print settings object to the document’s data structure to allow the object to be accessed by your application’s Print dialog done function.</p></li><li class="li"><p>Calls the Carbon Printing Manager function <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionUseSheets" target="_top">PMSessionUseSheets</a></code><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_206"></a> to specify that a printing dialog (in this case the Print dialog) should be displayed as a sheet. </p><p>You need to pass the current printing session, the window that contains the document to be printed, and a pointer to your Print dialog done function. The Carbon Printing Manager calls your Print dialog done function when the user dismisses the Print dialog. This code assumes the application already declared a global variable:</p><div class="codesample"><table><tr><td scope="row"><pre>gMyPrintDoneProc = NewPMSheetDoneUPP (MyPrintDoneProc);<span></span></pre></td></tr></table></div><p>If your application runs in Mac OS 8 or 9, calling the function <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionUseSheets" target="_top">PMSessionUseSheets</a></code> returns the error <code>kPMNotImplemented</code>, and the function has no effect.</p></li><li class="li"><p>Checks for the error <code>kPMNotImplemented</code>. If it is returned, this means your application is running in Mac OS 8 or 9, and that you are responsible for calling your procedure to handle dismissal of the Print dialog. Set <code>sheetsAreAvailable</code> to <code>false</code>.</p></li><li class="li"><p>Calls the Carbon Printing Manager function <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionPrintDialog" target="_top">PMSessionPrintDialog</a></code><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_207"></a>, to display the Print dialog. Pass the current printing session, the print settings and page format objects that were set up in previous steps, and a pointer to a Boolean value. You call this function regardless of the version of the operating system. If your application is running in Mac OS X, the dialog appears as a sheet.</p><p>The following is true if you are using sheets:</p><ul class="ul"><li class="li"><p>When the user dismisses the Print dialog, the Carbon Printing Manager calls the function specified by <code><!--a-->gMyPrintDialogDoneProc<!--/a--></code> in the previous call to <code><!--a-->PMSessionUseSheets.<!--/a--></code></p></li><li class="li"><p>When using sheets, the <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionPrintDialog" target="_top">PMSessionPrintDialog</a></code> function returns immediately and the Boolean value returned in the <code>accepted</code> variable is irrelevant since it is your Print dialog done function that is called when the dialog is dismissed.  If your application needs to perform additional tasks after the user dismisses the Print dialog, it can do so in the <code>MyPrintDoneProc</code> function, which is called when the user dismisses the Print dialog.</p></li><li class="li"><p>If the user clicks the OK button in the Print dialog, the print settings object is updated with the user’s changes (if any) and the value <code>true</code> is returned to the <code>MyPrintDoneProc</code> function. If the user clicks the Cancel button, the print settings object is unchanged and the value <code>false</code> is returned to the <code>MyPrintDoneProc</code> function.</p></li></ul><p>The following is true if you are not using sheets:</p><ul class="ul"><li class="li"><p>The <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionPrintDialog" target="_top">PMSessionPrintDialog</a></code> function does not return until the user dismisses the Print dialog.</p></li><li class="li"><p>The Boolean value returned in the <code>accepted</code> variable is <code>true</code> if the user clicks OK and <code>false</code> if the user clicks Cancel.</p></li></ul></li><li class="li"><p>If there is no error, and sheets are not available, then your application must call its Print dialog done function to handle dismissal of the Print dialog. See <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF20">“Handling Dismissal of the Print Dialog.”</a></span></p></li><li class="li"><p>If an error is returned from the Print dialog, then you must release the printing session and print settings objects here. Otherwise you should release them in your Print dialog done function.</p></li><li class="li"><p>If there is an error, sets the print settings object stored in the document’s data structure to <code>NULL</code>.</p></li><li class="li"><p>If there is an error, releases the local printing session object.</p></li><li class="li"><p>Calls your application’s function to post a printing error. See <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF14">“Handling Errors”</a></span> for more information. If there is no error, the function does nothing.<a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_208"></a></p></li></ol><a name="//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF20" title="Handling Dismissal of the Print Dialog"></a><h3>Handling Dismissal of the Print Dialog</h3><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_209"></a><p>There are a number of operations your application needs to do when the user dismisses the Print dialog. You should handle these in a Print dialog done function. This function is called by the Carbon Printing Manager if your application uses sheets. Otherwise, your application must call this function after it calls the function <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionPrintDialog" target="_top">PMSessionPrintDialog</a></code>.</p><p>The function <code><!--a-->MyPrintDialogDoneProc<!--/a--></code> in <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF22">Listing 3-7</a></span> shows how you can handle dismissal of the Print dialog in your application. It contains the minimum amount of code necessary to handle the dismissal, including calling the application’s print loop if the user accepts the Print dialog. If your application has more complicated printing needs, it may need to include code to perform other operations here. A detailed explanation for each line of code that has a numbered comment appears following the listing.</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_23" title="Listing 2-7A function to handle dismissal of the Print dialog"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF22" title="Listing 2-7A function to handle dismissal of the Print dialog"></a><strong>Listing 2-7&nbsp;&nbsp;</strong>A function to handle dismissal of the Print dialog</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_210"></a><div class="codesample"><table><tr><td scope="row"><pre>static pascal void MyPrintDialogDoneProc (PMPrintSession printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                                  WindowRef documentWindow,<span></span></pre></td></tr><tr><td scope="row"><pre>                                 Boolean accepted)<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status = noErr, tempErr;<span></span></pre></td></tr><tr><td scope="row"><pre>    MyDocData *docDataP = MyGetWindowProperty (documentWindow);<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    if (docDataP)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        if (accepted)<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>            status = MyDoPrintLoop (printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    docDataP->pageFormat,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    docDataP->printSettings,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    docDataP);<span></span></pre></td></tr><tr><td scope="row"><pre>        tempErr = PMRelease (ourDataP->printSettings);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>        if (status == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>            status = tempErr;<span></span></pre></td></tr><tr><td scope="row"><pre>         docDataP->printSettings = NULL;<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    tempErr = PMRelease (printSession);<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>    if (status == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre>        status = tempErr;<span></span></pre></td></tr><tr><td scope="row"><pre>    MyPostPrintingError (status, kMyPrintErrorFormatStrKey);<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code in <span class="content_text">Listing 3-7</span> does:</p><ol class="ol"><li class="li"><p>The function takes three parameters: the current printing session object, a reference to document window, and a Boolean to indicate whether the user accepted or cancelled the Print dialog.</p></li><li class="li"><p>Calls your application’s function to retrieve a pointer to the structure <code>MyDocData</code>. If you set the pointer as a property of the document window using the Window Manager function <code><a href="../../../Reference/Window_Manager/Reference/reference.html#//apple_ref/doc/c_ref/SetWindowProperty" target="_top">SetWindowProperty</a></code>, you can retrieve it using the Window Manager function <code><a href="../../../Reference/Window_Manager/Reference/reference.html#//apple_ref/doc/c_ref/GetWindowProperty" target="_top">GetWindowProperty</a></code>. See the Window Manager documentation for more information.</p></li><li class="li"><p>If the user accepts the Print dialog (<code>accepted</code> has the value <code>true</code>), calls your application’s <code><!--a-->MyDoPrintLoop<!--/a--></code> function to print the pages in the selected range. See <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF10">“Writing the Print Loop.”</a></span></p></li><li class="li"><p>Calls the Carbon Printing Manager function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMRelease" target="_top">PMRelease</a></code> to release the print settings object. Releasing an object decrements its reference count, causing it to be deallocated when the count reaches 0. By not saving print settings between calls to the Print dialog, you ensure that the dialog displays with the appropriate default settings, which is the recommended behavior.</p></li><li class="li"><p>Sets the value of the print settings object to <code>NULL</code> to indicate it is no longer valid. </p></li><li class="li"><p>Calls the Carbon Printing Manager function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMRelease" target="_top">PMRelease</a></code> to release the printing session object. </p></li><li class="li"><p>Calls your application’s function to post a printing error. See <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF14">“Handling Errors”</a></span> for information on the error-posting <a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_211"></a>function.<a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_212"></a></p></li></ol><a name="//apple_ref/doc/uid/TP30000978-TP30000046-BAJGABDA" title="Printing the Job"></a><h2>Printing the Job</h2><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_213"></a><p>This section shows you how to write the code that actually creates a print job. Printing can occur only after valid page format and print settings objects are set up. In a document-based application, the printing code is typically called when the user clicks Print in the Print dialog. An application usually calls the printing code from its print dialog done procedure. See the call to the application-defined function <code><!--a-->MyDoPrintLoop<!--/a--></code> from the function <code><!--a-->MyPrintDialogDoneProc<!--/a--></code> (in <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF20">“Handling Dismissal of the Print Dialog”</a></span>). </p><p>This section discusses the following tasks that your application needs to do to print a document:</p><ul class="ul"><li class="li"><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF10">“Writing the Print Loop”</a></span></p></li><li class="li"><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF13">“Calculating the Maximum Number of Pages to Print”</a></span></p></li><li class="li"><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF12">“Drawing a Page”</a></span></p></li></ul><a name="//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF10" title="Writing the Print Loop "></a><h3>Writing the Print Loop </h3><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_214"></a><p>An application’s print loop code does most of its work by calling Carbon Printing Manager functions. The code loops over the page range specified by the user. Each pass through the loop, your application needs to call its page drawing function to draw one page. At each step through the print loop, your code should check for errors and take appropriate action if an error occurs. </p><p>The function <code><!--a-->MyDoPrintLoop<!--/a--></code> in <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BAJJFBJF">Listing 3-8</a></span> shows how your application can implement the print loop. You should be able to adapt this print loop code for applications with more sophisticated printing requirements. Following this listing is a detailed explanation for each line of code that has a numbered comment.</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_24" title="Listing 2-8A function that implements a print loop"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30000978-TP30000046-BAJJFBJF" title="Listing 2-8A function that implements a print loop"></a><strong>Listing 2-8&nbsp;&nbsp;</strong>A function that implements a print loop</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_215"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_216"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_217"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_218"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_219"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_220"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_221"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_222"></a><div class="codesample"><table><tr><td scope="row"><pre>static OSStatus MyDoPrintLoop (PMPrintSession printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                    PMPageFormat pageFormat,<span></span></pre></td></tr><tr><td scope="row"><pre>                    PMPrintSettings printSettings,<span></span></pre></td></tr><tr><td scope="row"><pre>                    const MyDocData *docDataP)<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus err = noErr;<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    OSStatus tempErr = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>    UInt32 firstPage, lastPage,<span></span></pre></td></tr><tr><td scope="row"><pre>            totalDocPages = MyGetDocumentNumPagesInDoc (docDataP);<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    if (!err)<span></span></pre></td></tr><tr><td scope="row"><pre>        err = PMGetFirstPage (printSettings, &amp;firstPage);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    if (!err)<span></span></pre></td></tr><tr><td scope="row"><pre>                 err = PMGetLastPage (printSettings, &amp;lastPage);<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>    if (!err &amp;&amp; lastPage > totalDocPages)<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>             lastPage = totalDocPages;<span></span></pre></td></tr><tr><td scope="row"><pre>    if (!err)<span></span></pre></td></tr><tr><td scope="row"><pre>             err = PMSetLastPage (printSettings, lastPage, false);<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>    if (!err)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>         err = PMSessionBeginDocument (printSession, printSettings,<span></span></pre></td></tr><tr><td scope="row"><pre>                                pageFormat);<span>// 8</span></pre></td></tr><tr><td scope="row"><pre>        if (!err)<span></span></pre></td></tr><tr><td scope="row"><pre>         {<span></span></pre></td></tr><tr><td scope="row"><pre>            UInt32 pageNumber = firstPage;<span></span></pre></td></tr><tr><td scope="row"><pre>             while (pageNumber &lt;= lastPage &amp;&amp; err == noErr &amp;&amp;<span></span></pre></td></tr><tr><td scope="row"><pre>                            PMSessionError (printSession) == noErr)<span>// 9</span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                err = PMSessionBeginPage (printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    pageFormat, NULL);<span>// 10</span></pre></td></tr><tr><td scope="row"><pre>                if (!err)<span></span></pre></td></tr><tr><td scope="row"><pre>                 {<span></span></pre></td></tr><tr><td scope="row"><pre>                    GrafPtr oldPort = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>                    void *printingContext = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>                    GetPort (&amp;oldPort);<span>// 11</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                    err = PMSessionGetGraphicsContext (printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                            kPMGraphicsContextQuickdraw,<span></span></pre></td></tr><tr><td scope="row"><pre>                            (void **) &amp;printingContext);<span>// 12</span></pre></td></tr><tr><td scope="row"><pre>                     if (!err)<span></span></pre></td></tr><tr><td scope="row"><pre>                    {<span></span></pre></td></tr><tr><td scope="row"><pre>                        Rect pageRect;<span></span></pre></td></tr><tr><td scope="row"><pre>                        SetPort ((CGrafPtr) printingContext);<span>// 13</span></pre></td></tr><tr><td scope="row"><pre>                        GetPortBounds (printingContext, &amp;pageRect);<span>// 14</span></pre></td></tr><tr><td scope="row"><pre>                        err = MyPageDrawProc (docDataP, &amp;pageRect,<span></span></pre></td></tr><tr><td scope="row"><pre>                                                 pageNumber)<span>// 15</span></pre></td></tr><tr><td scope="row"><pre>                        SetPort (oldPort);<span>// 16</span></pre></td></tr><tr><td scope="row"><pre>                    }<span></span></pre></td></tr><tr><td scope="row"><pre>                    tempErr = PMSessionEndPage (printSession);<span>// 17</span></pre></td></tr><tr><td scope="row"><pre>                    if(!err)err = tempErr;<span></span></pre></td></tr><tr><td scope="row"><pre>                }<span></span></pre></td></tr><tr><td scope="row"><pre>                pageNumber++;<span>// 18</span></pre></td></tr><tr><td scope="row"><pre>             } // end while loop<span></span></pre></td></tr><tr><td scope="row"><pre>            tempErr = PMSessionEndDocument (printSession);<span>// 19</span></pre></td></tr><tr><td scope="row"><pre>            if (!err)<span></span></pre></td></tr><tr><td scope="row"><pre>                    err = tempErr;<span></span></pre></td></tr><tr><td scope="row"><pre>            if (!err)<span></span></pre></td></tr><tr><td scope="row"><pre>                    err = PMSessionError (printSession);<span>// 20</span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    return err;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_223"></a>Here’s what<a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_224"></a> the code <a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_225"></a>in <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BAJJFBJF">Listing 3-8</a></span> does:</p><ol class="ol"><li class="li"><p>The function takes four parameters: the current printing session object, a page format object, a print settings object, and pointer to the structure <code>MyDocData</code> (described in <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF23">“Setting Up the Page Format.”</a></span> </p></li><li class="li"><p>Declares two variable to keep track of error codes. This ensures an error that could occur in one part of the print loop won’t overwrite an error that occurs in another part. </p></li><li class="li"><p>Declares variables for the page numbers of the first and last pages to be printed and the number of pages that it is possible to print. Call your application’s function (<code><!--a-->MyDetermineNumberOfPagesInDoc<!--/a--></code>) to figure out the maximum number of pages that can be printed. See <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF13">“Calculating the Maximum Number of Pages to Print”</a></span> for more information.</p></li><li class="li"><p>Calls the Carbon Printing Manager function <code>PMGetFirstPage</code> to obtain the page number entered by the user in the From field in the Copies &amp; Pages pane of the Print dialog. If the user does not enter a value, the function returns the value of the previous call to <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSetFirstPage" target="_top">PMSetFirstPage</a></code>, if any, or the default value. </p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_25" title="Note"></a><p><strong>Note:</strong>&nbsp;You must use 32-bit unsigned containers to obtain the first page and last page values because in some cases the <code>PMGetFirstPage</code> and <code>PMGetLastPage</code> functions may return very large values from the print settings data structure.</p>You should not use the constant <code>kPrintAllPages</code> in your print loop. That constant is used only with the <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSetLastPage" target="_top">PMSetLastPage</a></code> and <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSetPageRange" target="_top">PMSetPageRange</a></code> functions to specify a last page. It is not returned by the <code>PMGetLastPage</code> function and your code should not look for it here.</p></div></li><li class="li"><p>Calls the Carbon Printing Manager function <code>PMGetLastPage</code> to obtain the page number entered by the user in the To field in the Copies &amp; Pages pane of the Print dialog. If the user did not enter a value, the function returns the value of the previous call to <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSetLastPage" target="_top">PMSetLastPage</a></code>, if any, or the default value. </p></li><li class="li"><p>If the user specified a last page number greater than the number of pages in the document, assigns the actual last page in the document to the variable <code>lastPage</code>.</p></li><li class="li"><p>Calls the Carbon Printing Manager function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSetLastPage" target="_top">PMSetLastPage</a></code> to set the last page of the page range in the print settings object for this print job. Setting the last page provides information used by the progress dialog that is shown during printing.</p></li><li class="li"><p>Calls the Carbon Printing Manager function <code>PMSessionBeginDocument</code> to establish a new print job. </p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_26" title="Note"></a><p><strong>Note:</strong>&nbsp;If no error results from this call, the ensuing code always calls <code>PMSessionEndDocument</code> to end the print job regardless of any intervening errors. </p></div></li><li class="li"><p>Sets up a <code>while</code> loop over the range of pages selected for printing. Note that the loop terminates if any function returns an error (that is, if the variable <code>status</code> has a value other than <code>noErr</code>) or if the Carbon Printing Manager function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionError" target="_top">PMSessionError</a></code> returns an error.</p></li><li class="li"><p>Calls the Carbon Printing Manager function <code>PMSessionBeginPage</code> to inform the printing system that the drawing code which follows is part of a new page.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_27" title="Note"></a><p><strong>Note:</strong>&nbsp;If no error results from this call, the ensuing code always calls <code>PMSessionEndPage</code> to finish the current page regardless of any intervening errors.</p></div></li><li class="li"><p>Calls the QuickDraw function <code><a href="../../../Reference/QuickDraw_Ref/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/doc/c_ref/GetPort" target="_top">GetPort</a></code> to preserve the current graphics port.</p></li><li class="li"><p>Calls the Carbon Printing Manager function <code>PMSessionGetGraphicsContext</code> to obtain the QuickDraw graphics printing port for the page being printed.</p></li><li class="li"><p>Calls the QuickDraw function <code><a href="../../../Reference/QuickDraw_Ref/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/doc/c_ref/SetPort" target="_top">SetPort</a></code> to set the graphics port to the port obtained in the previous step. You must do this before calling the document’s function to draw one page.</p></li><li class="li"><p>Calls the QuickDraw function <code><a href="../../../Reference/QuickDraw_Ref/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/doc/c_ref/GetPortBounds" target="_top">GetPortBounds</a></code> to get the page rectangle for the current printing context. Your application may prefer to use the functions <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMGetAdjustedPageRect" target="_top">PMGetAdjustedPageRect</a></code> and <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMGetAdjustedPaperRect" target="_top">PMGetAdjustedPaperRect</a></code> for its drawing.</p></li><li class="li"><p>Calls your application’s function to draw the current page. See <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF12">“Drawing a Page”</a></span> for more information.</p></li><li class="li"><p>Calls the <code><a href="../../../Reference/QuickDraw_Ref/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/doc/c_ref/SetPort" target="_top">SetPort</a></code> function again to restore the port to the one you preserved previously.</p></li><li class="li"><p>Calls the Carbon Printing Manager function <code>PMSessionEndPage</code> to end the current page. You should use a temporary variable (<code>tempErr</code>) to get the status for this function so it doesn’t overwrite an existing, prior error. This approach ensures that the current page is always finished and that if any error occurs the loop terminates.</p></li><li class="li"><p>Increments the page count within the page-printing loop.</p></li><li class="li"><p>On completion of the page-printing loop, call the Carbon Printing Manager function <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionEndDocument" target="_top">PMSessionEndDocument</a></code> to signal the completion of the print job.</p></li><li class="li"><p>Calls the Carbon Printing Manager function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionError" target="_top">PMSessionError</a></code> to determine if any printing error has occurred. If the user cancels the print job, the result code is <code>kPMCancel</code>.<a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_226"></a></p></li></ol><a name="//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF13" title="Calculating the Maximum Number of Pages to Print "></a><h3>Calculating the Maximum Number of Pages to Print </h3><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_227"></a><p>The number of pages in a document is likely to depend on a number of factors, including document-specific changes by the user (such as adding text or changing font size), as well as Page Setup and Print dialog settings. Some applications might require a separate version of this function for each kind of document they print. Typically, you’d call the page calculation function from your print function (<code><!--a-->MyDoPrint<!--/a--></code>). See <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF21">Listing 3-6</a></span>. </p><p>When you write your page calculation function, you should consider including code to do the following:</p><ol class="ol"><li class="li"><p>Call the Carbon Printing Manager function <code>PMGetAdjustedPaperRect</code> to obtain the paper size, taking into account orientation, application drawing resolution, and scaling settings. Applications can use this information to determine the number of pages in the document based on the current page format. </p><p>If your application formats pages based on the page rectangle, you should instead call the Carbon Printing Manager function <code>PMGetAdjustedPageRect</code>.</p></li><li class="li"><p>Call the Carbon Printing Manager function <code>PMGetAdjustedPageRect</code> to obtain the page size (the imageable area), in points, taking into account orientation, application drawing resolution, and scaling settings. </p></li><li class="li"><p>Return the computed number of pages to print in the document.</p></li></ol><a name="//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF12" title="Drawing a Page"></a><h3>Drawing a Page</h3><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_228"></a><p>The code you write to draw a page of a document needs to be tailored to support the specific needs of your application. You can call the Carbon Printing Manager function <code>PMGetAdjustedPageRect</code> to obtain the page size (the imageable area), in points, taking into account orientation, application drawing resolution, and scaling settings. </p><p> Regardless of how you implement page drawing, your application should check for errors after attempting to draw each page, and take the appropriate action should an error occur. Typically, you’d call your page drawing function from your print loop function. See <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BAJJFBJF">Listing 3-8</a></span>.</p><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BAJFFHAB">Listing 3-9</a></span> shows a function that does some very simple text drawing. </p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_28" title="Listing 2-9A function that draws one page of a document"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30000978-TP30000046-BAJFFHAB" title="Listing 2-9A function that draws one page of a document"></a><strong>Listing 2-9&nbsp;&nbsp;</strong>A function that draws one page of a document</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_229"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_230"></a><div class="codesample"><table><tr><td scope="row"><pre>OSStatus MyPageDrawProc (const MyDocData *docDataP,<span></span></pre></td></tr><tr><td scope="row"><pre>                            const Rect *drawingRectP,<span></span></pre></td></tr><tr><td scope="row"><pre>                            UInt32 pageNumber)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    #pragma unused (docDataP, drawingRectP)<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus err = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>    Str255 pageNumberString;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    MoveTo (72,72);<span></span></pre></td></tr><tr><td scope="row"><pre>    TextFont (kFontIDHelvetica);<span></span></pre></td></tr><tr><td scope="row"><pre>    TextSize (24);<span></span></pre></td></tr><tr><td scope="row"><pre>    DrawString ("\pDrawing Page Number ");<span></span></pre></td></tr><tr><td scope="row"><pre>    NumToString (pageNumber, pageNumberString);<span></span></pre></td></tr><tr><td scope="row"><pre>    DrawString (pageNumberString);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return err;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF14" title="Handling Errors"></a><h2>Handling Errors</h2><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_231"></a><p>Handling errors is critical to providing printing support in any application. An application should handle any errors it gets, making sure it displays localized error strings to the user. Providing localized strings in Mac OS X is fairly easy if you define them in a separate file named <code>Localizable.strings</code> and follow the Mac OS X convention to put localized versions of the file into the appropriate language-specific folder. </p><p>You can create a <code>Localizable.strings</code> file in Project Builder by choosing New File from the File menu. Then, create an empty file named <code>Localizable.strings</code> and add it to the Resources group of your project. See <em>Inside Mac OS X: System Overview</em> for detailed information on localizing strings, string file syntax, functions for retrieving strings, and information on generating a string file automatically.</p><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF108">Listing 3-10</a></span> shows a function that displays an alert to notify the user that a printing error has occurred. The alert message includes a localized string and the error number. A detailed explanation for each line of code that has a numbered comment appears following the listing.</p><p>The function assumes a <code>Localizable.strings</code> file exists and contains a formatting string. A typical localized formatting string for a printing application would be:</p><div class="codesample"><table><tr><td scope="row"><pre>"Print error format" = "There is an error in the printing code. Error number: %d.";<span></span></pre></td></tr></table></div><p>The string <code>"Print error format"</code> is the key. It is the string you pass to the function in <span class="content_text">Listing 3-10</span> as the <code>errorFormatStringKey</code> parameter. The string <code>"There is an error in the printing code. Error number: %d."</code> is the localized formatting string; it uses printf-style formatting. </p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_29" title="Listing 2-10A function to post a printing error alert"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF108" title="Listing 2-10A function to post a printing error alert"></a><strong>Listing 2-10&nbsp;&nbsp;</strong>A function to post a printing error alert</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_232"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_233"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_234"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_235"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_236"></a><div class="codesample"><table><tr><td scope="row"><pre>void MyPostPrintingError (OSStatus status,<span></span></pre></td></tr><tr><td scope="row"><pre>                            CFStringRef errorFormatStringKey)<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CFStringRef formatStr = NULL,<span></span></pre></td></tr><tr><td scope="row"><pre>                printErrorMsg = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    SInt16      alertItemHit = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>    Str255      stringBuf;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if ((status != noErr) &amp;&amp; (status != kPMCancel))           <span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        formatStr =  CFCopyLocalizedString (errorFormatStringKey, NULL);<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>        if (formatStr != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            printErrorMsg = CFStringCreateWithFormat(<span></span></pre></td></tr><tr><td scope="row"><pre>                       NULL, NULL,<span></span></pre></td></tr><tr><td scope="row"><pre>                       formatStr, status);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>            if (printErrorMsg != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>            {<span></span></pre></td></tr><tr><td scope="row"><pre>                if (CFStringGetPascalString (printErrorMsg,<span></span></pre></td></tr><tr><td scope="row"><pre>                              stringBuf, sizeof (stringBuf),<span></span></pre></td></tr><tr><td scope="row"><pre>                              GetApplicationTextEncoding()))<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>                 {<span></span></pre></td></tr><tr><td scope="row"><pre>                     StandardAlert(kAlertStopAlert, stringBuf,<span></span></pre></td></tr><tr><td scope="row"><pre>                                       NULL, NULL, &amp;alertItemHit);<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>                 }<span></span></pre></td></tr><tr><td scope="row"><pre>                CFRelease (printErrorMsg);                     <span>// 7</span></pre></td></tr><tr><td scope="row"><pre>            }<span></span></pre></td></tr><tr><td scope="row"><pre>           CFRelease (formatStr);                             <span>// 8</span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_237"></a>Here’s what <a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_238"></a>the code in <span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-TPXREF108">Listing 3-10</a></span> does:</p><ol class="ol"><li class="li"><p>The function takes two parameters: a result code (<code>status</code>) and a string (<code>CFStringRef</code>) that specifies a key associated with the localized format string. </p></li><li class="li"><p>Checks whether the passed error should be displayed. Any error except <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/kPMCancel" target="_top">kPMCancel</a></code>, indicating the user cancelled printing, should be displayed.</p></li><li class="li"><p>Calls the Core Foundation Bundle Services macro <code><a href="../../../../CoreFoundation/Reference/CFBundleRef/Reference/reference.html#//apple_ref/doc/c_ref/CFCopyLocalizedString" target="_top">CFCopyLocalizedString</a></code> to search the default strings file (<code>Localizable.strings</code>) for a localized format string that indicates how the error should be formatted for display. You need to pass the key (<code>errorFormatStringKey</code>) for the localized string you wish to retrieve. The second parameter is optional—it is a comment (<code>CFStringRef</code>) to help translators by giving them context or other hints about how the string is used or how to translate it. If you don’t provide a comment, you should pass <code>NULL</code>.</p></li><li class="li"><p>If no error occurs, calls the Core Foundation String Services function <code><a href="../../../../CoreFoundation/Reference/CFStringRef/Reference/reference.html#//apple_ref/doc/c_ref/CFStringCreateWithFormat" target="_top">CFStringCreateWithFormat</a></code> to create a copy of the error string that includes the error number. The first parameter is a reference to an allocator to be used to create the <code>CFString</code> object. You can pass <code>NULL</code> to request the default allocator. The second parameter refers to an undocumented feature, so pass <code>NULL</code>. The third parameter is a reference to a <code>CFString</code> object that contains a string with printf-style specifiers. The remaining parameters are arguments for the printf-style string. In this case there is only one, a status code.</p></li><li class="li"><p>Calls the Core Foundation String Services function <code><a href="../../../../CoreFoundation/Reference/CFStringRef/Reference/reference.html#//apple_ref/doc/c_ref/CFStringGetPascalString" target="_top">CFStringGetPascalString</a></code> to get a copy of the string in a format that can display in a standard alert dialog.</p></li><li class="li"><p>Calls the Dialog Manager function <code><a href="../../../Reference/Dialog_Manager/Reference/reference.html#//apple_ref/doc/c_ref/StandardAlert" target="_top">StandardAlert</a></code> to display the error message.</p></li><li class="li"><p>Calls the Core Foundation Base Services function <code><a href="../../../../CoreFoundation/Reference/CFTypeRef/Reference/reference.html#//apple_ref/doc/c_ref/CFRelease" target="_top">CFRelease</a></code> to release the string (<code>printErrorMsg</code>) created by the call to <code><a href="../../../../CoreFoundation/Reference/CFBundleRef/Reference/reference.html#//apple_ref/doc/c_ref/CFCopyLocalizedString" target="_top">CFCopyLocalizedString</a></code>.</p></li><li class="li"><p>Calls the function <code><a href="../../../../CoreFoundation/Reference/CFTypeRef/Reference/reference.html#//apple_ref/doc/c_ref/CFRelease" target="_top">CFRelease</a></code> to release the string (<code>formatStr</code>) created by the call to <code><a href="../../../../CoreFoundation/Reference/CFStringRef/Reference/reference.html#//apple_ref/doc/c_ref/CFStringCreateWithFormat" target="_top">CFStringCreateWithFormat</a></code>.</p></li></ol><a name="//apple_ref/doc/uid/TP30000978-TP30000046-BAJGEBID" title="Saving a Document as a PDF File "></a><h2>Saving a Document as a PDF File </h2><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_239"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_240"></a><p>This section provides information on what you need to do in your code to implement a command to save a document as a PDF file. In Mac OS X saving a document as a PDF file is simple. Your application needs to set the printing destination<a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_241"></a> to a file location instead of to a printer. You set the destination by calling the function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionSetDestination" target="_top">PMSessionSetDestination</a></code><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_242"></a>.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_30" title="Note"></a><p><strong>Note:</strong>&nbsp;The function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionSetDestination" target="_top">PMSessionSetDestination</a></code> is available in Mac OS X version 10.1 and later.</p></div><p><span class="content_text">Listing 3-11</span> shows a code fragment that sets the destination to a PDF file. You need to supply the Carbon Printing Manager constants <code>kPMDestinationFile</code> to specify that the destination is a file and <code>kPMDocumentFormatPDF</code> that the document format is PDF. The parameter <code>saveURL</code> specifies the location to save the PDF file. </p><p>When you call the function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionSetDestination" target="_top">PMSessionSetDestination</a></code> you must</p><ul class="ul"><li class="li"><p>call the function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionSetDestination" target="_top">PMSessionSetDestination</a></code> after a call to <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMCreateSession" target="_top">PMCreateSession</a></code> and before you release the printing session object. </p></li><li class="li"><p>use the same printing session object for the function <code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionSetDestination" target="_top">PMSessionSetDestination</a></code> as you use when you set defaults for the print settings object (<code>printSettings</code>). </p></li><li class="li"><p>set the destination before you call your print loop code.</p></li></ul><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_31" title="Listing 2-11Setting the destination as a PDF file"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30000978-TP30000046-BAJJEBED" title="Listing 2-11Setting the destination as a PDF file"></a><strong>Listing 2-11&nbsp;&nbsp;</strong>Setting the destination as a PDF file</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_243"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_244"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_245"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_246"></a><div class="codesample"><table><tr><td scope="row"><pre>if (status == noErr){<span></span></pre></td></tr><tr><td scope="row"><pre>        status = PMSessionSetDestination (printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                            printSettings,<span></span></pre></td></tr><tr><td scope="row"><pre>                            kPMDestinationFile,<span></span></pre></td></tr><tr><td scope="row"><pre>                            kPMDocumentFormatPDF,<span></span></pre></td></tr><tr><td scope="row"><pre>                            saveURL);<span></span></pre></td></tr><tr><td scope="row"><pre> }<span></span></pre></td></tr></table></div><div class="notebox"><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_32" title="Note"></a><p><strong>Note:</strong>&nbsp;If you want the user to specify the location, you need to write functions that call the Navigation Services API. You call your printing code after the user has specified the location in the Navigation Services dialog.</p></div><p>In addition to setting the destination as a PDF file, you need to decide how your application handles printing dialogs (Page Setup and Print) and whether you want the printing system to display the printing status dialog<a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_247"></a>. </p><p>When users save a document, they expect to see a dialog in which they can specify a filename and file location. They do not expect to see Page Setup or Print dialogs. In most cases, your application should not display either of the printing dialogs to the user in response to the Save As PDF command. You need to write your printing code so that the print settings object is set up programmatically rather than by the user. Your application should use the current page format that is associated with the document.</p><p>The printing status dialog is automatically shown by the printing system when an application calls these functions: <code><a href="../../../Reference/CarbonPrintRef/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/doc/c_ref/PMSessionBeginDocument" target="_top">PMSessionBeginDocument</a></code>, <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionEndDocument" target="_top">PMSessionEndDocument</a></code>, <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionBeginPage" target="_top">PMSessionBeginPage</a></code>, and <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionEndPage" target="_top">PMSessionEndPage</a></code>. The printing status message informs the user of the page being printed (Printing Page 1, Printing Page 2, and so forth). A printing status message is probably not appropriate to show for file saving so you should suppress the printing status dialog. </p><p>To suppress the printing status dialog, your application needs to use the “No Status Dialog” versions of these functions. Specifically, you call</p><ul class="ul"><li class="li"><p><code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/doc/c_ref/PMSessionBeginDocumentNoDialog" target="_top">PMSessionBeginDocumentNoDialog</a></code><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_248"></a> instead of <code><a href="../../../Reference/CarbonPrintRef/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/doc/c_ref/PMSessionBeginDocument" target="_top">PMSessionBeginDocument</a></code></p></li><li class="li"><p><code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionEndDocumentNoDialog" target="_top">PMSessionEndDocumentNoDialog</a></code><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_249"></a> instead of <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionEndDocument" target="_top">PMSessionEndDocument</a></code></p></li><li class="li"><p><code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionBeginPageNoDialog" target="_top">PMSessionBeginPageNoDialog</a></code><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_250"></a> instead of <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionBeginPage" target="_top">PMSessionBeginPage</a></code></p></li><li class="li"><p><code><a href="../../../../GraphicsImaging/Reference/CorePrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionEndPageNoDialog" target="_top">PMSessionEndPageNoDialog</a></code><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_251"></a> instead of <code><a href="../../../Reference/CarbonPrintRef/Reference/reference.html#//apple_ref/doc/c_ref/PMSessionEndPage" target="_top">PMSessionEndPage</a></code></p></li></ul><p>Otherwise, the code you use to implement the print loop is the same as what you’d use to print a print job triggered by a user clicking Print in the Print dialog.</p><p><span class="content_text"><a href="cpm_tasks.html#//apple_ref/doc/uid/TP30000978-TP30000046-BAJCGDGJ">Listing 3-12</a></span> shows a code fragment that assigns function names to an application-defined structure based on whether the status dialog should be shown. Then, the application passes a pointer to the structure to its print loop function (<code><!--a-->MyDoPrintLoop<!--/a--></code>). You would need to modify your application’s print loop function to require a parameter that specifies a pointer to the application-defined structure containing the function names and call the appropriate function from the structure.</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_33" title="Listing 2-12Setting up a print loop to use the No Dialog functions"></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30000978-TP30000046-BAJCGDGJ" title="Listing 2-12Setting up a print loop to use the No Dialog functions"></a><strong>Listing 2-12&nbsp;&nbsp;</strong>Setting up a print loop to use the No Dialog functions</p><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_252"></a><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_253"></a><div class="codesample"><table><tr><td scope="row"><pre> if (status == noErr)<span></span></pre></td></tr><tr><td scope="row"><pre> {<span></span></pre></td></tr><tr><td scope="row"><pre>#if NO_STATUS_DIALOG<span></span></pre></td></tr><tr><td scope="row"><pre>        PrintingProcs myPrintingProcs = {PMSessionBeginDocumentNoDialog,<span></span></pre></td></tr><tr><td scope="row"><pre>                        PMSessionEndDocumentNoDialog,<span></span></pre></td></tr><tr><td scope="row"><pre>                        PMSessionBeginPageNoDialog,<span></span></pre></td></tr><tr><td scope="row"><pre>                        PMSessionEndPageNoDialog};<span></span></pre></td></tr><tr><td scope="row"><pre>#else<span></span></pre></td></tr><tr><td scope="row"><pre>        PrintingProcs myPrintingProcs = {PMSessionBeginDocument,<span></span></pre></td></tr><tr><td scope="row"><pre>                        PMSessionEndDocument,<span></span></pre></td></tr><tr><td scope="row"><pre>                        PMSessionBeginPage,<span></span></pre></td></tr><tr><td scope="row"><pre>                        PMSessionEndPage};<span></span></pre></td></tr><tr><td scope="row"><pre>#endif<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>                status = MyDoPrintLoop(printSession,<span></span></pre></td></tr><tr><td scope="row"><pre>                            pageFormat,<span></span></pre></td></tr><tr><td scope="row"><pre>                            printSettings,<span></span></pre></td></tr><tr><td scope="row"><pre>                            documentDataP,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;myPrintingProcs);<span></span></pre></td></tr><tr><td scope="row"><pre> }<span></span></pre></td></tr></table></div><a name="//apple_ref/doc/uid/TP30000978-TP30000046-BAJECEEI" title="Printing One Copy"></a><h2>Printing One Copy</h2><p>The Print One Copy command<a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_254"></a> is often provided by applications as a shortcut to allow a user to print a single copy of a document using default settings. Because default print setting values are used, there is no need for your application to display the Print dialog. Instead your application should set up the print settings objects programmatically and should use the current page format that is associated with the document. Otherwise, the code you use to implement the print loop is the same as what you’d use to print a print job triggered by a user clicking Print in the Print dialog.</p><a name="//apple_ref/doc/uid/TP30000978-TP30000046-BCIGECAI" title="Printing Multiple Copies"></a><h2>Printing Multiple Copies</h2><p>The Mac OS X printing system automatically handles printing multiple copies. Your application does not need to perform any tasks other than specifying the number of copies in the printing session object.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000046-DontLinkElementID_34" title="Note"></a><p><strong>Note:</strong>&nbsp;In non-Carbon printing in Mac OS 9 and earlier your application had to iterate through the print loop for each copy you wanted to print. This is no longer true. If you use this approach in Mac OS X, you will get unsatisfactory results.</p></div>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../cpm_chap2/cpm_concepts.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../cpm_chap4/cpm_adopt.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2001, 2004 Apple Computer, Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2004-08-31<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Carbon/Conceptual/CPM_Concepts/cpm_chap3/cpm_tasks.html%3Fid%3DTP30000978-2.1&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Carbon/Conceptual/CPM_Concepts/cpm_chap3/cpm_tasks.html%3Fid%3DTP30000978-2.1&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Carbon/Conceptual/CPM_Concepts/cpm_chap3/cpm_tasks.html%3Fid%3DTP30000978-2.1&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>