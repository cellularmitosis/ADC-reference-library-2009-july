<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>qteffects - /QTEffects.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/QuickTime/index.html">QuickTime</a> &gt; <a href="../../samplecode/QuickTime/idxVideoEffectsTransitions-date.html">Video Effects & Transitions</a> &gt; <A HREF="javascript:location.replace('index.html');">qteffects</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">qteffects</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/QTEffects.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/Application Files/ComApplication.c</option>
<option value="listing2.html">/Application Files/ComApplication.h</option>
<option value="listing3.html">/Application Files/ComResource.h</option>
<option value="listing4.html">/Common Files/ComFramework.c</option>
<option value="listing5.html">/Common Files/ComFramework.h</option>
<option value="listing6.html">/Common Files/EffectsUtilities.c</option>
<option value="listing7.html">/Common Files/EffectsUtilities.h</option>
<option value="listing8.html">/Common Files/EndianUtilities.c</option>
<option value="listing9.html">/Common Files/EndianUtilities.h</option>
<option value="listing10.html">/Common Files/ImageCompressionUtilities.c</option>
<option value="listing11.html">/Common Files/ImageCompressionUtilities.h</option>
<option value="listing12.html">/Common Files/MacFramework.c</option>
<option value="listing13.html">/Common Files/MacFramework.h</option>
<option value="listing14.html">/Common Files/MacPrefix.h</option>
<option value="listing15.html">/Common Files/QTUtilities.c</option>
<option value="listing16.html">/Common Files/QTUtilities.h</option>
<option value="listing17.html">/Common Files/SpriteUtilities.c</option>
<option value="listing18.html">/Common Files/SpriteUtilities.h</option>
<option value="listing19.html">/Common Files/WinFramework.c</option>
<option value="listing20.html">/Common Files/WinFramework.h</option>
<option value="listing21.html">/Common Files/WinPrefix.h</option>
<option value="listing22.html">/Common Files/WiredSpriteUtilities.c</option>
<option value="listing23.html">/Common Files/WiredSpriteUtilities.h</option>
<option value="listing24.html">/QTEffects.c</option>
<option value="listing25.html">/QTEffects.h</option>
<option value="listing26.html">/README.txt</option></select>
				</p>
				</form>
				<p><strong><a href="qteffects.zip">Download Sample</a></strong> (&#147;qteffects.zip&#148;, 220.3K)<BR>
<strong><a href="qteffects.dmg">Download Sample</a></strong> (&#147;qteffects.dmg&#148;, 301.9K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">//////////////  File:    QTEffects.c////  Contains:  QuickTime video effect support for QuickTime movies.//        Based on existing samples QTShowEffect, MakeEffectMovie, and AddEffectSeg.////  Written by:  Tim Monroe////  Copyright:  &copy; 1997-2001 by Apple Computer, Inc., all rights reserved.////  Change History (most recent first):////     &lt;1&gt;     11/06/97  rtm    first file; parts from QTShowEffect, MakeEffectMovie, and AddEffectSeg//     ////////////////////////// header files////////////#include &quot;QTEffects.h&quot;////////////// global variables////////////QTParameterDialog      gEffectsDialog = 0L;      // identifier for the standard parameter dialog boxint              gNumberOfSteps = k30StepsCount;QTAtomContainer        gEffectDesc = NULL;      // effects descriptionQTAtomContainer        gEffectList = NULL;PicHandle          gPosterA = NULL;PicHandle          gPosterB = NULL;Movie            gSrcMovies[kMaxNumSources] = {NULL, NULL, NULL};Track            gSrcTracks[kMaxNumSources] = {NULL, NULL, NULL};UInt16            gSpecCount = 0;    Boolean            gCopyMovieMedia = false;    // should we copy the movie media into the new effects movie?Boolean            gDoneWithDialog = false;    // are we done using the effects parameters dialog box?/////////////////////////////////////////////////////////////////////////////////////////////////////////////// High-level functions.//// These functions are called by QTApp_HandleMenu./////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// QTEffects_MakeFireMovie// Make a movie containing the fire effect.////////////void QTEffects_MakeFireMovie (void){  FSSpec          myFile;  Boolean          myIsSelected = false;  Boolean          myIsReplacing = false;    StringPtr         myPrompt = QTUtils_ConvertCToPascalString(kEffectsSaveMoviePrompt);  StringPtr         myFileName = QTUtils_ConvertCToPascalString(kEffectsFireMovieFileName);  Movie          myMovie = NULL;  short          myMovieRefNum = kInvalidFileRefNum;  short          myResID = movieInDataForkResID;  Track          myEffectTrack = NULL;  Media          myEffectMedia = NULL;  QTAtomContainer      myEffectDesc = NULL;  ImageDescriptionHandle  mySampleDesc = NULL;  TimeValue        mySampleTime = 0;  long          myFlags = createMovieFileDeleteCurFile | createMovieFileDontCreateResFile;  OSType          myType = FOUR_CHAR_CODE('none');  OSErr          myErr = noErr;  // ask the user for the name of the new movie file  QTFrame_PutFile(myPrompt, myFileName, &amp;myFile, &amp;myIsSelected, &amp;myIsReplacing);  if (!myIsSelected)    goto bail;        // deal with user cancelling  // create a movie file for the destination movie  myErr = CreateMovieFile(&amp;myFile, sigMoviePlayer, smSystemScript, myFlags, &amp;myMovieRefNum, &amp;myMovie);  if (myErr != noErr)    goto bail;    // select the &quot;no controller&quot; movie controller  myType = EndianU32_NtoB(myType);  SetUserDataItem(GetMovieUserData(myMovie), &amp;myType, sizeof(myType), kUserDataMovieControllerType, 1);      //////////  //  // create the effects track  //  //////////    myEffectTrack = NewMovieTrack(myMovie, IntToFixed(kDefaultTrackWidth), IntToFixed(kDefaultTrackHeight), kNoVolume);  if (myEffectTrack == NULL)    goto bail;  myEffectMedia = NewTrackMedia(myEffectTrack, VideoMediaType, kOneSecond, NULL, 0);  if (myEffectMedia == NULL)    goto bail;  //////////  //  // create the sample description  //  //////////    mySampleDesc = EffectsUtils_MakeSampleDescription(kFireCodecType, kDefaultTrackWidth, kDefaultTrackHeight);  if (mySampleDesc == NULL)    goto bail;    //////////  //  // create the effect description  //  //////////    myEffectDesc = EffectsUtils_CreateEffectDescription(kFireCodecType, kSourceNoneName, kSourceNoneName, kSourceNoneName);  if (myEffectDesc == NULL)    goto bail;    // add a parameter atom to the effects sample  if (0) {    long    myRate = 11;  // this one goes to 11....        myRate = EndianS32_NtoB(myRate);    myErr = QTInsertChild(myEffectDesc, kParentAtomIsContainer, FOUR_CHAR_CODE('decy'), 1, 0, sizeof(myRate), &amp;myRate, NULL);  }    //////////  //  // add the effect description as a sample to the effects track media  //  //////////    myErr = BeginMediaEdits(myEffectMedia);  if (myErr != noErr)    goto bail;  myErr = AddMediaSample(myEffectMedia, myEffectDesc, 0, GetHandleSize(myEffectDesc), kEffectMovieDuration, (SampleDescriptionHandle)mySampleDesc, 1, 0, &amp;mySampleTime);  if (myErr != noErr)    goto bail;  myErr = EndMediaEdits(myEffectMedia);  if (myErr != noErr)    goto bail;  myErr = InsertMediaIntoTrack(myEffectTrack, 0, mySampleTime, kEffectMovieDuration, fixed1);  if (myErr != noErr)    goto bail;  AddMovieResource(myMovie, myMovieRefNum, &amp;myResID, NULL);  bail:  if (myMovieRefNum != kInvalidFileRefNum)    CloseMovieFile(myMovieRefNum);  if (myMovie != NULL)    DisposeMovie(myMovie);    if (myEffectDesc != NULL)    QTDisposeAtomContainer(myEffectDesc);    if (mySampleDesc != NULL)    DisposeHandle((Handle)mySampleDesc);    free(myPrompt);  free(myFileName);  return;}////////////// QTEffects_AddFilmNoiseToMovie// Add the film noise effect to the (first video track in the) specified movie.////////////void QTEffects_AddFilmNoiseToMovie (Movie theMovie){  ImageDescriptionHandle  mySampleDesc = NULL;  Track          mySrcTrack = NULL;  Track          myTrack = NULL;  Media          myMedia = NULL;  QTAtomContainer      myInputMap = NULL;  QTAtomContainer      myEffectDesc = NULL;  TimeValue        mySampleTime;  Fixed          myWidth, myHeight;  OSErr          myErr = noErr;  if (theMovie == NULL)    goto bail;  // get the first visual track in the movie  mySrcTrack = GetMovieIndTrackType(theMovie, 1, kCharacteristicCanSendVideo, movieTrackCharacteristic | movieTrackEnabledOnly);  if (mySrcTrack == NULL)    goto bail;  // get the width and height of that track  GetTrackDimensions(mySrcTrack, &amp;myWidth, &amp;myHeight);      //////////  //  // create the effects track  //  //////////    myTrack = NewMovieTrack(theMovie, myWidth, myHeight, kNoVolume);  if (myTrack == NULL)    goto bail;      myMedia = NewTrackMedia(myTrack, VideoMediaType, kOneSecond, NULL, 0);  if (myMedia == NULL)    goto bail;  //////////  //  // create the sample description  //  //////////    mySampleDesc = EffectsUtils_MakeSampleDescription(kFilmNoiseImageFilterType, FixedToInt(myWidth), FixedToInt(myHeight));  if (mySampleDesc == NULL)    goto bail;    //////////  //  // create the effect description  //  //////////    myEffectDesc = EffectsUtils_CreateEffectDescription(kFilmNoiseImageFilterType, kSourceOneName, kSourceNoneName, kSourceNoneName);  if (myEffectDesc == NULL)    goto bail;  //////////  //  // add the effect description as a sample to the effects track media  //  //////////  myErr = BeginMediaEdits(myMedia);  if (myErr != noErr)    goto bail;  myErr = AddMediaSample(myMedia, (Handle)myEffectDesc, 0, GetHandleSize((Handle)myEffectDesc), GetMediaDuration(GetTrackMedia(mySrcTrack)), (SampleDescriptionHandle)mySampleDesc, 1, 0, &amp;mySampleTime);  if (myErr != noErr)    goto bail;  myErr = EndMediaEdits(myMedia);  if (myErr != noErr)    goto bail;    //////////  //  // create the input map and add references for the first effects track  //  //////////    myErr = QTNewAtomContainer(&amp;myInputMap);  if (myErr != noErr)    goto bail;      myErr = EffectsUtils_AddTrackReferenceToInputMap(myInputMap, myTrack, mySrcTrack, kSourceOneName);  if (myErr != noErr)    goto bail;      // add the input map to the effects track  myErr = SetMediaInputMap(myMedia, myInputMap);  if (myErr != noErr)    goto bail;  //////////  //  // add the media to the track  //  //////////  myErr = InsertMediaIntoTrack(myTrack, 0, mySampleTime, GetMediaDuration(myMedia), fixed1);  bail:      if (myEffectDesc != NULL)    QTDisposeAtomContainer(myEffectDesc);    if (mySampleDesc != NULL)    DisposeHandle((Handle)mySampleDesc);    if (myInputMap != NULL)    QTDisposeAtomContainer(myInputMap);    return;}////////////// QTEffects_AddFilmNoiseToImage// Add the film noise effect to the image associated with the specified window object.////////////void QTEffects_AddFilmNoiseToImage (WindowObject theWindowObject){  ApplicationDataHdl      myAppData = NULL;  GraphicsImportComponent    myImporter = NULL;  Rect            myRect;    if (theWindowObject == NULL)    return;  myAppData = (ApplicationDataHdl)(**theWindowObject).fAppData;  if (myAppData == NULL)    return;    myImporter = (**theWindowObject).fGraphicsImporter;  if (myImporter == NULL)    return;  GraphicsImportGetBoundsRect(myImporter, &amp;myRect);  // set up the initial state  (**myAppData).fSampleDescription = EffectsUtils_MakeSampleDescription(kImageEffectType, myRect.right - myRect.left, myRect.bottom - myRect.top);  (**myAppData).fEffectDescription = EffectsUtils_CreateEffectDescription(kImageEffectType, kSourceOneName, kSourceNoneName, kSourceNoneName);  (**myAppData).fEffectType        = kImageEffectType;  (**myAppData).fEffectSequenceID  = 0L;  (**myAppData).fTimeBase          = NULL;    QTEffects_SetUpEffectSequence(theWindowObject);}////////////// QTEffects_MakePenguinMovie// Make a movie that cross-fades the penguin picture in from a white initial frame.////////////void QTEffects_MakePenguinMovie (void){  ImageDescriptionHandle  mySampleDesc = NULL;  short          myMovieRefNum = kInvalidFileRefNum;  short          myResID = movieInDataForkResID;  Movie          myMovie = NULL;  Track          myTrack = NULL;  Track          mySrc1Track = NULL;  Track          mySrc2Track = NULL;  Media          myMedia;  GWorldPtr        myGW1 = NULL;  GWorldPtr        myGW2 = NULL;  FSSpec          myFile;  Boolean          myIsSelected = false;  Boolean          myIsReplacing = false;    QTAtomContainer      myInputMap = NULL;  QTAtomContainer      myEffectDesc = NULL;  TimeValue        mySampleTime;  long          myFlags = createMovieFileDeleteCurFile | createMovieFileDontCreateResFile;  StringPtr         myPrompt = QTUtils_ConvertCToPascalString(kEffectsSaveMoviePrompt);  StringPtr         myFileName = QTUtils_ConvertCToPascalString(kEffectsPenguinMovieFileName);  OSErr          myErr = noErr;    // ask the user for the name of the new movie file  QTFrame_PutFile(myPrompt, myFileName, &amp;myFile, &amp;myIsSelected, &amp;myIsReplacing);  if (!myIsSelected)    goto bail;        // deal with user cancelling  // create a movie file for the destination movie  myErr = CreateMovieFile(&amp;myFile, sigMoviePlayer, smCurrentScript, myFlags, &amp;myMovieRefNum, &amp;myMovie);  if (myErr != noErr)    goto bail;    //////////  //  // create the effects track  //  //////////    myTrack = NewMovieTrack(myMovie, IntToFixed(kPenguinTrackWidth), IntToFixed(kPenguinTrackHeight), kNoVolume);  if (myTrack == NULL)    goto bail;      myMedia = NewTrackMedia(myTrack, VideoMediaType, kOneSecond, NULL, 0);  if (myMedia == NULL)    goto bail;  //////////  //  // create the sample description  //  //////////    mySampleDesc = EffectsUtils_MakeSampleDescription(kCrossFadeTransitionType, kPenguinTrackWidth, kPenguinTrackHeight);  if (mySampleDesc == NULL)    goto bail;  //////////  //  // create the effect description  //  //////////    myEffectDesc = EffectsUtils_CreateEffectDescription(kCrossFadeTransitionType, kSourceOneName, kSourceTwoName, kSourceNoneName);  if (myEffectDesc == NULL)    goto bail;  //////////  //  // add the video tracks of the source pictures to the effects movie  //  //////////    myErr = EffectsUtils_GetPictResourceAsGWorld(kWhiteRectID, kPenguinTrackWidth, kPenguinTrackHeight, 0, &amp;myGW1);  if (myErr != noErr)    goto bail;  myErr = EffectsUtils_GetPictResourceAsGWorld(kPenguinPictID, kPenguinTrackWidth, kPenguinTrackHeight, 0, &amp;myGW2);  if (myErr != noErr)    goto bail;  // the video tracks used as sources for the effect should start at the same time as the effects track  // and end at the same time as the effects track  myErr = EffectsUtils_AddVideoTrackFromGWorld(&amp;myMovie, myGW1, &amp;mySrc1Track, 0, kEffectMovieDuration, kPenguinTrackWidth, kPenguinTrackHeight);  if (myErr != noErr)    goto bail;      myErr = EffectsUtils_AddVideoTrackFromGWorld(&amp;myMovie, myGW2, &amp;mySrc2Track, 0, kEffectMovieDuration, kPenguinTrackWidth, kPenguinTrackHeight);  if (myErr != noErr)    goto bail;  //////////  //  // add the effect description as a sample to the effects track media  //  //////////  myErr = BeginMediaEdits(myMedia);  if (myErr != noErr)    goto bail;  myErr = AddMediaSample(myMedia, (Handle)myEffectDesc, 0, GetHandleSize((Handle)myEffectDesc), kEffectMovieDuration, (SampleDescriptionHandle)mySampleDesc, 1, 0, &amp;mySampleTime);  if (myErr != noErr)    goto bail;  myErr = EndMediaEdits(myMedia);  if (myErr != noErr)    goto bail;    //////////  //  // create the input map and add references for the first effects track  //  //////////    myErr = QTNewAtomContainer(&amp;myInputMap);  if (myErr != noErr)    goto bail;      myErr = EffectsUtils_AddTrackReferenceToInputMap(myInputMap, myTrack, mySrc1Track, kSourceOneName);  if (myErr != noErr)    goto bail;      myErr = EffectsUtils_AddTrackReferenceToInputMap(myInputMap, myTrack, mySrc2Track, kSourceTwoName);  if (myErr != noErr)    goto bail;  // add the input map to the effects track  myErr = SetMediaInputMap(myMedia, myInputMap);  if (myErr != noErr)    goto bail;  //////////  //  // add the media to the track  //  //////////    myErr = InsertMediaIntoTrack(myTrack, 0, mySampleTime, GetMediaDuration(myMedia), fixed1);  if (myErr != noErr)    goto bail;      // put the movie resource into the file  myErr = AddMovieResource(myMovie, myMovieRefNum, &amp;myResID, NULL);  bail:      if (myGW1 != NULL)    DisposeGWorld(myGW1);      if (myGW2 != NULL)    DisposeGWorld(myGW2);      if (mySampleDesc != NULL)    DisposeHandle((Handle)mySampleDesc);    if (myMovieRefNum != kInvalidFileRefNum)    CloseMovieFile(myMovieRefNum);  if (myMovie != NULL)    DisposeMovie(myMovie);  if (myInputMap != NULL)    QTDisposeAtomContainer(myInputMap);    free(myPrompt);  free(myFileName);  return;}////////////// QTEffects_AddEffectToMovieSegment// Add the specified effect to occur at the specified time and duration.////////////OSErr QTEffects_AddEffectToMovieSegment (Movie theMovie, OSType theEffectType, long theNumSources, TimeValue theStartTime, TimeValue theDuration){  Track          myVidTrack1 = NULL;  Track          myVidTrack2 = NULL;  Track          mySrcTrack1 = NULL;  Track          mySrcTrack2 = NULL;  Media          mySrcMedia1 = NULL;  Media          mySrcMedia2 = NULL;  Track          myEffectTrack = NULL;  Media          myEffectMedia = NULL;  Fixed          myWidth, myHeight;  TimeScale        myTimeScale;  TimeValue        mySampleTime;  Rect          myRect;  QTAtomContainer      myInputMap = NULL;  QTAtomContainer      myEffectDesc = NULL;  ImageDescriptionHandle  mySampleDesc = NULL;  OSType          myEffectName1 = kSourceNoneName;  OSType          myEffectName2 = kSourceNoneName;  short          myLayer;  OSErr          myErr = noErr;    // make sure we were passed a valid movie  if (theMovie == NULL)    return(paramErr);      //////////  //  // get some information about the movie  //  //////////    myTimeScale = GetMovieTimeScale(theMovie);  GetMovieBox(theMovie, &amp;myRect);  myLayer = EffectsUtils_GetFrontmostTrackLayer(theMovie, VideoMediaType);    myWidth = IntToFixed((myRect.right - myRect.left));  myHeight = IntToFixed((myRect.bottom - myRect.top));  //////////  //  // retrieve the original video track(s), create the effect's source track(s) and media,  // then set the new source track(s) to reference the data in the original video track(s)  //  //////////    switch (theNumSources) {    case 2:      myVidTrack2 = GetMovieIndTrackType(theMovie, 2, VideoMediaType, movieTrackMediaType | movieTrackEnabledOnly);      if (myVidTrack2 == NULL)        return(paramErr);            mySrcTrack2 = NewMovieTrack(theMovie, myWidth, myHeight, kNoVolume);      if (mySrcTrack2 == NULL)        return(paramErr);              mySrcMedia2 = NewTrackMedia(mySrcTrack2, VideoMediaType, myTimeScale, NULL, 0);      if (mySrcMedia2 == NULL)        return(paramErr);#if COPY_MOVIE_MEDIA      myErr = BeginMediaEdits(mySrcMedia2);      if (myErr != noErr)        return(myErr);#endif            myErr = CopyTrackSettings(myVidTrack2, mySrcTrack2);      myErr = InsertTrackSegment(myVidTrack2, mySrcTrack2, theStartTime, theDuration, theStartTime);      if (myErr != noErr)        return(myErr);#if COPY_MOVIE_MEDIA      EndMediaEdits(mySrcMedia2);#endif            myEffectName2 = kSourceTwoName;            // note that we fall through here!            case 1:      myVidTrack1 = GetMovieIndTrackType(theMovie, 1, VideoMediaType, movieTrackMediaType | movieTrackEnabledOnly);      if (myVidTrack1 == NULL)        return(paramErr);              mySrcTrack1 = NewMovieTrack(theMovie, myWidth, myHeight, kNoVolume);      if (mySrcTrack1 == NULL)        return(paramErr);              mySrcMedia1 = NewTrackMedia(mySrcTrack1, VideoMediaType, myTimeScale, NULL, 0);      if (mySrcMedia1 == NULL)        return(paramErr);#if COPY_MOVIE_MEDIA      myErr = BeginMediaEdits(mySrcMedia1);      if (myErr != noErr)        return(myErr);#endif            myErr = CopyTrackSettings(myVidTrack1, mySrcTrack1);      myErr = InsertTrackSegment(myVidTrack1, mySrcTrack1, theStartTime, theDuration, theStartTime);      if (myErr != noErr)        return(myErr);      #if COPY_MOVIE_MEDIA      EndMediaEdits(mySrcMedia1);#endif            myEffectName1 = kSourceOneName;            break;          case 0:      // for 0-source effects, we don't need to create a new source track      break;      default:      return(paramErr);  }    //////////  //  // create the effects track and media  //  //////////  myEffectTrack = NewMovieTrack(theMovie, myWidth, myHeight, kNoVolume);  if (myEffectTrack == NULL)    return(GetMoviesError());      myEffectMedia = NewTrackMedia(myEffectTrack, VideoMediaType, myTimeScale, NULL, 0);  if (myEffectMedia == NULL)    return(GetMoviesError());    // create an effect sample description  mySampleDesc = EffectsUtils_MakeSampleDescription(theEffectType, FixedToInt(myWidth), FixedToInt(myHeight));  if (mySampleDesc == NULL)    goto bail;  // create an effect description  myEffectDesc = EffectsUtils_CreateEffectDescription(theEffectType, myEffectName1, myEffectName2, kSourceNoneName);  // add the effect description as a sample to the effects track media  BeginMediaEdits(myEffectMedia);  myErr = AddMediaSample(myEffectMedia, (Handle)myEffectDesc, 0, GetHandleSize((Handle)myEffectDesc), theDuration, (SampleDescriptionHandle)mySampleDesc, 1, 0, &amp;mySampleTime);  if (myErr != noErr)    goto bail;  EndMediaEdits(myEffectMedia);    // add the media sample to the effects track  myErr = InsertMediaIntoTrack(myEffectTrack, theStartTime, mySampleTime, theDuration, fixed1);  if (myErr != noErr)    goto bail;  //////////  //  // create the input map and add references for the source track(s)  //  //////////  myErr = QTNewAtomContainer(&amp;myInputMap);  if (myErr != noErr)    goto bail;    if (mySrcTrack1 != NULL) {      myErr = EffectsUtils_AddTrackReferenceToInputMap(myInputMap, myEffectTrack, mySrcTrack1, kSourceOneName);    if (myErr != noErr)      goto bail;  }      if (mySrcTrack2 != NULL) {      myErr = EffectsUtils_AddTrackReferenceToInputMap(myInputMap, myEffectTrack, mySrcTrack2, kSourceTwoName);    if (myErr != noErr)      goto bail;  }      // add the input map to the effects track  myErr = SetMediaInputMap(myEffectMedia, myInputMap);  if (myErr != noErr)    goto bail;  //////////  //  // do any required positioning and graphics mode manipulation  //  //////////  SetTrackLayer(myEffectTrack, myLayer - 1);  // in front of any existing video track    switch (theNumSources) {    case 2:      break;          case 1:      break;          case 0: {      RGBColor  myColor;            myColor.red = 0;    // (good for fire, not so good for clouds)      myColor.green = 0;      myColor.blue = 0;            MediaSetGraphicsMode(GetMediaHandler(myEffectMedia), transparent, &amp;myColor);      break;    }  }  bail:  if (mySampleDesc != NULL)    DisposeHandle((Handle)mySampleDesc);    if (myInputMap != NULL)    QTDisposeAtomContainer(myInputMap);    return(myErr);}////////////// QTEffects_MakeSpriteEffectMovie// Create a movie with a sprite that uses an effect for its image.////////////void QTEffects_MakeSpriteEffectMovie (void){  Movie          myMovie = NULL;  Track          myTrack = NULL;  Media          myMedia = NULL;  FSSpec          myFile;  Boolean          myIsSelected = false;  Boolean          myIsReplacing = false;    StringPtr         myPrompt = QTUtils_ConvertCToPascalString(kEffectsSaveMoviePrompt);  StringPtr         myFileName = QTUtils_ConvertCToPascalString(kEffectsPenguinMovieFileName);  long          myFlags = createMovieFileDeleteCurFile | createMovieFileDontCreateResFile;  OSType          myType = FOUR_CHAR_CODE('none');  short          myMovieRefNum = kInvalidFileRefNum;  short          myResID = movieInDataForkResID;  OSErr          myErr = noErr;  //////////  //  // create a new movie file  //  //////////  // prompt the user for the destination file name  QTFrame_PutFile(myPrompt, myFileName, &amp;myFile, &amp;myIsSelected, &amp;myIsReplacing);  if (!myIsSelected)    goto bail;  // create a movie file for the destination movie  myErr = CreateMovieFile(&amp;myFile, sigMoviePlayer, smSystemScript, myFlags, &amp;myMovieRefNum, &amp;myMovie);  if (myErr != noErr)    goto bail;    // select the &quot;no controller&quot; movie controller  myType = EndianU32_NtoB(myType);  SetUserDataItem(GetMovieUserData(myMovie), &amp;myType, sizeof(myType), kUserDataMovieControllerType, 1);    //////////  //  // create the sprite track and media  //  //////////    myTrack = NewMovieTrack(myMovie, IntToFixed(kPenguinTrackWidth), IntToFixed(kPenguinTrackHeight), kFullVolume);  if (myTrack == NULL)    goto bail;  myMedia = NewTrackMedia(myTrack, SpriteMediaType, kSpriteMediaTimeScale, NULL, 0);  if (myMedia == NULL)    goto bail;  //////////  //  // add the appropriate samples to the sprite media  //  //////////    myErr = BeginMediaEdits(myMedia);  if (myErr != noErr)    goto bail;  QTEffects_AddPenguinMovieSamplesToMedia(myMedia);    myErr = EndMediaEdits(myMedia);  if (myErr != noErr)    goto bail;    // add the media to the track  InsertMediaIntoTrack(myTrack, 0, 0, GetMediaDuration(myMedia), fixed1);      //////////  //  // set the sprite track properties  //  //////////    QTEffects_SetTrackProperties(myMedia);    //////////  //  // add the movie resource to the movie file  //  //////////    myErr = AddMovieResource(myMovie, myMovieRefNum, &amp;myResID, myFile.name);    bail:  if (myMovieRefNum != kInvalidFileRefNum)    CloseMovieFile(myMovieRefNum);  if (myMovie != NULL)    DisposeMovie(myMovie);      free(myPrompt);  free(myFileName);  return;}////////////// QTEffects_PromptUserForFilesAndMakeEffectMovie// Let the user select some movies, then apply the effect to them.//// If the user cancels the first file-open dialog box, there are zero sources.// If the user cancels the second file-open dialog box, there is one source.// //////////void QTEffects_PromptUserForFilesAndMakeEffectMovie (void){  QTFrameFileFilterUPP  myFileFilterUPP = NULL;  FSSpec          mySpecs[kMaxNumSources];  int            mySpecCount;  OSType           myTypeList[] = {kQTFileTypeMovie};  short          myNumTypes = 1;  OSErr          myErr = noErr;  #if TARGET_OS_MAC  myNumTypes = 0;#endif  myFileFilterUPP = QTFrame_GetFileFilterUPP((ProcPtr)QTFrame_FilterFiles);  // ask for up to kMaxNumSources movie files;  // accept early cancels; they just mean there are fewer input movies  mySpecCount = 0;  while (mySpecCount &lt; kMaxNumSources) {    FSSpec  myFSSpec;    myTypeList[0] = MovieFileType;    myErr = QTFrame_GetOneFileWithPreview(myNumTypes, (QTFrameTypeListPtr)myTypeList, &amp;myFSSpec, myFileFilterUPP);    if (myErr != noErr)      break;  // the user doesn't want any more source movies      // save the FSSpec from the reply information    mySpecs[mySpecCount] = myFSSpec;        mySpecCount++;  }    QTEffects_DisplayDialogForSources(mySpecs, mySpecCount);    if (myFileFilterUPP != NULL)    DisposeNavObjectFilterUPP(myFileFilterUPP);}//////////////////////// QTEffects_AddRippleEffectAsSpriteImage// Add the ripple effect as the image override of the specified sprite image ID.//////////////////////void QTEffects_AddRippleEffectAsSpriteImage (QTAtomContainer theKeySample, QTAtomID theImageID){  ImageDescriptionHandle    mySampleDesc = NULL;  QTAtomContainer        myEffectDesc = NULL;  OSType            myType = kWaterRippleCodecType;  OSErr            myErr = noErr;    // create a sample description  mySampleDesc = EffectsUtils_MakeSampleDescription(myType, kPenguinTrackWidth, kPenguinTrackHeight);  if (mySampleDesc == NULL)    goto bail;  // create an effect description  myEffectDesc = EffectsUtils_CreateEffectDescription(myType, kSourceNoneName, kSourceNoneName, kSourceNoneName);  if (myEffectDesc == NULL)    goto bail;  SpriteUtils_AddCompressedImageToKeyFrameSample(theKeySample, mySampleDesc, GetHandleSize(myEffectDesc), *myEffectDesc, theImageID, NULL, NULL);bail:  if (mySampleDesc != NULL)    DisposeHandle((Handle)mySampleDesc);  if (myEffectDesc != NULL)    QTDisposeAtomContainer(myEffectDesc);      return;}/////////////////////////////////////////////////////////////////////////////////////////////////////////////// Effects dialog utilities.//// Use these functions to work with the effects parameter dialog box./////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// QTEffects_DisplayDialogForSources// Display the standard effects parameters dialog box for the movies passed in.////////////OSErr QTEffects_DisplayDialogForSources (FSSpec *theSpecList, UInt16 theSpecCount){  UInt16          myMovieIter;  OSErr          myErr = noErr;    // make sure that there aren't too many sources  if (theSpecCount &gt; kMaxNumSources) {    myErr = paramErr;    goto bail;  }    // assign source count to a global, so QTEffects_RespondToDialogSelection has access to it  gSpecCount = theSpecCount;        // get the first video track from each movie file  for (myMovieIter = 0; myMovieIter &lt; theSpecCount; myMovieIter++) {    short  myRefNum;        // open a movie file using the FSSpec and create a movie from that file    myErr = OpenMovieFile(&amp;theSpecList[myMovieIter], &amp;myRefNum, 0);    if (myErr != noErr)      goto bail;        myErr = NewMovieFromFile(&amp;gSrcMovies[myMovieIter], myRefNum, NULL, NULL, newMovieActive, NULL);    if (myErr != noErr)      goto bail;        SetMoviePlayHints(gSrcMovies[myMovieIter], hintsHighQuality, hintsHighQuality);    // we're done with the movie file, so close it    CloseMovieFile(myRefNum);        // find the first video track in the source movie    gSrcTracks[myMovieIter] = GetMovieIndTrackType(gSrcMovies[myMovieIter], 1, kCharacteristicCanSendVideo, movieTrackCharacteristic | movieTrackEnabledOnly);    if (gSrcTracks[myMovieIter] == NULL)      goto bail;  }    // ask the user to select an effect  myErr = QTNewAtomContainer(&amp;gEffectDesc);  if (myErr != noErr)    goto bail;    myErr = QTGetEffectsList(&amp;gEffectList, theSpecCount, theSpecCount, 0);  if (myErr != noErr)    goto bail;    // create the effects parameter dialog box, so the user can select an effect  myErr = QTCreateStandardParameterDialog(gEffectList, gEffectDesc, 0, &amp;gEffectsDialog);  if (myErr != noErr)    goto bail;    // insert poster frames into dialog  if (gSrcTracks[0] != NULL) {    gPosterA = GetTrackPict(gSrcTracks[0], GetMoviePosterTime(gSrcMovies[0]));    if (gPosterA != NULL) {      QTParamPreviewRecord      myPreviewRecord;      myPreviewRecord.sourcePicture = gPosterA;      myPreviewRecord.sourceID = 1;      myErr = QTStandardParameterDialogDoAction(gEffectsDialog, pdActionSetPreviewPicture, &amp;myPreviewRecord);    }  }  if (gSrcTracks[1] != NULL) {    gPosterB = GetTrackPict(gSrcTracks[1], GetMoviePosterTime(gSrcMovies[1]));    if (gPosterB != NULL) {      QTParamPreviewRecord      myPreviewRecord;      myPreviewRecord.sourcePicture = gPosterB;      myPreviewRecord.sourceID = 2;      myErr = QTStandardParameterDialogDoAction(gEffectsDialog, pdActionSetPreviewPicture, &amp;myPreviewRecord);    }  }    // now, the frontmost window is the standard effects parameter dialog box;  // on the Mac, we call QTEffects_HandleEffectsDialogEvents in our main event loop  // to find and process events targeted at the effects parameter dialog box; on Windows,  // we need to use a different strategy: we install a modeless dialog callback procedure  // that is called internally by QTML#if TARGET_OS_WIN32  gDoneWithDialog = false;    // force the dialog box to be drawn  {    EventRecord      myEvent = {0};        QTEffects_EffectsDialogCallback(&amp;myEvent, FrontWindow(), 0);  }    SetModelessDialogCallbackProc(FrontWindow(), (QTModelessCallbackUPP)QTEffects_EffectsDialogCallback);  QTMLSetWindowWndProc(FrontWindow(), QTEffects_CustomDialogWndProc);#endif  bail:  return(myErr);}////////////// QTEffects_RespondToDialogSelection// If theErr is codecParameterDialogConfirm, make an effects movie.// If theErr is userCanceledErr, do any necessary clean up.////////////static void QTEffects_RespondToDialogSelection (OSErr theErr){  short          myMovieRefNum = 0;  short          myResID = movieInDataForkResID;  OSType          myEffectCode;  OSType          mySourceName;  Fixed          myTrackWidth, myTrackHeight;  TimeScale        myMovieTimeScale = 600;   TimeValue        myEffectDuration = 0;  TimeValue        mySampleTime = 0;  FSSpec          myFile;  Boolean          myIsSelected = false;  Boolean          myIsReplacing = false;    StringPtr         myPrompt = QTUtils_ConvertCToPascalString(kEffectsSaveMoviePrompt);  StringPtr         myFileName = QTUtils_ConvertCToPascalString(kEffectsSaveMovieFileName);  Movie          myDestMovie = NULL;  Track          myVideoTracks[kMaxNumSources];  Track          myEffectTrack = NULL;  Media          myEffectMedia = NULL;  UInt16          myMovieIter;  ImageDescriptionHandle  mySampleDesc = NULL;  QTAtomContainer      myInputMap = NULL;  long          myFlags = createMovieFileDeleteCurFile | createMovieFileDontCreateResFile;  OSErr          myErr = noErr;    //////////  //  // standard parameter box has been dismissed; first do any necessary clean-up  //  //////////  gEffectsDialog = 0L;  // we're finished with the effect list and movie posters  if (gEffectList != NULL)    QTDisposeAtomContainer(gEffectList);    if (gPosterA != NULL)    KillPicture(gPosterA);      if (gPosterB != NULL)    KillPicture(gPosterB);    // if the user cancelled, bail  if (theErr == userCanceledErr)    goto bail;    //////////  //  // add to gEffectDesc some atoms naming the sources   //  //////////      if (gSpecCount &gt;= 1) {    mySourceName = EndianU32_NtoB(kSourceOneName);    QTInsertChild(gEffectDesc, kParentAtomIsContainer, kEffectSourceName, 1, 0, sizeof(mySourceName), &amp;mySourceName, NULL);  }    if (gSpecCount &gt;= 2) {    mySourceName = EndianU32_NtoB(kSourceTwoName);    QTInsertChild(gEffectDesc, kParentAtomIsContainer, kEffectSourceName, 2, 0, sizeof(mySourceName), &amp;mySourceName, NULL);  }    if (gSpecCount &gt;= 3) {    mySourceName = EndianU32_NtoB(kSourceThreeName);    QTInsertChild(gEffectDesc, kParentAtomIsContainer, kEffectSourceName, 3, 0, sizeof(mySourceName), &amp;mySourceName, NULL);  }    //////////  //  // find out what kind of effect it is  //  //////////      myErr = EffectsUtils_GetTypeFromEffectDescription(gEffectDesc, &amp;myEffectCode);  if (myErr != noErr)    goto bail;  //////////  //  // create the effects movie  //  //////////    // ask the user for the name of the new movie file  QTFrame_PutFile(myPrompt, myFileName, &amp;myFile, &amp;myIsSelected, &amp;myIsReplacing);  if (!myIsSelected)    goto bail;        // deal with user cancelling  // create a movie file for the destination movie  myErr = CreateMovieFile(&amp;myFile, sigMoviePlayer, smSystemScript, myFlags, &amp;myMovieRefNum, &amp;myDestMovie);  if (myErr != noErr)    goto bail;    // copy the user data and settings from the source to the destination movie;  // these settings include information like user data  if (gSpecCount &gt; 0)    CopyMovieSettings(gSrcMovies[0], myDestMovie);    // convert all the movies to have a common time scale;  // we pick the largest time scale out of all the source movies, with a minimum of 600  myMovieTimeScale = 600;  for (myMovieIter = 0; myMovieIter &lt; gSpecCount; myMovieIter++) {    if (myMovieTimeScale &lt; GetMovieTimeScale(gSrcMovies[myMovieIter]))      myMovieTimeScale = GetMovieTimeScale(gSrcMovies[myMovieIter]);  }    for (myMovieIter = 0; myMovieIter &lt; gSpecCount; myMovieIter++) {    if (myMovieTimeScale != GetMovieTimeScale(gSrcMovies[myMovieIter]))      SetMovieTimeScale(gSrcMovies[myMovieIter], myMovieTimeScale);  }    // the effect duration is the minimum of the length of the tracks  if (gSpecCount == 0)    myEffectDuration = myMovieTimeScale * 10;  else    myEffectDuration = GetTrackDuration(gSrcTracks[0]);    for (myMovieIter = 1; myMovieIter &lt; gSpecCount; myMovieIter++) {    if (myEffectDuration &gt; GetTrackDuration(gSrcTracks[myMovieIter]))      myEffectDuration = GetTrackDuration(gSrcTracks[myMovieIter]);  }    // default size when there are no video tracks  myTrackWidth = IntToFixed(kDefaultTrackWidth);  myTrackHeight = IntToFixed(kDefaultTrackHeight);  for (myMovieIter = 0; myMovieIter &lt; kMaxNumSources; myMovieIter++) {    myVideoTracks[myMovieIter] = NULL;  }    // make the video tracks  for (myMovieIter = 0; myMovieIter &lt; gSpecCount; myMovieIter++) {    Fixed  mySrcTrackWidth, mySrcTrackHeight;    OSType  mySrcMediaType = 0;    Media  myVideoMedia;    // myVideoTracks[n] is a clone of gSrcTracks[n]    GetTrackDimensions(gSrcTracks[myMovieIter], &amp;mySrcTrackWidth, &amp;mySrcTrackHeight);        if ((myMovieIter == 0) || (myTrackWidth &lt; mySrcTrackWidth))        myTrackWidth = mySrcTrackWidth;            if ((myMovieIter == 0) || (myTrackHeight &lt; mySrcTrackHeight))        myTrackHeight = mySrcTrackHeight;        GetMediaHandlerDescription(GetTrackMedia(gSrcTracks[myMovieIter]), &amp;mySrcMediaType, NULL, NULL);    myVideoTracks[myMovieIter] = NewMovieTrack(myDestMovie, mySrcTrackWidth, mySrcTrackHeight, kNoVolume);    if (myVideoTracks[myMovieIter] == NULL)      goto bail;    myVideoMedia = NewTrackMedia(myVideoTracks[myMovieIter], mySrcMediaType, myMovieTimeScale, NULL, 0);    if (myVideoMedia == NULL)      goto bail;        if (gCopyMovieMedia) {      myErr = BeginMediaEdits(myVideoMedia);      if (myErr != noErr)        goto bail;    }    myErr = CopyTrackSettings(gSrcTracks[myMovieIter], myVideoTracks[myMovieIter]);    if (myErr != noErr)      goto bail;    myErr = InsertTrackSegment(gSrcTracks[myMovieIter], myVideoTracks[myMovieIter], 0, myEffectDuration, 0);    if (myErr != noErr)      goto bail;        if (gCopyMovieMedia) {      myErr = EndMediaEdits(myVideoMedia);      if (myErr != noErr)        goto bail;    }  }    //////////  //  // create the effects track  //  //////////    // myEffectTrack is the special track that implements the effect  myEffectTrack = NewMovieTrack(myDestMovie, myTrackWidth, myTrackHeight, kNoVolume);  if (myEffectTrack == NULL)    goto bail;  myEffectMedia = NewTrackMedia(myEffectTrack, VideoMediaType, myMovieTimeScale, NULL, 0);  if (myEffectMedia == NULL)    goto bail;  // create the sample description  mySampleDesc = EffectsUtils_MakeSampleDescription(myEffectCode, FixedToInt(myTrackWidth), FixedToInt(myTrackHeight));  if (mySampleDesc == NULL)    goto bail;    //////////  //  // add the effects sample to the movie  //  //////////    myErr = BeginMediaEdits(myEffectMedia);  if (myErr != noErr)    goto bail;  myErr = AddMediaSample(myEffectMedia, gEffectDesc, 0, GetHandleSize(gEffectDesc), myEffectDuration, (SampleDescriptionHandle)mySampleDesc, 1, 0, &amp;mySampleTime);  if (myErr != noErr)    goto bail;  myErr = EndMediaEdits(myEffectMedia);  if (myErr != noErr)    goto bail;  QTDisposeAtomContainer(gEffectDesc);  DisposeHandle((Handle)mySampleDesc);  myErr = InsertMediaIntoTrack(myEffectTrack, 0, mySampleTime, myEffectDuration, fixed1);  if (myErr != noErr)    goto bail;  //////////  //  // create and add the input map  //  //////////  myErr = QTNewAtomContainer(&amp;myInputMap);  if (myErr != noErr)    goto bail;  // first input  if (myVideoTracks[0] != NULL)    EffectsUtils_AddTrackReferenceToInputMap(myInputMap, myEffectTrack, myVideoTracks[0], kSourceOneName);  if (myVideoTracks[1] != NULL)    EffectsUtils_AddTrackReferenceToInputMap(myInputMap, myEffectTrack, myVideoTracks[1], kSourceTwoName);  if (myVideoTracks[2] != NULL)    EffectsUtils_AddTrackReferenceToInputMap(myInputMap, myEffectTrack, myVideoTracks[2], kSourceThreeName);  // set the input map  if (gSpecCount &gt; 0)    SetMediaInputMap(GetTrackMedia(myEffectTrack), myInputMap);  //////////  //  // finish up  //  //////////  myErr = AddMovieResource(myDestMovie, myMovieRefNum, &amp;myResID, NULL);  if (myErr != noErr)    goto bail;    CloseMovieFile(myMovieRefNum);    for (myMovieIter = 0; myMovieIter &lt; gSpecCount; myMovieIter++)    DisposeMovie(gSrcMovies[myMovieIter]);      DisposeMovie(myDestMovie);  bail:  free(myPrompt);  free(myFileName);  if (myInputMap != NULL)    QTDisposeAtomContainer(myInputMap);  return;}#if TARGET_OS_WIN32////////////// QTEffects_EffectsDialogCallback// This function is called by QTML when it processes events for the standard or custom effects parameter dialog box.// //////////static void QTEffects_EffectsDialogCallback (EventRecord *theEvent, DialogRef theDialog, DialogItemIndex theItemHit){  QTParamDialogEventRecord  myRecord;  myRecord.theEvent = theEvent;  myRecord.whichDialog = theDialog;  myRecord.itemHit = theItemHit;  if (gEffectsDialog != 0L) {    QTStandardParameterDialogDoAction(gEffectsDialog, pdActionModelessCallback, &amp;myRecord);      // see if the event is meant for the effects parameter dialog box    QTEffects_HandleEffectsDialogEvents(theEvent, theItemHit);  }}////////////// QTEffects_CustomDialogWndProc// Handle messages for the custom effects parameters dialog box.// //////////LRESULT CALLBACK QTEffects_CustomDialogWndProc (HWND theWnd, UINT theMessage, UINT wParam, LONG lParam){  EventRecord      myEvent = {0};  if (!gDoneWithDialog &amp;&amp; (theMessage == 0x7FFF))    QTEffects_EffectsDialogCallback(&amp;myEvent, GetNativeWindowPort(theWnd), 0);  return(DefWindowProc(theWnd, theMessage, wParam, lParam));}#endif////////////// QTEffects_HandleEffectsDialogEvents// Process events that might be targeted at the standard effects parameter dialog box.// Return true if the event was completely handled.// //////////Boolean QTEffects_HandleEffectsDialogEvents (EventRecord *theEvent, DialogItemIndex theItemHit){#pragma unused(theItemHit)  Boolean      isHandled = false;  OSErr      myErr = noErr;    // pass the event to the standard effects parameter dialog box handler  myErr = QTIsStandardParameterDialogEvent(theEvent, gEffectsDialog);    // the result from QTIsStandardParameterDialogEvent tells us how to respond next  switch (myErr) {        case codecParameterDialogConfirm:    case userCanceledErr:      // the user clicked the OK or Cancel button; dismiss the dialog box and respond accordingly      gDoneWithDialog = true;            if (myErr == codecParameterDialogConfirm)        QTStandardParameterDialogDoAction(gEffectsDialog, pdActionConfirmDialog, NULL);      QTDismissStandardParameterDialog(gEffectsDialog);      gEffectsDialog = 0L;      QTEffects_RespondToDialogSelection(myErr);      isHandled = true;      break;          case noErr:      // the event was completely handled by QTIsStandardParameterDialogEvent      isHandled = true;      break;          case featureUnsupported:      // the event was not handled by QTIsStandardParameterDialogEvent;      // let the event be processed normally      isHandled = false;      break;          default:      // the event was not handled by QTIsStandardParameterDialogEvent;      // do not let the event be processed normally      isHandled = true;      break;  }  return(isHandled);}/////////////////////////////////////////////////////////////////////////////////////////////////////////////// Effects-rendering utilities.//// Use these functions to render an effect into a GWorld./////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// QTEffects_InitWindowData// Do any effects-specific initialization for the specified window.// //////////Handle QTEffects_InitWindowData (WindowObject theWindowObject){  ApplicationDataHdl      myAppData = NULL;  // if we already have some window data, dump it  myAppData = (ApplicationDataHdl)QTFrame_GetAppDataFromWindowObject(theWindowObject);   if (myAppData != NULL)    QTEffects_DumpWindowData(theWindowObject);  // allocate and initialize our application data  myAppData = (ApplicationDataHdl)NewHandleClear(sizeof(ApplicationDataRecord));  return((Handle)myAppData);}////////////// QTEffects_DumpWindowData// Do any effects-specific tear-down for the specified window.////////////void QTEffects_DumpWindowData (WindowObject theWindowObject){  ApplicationDataHdl    myAppData = NULL;      myAppData = (ApplicationDataHdl)QTFrame_GetAppDataFromWindowObject(theWindowObject);  if (myAppData != NULL) {    if ((**myAppData).fGWDesc != NULL)      DisposeHandle((Handle)(**myAppData).fGWDesc);    if ((**myAppData).fGW != NULL)      DisposeGWorld((**myAppData).fGW);    if ((**myAppData).fSampleDescription != NULL)      DisposeHandle((Handle)(**myAppData).fSampleDescription);          if ((**myAppData).fEffectDescription != NULL)      QTDisposeAtomContainer((**myAppData).fEffectDescription);          if ((**myAppData).fEffectSequenceID != 0L)      CDSequenceEnd((**myAppData).fEffectSequenceID);          if ((**myAppData).fTimeBase != NULL)      DisposeTimeBase((**myAppData).fTimeBase);    DisposeHandle((Handle)myAppData);    (**theWindowObject).fAppData = NULL;  }}////////////// QTEffects_SetUpEffectSequence// Set up an effects sequence for a one-source effect.// //////////static OSErr QTEffects_SetUpEffectSequence (WindowObject theWindowObject){  ApplicationDataHdl      myAppData = NULL;  ImageSequenceDataSource    mySrc = 0;  PixMapHandle        mySrcPixMap = NULL;  GraphicsImportComponent    myImporter = NULL;  Rect            myRect;   OSErr            myErr = paramErr;    myAppData = (ApplicationDataHdl)QTFrame_GetAppDataFromWindowObject(theWindowObject);  if (myAppData == NULL)    goto bail;  // if an effect sequence is already set up, end it  if ((**myAppData).fEffectSequenceID != 0L) {    CDSequenceEnd((**myAppData).fEffectSequenceID);    (**myAppData).fEffectSequenceID = 0L;  }    // if there is a timebase already set up, dispose of it  if ((**myAppData).fTimeBase != NULL) {    DisposeTimeBase((**myAppData).fTimeBase);    (**myAppData).fTimeBase = NULL;  }      // make an effects sequence  HLock((Handle)(**myAppData).fEffectDescription);  // prepare the decompression sequence for playback  myErr = DecompressSequenceBeginS(              &amp;(**myAppData).fEffectSequenceID,              (**myAppData).fSampleDescription,#if TARGET_CPU_68K              StripAddress(*(**myAppData).fEffectDescription),#else              *(**myAppData).fEffectDescription,#endif              GetHandleSize((**myAppData).fEffectDescription),              (CGrafPtr)QTFrame_GetPortFromWindowReference((**theWindowObject).fWindow),              NULL,              NULL,              NULL,              ditherCopy,              NULL,              0,              codecNormalQuality,              NULL);  HUnlock((Handle)(**myAppData).fEffectDescription);  if (myErr != noErr)    goto bail;  // create the offscreen GWorld holding the original image data    myImporter = (**theWindowObject).fGraphicsImporter;  if (myImporter == NULL)    goto bail;  // set the size of the GWorld  GraphicsImportGetBoundsRect(myImporter, &amp;myRect);    HLock((Handle)myAppData);  // allocate a new GWorld  myErr = QTNewGWorld(&amp;(**myAppData).fGW, 32, &amp;myRect, NULL, NULL, kICMTempThenAppMemory);  if (myErr != noErr)    goto bail;    // lock the pixmap  LockPixels(GetGWorldPixMap((**myAppData).fGW));  GraphicsImportSetGWorld(myImporter, (**myAppData).fGW, NULL);  GraphicsImportDraw(myImporter);    // get the pixel maps for the GWorlds  mySrcPixMap = GetGWorldPixMap((**myAppData).fGW);  if (mySrcPixMap == NULL)    goto bail;  // make the effect source  if ((**myAppData).fGW == NULL)    goto bail;      myErr = MakeImageDescriptionForPixMap(mySrcPixMap, &amp;(**myAppData).fGWDesc);  if (myErr != noErr)    goto bail;  myErr = CDSequenceNewDataSource((**myAppData).fEffectSequenceID, &amp;mySrc, kSourceOneName, 1, (Handle)(**myAppData).fGWDesc, NULL, 0);  if (myErr != noErr)    goto bail;  CDSequenceSetSourceData(mySrc, GetPixBaseAddr(mySrcPixMap), (**(**myAppData).fGWDesc).dataSize);  // create a new time base and associate it with the decompression sequence  (**myAppData).fTimeBase = NewTimeBase();  myErr = GetMoviesError();  if (myErr != noErr)    goto bail;  SetTimeBaseRate((**myAppData).fTimeBase, 0);  myErr = CDSequenceSetTimeBase((**myAppData).fEffectSequenceID, (**myAppData).fTimeBase);bail:  HUnlock((Handle)myAppData);  return(myErr);}////////////// QTEffects_RunEffect// Run the effect: decompress a single step of the effect sequence.// //////////OSErr QTEffects_RunEffect (WindowObject theWindowObject, TimeValue theTime){  ApplicationDataHdl      myAppData = NULL;  ICMFrameTimeRecord      myFrameTime;   OSErr            myErr = paramErr;    myAppData = (ApplicationDataHdl)QTFrame_GetAppDataFromWindowObject(theWindowObject);  if (myAppData == NULL)    goto bail;  // assertions  if (((**myAppData).fEffectDescription == NULL) || ((**myAppData).fEffectSequenceID == 0L))    goto bail;  // set the timebase time to the step of the sequence to be rendered  SetTimeBaseValue((**myAppData).fTimeBase, theTime, gNumberOfSteps);  myFrameTime.value.hi        = 0;  myFrameTime.value.lo        = theTime;  myFrameTime.scale          = gNumberOfSteps;  myFrameTime.base          = 0;  myFrameTime.duration        = gNumberOfSteps;  myFrameTime.rate          = 0;  myFrameTime.recordSize        = sizeof(myFrameTime);  myFrameTime.frameNumber        = 1;  myFrameTime.flags          = icmFrameTimeHasVirtualStartTimeAndDuration;  myFrameTime.virtualStartTime.lo    = 0;  myFrameTime.virtualStartTime.hi    = 0;  myFrameTime.virtualDuration      = gNumberOfSteps;    HLock((Handle)(**myAppData).fEffectDescription);  myErr = DecompressSequenceFrameWhen(                    (**myAppData).fEffectSequenceID,#if TARGET_CPU_68K                    StripAddress(*((Handle)(**myAppData).fEffectDescription)),#else                    *((Handle)(**myAppData).fEffectDescription),#endif                    GetHandleSize((Handle)(**myAppData).fEffectDescription),                    0,                    NULL,                    NULL,                    &amp;myFrameTime);                      HUnlock((Handle)(**myAppData).fEffectDescription);  bail:  return(myErr);}/////////////////////////////////////////////////////////////////////////////////////////////////////////////// Sprite utilities.//// Use these functions to create sprite tracks./////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// QTEffects_AddPenguinMovieSamplesToMedia// Build the key frame for the penguin sprite movie.////////////static void QTEffects_AddPenguinMovieSamplesToMedia (Media theMedia){  QTAtomContainer      mySample = NULL;  QTAtomContainer      mySpriteData = NULL;  RGBColor        myKeyColor;  Point          myLocation;  short          isVisible, myIndex, myLayer;  OSErr          myErr = noErr;    // create a new, empty key frame sample  myErr = QTNewAtomContainer(&amp;mySample);  if (myErr != noErr)    goto bail;  myKeyColor.red = myKeyColor.green = myKeyColor.blue = 0xffff;    // white    // add images to the key frame sample  SpriteUtils_AddPICTImageToKeyFrameSample(mySample, kPenguinPictID, &amp;myKeyColor, 1, NULL, NULL);  QTEffects_AddRippleEffectAsSpriteImage(mySample, 2);  myErr = QTNewAtomContainer(&amp;mySpriteData);  if (myErr != noErr)    goto bail;  // the penguin sprite  myLocation.h   = 0;  myLocation.v  = 0;  isVisible    = true;  myIndex      = 1;  myLayer      = 0;    SpriteUtils_SetSpriteData(mySpriteData, &amp;myLocation, &amp;isVisible, &amp;myLayer, &amp;myIndex, NULL, NULL, NULL);  SpriteUtils_AddSpriteToSample(mySample, mySpriteData, 1);    QTDisposeAtomContainer(mySpriteData);    myErr = QTNewAtomContainer(&amp;mySpriteData);  if (myErr != noErr)    goto bail;  // the ripple sprite  myLocation.h   = 0;  myLocation.v  = 0;  isVisible    = true;  myIndex      = 2;  myLayer      = -1;  SpriteUtils_SetSpriteData(mySpriteData, &amp;myLocation, &amp;isVisible, &amp;myLayer, &amp;myIndex, NULL, NULL, NULL);    WiredUtils_AddQTEventAndActionAtoms(mySpriteData, kParentAtomIsContainer, kQTEventMouseClick, kActionSpritePassMouseToCodec, NULL);  SpriteUtils_AddSpriteToSample(mySample, mySpriteData, 2);  SpriteUtils_AddSpriteSampleToMedia(theMedia, mySample, kSpriteMediaFrameDurationPenguin, true, NULL);    bail:    if (mySample != NULL)    QTDisposeAtomContainer(mySample);  if (mySpriteData != NULL)    QTDisposeAtomContainer(mySpriteData);  }////////////// QTEffects_SetTrackProperties// Set the track properties for the specified sample sprite movie.////////////void QTEffects_SetTrackProperties (Media theMedia){  QTAtomContainer    myTrackProperties;  RGBColor      myBackgroundColor;  Boolean        hasActions;  OSErr        myErr = noErr;      // add a background color to the sprite track  myBackgroundColor.red = EndianU16_NtoB(0xffff);  myBackgroundColor.green = EndianU16_NtoB(0xffff);  myBackgroundColor.blue = EndianU16_NtoB(0xffff);    myErr = QTNewAtomContainer(&amp;myTrackProperties);  if (myErr == noErr) {    QTInsertChild(myTrackProperties, 0, kSpriteTrackPropertyBackgroundColor, 1, 1, sizeof(myBackgroundColor), &amp;myBackgroundColor, NULL);    // tell the movie controller that this sprite track has actions    hasActions = true;    QTInsertChild(myTrackProperties, 0, kSpriteTrackPropertyHasActions, 1, 1, sizeof(hasActions), &amp;hasActions, NULL);      SetMediaPropertyAtom(theMedia, myTrackProperties);        QTDisposeAtomContainer(myTrackProperties);  }}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/qteffects/listing24.html%3Fid%3DDTS10000833-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/qteffects/listing24.html%3Fid%3DDTS10000833-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/qteffects/listing24.html%3Fid%3DDTS10000833-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>