<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Quartz 2D Programming Guide: Graphics Contexts</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Graphics Contexts"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30001066-CH203" title="Graphics Contexts"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000424" target="_top">Graphics &amp; Imaging</a> &gt; <a href="../../../Quartz-date.html#//apple_ref/doc/uid/TP30000440-TP30000424-TP30000559" target="_top">Quartz</a> &gt; <a href="../dq_intro/dq_intro.html#//apple_ref/doc/uid/TP30001066-CH201-TPXREF101">Quartz 2D Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../dq_overview/dq_overview.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../dq_paths/dq_paths.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30001066-CH203-TPXREF101" title="Graphics Contexts"></a><h1>Graphics Contexts</h1><p>A graphics context represents a drawing destination. It contains drawing parameters and all device-specific information needed to render the paint on a page to the destination, whether the destination is a window in an application, a bitmap, a PDF document, or a printer. You can obtain a graphics context by using Quartz context creation functions or by using higher-level functions provided in the Carbon, Cocoa, or Printing frameworks. Quartz provides creation functions for various flavors of Quartz graphics contexts including bitmap and PDF. The Carbon and Cocoa frameworks provide functions for obtaining window graphics contexts. The Printing framework provides functions that obtain a graphics context appropriate for the kind of destination printer you are using.</p><p>This chapter shows you how to create a graphics context for a variety of drawing destinations. A graphics context is represented in your code by the data type <code>CGContextRef</code>, which is an opaque data type. After you obtain a graphics context you can use Quartz 2D functions to draw to the context, perform operations (such as translations) on the context, and change graphics state parameters, such as line width and fill color.</p><ul class="ul"><li class="li"><p><span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-CJBDCHAC">“Creating a Window Graphics Context”</a></span> shows how to get a context from the Cocoa and Carbon frameworks, what to do if you are moving QuickDraw code to Quartz 2D, and discusses the differences between the HIView and Quartz coordinate systems.</p></li><li class="li"><p><span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-TPXREF118">“Creating a PDF Graphics Context”</a></span> provides code that shows how to obtain and draw into a PDF context.</p></li><li class="li"><p><span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-CJBHBFFE">“Creating a Bitmap Graphics Context”</a></span> discusses the parameters needed to create a bitmap context, shows how to obtain and draw into one, and introduces one method you can use to draw the resulting image to a window graphics context. </p><div class="notebox"><a name="//apple_ref/doc/uid/TP30001066-CH203-DontLinkElementID_48" title="Note"></a><p><strong>Note:</strong>&nbsp; If you want to perform offscreen drawing, before you use a bitmap graphics context, you should first read <span class="content_text"><a href="../dq_layers/dq_layers.html#//apple_ref/doc/uid/TP30001066-CH219-TPXREF101">“CGLayer Drawing.”</a></span> CGLayer objects, introduced in Mac OS X v10.4, support drawing to layers and provide a much more optimized solution for offscreen drawing than bitmap graphics contexts provide.</p></div></li><li class="li"><p><span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-CJBJDEFF">“Obtaining a Graphics Context for Printing”</a></span> describes how to use the Printing framework for Quartz 2D drawing.</p></li></ul><a name="//apple_ref/doc/uid/TP30001066-CH203-CJBDCHAC" title="Creating a Window Graphics Context"></a><h2>Creating a Window Graphics Context</h2><p>The Quartz 2D API provides no functions to obtain a windows graphics context. Instead, you use the Cocoa framework to obtain a context for a window created in Cocoa, and the Carbon framework to obtain a context for a window created in Carbon. Obtaining a window graphics context from the Cocoa framework is fairly straightforward. The approach for obtaining a window graphics context from the Carbon framework depends on whether you are creating a new Mac OS X application or moving a QuickDraw-based application to Quartz 2D. </p><a name="//apple_ref/doc/uid/TP30001066-CH203-DontLinkElementID_3" title="Window Graphics Context in Cocoa"></a><h3>Window Graphics Context in Cocoa</h3><p> You obtain a Quartz graphics context from within the <code>drawRect:</code> routine of a Cocoa application using the following line of code:</p><div class="codesample"><table><tr><td scope="row"><pre>CGContextRef myContext = [[NSGraphicsContext currentContext] graphicsPort];<span></span></pre></td></tr></table></div><p>The method <code>currentContext</code> returns the NSGraphicsContext instance of the current thread. The method <code>graphicsPort</code> returns the low-level, platform-specific graphics context represented by the receiver, which is a Quartz graphics context. (Don’t get confused by the method names; they are historical.) For more information see <code><a href="../../../../Cocoa/Reference/ApplicationKit/Classes/NSGraphicsContext_Class/Reference/Reference.html#//apple_ref/occ/cl/NSGraphicsContext" target="_top">NSGraphicsContext</a></code>.</p><p>After you obtain the graphics context, you can call any of the Quartz 2D drawing functions in your Cocoa application. You can also mix Quartz 2D calls with Cocoa drawing calls. You can see an example of Quartz 2D drawing to a Cocoa view by looking at <span class="content_text">Figure 2-1</span>. The drawing consists of two overlapping rectangles, an opaque red one and a partially transparent blue one. You’ll learn more about transparency in <span class="content_text"><a href="../dq_color/dq_color.html#//apple_ref/doc/uid/TP30001066-CH205-TPXREF101">“Color and Color Spaces.”</a></span> The ability to control how much you can “see through” colors is one of the hallmark features of Quartz 2D.</p><br/><div><a name="//apple_ref/doc/uid/TP30001066-CH203-BCIBAIFD" title="Figure 2-1A view in the Cocoa framework that contains Quartz drawing"></a><p><strong>Figure 2-1&nbsp;&nbsp;</strong>A view in the Cocoa framework that contains Quartz drawing</p><img src = "../Art/cocoa_draw.gif" alt = "A view in the Cocoa framework that contains Quartz drawing" width="325" height="271"></div><br/><p>To create the drawing in <span class="content_text">Figure 2-1</span>, you first create a Cocoa application Xcode project. In Interface Builder, drag a Custom View to the window and subclass it. Then write an implementation for the subclassed view, similar to what <span class="content_text">Listing 2-1</span> shows. For this example, the subclassed view is named MyQuartzView. (You can name it whatever you like.) The <code>drawRect:</code> method for the view contains all the Quartz drawing code. A detailed explanation for each numbered line of code appears following the listing. </p><div class="notebox"><a name="//apple_ref/doc/uid/TP30001066-CH203-DontLinkElementID_49" title="Note"></a><p><strong>Note:</strong>&nbsp;The <code><a href="../../../../Cocoa/Reference/ApplicationKit/Classes/NSView_Class/Reference/NSView.html#//apple_ref/occ/instm/NSView/drawRect:" target="_top">drawRect:</a></code> method of the <code>NSView</code> class is invoked automatically each time the view needs to be drawn. To find out more information about overriding the <code><a href="../../../../Cocoa/Reference/ApplicationKit/Classes/NSView_Class/Reference/NSView.html#//apple_ref/occ/instm/NSView/drawRect:" target="_top">drawRect:</a></code> method, see <em><a href="../../../../Cocoa/Reference/ApplicationKit/Classes/NSView_Class/index.html#//apple_ref/doc/uid/TP40004149" target="_top">NSView Class Reference</a></em>.</p></div><a name="//apple_ref/doc/uid/TP30001066-CH203-BCIBGBIC" title="Listing 2-1Code that draws to a window graphics context"></a><p class="codesample"><strong>Listing 2-1&nbsp;&nbsp;</strong>Code that draws to a window graphics context</p><div class="codesample"><table><tr><td scope="row"><pre>@implementation MyQuartzView<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (id)initWithFrame:(NSRect)frameRect<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    self = [super initWithFrame:frameRect];<span></span></pre></td></tr><tr><td scope="row"><pre>    return self;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>- (void)drawRect:(NSRect)rect<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CGContextRef myContext = [[NSGraphicsContext <span>// 1</span></pre></td></tr><tr><td scope="row"><pre>                                currentContext]graphicsPort];<span></span></pre></td></tr><tr><td scope="row"><pre>   // ********** Your drawing code here ********** <span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    CGContextSetRGBFillColor (myContext, 1, 0, 0, 1);<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    CGContextFillRect (myContext, CGRectMake (0, 0, 200, 100 ));<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    CGContextSetRGBFillColor (myContext, 0, 0, 1, .5);<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>    CGContextFillRect (myContext, CGRectMake (0, 0, 100, 200));<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>  }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>@end<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Obtains a graphics context for the view. </p></li><li class="li"><p>This is where you insert your drawing code. The four lines of code that follow are examples of using Quartz 2D functions.</p></li><li class="li"><p>Sets a red fill color that’s fully opaque. For information on colors and alpha (which sets opacity), see <span class="content_text"><a href="../dq_color/dq_color.html#//apple_ref/doc/uid/TP30001066-CH205-TPXREF101">“Color and Color Spaces.”</a></span></p></li><li class="li"><p>Fills a rectangle whose origin is (<code>0,0</code>) and whose width is <code>200</code> and height is <code>100</code>. For information on drawing rectangles, see <span class="content_text"><a href="../dq_paths/dq_paths.html#//apple_ref/doc/uid/TP30001066-CH211-TPXREF101">“Paths.”</a></span></p></li><li class="li"><p>Sets a blue fill color that’s partially transparent.</p></li><li class="li"><p>Fills a rectangle whose origin is (<code>0,0</code>) and which width is <code>100</code> and height is <code>200</code>.</p></li></ol><a name="//apple_ref/doc/uid/TP30001066-CH203-DontLinkElementID_4" title="Window Graphics Context in Carbon: HIView"></a><h3>Window Graphics Context in Carbon: HIView</h3><p>If you are using the Carbon framework to create a new application for Mac OS X, you will want to use the HIToolbox API, and HIView in particular, for Quartz 2D drawing. HIView is the Quartz-based object-oriented view system available for implementing Carbon user interface elements in Mac OS X. You use Carbon events to obtain a window graphics context from an HIView by installing an event handler that responds to a draw event (<code><a href="../../../../Carbon/Reference/Carbon_Event_Manager_Ref/Reference/reference.html#//apple_ref/c/econst/kEventControlDraw" target="_top">kEventControlDraw</a></code>). As long as the HIView is in a composited window, you can obtain the event parameter <code><a href="../../../../Carbon/Reference/Carbon_Event_Manager_Ref/Reference/reference.html#//apple_ref/c/econst/kEventParamCGContextRef" target="_top">kEventParamCGContextRef</a></code> from the draw event. Draw events for windows that are not composited do not contain this event parameter, which means you must use a composited window. If you can’t, see <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-BCIHDEFA">“Windows Graphics Context: QuickDraw.”</a></span></p><p>You need to perform these steps to draw to an HIView:</p><ol class="ol"><li class="li"><p>In Xcode, create a Carbon application.</p></li><li class="li"><p>Open the <code>.nib</code> file provided by Xcode and place an HIView in the main window. </p><p>Compositing must be turned on for the window. It’s on by default, so make sure you don’t turn it off. </p></li><li class="li"><p>Assign a signature and an ID to the view, as shown in <span class="content_text">Figure 2-2</span>.</p><p>You don’t have to use the signature and ID in the figure. Make note of what you assign to these items. You need to declare constants in your code that have these exact values. Otherwise, your code won’t draw to the view.</p><div class="item_figure"><a name="//apple_ref/doc/uid/TP30001066-CH203-BCIEBDDI" title="Figure 2-2A unique signature and control ID for an HIView"></a><p><strong>Figure 2-2&nbsp;&nbsp;</strong>A unique signature and control ID for an HIView</p><img src = "../Art/view_sig_id.gif" alt = "A unique signature and control ID for an HIView" width="537" height="315"></div></li><li class="li"><p>In your application code, declare constants for the signature and ID.</p></li><li class="li"><p>Install an event handler on the HIView that you want to draw to. The handler must process the event whose class and kind are {<code><a href="../../../../Carbon/Reference/Carbon_Event_Manager_Ref/Reference/reference.html#//apple_ref/c/econst/kEventClassControl" target="_top">kEventClassControl</a></code>, <code><a href="../../../../Carbon/Reference/Carbon_Event_Manager_Ref/Reference/reference.html#//apple_ref/c/econst/kEventControlDraw" target="_top">kEventControlDraw</a></code>}.</p></li><li class="li"><p>In your event handler, obtain a graphics context by calling the Carbon Event Manager function <code><a href="../../../../Carbon/Reference/Carbon_Event_Manager_Ref/Reference/reference.html#//apple_ref/c/func/GetEventParameter" target="_top">GetEventParameter</a></code> and passing the constant <code><a href="../../../../Carbon/Reference/Carbon_Event_Manager_Ref/Reference/reference.html#//apple_ref/c/econst/kEventParamCGContextRef" target="_top">kEventParamCGContextRef</a></code>.</p></li></ol><p><span class="content_text">Listing 2-2</span> and <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-CJBBEIGA">Listing 2-3</a></span> show code that implements the previous steps. <span class="content_text">Listing 2-2</span> is the main routine and <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-CJBBEIGA">Listing 2-3</a></span> implements the event handler for the HIView. The handler obtains a graphics context for an HIView and then draws into that view. A detailed explanation for each numbered line of code appears following each listing.</p><a name="//apple_ref/doc/uid/TP30001066-CH203-BCIGCDAF" title="Listing 2-2The main routine in a Carbon drawing application"></a><p class="codesample"><strong>Listing 2-2&nbsp;&nbsp;</strong>The main routine in a Carbon drawing application</p><div class="codesample"><table><tr><td scope="row"><pre>#define kMyHIViewSignature 'mVue'<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>#define kMyHIViewFieldID 130<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>int main (int argc, char* argv[])<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    IBNibRef            nibRef;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus            err;<span></span></pre></td></tr><tr><td scope="row"><pre>    WindowRef       myMainWindow;<span></span></pre></td></tr><tr><td scope="row"><pre>    HIViewRef       myHIView;<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    static const EventTypeSpec  myHIViewSpec[] = {kEventClassControl,<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>                                kEventControlDraw };<span></span></pre></td></tr><tr><td scope="row"><pre>    static const HIViewID       myHIViewID = { kMyHIViewSignature,<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>                                 kMyHIViewFieldID };<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    err = CreateNibReference (CFSTR("main"), &amp;nibRef);<span></span></pre></td></tr><tr><td scope="row"><pre>    require_noerr (err, CantGetNibRef);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    err = SetMenuBarFromNib(nibRef, CFSTR("MenuBar"));<span></span></pre></td></tr><tr><td scope="row"><pre>    require_noerr (err, CantSetMenuBar);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    err = CreateWindowFromNib (nibRef, CFSTR("MainWindow"), &amp;myMainWindow);<span></span></pre></td></tr><tr><td scope="row"><pre>    require_noerr (err, CantCreateWindow );<span></span></pre></td></tr><tr><td scope="row"><pre>    DisposeNibReference(nibRef);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    HIViewFindByID (HIViewGetRoot(myMainWindow), myHIViewID, &amp;myHIView);    <span>// 5</span></pre></td></tr><tr><td scope="row"><pre>    err = InstallEventHandler (GetControlEventTarget (myHIView), <span>// 6</span></pre></td></tr><tr><td scope="row"><pre>                            NewEventHandlerUPP (MyDrawEventHandler),<span></span></pre></td></tr><tr><td scope="row"><pre>                            GetEventTypeCount (myHIViewSpec),<span></span></pre></td></tr><tr><td scope="row"><pre>                            myHIViewSpec,<span></span></pre></td></tr><tr><td scope="row"><pre>                            (void *) myHIView,<span></span></pre></td></tr><tr><td scope="row"><pre>                            NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>    ShowWindow (myMainWindow);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    RunApplicationEventLoop();<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>CantCreateWindow:<span></span></pre></td></tr><tr><td scope="row"><pre>CantSetMenuBar:<span></span></pre></td></tr><tr><td scope="row"><pre>CantGetNibRef:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return err;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Declares constants for the signature and ID that you assign to the HIView in Interface Builder. Make sure they match exactly and that the combination is unique to your application.</p></li><li class="li"><p>Declares a variable for an <code>HIViewRef</code> data type to reference the HIView. You need this to set up the event handler.</p></li><li class="li"><p>Declares an event specification for the draw event. This is the event your HIView event handler responds to. Your event handler can respond to as many events as you’d like. This example handles only the draw event so that you can see exactly what needs to be done to handle drawing.</p></li><li class="li"><p>Declares an HIView ID using the constants for the signature and ID that you previously assigned and that uniquely identify the HIView in your application.</p></li><li class="li"><p>Obtains the reference to the HIView you placed in the window.</p></li><li class="li"><p>Calls the Carbon Event Manager function to install your event handler on the HIView.</p></li></ol><a name="//apple_ref/doc/uid/TP30001066-CH203-CJBBEIGA" title="Listing 2-3An event handler for an HIView"></a><p class="codesample"><strong>Listing 2-3&nbsp;&nbsp;</strong>An event handler for an HIView</p><div class="codesample"><table><tr><td scope="row"><pre>OSStatus MyDrawEventHandler (EventHandlerCallRef myHandler,<span></span></pre></td></tr><tr><td scope="row"><pre>                        EventRef event, void *userData)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus status = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>    CGContextRef myContext;<span></span></pre></td></tr><tr><td scope="row"><pre>    HIRect      bounds;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status = GetEventParameter (event, <span>// 1</span></pre></td></tr><tr><td scope="row"><pre>                            kEventParamCGContextRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                            typeCGContextRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                            NULL,<span></span></pre></td></tr><tr><td scope="row"><pre>                            sizeof (CGContextRef),<span></span></pre></td></tr><tr><td scope="row"><pre>                            NULL,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;myContext);<span></span></pre></td></tr><tr><td scope="row"><pre>    require_noerr(status, CantGetGraphicsContext);<span></span></pre></td></tr><tr><td scope="row"><pre>    HIViewGetBounds ((HIViewRef) userData, &amp;bounds);<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    require_noerr(status, CantGetBoundingRectangle);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // ********** Your drawing code here ********** <span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    CGContextSetRGBFillColor (myContext, 1, 0, 0, 1);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    CGContextFillRect (myContext, CGRectMake(0, 0, 200, 100 ));<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>    CGContextSetRGBFillColor (myContext, 0, 0, 1, .5);<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>    CGContextFillRect (myContext, CGRectMake (0, 0, 100, 200 ));<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>CantGetGraphicsContext:<span></span></pre></td></tr><tr><td scope="row"><pre>CantGetBoundingRectangle:<span></span></pre></td></tr><tr><td scope="row"><pre>    return status;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Calls the Carbon Event Manager function to obtain the graphics context from the event. You must pass: </p><ul class="ul"><li class="li"><p>The event to get the parameter from. The system passes this event to your handler. Recall that you registered for the draw event.</p></li><li class="li"><p>The symbolic name of the parameter you want to obtain. In this case, pass the system-defined constant <code>kEventParamCGContextRef</code>.</p></li><li class="li"><p>The desired type of the parameter, which you specify as the system-defined constant <code>typeCGContextRef</code>.</p></li><li class="li"><p>The actual type of the parameter, which is <code>NULL</code> because it’s not necessary to get this information for this example.</p></li><li class="li"><p>The size of the data you are obtaining.</p></li><li class="li"><p>The actual size of the data, which is <code>NULL</code> because it’s not necessary to get this information for this example. </p></li><li class="li"><p>A pointer to a <code>CGContextRef</code> data type which, on output, is the window graphics context for the view. This is what you’ll draw to.</p></li></ul></li><li class="li"><p>Obtains the bounding rectangle for the HIView. Note that this code assumes the <code>userData</code> passed to the event handler is an HIViewRef. Another approach you can take is to obtain the view by extracting the event parameter <code>kEventParamDirectObject</code> from the event.</p></li><li class="li"><p>This is where you insert your drawing code. The four lines of code below this are examples of using Quartz 2D functions.</p></li><li class="li"><p>Sets a red fill color that’s fully opaque. For information on colors and alpha (which sets opacity), see <span class="content_text"><a href="../dq_color/dq_color.html#//apple_ref/doc/uid/TP30001066-CH205-TPXREF101">“Color and Color Spaces.”</a></span></p></li><li class="li"><p>Fills a rectangle whose origin is (<code>0,0</code>) and whose width is <code>200</code> and height is <code>100</code>. For information on drawing rectangles, see <span class="content_text"><a href="../dq_paths/dq_paths.html#//apple_ref/doc/uid/TP30001066-CH211-TPXREF101">“Paths.”</a></span></p></li><li class="li"><p>Sets a blue fill color that’s partially transparent.</p></li><li class="li"><p>Fills a rectangle whose origin is (<code>0,0</code>) and which width is <code>100</code> and height is <code>200</code>.</p></li></ol><p><span class="content_text">Figure 2-3</span> shows the output produced by the drawing code in <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-CJBBEIGA">Listing 2-3</a></span>. Compare <span class="content_text">Figure 2-3</span> with the output produced by the same Quartz 2D drawing calls from a Cocoa application, and shown in <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-BCIBAIFD">Figure 2-1</a></span>. Notice that one drawing is flipped with respect to the other. </p><br/><div><a name="//apple_ref/doc/uid/TP30001066-CH203-BCICGHBJ" title="Figure 2-3An HIView uses HIView coordinates to display drawing"></a><p><strong>Figure 2-3&nbsp;&nbsp;</strong>An HIView uses HIView coordinates to display drawing</p><img src = "../Art/carb_hiview_coords.gif" alt = "An HIView uses HIView coordinates to display drawing" width="328" height="270"></div><br/><p>The Quartz coordinate system, as mentioned in <span class="content_text"><a href="../dq_overview/dq_overview.html#//apple_ref/doc/uid/TP30001066-CH202-TPXREF101">“Overview of Quartz 2D,”</a></span> places the origin at the lower-left corner of the view. But HIView returns a context that places the origin a the upper-left corner of the view. Each origin has its advantages. HIView uses the upper left to ensure that the coordinates of objects, such as controls, do not change as the user resizes the window. If you want to use the Quartz coordinate system, you can add the following two lines of code to your event handler, placed just before your drawing code:</p><div class="codesample"><table><tr><td scope="row"><pre>    CGContextTranslateCTM (myContext, 0, bounds.size.height);<span></span></pre></td></tr><tr><td scope="row"><pre>    CGContextScaleCTM (myContext, 1.0, -1.0);<span></span></pre></td></tr></table></div><p>The first line of code translates the coordinate system so that the y values are moved towards the bottom of the HIView by the height of the HIView bounding rectangle. If you were to draw now, your drawing would be below the HIView, not in a visible area.</p><p>The second line of code flips the y-coordinates by a factor of –1.0. Because you just translated the coordinates below the HIView, the scaling effectively flips them into the HIView. After this operation, the origin is at the lower left of the HIView, with the y values increasing from bottom to top. The x values are unchanged; they still increase from left to right.</p><p><span class="content_text">Figure 2-4</span> shows the output from <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-CJBBEIGA">Listing 2-3</a></span> after inserting the translation and scaling code before the drawing code in the handler. The sample code in the rest of this book uses the Quartz coordinate system. If you plan to use an HIView to try out the sample code from the book, you may want to transform the coordinates so that your output matches that shown in the figures.</p><br/><div><a name="//apple_ref/doc/uid/TP30001066-CH203-BCIBEHFE" title="Figure 2-4An HIView that displays a drawing that uses transformed coordinates"></a><p><strong>Figure 2-4&nbsp;&nbsp;</strong>An HIView that displays a drawing that uses transformed coordinates</p><img src = "../Art/carb_quartz_coords.gif" alt = "An HIView that displays a drawing that uses transformed coordinates" width="329" height="272"></div><br/><p>For more information, see <em><a href="../../../../Carbon/Reference/Carbon_Event_Manager_Ref/index.html#//apple_ref/doc/uid/TP30000135" target="_top">Carbon Event Manager Reference</a></em> and <em><a href="../../../../Carbon/Conceptual/HIViewDoc/index.html#//apple_ref/doc/uid/TP30000923" target="_top">HIView Programming Guide</a></em>.</p><a name="//apple_ref/doc/uid/TP30001066-CH203-BCIHDEFA" title="Windows Graphics Context: QuickDraw"></a><h3>Windows Graphics Context: QuickDraw</h3><p>If your application can’t use a compositing window, or if you are moving older QuickDraw code to Quartz, you might need an alternative to obtaining a graphics context from HIView. The QuickDraw functions <code><a href="../../../../Carbon/Reference/QuickDraw_Ref/Reference/reference.html#//apple_ref/doc/c_ref/QDBeginCGContext" target="_top">QDBeginCGContext</a></code> and <code>QDEndCGContext</code> provide such an alternative. The function <code><a href="../../../../Carbon/Reference/QuickDraw_Ref/Reference/reference.html#//apple_ref/doc/c_ref/QDBeginCGContext" target="_top">QDBeginCGContext</a></code> obtains a graphics context for a window port and signals the beginning of Quartz 2D drawing calls. The function <code>QDEndCGContext</code> signals the end of Quartz 2D drawing calls and restores the window port. These functions must be used in pairs.</p><p>The code in <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-BCIGAHJG">Listing 2-4</a></span> produces the output shown in <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-BCIGEGGF">Figure 2-5</a></span>. A detailed explanation for each numbered line of code appears following <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-BCIGAHJG">Listing 2-4</a></span>. Note in the figure that the graphics context provided by <code><a href="../../../../Carbon/Reference/QuickDraw_Ref/Reference/reference.html#//apple_ref/doc/c_ref/QDBeginCGContext" target="_top">QDBeginCGContext</a></code> uses Quartz coordinates. Unlike previous examples, the code draws to a window, not a view, which is why the drawing starts in the window corner and is not indented as it is in <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-BCIBAIFD">Figure 2-1</a></span>, <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-BCICGHBJ">Figure 2-3</a></span>, and <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-BCIBEHFE">Figure 2-4</a></span>.</p><br/><div><a name="//apple_ref/doc/uid/TP30001066-CH203-BCIGEGGF" title="Figure 2-5A window that contains a drawing from a graphics context obtained from QDBeginCGContext"></a><p><strong>Figure 2-5&nbsp;&nbsp;</strong>A window that contains a drawing from a graphics context obtained from QDBeginCGContext</p><img src = "../Art/qdcontext_draw.gif" alt = "A window that contains a drawing from a graphics context obtained from QDBeginCGContext" width="359" height="284"></div><br/><a name="//apple_ref/doc/uid/TP30001066-CH203-BCIGAHJG" title="Listing 2-4Code that obtains a graphics context from QDBeginCGContext"></a><p class="codesample"><strong>Listing 2-4&nbsp;&nbsp;</strong>Code that obtains a graphics context from QDBeginCGContext</p><div class="codesample"><table><tr><td scope="row"><pre>void MyDrawInWindow (WindowRef window)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CGContextRef myContext;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    SetPortWindowPort (window);<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    QDBeginCGContext (GetWindowPort (window), &amp;myContext);<span>// 2</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        // ********** Your drawing code here ********** <span>// 3</span></pre></td></tr><tr><td scope="row"><pre>        CGContextSetRGBFillColor (myContext, 1, 0, 0, 1);<span></span></pre></td></tr><tr><td scope="row"><pre>        CGContextFillRect (myContext, CGRectMake (0, 0, 200, 100));<span></span></pre></td></tr><tr><td scope="row"><pre>        CGContextSetRGBFillColor (myContext, 0, 0, 1, .5);<span></span></pre></td></tr><tr><td scope="row"><pre>        CGContextFillRect (myContext, CGRectMake (0, 0, 100, 200));<span></span></pre></td></tr><tr><td scope="row"><pre>        CGContextFlush(myContext);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>     QDEndCGContext (GetWindowPort(window), &amp;myContext);<span>// 5</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Sets the current graphics port to the window port. </p></li><li class="li"><p>Returns a Quartz graphics context for the supplied color graphics port.</p></li><li class="li"><p>Performs Quartz 2D drawing. You would replace this and the following four lines of code with the Quartz drawing routines appropriate for your application.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30001066-CH203-DontLinkElementID_50" title="Note"></a><p><strong>Note:</strong>&nbsp;You can’t mix Quartz 2D routines with QuickDraw calls. You need to replace QuickDraw with Quartz 2D routines that provide similar functionality. For more information, see <em><a href="../../../../Carbon/Conceptual/QuickDrawToQuartz2D/index.html#//apple_ref/doc/uid/TP40001098" target="_top">Quartz Programming Guide for QuickDraw Developers</a></em>.</p></div></li><li class="li"><p>Forces all pending drawing operations in a window graphics context to be rendered immediately to the destination device. Normally you don’t need to call this function. But you must call this function when you obtain a graphics context using the function <code>QDBeginCGContext</code>. As an alternative, you can call the function <code>CGContextSynchronize</code>, which marks a window graphics context for updating.</p></li><li class="li"><p>Ends the Quartz 2D drawing session. </p></li></ol><a name="//apple_ref/doc/uid/TP30001066-CH203-TPXREF118" title="Creating a PDF Graphics Context"></a><h2>Creating a PDF Graphics Context</h2><p>When you create a PDF graphics context and draw to that context, Quartz records your drawing as a series of PDF drawing commands written to a file. You supply a location for the PDF output and a default <strong>media box</strong>—a rectangle that specifies bounds of the page. <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-BCIHJDCC">Figure 2-6</a></span> shows the result of drawing to a PDF graphics context and then opening the resulting PDF in Preview. </p><br/><div><a name="//apple_ref/doc/uid/TP30001066-CH203-BCIHJDCC" title="Figure 2-6A PDF created by using CGPDFContextCreateWithURL"></a><p><strong>Figure 2-6&nbsp;&nbsp;</strong>A PDF created by using CGPDFContextCreateWithURL</p><img src = "../Art/pdf_context_draw.gif" alt = "A PDF created by using CGPDFContextCreateWithURL" width="297" height="349"></div><br/><p>The Quartz 2D API provides two functions that create a PDF graphics context:</p><ul class="ul"><li class="li"><p><code>CGPDFContextCreateWithURL</code>, which you use when you want to specify the location for the PDF output as a Core Foundation URL. <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-CJBGGCCC">Listing 2-5</a></span> shows how to use this function to create a PDF graphics context.</p></li><li class="li"><p><code>CGPDFContextCreate</code>, which you use when you want the PDF output sent to a data consumer. (For more information see <span class="content_text"><a href="../dq_data_mgr/dq_data_mgr.html#//apple_ref/doc/uid/TP30001066-CH216-TPXREF101">“Data Management.”</a></span>) <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-CJBHIFDC">Listing 2-6</a></span> shows how to use this function to create a PDF graphics context. </p></li></ul><p>A detailed explanation for each numbered line of code follows each listing.</p><a name="//apple_ref/doc/uid/TP30001066-CH203-CJBGGCCC" title="Listing 2-5A routine that calls CGPDFContextCreateWithURL to create a PDF graphics context"></a><p class="codesample"><strong>Listing 2-5&nbsp;&nbsp;</strong>A routine that calls <code>CGPDFContextCreateWithURL</code> to create a PDF graphics context</p><div class="codesample"><table><tr><td scope="row"><pre>CGContextRef MyCreatePDFContext (const CGRect *inMediaBox,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    CFStringRef path)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CGContextRef myOutContext = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFURLRef url;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    url = CFURLCreateWithFileSystemPath (NULL, <span>// 1</span></pre></td></tr><tr><td scope="row"><pre>                                path,<span></span></pre></td></tr><tr><td scope="row"><pre>                                kCFURLPOSIXPathStyle,<span></span></pre></td></tr><tr><td scope="row"><pre>                                false);<span></span></pre></td></tr><tr><td scope="row"><pre>    if (url != NULL) {<span></span></pre></td></tr><tr><td scope="row"><pre>        myOutContext = CGPDFContextCreateWithURL (url,<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>                                        inMediaBox,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(url);<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    return myOutContext;<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Calls the Core Foundation function to create a CFURL object from the CFString object supplied to the <code>MyPDFContextCreate</code> function. You pass <code>NULL</code> as the first parameter to use the default allocator. You also need to specify a path style, which for this example is a POSIX-style pathname.</p></li><li class="li"><p>Calls the Quartz 2D function to create a PDF graphics context using the PDF location just created (as a CFURL object) and a rectangle that specifies the bounds of the PDF. The rectangle (a <code>CGRect</code>) was passed to the <code>MyPDFContextCreate</code> function and is the default page media bounding box for the PDF.</p></li><li class="li"><p>Releases the CFURL object.</p></li><li class="li"><p>Returns the PDF graphics context. The caller must release the graphics context when it is no longer needed.</p></li></ol><a name="//apple_ref/doc/uid/TP30001066-CH203-CJBHIFDC" title="Listing 2-6A routine that calls CGPDFContextCreate to create a PDF graphics context "></a><p class="codesample"><strong>Listing 2-6&nbsp;&nbsp;</strong>A routine that calls <code>CGPDFContextCreate</code> to create a PDF graphics context </p><div class="codesample"><table><tr><td scope="row"><pre>CGContextRef MyCreatePDFContext (const CGRect *inMediaBox,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    CFStringRef path)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CGContextRef        myOutContext = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    CFURLRef            url;<span></span></pre></td></tr><tr><td scope="row"><pre>    CGDataConsumerRef   dataConsumer;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    url = CFURLCreateWithFileSystemPath (NULL, <span>// 1</span></pre></td></tr><tr><td scope="row"><pre>                                        path,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        kCFURLPOSIXPathStyle,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        false);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (url != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        dataConsumer = CGDataConsumerCreateWithURL (url);<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>        if (dataConsumer != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            myOutContext = CGPDFContextCreate (dataConsumer, <span>// 3</span></pre></td></tr><tr><td scope="row"><pre>                                        inMediaBox,<span></span></pre></td></tr><tr><td scope="row"><pre>                                        NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>            CGDataConsumerRelease (dataConsumer);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>        CFRelease(url);<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    return myOutContext;<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Calls the Core Foundation function to create a CFURL object from the CFString object supplied to the <code>MyPDFContextCreate</code> function. You pass <code>NULL</code> as the first parameter to use the default allocator. You also need to specify a path style, which for this example is a POSIX-style path name.</p></li><li class="li"><p>Creates a Quartz data consumer object using the CFURL object. If you don’t want to use a CFURL object (for example, you want to place the PDF data in a location that can’t be specified by a CFURL object), you can instead create a data consumer from a set of callback functions that you implement in your application. For more information, see <span class="content_text"><a href="../dq_data_mgr/dq_data_mgr.html#//apple_ref/doc/uid/TP30001066-CH216-TPXREF101">“Data Management.”</a></span></p></li><li class="li"><p>Calls the Quartz 2D function to create a PDF graphics context passing as parameters the data consumer and the rectangle (of type <code>CGRect</code>) that was passed to the <code>MyPDFContextCreate</code> function. This rectangle is the default page media bounding box for the PDF.</p></li><li class="li"><p>Releases the data consumer.</p></li><li class="li"><p>Releases the CFURL object.</p></li><li class="li"><p>Returns the PDF graphics context. The caller must release the graphics context when it is no longer needed.</p></li></ol><p><span class="content_text">Listing 2-7</span> shows how to call the <code>MyCreatePDFContext</code> routine and draw to it. A detailed explanation for each numbered line of code appears following the listing.</p><a name="//apple_ref/doc/uid/TP30001066-CH203-BCIEFGED" title="Listing 2-7Code that draws to a PDF graphics context"></a><p class="codesample"><strong>Listing 2-7&nbsp;&nbsp;</strong>Code that draws to a PDF graphics context</p><div class="codesample"><table><tr><td scope="row"><pre>    CGRect mediaBox;<span>// 1</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    mediaBox = CGRectMake (0, 0, myPageWidth, myPageHeight);<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    myPDFContext = MyCreatePDFContext (&amp;mediaBox, CFSTR("test.pdf"));<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    CGContextBeginPage(myPDFContext, &amp;mediaBox);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>        // ********** Your drawing code here **********<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>        CGContextSetRGBFillColor (myPDFContext, 1, 0, 0, 1);<span></span></pre></td></tr><tr><td scope="row"><pre>        CGContextFillRect (myPDFContext, CGRectMake (0, 0, 200, 100 ));<span></span></pre></td></tr><tr><td scope="row"><pre>        CGContextSetRGBFillColor (myPDFContext, 0, 0, 1, .5);<span></span></pre></td></tr><tr><td scope="row"><pre>        CGContextFillRect (myPDFContext, CGRectMake (0, 0, 100, 200 ));<span></span></pre></td></tr><tr><td scope="row"><pre>    CGContextEndPage(myPDFContext);<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>    CGContextRelease(myPDFContext);<span>// 7</span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Declares a variable for the rectangle that you use to define the PDF media box.</p></li><li class="li"><p>Sets the origin of the media box to <code>(0,0)</code> and the width and height to variables supplied by the application.</p></li><li class="li"><p>Calls the function <code>MyCreatePDFContext</code> (See <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-CJBHIFDC">Listing 2-6</a></span>) to obtain a PDF graphics context, supplying a media box and a path name. The macro <code>CFSTR</code> converts a string to a <code>CFStringRef</code> data type.</p></li><li class="li"><p>Signals the start of a page. This function is used for page-paged graphics, which is what PDF drawing is. This example passes the media box to define the page boundary. You don’t have to pass the same rectangle you used to set up the PDF graphics context. The rectangle you pass to <code>CGContextBeginPage</code> supersedes the rectangle you pass to set up the PDF graphics context.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30001066-CH203-DontLinkElementID_51" title="Note"></a><p><strong>Note:</strong>&nbsp; Starting in Mac OS X v10.4, you can call the function <code><a href="../../../Reference/CGPDFContext/Reference/reference.html#//apple_ref/doc/c_ref/CGPDFContextBeginPage" target="_top">CGPDFContextBeginPage</a></code> and its companion <code><a href="../../../Reference/CGPDFContext/Reference/reference.html#//apple_ref/doc/c_ref/CGPDFContextEndPage" target="_top">CGPDFContextEndPage</a></code> to delineate PDF pages. You can provide a CFDictionary to the function <code>CGPDFContextBeginPage</code> to specify page properties.</p></div></li><li class="li"><p>Calls Quartz 2D drawing functions. You replace this and the following four lines of code with the drawing code appropriate for your application.</p></li><li class="li"><p>Signals the end of the PDF page.</p></li><li class="li"><p>Releases the PDF graphics context when it is no longer needed.</p></li></ol><p>You can write any content to a PDF that’s appropriate for your application—images, text, path drawing—and you can add links and encryption. For more information see <span class="content_text"><a href="../dq_pdf/dq_pdf.html#//apple_ref/doc/uid/TP30001066-CH214-TPXREF101">“PDF Document Creation, Viewing, and Transforming.”</a></span></p><a name="//apple_ref/doc/uid/TP30001066-CH203-CJBHBFFE" title="Creating a Bitmap Graphics Context"></a><h2>Creating a Bitmap Graphics Context</h2><p>A bitmap graphics context accepts a pointer to a memory buffer that contains storage space for the bitmap. When you paint into the bitmap graphics context, the buffer is updated. After you release the graphics context, you have a fully updated bitmap in the pixel format you specify.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30001066-CH203-DontLinkElementID_52" title="Note"></a><p><strong>Note:</strong>&nbsp;Bitmap graphics contexts are sometimes used for drawing offscreen. Before you decide to use a bitmap graphics context for this purpose, see <span class="content_text"><a href="../dq_layers/dq_layers.html#//apple_ref/doc/uid/TP30001066-CH219-TPXREF101">“CGLayer Drawing.”</a></span> CGLayer objects (<code>CGLayerRef</code>), available in Mac OS X v10.4 and later, are optimized for offscreen drawing because, whenever possible, Quartz caches layers on the video card. </p></div><p>You use the function <code><a href="../../../Reference/CGBitmapContext/Reference/reference.html#//apple_ref/doc/c_ref/CGBitmapContextCreate" target="_top">CGBitmapContextCreate</a></code> to create a bitmap graphics context. This function takes the following parameters:</p><ul class="ul"><li class="li"><p><code>data</code>. Supply a pointer to the destination in memory where you want the drawing rendered. The size of this memory block should be at least (<code>bytesPerRow</code>*<code>height</code>) bytes.</p></li><li class="li"><p><code>width</code>. Specify the width, in pixels, of the bitmap.</p></li><li class="li"><p><code>height</code>. Specify the height, in pixels, of the bitmap.</p></li><li class="li"><p><code>bitsPerComponent</code>. Specify the number of bits to use for each component of a pixel in memory. For example, for a 32-bit pixel format and an RGB color space, you would specify a value of 8 bits per component. See <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-BCIBHHBB">“Supported Pixel Formats.”</a></span></p></li><li class="li"><p><code>bytesPerRow</code>. Specify the number of bytes of memory to use per row of the bitmap.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30001066-CH203-DontLinkElementID_53" title="Tip"></a><p><strong>Tip:</strong>&nbsp; When you create a bitmap graphics context, you’ll get the best performance if you make sure the data and <code>bytesPerRow</code> are 16-byte aligned.</p></div></li><li class="li"><p><code>colorspace</code>. The color space to use for the bitmap context. You can provide a Gray, RGB, CMYK, or NULL color space when you create a bitmap graphics context. For detailed information on color spaces and color management principles, see <em><a href="../../csintro/index.html#//apple_ref/doc/uid/TP30001148" target="_top">Color Management Overview</a></em>. For information on creating and using color spaces in Quartz, see <span class="content_text"><a href="../dq_color/dq_color.html#//apple_ref/doc/uid/TP30001066-CH205-TPXREF101">“Color and Color Spaces.”</a></span> For information about supported color spaces, see <span class="content_text"><a href="../dq_images/dq_images.html#//apple_ref/doc/uid/TP30001066-CH212-CJBHEGIB">“Color Spaces and Bitmap Layout”</a></span> in the <span class="content_text"><a href="../dq_images/dq_images.html#//apple_ref/doc/uid/TP30001066-CH212-TPXREF101">“Bitmap Images and Image Masks”</a></span> chapter.</p></li><li class="li"><p><code>bitmapInfo</code>. Bitmap layout information, expressed as a <code>CGImageBitmapInfo</code> constant in Mac OS X v10.4, that specifies whether the bitmap should contain an alpha component, the relative location of the alpha component (if there is one) in a pixel, whether the alpha component is premultiplied, and whether the color components are integer or floating point values. (In earlier versions of Mac OS X, this constant is expressed as a <code>CGImageAlphaInfo</code> constant.) For detailed information on what these constants are, when each is used, and Quartz-supported pixel formats for bitmap graphics contexts and images, see <span class="content_text"><a href="../dq_images/dq_images.html#//apple_ref/doc/uid/TP30001066-CH212-CJBHEGIB">“Color Spaces and Bitmap Layout”</a></span> in the <span class="content_text"><a href="../dq_images/dq_images.html#//apple_ref/doc/uid/TP30001066-CH212-TPXREF101">“Bitmap Images and Image Masks”</a></span> chapter.</p></li></ul><p><span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-CJBFDAEC">Listing 2-8</a></span> shows how to create a bitmap graphics context. When you draw into the resulting bitmap graphics context, Quartz records your drawing as bitmap data in the specified block of memory. A detailed explanation for each numbered line of code follows the listing. </p><a name="//apple_ref/doc/uid/TP30001066-CH203-CJBFDAEC" title="Listing 2-8A routine that creates a bitmap graphics context"></a><p class="codesample"><strong>Listing 2-8&nbsp;&nbsp;</strong>A routine that creates a bitmap graphics context</p><div class="codesample"><table><tr><td scope="row"><pre>CGContextRef MyCreateBitmapContext (int pixelsWide,<span></span></pre></td></tr><tr><td scope="row"><pre>                            int pixelsHigh)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CGContextRef    context = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    CGColorSpaceRef colorSpace;<span></span></pre></td></tr><tr><td scope="row"><pre>    void *          bitmapData;<span></span></pre></td></tr><tr><td scope="row"><pre>    int             bitmapByteCount;<span></span></pre></td></tr><tr><td scope="row"><pre>    int             bitmapBytesPerRow;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    bitmapBytesPerRow   = (pixelsWide * 4);<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    bitmapByteCount     = (bitmapBytesPerRow * pixelsHigh);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    colorSpace = CGColorSpaceCreateWithName(kCGColorSpaceGenericRGB);<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    bitmapData = malloc( bitmapByteCount );<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    if (bitmapData == NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        fprintf (stderr, "Memory not allocated!");<span></span></pre></td></tr><tr><td scope="row"><pre>        return NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    context = CGBitmapContextCreate (bitmapData,<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>                                    pixelsWide,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    pixelsHigh,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    8,      // bits per component<span></span></pre></td></tr><tr><td scope="row"><pre>                                    bitmapBytesPerRow,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    colorSpace,<span></span></pre></td></tr><tr><td scope="row"><pre>                                    kCGImageAlphaPremultipliedLast);<span></span></pre></td></tr><tr><td scope="row"><pre>    if (context== NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        free (bitmapData);<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>        fprintf (stderr, "Context not created!");<span></span></pre></td></tr><tr><td scope="row"><pre>        return NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre>    CGColorSpaceRelease( colorSpace );<span>// 6</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return context;<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Declares a variable to represent the number of bytes per row. Each pixel in the bitmap in this example is represented by 4 bytes; 8 bits each of red, green, blue, and alpha. </p></li><li class="li"><p>Creates a generic RGB color space. You can also create a CMYK color space. See <span class="content_text"><a href="../dq_color/dq_color.html#//apple_ref/doc/uid/TP30001066-CH205-TPXREF101">“Color and Color Spaces”</a></span> for more information and for a discussion of generic color spaces versus device dependent ones.</p></li><li class="li"><p>Calls the <code><!--a-->malloc<!--/a--></code> function to create a block of memory in which to store the bitmap data. This example creates a 32-bit RGBA bitmap (that is, an array with 32 bits per pixel, each pixel containing 8 bits each of red, green, blue, and alpha information). Each pixel in the bitmap occupies 4 bytes of memory.</p></li><li class="li"><p>Creates a bitmap graphics context, supplying the bitmap data, the width and height of the bitmap, the number of bits per component, the bytes per row, the color space, and a constant that specifies whether the bitmap should contain an alpha channel and its relative location in a pixel. The constant <code>kCGImageAlphaPremultipliedLast</code> indicates that the alpha component is stored in the last byte of each pixel and that the color components have already been multiplied by this alpha value. See <span class="content_text"><a href="../dq_color/dq_color.html#//apple_ref/doc/uid/TP30001066-CH205-TPXREF119">“The Alpha Value”</a></span> for more information on premultiplied alpha.</p></li><li class="li"><p>If the context isn’t created for some reason, frees the memory allocated for the bitmap data.</p></li><li class="li"><p>Releases the color space.</p></li><li class="li"><p>Returns the bitmap graphics context. The caller must release the graphics context when it is no longer needed.</p></li></ol><p><span class="content_text">Listing 2-9</span> shows code that calls <code>MyCreateBitmapContext</code> to create a bitmap graphics context, uses the bitmap graphics context to create a CGImage, then draws the resulting image to a window graphics context. <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-BCIFEBAI">Figure 2-7</a></span> shows the image drawn to the window. A detailed explanation for each numbered line of code follows the listing. </p><a name="//apple_ref/doc/uid/TP30001066-CH203-BCICJBGG" title="Listing 2-9Code that draws to a bitmap graphics context"></a><p class="codesample"><strong>Listing 2-9&nbsp;&nbsp;</strong>Code that draws to a bitmap graphics context</p><div class="codesample"><table><tr><td scope="row"><pre>    CGRect myBoundingBox;<span>// 1</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    myBoundingBox = CGRectMake (0, 0, myWidth, myHeight);<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    myBitmapContext = MyCreateBitmapContext (400, 300);<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    // ********** Your drawing code here ********** <span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    CGContextSetRGBFillColor (myBitmapContext, 1, 0, 0, 1);<span></span></pre></td></tr><tr><td scope="row"><pre>    CGContextFillRect (myBitmapContext, CGRectMake (0, 0, 200, 100 ));<span></span></pre></td></tr><tr><td scope="row"><pre>    CGContextSetRGBFillColor (myBitmapContext, 0, 0, 1, .5);<span></span></pre></td></tr><tr><td scope="row"><pre>    CGContextFillRect (myBitmapContext, CGRectMake (0, 0, 100, 200 ));<span></span></pre></td></tr><tr><td scope="row"><pre>    myImage = CGBitmapContextCreateImage (myBitmapContext);<span>// 5</span></pre></td></tr><tr><td scope="row"><pre>    CGContextDrawImage(myContext, myBoundingBox, myImage);<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>    char *bitmapData = CGBitmapContextGetData(myBitmapContext); <span>// 7</span></pre></td></tr><tr><td scope="row"><pre>    CGContextRelease (myBitmapContext);<span>// 8</span></pre></td></tr><tr><td scope="row"><pre>    if (bitmapData) free(bitmapData); <span>// 9</span></pre></td></tr><tr><td scope="row"><pre>    CGImageRelease(myImage);<span>// 10</span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Declares a variable to store the origin and dimensions of the bounding box into which Quartz will draw an image created from the bitmap graphics context.</p></li><li class="li"><p>Sets the origin of the bounding box to (0,0) and the width and height to variables previously declared, but whose declaration are not shown in this code.</p></li><li class="li"><p>Calls the application supplied function <code>MyCreateBimapContext</code> (see <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-CJBFDAEC">Listing 2-8</a></span>) to create a bitmap context that is 400 pixels wide and 300 pixels high. You can create a bitmap graphics context using any dimensions that are appropriate for your application.</p></li><li class="li"><p>Calls Quartz 2D functions to draw into the bitmap graphics context. You would replace this and the next four lines of code with drawing code appropriate for your application.</p></li><li class="li"><p>Creates a Quartz 2D image (<code>CGImageRef</code>) from the bitmap graphics context. The function <code>CGBitmapContextCreateImage</code> is available in Mac OS X v10.4 and later. For information on creating Quartz 2D images from a bitmap graphics context in earlier versions of Mac OS X, see <span class="content_text"><a href="../dq_images/dq_images.html#//apple_ref/doc/uid/TP30001066-CH212-TPXREF101">“Bitmap Images and Image Masks.”</a></span></p></li><li class="li"><p>Draws the image into the location in the window graphics context that is specified by the bounding box. The bounding box specifies the location and dimensions in user space in which to draw the image.</p><p> This example does not show the creation of the window graphics context. See <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-CJBDCHAC">“Creating a Window Graphics Context”</a></span> for information on how to create one.</p></li><li class="li"><p>Gets the bitmap data associated with the bitmap graphics context.</p></li><li class="li"><p>Releases the bitmap graphics context when it is no longer needed.</p></li><li class="li"><p>Free the bitmap data if it exists.</p></li><li class="li"><p>Releases the image when it is no longer needed.</p></li></ol><br/><div><a name="//apple_ref/doc/uid/TP30001066-CH203-BCIFEBAI" title="Figure 2-7An image created from a bitmap graphics context and drawn to a window graphics context"></a><p><strong>Figure 2-7&nbsp;&nbsp;</strong>An image created from a bitmap graphics context and drawn to a window graphics context</p><img src = "../Art/bitmap.gif" alt = "An image created from a bitmap graphics context and drawn to a window graphics context" width="327" height="270"></div><br/><a name="//apple_ref/doc/uid/TP30001066-CH203-BCIBHHBB" title="Supported Pixel Formats"></a><h3>Supported Pixel Formats</h3><p><span class="content_text">Table 2-1</span> summarizes the pixel formats that are supported for bitmap graphics context, the associated color space (cs), and the format availability in versions of Mac OS X. The pixel format is specified as bits per pixel (bpp) and bits per component (bpc). The table also includes the bitmap information constant associated with that pixel format. See <em><a href="../../../Reference/CGImage/index.html#//apple_ref/doc/uid/TP30000956" target="_top">CGImage Reference</a></em> for details on what each of the bitmap information format constants represent.</p><a name="//apple_ref/doc/uid/TP30001066-CH203-CJBEAGHH" title="Table 2-1Color space (CS), pixel formats, and availability information"></a><div class="tableholder"><table class="graybox" border = "0" cellspacing="0" cellpadding="5"><caption class="tablecaption"><strong>Table 2-1&nbsp;&nbsp;</strong>Color space (CS), pixel formats, and availability information</caption><tr><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>CS</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Pixel Format and Bitmap Information Constant</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Availability</p></th></tr><tr><td  scope="row"><p>Gray</p></td><td ><p>8 bpp, 8 bpc,<code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGImageAlphaNone" target="_top">kCGImageAlphaNone</a></code> </p></td><td ><p>10.0</p></td></tr><tr><td  scope="row"><p>Null</p></td><td ><p>8 bpp, 8 bpc, <code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGImageAlphaOnly" target="_top">kCGImageAlphaOnly</a></code></p></td><td ><p>10.3</p></td></tr><tr><td  scope="row"><p>RGB</p></td><td ><p>16 bpp, 5 bpc, <code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGImageAlphaNoneSkipFirst" target="_top">kCGImageAlphaNoneSkipFirst</a></code></p></td><td ><p>10.0</p></td></tr><tr><td  scope="row"><p>RGB</p></td><td ><p>32 bpp, 8 bpc, <code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGImageAlphaNoneSkipFirst" target="_top">kCGImageAlphaNoneSkipFirst</a></code></p></td><td ><p>10.0</p></td></tr><tr><td  scope="row"><p>RGB</p></td><td ><p>32 bpp, 8 bpc, <code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGImageAlphaNoneSkipLast" target="_top">kCGImageAlphaNoneSkipLast</a></code></p></td><td ><p>10.0</p></td></tr><tr><td  scope="row"><p>RGB</p></td><td ><p>32 bpp, 8 bpc, <code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGImageAlphaPremultipliedFirst" target="_top">kCGImageAlphaPremultipliedFirst</a></code></p></td><td ><p>10.0</p></td></tr><tr><td  scope="row"><p>RGB</p></td><td ><p>32 bpp, 8 bpc, <code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGImageAlphaPremultipliedLast" target="_top">kCGImageAlphaPremultipliedLast</a></code></p></td><td ><p>10.0</p></td></tr><tr><td  scope="row"><p>CMYK</p></td><td ><p>32 bpp, 8 bpc, <code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGImageAlphaNone" target="_top">kCGImageAlphaNone</a></code></p></td><td ><p>10.3</p></td></tr><tr><td  scope="row"><p>Gray</p></td><td ><p>32 bpp, 32 bpc, <code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGImageAlphaNone" target="_top">kCGImageAlphaNone</a></code>|<code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGBitmapFloatComponents" target="_top">kCGBitmapFloatComponents</a></code></p></td><td ><p>10.4</p></td></tr><tr><td  scope="row"><p>RGB</p></td><td ><p>128 bpp, 32 bpc, <code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGImageAlphaNoneSkipLast" target="_top">kCGImageAlphaNoneSkipLast</a></code> |<code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGBitmapFloatComponents" target="_top">kCGBitmapFloatComponents</a></code></p></td><td ><p>10.4</p></td></tr><tr><td  scope="row"><p>RGB</p></td><td ><p>128 bpp, 32 bpc,  <code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGImageAlphaPremultipliedLast" target="_top">kCGImageAlphaPremultipliedLast</a></code> |<code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGBitmapFloatComponents" target="_top">kCGBitmapFloatComponents</a></code></p></td><td ><p>10.4</p></td></tr><tr><td  scope="row"><p>CMYK</p></td><td ><p>128 bpp, 32 bpc,  <code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGImageAlphaNone" target="_top">kCGImageAlphaNone</a></code> |<code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGBitmapFloatComponents" target="_top">kCGBitmapFloatComponents</a></code></p></td><td ><p>10.4</p></td></tr><tr><td  scope="row"><p>Gray</p></td><td ><p>16 bpp, 16 bpc,  <code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGImageAlphaNone" target="_top">kCGImageAlphaNone</a></code></p></td><td ><p>10.5</p></td></tr><tr><td  scope="row"><p>RGB</p></td><td ><p>64 bpp, 16 bpc,  <code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGImageAlphaPremultipliedLast" target="_top">kCGImageAlphaPremultipliedLast</a></code></p></td><td ><p>10.5</p></td></tr><tr><td  scope="row"><p>RGB</p></td><td ><p>64 bpp, 16 bpc, <code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGImageAlphaNoneSkipLast" target="_top">kCGImageAlphaNoneSkipLast</a></code> </p></td><td ><p>10.5</p></td></tr><tr><td  scope="row"><p>CMYK</p></td><td ><p>64 bpp, 16 bpc,  <code><a href="../../../Reference/CGImage/Reference/reference.html#//apple_ref/c/econst/kCGImageAlphaNone" target="_top">kCGImageAlphaNone</a></code></p></td><td ><p>10.5</p></td></tr></table></div><a name="//apple_ref/doc/uid/TP30001066-CH203-BBCBHADI" title="Anti-Aliasing"></a><h3>Anti-Aliasing</h3><p>Bitmap graphics contexts support <strong>anti-aliasing</strong>, which is the process of artificially correcting the jagged (or <strong>aliased</strong>) edges you sometimes see in bitmap images when text or shapes are drawn. These jagged edges occur when the resolution of the bitmap is significantly lower than the resolution of your eyes. To make objects appear smooth in the bitmap, Quartz uses different colors for the pixels that surround the outline of the shape. By blending the colors in this way, the shape appears smooth. You can see the effect of using anti-aliasing in <span class="content_text">Figure 2-8</span>. You can turn anti-aliasing off for a particular bitmap graphics context by calling the function <code><a href="../../../Reference/CGContext/Reference/reference.html#//apple_ref/doc/c_ref/CGContextSetShouldAntialias" target="_top">CGContextSetShouldAntialias</a></code>. The anti-aliasing setting is part of the graphics state.</p><p>As of Mac OS X v10.4 you can control whether or not to allow anti-aliasing for a particular graphics context by using the function <code><a href="../../../Reference/CGContext/Reference/reference.html#//apple_ref/doc/c_ref/CGContextSetAllowsAntialiasing" target="_top">CGContextSetAllowsAntialiasing</a></code>. Pass <code>true</code> to this function to allow anti-aliasing; <code>false</code> not to allow it. This setting is not part of the graphics state. Quartz performs anti-aliasing for a graphics context if you allow anti-aliasing by passing <code>true</code> to <code><a href="../../../Reference/CGContext/Reference/reference.html#//apple_ref/doc/c_ref/CGContextSetAllowsAntialiasing" target="_top">CGContextSetAllowsAntialiasing</a></code> and you set the anti-aliasing graphics state parameter to <code>true</code> by calling <code><a href="../../../Reference/CGContext/Reference/reference.html#//apple_ref/doc/c_ref/CGContextSetShouldAntialias" target="_top">CGContextSetShouldAntialias</a></code>.</p><br/><div><a name="//apple_ref/doc/uid/TP30001066-CH203-BBCFJDBF" title="Figure 2-8A comparison of aliased and anti-aliasing drawing"></a><p><strong>Figure 2-8&nbsp;&nbsp;</strong>A comparison of aliased and anti-aliasing drawing</p><img src = "../Art/antialias.gif" alt = "A comparison of aliased and anti-aliasing drawing" width="304" height="360"></div><br/><a name="//apple_ref/doc/uid/TP30001066-CH203-CJBJDEFF" title="Obtaining a Graphics Context for Printing"></a><h2>Obtaining a Graphics Context for Printing</h2><p>When you use the Carbon Printing Manager to print from an application in Mac OS X, you call the function <code>PMSessionGetGraphicsContext</code> to obtain a graphics context for each page you print. The Carbon Printing Manager manages the graphics context for your application so that your documents are output appropriately, whether to a raster printer or as PostScript data. </p><p>The code in <span class="content_text"><a href="dq_context.html#//apple_ref/doc/uid/TP30001066-CH203-CJBBHJBB">Listing 2-10</a></span> is an excerpt from a more complex printing routine. The purpose is to point out the basic calls you need to make to print to a Quartz graphics context, and not to show you how to use the Carbon Printing Manager. You can find detailed information on how to print in <em><a href="../../../../Carbon/Conceptual/CPM_Concepts/index.html#//apple_ref/doc/uid/TP30000978" target="_top">Supporting Printing in Your Carbon Application</a></em> and <em><a href="../../../../Carbon/Reference/CarbonPrintingManager_Ref/index.html#//apple_ref/doc/uid/TP30000048" target="_top">Carbon Printing Manager Reference</a></em>. </p><p>A detailed explanation for each numbered line of code appears following the listing. Within the code, embedded comments provide you with additional guidance.</p><a name="//apple_ref/doc/uid/TP30001066-CH203-CJBBHJBB" title="Listing 2-10Code that prints to a Quartz graphics context"></a><p class="codesample"><strong>Listing 2-10&nbsp;&nbsp;</strong>Code that prints to a Quartz graphics context</p><div class="codesample"><table><tr><td scope="row"><pre>    CFStringRef         strings[1];<span></span></pre></td></tr><tr><td scope="row"><pre>    CFArrayRef          myGraphicsContextsArray;<span></span></pre></td></tr><tr><td scope="row"><pre>    CGContextRef        printingContext;<span></span></pre></td></tr><tr><td scope="row"><pre>    PMPrintSession      printSession;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    strings[0] = kPMGraphicsContextCoreGraphics; <span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    myGraphicsContextsArray = CFArrayCreate (kCFAllocatorDefault,<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>                        (const void **) strings,<span></span></pre></td></tr><tr><td scope="row"><pre>                        1,<span></span></pre></td></tr><tr><td scope="row"><pre>                        &amp;kCFTypeArrayCallBacks);<span></span></pre></td></tr><tr><td scope="row"><pre>    if (myGraphicsContextsArray != NULL)<span></span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        PMSessionSetDocumentFormatGeneration (printSession,<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>                            kPMDocumentFormatPDF,<span></span></pre></td></tr><tr><td scope="row"><pre>                            myGraphicsContextsArray,<span></span></pre></td></tr><tr><td scope="row"><pre>                            NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>    CFRelease (myGraphicsContextsArray);<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    // More of your print loop code here<span></span></pre></td></tr><tr><td scope="row"><pre>    // Your call to PMSessionBeginDocument<span></span></pre></td></tr><tr><td scope="row"><pre>    // Your call to PMSessionBeginPage here<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    PMSessionGetGraphicsContext (printSession,<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>                                kPMGraphicsContextCoreGraphics,<span></span></pre></td></tr><tr><td scope="row"><pre>                                (void **) &amp;printingContext);<span></span></pre></td></tr><tr><td scope="row"><pre>    // Use Quartz 2D routines to draw content to the context<span></span></pre></td></tr><tr><td scope="row"><pre>    // Then, continue your print loop<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Assigns the Carbon Printing Manager constant <code>kPMGraphicsContextCoreGraphics</code> to the first element of an array of strings. This constant specifies a Quartz 2D context. </p></li><li class="li"><p>Calls the Core Foundation array creation function to create an array that you later pass as a parameter to the function <code>PMSessionSetDocumentFormatGeneration</code>.</p></li><li class="li"><p>Calls the Carbon Printing Manager function <code>PMSessionSetDocumentFormatGeneration</code> to request a spool file format and supply the graphics context types to use for drawing pages within the print loop. You pass four parameters:</p><ul class="ul"><li class="li"><p>A print session—the code here assumes the print session was already created. For more information see <em><a href="../../../../Carbon/Reference/CarbonPrintingManager_Ref/index.html#//apple_ref/doc/uid/TP30000048" target="_top">Carbon Printing Manager Reference</a></em>.</p></li><li class="li"><p>A spool file format. Pass <code>kPMDocumentFormatPDF</code>.</p></li><li class="li"><p>A graphics context array. This array has one item in it (<code>kPMGraphicsContextCoreGraphics</code>) to specify a Quartz graphics context, and not a QuickDraw context. (QuickDraw is what older Mac OS 9 applications use because Quartz is not available prior to Mac OS X.) </p></li><li class="li"><p><code>NULL</code>. This parameter is reserved for future use.</p></li></ul></li><li class="li"><p>Calls the Carbon Printing Manager function <code>PMSessionGetGraphicsContext</code> to obtain a Quartz graphics context for drawing. After you obtain the context, you can use Quartz 2D routines to draw content to the context. Then, continue with the appropriate print loop code. (Note that you cannot use QuickDraw routines when you print to a Quartz graphics context.)</p><p>You call the function <code><a href="../../../Reference/CorePrintRef/DeprecationAppendix/AppendixADeprecatedAPI.html#//apple_ref/doc/c_ref/PMSessionGetGraphicsContext" target="_top">PMSessionGetGraphicsContext</a></code> for each page you print. </p></li></ol>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../dq_overview/dq_overview.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../dq_paths/dq_paths.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2001, 2007 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2007-12-11<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_context/dq_context.html%3Fid%3DTP30001066-7.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_context/dq_context.html%3Fid%3DTP30001066-7.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/GraphicsImaging/Conceptual/drawingwithquartz2d/dq_context/dq_context.html%3Fid%3DTP30001066-7.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>