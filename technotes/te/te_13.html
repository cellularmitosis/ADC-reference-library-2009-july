<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TE13: Styled TextEdit Changes in System 6.0</title>                                       <meta name="categories" content="Text"><meta name="week-posted" content="Aug 1, 1988 - Aug 5, 1988"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002821" title="Styled TextEdit Changes in System 6.0"></a><a name="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxTextFonts-date.html">Text & Fonts</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/TextFonts/index.html" target="_blank">Reference Library > Text & Fonts</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TE13</div>
<div id="pageheadsub">Styled TextEdit Changes in System 6.0</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Section1">TextEdit Changes</A><BR><BR><A HREF="#Section2">Changes to Existing Routines</A><BR><BR><A HREF="#Section3">New TextEdit Routines</A><BR><BR><A HREF="#Section4">TEContinuousStyle</A><BR><BR><A HREF="#Section5">SetStylScrap</A><BR><BR><A HREF="#Section6">TENumStyles</A><BR><BR><A HREF="#Section7">TECustomHook</A><BR><BR><A HREF="#Section8">TEEOLHook</A><BR><BR><A HREF="#Section9">TEWidthHook</A><BR><BR><A HREF="#Section10">TEDrawHook</A><BR><BR><A HREF="#Section11">TEHitTestHook</A><BR><BR><A HREF="#Section12">TextEdit Data Structures</A><BR><BR><A HREF="#References">References</A><BR><BR><A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">Some changes were made to TextEdit in System 6.0 to provide more functionalityand to make life easier for the programmer using TextEdit.  This Note documentsthose changes and enhancements.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Dec 01 1988]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content --><a name=Section1></A><h2>TextEdit Changes</h2><p>In order to improve the usability of styled TextEdit, some routines have beenchanged, and some new routines have been added.  These changes exist in SystemSoftware 6.0 and later.  If you intend to rely on any of these changes or newroutines, it is important that you call <code>_SysEnvirons</code> first to makesure you are running under System Software 6.0 or later.</p><p><code>_SysEnvirons</code> is documented in <i>Inside Macintosh</i>, Volume V andM.OV.GestaltSysenvirons.  To check for the styled TextEdit changes, you mightdo the following:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    VAR        theWorld:    SysEnvRec;        anErr    :    OSErr;    BEGIN        anErr := SysEnvirons(1, theWorld);        IF (anErr = noErr) AND (theWorld.systemVersion &gt;= $0600) THEN ...            {System 6.0 or later}</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></p><a name="Section2"></a><h2>Changes to Existing Routines</h2><p><code>_TEKey</code> and _<code>TEDelete</code> have been changed so that backspacing to thebeginning of a style no longer deletes that style.  Instead, the style is savedin the <code>nullScrap</code> to be applied to subsequently typed characters.  Assoon as the user has backspaced past the beginning of the style, or clicked insome other area of the text, the style is removed.</p><p><code>GetStylScrap</code> now returns a handle to a valid style scrap record whencalled for an insertion point (<code>selStart</code> = <code>selEnd</code>).<code>NIL</code> is still returned when <code>GetStylScrap</code> is called with an oldstyle <code>TEHandle</code>.</p><p><code>TESetStyle</code> now accepts an additional mode, <code>doToggle</code> (<code>=32</code>).  When <code>doToggle</code> is specified along with <code>doFace</code>,<code>TESetStyle</code> operates as follows:  If a style specified in the given<code>TextStyle</code> parameter exists across the entire selected range, thatstyle is removed (turned off).  Otherwise, all of the selected text is set toinclude that style.  When a particular style is set for an entire selectionrange, that style is said to be continuous over the selection.</p><p>For example, given that the following text is the current selection:</p><P align=center><img src="images/te_13_001.gif" alt="mylti-styled selection" width=320 height=101></P><p>then the style <code>bold</code> is continuous over the selection range and the<code>italic</code> style is not.  If <code>TESetStyle</code> were called with a modeof <code>doFace</code> + <code>doToggle</code> and a <code>TextStyle</code> <code>tsFace</code>field of <code>[bold]</code>, then the resulting selection would be:</p><p align=center><img src="images/te_13_002.gif" alt="mylti-styled selection with styles labeled" width=320 height=103></P><p>On the other hand, if <code>TESetStyle</code> had been called with a mode of<code>doFace</code> + <code>doToggle</code> and a <code>TextStyle</code> <code>tsFace</code>field of <code>[italic]</code>, then the selected text would have become:</p><p align=center><img src="images/te_13_003.gif" alt="single-styled selection" width=320 height=105></P><P><A HREF="#top">Back to top</A></p><a name="Section3"></a><h2>New TextEdit Routines </h2><p>Some new routines have been added to TextEdit, <code>TEContinuousStyle</code>,<code>SetStylScrap, TECustomHook, </code>and<code> TENumStyles</code>.  These routinesare described in detail below.</p><h3>Assembly language note:</h3><P>The new TextEdit routines are called via the <code>_TEDispatch</code> trap.Following are the decimal selectors for the new routines:</p><p>    <code>TEContinuousStyle</code>    <code>10</code></p>    <p><code>SetStylScrap</code>    <code>11</code></p>    <p><code>TECustomHook    12</code></p>    <p><code>TENumStyles    13</code></p><P><A HREF="#top">Back to top</A></p><a name="Section4"></a><h2>TEContinuousStyle </h2><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>FUNCTION TEContinuousStyle(VAR mode : Integer; VAR aStyle : TextStyle;</pre>	</TD></TR></TABLE></CENTER><p><code>TEContinuousStyle</code> gives you information about the attributes of thecurrent selection.  The <code>mode</code> parameter, which takes the same values asin <code>TESetStyle</code>, specifies which attributes should be checked.  When<code>TEContinuousStyle</code> returns, the <code>mode</code> parameter indicates whichof the checked attributes is continuous over the selection range and the<code>aStyle</code> parameter is set  to reflect the continuous attributes.</p><p><code>TEContinuousStyle</code> returns <code>TRUE</code> if all of the attributes to bechecked are continuous and <code>FALSE</code> if not.  In other words, if the<code>mode</code> parameter is the same before and after the call, then<code>TEContinuousStyle</code> returns <code>TRUE</code>.</p><p>For example, <code>TEContinuousStyle</code> is useful for marking the style menuitems based on the current selection.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    mode := doFace;    IF TEContinuousStyle(mode, aStyle, myTE) THEN BEGIN    { There is at least one face that is continuous over the      selection. Note that it might be plain which is actually      the absence of all styles. }        CheckItem(styleMenu, plainItem, aStyle.tsFace = []);        CheckItem(styleMenu, boldItem, bold IN aStyle.tsFace);        CheckItem(styleMenu, italicItem, italic IN aStyle.tsFace);        ...etc.    END ELSE BEGIN    { No text face is common to the entire selection. }        CheckItem(styleMenu, plainItem, FALSE);        CheckItem(styleMenu, boldItem, FALSE);        CheckItem(styleMenu, italicItem, FALSE);        ...etc.</pre>	</TD></TR></TABLE></CENTER><p>This function can also be used to determine the actual values for thoseattributes that are continuous for the selection.  Note that a field in the<code>TextStyle</code> record is only valid if the corresponding bit is set in the<code>mode</code> variable; otherwise the field contains garbage.  For example, todetermine the font, face, size, and color of the current selection:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    mode := doFont + doFace + doSize + doColor;    continuous := TEContinuousStyle(mode, aStyle, myTE);    IF BitAnd(mode, doFont) &lt;&gt; 0 THEN        { Font for selection = aStyle.tsFont. }    ELSE        { More than one font in selection. };    IF BitAnd(mode, doFace) &lt;&gt; 0 THEN        { aStyle.tsFace contains the text faces (or plain) that are          common to the selection. }    ELSE        { No text face is common to the entire selection. };    IF BitAnd(mode, doSize) &lt;&gt; 0 THEN        { Size for selection = aStyle.tsSize. }    ELSE        { More than one size in selection. };    IF BitAnd(mode, doColor) &lt;&gt; 0 THEN        { Color for selection = aStyle.tsColor. }    ELSE</pre>	</TD></TR></TABLE></CENTER><p>The <code>aStyle.tsFace</code> field is a bit tricky.  When<code>TEContinuousStyle</code> returns a <code>mode</code> that contains<code>doFace</code>, and an <code>aStyle.tsFace</code> field that contains<code>[bold,&nbsp;italic]</code>, it means that the selected text is all bold andall italic, but may contain other text faces as well.  None of the other faceswill apply to all of the selected text, or they would have been included in the<code>tsFace</code> field.  But if the tsFace field is the empty set ([] = plain),then all of the selected text is plain.</p><p>If the current selection range is an insertion point,<code>TEContinuousStyle</code> returns the style information for the next characterto be typed.  <code>TEContinuousStyle</code> will always return <code>TRUE</code> inthis case, and each field of the <code>TextStyle</code> record will be set if thecorresponding bit in the <code>mode</code> parameter was set.</p><P><A HREF="#top">Back to top</A></p><a name="Section5"></a><h2>SetStylScrap</h2><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    PROCEDURE SetStylScrap(rangeStart, rangeEnd : LongInt;</pre>	</TD></TR></TABLE></CENTER><p><code>SetStylScrap</code> performs the opposite function of <code>GetStylScrap</code>.  The<code>newStyles</code> parameter is a handle to a style scrap record which will beapplied over the given range of text.  The current selection range is notchanged.  If <code>newStyles</code> is <code>NIL</code> or <code>hTE</code> is a handle toan old style <code>TERecord</code>, <code>SetStylScrap</code> does nothing.</p><p><code>SetStylScrap</code> will terminate without error if it prematurely reaches theend of the range or if there are not enough scrap style elements to cover thewhole range.  In the latter case, the last style in the scrap record will beapplied to the remainder of the range.</p><P><A HREF="#top">Back to top</A></p><a name="Section6"></a><h2>TENumStyles</h2><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    FUNCTION TENumStyles(rangeStart, rangeEnd : LongInt;</pre>	</TD></TR></TABLE></CENTER><p>This function returns the number of style <u>changes</u> contained in the givenrange, counting one for the start of the range.  Note that this does notnecessarily represent the number of unique styles for the range, because somestyles may be repeated.  For old-style TextEdit records, this function alwaysreturns 1.</p><p>This function is useful for calculating the amount of memory that would berequired for a contemplated _<code>TECut</code> or _<code>TECopy</code>.  Since thestyle scrap record is linear in nature, with one element for each style change,you can multiply the result returned by <code>TENumStyles</code> by<code>SizeOf(ScrpSTElement)</code> and add 2 to get the amount of memory that willbe needed.</p><P><A HREF="#top">Back to top</A></p><a name="Section7"></a><h2>TECustomHook</h2><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    PROCEDURE TECustomHook(which : TEHook; VAR addr : ProcPtr;</pre>	</TD></TR></TABLE></CENTER><p>This procedure lets applications customize the functions of TextEdit by settingthe TextEdit bottleneck routines.  The <code>which</code> parameter specifies whichbottleneck routine to replace, and is of type <code>TEHook</code> (describedbelow).  When <code>TECustomHook</code> returns, the <code>addr</code> parametercontains the address of the previous bottleneck routine specified by<code>which</code>.  This is returned so that bottleneck routines can bedaisy-chained.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    TYPE</pre>	</TD></TR></TABLE></CENTER><p>The internally used fields, <code>recalBack</code> and <code>recalLines</code> now forma handle to the list of TextEdit bottleneck routines.  Each <code>TERecord</code>has its own set of bottleneck routines to provide for maximum flexibility.  The<code>TECustomHook</code> procedure should always be used to change the bottleneckroutines instead of modifying the edit record directly.</p><p>Also, it is important to note that you should not clone a <code>TERec</code>.Doing so would duplicate the handle stored in <code>recalBack</code> and<code>recalLines</code>.  When one of the TextEdit records was disposed, the handlestored in the copy would be invalid, and TextEdit would crash.</p><p>There are four bottleneck routines, <code>TEEOLHook</code>, <code>TEWidthHook</code>,<code>TEDrawHook</code>, and <code>TEHitTestHook</code>, described individually below.When replacing these routines, note that all registers except those specifiedas containing return values must be preserved.  Registers <code>A3</code> and<code>A4</code> contain a pointer and a handle to the TextEdit record respectively.Line start positions can be obtained from the <code>lineStarts</code> array in theedit record.</p><p>None of these bottleneck routines are called from _<code>TextBox</code>.</p><P><A HREF="#top">Back to top</A></p><a name="Section8"></a><h2>TEEOLHook</h2><p>This routine tests a given character and returns with the appropriate statusflags set in the status register.  The default action is to merely compare thecharacter with <code>$0D</code> (a carriage return) and return.</p><p>On entry:    D0    character to compare            (byte)</p>        <p>A3    pointer to the TextEdit record        (long)</p>       <p> A4    handle to the TextEdit record        (long)</p><p>On exit:        z flag clear if end-of-line character, set otherwise</p><P><A HREF="#top">Back to top</A></p><a name="Section9"></a><h2>TEWidthHook</h2><p>This routine is called any time the width of various components of a line arecalculated.  The appropriate font, face, and size characteristics have alreadybeen set into the current port by the time this routine is called.  The defaultaction is to call _<code>Char2Pixel</code> and return.</p><p>On entry:    <code>D0</code>    length of text to measure        (word)</p>        <p><code>D1</code>    offset into text            (word)</p>        <p><code>A0</code>    pointer to text to measure        (long)</p>        <p><code>A3</code>    pointer to the TextEdit record        (long)</p>        <p><code>A4</code>    handle to the TextEdit record        (long)</p><p>On exit:    <code>D1    </code>width of measured text        (word)</p><P><A HREF="#top">Back to top</A></p><a name="Section10"></a><h2>TEDrawHook</h2><p>This routine is called any time the various components of a line are drawn.The appropriate font, face, and size characteristics have already been set intothe current port by the time this routine is called.  The default action is tocall _<code>DrawText</code> and return.</p><p>On entry:    <code>D0</code>    offset into text            (word)</p>       <p> <code>D1</code>    length of text to draw            (word)</p>        <p><code>A0</code>    pointer to text to draw        (long)</p>        <p><code>A3</code>    pointer to the TextEdit record        (long)</p>        <p><code>A4</code>    handle to the TextEdit record        (long)</p><P><A HREF="#top">Back to top</A></p><a name="Section11"></a><h2>TEHitTestHook</h2><p>This routine is called to determine the character position in a line given thehorizontal offset, in pixels, from the beginning of a line.  The default actionis to call _<code>Pixel2Char</code> and return.  For more information, see thedescription of _<code>Pixel2Char</code> in the Script Manager chapter of <i>InsideMacintosh</i>, Volume 5 and the Inside Macintosh Interim Chapter Draft, ScriptManager 2.0.</p><p>On entry:    <code>D0</code>    length of text to hit test        (word)</p>        <p><code>D1</code>    pixel offset from start of text        (word)</p>        <p><code>A0</code>    pointer to start of text            (long)</p>        <p><code>A3</code>    pointer to the TextEdit record        (long)</p>        <p><code>A4</code>    handle to the TextEdit record        (long)</p><p>On exit:    <code>D0</code>    pixel width to last offset        (low word)</p>           <p> Boolean = TRUE if a character    (high word)</p>           <p> offset corresponding to the pixel width was found.</p>        <p><code>D1</code>    character offset            (word)</p>       <p> <code>D2</code>    Boolean = TRUE if the pixel        (word)</p>           <p> offset falls within the left side of the character.</p><P><A HREF="#top">Back to top</A></p><a name="Section12"></a><h2>TextEdit Data Structures</h2><p>The illustration on the following page is a graphic representation of theTextEdit data structures.  You should use this information only for debuggingand so you understand what is going on.  For reading or writing these datastructures, the TextEdit routines should be used. This will help ensure futurecompatibility.</p><P><A HREF="#top">Back to top</A></p><a name = "References"></a><h2>References</h2><p><A HREF = "../ov/ov_16.html">M.OV.GestaltSysenvirons</a></p>         <a name="Downloads"></a>       <P><A HREF="#top">Back to top</A></p><h2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (156K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/te_13.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/te/te_13.html%3Fid%3DDTS10002821-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/te/te_13.html%3Fid%3DDTS10002821-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/te/te_13.html%3Fid%3DDTS10002821-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>