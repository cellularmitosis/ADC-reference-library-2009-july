<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Using a Progress Broadcaster(Cyberdog)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING36></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->




<!-- Main Body -->

<CENTER>
<P>
<A HREF="Cyberdog-35.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Cyberdog-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Cyberdog-319.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Cyberdog-37.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="Cyberdog-2.html"><B>Cyberdog Programmer's Kit</B></A> / <A HREF="Cyberdog-20.html"><B>Part 2 - Programming in Cyberdog</B></A><BR><DD><A HREF="Cyberdog-32.html"><B>Chapter 5 - Embedding a Cyberdog Display Part in a Navigator</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING36-0></A>
<H1><A NAME=MARKER-13-41></A>Using a Progress Broadcaster</H1>
 <A NAME=MARKER-2-35></A>Your embedded display part can set up a progress broadcaster to send status information to progress receivers. This information might include the amount of data transferred by a download operation or a stream's status. Progress receivers are associated with progress parts, such as Cyberdog navigators and Cyberdog opener parts. Progress parts display the status of time-consuming operations. Thus, the navigator and opener parts support behavior to receive and display progress. The navigator or opener part can use the information received to animate and display the status bar.<P>
 To use a progress broadcaster, you must support the following operations:<P>
<UL>
<LI>Create and initialize a CyberProgressBroadcaster object.
<LI>Supply an abort callback function.
<LI>Attach the broadcaster to a navigator.
<LI>Detach the broadcaster.
<LI>Send status messages to the navigator.<P>
</UL>
 The following sections show you how to implement these operations.<P>
<A NAME=HEADING36-9></A>
<H2>Setting Up the Progress Broadcaster</H2>
 <A NAME=MARKER-2-36></A>You can set up a progress broadcaster when you initiate any time-consuming operation. To set up a progress broadcaster, you must take the following actions:<P>
<UL>
<LI>Create a <A NAME=MARKER-2-37></A>CyberProgressBroadcaster object and keep a reference to it.
<LI>Call the <A NAME=MARKER-2-38></A>NewCyberAbortProc utility to create a Cyberdog abort callback function.
<LI>Call the broadcaster object's <A NAME=MARKER-2-39></A>ICyberProgressBroadcaster method to initialize the broadcaster object and associate it with the Cyberdog abort procedure callback routine.
<LI><A NAME=MARKER-2-40></A>Call the broadcaster object's <A NAME=MARKER-2-41></A>SetProgressMode method to specify whether progress is metered (kMeteredProgress) or not (kUnmeteredProgress).<P>
</UL>
 The embedded text-viewer part creates a progress broadcaster when it starts a download operation. <A HREF=#MARKER-9-42>Listing 5-6</A> shows the InitiateDownload method, which is called from the <CODE>OpenCyberItem</CODE> method. <P>
<B>Listing 5-6  <A NAME=MARKER-9-42></A>The <CODE>InitiateDownload</CODE> method of the embedded text-viewer part</B><P>
<PRE>
void CybTxtNavViewer::InitiateDownload (Environment *ev, 
                              CyberItem* item, 
                              ParameterSet* openParams) 
{
   // Start the download and add the item to the log.
   ...
   
   // Prepare a progress broadcaster to attach to the navigator part.
   if (fBroadcaster == kODNULL)
   {
      fBroadcaster = new CyberProgressBroadcaster;
      
      if (gMyCyberAbortUPP == nil)
      {
         gMyCyberAbortUPP = NewCyberAbortProc(CyberAbortProc);
      }
      fBroadcaster-&gt;ICyberProgressBroadcaster
                           (ev, gMyCyberAbortUPP, (Ptr) this);
      // Set the progress mode.
      fBroadcaster-&gt;SetProgressMode(ev, kUnmeteredProgress);
   }
}
</PRE>
 <A HREF=#MARKER-9-42>Listing 5-6</A> shows the <CODE>this</CODE> pointer being passed as an argument to the ICyberProgressBroadcaster method. The <CODE>this</CODE> pointer allows the calling object to be referenced from the abort procedure callback routine.<P>
<DL>
<DT><B>Note</B>
<DD>The <CODE>gMyCyberAbortUPP</CODE> class variable holds a pointer to the callback procedure. It is initialized as follows:<BR><CODE>CyberAbortUPP CybTxtNavViewer::gMyCyberAbortUPP = nil; </CODE>  <IMG ALIGN = BOTTOM SRC = "graphics/diamond.gif">
</DL>
<A NAME=HEADING36-20></A>
<H2>Implementing the Abort Callback Function</H2>
 <A NAME=MARKER-2-43></A><A NAME=MARKER-2-44></A>When the user cancels an operation associated with a Cyberdog broadcaster, such as by closing the navigator's window during a download operation, the broadcaster's abort callback function is called. The abort callback function takes the appropriate action to abort the operation. <A HREF=#MARKER-9-45>Listing 5-7</A> shows the embedded text-viewer's abort callback function, called CyberAbortProc. It aborts the stream.<P>
<B>Listing 5-7  <A NAME=MARKER-9-45></A>The embedded text-viewer's abort callback function</B><P>
<PRE>
void CybTxtNavViewer::CyberAbortProc(CDAbortProcMessage msgCode,
                            CyberProgressBroadcaster*, 
                            Ptr thisPtr)
{
   CybTxtNavViewer* THIS = (CybTxtNavViewer*)thisPtr;
   
   switch(msgCode)
   {
      case kAbortMessage:
         if (THIS-&gt;fStream)
            THIS-&gt;fStream-&gt;Abort(somGetGlobalEnvironment());
         break;
      default:
         break;
   }
   return;
}
</PRE>
 The <CODE>PollStream</CODE> method deletes the stream and the broadcaster when the download operation is aborted. See <A HREF=#MARKER-9-58>Listing 5-10 (page 160)</A>.<P>
<A NAME=HEADING36-25></A>
<H2>Attaching the Broadcaster Object</H2>
 <A NAME=MARKER-2-46></A>You can attach a Cyberdog broadcaster object to a Cyberdog navigator when your display part appears in a navigator. Your part is notified when a new display frame is created or when a display frame that was previously written out is instantiated from storage. OpenDoc calls the <CODE>DisplayFrameAdded</CODE> and <CODE>DisplayFrameConnected</CODE> methods, respectively, to handle these cases; you can attach the broadcaster object these methods.<P>
 To attach a progress broadcaster, you must take the following actions:<P>
<UL>
<LI>Retrieve the Cyberdog navigator for the embedded display part.
<LI>Acquire a Cyberdog navigator extension for the navigator.
<LI>Call the extension's <A NAME=MARKER-2-47></A>AttachProgressBroadcaster method to attach the broadcaster to the Cyberdog navigator.<P>
</UL>
 <A HREF=#MARKER-9-48>Listing 5-8</A> shows how the embedded text-viewer part attaches a progress broadcaster to a Cyberdog navigator. The part calls its GetContainingNavigator method to find a frame that is a navigator; see <A HREF=Cyberdog-35.html#MARKER-9-33>Listing 5-5 (page 154)</A>.<P>
<B>Listing 5-8  <A NAME=MARKER-9-48></A>Adding a progress broadcaster</B><P>
<PRE>
if (fBroadcaster)
{
   ODPart* navPart = this-&gt;GetContainingNavigator(ev);
   if (navPart)
   {
      TempNavigatorExtension navExt(navPart, kCyberNavigatorExtension);
      navExt-&gt;AttachProgressBroadcaster(ev, fBroadcaster);
   }
}
</PRE>
<A NAME=HEADING36-34></A>
<H2>Detaching the Broadcast Object</H2>
 <A NAME=MARKER-2-49></A>When your display part is no longer displayed in a navigator, you should detach the progress broadcaster object by calling your part extension's <A NAME=MARKER-2-50></A>DetachProgressBroadcaster method. You may need to detach the broadcaster object when OpenDoc calls the <CODE>DisplayFrameRemoved</CODE> or the <CODE>DisplayFrameClosed</CODE> methods.<P>
 <A HREF=#MARKER-9-51>Listing 5-9</A> shows the embedded text-viewer part's DisplayFrameRemoved method, which detaches the broadcaster.<P>
<B>Listing 5-9  <A NAME=MARKER-9-51></A>The <CODE>DisplayFrameRemoved</CODE> method of the embedded text-viewer part</B><P>
<PRE>
void CybTxtNavViewer::DisplayFrameRemoved( Environment*ev,
                             ODFrame*  frame )
{
   TRY
      // Keep a reference to the navigator; it may be necessary to
      // detach our broadcaster from the navigator.
      ODPart* preNavPart = kODNULL;
      if(fBroadcaster)
         preNavPart = this-&gt;GetContainingNavigator(ev);
      

      // Perform the operations associated with removal.
      ...

      // Detach the broadcaster if the part is no longer displayed
      // in the navigator.
      if (fBroadcaster)
      {
         if (preNavPart &amp;&amp; (preNavPart != GetContainingNavigator(ev)))
         {
            TempNavigatorExtension 
                     navExt(preNavPart, kCyberNavigatorExtension);
            navExt-&gt;DetachProgressBroadcaster(ev, fBroadcaster);
         }
      }
      this-&gt;SetDirty(ev);
   
   CATCH_ALL
   ...
      RERAISE;
   ENDTRY
}
</PRE>
<A NAME=HEADING36-39></A>
<H2>Sending Status Messages to the Navigator</H2>
 <A NAME=MARKER-2-52></A><A NAME=MARKER-2-53></A>You can send messages to a navigator by calling broadcaster methods. <A HREF=#MARKER-9-58>Listing 5-10</A> shows how the embedded text-viewer part sends messages during a polling operation. The method calls the broadcaster's <A NAME=MARKER-2-54></A>SetAmountDone method to update the number of characters transferred. It then calls the broadcaster's <A NAME=MARKER-2-55></A>SetStatusString method to update the status string. The method calls the <A NAME=MARKER-2-56></A>stream's <A NAME=MARKER-2-57></A>GetStatusString method to obtain the content information to display.<P>
<B>Listing 5-10  <A NAME=MARKER-9-58></A>Sending status messages to the navigator</B><P>
<PRE>
void CybTxtNavViewer::PollStream(Environment* ev)
{  
   StreamStatus status;
   ODBoolean gotData = kODFalse;
   Size bytesThisPoll = 0;
   ODULong savedLength = fCharsLength;
   
   while (bytesThisPoll &lt; kBytesPerPoll) 
   {  
      status = fStream-&gt;GetStreamStatus(ev);
      // Get the data.
      ...
   }
   
   // Check status after data transfer; it may have changed.
   status = fStream-&gt;GetStreamStatus(ev); 

   // Animate the Amount Done field of the navigator's status bar.
   if (fCharsLength &gt; savedLength)
      fBroadcaster-&gt;SetAmountDone(ev, fCharsLength);
      
   // Get the status string from the stream and display it in the
   // navigator's status bar.
   if (status &amp; kCDStatusStringChanged)
   {
      Str255 status;
      fStream-&gt;GetStatusString(ev, status);
      fBroadcaster-&gt;SetStatusString(ev, status);
   }
   // Downloading is complete or an error occurred.
   if ((status &amp; kCDDownloadComplete) || 
      (status &amp; kCDErrorOccurred) || 
      (status &amp; kCDAbortComplete)) 
   {
      // Delete the stream.
      delete fStream;
      fStream = kODNULL;
      
      // Delete the progress broadcaster.
      if (fBroadcaster)
      {
         delete fBroadcaster;
         fBroadcaster = kODNULL;
      }
   }
   ...
}
</PRE>

</BLOCKQUOTE>
<HR>
<center>
<A HREF="Cyberdog-35.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="Cyberdog-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="Cyberdog-319.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="Cyberdog-37.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="Cyberdog-3.html">&copy; Apple Computer, Inc.</A><br>13 JUL 1996</center></font><P>
<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->
</BODY>
</HTML>   
