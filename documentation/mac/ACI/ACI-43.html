<!-- Generated by Harlequin WebMaker 2.2.3 (30-Apr-1996)
Macintosh Common Lisp Version 3.0kp2p2 [AppGen 3.0b1kp2p2] -->
<HTML> <HEAD>
<TITLE>Returning and Setting Color Picker Information</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING43></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->




<!-- Main Body -->

<CENTER>
<P>
<A HREF="ACI-42.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="ACI-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="ACI-122.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="ACI-44.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="ACI-2.html"><B>Advanced Color Imaging on the Mac OS</B></A> / <BR><DD><A HREF="ACI-29.html"><B>Chapter 2 - Color Picker Manager</B></A> / <A HREF="ACI-38.html"><B>Writing Your Own Color Pickers</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING43-0></A>
<H2>Returning and Setting Color Picker Information</H2>
 <A NAME=MARKER-2-144></A>The Color Picker Manager sends the <A NAME=MARKER-2-145></A><CODE>kGetColor</CODE> code to request your color picker to supply an original or a new color. In turn, your color picker returns either the original color or the new color, as shown in <A HREF=#MARKER-9-146>Listing 2-24</A>. <P>
<B>Listing 2-24  <A NAME=MARKER-9-146></A>Returning the original or the new color</B><P>
<PRE>
pascal ComponentResult MyGetColor(PickerStorageHndl storage,
                          ColorType whichColor, 
                          PMColorPtr color)
{
   /* copy the color here because the profile is always set as 
      we want it to be (nil - the system profile/RGB space) */
   if(whichColor == kNewColor)
      *color = (*storage)-&gt;color;
   else
      *color = (*storage)-&gt;origColor;
   return noErr;
}
</PRE>
 Similarly, the Color Picker Manager sends the <A NAME=MARKER-2-147></A><CODE>kSetColor</CODE> code to request your color picker to set an original or a new color. <A HREF=#MARKER-9-148>Listing 2-25</A> shows how a color picker can set these colors.<P>
<B>Listing 2-25  <A NAME=MARKER-9-148></A>Setting colors</B><P>
<PRE>
pascal ComponentResult MySetColor(PickerStorageHndl storage, 
                          ColorType whichColor, PMColorPtr color)
{
   Boolean  updateEditor = false;
   Boolean  textInvalid = false;
   CWorld   cworld;
   PMColor  myColor;
   long     csLong;

   OSErr    err = noErr;
   myColor = *color;    /* get your own copy */
   /* check whether a profile was included; if so, convert the color to 
      system space */
   if(color-&gt;profile)  
   {
      /* first ensure that ColorSync is available */
      if(Gestalt(gestaltColorMatchingVersion,&amp;csLong) != noErr)  
      {
         err = colorSyncNotInstalled;
         goto fail;
      }
      /* create the color world and convert the color */
      if(CWNewColorWorld(&amp;cworld,myColor.profile,0L) == noErr) 
      {
         if(CWMatchColors(cworld,&amp;myColor.color,1) != noErr)  
         {
            err = badProfileError;
            CWDisposeColorWorld(cworld);
            goto fail;
         }
         CWDisposeColorWorld(cworld);
      } 
      else  
      {
         err = badProfileError;
         goto fail;
      }
   }
   myColor.profile = 0L;   /* it's in the system space now */
   if(whichColor == kNewColor)  
   {
      (*storage)-&gt;color = *color;
      (*storage)-&gt;lastRGB = color-&gt;color.rgb;
      updateEditor = true;
   } 
   else  
   {  (*storage)-&gt;origColor = *color;
      /* make a new pattern for the original color */
      MakeRGBPat((*storage)-&gt;origColorPat,&amp;color-&gt;color.rgb);
      if((*storage)-&gt;visible)
         DrawMYColorRects(storage,true);/* redraw original color rect */
   }
   if(updateEditor)  {
      /* make some calls to update data structures and redraw the parts of 
         the picker that need to be redrawn */
      SetSelectionColor(storage);
      UpdateColorText(storage);
      if((*storage)-&gt;visible)  
      {
         /* you don't call DoPickerDraw here because you don't need to 
            redraw everything */
         DrawMYColorRects(storage,false);
         DrawMYColorEditor(storage,false);
      }
   }
fail: C
   return err;
}
</PRE>
 <A NAME=MARKER-2-149></A><A HREF=#MARKER-9-151>Listing 2-26</A> illustrates a color picker-defined function that responds to the <A NAME=MARKER-2-150></A><CODE>kGetIconData</CODE> request code. The color picker uses a <CODE>PickerIconData</CODE> structure (described in <A HREF=#nonexistent-marker>"Color Picker Manager Reference"</A> in <I>Advanced Color Imaging Reference)</I> to return the script code and the resource ID of the icon family by which the color picker identifies itself in the list of icons for available color pickers in a color picker dialog box. (Such an icon list is shown in <A HREF=ACI-31.html#MARKER-9-32>Figure 2-2</A>.)<P>
<B>Listing 2-26  <A NAME=MARKER-9-151></A>Returning icon data</B><P>
<PRE>
pascal ComponentResult MyGetIconData(PickerStorageHndl storage, 
                            PickerIconData *data)
{
   short             fref;
   OSErr             err = noErr;
   PickerIconData    **mypdat;

   data-&gt;scriptCode = 0;
   data-&gt;iconSuiteID = kPickerData;
   fref = OpenComponentResFile((Component) (*storage)-&gt;myself);
   if(fref)  
   {
      mypdat = (PickerIconData **)GetResource(kPickerDataType, 
                                             kPickerData);
      if(mypdat)
         *data = **mypdat;
      else
         goto fail;
   } 
   else
      goto fail;
   CloseComponentResFile(fref);
   return err;
fail:
   DebugStr(&quot;\pProblem getting resource&quot;);
   return pickerResourceError;
}
</PRE>
 The Color Picker Manager sends the <A NAME=MARKER-2-152></A><CODE>kGetPrompt</CODE> request code to obtain the prompt string currently used by your color picker. Your color picker should respond to this code by returning its string, as illustrated in <A HREF=#MARKER-9-154>Listing 2-27</A>.<A NAME=MARKER-2-153></A><P>
<B>Listing 2-27  <A NAME=MARKER-9-154></A>Returning the color picker's prompt</B><P>
<PRE>
pascal ComponentResult MyGetPrompt(PickerStorageHndl storage, 
                           Str255 prompt)
{
   Handle   theItem;
   short    iType;
   Rect     iBox;

   GetDialogItem((*storage)-&gt;port, (*storage)-&gt;baseItem + 
                  iPrompt, &amp;iType ,&amp;theItem, &amp;iBox);
   GetDialogItemText(theItem, prompt);
   return noErr;
}
</PRE>
 <A HREF=#MARKER-9-156>Listing 2-28</A> illustrates a color picker-defined function that responds to the <A NAME=MARKER-2-155></A><CODE>kSetPrompt</CODE> request code by setting the prompt string used by the color picker.<P>
<B>Listing 2-28  <A NAME=MARKER-9-156></A>Setting the color picker's prompt</B><P>
<PRE>
pascal ComponentResult MySetPrompt(PickerStorageHndl storage, 
                           Str255 prompt)
{
   Handle theItem;
   short iType;
   Rect iBox;

   GetDialogItem((*storage)-&gt;port, (*storage)-&gt;baseItem + 
                  iPrompt, &amp;iType, &amp;theItem, &amp;iBox);
   SetDialogItemText(theItem, prompt);
   return noErr;
}
</PRE>
 <A NAME=MARKER-2-157></A>The Color Picker Manager sends the <A NAME=MARKER-2-158></A><CODE>kGetProfile</CODE> request code to obtain the destination color-matching profile currently used by your color picker. Your color picker should respond to this code by returning the destination profile, as illustrated in <A HREF=#MARKER-9-159>Listing 2-29</A>.<P>
<B>Listing 2-29  <A NAME=MARKER-9-159></A>Returning the destination profile</B><P>
<PRE>
pascal ComponentResult MyGetProfile(PickerStorageHndl storage)
{
   Handle h;
   h = (Handle) (*storage)-&gt;profile;
   if(h)
      HandToHand(&amp;h);
   return (long) h;
}
</PRE>
 <A HREF=#MARKER-9-161>Listing 2-30</A> illustrates a color picker-defined function that responds to the <A NAME=MARKER-2-160></A><CODE>kSetProfile</CODE> request code by setting a new destination profile for use by the color picker.<P>
<B>Listing 2-30  <A NAME=MARKER-9-161></A>Setting the destination profile</B><P>
<PRE>
pascal ComponentResult MySetProfile(PickerStorageHndl storage, 
                           CMProfileHandle profile)
{
   CMProfileHandlemyProfile;

   OSErr err = noErr;
   /* Make a private copy of the profile, even though this 
      picker doesn't do anything with profiles. This is necessary 
      because the Color Picker Manager relies on color pickers to 
      store this data so that it doesn't have to duplicate the 
      storage and waste memory. */
   if(myProfile = profile)  
   {
      HandToHand((Handle *) &amp;myProfile);
      if((err = MemError()) != noErr)
         goto fail;
   }
   (*storage)-&gt;profile = myProfile;
fail:
   return err;
}
</PRE>
 <A NAME=MARKER-2-162></A>The Color Picker Manager sends the <A NAME=MARKER-2-163></A><CODE>kGetEditMenuState</CODE> request code to obtain information about the desired state of the edit menu for your color picker. As illustrated in <A HREF=#MARKER-9-164>Listing 2-31</A>, your color picker should respond to this code by returning edit menu information in a <CODE>MenuState</CODE> structure, which is described in detail in <A HREF=#nonexistent-marker>"Color Picker Manager Reference"</A> in <I>Advanced Color Imaging Reference</I>. <P>
<B>Listing 2-31  <A NAME=MARKER-9-164></A>Specifying how the Edit menu should be set</B><P>
<PRE>
pascal ComponentResult MyGetEditMenuState(PickerStorageHndl storage, 
                                MenuState *mState)
{
   #pragma unused(storage)
   OSErr err = noErr;
   mState-&gt;cutEnabled = true;
   mState-&gt;copyEnabled = true;
   mState-&gt;pasteEnabled = true;
   mState-&gt;clearEnabled = true;
   mState-&gt;undoEnabled = true;
   strcpy(mState-&gt;undoString,&quot;\pUndo&quot;);
   return err;
}
</PRE>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="ACI-42.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="ACI-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="ACI-122.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="ACI-44.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="ACI-3.html">&copy; Apple Computer, Inc.</A><br>13 NOV 1996<P>
<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->
</BODY>
</HTML> 
