<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TN1048: Some Sound Advice: Getting the Most Out of the Sound Manager</title>    <meta name="keywords" content="Mac OS 8 Sound Manager input output problems playing">    <meta name="Description" content="Technical Note TN1048: This Technical Note discusses issuesthat you need to be aware of if you are developing apps thatuse more than basic Sound Manager calls. Topics include:Void pointers, Playing a Compressed Sound Using SndPlayDoubleBuffer,Variations on Input Sample Rate Support, Simultaneous Play-and-Record,etc."><meta name="categories" content="Sound"><meta name="week-posted" content="May 27, 1996 - Jun 7, 1996"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002889" title="Some Sound Advice: Getting the Most Out of the Sound Manager"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/index.html" target="_blank">Reference Library</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1048</div>
<div id="pageheadsub">Some Sound Advice: Getting the Most Out of the Sound Manager</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"> <!-- begin_header_box --> <table width="600" cellpadding="0" cellspacing="0" border="0">	<tr>		<td width=300 valign="top" align=left scope="row">			<table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>				</tr>				<tr bgcolor="#e6e6e6">					<td background="images/tnmenubody.gif" width=300 align=left>						<span id="menutitle">							CONTENTS     <BR>    <BR>						</span>					</td>				</tr>				<tr bgcolor="#e6e6e6">					<td background="images/tnmenubody.gif" width=300 align=left>						<p id="menutext"><A HREF = "#RTFToC1">Input Items</a><br><br><A HREF = "#RTFToC2">Output Items</a><br><br><A HREF = "#Summary">Summary</a><br><br><A HREF = "#References">References</a><br><br><A HREF="#Downloads">Downloadables</A></p>											</td>				</tr>				<tr>					<td width=300 align=left scope="row">						<img src="images/tnmenubottom.gif" alt="" width=300 height=16>					</td>				</tr>			</table>		</td>		<td width=300 valign="top" align=left>			<!-- begin_intro_text --><P id = "introtext">This Technote discusses issues that you need to be aware of if you aredeveloping apps that use more than basic Sound Manager calls. The informationin this Technote has been gleaned from a number of developer questions fieldedby DTS, and focuses on issues that arise when dealing with sound input andsound output.</p><P id = "introtext">The information in chapters 2 and 3, "Sound Manager" and "Sound Input Manager,"in <i><a href="http://developer.apple.com/documentation/mac/Sound/Sound-2.html">Inside Macintosh: Sound</A></i> is still accurate, but changes and newfeatures require new documentation which this Technote is part of. ThisTechnote covers information not found in the release notes for Sound Manager3.0, 3.1, and 3.2. This Technote also clarifies the information in <i>InsideMacintosh: Sound</i> and points out how you can use the Sound Manager moreefficiently.</p><!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [June 1 1996]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR> <!-- begin_content --><a name = "RTFToC1"></a><h2>Input Items</h2><P>Over the last three years, in answering developer questions about the SoundManager, DTS has gained some new insights into the Sound Manager's innerworkings. In this section of the Technote, we share those insights.</p><P>On the surface, sound input appears to be programmatically similar to soundoutput. This, however, is not true. There are two reasons for this:</p><ol><li>Sound input is still based on an old-fashioned driver model.</li><li>Sound output has been "modernized," beginning with Sound Manager 3.0, anduses the Component Manager extensively.</li></ol><h3>One Source of Input Problems: Different Hardware Implementations</h3><P>Input problems can arise because of variations in sound input hardware from onemachine to another. For example, a Macintosh Quadra 700 has 8-bit sound inputwhile a Power Macintosh 7200 has 16-bit sound input. The contrast, however, ismore subtle because a 7200 defaults to recording stereo 16-bit sound instead of8-bit mono sound like the 700. Furthermore, even though the Quadra 840AV andmost Power Macs support 16-bit sound, the 840AV supports many more anddifferent sample rates than most Power Macs.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Important:</B><BR>Don't assume that the default settings of the selected sound inputdevice are what you're expecting or what they've been on previous Macs orprevious versions of the Sound Manager. Make sure that you set the input stateto exactly what you want before you begin recording. Use the <code>SPBSetDeviceInfo</code>function to set the recording parameters. Use the <code>SPBGetDeviceInfo</code> function tomake sure that the sound will be recorded exactly as you want it to be.</P></TD></TR></TABLE></CENTER><BR><h3>Simultaneous Play-and-Record</h3><P>Simultaneous play-and-record is the act of recording one sound while playinganother sound at the same time. This is a feature commonly requested in speakerphones.</p><P>Not all Macintosh computers can simultaneously play and record sound -- e.g., aPowerBook Duo 280c cannot play and record at the same time, while the Quadra840AV can.</p><P>To determine if a particular Mac can play and record simultaneously, you needto call Gestalt with the 'snd ' selector and check for the <code>gestaltPlayAndRecord</code>bit being set. If this bit is not set and you are recording a sound, you willnot be able to play a sound until the recording finishes. Likewise, if you areplaying a sound, recording is not possible either. What this means to you isthat if your application requires this functionality, you will need to checkGestalt and take the appropriate action.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>Turning on the level meter (with <code>SPBSetDeviceInfo</code> and the<code>siLevelMeterOnOff</code> selector) is recording without saving the data. Therefore,for machines that cannot play and record simultaneously, the level meter mustbe off before you can play sounds.</P></TD></TR></TABLE></CENTER><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Important:</B><BR>Power Macintosh computers can only do simultaneous play and recordif both the input and output channels are set to the same rate -- for example,22.050 KHz. If you require this, make sure that input and output rates are thesame.</P></TD></TR></TABLE></CENTER><BR><h3>Variations on Input Sample Rate Support</h3><P>Don't assume that all Macs support the same input rates, and don't assume thatthey default to the same rates either. Even similar Macs can have verydifferent capabilities.</p><P>There are variations in the input sample rates supported by different Macintoshcomputers. For example, the number of input rates supported by a PowerMacintosh 7100 is two, while the number of input rates for a Power Macintosh7500 is three, and a Quadra 840AV has seven. The Power Macintosh 7100 rates are22.050 KHz and 44.1 KHz; the Power Mac 7500 also supports 11.025KHz; the Quadra840AV rates includes those, plus an additional two -- 24 KHz and 48 KHz.</p><P>For most developers, and users, this is not an issue unless you have hard-codedin a particular sample rate. If this is the case, then you should rewrite yourcode to be more flexible in its choice of sample rates. Use <code>SPBGetDeviceInfo</code>with the siSampleRate selector to find the rate you like best and then use<code>SPBSetDeviceInfo</code> to set that rate. If you can't get a needed sample rate yourequire, you can use Sound Manager 3.2's conversion routines to convert betweenthe rate you can get and the rate that you need.</p><h3>Having the Correct Buffer Size Matters</h3><P>Sound recording works best if the buffer you are recording into is sized to bean integer multiple of the size of the recording device's interrupt buffer.</p><P>After you've set up the recording parameters, specifically mono versus stereo,and 8 bit versus 16 bits, call <code>SPBGetDeviceInfo</code> with the siDeviceBufferInfo('dbin') selector to find the size of the machine's input buffer.</p><P>After determining the size, multiply this number by some integer of yourchoosing to size your application's recording buffer. This way, at interrupttime you are copying whole buffers, and you and the Sound Manager don't have toworry about partial buffers.</p><P>This helps to optimize how the Sound Manager moves data out of the recordinghardware and is a speed optimization.</p><h3>Variations in Sound Input Hardware</h3><P>The sound input hardware on all Power Macintosh 5200/5300/6200/6300 computerswas changed during its lifetime. Some of these Macs can only record 8-bitsounds, while others can also record 16-bit sounds. The machine you have inyour lab will be one or the other of these; you need to make sure that youwrite code that will work on both. To this end, use <code>SPBGetDeviceInfo</code> with the<code>siSampleSizeAvailable</code> ('ssav') selector to find out what bit depth the Mac youare running on is capable of recording sounds at, or better yet, write codethat doesn't care what the bit size is.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>IMPORTANT:</B><BR>There are sound hardware differences among these four classes ofmachines: the Power Macintosh 5200/5300/6200/6300 computers. Just because theseare Power Mac machines, you should not assume that all contain 16-bit input andoutput hardware. For example, the Macintosh Performa 5215CD contains both16-bit input and output hardware. However, if you call Gestalt on thatparticular machine, it returns gestalt16BitSoundIO not set (i.e., false), thisis incorrect. You should instead check the available sample sizes by using the<code>siSampleSizeAvailable</code> selector.</P></TD></TR></TABLE></CENTER><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Important:</B><BR>The <code>siActiveChannels</code> selector used with the <code>SPBGetDeviceInfo</code> and<code>SPBSetDeviceInfo</code> calls is not supported on the Power Macintosh5200/5300/6200/6300 series Macintoshes, and may not be supported on othercurrent or future Macintosh models. If you make this call and it returns theerror siUnknownInfoType, then you know that this selector is not supported.Don't panic: you will be recording always from both channels.</P></TD></TR></TABLE></CENTER><BR><P>On PCI Power Macintoshes, using the <code>siActiveChannels</code>selector with a value of0x01 or 0x02 (which would turn on only the left or right channel, respectively)does not work before System 7.5.3. If you are on a PCI Power Mac running system7.5.2, the Sound Manager version does not matter: do not set <code>siActiveChannels</code>to anything but 0x03, which is the same as leaving it at its default. If youare on a PCI Power Mac running 7.5.3 or later, you can use the <code>siActiveChannels</code>selector and set it to 0x01, 0x02, or 0x03.</p><P>If you need to record from only one channel of an input source on a stereoMacintosh and <code>siActiveChannels</code> is not available, record in stereo(siNumberChannels set to 2) and have your buffer routine only copy out thedesired channel. This is the most effective and memory-frugal workaround.</p><h3>Portable Issues</h3><P>The PowerBook 5300 does not support microphone level input as most other Macsdo. That 1/8" jack in the back that looks suspiciously like a microphone jackisn't - it's a line input jack. The PowerBook 5300 requires line-level input torecord sounds from this jack, such as the input levels that are carried on RCAtype jacks. Some Macintoshes shipped with an RCA-to-microphone level adapter,but this won't work on the PowerBook 5300.</p><P>You'll need to buy a RCA-to-mini 1/8" jack to get sound into a PowerBook 5300if you don't want to use the built in microphone. Recording must be done from asource that outputs line level signals, such as a standard CD player.</p><P>The PowerBook Duo 2300's sound hardware is capable of recording stereo sound,but since its built-in microphone only records in mono, and the 2300 doesn'thave a line-in jack, you have to connect it to an external Duo Dock to getline-in input. The current Apple Duo Docks that provide sound input jacks onlyprovide mono input connectors. Unless a third party makes a dock with a stereosound input jack, there just isn't a way to get from hear (pun intended) tothere.</p><P><A HREF="#top">Back to top</A></P><a name = "RTFToC2"></a><h2>Output Items</h2><P>Sound Managers version 3.0 and later extend the capabilities of the output ofsound, offering 16-bit sound and better sample rates along with more a flexiblecomponent architecture.</p><h3>Return the Right Thing</h3><P>If you are calling <code>SndSoundManagerVersion</code>, <code>MACEVersion</code>, MIDIVersion,<code>SpeechManagerVersion</code>, or <code>SPBVersion</code>, make sure that the return types are aNumVersion instead of a long. Change your headers if necessary.</p><P>These are currently the only calls that should return a NumVersion.</p><h4>Trouble with Void Pointers </h4><P>The <code>SetSoundOutputInfo</code>, <code>SndSetInfo</code>, and <code>SPBSetDeviceInfo</code> all take a void* astheir last parameter.</p><P>Because the last parameter of these calls is a void*, it looks as if you needto pass a pointer to the value you are setting, but this is not the case ifwhat you are passing is 4 bytes or less in size. If you are passing a parameterthat is larger than four bytes, you must pass a pointer to it.</p><P>If you are calling GetSoundOutputInfo, SndGetInfo, or <code>SPBGetDeviceInfo</code> and itis returning a value that is 4 bytes in size or less, it does not return apointer to that value, it just returns the value.</p><h3>Playing a Compressed Sound Using <code>SndPlayDoubleBuffer</code></h3><P>Beginning with Sound Manager 3.0, if you're using <code>SndPlayDoubleBuffer</code> to playsounds, you need to use the <code>SndDoubleBufferHeader</code> structure for uncompressedsounds. Use the <code>SndDoubleBufferHeader</code>2 structure to play both compressed anduncompressed sounds.</p><P><code>SndPlayDoubleBuffer</code> takes a pointer to a structure of type<code>SndDoubleBufferHeader</code>. To play a compressed sound using the<code>SndDoubleBufferHeader2</code> structure, simply cast it to a <code>SndDoubleBufferHeader</code>Ptrwhen you call <code>SndPlayDoubleBuffer</code>. The <code>SndPlayDoubleBuffer</code> function is "smart"enough to figure out the rest.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>Starting with Sound Manager 3.0 <code>SndPlayDoubleBuffer</code> is able to play 16bit sounds. See the <i>SndMgr 3.0 release note</i> for more information</P></TD></TR></TABLE></CENTER><BR><h3>Too Much of a Good Thing</h3><P>Some applications may be calling some Sound Manager calls more often than theyneed to, specifically, <code>GetDefaultOutputVolume</code>. Some applications call thisfunction in their main event loop when this is probably not necessary. Soundvolume levels rarely change ten or more times a second -- in fact, they rarelychange. The proper time to call <code>GetDefaultOutputVolume</code> is right before you goto play a sound to see if you need to adjust the output device's volume, or toadjust the input or output gain of a device. This saves you a little time inyour event loop and may make your application a bit faster.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>You probably shouldn't be changing the output volume, making theGetDefaultOutputVolume unnecessary. Take the user's word for the output volumethey want.</P></TD></TR></TABLE></CENTER><BR><h4>Trouble with Bits and Bytes</h4><P>In the <code>SndDoubleBufferHeader</code>2 structure, there is a field called <code>dbhSampleSize</code>which is the sample size in bits of the sound. <a href="http://developer.apple.com/documentation/mac/Sound/Sound-58.html"><i>Inside Macintosh: Sound</i>page 2-111</A> says that <code>dbhSampleSize</code> should be set to 0 if the sound iscompressed. This is incorrect: <code>dbhSampleSize</code> should always be set to the actualuncompressed sample size of the sound. <a href="http://developer.apple.com/documentation/mac/Sound/Sound-58.html"><i>Inside Macintosh: Sound</i> page 2-112</A>says that the dbhPacketSize field needs to be set to the number of bits perpacket; it needs to be set to the number of <b>bytes</b> per packet, however.</p><h3>Outta Time--The kNonRealTime Flag</h3><P>This only applies to those developers who are writing sound output components.It is expected that all sound components work in real time.</p><P>Beginning with Sound Manager 3.1 the kRealTime flag was renamed tokNonRealTime. This flag tells the Sound Manager that your sound component canalso work in non-real time, i.e., it can do a better job if only given theextra time.</p><P>This means that when the component is part of a QuickTime output chain or aSound Manager 3.2 conversion chain, it can take the extra time it needs to do abetter job.</p><h3>Hold That Memory</h3><P>Because we expect sound to occur in realtime, smoothly and without hiccups orgaps, if you turn on Virtual Memory (VM), you're going to experience problems.When VM pages it turns off interrupts for a long period of time and withoutinterrupts enabled, the Sound Manager is not able to service the soundhardware. If interrupts are disabled for too long, the sound will stop playingand then resume when VM re-enables interrupts.</p><P>You want to make sure that VM at least never pages out your sound's buffers.Even if it doesn't page out your buffers, this will not assure you that soundwill play uninterrupted, but it is the best that you can do. To this end, use<code>HoldMemory</code> to hold the memory that your sound's buffers are in. <code>HoldMemory</code> isexplained in the chapter "Virtual Memory" in <i>Inside Macintosh: Memory.</i><A HREF = "../me/me_09.html">Macintosh Technical Note ME 09</a> has valuable information about how to deal withVM and the limitations it imposes.</p><P>Be sure you call Un<code>HoldMemory</code> on each block when you are done with it.</p><h3>Why Caching is Not Useful</h3><P>Setting the <code>noCacheBit</code> (which is defined in FSM.h) to disable caching of readswhen you're reading a sound from disk is a good idea. Since many sounds arelarger than will fit into the cache, and most sounds are only played once,caching them is of no benefit and not worth the overhead. Refer to <A HREF = "../fl/fl_16.html">MacintoshTechnical Note FL 16</a> for information on how to use this feature.</p><P><A HREF="#top">Back to top</A></P><a name = "Summary"></a><h2>Summary</h2><P>Because there are real hardware differences among various Macintosh computers,you may not be taking full advantage of sound in your application. To avoidsound input and output problems, your app needs (1) to call Gestalt and<code>SPBGetDeviceInfo</code> to determine what features and capabilities are present inboth the hardware and the Sound Manager, and (2) to pay attention to the topicsand issues addressed in this Technote.</p><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><P><a href="http://developer.apple.com/documentation/mac/Sound/Sound-2.html"><i>Inside Macintosh: Sound</i></A></p><p>The Sound Manager 3.0, 3.1, and 3.2 Release Notes on Developer CD Series.</p><p>Macintosh Technote <A HREF = "../me/me_09.html">ME 9 - Coping With VM and Memory Mappings</a></p><p>Macintosh Technote <A HREF = "../fl/fl_16.html">FL 16 - File Manager Performance and Caching</a></p><P><A HREF="#top">Back to top</A></P>         <P><A NAME=Downloads></A></P>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (68K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tn1048.pdf">Download</A></P>               </TD>            </TR></TABLE><P><A HREF="#top">Back to top</A></P></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1048.html%3Fid%3DDTS10002889-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1048.html%3Fid%3DDTS10002889-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1048.html%3Fid%3DDTS10002889-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>