<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!--Template 06-20-02--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Q&amp;A DV18: Detecting a CD-ROM</title>	<meta name="keywords" content="Mac OS 7 CD-ROM drive detection">	<meta name="Description" content="Technical Q&amp;A DV18: Q&amp;A presents methods for determiningwhether a drive on the Mac is a CD-ROM drive, including aDriverGestalt code snippet which does this for version 5.2.xof .AppleCD. Q&amp;A also gives a method for discovering unmounteddrives on a machine."><meta name="categories" content="Devices"><meta name="week-posted" content="Jan 27, 1997 - Jan 31, 1997"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10001159" title="Detecting a CD-ROM"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/HardwareDrivers/index.html">Hardware & Drivers</a> &gt; <a href="../../technicalqas/HardwareDrivers/idxMassStorageDevices-date.html">Storage</a> &gt; </p><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A DV18</div>
<div id="pageheadsub">Detecting a CD-ROM</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><!-- begin_content --> <CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=555> <TR> <td align="left"><hr width=500 align=center><p id=p2>Q:  My application runs from the hard disk, but it requires a specificCD-ROM to be present on the system. I am concerned about the possibilitythat a user may have a  hard-disk volume or a diskette with the samename as my CD-ROM. To check for this, my application searches for aspecifically named locked volume that contains a certain file, and I'dlike to simplify this process.  What is the best way to determine if amounted volume or SCSI address is a CD-ROM drive?</p><p id=p4>A:  In the past, there was no foolproof way to determine whether a drive on theMacintosh is a CD-ROM, so developers tried several methods:</p><OL TYPE="1" START="1">	<LI><p id=p4>Inspect the drive-queue element for a mounted drive to determine whichdriver the <code>dQRefNum</code> points to. Then, inspectthe driver's name. If the name is ".AppleCD", it's probably a CD-ROM drive.</p></li><LI><p id=p4>This approach fails for non-Apple CD-ROM drives, since they have differentdriver names.</p></li>    <LI><p id=p4>Inspect the drive's attributes in the four bytes preceding thedrive-queue entry. If the drive is "locked in hardware" andis removable, it's probably a CD-ROM drive.</p></li>    <LI><p id=p4>Issue a SCSI request directly to the drive.</p></li> <LI><p id=p4>This fails for some early CD-ROM drives (non-SCSI-2 compliant). BeforeSCSI-2, there was no CD-ROM device type defined, and some CD-ROM drivesreported that they were hard disks. There is an additional complicationintroduced by SCSI Manager 4.3, and IDE CD-ROM drives require a completelydifferent calling architecture.</p></li><LI><p id=p4>Furthermore, some newer Macintosh models such as the PowerBook 1400 and many of theclones use an ATAPI protocol-based CD-ROM drive and therefore won't show upin any SCSI probing you do.</p></li></OL><p id=p4>However, since the introduction of version 5.2.X. of the .AppleCD (and any.AppleCD compliant) driver, CD-ROM drivers have supported the <code>DriverGestalt</code>csCode.</P><p id=p4>To find the inserted CD-ROM drives using these drivers, you can scan the Drive Table andissue <code>DriverGestalt</code> commands to the drivers to determine the device type.The following snippet will illustrate this:</P><TABLE BORDER=0 CELLPADDING=5 WIDTH=550> <TR> <td bgcolor="#e6e6e6" align=left><pre>#include &lt;DriverGestalt.h&gt;void FindTheCD-ROMS(void)                   //  Scan Drive table for CD-ROMS{    DriverGestaltParam          pb;    DrvQEl  *dqp;    OSErr   status;    pb.csCode       = kDriverGestaltCode;       // Setup Driver Gestalt PB    pb.driverGestaltSelector = kdgDeviceType;   // ask for Device Type    dqp = (DrvQEl *) GetDrvQHdr()-&gt;qHead;   // Start with head of drive queue    while (dqp != NULL) {                   // for each device in drive queue        pb.ioCRefNum    = dqp-&gt;dQRefNum;            // Get the driver refNum        pb.ioVRefNum    = dqp-&gt;dQDrive;             // get the drive  refNum        status = PBStatusSync((ParmBlkPtr) &amp;pb);    // Do a Driver Gestalt call        if (status == noErr)            if(pb.driverGestaltResponse == kdgCDType ) // Device type is 'cdrm'            {                    printf("Drive: %d Driver:(%d) ",                             (int) dqp-&gt;dQDrive, dqp-&gt;dQRefNum);            }        dqp = (DrvQEl *) dqp-&gt;qLink;                // Next drive    }}</pre></td></tr> </table> <p id=p4>A complete sample entitled <a href="http://www.vmeng.com/vinnie/Papers/DriverGestaltDemo.html">Macintosh Disk Driver Gestalt Sample</a> is available from DTS which illustrates how toquery devices.</P><p id=p4>To discover any unmounted drives, you need to use either the SCSI or ATAmanager, whichever is appropriate.  The <a href="http://www.vmeng.com/vinnie/Papers/ATADemo.html"> 'ATA demo' DTScode sample </a> illustrates how to scan the ATA bus and identify theavailable devices.</P><p id=p4>There is also a driver <code>Status</code> call for available on the .AppleCD driverstarting in version 5.2.X. that will return information on the type ofCD-ROM device.</P><p id=p4>Issue a Status Call to the .AppleCD Driver with the following parameters:</P><TABLE BORDER=0 CELLPADDING=5 WIDTH=550> <TR> <td bgcolor="#e6e6e6" align=left><pre>    csCode = 120    csParam[ 0 -1]   will return a DeviceIdent of the formtypedef struct DeviceIdent{  uchar busType;                // SCSI -  0                ATAPI = 7  uchar bus;                    // SCSI - Bus#              ATAPI = 0  uchar targetID;               // SCSI - Target SCSI ID    ATAPI = Bus #  uchar partition ;             // SCSI - LUN               ATAPI  = 0}</pre></td></tr> </table> <p id=p4>One thing to note: if you are using an older version of the .AppleCDdriver, the above calls might not work, in which case you may considereither falling back to previous methods or requesting the user update theirCD-ROM driver.</P></td></tr></table></CENTER><!-- end_content --><!-- begin_date --><H4 ALIGN=center>[Jan 31 1997]</H4><!-- end_date --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/dv/dv18.html%3Fid%3DDTS10001159-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/dv/dv18.html%3Fid%3DDTS10001159-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/dv/dv18.html%3Fid%3DDTS10001159-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --> <hr width=500 align=center> </BODY> </HTML>