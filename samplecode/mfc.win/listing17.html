<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>mfc.win - /QTClasses/CQuickTime.cpp</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/QuickTime/index.html">QuickTime</a> &gt; <a href="../../samplecode/QuickTime/idxMovieBasics-date.html">Movie Basics</a> &gt; <A HREF="javascript:location.replace('index.html');">mfc.win</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">mfc.win</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/QTClasses/CQuickTime.cpp</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/MFCMDIPlayer/ChildFrm.cpp</option>
<option value="listing2.html">/MFCMDIPlayer/ChildFrm.h</option>
<option value="listing3.html">/MFCMDIPlayer/MainFrm.cpp</option>
<option value="listing4.html">/MFCMDIPlayer/MainFrm.h</option>
<option value="listing5.html">/MFCMDIPlayer/MFCMDIPlayer.cpp</option>
<option value="listing6.html">/MFCMDIPlayer/MFCMDIPlayer.h</option>
<option value="listing7.html">/MFCMDIPlayer/MFCMDIPlayerDoc.cpp</option>
<option value="listing8.html">/MFCMDIPlayer/MFCMDIPlayerDoc.h</option>
<option value="listing9.html">/MFCMDIPlayer/MFCMDIPlayerView.cpp</option>
<option value="listing10.html">/MFCMDIPlayer/MFCMDIPlayerView.h</option>
<option value="listing11.html">/MFCMDIPlayer/ReadMe.txt</option>
<option value="listing12.html">/MFCMDIPlayer/Resource.h</option>
<option value="listing13.html">/MFCMDIPlayer/StdAfx.cpp</option>
<option value="listing14.html">/MFCMDIPlayer/StdAfx.h</option>
<option value="listing15.html">/MFCQTClasses/CQuickTime.cpp</option>
<option value="listing16.html">/MFCQTClasses/CQuickTime.h</option>
<option value="listing17.html">/QTClasses/CQuickTime.cpp</option>
<option value="listing18.html">/QTClasses/CQuickTime.h</option>
<option value="listing19.html">/SimpleEdit/MainFrm.cpp</option>
<option value="listing20.html">/SimpleEdit/MainFrm.h</option>
<option value="listing21.html">/SimpleEdit/ReadMe.txt</option>
<option value="listing22.html">/SimpleEdit/resource.h</option>
<option value="listing23.html">/SimpleEdit/SimpleEditMFC.cpp</option>
<option value="listing24.html">/SimpleEdit/SimpleEditMFC.h</option>
<option value="listing25.html">/SimpleEdit/SimpleEditMFCDoc.cpp</option>
<option value="listing26.html">/SimpleEdit/SimpleEditMFCDoc.h</option>
<option value="listing27.html">/SimpleEdit/SimpleEditMFCView.cpp</option>
<option value="listing28.html">/SimpleEdit/SimpleEditMFCView.h</option>
<option value="listing29.html">/SimpleEdit/StdAfx.cpp</option>
<option value="listing30.html">/SimpleEdit/StdAfx.h</option>
<option value="listing31.html">/SimplePlayer/MainFrm.cpp</option>
<option value="listing32.html">/SimplePlayer/MainFrm.h</option>
<option value="listing33.html">/SimplePlayer/ReadMe.txt</option>
<option value="listing34.html">/SimplePlayer/Resource.h</option>
<option value="listing35.html">/SimplePlayer/SimplePlayerMFC.cpp</option>
<option value="listing36.html">/SimplePlayer/SimplePlayerMFC.h</option>
<option value="listing37.html">/SimplePlayer/SimplePlayerMFCDoc.cpp</option>
<option value="listing38.html">/SimplePlayer/SimplePlayerMFCDoc.h</option>
<option value="listing39.html">/SimplePlayer/SimplePlayerMFCView.cpp</option>
<option value="listing40.html">/SimplePlayer/SimplePlayerMFCView.h</option>
<option value="listing41.html">/SimplePlayer/StdAfx.cpp</option>
<option value="listing42.html">/SimplePlayer/StdAfx.h</option></select>
				</p>
				</form>
				<p><strong><a href="mfc.win.zip">Download Sample</a></strong> (&#147;mfc.win.zip&#148;, 117.3K)<BR>
<strong><a href="mfc.win.dmg">Download Sample</a></strong> (&#147;mfc.win.dmg&#148;, 176.6K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*
  File:    CQuickTime.c

  Written by: Keith Gurganus

  Note: Set project settings to &quot;Not using precompiled headers&quot; for this file.
*/

#include &quot;QTML.h&quot;
#include &quot;CQuickTime.h&quot;

CQuickTime::CQuickTime()
{
  movieOpened = FALSE;
  theMovie = NULL;
    theMC = NULL;
  theHwnd = NULL;
  theViewHwnd = NULL;
  theAppName[0] = '\0';
  theFullPath[0] = '\0';
}

CQuickTime::~CQuickTime()
{
}

void CQuickTime::NewMovieFile(void){
  // Close any previously opened movie
  CloseMovie();

  // Set the port  
  SetGWorld((CGrafPtr)GetHWNDPort(theViewHwnd), nil);

  // Create a newMovie
  theMovie = NewMovie(newMovieActive);

  if ( theMovie != NULL ) {
    // set window title to name  
    strcpy((char*)theFullPath,&quot;Untitled&quot;);
    SetWindowTitle();

    // Create the movie controller
    CreateNewMovieController(theMovie);
    
    movieOpened = TRUE;
  }  
}


BOOL CQuickTime::OpenMovie(unsigned char *fullPath)
{
  BOOL  isMovieGood = FALSE;

  if ( strlen ((char*)fullPath ) != 0)
  {
    OSErr        err;
    short        theFile = 0;
    long        controllerFlags = 0L;
    FSSpec        sfFile;
    short        movieResFile;

    // Close any previously opened movie
    CloseMovie();
  
    // make a copy of our full path name
    strcpy ( (char *)theFullPath, (const char *) fullPath );

    // convert theFullPath to pstring
    CToPstr((char*)theFullPath);

    // Make a FSSpec with a pascal string filename
    FSMakeFSSpec(0,0L,theFullPath, &amp;sfFile);
    
    // Set the port  
    SetGWorld((CGrafPtr)GetHWNDPort(theViewHwnd), nil);

    // Open the movie file
    err = OpenMovieFile(&amp;sfFile, &amp;movieResFile, fsRdPerm);
    if (err == noErr)
    {
      // Get the Movie from the file
      err = NewMovieFromFile(&amp;theMovie,movieResFile, 
                  nil, 
                  nil, 
                  newMovieActive, /* flags */
                  nil);
    
      // Close the movie file
      CloseMovieFile(movieResFile);

      if (err == noErr)
      {
        // Create the movie controller
           CreateNewMovieController(theMovie);
        isMovieGood = movieOpened = TRUE;  
        PToCstr((char*)theFullPath);
      } else
        theFullPath[0] = '\0'; 
        
    } else
      theFullPath[0] = '\0';
    
    SetWindowTitle();
  }
  return isMovieGood;
}

void CQuickTime::CloseMovie(void)
{
  if (movieOpened == TRUE ){
    movieOpened = FALSE;
   
    if (theMC)
      DisposeMovieController(theMC);

    if (theMovie)
      DisposeMovie(theMovie);

    theMovie = NULL;
    theMC = NULL;
  }

  Rect initialRect;
  initialRect.bottom = MINWINDOWHEIGHT;
  initialRect.right = MINWINDOWWIDTH;
  
  SizeWindow((WindowPtr)GetHWNDPort(theViewHwnd), initialRect.right, initialRect.bottom, FALSE);

  /* set window title to empty name */
  theFullPath[0] ='\0';
  SetWindowTitle ();
}


void CQuickTime::SaveAsMovie(void){
  unsigned char  lpszPathName[256];
  OPENFILENAME  ofn;

    memset(&amp;ofn, 0, sizeof(OPENFILENAME));
  lpszPathName[0] = '\0';

    ofn.lStructSize = sizeof(OPENFILENAME);
    ofn.hwndOwner = ::GetActiveWindow ();
    ofn.lpstrFilter = &quot;QuickTime Movies (*.mov) \0 *.mov\0&quot;;
    ofn.lpstrFile = (char *)lpszPathName;
    ofn.nMaxFile = sizeof(lpszPathName);
    ofn.lpstrFileTitle = NULL;
    ofn.nMaxFileTitle = (unsigned long)NULL;
    ofn.lpstrInitialDir = NULL;
    ofn.Flags = OFN_OVERWRITEPROMPT;

  // Put up a save file dialog
    if (GetSaveFileName(&amp;ofn)) {
    long      movieFlattenFlags = flattenAddMovieToDataFork;
    FSSpec      sfFile;
    OSType      creator = FOUR_CHAR_CODE('TVOD');
    long      createMovieFlags = createMovieFileDeleteCurFile;

    // Convert full path name to pstring
    CToPstr((char *)lpszPathName);  

    // Make a FSSpec with a pascal string filename
    FSMakeFSSpec(0,0L,lpszPathName, &amp;sfFile);

    // FlattenMovie
    FlattenMovie(  theMovie,
            movieFlattenFlags,
            &amp;sfFile,
            creator,
            -1,
            createMovieFlags,
            nil,
            NULL );
  
  }
}

void CQuickTime::OnEditCut() 
{
  Movie        scrapMovie;
  ComponentResult    theErr = noErr;
  
  if (theMC){
    scrapMovie = MCCut(theMC);
    if ( scrapMovie ) {
      theErr = PutMovieOnScrap(scrapMovie, 0L);
      DisposeMovie(scrapMovie);
    } 
  }
}

void CQuickTime::OnEditCopy() 
{
  Movie        scrapMovie;
  ComponentResult    theErr = noErr;
  
  if (theMC){
    scrapMovie = MCCopy(theMC);
    if ( scrapMovie ) {
      theErr = PutMovieOnScrap(scrapMovie, 0L);
      DisposeMovie(scrapMovie);
    }
  }
}

void CQuickTime::OnEditPaste() 
{
  if (theMC)
    MCPaste(theMC, nil);
}

void CQuickTime::OnEditClear() 
{
  if (theMC)
    MCClear(theMC);
}

void CQuickTime::OnEditUndo() 
{
  if (theMC)
    MCUndo(theMC);
}


void CQuickTime::OnEditSelectall() 
{
  TimeRecord       tr;
  ComponentResult    theErr = noErr;
  
  if ( theMovie &amp;&amp; theMC ) {
    tr.value.hi = 0;
    tr.value.lo = 0;
    tr.base = 0;
    tr.scale = GetMovieTimeScale(theMovie);
    MCDoAction(theMC, mcActionSetSelectionBegin, &amp;tr);
    tr.value.lo = GetMovieDuration(theMovie);
    MCDoAction(theMC, mcActionSetSelectionDuration, &amp;tr);
  } else {
    if ( theMovie == NULL )
      theErr = invalidMovie;
    else
      theErr = -1;
  }  
  
}

void CQuickTime::ProcessMovieEvent(HWND hWnd, unsigned int message, unsigned int wParam, long lParam) 
{  
  // Convert the Windows event to a QTML event
  MSG        theMsg;
  EventRecord    macEvent;
  LONG      thePoints = GetMessagePos();

    theMsg.hwnd = hWnd;
    theMsg.message = message;
    theMsg.wParam = wParam;
    theMsg.lParam = lParam;
    theMsg.time = GetMessageTime();
    theMsg.pt.x = LOWORD(thePoints);
    theMsg.pt.y = HIWORD(thePoints);

  // tranlate a windows event to a mac event
  WinEventToMacEvent(&amp;theMsg, &amp;macEvent);

  // Pump messages as mac event
    MCIsPlayerEvent(theMC,(const EventRecord *)&amp;macEvent);
}

int CQuickTime::OnMovieWindowCreate(HWND hWnd, CREATESTRUCT *lpCreateStruct) 
{

  if ( hWnd != NULL) { 
    theViewHwnd = hWnd;          // the view's hwnd
    theHwnd = ::GetParent(theViewHwnd);  // the parent hwnd   hwndParent

    int borderWidth = GetWindowsBorderWidth();
    int titlebarHeight = GetWindowsTitleHeight();
    int captionHeight = GetWindowsCaptionHeight();  

    lpCreateStruct-&gt;cy = borderWidth + titlebarHeight + captionHeight;
    lpCreateStruct-&gt;cx = MINWINDOWWIDTH;

    SetWindowTitle();
    Rect initialRect;
    initialRect.top = initialRect.left = initialRect.bottom = 0;
    initialRect.right = MINWINDOWWIDTH;

    // Create GrafPort &lt;-&gt; HWND association
    CreatePortAssociation(theViewHwnd, NULL, 0);  
  }

  return 0;
}
 
void CQuickTime::CreateNewMovieController(Movie theMovie)
{
  Rect  bounds;
  Rect  maxBounds;
  long   controllerFlags;

  // 0,0 Movie coordinates
  GetMovieBox(theMovie, &amp;theMovieRect);
  MacOffsetRect(&amp;theMovieRect, -theMovieRect.left, -theMovieRect.top);

  // Attach a movie controller
  theMC = NewMovieController(theMovie, &amp;theMovieRect, mcTopLeftMovie );

  // Get the controller rect 
  MCGetControllerBoundsRect(theMC, &amp;bounds);

  // Enable editing
  MCEnableEditing(theMC,TRUE);

  // Tell the controller to attach a movie's CLUT to the window as appropriate.
  MCDoAction(theMC, mcActionGetFlags, &amp;controllerFlags);
  MCDoAction(theMC, mcActionSetFlags, (void *)(controllerFlags | mcFlagsUseWindowPalette));

  // Allow the controller to accept keyboard events
  MCDoAction(theMC, mcActionSetKeysEnabled, (void *)TRUE);

  // Set the controller action filter
  MCSetActionFilterWithRefCon(theMC, MCFilter, (long)theViewHwnd);

  // Set the grow box amound
  GetMaxBounds(&amp;maxBounds);
  MCDoAction(theMC, mcActionSetGrowBoxBounds, &amp;maxBounds);

  // Size our window
  SizeWindow((WindowPtr)GetHWNDPort(theViewHwnd), bounds.right, bounds.bottom, FALSE);
}

void CQuickTime::OnMovieWindowDestroy() 
{  
  CGrafPtr  windowPort = NULL;
  
  // close any movies  before destroying PortAssocation
  CloseMovie();

  // Destroy the view's GrafPort &lt;-&gt; HWND association
  if (theViewHwnd)
    windowPort = (CGrafPtr)GetHWNDPort(theViewHwnd);
  
  if (windowPort)
    DestroyPortAssociation(windowPort);

}

void CQuickTime::SetWindowTitle(void) 
{
  /* set window title to name */
  unsigned char  fileName[64];
  unsigned char  appName[32];
  unsigned char  titleName[256];

  fileName[0] = '\0';
  appName[0] = '\0';
  titleName[0] = '\0';

  GetAppName((unsigned char *)&amp;appName);
  if (strlen((char*)appName))
    strcpy ((char *)titleName, (char *)appName);

  GetFileNameFromFullPath((unsigned char *)&amp;fileName);
  if (strlen((char*)fileName)){
    if (strlen((char*)appName))
      strcat ((char *)titleName, &quot; - &quot;);

    strcat ((char *)titleName, (char *)fileName);
  }
  ::SetWindowText(theHwnd, (const char *)titleName);
}

void CQuickTime::GetFileNameFromFullPath(unsigned char *fileName) 
{
  /* pluck the filename from the fullpath, */
  int    i = 0, j = -1, stringLen = 0;

  stringLen = strlen((char *)theFullPath);
  if (stringLen &gt; 0 ) {
    while(i&lt;stringLen){
      if (theFullPath[i] == 0x5c || theFullPath[i] == '/' )
        j = i;
      i++;
    }
    if ( j&gt;-1)
      strcpy((char *)fileName, (char *)&amp;theFullPath[j+1]);
    else
      strcpy((char *)fileName, (char *)theFullPath);

  }
}

void CQuickTime::GetAppName(unsigned char *appName)
{ 
#if (!WIN32)
  HINSTANCE theModule = (HINSTANCE)GetWindowLong(theHwnd, GWL_HINSTANCE);
  GetModuleFileName(theModule, (char *)appName, strlen((char *)appName) );
#else
  if (strlen((char*)theAppName) &gt; 0)
    strcpy((char*)appName, (char*)theAppName);
#endif
}

void CQuickTime::CToPstr(char *theString)
{
  char  tempString[256];

  tempString[0] = strlen (theString);
  tempString[1] = '\0';

  strcat ( tempString, theString );
  strcpy  ( theString, tempString );
}

void CQuickTime::PToCstr(char *theString)
{
  char  tempString[256];
  int    len = theString[0];

  memcpy ( tempString, &amp;theString[1], theString[0]);
  tempString[len] = '\0';
  strcpy  ( theString, tempString );
}

int  CQuickTime::GetWindowsBorderWidth (void)
{
  RECT  windowRect, clientRect;
  int    windowWidth, clientWidth;
  
  ::GetWindowRect(theHwnd, &amp;windowRect);
  ::GetClientRect(theHwnd, &amp;clientRect);

  windowWidth = windowRect.right - windowRect.left;
  clientWidth = clientRect.right - clientRect.left;

  return windowWidth - clientWidth;
}

int  CQuickTime::GetWindowsTitleHeight (void)
{
  RECT  windowRect, clientRect;
  int    windowHeight, clientHeight;
  int    windowWidth, clientWidth, bordersWidth;
  int    captionHeight, titlebarHeight;
  
  ::GetWindowRect(theHwnd, &amp;windowRect);
  ::GetClientRect(theHwnd, &amp;clientRect);

  windowWidth = windowRect.right - windowRect.left;
  clientWidth = clientRect.right - clientRect.left;
  bordersWidth = windowWidth - clientWidth;

  windowHeight = windowRect.bottom - windowRect.top;
  clientHeight = clientRect.bottom - clientRect.top;
  captionHeight = GetSystemMetrics(SM_CYCAPTION);  
  titlebarHeight = (windowHeight - clientHeight) - captionHeight;

  return titlebarHeight;
}

int CQuickTime::GetWindowsCaptionHeight(void)
{
   DWORD  dwStyle = 0L;
  int    retValue = 0L;

  if(!IsWindow(theHwnd))
    return 0L;

  dwStyle = GetWindowLong(theHwnd, GWL_STYLE);

  if (dwStyle &amp; WS_CAPTION)
    retValue = GetSystemMetrics(SM_CYCAPTION);

  return retValue;
}

void CQuickTime::GetMaxBounds(Rect *maxRect)
{
  RECT deskRect;

  GetWindowRect(GetDesktopWindow(), &amp;deskRect);

  OffsetRect(&amp;deskRect, -deskRect.left, -deskRect.top);

  maxRect-&gt;top = (short)deskRect.top;
  maxRect-&gt;bottom = (short)deskRect.bottom;
  maxRect-&gt;left = (short)deskRect.left;
  maxRect-&gt;right = (short)deskRect.right;
}

Movie CQuickTime::GetMovie()
{
  return theMovie;
}

Boolean MCFilter(MovieController mc, short action, void*params, long refCon)
{
  if(action == mcActionControllerSizeChanged) {
    Rect    bounds;
    WindowPtr  w;
    MCGetControllerBoundsRect(mc, &amp;bounds);

    w = GetHWNDPort((HWND)refCon);
    SizeWindow((WindowPtr)w, bounds.right, bounds.bottom, TRUE);
  }
  return FALSE;
}




</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/mfc.win/listing17.html%3Fid%3DDTS10000769-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/mfc.win/listing17.html%3Fid%3DDTS10000769-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/mfc.win/listing17.html%3Fid%3DDTS10000769-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>