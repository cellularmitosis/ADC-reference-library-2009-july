<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note PT25: MPW's -mc68881 Option</title><meta name="categories" content="Platforms and Tools"><meta name="week-posted" content="Jun 29, 1987 - Jul 3, 1987"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002679" title="MPW's -mc68881 Option"></a><a name="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxTools-date.html">Tools</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/Java/idxTools-date.html" target="_blank">Reference Library > Tools</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note PT25</div>
<div id="pageheadsub">MPW's -mc68881 Option</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext"><A HREF="#Section1">MPW Compilers and Extended Values</A><BR><BR><A HREF="#Section2">SANE on the Macintosh II</A><BR><BR><A HREF="#Section3">A Note About 68881 Accuracy and Numeric Compatibility</A><BR><BR><A HREF="#References">References</A><BR><BR><A HREF="#Changes">Change History</A><BR><BR><A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><p id="introtext">This Technical Note discusses MPW's <code>-mc68881</code> option, which represents<code>Extended</code> values in 96 bits (instead of 80, as with software SANE), andcompatibility issues when using non-SANE system calls that expect 80-bit<code>Extended</code> values.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[Jul 01 1990]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content --><a name=Section1></A><h2>MPW Compilers and Extended Values</h2><p>The MPW 2.0 and later compilers provide a command-line option,<code>-mc68881</code>, to generate in-line code to use the Motorola 68881/68882floating-point units (FPU). (Note that MPW compilers currently do not include a<code>-mc68882</code> option, as they treat the two chips the same. If you want tooptimize code for the 68882, then you need to write your own assembly-languagecode.)  This option allows applications to sacrifice compatibility with otherMacintosh models (those not equipped with an FPU) in exchange for muchincreased numeric performance.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Warning:</B><BR>Applications should not make assumptions about the presence ofan FPU based upon the microprocessor of a Macintosh. If an application makes aconditional branch to execute floating-point instructions directly, then itshould first explicitly check for the presence of the FPU with<code>_Gestalt</code> or <code>_SysEnvirons</code>. Furthermore, you should not assumethat the presence of an MC68040 processor guarantees access to floating-pointinstructions. Motorola has announced a reduced-cost MC68040 CPU that lacks anintegral floating-point unit. Possible inclusion of such a CPU in futureMacintosh products means FPU-less 68040 products may someday exist.</P></TD></TR></TABLE></CENTER><BR>   <p>When using the <code>-mc68881</code> option, the compiler stores all<code>Extended</code> values in the 96-bit format used by the 68881 instead of the80-bit software SANE (Standard Apple Numerics Environment), both of which areillustrated in Figures 1 and 2.</p><P align=center><img src="images/pt_25_001.gif" alt="Figure 1. Software SANE Format (80-Bit)." width=288 height=54></P><P align=center><b>Figure 1</b>. Software SANE Format (80-Bit)</p><P align=center><img src="images/pt_25_002.gif" alt="Figure 2. MC68881 Format (96-Bit)." width=384 height=54></P><P align=center><b>Figure 2.</b>  MC68881 Format (96-Bit)</p><p>This difference in format affects all procedures that accept floating-pointvalues as arguments, since all floating-point arguments are converted to<code>Extended</code> before being passed, no matter how they are declared (forexample, <code>Real</code>, <code>Single</code>, <code>Double</code>, or <code>Comp</code>).</p><p>When compiling with this option, you must link with a special SANELib libraryfile, SANE881Lib.o; the interface source file SANE.p containsconditional-compilation statements to make sure that the correct library'sinterface is compiled. In this situation, SANE procedures are used for certaintranscendental functions only (see the last section of this Technote), andthese functions, which are in SANE881Lib.o, expect their <code>Extended</code>parameters in 96-bit format.</p><p>However, numeric routines that are not compiled by Pascal (such as anyassembly-language routines) have no way of finding out that their parametersare in 96-bit format. If it is not possible to rewrite these routines for96-bit values, you can use the SANELib routines <code>X96ToX80</code> and<code>X80ToX96</code> to convert between formats. It might be simplest to define anew interface routine that automatically converts the formats:</p><b>Pascal</b><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    {FPFunc is a generic floating-point, assembly-language function that accepts}    {an 80-bit Extended parameter and returns an 80-bit result.}    {We've changed the types to reflect that these are not 96-bit values.}    FUNCTION FPFunc(x: Extended80): Extended80; EXTERNAL;    {Given that we're compiling in -mc68881 mode, the compiler}    {thinks that Extended values are 96-bits long, but FPFunc wants an}    {80-bit parameter and produces an 80-bit result; we convert.}    FUNCTION FPFunc96(x: Extended): Extended; {x is a 96-bit extended!}    BEGIN      {convert our argument, call the function, then convert the result}      MyFPFunc := X80ToX96(FPFunc(X96ToX80(x))); {call the real FPFunc}</pre>	</TD></TR></TABLE></CENTER><b>C</b><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    extern Extended80 FPFunc (Extended80 x);    Extended FPFunc96 (Extended x); //x is a 96-bit extended!    {      //convert our argument, call the function, then convert the result      MyFPFunc = X80ToX96(FPFunc(X96ToX80(x))); //call the real FPFunc</pre>	</TD></TR></TABLE></CENTER><p>It's best to avoid compiling some parts of an application with the<code>-mc68881</code> option on and other parts with it off; very strange bugs canoccur if you try this. Note that 80-bit code and 96-bit code cannot referencethe same <code>Extended</code> variables. There is no way to tell whether a givenstored value is in 80-bit format or 96-bit format.</p><b>Size of Data Structures</b><p>Compile time differences in the size of extended variables also cause problemsfor variables embedded in data structures.  The size of data structures andoffsets within the structure can change depending on the compile-time options.This could be particular troublesome of you write the data to a file and thenattempt to read the file with a version of the program which was compileddifferently.</p><p>An example of this can be found in some of the Sound Manager interfaces.  Forexample, prior to MPW 3.2.1, the ExtSoundHeader record contained an extendedfield which could cause the problem described above.  In MPW 3.2.1, theextended field was changed to the uniform type extended80 to avoid theproblem.</p><a name="Section2"></a> <P><A HREF="#top">Back to top</A></p><h2>SANE on the Macintosh II</h2><p>The version of SANE provided in the Macintosh II ROM recognizes the presence ofthe 68881 and uses it for most calculations automatically. SANE still expects(and produces) 80-bit-format <code>Extended</code> values; it converts to and from96-bit format internally when using the 68881.</p><a name="Section3"></a> <P><A HREF="#top">Back to top</A></p><h2>A Note About 68881 Accuracy and Numeric Compatibility</h2><p>SANE is more accurate than the 68881 when calculating results of certainfunctions (<code>Sin</code>, <code>Cos</code>, <code>Arctan</code>, <code>Exp</code>,<code>Ln</code>, <code>Tan</code>, <code>Exp1</code>, <code>Exp2</code>, <code>Ln1</code>, and<code>Log2</code>). To maintain this accuracy, SANE does not use 68881 instructionsto directly perform these functions; thus the results you get from SANEcalculations are still identical on all Macintosh systems.</p><p>To preserve this numeric compatibility with other SANE implementations, MPWcompilers normally do not generate in-line 68881 calls to the above functions,even when the <code>-mc68881</code> option is used; instead, they generate SANEcalls to accomplish them. If you are willing to sacrifice numeric compatibilityto gain extra speed, you can override this compiler feature with thecompile-time variable, <code>Elems881</code>; include the option <code>-d Elems881 =TRUE </code>on the Pascal compiler and <code>-Elems881</code> on the C compilercommand line to cause the compiler to generate direct 68881 instructions.</p><p>For certain other transcendental functions provided by the 68881 that are notprovided by SANE, MPW compilers generate direct 68881 calls if the<code>-mc68881</code> option is on, independent of the setting of the<code>Elems881</code> variable. These operations are <code>Arctanh</code>,<code>Cosh</code>, <code>Sinh</code>, <code>Tanh</code>, <code>Log10</code>, <code>Exp10</code>,<code>Arccos</code>, <code>Arcsin</code>, and <code>Sincos</code>.</p><p>For Pascal programmers, it is important to note that if you want an applicationto check for an FPU and exit gracefully if it does not exist, then you need tocheck for the FPU with code that does not have the <code>-mc68881</code> optionturned on. You need to do this because the <code>-mc68881 </code>option insertscode to initialize the 68881/68882 at the beginning of your code, and thisinitialization code causes an exception error if no FPU is present. Forexample, if you check for the existence of an FPU in your main Pascalprocedure, you need to compile that main procedure with <code>{$MC68881-}</code>.Note that this compiler option affects the entire file that contains theoption, so you would need to separate any code that uses an FPU into anotherfile.</p><p>After you determine that an FPU exists, you have to execute the followinginstructions by hand to initialize the FPU yourself:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre> PROCEDURE ClearTheFPU ();        INLINE    $42A7,                    {clr.l -(a7)}                  $42A7,                    {clr.l -(a7)}</pre>	</TD></TR></TABLE></CENTER><BR><br><a name="References"></a> <P><A HREF="#top">Back to top</A></p><h2>References</h2><P>   <i>Inside Macintosh</i>, Volume V-1, Compatibility Guidelines</p><P>   <i>Apple Numerics Manual</i>, Second Edition</p><P>   <A HREF = "../ov/ov_16.html">M.OV.GestaltSysenvirons</a></p><P>   <A HREF = "../hw/hw_32.html">M.HW.SpeedyMathCoProc</a></p><P>   MPW Pascal Reference Manual</p>  <P><A HREF="#top">Back to top</A></p><h2>Change History</H2>                           <TABLE BORDER=0 CELLPADDING=3 WIDTH=544>            <TR>               <td width=100 align=left>                  <P ALIGN=center>01-June-1990</P>               </TD>               <td align="left">                  <P>Extended the warning about explicitly checkingfor the presence of an FPU if an application uses floating-point instructionsto include the possibility of FPU-less MC68040 products and also raised theissue of extended values embedded in data structures.</P>               </TD>            </TR>            <TR>               <td width=100 align=left>                  <P ALIGN=center>01-June-1987</P>               </TD>               <td align="left">                  <P>Originally written.</P>               </TD>            </TR>         </TABLE>         <BR>                <a name=Downloads></A>                  <P><A HREF="#top">Back to top</A></p><h2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/pt_25.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/pt/pt_25.html%3Fid%3DDTS10002679-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/pt/pt_25.html%3Fid%3DDTS10002679-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/pt/pt_25.html%3Fid%3DDTS10002679-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>