<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>ATSUI Programming Guide: Direct-Access Tasks: Working With Glyph Data</title>
	<meta id="Generator" name="Generator" content="Gutenberg"/>
	<meta id="GeneratorVersion" name="GeneratorVersion" content="v132"/>
	<meta http-equiv="content-type" content="text/html;charset=utf-8"/>
	<meta id="Copyright" name="Copyright" content="Copyright 2009 Apple Inc. All Rights Reserved."/>
	<meta id="IndexTitle" name="IndexTitle" content="Direct-Access Tasks: Working With Glyph Data"/>
	<meta id="xcode-display" name="xcode-display" content="render"/>
	<meta id="toc-file" name="toc-file" content="../toc.html"/>
	<meta id="RESOURCES" content="../../../../Resources" />
	
	<link rel="stylesheet" type="text/css" href="../../../../Resources/CSS/frameset_styles.css"/>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/prototype.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/lib/scriptaculous.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/page.js"></script>
	<script language="JavaScript" type="text/javascript" src="../../../../Resources/JavaScript/pedia.js"></script>
	<!--[if lte IE 6]>
		<style type="text/css">
			/*<![CDATA[*/ 
			html {overflow-x:auto; overflow-y:hidden;  }
			/*]]>*/
		</style>
	<![endif]-->
</head>    
<body bgcolor="#ffffff" onload="initialize_page();"><a name="//apple_ref/doc/uid/TP30000033" title="Direct-Access Tasks: Working With Glyph Data"></a>
    <noscript>
    <div id="tocMenu">
        <iframe id="toc_content" name="toc_content" SRC="../toc.html" width="210" height="100%" align="left" frameborder="0">This document set is best viewed in a browser that supports iFrames.</iframe>
    </div>
    </noscript>
    <div id="bodyText">
        <a name="top"></a>
        <div class="hideOnPrint hideInXcode">
        <!-- start of header -->
        <!--#include virtual="/includes/framesetheader" -->
        <!-- end of header -->
        </div>
        
        <!-- start of path -->
<div class="breadcrumb hideOnPrint hideInXcode"><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Guides</a> &gt; <a href="../../../index.html#//apple_ref/doc/uid/TP30000440-TP30000420" target="_top">Carbon</a> &gt; <a href="../../../TextFonts-date.html#//apple_ref/doc/uid/TP30000440-TP30000420-TP30000461" target="_top">Text &amp; Fonts</a> &gt; <a href="../atsui_chap1/atsui_intro.html#//apple_ref/doc/uid/TP30000027-TP1">ATSUI Programming Guide</a> &gt; </div><br class="hideInXcode"/><!-- end of path -->
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../atsui_chap6/atsui_adv_tasks.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../atsui_app_unicode/atsui_appendixA.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCUpperSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" hideText="Hide TOC" showText="Show TOC" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <hr />
        
        
        <a name="//apple_ref/doc/uid/TP30000033-TP1" title="Direct-Access Tasks: Working With Glyph Data"></a><h1>Direct-Access Tasks: Working With Glyph Data</h1><p>ATSUI provides a set of functions that enable you to access information about glyphs during the layout process. These functions are called <strong>direct-access functions</strong><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1070"></a> because they allow you to manipulate glyph data directly. You can use direct-access functions to control many aspects of ATSUI’s internal layout process and, as a result, control how ATSUI draws text for your application. For example, you can override one or more steps of the ATSUI layout process, exercise fine control over layout metrics, specify glyph replacements, and perform post-layout processing.</p><div class="notebox"><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_28" title="Note"></a><p><strong>Note:</strong>&nbsp;Direct-access functions should be used only if you provide your own text layout engine in your application. Most developers do not need to use direct-access functions, because ATSUI provides line and layout attributes that support the requirements of most applications.</p></div><p>You can call ATSUI direct-access functions along with functions you’ve provided in your text layout engine. Mixing your functions with ATSUI’s reduces the processing ATSUI does by default and enables you to perform your own layout adjustments. </p><p>This chapter shows you how to use ATSUI’s direct-access functions in the following sections:</p><ul class="ul"><li class="li"><p><span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-TPXREF144">“Overriding ATSUI Layout Operations ”</a></span> shows how to write and install callbacks that obtain and modify glyph positioning information. </p></li><li class="li"><p><span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-TPXREF136">“Retrieving and Drawing Glyph Outlines”</a></span> provides information on obtaining the curves that make up a glyph shape and using your own functions to draw them.</p></li></ul><p>Before you read this chapter you should be familiar with the text measurement terms discussed in Chapter 2, <span class="content_text"><a href="../atsui_chap2/atsui_concepts.html#//apple_ref/doc/uid/TP30000028-TP1">“Typography Concepts”</a></span> and know how to perform the tasks discussed in Chapter 4, <span class="content_text"><a href="../atsui_chap4/atsui_tasks.html#//apple_ref/doc/uid/TP30000030-TP1">“Basic Tasks: Working With Objects and Drawing Text.”</a></span></p><p>This chapter provides a number of code samples to illustrate how to use direct-access functions. You can obtain the sample applications from which this code is taken, as well as additional code samples, from the developer sample code website:</p><p><span class="content_text"><a href="../../../../../samplecode/" target="_top">http://developer.apple.com/samplecode/</a></span></p>
<!-- This template is being used for both PDF and HTML. -->

    
    <h4>In this section:</h4>
    
    
    <p class="blockquote">
    
        
			
			
				<a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-TPXREF144">Overriding ATSUI Layout Operations</a>
				
			<br/>
			
        
			
			
				<a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-TPXREF136">Retrieving and Drawing Glyph Outlines</a>
				
			<br/>
			
        

    </p><br/>

<a name="//apple_ref/doc/uid/TP30000033-TPXREF144" title="Overriding ATSUI Layout Operations "></a><h2>Overriding ATSUI Layout Operations </h2><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1071"></a><p>You can override ATSUI’s layout operations by modifying layout information for the glyphs associated with a text layout object. You can adjust such values as the glyph’s baseline delta, advance delta, and real position values. You can also specify a post-layout operation (such as glyph substitution) that modifies a line after ATSUI has completed its layout operations. <span class="content_text">Table 6-1</span> defines some of the values you can modify using direct-access functions.</p><a name="//apple_ref/doc/uid/TP30000033-CJBEDEHG" title="Table 6-1Some values you can modify using direct-access functions "></a><div class="tableholder"><table class="graybox" border = "0" cellspacing="0" cellpadding="5"><caption class="tablecaption"><strong>Table 6-1&nbsp;&nbsp;</strong>Some values you can modify using direct-access functions </caption><tr><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Value</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Definition</p></th></tr><tr><td  scope="row"><p>Real position<a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1072"></a></p></td><td ><p>The actual drawing position on the x-axis. This position does not include the device delta.</p></td></tr><tr><td  scope="row"><p>Advance delta<a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1073"></a></p></td><td ><p>The distance between the end of one glyph’s advance and the next glyph’s real position.</p></td></tr><tr><td  scope="row"><p>Baseline delta<a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1074"></a></p></td><td ><p>The distance between the actual drawing position on the y-axis and the baseline position. </p></td></tr><tr><td  scope="row"><p>Device delta<a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1075"></a></p></td><td ><p>A value used to adjust truncated factional values for cases in which fractional positioning can’t be used. For example, to compensate for integer drawing in QuickDraw. Device delta values are usually used when anti-aliasing is turned off. However, these values can be used when anti-aliasing is on to assure that the glyphs in a connected script (such as one that used the Zapfino font) are connected smoothly.</p></td></tr></table></div><p>The three lines of text in <span class="content_text">Figure 6-1</span> show an example of what you can do using the ATSUI direct-access functions. The first line is drawn as ATSUI would normally draw the text. The next two lines were drawn by ATSUI after glyph values were modified through the use of direct-access functions. The advance delta values of the text in the second line have been modified by decreasing the advance to create a condensed text appearance. Whereas the advance delta values of the text in the third line have been increased from normal to create an extended text appearance. To achieve each effect, the advance delta values are modified by a callback, then ATSUI uses the modified values during the course of its normal layout and drawing processes.</p><br/><div><a name="//apple_ref/doc/uid/TP30000033-BBCDIBJA" title="Figure 6-1Unadjusted text compared to text with modified advance delta values"></a><p><strong>Figure 6-1&nbsp;&nbsp;</strong>Unadjusted text compared to text with modified advance delta values</p><img src = "../art/advancedeltas.gif" alt = "Unadjusted text compared to text with modified advance delta values" width="439" height="109"></div><br/><p><span class="content_text">Figure 6-2</span> also shows an example of using ATSUI direct-access functions, but in this case the layout was modified after ATSUI already performed its normal layout process. The space characters in the text are replaced with a specified replacement character through a callback that is applied post-layout.</p><br/><div><a name="//apple_ref/doc/uid/TP30000033-BBCHFHAG" title="Figure 6-2Text drawn with replacement characters in place of space characters"></a><p><strong>Figure 6-2&nbsp;&nbsp;</strong>Text drawn with replacement characters in place of space characters</p><img src = "../art/whitespacereplace.gif" alt = "Text drawn with replacement characters in place of space characters" width="448" height="25"></div><br/><p>The text in <span class="content_text">Figure 6-3</span> is one line of text. The baseline delta values for the glyphs are adjusted such that every other glyph has a positive baseline delta value and alternate glyphs have a negative baseline delta value.</p><br/><div><a name="//apple_ref/doc/uid/TP30000033-BBCCFAFC" title="Figure 6-3Text with modified baseline delta values"></a><p><strong>Figure 6-3&nbsp;&nbsp;</strong>Text with modified baseline delta values</p><img src = "../art/baselinedeltavee.gif" alt = "Text with modified baseline delta values" width="437" height="124"></div><br/><p>As you can see from <span class="content_text">Figure 6-1</span>, <span class="content_text">Figure 6-2</span>, and <span class="content_text">Figure 6-3</span>, you can achieve a number of effects using the ATSUI direct-access functions. Overriding ATSUI layout operations requires that you perform these tasks:</p><ol class="ol"><li class="li"><p>Write a callback that obtains glyph data from ATSUI and modifies the glyph data associated with a text layout object.</p></li><li class="li"><p>Install the callback on a text layout object.</p></li><li class="li"><p>Use ATSUI as you normally would to create text layout objects, draw text, get glyph bounds, and so forth. ATSUI invokes your callback each time it lays out a line of text.</p></li></ol><p>The callback definition for a direct-access callback function is as follows:<a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1076"></a></p><div class="codesample"><table><tr><td scope="row"><pre>OSStatus (* ATSUDirectLayoutOperationOverrideProcPtr)(<span></span></pre></td></tr><tr><td scope="row"><pre>                    ATSULayoutOperationSelector iCurrentOperation,<span></span></pre></td></tr><tr><td scope="row"><pre>                    ATSULineRef iLineRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                    UInt32 iRefCon,<span></span></pre></td></tr><tr><td scope="row"><pre>                    void *iOperationCallbackParameterPtr,<span></span></pre></td></tr><tr><td scope="row"><pre>                    ATSULayoutOperationCallbackStatus *oCallbackStatus);<span></span></pre></td></tr></table></div><p>These are the parameters:</p><ul class="ul"><li class="li"><p><code>iCurrentOperation</code>, the operation that triggered the callback. This value is passed to your callback by ATSUI. If you write a callback that handles more than one layout operation, you can use this value to determine which operation you should handle.</p></li><li class="li"><p><code>iLineRef</code>, a reference to the current line. This is the line of text on which your callback operates. Your callback gets called for each line of text associated with the text layout object on which you installed the callback.</p></li><li class="li"><p><code>iRefCon</code>, a value set by calling the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUSetTextLayoutRefCon" target="_top">ATSUSetTextLayoutRefCon</a></code>. This is optional, and can be any data you need to track for your application, such as user preference data related to layout operations.</p></li><li class="li"><p><code>iOperationCallbackParameterPtr</code>. Currently unused and is set to <code>NULL</code>. </p></li><li class="li"><p><code>oCallbackStatus</code>. On output, you must supply a status value to indicate to ATSUI whether your callback handled the operation (<code>kATSULayoutOperationCallbackStatusHandled</code>) or whether ATSUI needs to handle the operation (<code>kATSULayoutOperationCallbackStatusContinue</code>). If you return the result <code>kATSULayoutOperationCallbackStatusContinue</code>, ATSUI may overwrite any settings that you have modified for that process.</p></li></ul><p>Within the body of your callback function you need to call one of the ATSUI direct-access functions, such as <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUDirectGetLayoutDataArrayPtrFromLineRef" target="_top">ATSUDirectGetLayoutDataArrayPtrFromLineRef</a></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1077"></a>, to obtain the glyph data you want to modify. You use the data selectors shown in <span class="content_text">Table 6-2</span> to specify which data you want to obtain. The selectors are nonexclusive; you can use the logical-Or operator to combine several data selectors if your callback handles multiple operations.</p><a name="//apple_ref/doc/uid/TP30000033-BBCFCFGH" title="Table 6-2Data selectors used to obtain glyph data"></a><div class="tableholder"><table class="graybox" border = "0" cellspacing="0" cellpadding="5"><caption class="tablecaption"><strong>Table 6-2&nbsp;&nbsp;</strong>Data selectors used to obtain glyph data</caption><tr><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Selector</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Obtains</p></th></tr><tr><td  scope="row"><p><code>kATSUDirectDataAdvanceDeltaFixedArray</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1078"></a></p></td><td ><p>The advance delta array.</p></td></tr><tr><td  scope="row"><p><code>kATSUDirectDataBaselineDeltaFixedArray</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1079"></a></p></td><td ><p>The baseline delta array. </p></td></tr><tr><td  scope="row"><p><code>kATSUDirectDataDeviceDeltaSInt16Arrray</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1080"></a></p></td><td ><p>The device delta array. </p></td></tr><tr><td  scope="row"><p><code>kATSUDirectDataStyleIndexUInt16Array</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1081"></a></p></td><td ><p>The style-index array. The values in the array are indices to the style setting reference array.</p></td></tr><tr><td  scope="row"><p><code>kATSUDirectDataStyleSettingATSUStyleSettingRefArray</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1082"></a></p></td><td ><p>The style setting array.</p></td></tr><tr><td  scope="row"><p><code>kATSUDirectDataLayoutRecordATSLayoutRecordVersionCurrent</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1083"></a></p></td><td ><p>The <code>ATSLayoutRecord</code> for a glyph. The layout record contains the glyph ID, real position, and other information.</p></td></tr></table></div><p>To install a callback, you follow the same procedure as you would to set a layout attribute. You must do the following:</p><ol class="ol"><li class="li"><p>Set up a triple (tag, size, value) to specify the operation you want to override and the callback function you are providing to handle the operation.</p><p>In this case, the attribute tag is a structure (<code>ATSULayoutOperationOverrideSpecifier</code>) that specifies a selector for a layout operation and a pointer to a callback function. Typical selectors are listed in <span class="content_text">Table 6-3</span>. See <em>Inside Mac OS X: ATSUI Reference</em> for a complete list.</p></li><li class="li"><p>Call the function <code>ATSUSetLayoutControls</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1084"></a> to associate the triple with the text layout object whose layout operation you want to override.</p></li></ol><a name="//apple_ref/doc/uid/TP30000033-BBCEEFDC" title="Table 6-3Selectors for layout operations"></a><div class="tableholder"><table class="graybox" border = "0" cellspacing="0" cellpadding="5"><caption class="tablecaption"><strong>Table 6-3&nbsp;&nbsp;</strong>Selectors for layout operations</caption><tr><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Selector</p></th><th scope="col" align="left" style="font-weight: bold" bgcolor="#CCCCCC"><p>Specifies </p></th></tr><tr><td  scope="row"><p><code>kATSULayoutOperationNone</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1085"></a></p></td><td ><p>No layout select operation selected.</p></td></tr><tr><td  scope="row"><p><code>kATSULayoutOperationJustification</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1086"></a></p></td><td ><p>Justification.</p></td></tr><tr><td  scope="row"><p><code>kATSULayoutOperationMorph</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1087"></a></p></td><td ><p>Character morphing.</p></td></tr><tr><td  scope="row"><p><code>kATSULayoutOperationKerningAdjustment</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1088"></a></p></td><td ><p>Kerning adjustment.</p></td></tr><tr><td  scope="row"><p><code>kATSULayoutOperationBaselineAdjustment</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1089"></a></p></td><td ><p>Baseline adjustment; layout above or below current baseline.</p></td></tr><tr><td  scope="row"><p><code>kATSULayoutOperationTrackingAdjustment</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1090"></a></p></td><td ><p>Tracking adjustment.</p></td></tr><tr><td  scope="row"><p><code>kATSULayoutOperationPostLayoutAdjustment</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1091"></a></p></td><td ><p>Applies a layout operation after ATSUI has finished its layout operations.</p></td></tr></table></div><p>After you’ve installed the callback, you use ATSUI as you normally would to draw text. ATSUI triggers your callback each time the layout operation you specified is invoked.</p><p>You’ll see specific examples of how to write and install callbacks that manipulate the final layout in the following sections:</p><ul class="ul"><li class="li"><p><span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-TPXREF163">“Extending the Space Between Glyphs.”</a></span> This example shows how to obtain the array of advance delta values for a line of text, and then to modify advance values to extend the space between the glyphs.</p></li><li class="li"><p><span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-TPXREF166">“Positioning Glyphs Along a Curve.”</a></span> This example shows how to retrieve ATS layout records, advance delta arrays, and baseline delta arrays, and then to use real position information to calculate advance and baseline delta values that achieve the desired layout.</p></li></ul><p>Before you override any of ATSUI’s layout operations, you should read the guidelines outlined in the following section.</p><a name="//apple_ref/doc/uid/TP30000033-TPXREF172" title="Guidelines for Overriding Layout Operations"></a><h3>Guidelines for Overriding Layout Operations</h3><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1092"></a><p>Follow these guidelines when you override ATSUI layout operations:</p><ul class="spaceabove"><li class="li"><p>You should modify advance delta values during ATSUI’s layout process and not as a post layout operation. ATSUI uses advance delta values when it calculates the real position. The real position is available only post layout. So adjusting advance delta values post layout won’t have an effect. </p></li><li class="li"><p>You should modify the real position only at post layout. </p></li><li class="li"><p>Ideally, if you modify the real position, you should update the advance delta values to reflect the real-position modifications.</p></li><li class="li"><p>You should modify baseline delta values as a post-layout operation (<code>kATSULayoutOperationPostLayoutAdjustment</code>) or in the baseline operation (<code>kATSULayoutOperationBaselineAdjustment</code>). If you modify these values during any other operation, ATSUI’s baseline operation can overwrite the values you modify.</p></li></ul><a name="//apple_ref/doc/uid/TP30000033-TPXREF163" title="Extending the Space Between Glyphs"></a><h3>Extending the Space Between Glyphs</h3><p>You can extend the space between glyphs by providing values that adjust the positions of the glyph<a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1093"></a>. To do so, you need to</p><ul class="spaceabove"><li class="li"><p>inform ATSUI that you want to override the justification layout operation</p></li><li class="li"><p>obtain the advance delta array for the glyphs associated with the text layout object whose layout you want to modify</p></li><li class="li"><p>adjust advance delta values for each glyph whose layout you want to modify</p></li></ul><p>Depending on the advance delta values you provide, you’ll get an effect similar to the bottom line shown in <span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-BBCDIBJA">Figure 6-1</a></span>. All glyphs except the first glyph in this line are drawn using the same advance delta value to achieve a uniform spacing. The advance delta values do not need to be the same for each glyph. </p><p>The following sections show how to extend the space between glyphs:</p><ul class="spaceabove"><li class="li"><p><span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-TPXREF165">“Writing a Callback to Modify Advance Delta Values”</a></span></p></li><li class="li"><p><span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-TPXREF164">“Installing a Callback for a Justification Override Operation”</a></span></p></li></ul><a name="//apple_ref/doc/uid/TP30000033-TPXREF165" title="Writing a Callback to Modify Advance Delta Values"></a><h4>Writing a Callback to Modify Advance Delta Values</h4><p>The callback<a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1094"></a> shown in <span class="content_text">Listing 6-1</span> (<code><!--a-->MyStretchGlyphCallback<!--/a--></code>) performs one task—it modifies advance delta values. The effect is to extend the space between glyphs. A detailed explanation for each numbered line of code appears following the listing.</p><a name="//apple_ref/doc/uid/TP30000033-BBCCBJEF" title="Listing 6-1A callback that modifies advance delta values"></a><p class="codesample"><strong>Listing 6-1&nbsp;&nbsp;</strong>A callback that modifies advance delta values</p><div class="codesample"><table><tr><td scope="row"><pre>static<span></span></pre></td></tr><tr><td scope="row"><pre>OSStatus MyStretchGlyphCallback (<span></span></pre></td></tr><tr><td scope="row"><pre>                    ATSULayoutOperationSelector     iCurrentOperation,<span></span></pre></td></tr><tr><td scope="row"><pre>                    ATSULineRef     iLineRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                    UInt32          iRefCon,<span></span></pre></td></tr><tr><td scope="row"><pre>                    void            *iOperationExtraParameter,<span></span></pre></td></tr><tr><td scope="row"><pre>                    ATSULayoutOperationCallbackStatus *oCallbackStatus )<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus        status;<span></span></pre></td></tr><tr><td scope="row"><pre>    Fixed           *myDeltaXArray;<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    ItemCount       myRecordArrayCount;<span></span></pre></td></tr><tr><td scope="row"><pre>    ItemCount       myItems;<span></span></pre></td></tr><tr><td scope="row"><pre>    Fixed           myStretchFactor;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status = ATSUDirectGetLayoutDataArrayPtrFromLineRef (iLineRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                            kATSUDirectDataAdvanceDeltaFixedArray,<span></span></pre></td></tr><tr><td scope="row"><pre>                            true,<span></span></pre></td></tr><tr><td scope="row"><pre>                            (void **) &amp;myDeltaXArray,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;myRecordArrayCount);<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    require_noerr (status, StretchGlyphCallback_err);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    myStretchFactor = (Fixed) ((gFontSize*2) &lt;&lt; 16);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    for (myItems = 1; myItems &lt; myRecordArrayCount; myItems++ ) <span>// 5</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        myDeltaXArray[myItems] += myStretchFactor;<span></span></pre></td></tr><tr><td scope="row"><pre>    };<span></span></pre></td></tr><tr><td scope="row"><pre>    status = ATSUDirectReleaseLayoutDataArrayPtr (iLineRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                            kATSUDirectDataAdvanceDeltaFixedArray,<span></span></pre></td></tr><tr><td scope="row"><pre>                            (void **) &amp;myDeltaXArray );<span>// 6</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>StretchGlyphCallback_err:<span></span></pre></td></tr><tr><td scope="row"><pre>    *oCallbackStatus = kATSULayoutOperationCallbackStatusHandled;<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>    return status;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Provides the parameters specified by the callback definition. As you’ll see, this callback uses only two of the parameters: <code>iLineRef</code> and <code>oCallbackStatus</code>. </p></li><li class="li"><p>Declares an array for the advance delta values.</p></li><li class="li"><p>Calls the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUDirectGetLayoutDataArrayPtrFromLineRef" target="_top">ATSUDirectGetLayoutDataArrayPtrFromLineRef</a></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1095"></a> to obtain the advance delta values for the line specified by <code>iLineRef</code>. This function returns the data pointer specified by the <code>iDataSelector</code> parameter (in this case, <code>kATSUDirectDataAdvanceDeltaFixedArray</code>) for the line specified by <code>iLineRef</code>. </p><p>You should pass <code>true</code> for the <code>iCreate</code> parameter. If the requested array isn’t referenced by <code>iLineRef</code>, ATSUI creates and returns a zero-filled array. If the requested array has already been created, ATSUI returns the array with the current advance delta values. On output, <code>myRecordArrayCount</code> specifies the number of items in the array. </p></li><li class="li"><p>Sets a stretch-factor value, based on the current font size, to be used for the advance delta.</p></li><li class="li"><p>Iterates through the advance delta array, assigning a value to each element in the array.</p></li><li class="li"><p>Releases the data pointer (<code>myDeltaXArray</code>) obtained by calling the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUDirectGetLayoutDataArrayPtrFromLineRef" target="_top">ATSUDirectGetLayoutDataArrayPtrFromLineRef</a></code>. You must release this data pointer by calling the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUDirectReleaseLayoutDataArrayPtr" target="_top">ATSUDirectReleaseLayoutDataArrayPtr</a></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1096"></a>. Releasing the array signals ATSUI that you are done with the data and that ATSUI can merge values you set with those set in the font. </p></li><li class="li"><p>Returns the status <code>kATSULayoutOperationCallbackStatusHandled</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1097"></a> to indicate the layout operation is handled successfully. </p></li></ol><a name="//apple_ref/doc/uid/TP30000033-TPXREF164" title="Installing a Callback for a Justification Override Operation"></a><h4>Installing a Callback for a Justification Override Operation</h4><p>The <code><!--a-->MyInstallStretchGlyphCallback<!--/a--></code> function in <span class="content_text">“A function that installs a justification override callback ”</span> sets up ATSUI to call <code>MyStretchGlyphCallback</code> each time a justification operation needs to be performed on the text associated with the specified text layout object. A detailed explanation for each numbered line of code appears following the listing.</p><a name="//apple_ref/doc/uid/TP30000033-SW1" title="Listing 6-2A function that installs a justification override callback "></a><p class="codesample"><a name="//apple_ref/doc/uid/TP30000033-BBCICDCE" title="Listing 6-2A function that installs a justification override callback "></a><strong>Listing 6-2&nbsp;&nbsp;</strong>A function that installs a justification override callback </p><div class="codesample"><table><tr><td scope="row"><pre>OSStatus MyInstallStretchGlyphCallback (ATSUTextLayout myTextLayout)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus                status = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>    ATSULayoutOperationOverrideSpecifier    myOverrideSpec;<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    ATSUAttributeTag        theTag;<span></span></pre></td></tr><tr><td scope="row"><pre>    ByteCount               theSize;<span></span></pre></td></tr><tr><td scope="row"><pre>    ATSUAttributeValuePtr   theValue;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    myOverrideSpec.operationSelector =<span></span></pre></td></tr><tr><td scope="row"><pre>                 kATSULayoutOperationJustification;<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    myOverrideSpec.overrideUPP = MyStretchGlyphCallback;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    theTag = kATSULayoutOperationOverrideTag;<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    theSize = sizeof (ATSULayoutOperationOverrideSpecifier);<span></span></pre></td></tr><tr><td scope="row"><pre>    theValue = &amp;myOverrideSpec;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status = ATSUSetLayoutControls (myTextLayout, 1,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;theTag, &amp;theSize, &amp;theValue);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    require_noerr (status, InstallStrechGlyphCallback_err );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>InstallStrechGlyphCallback_err:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return status;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Declares an override specification<a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1098"></a>. This structure contains a selector for a layout operation and a universal procedure pointer to the callback you supply.</p></li><li class="li"><p>Assigns the justification selector as the operation selector and the <code>MyStretchGlyphCallback</code> callback as the callback to handle justification.</p></li><li class="li"><p>Sets up a triple (tag, size, value) for the layout attribute. In this case, the layout attribute is the override specification.</p></li><li class="li"><p>Calls the function <code>ATSUSetLayoutControls</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1099"></a> to associate the override specification with the text layout object. </p></li></ol><a name="//apple_ref/doc/uid/TP30000033-TPXREF166" title="Positioning Glyphs Along a Curve"></a><h3>Positioning Glyphs Along a Curve</h3><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1100"></a><p>The text in <span class="content_text">Figure 6-4</span> shows glyphs whose baseline delta values are adjusted to track a sine curve. To achieve the smoothest look possible, the baseline delta values are calculated using the real position of the glyphs. In addition, the advance width for each glyph is adjusted. </p><p>To position glyphs along a curve, you need to do the following:</p><ul class="spaceabove"><li class="li"><p>Inform ATSUI that you want to provide a post-layout operation.</p></li><li class="li"><p>Obtain the ATS layout record, advance delta array, and the baseline delta array for the glyphs associated with the text layout object whose layout you want to modify. The ATS layout record contains the real position of the glyph.</p></li><li class="li"><p>Adjust the advance delta and baseline delta values for each glyph such that the values track the specified curve.</p></li></ul><div class="notebox"><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_29" title="Note"></a><p><strong>Note:</strong>&nbsp;When you position text along a curve, you must obtain and lay out the glyphs in small groups. For arbitrary Unicode text, you should consider international issues when you break the glyphs into small groups. For example, breaking a cursive script, such as Arabic, in the middle of a ligature or between two cursively connected glyphs gives the wrong appearance in the drawn output.</p></div><p>The next sections discuss the specific tasks you need to perform to position glyphs along a curve:</p><ul class="spaceabove"><li class="li"><p><span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-TPXREF168">“Writing the Callback to Modify Baseline Delta Values”</a></span></p></li><li class="li"><p><span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-TPXREF167">“Installing a Callback for a Post-Layout Operation”</a></span></p></li></ul><br/><div><a name="//apple_ref/doc/uid/TP30000033-BBCDJJGH" title="Figure 6-4Text positioned along a sine curve"></a><p><strong>Figure 6-4&nbsp;&nbsp;</strong>Text positioned along a sine curve</p><img src = "../art/sinusoid.gif" alt = "Text positioned along a sine curve" width="420" height="64"></div><br/><a name="//apple_ref/doc/uid/TP30000033-TPXREF168" title="Writing the Callback to Modify Baseline Delta Values"></a><h4>Writing the Callback to Modify Baseline Delta Values</h4><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1101"></a><p>The callback (<code><!--a-->MySineCurveGlyphCallback<!--/a--></code>) shown in <span class="content_text">Listing 6-3</span> modifies advance and delta values so that glyphs are positioned along a sine curve. A detailed explanation for each numbered line of code appears following the listing.</p><a name="//apple_ref/doc/uid/TP30000033-BBCCAACC" title="Listing 6-3A callback that positions glyphs along a sine curve"></a><p class="codesample"><strong>Listing 6-3&nbsp;&nbsp;</strong>A callback that positions glyphs along a sine curve</p><div class="codesample"><table><tr><td scope="row"><pre>static<span></span></pre></td></tr><tr><td scope="row"><pre>OSStatus MySineCurveGlyphCallback(<span></span></pre></td></tr><tr><td scope="row"><pre>            ATSULayoutOperationSelector     iCurrentOperation,<span></span></pre></td></tr><tr><td scope="row"><pre>            ATSULineRef             iLineRef,<span></span></pre></td></tr><tr><td scope="row"><pre>            UInt32                  iRefCon,<span></span></pre></td></tr><tr><td scope="row"><pre>            void                    *iOperationExtraParameter,<span></span></pre></td></tr><tr><td scope="row"><pre>            ATSULayoutOperationCallbackStatus   *oCallbackStatus )<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus        status = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>    Fixed           *deltaYArray;<span></span></pre></td></tr><tr><td scope="row"><pre>    Fixed           *deltaXArray;<span></span></pre></td></tr><tr><td scope="row"><pre>    Fixed           positionDifference;<span></span></pre></td></tr><tr><td scope="row"><pre>    ATSLayoutRecord *layoutRecordArray;<span></span></pre></td></tr><tr><td scope="row"><pre>    ItemCount       recordArrayCount;<span></span></pre></td></tr><tr><td scope="row"><pre>    ItemCount       i;<span></span></pre></td></tr><tr><td scope="row"><pre>    Fixed           scaleFactor = 0;<span></span></pre></td></tr><tr><td scope="row"><pre>    float           amplitude;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status = ATSUDirectGetLayoutDataArrayPtrFromLineRef (iLineRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                    kATSUDirectDataLayoutRecordATSLayoutRecordCurrent,<span></span></pre></td></tr><tr><td scope="row"><pre>                    false,<span></span></pre></td></tr><tr><td scope="row"><pre>                    (void **) &amp;layoutRecordArray,<span></span></pre></td></tr><tr><td scope="row"><pre>                    &amp;recordArrayCount );<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    require_noerr (status, GlyphWaveCallback_err);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status = ATSUDirectGetLayoutDataArrayPtrFromLineRef (iLineRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                            kATSUDirectDataAdvanceDeltaFixedArray,<span></span></pre></td></tr><tr><td scope="row"><pre>                            true,<span></span></pre></td></tr><tr><td scope="row"><pre>                            (void **) &amp;deltaXArray,<span></span></pre></td></tr><tr><td scope="row"><pre>                            &amp;recordArrayCount );<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    require_noerr (status, GlyphWaveCallbackDeltaXArray_err);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status = ATSUDirectGetLayoutDataArrayPtrFromLineRef (iLineRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                        kATSUDirectDataBaselineDeltaFixedArray,<span></span></pre></td></tr><tr><td scope="row"><pre>                        true,<span></span></pre></td></tr><tr><td scope="row"><pre>                        (void **) &amp;deltaYArray,<span></span></pre></td></tr><tr><td scope="row"><pre>                        &amp;recordArrayCount );<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    require_noerr (status, SineCurveGlyphCallbackDeltaYArray_err);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    for ( i = 1; i &lt; recordArrayCount; i++ )<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        positionDifference = (layoutRecordArray[i].realPos -<span></span></pre></td></tr><tr><td scope="row"><pre>                            layoutRecordArray[i-1].realPos);<span></span></pre></td></tr><tr><td scope="row"><pre>        if (positionDifference > scaleFactor)<span></span></pre></td></tr><tr><td scope="row"><pre>                    scaleFactor = positionDifference;<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    amplitude = FixedToFloat( scaleFactor );<span>// 5</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    for ( i = 1; i &lt; recordArrayCount - 1; i++ )<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        positionDifference =  scaleFactor - (layoutRecordArray[i].realPos -<span></span></pre></td></tr><tr><td scope="row"><pre>                                layoutRecordArray[i-1].realPos);<span>// 7</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        layoutRecordArray[i].realPos += positionDifference;<span>// 8</span></pre></td></tr><tr><td scope="row"><pre>        deltaXArray[i-1] += positionDifference;<span>// 9</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>        deltaYArray[i] = FloatToFixed (sinf ( i ) * amplitude);<span>// 10</span></pre></td></tr><tr><td scope="row"><pre>    };<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    ATSUDirectReleaseLayoutDataArrayPtr (iLineRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                            kATSUDirectDataBaselineDeltaFixedArray,<span></span></pre></td></tr><tr><td scope="row"><pre>                            (void **) &amp;deltaYArray );<span>// 11</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>SineCurveGlyphCallbackDeltaYArray_err:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    ATSUDirectReleaseLayoutDataArrayPtr (iLineRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                            kATSUDirectDataAdvanceDeltaFixedArray,<span></span></pre></td></tr><tr><td scope="row"><pre>                            (void **) &amp;deltaXArray );<span>// 12</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>SineCurveGlyphCallbackDeltaXArray_err:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    ATSUDirectReleaseLayoutDataArrayPtr (iLineRef,<span></span></pre></td></tr><tr><td scope="row"><pre>                    kATSUDirectDataLayoutRecordATSLayoutRecordCurrent,<span></span></pre></td></tr><tr><td scope="row"><pre>                        (void **) &amp;layoutRecordArray );<span>// 13</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>SineCurveGlyphCallback_err:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    *oCallbackStatus = kATSULayoutOperationCallbackStatusHandled;<span>// 14</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return status;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Calls the function <code>ATSUDirectGetLayoutDataArrayPtrFromLineRef</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1102"></a> with the layout record data selector to obtain the ATS layout records for each glyph on the line. A layout record contains the glyph real position. Calculating a sine curve based on the real positions of the glyphs results in a much smoother appearance.</p></li><li class="li"><p>Calls the function <code>ATSUDirectGetLayoutDataArrayPtrFromLineRef</code> with the advance delta data selector to obtain the advance delta array for the glyphs on the line. </p></li><li class="li"><p>Calls the function <code>ATSUDirectGetLayoutDataArrayPtrFromLineRef</code> with the baseline delta data selector to obtain the baseline delta array for the glyphs on the line. </p></li><li class="li"><p>Iterates through the layout records to find the largest positional difference in the line. This difference will be used to set a scaling factor.</p></li><li class="li"><p>Sets the amplitude for the sine curve calculation to the scale factor.</p></li><li class="li"><p>Iterates through the glyph information to set the advance and baseline delta factors, taking into account the real position of the glyph.</p></li><li class="li"><p>Calculates a positional difference. This will be used to impose a fixed width on each glyph that takes the glyph’s point size into account.</p></li><li class="li"><p>Adds the positional difference to the real position value for the layout record array.</p></li><li class="li"><p>Adds the positional difference to the advance delta value.</p></li><li class="li"><p>Calculates the baseline delta using the previously calculated amplitude value and calling the function <code><!--a-->sinf<!--/a--></code>.</p></li><li class="li"><p>Releases the baseline delta array by calling the function <code>ATSUDirectReleaseLayoutDataArrayPtr</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1103"></a> with the baseline delta data selector.</p></li><li class="li"><p>Releases the advance delta array by calling the function <code>ATSUDirectReleaseLayoutDataArrayPtr</code> with the advance delta data selector.</p></li><li class="li"><p>Releases the layout record array by calling the function <code>ATSUDirectReleaseLayoutDataArrayPtr</code> with the ATS layout record data selector.</p></li><li class="li"><p>Returns a status value to ATSUI to indicate the layout operation is handled successfully.<a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1104"></a></p></li></ol><a name="//apple_ref/doc/uid/TP30000033-TPXREF167" title="Installing a Callback for a Post-Layout Operation"></a><h4>Installing a Callback for a Post-Layout Operation</h4><p>The <code><!--a-->MyInstallSineCuveGlyphCallback<!--/a--></code> function in <span class="content_text">Listing 6-4</span> sets up ATSUI to call <code>MySineCuveGlyphCallback</code>. ATSUI triggers the callback for each line of text associated with the specified text layout object. Because the callback does post-layout processing, ATSUI invokes the callback at the end of its layout operations for the line. A detailed explanation for each numbered line of code appears following the listing.</p><a name="//apple_ref/doc/uid/TP30000033-BBCJIHHJ" title="Listing 6-4Installing a callback for a post-layout override operation"></a><p class="codesample"><strong>Listing 6-4&nbsp;&nbsp;</strong>Installing a callback for a post-layout override operation</p><div class="codesample"><table><tr><td scope="row"><pre>OSStatus MyInstallSineCurveGlyphCallback (ATSUTextLayout textLayout )<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus                                status = noErr;<span></span></pre></td></tr><tr><td scope="row"><pre>    ATSULayoutOperationOverrideSpecifier    myOverrideSpec;<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>    ATSUAttributeTag     theTag;<span></span></pre></td></tr><tr><td scope="row"><pre>    ByteCount            theSize;<span></span></pre></td></tr><tr><td scope="row"><pre>    ATSUAttributeValuePtr thePtr;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    myOverrideSpec.operationSelector =<span></span></pre></td></tr><tr><td scope="row"><pre>                            kATSULayoutOperationPostLayoutAdjustment;<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    myOverrideSpec.overrideUPP = MySineCurveGlyphCallback;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    attrTag = kATSULayoutOperationOverrideTag;<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    attrSize = sizeof (ATSULayoutOperationOverrideSpecifier);<span></span></pre></td></tr><tr><td scope="row"><pre>    attrPtr = &amp;myOverrideSpec;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    status = ATSUSetLayoutControls (textLayout, 1,<span></span></pre></td></tr><tr><td scope="row"><pre>                                &amp;theTag, &amp;theSize, &amp;thePtr );<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    require_noerr (status, InstallSineCureveGlyphCallback_err );<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>InstallSineCureveGlyphCallback_err:<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return status;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Declares an override specification. This structure contains a selector for a layout operation and a universal procedure pointer to the callback you supply.</p></li><li class="li"><p>Assigns the post-layout selector as the operation selector and the <code>MySineCurveGlyphCallback</code> callback as the callback to handle justification.</p></li><li class="li"><p>Sets up a triple (tag, size, value) for the layout attribute. In this case, the layout attribute is the override specification.</p></li><li class="li"><p>Calls the function <code>ATSUSetLayoutControls</code> to associate the override specification with the text layout object.<a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1105"></a><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1106"></a></p></li></ol><a name="//apple_ref/doc/uid/TP30000033-TPXREF136" title="Retrieving and Drawing Glyph Outlines"></a><h2>Retrieving and Drawing Glyph Outlines</h2><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1107"></a><p>ATSUI provides several direct-access functions<a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1108"></a> that retrieve <strong>glyph outlines</strong>—the curves that make up the shape of the glyph. You should obtain glyph outlines only when you want to handle drawing the glyph instead of letting ATSUI do it. You can make modifications to the glyph data before you draw the glyph. </p><p>Using direct-access functions, you can do the following: </p><ul class="ul"><li class="li"><p>Determine the native curve type of a font. TrueType fonts use quadratic curves while Type 1 (PostScript) fonts use cubic curves<a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1109"></a>. </p></li><li class="li"><p>Retrieve a cubic or quadratic glyph path—that is, the segments that make up the shape of a glyph.</p></li></ul><p>Determining the native curve type of a font is easy, just call the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGetNativeCurveType" target="_top">ATSUGetNativeCurveType</a></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1110"></a>. </p><p>Obtaining cubic or quadratic paths for a glyph requires you to use the functions <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGlyphGetCubicPaths" target="_top">ATSUGlyphGetCubicPaths</a></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1111"></a> or <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGlyphGetQuadraticPaths" target="_top">ATSUGlyphGetQuadraticPaths</a></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1112"></a>, respectively. However, you can call the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGlyphGetQuadraticPaths" target="_top">ATSUGlyphGetQuadraticPaths</a></code> for fonts whose native curve type is cubic, and you can call <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGlyphGetCubicPaths" target="_top">ATSUGlyphGetCubicPaths</a></code> for a font whose native curve type is quadratic. In each case, the font’s curves are converted to the format specified by the function. </p><p>The curves returned by the functions are those that have been modified by hints present in the font. If you need unhinted outlines, you should use a very large point size (for example, 1000 points) and scale down the result. Alternatively, you can set the <code>ATSUStyleRenderingOptions</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1113"></a> of the style object (<code>ATSUStyle</code>) to <code>0</code>.</p><p>The coordinates<a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1114"></a> returned for the curves and lines use the QuickDraw coordinate system. The (0,0) coordinate in QuickDraw is located in the upper-left corner. Quartz<a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1115"></a> 2D has its (0,0) coordinate in the lower-left corner. If you are drawing into a Quartz context, you need to transform the QuickDraw coordinates accordingly.</p><p>If you want to handle drawing glyphs that use quadratic curves, you call the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGlyphGetQuadraticPaths" target="_top">ATSUGlyphGetQuadraticPaths</a></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1116"></a>. This function obtains the glyph segments for a glyph and then calls your callback functions for drawing the glyph. You must supply these universal procedure pointers (UPPs) to the function <code><!--a-->ATSUGlyphGetQuadraticPaths][￼]. This function obtains the glyph segments for a glyph and then calls your callback functions for drawing the glyph. You must supply these universal procedure pointers (UPPs) to the function [ATSUGlyphGetQuadraticPaths<!--/a--></code>: </p><ul class="ul"><li class="li"><p><code>ATSQuadraticNewPathUPP</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1117"></a>, a pointer to your callback to handle the new-path operation </p></li><li class="li"><p><code>ATSQuadraticLineUPP</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1118"></a>, a pointer to your callback to handle the line-to operation </p></li><li class="li"><p><code>ATSQuadraticCurveUPP</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1119"></a>, a pointer to your callback to handle the curve-to operation </p></li><li class="li"><p><code>ATSQuadraticClosePathUPP</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1120"></a>, a pointer to your callback to handle the close-path operation</p></li></ul><p>Similarly, if you want to handle drawing glyphs that use cubic curves, you call the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGlyphGetCubicPaths" target="_top">ATSUGlyphGetCubicPaths</a></code>. This function obtains the glyph segments for a glyph and then calls your callback functions for drawing the glyph. You must supply these UPPs to the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGlyphGetCubicPaths" target="_top">ATSUGlyphGetCubicPaths</a></code>: </p><ul class="ul"><li class="li"><p><code>ATSCubicMoveToUPP</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1121"></a>, a pointer to your callback to handle the move-to operation</p></li><li class="li"><p><code>ATSCubicLineToUPP</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1122"></a>, a pointer to your callback to handle the line-to operation</p></li><li class="li"><p><code>ATSCubicCurveToUPP</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1123"></a>, a pointer to your callback to handle the curve-to operation</p></li><li class="li"><p><code>ATSCubicClosePathUPP</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1124"></a>, a pointer to your callback to handle the close-path operation</p></li></ul><p>Note that for cubic paths, the starting position for each curve or line is implicit from the current pen position. The start of a path is also implicit and is signaled by the move to establish the initial pen position. </p><p><span class="content_text">Listing 6-5</span> shows code that sets up the four quadratic curve callbacks that handle glyph drawing for glyphs whose curve type is quadratic. <span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-CJBCEBEB">Listing 6-6</a></span> shows a function (<code><!--a-->MyDrawQuadratics<!--/a--></code>) that creates universal procedure pointers to the callbacks and uses the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGlyphGetQuadraticPaths" target="_top">ATSUGlyphGetQuadraticPaths</a></code>. A detailed explanation for each numbered line of code in a listing appears following each listing. The code for using cubic curve callbacks to handle glyph drawing is similar to that shown in <span class="content_text">Listing 6-5</span> and <span class="content_text">Listing 6-6</span>, except that you would use the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGlyphGetCubicPaths" target="_top">ATSUGlyphGetCubicPaths</a></code> and supply to it your cubic callbacks.</p><a name="//apple_ref/doc/uid/TP30000033-CJBJIEGC" title="Listing 6-5Setting up the quadratic curve callbacks "></a><p class="codesample"><strong>Listing 6-5&nbsp;&nbsp;</strong>Setting up the quadratic curve callbacks </p><div class="codesample"><table><tr><td scope="row"><pre>OSStatus MyQuadraticLineProc (const Float32Point *pt1,<span></span></pre></td></tr><tr><td scope="row"><pre>                        const Float32Point *pt2,<span></span></pre></td></tr><tr><td scope="row"><pre>                        void *callBackDataPtr)<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    float x1 = ((MyCallbackData *)callBackDataPtr)->origin.x + pt1->x;<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    float y1 = ((MyCallbackData *)callBackDataPtr)->origin.y + pt1->y;<span></span></pre></td></tr><tr><td scope="row"><pre>    float x2 = ((MyCallbackData *)callBackDataPtr)->origin.x + pt2->x;<span></span></pre></td></tr><tr><td scope="row"><pre>    float y2 = ((MyCallbackData *)callBackDataPtr)->origin.y + pt2->y;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     y1 = ((MyCallbackData *)callBackDataPtr)->windowHeight - y1;<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>     y2 = ((MyCallbackData *)callBackDataPtr)->windowHeight - y2;<span></span></pre></td></tr><tr><td scope="row"><pre>     if ( ((MyCurveCallbackData *)callBackDataPtr)->first ) <span>// 4</span></pre></td></tr><tr><td scope="row"><pre>     {<span></span></pre></td></tr><tr><td scope="row"><pre>            CGContextMoveToPoint (gContext, x1, y1);<span></span></pre></td></tr><tr><td scope="row"><pre>            ((MyCurveCallbackData *)callBackDataPtr)->first = false;<span></span></pre></td></tr><tr><td scope="row"><pre>     }<span></span></pre></td></tr><tr><td scope="row"><pre>     CGContextAddLineToPoint (context, x2, y2);<span>// 5</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return noErr;<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>OSStatus MyQuadraticCurveProc (const Float32Point *pt1,<span></span></pre></td></tr><tr><td scope="row"><pre>                    const Float32Point *controlPt,<span></span></pre></td></tr><tr><td scope="row"><pre>                    const Float32Point *pt2,<span></span></pre></td></tr><tr><td scope="row"><pre>                    void *callBackDataPtr)<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    float x1 = ((MyCallbackData *)callBackDataPtr)->origin.x + pt1->x;<span>// 8</span></pre></td></tr><tr><td scope="row"><pre>    float y1 = ((MyCallbackData *)callBackDataPtr)->origin.y + pt1->y;<span></span></pre></td></tr><tr><td scope="row"><pre>    float x2 = ((MyCallbackData *)callBackDataPtr)->origin.x + pt2->x;<span></span></pre></td></tr><tr><td scope="row"><pre>    float y2 = ((MyCallbackData *)callBackDataPtr)->origin.y + pt2->y;<span></span></pre></td></tr><tr><td scope="row"><pre>    float cpx = ((MyCallbackData *)callBackDataPtr)->origin.x +<span></span></pre></td></tr><tr><td scope="row"><pre>                                     controlPt->x;<span></span></pre></td></tr><tr><td scope="row"><pre>    float cpy = ((MyCallbackData *)callBackDataPtr)->origin.y +<span></span></pre></td></tr><tr><td scope="row"><pre>                                     controlPt->y;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     y1 = ((MyCallbackData *)callBackDataPtr)->windowHeight - y1;<span>// 9</span></pre></td></tr><tr><td scope="row"><pre>     y2 = ((MyCallbackData *)callBackDataPtr)->windowHeight - y2;<span></span></pre></td></tr><tr><td scope="row"><pre>     cpy = ((MyCallbackData *)callBackDataPtr)->windowHeight - cpy;<span></span></pre></td></tr><tr><td scope="row"><pre>     if ( ((MyCurveCallbackData *)callBackDataPtr)->first ) <span>// 10</span></pre></td></tr><tr><td scope="row"><pre>     {<span></span></pre></td></tr><tr><td scope="row"><pre>            CGContextMoveToPoint(gContext, x1, y1);<span></span></pre></td></tr><tr><td scope="row"><pre>            ((MyCurveCallbackData *)callBackDataPtr)->first = false;<span></span></pre></td></tr><tr><td scope="row"><pre>     }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     CGContextAddQuadCurveToPoint (context, cpx, cpy, x2, y2);<span>// 11</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return noErr;<span>// 12</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>OSStatus MyQuadraticNewPathProc (void * callBackDataPtr)<span>// 13</span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>     ((MyCurveCallbackData *)callBackDataPtr)->first = true;<span>// 14</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return noErr;<span>// 15</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>OSStatus MyQuadraticClosePathProc (void * callBackDataPtr)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>     ((MyCurveCallbackData *)callBackDataPtr)->first = true;<span>// 16</span></pre></td></tr><tr><td scope="row"><pre>    return noErr;<span>// 17</span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Sets up the parameters that are passed to your callback for drawing a line. ATSUI passes two points that define a line and a pointer to any data your callback needs. You pass the pointer to your callback data to ATSUI when you call the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGlyphGetQuadraticPaths" target="_top">ATSUGlyphGetQuadraticPaths</a></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1125"></a>. See <span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-CJBCEBEB">Listing 6-6</a></span>.</p></li><li class="li"><p>Modifies the coordinate values of the points passed in by ATSUI. The four lines of code here add values supplied by the callback data pointer. These values are spacing adjustments that take into account the window height. When you write your callback, you would modify the values appropriately for your application.</p></li><li class="li"><p>Transforms the y-coordinate values from QuickDraw coordinates to Quartz coordinates. If you are using a Quartz context, you must perform this transformation because ATSUI always passes coordinates as QuickDraw coordinates.</p></li><li class="li"><p>Checks to see if this is the first point in the curve. If it is, calls the Quartz 2D function <code><a href="../../../../GraphicsImaging/Reference/CGContext/Reference/reference.html#//apple_ref/doc/c_ref/CGContextMoveToPoint" target="_top">CGContextMoveToPoint</a></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1126"></a> to begin drawing at the specified coordinates.</p></li><li class="li"><p>Calls the Quartz 2D function <code><a href="../../../../GraphicsImaging/Reference/CGContext/Reference/reference.html#//apple_ref/doc/c_ref/CGContextAddLineToPoint" target="_top">CGContextAddLineToPoint</a></code> to draw a straight line segment from the current point to the specified point.</p></li><li class="li"><p>Returns a result code that indicates whether or not your callback executed successfully. If your callback returns any value other than <code>0</code>, the function <code>ATSGlyphGetQuadraticPaths</code> stops parsing the path outline and returns the result <code>kATSOutlineParseAbortedErr</code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1127"></a>.</p></li><li class="li"><p>Sets up the parameters that are passed to your callback for drawing a curve. ATSUI passes the two end points and a control point that define the curve along with a pointer to any data your callback needs. You pass the pointer to your callback data to ATSUI when you call the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGlyphGetQuadraticPaths" target="_top">ATSUGlyphGetQuadraticPaths</a></code>. See <span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-CJBCEBEB">Listing 6-6</a></span>.</p></li><li class="li"><p>Modifies the coordinate values of the end points and control point passed in by ATSUI. The six lines of code here add origin values supplied by the callback data pointer. When you write your callback, you would modify the values of the end points and control point appropriately for your application.</p></li><li class="li"><p>Transforms the y-coordinate values from QuickDraw coordinates<a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1128"></a> to Quartz coordinates. If you are using a Quartz context, you must perform this transformation because ATSUI always passes coordinates as QuickDraw coordinates.</p></li><li class="li"><p>Checks to see if this is the first point in the curve. If it is, calls the Quartz 2D function <code><a href="../../../../GraphicsImaging/Reference/CGContext/Reference/reference.html#//apple_ref/doc/c_ref/CGContextMoveToPoint" target="_top">CGContextMoveToPoint</a></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1129"></a> to begin drawing at the specified location.</p></li><li class="li"><p>Calls the Quartz 2D function <code><a href="../../../../GraphicsImaging/Reference/CGContext/Reference/reference.html#//apple_ref/doc/c_ref/CGContextAddQuadCurveToPoint" target="_top">CGContextAddQuadCurveToPoint</a></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1130"></a> to draw a quadratic Bézier curve from the current point, using the control point and end point you specify.</p></li><li class="li"><p>Returns a result code that indicates whether or not your callback executed successfully. If your callback returns any value other than <code>0</code>, the function <code>ATSGlyphGetQuadraticPaths</code> stops parsing the path outline and returns the result <code>kATSOutlineParseAbortedErr</code>.</p></li><li class="li"><p>Sets up the parameter that is passed to your callback for establishing a new path. ATSUI passes a pointer to any data your callback needs. You pass the pointer to your callback data to ATSUI when you call the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGlyphGetQuadraticPaths" target="_top">ATSUGlyphGetQuadraticPaths</a></code>. See <span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-CJBCEBEB">Listing 6-6</a></span>.</p></li><li class="li"><p>Sets the flag that indicates the beginning of a curve segment to <code>true</code>. This flag is used by the functions <code><!--a-->MyQuadraticlineProc<!--/a--></code> and <code><!--a-->MyQuadraticCurveProc<!--/a--></code>.</p></li><li class="li"><p>Returns a result code that indicates whether or not your callback executed successfully. If your callback returns any value other than <code>0</code>, the function <code>ATSGlyphGetQuadraticPaths</code> stops parsing the path outline and returns the result <code>kATSOutlineParseAbortedErr</code>.</p></li><li class="li"><p>Sets the flag that indicates the beginning of a curve segment to <code>true</code>. This flag is used by the functions <code><!--a-->MyQuadraticlineProc<!--/a--></code> and <code><!--a-->MyQuadraticCurveProc<!--/a--></code>.</p></li><li class="li"><p>Returns a result code that indicates whether or not your callback executed successfully. If your callback returns any value other than <code>0</code>, the function <code>ATSGlyphGetQuadraticPaths</code> stops parsing the path outline and returns the result <code>kATSOutlineParseAbortedErr</code>.</p></li></ol><p>After you have written callbacks to handle drawing operations for a quadratic curve (as shown in <span class="content_text">Listing 6-5</span>), you need to write a function that creates universal procedure pointers (UPPs) for each callback and then pass the UPPs to the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGlyphGetQuadraticPaths" target="_top">ATSUGlyphGetQuadraticPaths</a></code>. <span class="content_text">Listing 6-6</span> shows a function that sets up UPPs, obtains glyph data, and calls the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUGlyphGetQuadraticPaths" target="_top">ATSUGlyphGetQuadraticPaths</a></code> to draw each glyph in a text run. A detailed explanation for each numbered line of code appears following the listing. </p><a name="//apple_ref/doc/uid/TP30000033-CJBCEBEB" title="Listing 6-6A function that draws glyph outlines using quadratic curve data"></a><p class="codesample"><strong>Listing 6-6&nbsp;&nbsp;</strong>A function that draws glyph outlines using quadratic curve data</p><div class="codesample"><table><tr><td scope="row"><pre>void MyDrawQuadratics (ATSUTextLayout iLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                            ATSUStyle iStyle,<span></span></pre></td></tr><tr><td scope="row"><pre>                            UniCharArrayOffset start,<span></span></pre></td></tr><tr><td scope="row"><pre>                            UniCharCount length,<span></span></pre></td></tr><tr><td scope="row"><pre>                            Fixed penX,<span></span></pre></td></tr><tr><td scope="row"><pre>                            Fixed penY,<span></span></pre></td></tr><tr><td scope="row"><pre>                            float windowHeight)<span>// 1</span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    ATSLayoutRecord             *layoutRecords;<span></span></pre></td></tr><tr><td scope="row"><pre>    ItemCount                   numRecords;<span></span></pre></td></tr><tr><td scope="row"><pre>    Fixed                       *deltaYs;<span></span></pre></td></tr><tr><td scope="row"><pre>    ItemCount                   numDeltaYs;<span></span></pre></td></tr><tr><td scope="row"><pre>    ATSQuadraticNewPathUPP      newPathProc;<span></span></pre></td></tr><tr><td scope="row"><pre>    ATSQuadraticLineUPP         lineProc;<span></span></pre></td></tr><tr><td scope="row"><pre>    ATSQuadraticCurveUPP        curveProc;<span></span></pre></td></tr><tr><td scope="row"><pre>    ATSQuadraticClosePathUPP    closePathProc;<span></span></pre></td></tr><tr><td scope="row"><pre>    MyCallbackData              data;<span></span></pre></td></tr><tr><td scope="row"><pre>    OSStatus                    status;<span></span></pre></td></tr><tr><td scope="row"><pre>    int                         i;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    newPathProc = NewATSQuadraticNewPathUPP (MyQuadraticNewPathProc);<span>// 2</span></pre></td></tr><tr><td scope="row"><pre>    lineProc = NewATSQuadraticLineUPP (MyQuadraticLineProc);<span>// 3</span></pre></td></tr><tr><td scope="row"><pre>    curveProc = NewATSQuadraticCurveUPP (MyQuadraticCurveProc);<span>// 4</span></pre></td></tr><tr><td scope="row"><pre>    closePathProc = NewATSQuadraticClosePathUPP (MyQuadraticClosePathProc);<span>// 5</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    ATSUDirectGetLayoutDataArrayPtrFromTextLayout (iLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                    start,<span></span></pre></td></tr><tr><td scope="row"><pre>                    kATSUDirectDataLayoutRecordATSLayoutRecordCurrent,<span></span></pre></td></tr><tr><td scope="row"><pre>                    (void *) &amp;layoutRecords,<span></span></pre></td></tr><tr><td scope="row"><pre>                    &amp;numRecords) ;<span>// 6</span></pre></td></tr><tr><td scope="row"><pre>    ATSUDirectGetLayoutDataArrayPtrFromTextLayout (iLayout,<span></span></pre></td></tr><tr><td scope="row"><pre>                    start,<span></span></pre></td></tr><tr><td scope="row"><pre>                    kATSUDirectDataBaselineDeltaFixedArray,<span></span></pre></td></tr><tr><td scope="row"><pre>                    (void *) &amp;deltaYs,<span></span></pre></td></tr><tr><td scope="row"><pre>                    &amp;numDeltaYs);<span>// 7</span></pre></td></tr><tr><td scope="row"><pre>    CGContextBeginPath (gContext);<span>// 8</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    data.windowHeight = windowHeight;<span>// 9</span></pre></td></tr><tr><td scope="row"><pre>    for (i=0; i &lt; numRecords; i++) <span>// 10</span></pre></td></tr><tr><td scope="row"><pre>    {<span></span></pre></td></tr><tr><td scope="row"><pre>        data.origin.x = Fix2X(penX) +<span></span></pre></td></tr><tr><td scope="row"><pre>                                Fix2X(layoutRecords[i].realPos);<span>// 11</span></pre></td></tr><tr><td scope="row"><pre>        if (deltaYs == NULL) <span>// 12</span></pre></td></tr><tr><td scope="row"><pre>                data.origin.y = Fix2X(penY);<span></span></pre></td></tr><tr><td scope="row"><pre>        else<span></span></pre></td></tr><tr><td scope="row"><pre>                data.origin.y = Fix2X(penY) - Fix2X(deltaYs[i]);<span></span></pre></td></tr><tr><td scope="row"><pre>         data.first = true;<span>// 13</span></pre></td></tr><tr><td scope="row"><pre>        if (layoutRecords[i].glyphID != kATSDeletedGlyphcode)<span>// 14</span></pre></td></tr><tr><td scope="row"><pre>        {<span></span></pre></td></tr><tr><td scope="row"><pre>            ATSUGlyphGetQuadraticPaths (iStyle,<span></span></pre></td></tr><tr><td scope="row"><pre>                        layoutRecords[i].glyphID,<span></span></pre></td></tr><tr><td scope="row"><pre>                        newPathProc,<span></span></pre></td></tr><tr><td scope="row"><pre>                        lineProc,<span></span></pre></td></tr><tr><td scope="row"><pre>                        curveProc,<span></span></pre></td></tr><tr><td scope="row"><pre>                        closPathProc,<span></span></pre></td></tr><tr><td scope="row"><pre>                        &amp;data,<span></span></pre></td></tr><tr><td scope="row"><pre>                        &amp;status);<span></span></pre></td></tr><tr><td scope="row"><pre>        }<span></span></pre></td></tr><tr><td scope="row"><pre>    }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    CGContextClosePath(gContext);<span>// 15</span></pre></td></tr><tr><td scope="row"><pre>    CGContextDrawPath(gContext, kCGPathStroke);<span>// 16</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (deltaYs != NULL) <span>// 17</span></pre></td></tr><tr><td scope="row"><pre>        ATSUDirectReleaseLayoutDataArrayPtr (NULL,<span></span></pre></td></tr><tr><td scope="row"><pre>                     kATSUDirectDataBaselineDeltaFixedArray,<span></span></pre></td></tr><tr><td scope="row"><pre>                     (void *) &amp;deltaYs);<span></span></pre></td></tr><tr><td scope="row"><pre>    ATSUDirectReleaseLayoutDataArrayPtr (NULL,<span></span></pre></td></tr><tr><td scope="row"><pre>                 kATSUDirectDataLayoutRecordATSLayoutRecordCurrent,<span></span></pre></td></tr><tr><td scope="row"><pre>                 (void *) &amp;layoutRecords);<span>// 18</span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    DisposeATSQuadraticNewPathUPP (newPathProc);<span>// 19</span></pre></td></tr><tr><td scope="row"><pre>    DisposeATSQuadraticLineUPP (lineProc);<span></span></pre></td></tr><tr><td scope="row"><pre>    DisposeATSQuadraticCurveUPP (curveProc);<span></span></pre></td></tr><tr><td scope="row"><pre>    DisposeATSQuadraticClosePathUPP (closePathProc);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>Here’s what the code does:</p><ol class="ol"><li class="li"><p>Sets up the parameters needed by this function:</p><ul class="ul"><li class="li"><p>a valid text layout</p></li><li class="li"><p>the style object associated with the text layout</p></li><li class="li"><p>the starting offset for the text run that will be processed by this function</p></li><li class="li"><p>the length of the text run that will be processed by this function</p></li><li class="li"><p> the x-coordinate for the pen’s starting location</p></li><li class="li"><p>the y-coordinate for the pen’s starting location</p></li><li class="li"><p>the height of the window into which the text will be drawn</p></li></ul></li><li class="li"><p>Calls the function <code><!--a-->NewATSQuadracticNewPathUPP<!--/a--></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1131"></a> to create a UPP for the <code><!--a-->MyQuadraticNewPathProc<!--/a--></code> callback created in <span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-CJBJIEGC">Listing 6-5</a></span>.</p></li><li class="li"><p>Calls the function <code><!--a-->NewATSQuadracticLineUPP<!--/a--></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1132"></a> to create a UPP for the <code><!--a-->MyQuadraticLineProc<!--/a--></code> callback created in <span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-CJBJIEGC">Listing 6-5</a></span>.</p></li><li class="li"><p>Calls the function <code><!--a-->NewATSQuadracticCurveUPP<!--/a--></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1133"></a>to create a UPP for the <code><!--a-->MyQuadraticCurveProc<!--/a--></code> callback created in <span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-CJBJIEGC">Listing 6-5</a></span>.</p></li><li class="li"><p>Calls the function <code><!--a-->NewATSQuadracticClosePathUPP<!--/a--></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1134"></a> to create a UPP for the <code><!--a-->MyQuadraticClosePathProc<!--/a--></code> callback created in <span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-CJBJIEGC">Listing 6-5</a></span>.</p></li><li class="li"><p>Calls the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUDirectGetLayoutDataArrayPtrFromTextLayout" target="_top">ATSUDirectGetLayoutDataArrayPtrFromTextLayout</a></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1135"></a> to obtain the glyph IDs and the real position for the glyphs associated with the text layout.</p></li><li class="li"><p>Calls the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUDirectGetLayoutDataArrayPtrFromTextLayout" target="_top">ATSUDirectGetLayoutDataArrayPtrFromTextLayout</a></code> to obtain the baseline delta values (if any) for the glyphs associated with the text layout.</p></li><li class="li"><p>Calls the Quartz 2D function <code><a href="../../../../GraphicsImaging/Reference/CGContext/Reference/reference.html#//apple_ref/doc/c_ref/CGContextBeginPath" target="_top">CGContextBeginPath</a></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1136"></a> to begin a path for the glyph outlines. A Quartz graphics context can have only a single path in use at any time. If the context already contains a path when you call <code><a href="../../../../GraphicsImaging/Reference/CGContext/Reference/reference.html#//apple_ref/doc/c_ref/CGContextBeginPath" target="_top">CGContextBeginPath</a></code>, Quartz replaces the previous current path with the new path, discarding the old path and any data associated with it.</p></li><li class="li"><p>Assigns the window height to the data structure that will be passed to the callbacks. This is used to transform the y-coordinate from QuickDraw coordinate space to Quartz coordinate space.</p></li><li class="li"><p>Begins a loop over all the glyphs in the text run.</p></li><li class="li"><p>Assigns an adjusted x-coordinate to the data structure that will be passed to the callbacks. The x-coordinate is the position for the beginning of the line added to the real position.</p></li><li class="li"><p>Checks to see if the baseline delta array is <code>NULL</code>. If the array is <code>NULL</code>, the y-coordinate is the vertical position of the line; otherwise, the y-coordinate is the vertical position of the line added to the baseline delta value.</p></li><li class="li"><p>Sets the flag that indicates the start of a curve segment to <code>true</code>. This flag is used by the callback functions <code><!--a-->MyQuadraticlineProc<!--/a--></code> and <code><!--a-->MyQuadraticCurveProc<!--/a--></code>. See <span class="content_text"><a href="atsui_direct_tasks.html#//apple_ref/doc/uid/TP30000033-CJBJIEGC">Listing 6-5</a></span>. </p></li><li class="li"><p>Checks whether the glyph ID is not that of a deleted glyph. Deleted glyphs should not be drawn. If the glyph should be drawn, calls the function <code><!--a-->ATSUGlyphGetQuadracticPaths<!--/a--></code> to draw the glyphs using the callback functions specified by the UPPs passed to <code><!--a-->ATSUGlyphGetQuadracticPaths<!--/a--></code>. This function also takes as parameters the style object associated with the text run, the glyph ID, a pointer to the data structure that will be passed to the callbacks, and a pointer to a status value. The status value is used to indicate the status of your callback functions. When a callback function returns any value other than <code>0</code>, the <code><!--a-->ATSGlyphsGetQuadraticPaths<!--/a--></code> function stops parsing the path outline and returns the result <code>kATSOutlineParseAbortedErr</code>.</p></li><li class="li"><p>Calls the Quartz 2D function <code><a href="../../../../GraphicsImaging/Reference/CGContext/Reference/reference.html#//apple_ref/doc/c_ref/CGContextClosePath" target="_top">CGContextClosePath</a></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1137"></a> to close and terminate the current path.</p></li><li class="li"><p>Calls the Quartz 2D function <code><a href="../../../../GraphicsImaging/Reference/CGContext/Reference/reference.html#//apple_ref/doc/c_ref/CGContextDrawPath" target="_top">CGContextDrawPath</a></code> to paint a line along the current path.</p></li><li class="li"><p>Checks to see if the baseline delta array is <code>NULL</code>. If it is not, calls the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUDirectReleaseLayoutDataArrayPtr" target="_top">ATSUDirectReleaseLayoutDataArrayPtr</a></code> to release the baseline delta array.</p></li><li class="li"><p>Calls the function <code><a href="../../../Reference/ATSUI_Reference/Reference/reference.html#//apple_ref/doc/c_ref/ATSUDirectReleaseLayoutDataArrayPtr" target="_top">ATSUDirectReleaseLayoutDataArrayPtr</a></code><a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1138"></a> to release the layout record array.</p></li><li class="li"><p>Calls the appropriate ATSUI functions to dispose of the four UPPs created previously.<a name="//apple_ref/doc/uid/TP30000033-DontLinkElementID_1139"></a></p></li></ol>

        <br /><br /> 
        
        <div class="mini_nav_text" align="left">
        <span class="navButtons">
        <a href="../atsui_chap6/atsui_adv_tasks.html">&lt; Previous Page</a><span style="margin-left: 8px"><a href="../atsui_app_unicode/atsui_appendixA.html">Next Page &gt;</a></span>
        </span>
        <span id="showHideTOCLowerSpan">
        <a href="#" onclick="showHideTOC();"><img src="../../../../Resources/Images/show_toc_icon.gif" width="15" height="14" border="0" style="margin-bottom: -2px;" alt="" /></a> <a href="#" onclick="showHideTOC();">Hide TOC</a>
        </span>
        </div>

        <br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> <!--#if expr="0=1" -->&#x00a9; 2002, 2007 Apple Inc. All Rights Reserved. &#40;<!--#endif -->Last updated: 2007-07-10<!--#if expr="0=1" -->&#041;<!--#endif --></p></div>

        
        <div class="hideOnPrint hideInXcode">
        <!-- start of footer -->
        	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Carbon/Conceptual/ATSUI_Concepts/atsui_chap7/atsui_direct_tasks.html%3Fid%3DTP30000984-2.6&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Carbon/Conceptual/ATSUI_Concepts/atsui_chap7/atsui_direct_tasks.html%3Fid%3DTP30000984-2.6&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Carbon/Conceptual/ATSUI_Concepts/atsui_chap7/atsui_direct_tasks.html%3Fid%3DTP30000984-2.6&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

        <!--#include virtual="/includes/framesetfooter" -->
        <!-- end of footer -->
        </div>
    </div>
</body>
</html>