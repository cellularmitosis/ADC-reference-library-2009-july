<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TN1040: Write Cache Flushing: Techniques for Properly Handling System Shutdown</title>    <meta name="keywords" content="Mac OS 8 flushing write cache disk shutdown SCSI ATA ">    <meta name="Description" content="Technical Note TN1040: This Technical Note addresses waysto flush the disk's write cache during the shutdown process.Included is a discussion of the Shutdown Procedures for SCSIand ATA devices.">                                       <meta name="categories" content="Hardware"><meta name="week-posted" content="Apr 1, 1996 - Apr 5, 1996"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002882" title="Write Cache Flushing: Techniques for Properly Handling System Shutdown"></a><A NAME="top"></A> <!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxMacOS9Earlier-date.html">Mac OS 9 & Earlier</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/index.html" target="_blank">Reference Library</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1040</div>
<div id="pageheadsub">Write Cache Flushing: Techniques for Properly Handling System Shutdown</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"> <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr><td width=300 valign="top" align=left scope="row">    <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td></tr><tr bgcolor="#e6e6e6">    <td background="images/tnmenubody.gif" width=300 align=left><span id="menutitle">    CONTENTS     <BR>    <BR></span>    </td></tr><tr bgcolor="#e6e6e6">    <td background="images/tnmenubody.gif" width=300 align=left><!-- begin_toc --><P id = "menutext"><A HREF = "#RTFToC1">Write Caching</a><br><br><A HREF = "#RTFToC2">The Good, the Bad and the Ugly</a><br><br><A HREF = "#RTFToC3">Installing the Shutdown Procedure</a><br><br><A HREF = "#RTFToC4">Shutdown Procedure for SCSI Devices</a><br><br><A HREF = "#RTFToC5">Shutdown Procedure for ATA Devices</a><br><br><A HREF = "#RTFToC6">Summary</a><br><br><A HREF = "#References">References</a><br><br><A HREF="#Downloads">Downloadables</A></P>   <!-- end_toc -->  </td></tr><tr>    <td width=300 align=left scope="row"><img src="images/tnmenubottom.gif" alt="" width=300 height=16>    </td></tr>    </table></td><td width=300 valign="top" align=left><!-- begin_intro_text -->  <P id = "introtext">Many high-performance disk drives available for Macintosh computers utilize anon-board hardware write cache mechanism. Although these devices can enhancedisk performance, they also require special software consideration to avoid theloss of data on shutdown.</p><P id = "introtext">This Technote is directed primarily to third-party IDE and SCSI disk interfacemodule software developers, and addresses ways to flush the disk's write cacheduring the shutdown process.</p><!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Mar 1 1996]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR> <!-- begin_content --><a name="RTFToC1"></a><h2>Write Caching</h2><P>Many disk drive manufacturers now include a write cache on the drive hardware.This cache is usually an area of temporary volatile storage (RAM) that has afaster access time than the actual drive media. Its purpose is to increasethroughput.</p><P>These devices use an algorithm to write back the cache. When the write backcache mode is enabled, the disk controller uses the cache to temporarily storedata that is promised to be written to the medium at a later time. This allowsthe disk controller to indicate to the computer that a write command hascompleted prior to the blocks of data actually being transferred to the medium.The process of transferring the cached data to the drive medium is known as<b>cache-synchronization</b>.</p><P>Because cache hardware uses volatile RAM, there is a period of time prior tocache-synchronization when the data is vulnerable to being lost if a powerfailure occurs before the media is updated.</p><P>Most drives will flush the cache periodically if there is no activity. However,some drives are unpredictable because if you don't explicitly synchronize theircache, they won't do it. This may pose a problem especially at system shutdown.Either the amount of time they wait after idle before synchronizing issufficiently long enough that the power is shut off, or the Macintosh resetsthe bus before the data gets written. Delaying shutdown is not a reliable wayto flush write cache because of varying vendor implementations.</p><P>Macintosh systems that use disk driver software which improperly handleswrite-caching run the risk of data loss or even corruption of the disks' filestructure on shutdown.</p><P><A HREF="#top">Back to top</A></P><a name="RTFToC2"></a><h2>The Good, the Bad and the Ugly</h2><P>Caching is such a popular technique that any particular Mac OS configurationcould be used in any number of layers. For instance, the Macintosh File Systemmaintains a cache. Even the disk interface card (e.g., PCI or NuBus) might alsohave a cache. These can coexist seamlessly, provided that during the shutdownprocess they are synchronized in a certain order: <i>from the inside out.</i>This is required to ensure data stored actually gets to the media.Yet in thecurrent OS, the driver writer has only limited control of this process. Let'sexamine some of the available options.</p><h3>Doing nothing - Bad </h3><P>In the past, Apple shipped systems with drives which either did not supportwrite caching or had the cache disabled. However, this is no longernecessarily true. If your driver still ignores the shutdown synchronization,you will suffer volume corruption.</p><h3>Disabling the cache - Ugly</h3><P>Some disk driver vendors simply attempted to prevent this circumstance byexplicitly requesting the drive to select a write-through caching algorithm --in effect, disabling the cache. This method is ugly, since it fails to takefull advantage of the drive performance available.</p><h3>Tail Patching of _UnmountVol - Uglier</h3><P>Let's assume we enable the cache. The next question is, how do we ensure thatour sync code runs after the file system is done with the volume? That's easy,you say, tail patch the _UnmountVol trap and flush the drive after the filesystem is done with it. In a perfect world, this idea might work.Unfortunately, some developers (including those at Apple) who depend onmodifying the behavior of the File Manager had the same idea. Things can getpretty ugly, because there is no guarantee that your cache-synch code will runlast.</p><h3>Shutdown Task - Close, But No Cigar</h3><P>The Macintosh Process Manager actually has a mechanism that allows code to runbefore shutdown or reset occurs. By invoking a call to ShutDwnInstall, yourdriver code can install an entry in the Shutdown Manager's power down queue.The Mac OS will then call your ShutDownProc during the power down process.</p><P>I'd like to say it was that simple, but after further examination of the code,I discovered that the File Manager also uses this method. So even though youare guaranteed to run, you can't be certain if it will be before or after thevolumes unmount.</p><P>Actually, the solution is close at hand. I mentioned earlier that disabling thecache was one option. But instead of doing it all the time, we just disablecaching at shutdown only and then force a synchronization. Even if anytransfers happen after our ShutDownProc runs, they won't get caught waitingaround in the write cache.</p><P><A HREF="#top">Back to top</A></P><a name="RTFToC3"></a><h2>Installing the Shutdown Procedure </h2><P>To setup your shutdown proc when your driver is opened, instruct the ShutdownManager to install a task in the sdRestartOrPower queue.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    ShutDwnInstall(YourShutDownProc, sdRestartOrPower);</pre>	</TD></TR></TABLE></CENTER><P>Be sure to load your shutdown procedure into the system heap because theProcess Manager frees all applications and other temporary heaps before callingthe Shutdown Manager.</p><P><A HREF="#top">Back to top</A></P><a name="RTFToC4"></a><h2>Shutdown Procedure for SCSI Devices</h2><h3>Disabling the drive cache</h3><P>The first thing you must do is disable the write cache by resetting the writecache enable (WCE) bit of the caching page, as shown in Table 1.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>+=====-========-========-========-========-========-========-========-========+|  Bit|   7    |   6    |   5    |   4    |   3    |   2    |   1    |   0    ||Byte |        |        |        |        |        |        |        |        ||=====+========+========+=====================================================|| 0   |   PS   |Reserved|        Page code (08h)                              ||-----+-----------------------------------------------------------------------|| 1   |                          Page length (0Ah)                            ||-----+-----------------------------------------------------------------------|| 2   |                          Reserved          |  WCE   |   MF   |  RCD   ||-----+-----------------------------------------------------------------------|| 3   |   Demand read retention priority  |     Write retention priority      ||-----+-----------------------------------------------------------------------|| 4   | (MSB)                                                                 ||-----+---                       Disable pre-fetch transfer length         ---|| 5   |                                                                 (LSB) ||-----+-----------------------------------------------------------------------|| 6   | (MSB)                                                                 ||-----+---                       Minimum pre-fetch                         ---|| 7   |                                                                 (LSB) ||-----+-----------------------------------------------------------------------|| 8   | (MSB)                                                                 ||-----+---                       Maximum pre-fetch                         ---|| 9   |                                                                 (LSB) ||-----+-----------------------------------------------------------------------|| 10  | (MSB)                                                                 ||-----+---                       Maximum pre-fetch ceiling                 ---|| 11  |                                                                 (LSB) |+=============================================================================+</pre>	</TD></TR><TR><td align="left"><P><b>Table 1</b>. Caching page</p></td></tr></TABLE></CENTER><P>You need to use the MODE SELECT command with (SP=0) to ensure that this changedoes not get written into the disk's non-volatile RAM. You just want the cachedisabled for now, as shown in Table 2.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>MODE SELECT(10) command+=====-========-========-========-========-========-========-========-========+|  Bit|   7    |   6    |   5    |   4    |   3    |   2    |   1    |   0    ||Byte |        |        |        |        |        |        |        |        ||=====+=======================================================================|| 0   |                           Operation code (55h)                        ||-----+-----------------------------------------------------------------------|| 1   | Logical unit number      |  PF    |      Reserved    |     SP         ||-----+-----------------------------------------------------------------------|| 2   |                           Reserved                                    ||-----+-----------------------------------------------------------------------|| 3   |                           Reserved                                    ||-----+-----------------------------------------------------------------------|| 4   |                           Reserved                                    ||-----+-----------------------------------------------------------------------|| 5   |                           Reserved                                    ||-----+-----------------------------------------------------------------------|| 6   |                           Reserved                                    ||-----+-----------------------------------------------------------------------|| 7   | (MSB)                                                                 ||-----+---                        Parameter list length                    ---|| 8   |                                                                 (LSB) ||-----+-----------------------------------------------------------------------|| 9   |                           Control                                     |+=============================================================================+</pre>	</TD></TR><TR><td align="left"><p><b>Table 2</b>. Mode select command</p></td></tr></TABLE></CENTER><h3>Synchronizing the write cache</h3><P>You have to force the disk to flush its write cache. Some drivers attempt totake shortcuts here by inserting a delay of a few hundred microseconds,assuming that the drives will flush automatically. Empirical evidence, however,indicates this is not always true. Some drives don't flush unless explicitlytold to do so. You can blame this on a loose interpretation of the SCSI spec.</p><P>To be safe, send a SynchronizeCache (0x35, 10 byte CDB) command with <b>allfields 0,</b> to the drive. This guarantees all of the cache will be consistentwith the media. The <b>Immed</b> bit must be clear to ensure the command willwait for completion, as shown in Table 3.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>+=====-========-========-========-========-========-========-========-========+|  Bit|   7    |   6    |   5    |   4    |   3    |   2    |   1    |   0    ||Byte |        |        |        |        |        |        |        |        ||=====+=======================================================================|| 0   |                           Operation code (35h)                        ||-----+-----------------------------------------------------------------------|| 1   | Logical unit number       |         Reserved        |  Immed | RelAdr ||-----+-----------------------------------------------------------------------|| 2   | (MSB)                                                                 ||-----+---                                                                 ---|| 3   |                                                                       ||-----+---                        Logical block address                    ---|| 4   |                                                                       ||-----+---                                                                 ---|| 5   |                                                                 (LSB) ||-----+-----------------------------------------------------------------------|| 6   |                           Reserved                                    ||-----+-----------------------------------------------------------------------|| 7   | (MSB)                                                                 ||-----+---                        Number of blocks                         ---|| 8   |                                                                 (LSB) ||-----+-----------------------------------------------------------------------|| 9   |                           Control                                     |+=============================================================================+</pre>	</TD></TR><TR><td align="left"><p><b>Table 3</b>. Synchronize cache command</p></td></tr></TABLE></CENTER><P>Because the SynchronizeCache is described in the SCSI specification asan optional command, it's possible but unlikely that a drive could supportwrite caching, but not support the SynchronizeCache command. Developers oughtto be aware of this.</p><h3>Ensuring That All Further Writes Go Directly to the Media</h3><p>In some drives, disabling the write cache is not preferred. An alternative todoing this is to execute the synchronize cache command and from that point ononly issue WRITE commands with the force unit access (FUA) bit set. Thisensures that all further writes go directly to the media, as shown in Table 4.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>+=====-========-========-========-========-========-========-========-========+|  Bit|   7    |   6    |   5    |   4    |   3    |   2    |   1    |   0    ||Byte |        |        |        |        |        |        |        |        ||=====+=======================================================================|| 0   |                           Operation code (2Ah)                        ||-----+-----------------------------------------------------------------------|| 1   | Logical unit number      |   DPO  | FUA  |Reserved|Reserved| RelAdr   ||-----+-----------------------------------------------------------------------|| 2   | (MSB)                                                                 ||-----+---                                                                 ---|| 3   |                                                                       ||-----+---                        Logical block address                    ---|| 4   |                                                                       ||-----+---                                                                 ---|| 5   |                                                                 (LSB) ||-----+-----------------------------------------------------------------------|| 6   |                           Reserved                                    ||-----+-----------------------------------------------------------------------|| 7   | (MSB)                                                                 ||-----+---                        Transfer length                             || 8   |                                                                 (LSB) ||-----+-----------------------------------------------------------------------|| 9   |                           Control                                     |+=============================================================================+</pre>	</TD></TR><TR><td align="left"><P><b>Table 4 </b>Write Command</p></td></tr></TABLE></CENTER><P>The driver must check if the disk supports this feature. You can do this byexecuting a MODE SENSE command to get the device-specific parameters andexamining if the DPOFUA bit is set, as shown in Table 5.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>+=====-========-========-========-========-========-========-========-========+|  Bit|   7    |   6    |   5    |   4    |   3    |   2    |   1    |   0    ||=====+========+=================+========+===================================||     |   WP   |     Reserved    |DPOFUA  |             Reserved              |+=============================================================================+</pre>	</TD></TR><TR><td align="left"><P><b>Table 5</b>. Device specific parameter</p></td></tr></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="RTFToC5"></a><h2>Shutdown Procedure for ATA Devices</h2><P>Due to loose interpretations and vendor uniqueness in the ATA Standard, thereis no defined way that a driver can be assured that the disk's cache has beenflushed. And the trigger to force a flush appears to vary by vendor. Eventhough the Set Features command can be used to disable the write cache, somedrives don't flush it until they receive another command.</p><P>One way of handling this is to issue a Standby or Sleep command to the drivewhen you want to flush the cache. This works because the drive must flush thecache before spinning down. These commands may complete before the drivecompletely spins down, but they do not complete before the cache is flushed.</p><P>Unfortunately, at the time of this writing, ATA cache synchronization is stillan unresolved issue with the X3T13 Standards Committee.</p><P><A HREF="#top">Back to top</A></P><a name="RTFToC6"></a><h2>Summary</h2><P>Because it is part of the ANSI specification, Macintosh disk driver writersmust support write caches and must assume that drives are shipped bymanufacturers with write cache enabled.</p><P>Write caches may enhance system performance, but it is important to properlyhandle system shutdown to prevent any loss of data.</p><P>Not all drive vendors implement commands the same way. <i>Therefore, it is theresponsibility of the driver writer to understand the specific workings andimplementations of the commands unique to a vendor's disk drive.</i></p><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><p><i>Inside Macintosh: Devices, </i>chapter on "SCSI Manager 4.3" </p><p><i>Inside Macintosh: Processes, </i>chapter on "Shutdown Manager"</p><p>SCSI Spec: ANSI XT3T9.2/375R revision 10L,at ftp: //abekas.com: 8080/scsi2/</p><p>ATA-3 Spec: ANSI X3T10/ 2008D Revision 6,at</p><P>ftp://fission.dt.wdc.com/pub/standards/ata/ata-3</p><P><A HREF="#top">Back to top</A></P>          <A NAME=Downloads></A>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (64K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tn1040.pdf">Download</A></P>               </TD>            </TR>         </TABLE>         <BR><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1040.html%3Fid%3DDTS10002882-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1040.html%3Fid%3DDTS10002882-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1040.html%3Fid%3DDTS10002882-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>