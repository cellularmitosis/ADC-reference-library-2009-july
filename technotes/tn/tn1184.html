<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-05-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css">   <title>Technical Note TN1184: FCBs, Now and Forever</title>       <meta name="keywords" content="QuickTime, 4.0.3, NativePathNameToFSSpec">    <meta name="Description" content="Technical Note TN1184: Mac OS 9.0 changes the format of theFile Control Block (FCB) table significantly. This technoteexplains the original format of the FCB table, how the useof the FCB table has evolved over time, and how you can accessFCB information in a compatible way."><meta name="categories" content="Files"><meta name="week-posted" content="Sep 27, 1999 - Oct 1, 1999"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10003023" title="FCBs, Now and Forever"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxCarbon-date.html">Carbon</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/Carbon/idxFileManagement-date.html" target="_blank">Carbon > File Management</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1184</div>
<div id="pageheadsub">FCBs, Now and Forever</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left">   <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">     <tr><td width=300 valign="top" align=left scope="row">    <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr><td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>  </tr>  <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left> <span id="menutitle">CONTENTS   <br>  <br> </span>   </td>  </tr>  <tr bgcolor="#e6e6e6">   <td background="images/tnmenubody.gif" width=300 align=left> <!-- begin_toc -->   <P id ="menutext"><A HREF = "#Introduction">Introduction</A><BR>                  <BR>                  <A HREF = "#BeforeTheBeginning">Before the Beginning</A><BR>                  <BR>                  <A HREF = "#InTheBeginning">In the Beginning</A><BR>                  <BR>                  <A HREF = "#System70">System 7.0</A><BR>                  <BR>                  <A HREF = "#System75">System 7.5</A><BR>                  <BR>                  <A HREF = "#MacOS81">Mac OS 8.1</A><BR>                  <BR>                  <A HREF = "#MacOS90">Mac OS 9.0</A><BR>                  <BR>                 <A HREF = "#Summary">Summary</A><BR><BR><A HREF = "#References">References</A><BR><BR><A HREF = "#Downloads">Downloadables</A></p> <!-- end_toc --></td>  </tr>  <tr>   <td width=300 align=left scope="row"> <img src="images/tnmenubottom.gif" alt="" width=300 height=16>   </td>  </tr>    </table></td>  <td width=300 valign="top" align=left><!-- begin_intro_text --><P id = "introtext">Mac OS 9.0 changes         the format of the File Control Block (FCB) table         significantly. This technote explains the original format of         the FCB table, how the use of the FCB table has evolved over         time, and how you can access FCB information in a compatible         way.</P>                  <P id = "introtext">All Mac OS developers should read the         <A HREF = "#ConcreteAdvice">Concrete Advice</A> section to         ensure that their software is compatible with Mac OS 9.0 and         beyond.</P>                  <P id = "introtext">If your software is not compatible with Mac OS 9.0         (specifically, it causes a system error <CODE>119</CODE>), you should read the <A HREF = "#DebuggingFCBProblems">Debugging FCB         Problems</A> section.</P>                  <P id = "introtext">The other sections of the technote are background         material for the Mac OS archaeologists out there.</p>      <!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Oct 5 1999]</h3><!-- end_date --></TD> </TR>    </TABLE> <!-- end_header_box --><BR><BR><hr width=500 align=center><BR><BR><!-- begin_content -->         <P><A NAME="Introduction"></A></P>                  <H2>Introduction</H2>                  <P>Prior to Mac OS 9.0, the Macintosh was limited to 348         simultaneously open files (FCBs). This limit proved to be a         problem for both users and developers, so one of the design         goals of Mac OS 9.0 was to increase this limit significantly.         Everything has its price, however, and the price of         increasing the number of FCBs is compatibility. Mac OS has         used the same FCB table format since the introduction of HFS         (1986) and a number of developers have (erroneously) grown         dependent on this format.</P>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>                                    The term "fork control block" is technically more                  accurate than the historical "file control                  block." To avoid confusion, this technote uses the                  abbreviation "FCB" everywhere.</p></TD></TR></TABLE></CENTER><BR><BR>                                <P>This technote describes the changes to the FCB table         format over time, and the consequences of these changes to         developers. The full story is quite involved, and so the         technote starts with some concrete advice for those folks         with more legacy code than time.</P>                  <H3><A NAME="ConcreteAdvice"></A>Concrete Advice</H3>                  <P>Mac OS 9.0 is not the ultimate evolution of the FCB         table. Apple expects to make further changes as the system         evolves. You should look at your code now to strive for         compatibility in the future.</P>                  <P>One specific thing to check is your use of file reference         numbers. File reference numbers are defined to be positive         <CODE>SInt16</CODE>'s. <STRONG>There are no special file         reference numbers.</STRONG> The number 2 is not guaranteed         to be the file reference number of System file. The equality         (<CODE>refNum mod</CODE> 4) = 2 (or (<CODE>refNum mod</CODE> 94) = 2, pre-Mac OS 9.0)         is not guaranteed either.</P>                 <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>                                    The number 0 (zero) is suitable as both a nil file                  reference number and a nil device reference number.</p></TD></TR></TABLE></CENTER><BR><BR>                  <P>For application-level software (applications, shared         libraries, and so on), <STRONG>the best road to future         compatibility is Carbon</STRONG>. The Carbon programming         interfaces are specifically designed to be supportable on         future systems. If you are programming for Carbon, you         should be isolated from future, low-level File Manager         changes.</P>                  <P>Specifically, <STRONG>if you want to access FCB         information from application-level code, you should use the         File Manager routine <CODE>FSGetForkCBInfo</CODE></STRONG>         (or its parameter block variants         <CODE>PBGetForkCBInfoSync</CODE> and         <CODE>PBGetForkCBInfoAsync</CODE>, or         <CODE>PBGetFCBInfoSync</CODE> and         <CODE>PBGetFCBInfoAsync</CODE> on pre-Mac OS 9.0 systems).         </P>                  <P>There are, however, circumstances in which it is not         possible to call the File Manager to get FCB information.         For example, if you are writing a File System Manager (FSM)         plug-in, or you are writing a system extension and your code         is executing within the context of a File Manager patch. In         these circumstances, you may need to access the FCB         immediately (that is, without queuing a File Manager         request).</P>                  <P><STRONG>If you need to access an FCB immediately and         <A HREF = "#HasFCBAccessors">FSM is available</A>, you should         use the FSM accessor routines</STRONG>. These routines are         discussed <A HREF = "#System75">later in this technote</A>.         </P>                  <P>The only time it is acceptable to access the FCB table         directly is when you need immediate access to the FCB and         FSM is not present.</P>                  <H3><A NAME="DebuggingFCBProblems"></A>Debugging FCB         Problems</H3>                  <P>If your software does not work on Mac OS 9.0 and you         suspect you have a dependency on the FCB table, there are a         number of ways you can debug it. This section describes how         you can search your source code looking for FCB-related bugs         and some run-time debugging techniques you can use.</P>                  <H4>Searching Your Source Code</H4>                  <P>One obvious way to determine whether your software relies         on the format of the FCB table is to run it under Mac OS         9.0. The tricky part, however, is exercising your entire         source base. The FCB table dependency may be hiding in a         rarely used feature that isn't exercised by your test suite.         A good alternative to testing is to search your source code         looking for references to the FCB table.</P>                  <P>For PowerPC software you should start by running your         program through the Carbon Dater tool (available on the         <a href="http://developer.apple.com/macosx/carbon/">Carbon</A>         web site). This will flag any references to the FCB table         low-memory accessor routines (<CODE>LMGetFCBSPtr</CODE>,         <CODE>LMSetFCBSPtr</CODE>, <CODE>LMGetFSFCBLen</CODE>, and         <CODE>LMSetFSFCBLen</CODE>) and likely PowerPC code         sequences that indicate a low-memory access. Unfortunately,         Carbon Dater cannot detect all low-memory accesses, so you         should search your source code textually as well.</P>                  <P>Carbon Dater is not an option for 68K software, so the         best thing to do is search your source code looking for some         (uncommon) strings that indicate direct access to the FCB         table. The strings to look for are:</P>                  <UL>            <LI>"FCBSPtr" and "FSFCBLen" - The official names for            the key low-memory globals.</li>                        <LI>"34E" and "3F6" - The above in hexadecimal.</li>                        <LI>"846" and "1014" - The above in decimal.</li>         </UL>                  <P>If you don't have source for all of your software, you         can also search your 68K code resources for <CODE>$034E</CODE> and <CODE>$03F6</CODE>.         Both of these values are rare as 68K instructions, so if you         hit one, it is worth disassembling the surrounding code to         see whether it is an FCB table access.</P>                  <H4>System Error 119</H4>                  <P>If you run your software and the system crashes with a         system error <CODE>dsMustUseFCBAccessors</CODE> <CODE>119</CODE>, it is a         sure sign that your PowerPC code is accessing the FCB table         directly. See <A HREF = "#dsMustUseFCBAccessors">PowerPC Code         and Low-Memory Accessors</A> for details.</P>                  <H4>Horrible Crashes</H4>                  <P>If your application dies with an <B>access exception</B> (or <B>bus error</B>) on Mac OS 9.0, you can look at the program state to         determine whether the problem is FCB related. Any of the         following in your Processor registers or local variables         might indicate FCB-related troubles.</P>                  <UL>            <LI>Pointers in to the 32-KB pointer block referenced by            the low-memory global <CODE>FCBSPtr ($034e).</CODE></li>                        <LI>Values of <CODE>$68F168F1</CODE>, possibly shifted in either direction by 16 bits. This is the bus error value which            the File Manager uses to fill unused entries in the fake            FCB table. See <A HREF = "#68KCodeAndLowMemory">68K Code            and Low Memory</A> for details.</li>                        <LI>Values that are the address of a VCB (using MacsBug's            <CODE>vol</CODE> command to display the VCB list),            possibly shifted in either direction by 16 bits.            <A HREF = "#68KCodeAndLowMemory">68K Code and Low            Memory</A> explains why this is likely.</li>         </UL>     <P><A HREF = "#top">Back to top</A></P><BR>         <P><A NAME="BeforeTheBeginning"></A></P>                  <H2>Before the Beginning</H2>                  <P>FCBs, as we know them today, were introduced as part of         HFS. HFS is built in to all 128K ROMs or later (starting         with the Macintosh Plus in 1986), and was available as an         extension for 64K ROM computers (the Macintosh 128 and 512).         </P>                  <P>Except for a few corner cases, this technote assumes that         you are programming for a 128K ROM system or later. This is         a fair assumption because 64K ROM machines do not support         System 7.0. Moreover, no current development environment         supports development for 64K ROMs. In short, if you are         developing for the 64K ROM, you have our sympathy but not         our support.</p>      <P><A HREF = "#top">Back to top</A></P>         <P><A NAME="InTheBeginning"></A></P>                  <H2>In the Beginning</H2>                  <P>This section described the classic FCB table format,         which was introduced with the HFS file system and retired in         Mac OS 9.0. It also discusses some of the limitations of         this format.</P>                  <H3>Classic FCB Table</H3>                  <P>When it was introduced, HFS used an simple table to store         FCBs. The table is held in a pointer block in the system         heap and is pointed to by the low-memory global         <CODE>FCBSPtr</CODE> ($34E). The table consists of a two         byte header (which contains the size of the pointer block)         followed by an array of FCBs, each of which is a fixed size.         This size is determined by another low-memory global,         <CODE>FSFCBLen ($3F6)</CODE>, which contained the value <CODE>94</CODE> when HFS was introduced.</P>                  <P>The format of the classic FCB table is shown in below.</P>                  <CENTER><img src="images/tn1184_001.gif" width=443 height=399 align=bottom alt="gif#1"></center>                  <P>A file reference number is the offset into this table of         the corresponding FCB. The file reference number for the         'Nth file is 2 + (N - 1) * <CODE>FSFCBLen</CODE>, which         yields the sequence 2, 96, 190, 284, and so on.</P>                  <H3>FCB Table Design Limitations</H3>                  <P>The basic structure of the FCB table implies a limit to         the number of FCBs, and hence the number of simultaneously         open files. The original Macintosh (which was extremely         memory constrained) created a table with 10 FCBs. This         number was derived from the <CODE>bbCntFCBs</CODE> field of         the boot block         (<CODE><a href="../../documentation/mac/Files/Files-101.html">BootBlkHdr</A></CODE>).         When the Macintosh Plus was introduced, the system         automatically scaled this number to suite the installed         memory. If the computer had 1 MB or more, the system created         an FCB table with <CODE>bbCntFCBs</CODE> * 4 entries. The         result was an FCB table with 40 entries on most System 6         computers.</P>                  <P>Towards the end of System 6's lifespan, this limit proved         to be a problem for many users. There were two solutions.         First, one could use a disk editor (the legendary FEdit,         for example) to increase the limit by editing the boot         block. Second, one could install the "Up Your FCBs" system         extension, which would expand the FCB table to its maximum         size at system startup.</P>                  <P><A NAME="Equation"></A>The maximum size of the classic         FCB table is 32 KB, primarily because a file reference         number is a 16-bit signed offset into the table. This yields         a maximum number of FCBs of (32768 - 2) div         <CODE>FSFCBLen</CODE>, or 348 for the standard FCB size of         94 bytes.</P>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>                                    <a href="../../documentation/mac/Files/Files-110.html#MARKER-9-674">Inside                  Macintosh: Files</A> states that the maximum number                  of open files with the classic FCB table is 342.                  This is incorrect. <B>The limit is 348.</B></p></TD></TR></TABLE></CENTER><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>                                    The maximum number of FCBs is not the same as the                  maximum number of files an application can open.                  The system uses some of these FCBs for its own                  internal needs. Some of this usage is an                  unavoidable implementation detail of the file                  system (such as the FCBs for the HFS catalog and                  extents files), while other files are explicitly                  opened by system software (such as the System file                  and various shared libraries). Modern systems                  maintain a lot of open files and severely constrain                  the number of FCBs available to application                  software. For example, an easy install of Mac OS                  8.6 has 100 files open before you get to the                  Finder.</p></TD></TR></TABLE></CENTER><BR><BR>                  <H3>Compatibility Notes</H3>                  <P><STRONG>The classic FCB table was never a public data         structure.</STRONG> While the format is well known - it is         described in Technote 1089,         <A HREF = "tn1089.html">"HFS         Elucidations Revisited</A>" - all these descriptions include         a warning that relying on this format will cause future         compatibility problems.</P>                  <P><A NAME="DocumentedFSFCBLenUse"></A>There is, however,         one documented use of the <CODE>FSFCBLen</CODE> low-memory         global, namely to determine whether the system has HFS         available. This mechanism is described in Technote FL_35,         <a href="../fl/fl_35.html">"Determining         Which File System Is Active."</A> This technique requires         that <CODE>FSFCBLen</CODE> be positive if HFS is available,         and negative otherwise. <STRONG>There is no documented use         of <CODE>FSFCBLen</CODE> other than testing its         sign.</STRONG></p>      <P><A HREF = "#top">Back to top</A></P>         <P><A NAME="System70"></A></P>                  <H2>System 7.0</H2>                  <P>System 7.0 introduced a number of new file system         features related to FCBs. This section describes those         features. Remember that all versions of System 7 and Mac OS         8 use the <A HREF = "#InTheBeginning">classic FCB table         format</A>, and inherit many properties from that format.         </P>                  <H3><A NAME="ParallelFCBTable"></A>Parallel FCB Table</H3>                  <P>System 7.0 was the first system to track FCB usage by         process. When a process opens a file, the FCB is tagged as         belonging to that process. If the process quits         unexpectedly, the Process Manager automatically closes all         the FCBs owned by it.</P>                  <P>Unfortunately, there was not enough space to store the         <CODE>ProcessSerialNumber</CODE> (PSN) of the owning process         in the classic FCB. While it was possible to grow the FCB         (by changing <CODE>FSFCBLen</CODE>), this had two important         drawbacks.</P>                  <OL TYPE=1 START=1>    <LI>Increasing the size of an FCB would decrease the maximum number of FCBs, because the maximum overall size of the classic FCB table size is limited to 32 KB.</li>                <LI>Increasing the size of an FCB might cause compatibility problems for developers who had hard-coded <CODE>sizeof(FCBRec)</CODE> into their code (bad developers!).</li></OL>                           <P>Instead, System 7.0 introduced the concept of a parallel         FCB table. This table was used to store the PSN for the         process that opened the file and, when a process quit, to         close all the files that were left open by that process.         </P>                           <P><B>IMPORTANT:</B><BR>                                    The parallel FCB table was never documented to                  third-party developers and has been removed in Mac                  OS 9.0. It is discussed here for informative                  purposes only and you should not rely on any                  details of the table or its implementation.</p>                  <P>Process Manager only tracks files that are opened         synchronously. Files that are opened asynchronous (using         <CODE>PBHOpenDFAsync</CODE>, for example) are not tracked by         the Process Manager because these calls can be made at         interrupt time, and there is no easy way to determine the         owning process at interrupt time.</P>                  <H3>Dynamically Growing FCB Table</H3>                  <P>System 7.0 also introduced a mechanism to grow the FCB table dynamically. When a program attempts to open a file         while the FCB table is full, the system returns a         <CODE>tmfoErr</CODE> (-42). When this happens under System         7.0, the system catches the error, attempts to grow the FCB         table, and then retries the open. The system can only grow         the FCB table if all of the following are true.</P>                  <UL>            <LI>The request to open a file was made synchronously.            Asynchronous requests (using <CODE>PBHOpenDFAsync</CODE>,            for example) can potentially be made at interrupt time,            when it is illegal to call the Memory Manager to grow the            FCB table.</li>                        <LI>There is enough space in the system heap for the new            table.</li>                        <LI>The table is smaller than its maximum of 348 FCBs.</li>         </UL>                  <P>Because of these restrictions, it is still possible to         get a <CODE>tmfoErr</CODE> error under System 7.0 and later,         although you are unlikely to get one if you are opening the         file synchronously unless the FCB table is completely full.</p><P><A HREF = "#top">Back to top</A></P>         <P><A NAME="System75"></A></P>                  <H2>System 7.5</H2>                  <P><a href="../ov/ov_21.html">System         7.5</A> was the first system to include the File System         Manager (FSM) as part of the System file. FSM provides a         number of routines which allow you to access FCBs without         assuming knowledge of the FCB table format.</P>                  <P>The four FCB accessor functions are:</P>                  <OL TYPE=1 START=1>            <LI><CODE>UTResolveFCB</CODE>, which maps a file            reference number to an FCB</li>                        <LI><CODE>UTIndexFCB</CODE>, which indexes through the            open FCBs on a volume</li>                        <LI><CODE>UTLocateFCB</CODE>, which finds an FCB by file            number and volume</li>                        <LI><CODE>UTLocateNextFCB</CODE>, which finds additional            FCBs (after using <CODE>UTLocateFCB</CODE>) by file            number (or name) and volume</li>         </oL>                  <P>These routines are documented in the "Guide to the File         System Manager", which is part of the         <A HREF = "ftp://ftp.apple.com/developer/Development_Kits/File_System_Manager.sit.hqx">File         System Manager SDK</A>.</P>                           <P><B>IMPORTANT:</B><BR>                                    These FCB accessor routines are not in InterfaceLib                  prior to Mac OS 8.5. The MoreInterfaceLib module of                  the DTS sample code                  <A HREF = "ftp://ftp.apple.com/developer/Sample_Code/Overview/MoreIsBetter.sit">MoreIsBetter</A>                  has Mixed Mode glue for calling these routines from                  CFM code on earlier systems.</p>                                    <P><B>IMPORTANT:</B><BR>                                    In Mac OS 9.0, <CODE>UTIndexFCB</CODE> will also                  return iterator control blocks.  If you are only                  interested in open files, you must explicitly skip                  these iterator control blocks using the technique                  <A HREF = "#IteratorControlBlocks">described                  below</A>.</p>                  <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>                                    These FCB accessor routines are not part of Carbon.                  Carbon code does not have immediate access to FCBs;                  see the <A HREF = "#ConcreteAdvice">Concrete                  Advice</A> section for details.</p></TD></TR></TABLE></CENTER><BR><BR>                  <P>These FCB accessor routines were originally intended for         use by FSM plug-ins (and other foreign file systems) but it         is appropriate to use them in other code. However, before         you use these routines you should read the         <A HREF = "#ConcreteAdvice">Concrete Advice</A> section to see         whether you would be better off using File Manager routines         instead (for example, <CODE>FSGetForkCBInfo)</CODE>.</P>                  <P><A NAME="HasFCBAccessors"></A>You can test for the         availability of these accessors with the following code.         </P><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>static Boolean HasFCBAccessors(void){    Boolean result;    long    response;&nbsp;    result = false;    // Make sure FSM is installed    if ( Gestalt(gestaltFSAttr, &amp;response) == noErr ) {        if ( (response &amp; (1L &lt;&lt; gestaltHasFileSystemManager)) != 0 ) {&nbsp;            // FSM 1.2 is the first version to support the            // the documented API, so check the version            if ( Gestalt(gestaltFSMVersion, &amp;response) == noErr ) {&nbsp;                // Make sure we have FSM 1.2 or later                if ( (unsigned long)response &gt;= 0x0120) {                    result = true;                }            }        }    }    return result;}</pre></TD></TR></TABLE></CENTER><BR><BR>           <P><A HREF = "#top">Back to top</A></P>         <P><A NAME="MacOS81"></A></P>                  <H2>Mac OS 8.1</H2>                  <P><A HREF = "tn1121.html">Mac         OS 8.1</A> introduced a new, built-in volume format,         <A HREF = "tn1150.html">HFS         Plus.</A> Despite significant changes to the internals of         the File Manager, Mac OS 8.1 changed the FCB table very         little.</P>                  <P>The most important change was required because HFS Plus         needs more space to store its extents information. The         <A HREF = "#InTheBeginning">classic FCB table</A> stores the         first 3 extents of a file in the <CODE>fcbExtRec</CODE> of         the FCB, where each extent is a 16-bit allocation block         number and a 16-bit length. HFS Plus needs to store the         first 8 extents of a file, where each extent is a 32-bit         allocation block number and a 32-bit length. Obviously the         new extent data would not fit into the classic FCB.</P>                  <P>The solution adopted was to store the extents data for         files on HFS Plus volumes in the         <A HREF = "#ParallelFCBTable">parallel FCB table</A>, leaving         the <CODE>fcbExtRec</CODE> field of the FCB unused (and set         to zero). This was a very compatible solution because it         left the classic FCB table mostly unchanged. Only software         that relied on <CODE>fcbExtRec</CODE> broke, and that         software would have broken anyway because of the new,         larger, allocation block numbers.      </p><P><A HREF = "#top">Back to top</A></P>         <P><A NAME="MacOS90"></A></P>                  <H2>Mac OS 9.0</H2>                  <P>This section describes the features of the Mac OS 9.0         File Manager as they relate to FCBs. It also explains some         of the rationale behind the changes made in Mac OS 9.0. It         even explains why the new limit to the number of open files         is 8,169!</P>                  <H3>Design Goals</H3>                  <P><a href="tn1176.html">Mac         OS 9.0</A> includes a significant enhancements to the File         Manager, including:</P>                  <UL>            <LI>new programming interfaces to access HFS Plus            features such as long file names (255 Unicode characters)            and large files (&gt; 2 GB)</li>                        <LI>a new FCB table format that extends the limit of the            number of open files from 348 to 8169</li>                        <LI>the ability to make most File Manager calls from            pre-emptive tasks (MP tasks)</li>         </UL>                  <P>One of the design criteria for the enhanced File Manager         was to implement these new features without breaking         software that uses documented programming interfaces.         Increasing the maximum number of open files required a         change to the FCB table format, but this format has never         been documented as something that developer can rely on.         </P>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>                                    Developers have been warned to not rely on the                  format of the FCB table many times.</P>                                    <UL>                     <LI><I>Inside Macintosh II</I>, page 127,                     "Warning: The size and structure of a file                     control block may be different in future                     versions of Macintosh system software."</li>                                          <LI><I>Inside Macintosh IV</I>, page 181,                     "Warning: The size and structure of a file                     control block may be different in future                     versions of Macintosh system software."</li>                                          <LI><I>Inside Macintosh V</I>, page 386, "Do not                     directly examine or manipulate system data                     structures, such as file control blocks (FCB) or                     volume control blocks (VCB), in memory. Use File                     Manager calls to access FCB and VCB                     information."</li>                                          <LI><a href="../../documentation/mac/Files/Files-110.html">Inside                     Macintosh: Files</A>, page 2-81, "Note: The size                     and structure of a file control block may be                     different in future versions of Macintosh system                     software. To be safe, you should get information                     from the FCB allocated for an open file by                     calling the File Manager function                     <CODE>PBGetFCBInfo</CODE>."</li>                                          <LI>Technote 1089,                     <A HREF = "tn1089.html">"HFS                     Elucidations Revisited."</A> "The following                     example is here for illustrative purposes only;                     dependence on it may cause compatibility                     problems with future system software."</li>                  </UL>               </TD></TR></TABLE></CENTER><BR><BR>                  <H3><A NAME="Gestalt"></A>Gestalt</H3>                  <P>Mac OS 9.0 defines a new <CODE>Gestalt</CODE> bit which indicates that the system has a new FCB table format and that you can't rely on <CODE>FCBSPtr</CODE>, <CODE>FSFCBLen</CODE>, or         their low-memory accessor routines (except         <CODE>LMGetFSFCBLen</CODE>). This <CODE>Gestalt</CODE> bit is         <CODE>gestaltMustUseFCBAccessors</CODE> (bit 13) of         <CODE>gestaltFSAttr</CODE>. As a rule, you should not use         this <CODE>Gestalt</CODE> bit to determine whether to use FCB accessors;         instead, you should always use the FCB accessors if they are         <A HREF = "#HasFCBAccessors">available</A>.</P>                  <H3>Big Changes</H3>                  <P>In Mac OS 9.0, FCB information is now stored in a private         table whose format is undocumented to developers.</P>                  <P>The information that was previously stored in the         parallel FCB table has been rolled into an expanded FCB. The         expanded FCB is defined by the <CODE>ForkControlBlock</CODE>         type in "FSM.h."</P>                  <P>Mac OS 9.0 also stores iterator control blocks in the FCB         table. See <A HREF = "#IteratorControlBlocks">Iterator Control         Blocks</A> for details.</P>                  <P>Developers who need immediate access to FCBs must use the         <A HREF = "#System75">FSM accessors</A>. In addition, Mac OS         9.0 introduces more FSM accessor routines, described in the         <A HREF = "#NewFSMAccessors">New FSM Accessors</A> section.         </P>                  <H4><A NAME="68KCodeAndLowMemory"></A>68K Code and Low         Memory</H4>                  <P>Given the massive changes to the FCB table format, it is         clear that the low-memory globals associated with the         classic FCB table format (<CODE>FCBSPtr</CODE> and         <CODE>FSFCBLen</CODE>, described         <A HREF = "#InTheBeginning">above</A>) no longer have any         meaning. Apple originally intended to set these variables to         a value that would cause a bus error if accessed, but a         number of considerations have modified this policy.</P>                  <P>Unfortunately, the Apple-supplied glue for         <CODE>GetVRefNum</CODE> relies on the classic FCB table         format. This glue is statically linked into many 68K         applications, and prevents Apple from eliminating the         classic FCB table completely. Instead, a fake FCB table is         carefully constructed so that this glue continues to work.         </P>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>                                    The Apple-supplied glue for <CODE>GetVRefNum</CODE>                  has made its way into a number of different                  libraries in a number of different development                  environment.</P>                                    <UL>                     <LI>MPW includes <CODE>GetVRefNum</CODE> in                     "Interface.o".</li>                                          <LI>CodeWarrior includes <CODE>GetVRefNum</CODE>                     in "MacOS.lib".</li>                                          <LI>Think C and Symantec C include                     <CODE>GetVRefNum</CODE> in "MacTraps".</li>                                          <LI>Think Pascal includes                     <CODE>GetVRefNum</CODE> in "Interface.Lib".</li>                  </UL>               </TD></TR></TABLE></CENTER><BR><BR>                  <P>The fake FCB table is pointed to by <CODE>FCBSPtr</CODE>         as before, but <CODE>FSFCBLen</CODE> is set to 4. The table         is make up of fake FCBs, one for each real FCB on the         system. The fake FCBs are staggered by <CODE>FSFCBLen</CODE>         (4 bytes) and each contains a valid <CODE>fcbVPtr</CODE> at         an offset of 20 ($14) bytes into the fake FCB ($10 bytes         beyond the bounds of the FCB as reported by         <CODE>FSFCBLen</CODE>). The following diagram illustrates         this layout.</P>                  <CENTER><img src="images/tn1184_002.gif" width=481 height=341 align=bottom alt="tn1184.2.gif"></center>                  <P>This layout allows the <CODE>GetVRefNum</CODE> to look up         the FCB table, check that the file reference number is         valid, and look up the <CODE>fcbVPtr</CODE> field of the         FCB, all using the fake FCB table.</P>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>                                    The disassembly of the GetVRefNum glue from                  "Interface.o" is shown below.</P>                  </TD></TR></TABLE></CENTER><BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><pre>; function GetVRefNum(fileRefNum: integer; VAR vRefNum: integer): OSErr;&nbsp;GetVRefNum        MOVEA.L    (A7)+,A1         ; pop return address        MOVEQ      #$00,D1          ; get fileRefNum (zero extended)        MOVE.W     $0004(A7),D1     ;        MOVEA.L    FCBSPtr,A0       ; get FCB table pointer        MOVE.W     FSFCBLen,D0      ; and FCB size        BMI.S      NoHFS            ; if negative, we're pre-HFS@HFS        DIVU.W     D0,D1            ; divide fileRefNum by FSFCBLen        BRA.S      DoneDivision@NoHFS        DIVU.W     #$005E,D1        ; divide fileRefNum by size of                                    ; pre-HFS FCB@DoneDivision        SWAP       D1               ; get fileRefNum mod FCB size        SUBQ.W     #$2,D1           ; if fileRefNum mod FCB size        BNE.S      BadResult        ; not 2, error out&nbsp;        MOVE.W     $0004(A7),D0     ; if fileRefNum &gt; than size        CMP.W      (A0),D0          ; of FCB table,        BCC.S      @BadResult       ; return an error        MOVEA.L    $14(A0,D0.W),A0  ; grab fcbVPtr from appropriate                                    ; FCB, points to VCB        MOVE.W     $004E(A0),D0     ; grab vcbVRefNum from VCB        MOVEQ      #$00,D1          ; noErr        BRA.S      @GoodResult&nbsp;@BadResult        MOVEQ      #$00,D0        MOVE.W     #$FFCD,D1        ; rfNumErr&nbsp;@GoodResult        MOVEA.L    (A7),A0          ; put D0 into vRefNum        MOVE.W     D0,(A0)          ;        ADDQ.W     #$6,A7           ; pop params        MOVE.W     D1,(A7)          ; put D1 into function result        JMP        (A1)             ; return to caller</pre></TD></TR></TABLE></CENTER><BR><BR>                                            <CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>                                    The fake FCB table is the cause of the 8169 limit                  on the number of open files. As before, the fake                  table is limited to 32 KB. No FCB is placed beyond                  the last 94 bytes because it might cause code that                  is walking the FCB table to wrap an                  <CODE>SInt16</CODE>. Therefore, the number of fake                  FCBs available is (32768 - 94 - 2) div 4 + 1, or                  8169.</p></TD></TR></TABLE></CENTER><BR><BR>                  <H4><A NAME="dsMustUseFCBAccessors"></A>PowerPC Code and         Low-Memory Accessors</H4>                  <P>The case for PowerPC code is somewhat clearer. For         PowerPC code, the implementation of <CODE>GetVRefNum</CODE>         is part of the system software, so it was modified to cope         with the new FCB table format.</P>                  <P>On the other hand, the low-memory accessor routines for         <CODE>FCBSPtr</CODE> and <CODE>FSFCBLen</CODE> presented a         more interesting problem. In theory, developers shouldn't be using these routines because they shouldn't be depending on the format of the FCB table. In practice, our experience is         that a surprising number of popular applications were using         them. This forced Apple to make a decision as to what these         routines should do.</P>                  <P>The final decision is:</P>                  <UL>            <LI><CODE>LMGetFCBSPtr</CODE>, <CODE>LMSetFCBSPtr</CODE>            and <CODE>LMSetFSFCBLen</CODE> all raise a            <CODE>dsMustUseFCBAccessors</CODE> (119) system error</li>                        <LI><CODE>LMGetFSFCBLen</CODE> continues to return the            value from <CODE>FSFCBLen</CODE>, which is now 4.</li>         </UL>                  <P>The rationale for these changes was:</P>                  <UL>            <LI>The format of the FCB table (as pointed to by            <CODE>FCBSPtr</CODE>) has radically changed. Any software            relying on this format is not going to work. Given that            the software is not going to work, it is much better for            the software to halt sooner rather than later. This            prevents possible data loss caused by old software            modifying what it thinks is the FCB table.</li>                        <LI>The distinctive system error number allows technical            support folk to quickly diagnose this problem.</li>                        <LI><CODE>FSFCBLen</CODE> has a documented use (to test            for the presence of HFS, as            <A HREF = "#DocumentedFSFCBLenUse">described earlier</A>)            and continues to work for that use.</li>         </UL>                  <H3><A NAME="IteratorControlBlocks"></A>Iterator Control         Blocks</H3>                  <P>The File Manager in Mac OS 9.0 introduces a new         mechanism, the iterator, to find all the items in a         directory or on a volume. An <STRONG>iterator</STRONG> is an         abstract object used to hold the state of a particular bulk         catalog operation. An iterator is described by the         <CODE>FSIterator</CODE> data type, which is created with         <CODE>FSOpenIterator</CODE> and destroyed with         <CODE>FSCloseIterator</CODE>.</P>                  <P>On traditional Mac OS, the state for the         <CODE>FSIterator</CODE> is maintained in an <STRONG>iterator         control block</STRONG> (of type         <CODE>IteratorControlBlock</CODE>) in the FCB table. The         iterator control block is like an FCB except that it         maintains the state for an <CODE>FSIterator</CODE> instead         of for an open file.</P>                  <P>Any software that uses FSM accessors must be careful to         treat iterator control blocks as such, and not to blindly         treat them as FCBs. You can distinguish between an         <CODE>IteratorControlBlock</CODE> and a         <CODE>ForkControlBlock</CODE> by testing the         <CODE>fcbIteratorBit</CODE> in the <CODE>moreFlags</CODE>         fields of the FCB.</P>                           <P><B>IMPORTANT:</B><BR>                                    The <CODE>moreFlags</CODE> field of the FCB is not                  present prior to Mac OS 9.0. You should                  conditionalize your test for iterator control                  blocks using <A HREF = "#Gestalt">Gestalt</A>.</p>                  <H3><A NAME="NewFSMAccessors"></A>New FSM Accessors</H3>                  <P>Mac OS 9.0 introduces a number of new FSM utility         routines which supplement the routines         <A HREF = "#System75">described earlier</A>. The routines are:         </P>                  <UL>            <LI><CODE>UTGetForkControlBlockSize</CODE> - Returns the            size of an FCB. This routine is necessary because            <CODE>LMGetFSFCBLen</CODE> is no longer useful and it is            expected that the FCB will expand further as the system            evolves.</li>                        <LI><CODE>UTResolveFileRefNum</CODE> - Returns the file            reference number for a given FCB.</li>                        <LI><CODE>UTCheckFCB</CODE> - Allows you to validate            whether an <CODE>FCBRecPtr</CODE> points to a valid FCB.</li>                        <LI><CODE>UTCheckForkPermissions</CODE> - A replacement            for <CODE>UTCheckPermission</CODE> that is somewhat            easier to use.</li>         </UL>                  <P>In addition, FCBs are now placed in a search list to         speed up the search for open files. The following routines         allow an external file system to benefit from the speed         gains of this search list.</P>                  <UL>            <LI><CODE>UTAddFCBToSearchList</CODE></li>                        <LI><CODE>UTRemoveFCBFromSearchList</CODE></li>                        <LI><CODE>UTLocateFCBInSearchList</CODE></li>         </UL>                  <P>All of these routines will be further documented in an         update to the "Guide to the File System Manager."</P>         <BR><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>                                    These FCB accessor routines are not part of Carbon.                  Carbon code does not have immediate access to FCBs;                  see the <A HREF = "#ConcreteAdvice">Concrete                  Advice</A> section for details.</p>  </TD></TR></TABLE></CENTER><BR><BR><P><A HREF = "#top">Back to top</A></P>         <P><A NAME="Summary"></A></P>                  <H2>Summary</H2>                  <P>The format of the FCB table, while documented to         developers for illustrative purposes, have never been         guaranteed. Mac OS 9.0 changes the format of this table,         primarily to increase the maximum number of open files on         the system. Apple has made this change such that all         existing, documented programming interfaces continue to         work. Moreover, the existing FSM accessors (introduced with         System 7.5) allow immediate access to an FCB in places where         this is necessary. However, Apple strongly recommends that         developers avoid immediate access to FCBs and instead use         the Carbon-compatible File Manager programming interfaces.</p><P><A HREF = "#top">Back to top</A></P><BR><a name="References"></a><H2>References</H2>            <p><a href="../../documentation/macos8/Files/FileManager/filemanager.html">Inside            Macintosh: Files</A>, especially the            <a href="../../documentation/mac/Files/Files-110.html">File            Control Blocks</A> section</p>                        <p><CITE>Guide to the File System Manager</CITE>, part            of the            <a href="http://developer.apple.com/sdk/">File            System Manager SDK</A></p>                        <p><A HREF = "tn1089.html">Technote 1089,             HFS            Elucidations Revisited</A></p>                        <p><a href="../fl/fl_35.html">Technote FL_35,            Determining            Which File System Is Active</A></p>                        <p><A HREF = "tn1176.html">Technote 1176,           Mac OS 9.0</A></p>                        <p><A HREF = "tn1121.html">Technote 1121,            Mac OS 8.1</A></p>                        <p><a href="../ov/ov_21.html">Technote OV_21,            System            7.5</A></p>                        <p><A HREF = "tn1150.html">Technote 1150,            HFS Plus Volume Format</A></p>                        <p><a href="../../qa/fl/fl10.html">Q&amp;A FL_10,            Accessing File Control Blocks</A></p>                        <p><a href="http://developer.apple.com/macosx/carbon/">Carbon</A>            web site</p><p><A HREF = "#top">Back to top</a> </p><BR><A NAME="Downloads"></A> <h2>Downloadables</h2><center><TABLE BORDER=0 CELLPADDING=3 WIDTH="600"> <TR> <td width=50 align=left>   <P ALIGN=center><img src="images/acrobatsmall.gif" align=middle alt="Acrobat" width=22 height=23></P></TD><td align="left">   <p>Acrobat version of this Note (188K).</P></TD><td width=60 align=left>   <p><A HREF="pdf/tn1184.pdf">Download</A></P></TD>  </TR> </table></center><BR><BR><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1184.html%3Fid%3DDTS10003023-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1184.html%3Fid%3DDTS10003023-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1184.html%3Fid%3DDTS10003023-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>