<html><head><title>Mac OS X Server
 Manual Page For imclient(3)</title>
<style type="text/css"><!-- @import "../../../../adcstyle.css"; .char {background: #ffffff; color:#0000ff;}.comment {background:#ffffff; color:#236e25}.function {background:#ffffff; color:#000000;}.keyword {background:#ffffff; color:#761550;}.number {background: #ffffff; color:#0000ff;}.param {background:#ffffff; color:#000000;}.preprocessor {background:#ffffff; color:#236e25}.string {background: #ffffff; color:#891315;}.template {background:#ffffff; color:#761550;}.type {background:#ffffff; color:#761550;}.var {background:#ffffff; color:#000000;} pre.manpages {font-size: 10pt;} .graybox { border-top: 1px solid #919699; border-left: 1px solid #919699; margin-bottom: 10px; } .graybox th { padding: 4px 8px 4px 8px; background: #E2E2E2; font-size: 12px; font-weight: bold; border-bottom: 1px solid #919699; border-right: 1px solid #919699; } .graybox td { padding: 8px; font-size: 12px; text-align: left; vertical-align: top; border-bottom: 1px solid #919699; border-right: 1px solid #919699; } .whiteout { font-size: 1px; background: #ffffff; color: #ffffff; } --></style>
<style type="text/css" media="print, aural, braille, embossed, projection, tty"><!-- @import "../../../../adcstyle.css"; .char {background: #ffffff; color:#0000ff;}.comment {background:#ffffff; color:#236e25}.function {background:#ffffff; color:#000000;}.keyword {background:#ffffff; color:#761550;}.number {background: #ffffff; color:#0000ff;}.param {background:#ffffff; color:#000000;}.preprocessor {background:#ffffff; color:#236e25}.string {background: #ffffff; color:#891315;}.template {background:#ffffff; color:#761550;}.type {background:#ffffff; color:#761550;}.var {background:#ffffff; color:#000000;} pre.manpages {font-size: 10pt;} .graybox { border-top: 1px solid #919699; border-left: 1px solid #919699; margin-bottom: 10px; } .graybox th { padding: 4px 8px 4px 8px; background: #E2E2E2; font-size: 12px; font-weight: bold; border-bottom: 1px solid #919699; border-right: 1px solid #919699; } .graybox td { padding: 8px; font-size: 12px; text-align: left; vertical-align: top; border-bottom: 1px solid #919699; border-right: 1px solid #919699; } .whiteout { display: none; } --></style>
</head><body bgcolor="white">
<a name="//apple_ref/doc/man/3/imclient" title="Mac OS X Server
 Manual Page for imclient(3)"><!-- headerDoc=man; indexgroup=Section 3; uid="//apple_ref/doc/man/3/imclient"; name=imclient(3) --></a>
<!--#include virtual="/includes/framesetheader"-->
<table width=600><tr><td scope="row">
<!-- begin breadcrumb insert request --><font face="Geneva,Helvetica,Arial" size="1">
 <a target="_top" href="http://developer.apple.com">ADC Home</a> <b>&gt;</b> <a href="../../../../../referencelibrary/index.html#//apple_ref/doc/uid/TP30000943" target="_top">Reference Library</a> <b>&gt;</b> <a href="../../../../../reference/index.html#//apple_ref/doc/uid/TP30001281" target="_top">Reference</a> <b>&gt;</b> <!-- a href="" target="_top" -->Mac OS X<!-- /a --> <b>&gt;</b> <a href="../index.html#//apple_ref/doc/framework/manpages" target="_top">Mac OS X Man Pages</a></font>
<!-- end breadcrumb insert request -->
<p>&nbsp;</p>
</td></tr></table>
<!-- end of header -->
<table border="0"  cellpadding="2" cellspacing="2" width="630pt"><tr><td valign="top" height="12" colspan="5" scope="row">
<p style='text-align:justify;'>This document is a Mac&nbsp;OS&nbsp;X manual page.  Manual pages are a command-line technology
for providing documentation.  You can view these manual pages locally using the
<a href="../man1/man.1.html#//apple_ref/doc/man/1/man">man(1)</a> command.
These manual pages come from many different sources, and thus, have a variety of writing
styles.</p>

<p style='text-align:justify;'>This manual page is associated with Mac&nbsp;OS&nbsp;X&nbsp;Server.  It is
not available on standard Mac OS X (client) installations.</p>

<p style='text-align:justify;'>For more information about the manual page format, see the manual page for 
<a href="../man5/manpages.5.html#//apple_ref/doc/man/5/manpages">manpages(5)</a>.</p>
</td></tr></table>
<hr />
<table border="0"  cellpadding="2" cellspacing="2" width="300"><tr><td valign="top" height="12" colspan="5" scope="row"><pre class="manpages"><tt>
IMCLIENT(3)                                                                                      IMCLIENT(3)



<b>NAME</b>
       imclient library - authenticating callback interface to IMAP/IMSP servers

<b>SYNOPSIS</b>
       <b>#include</b> <b>&lt;cyrus/imclient.h&gt;</b>

       <b>int</b> <b>imclient_connect(struct</b> <b>imclient</b> <b>**</b><u>imclient</u><b>,</b> <b>const</b> <b>char</b> <b>*</b><u>host</u><b>,</b> <b>const</b> <b>char</b> <b>*</b><u>port</u><b>);</b>

       <b>void</b> <b>imclient_close</b> <b>(struct</b> <b>imclient</b> <b>*</b><u>imclient</u><b>);</b>
       <b>void</b> <b>imclient_setflags(struct</b> <b>imclient</b> <b>*</b><u>imclient</u><b>,</b> <b>int</b><u>flags</u><b>);</b>
       <b>void</b> <b>imclient_clearflags</b> <b>(struct</b> <b>imclient</b> <b>*</b><u>imclient</u><b>,</b> <b>int</b><u>flags</u><b>);</b>
       <b>char*</b> <b>imclient_servername</b> <b>(struct</b> <b>imclient</b> <b>*</b><u>imclient</u><b>);</b>
       <b>void</b> <b>imclient_addcallback</b> <b>(struct</b> <b>imclient</b> <b>*</b> <b>imclient</b> <b>,...);</b>
       <b>void</b> <b>imclient_send</b> <b>(struct</b> <b>imclient</b> <b>*</b><u>imclient</u><b>,</b> <b>void</b> <b>(*</b><u>finishproc</u><b>)(),</b> <b>void</b> <b>*</b><u>finishrock</u><b>,</b> <b>const</b> <b>char</b>
       <b>*</b><u>fmt</u><b>,</b> <b>...);</b>
       <b>void</b> <b>imclient_getselectinfo</b> <b>(struct</b> <b>imclient</b> <b>*</b><u>imclient</u><b>,</b> <b>int</b> <b>*</b><u>fd</u><b>,</b> <b>int</b> <b>*</b> <u>wanttowrite</u><b>);</b>
       <b>void</b> <b>imclient_processoneevent</b> <b>(struct</b> <b>imclient</b> <b>*</b><u>imclient</u><b>);</b>
       <b>int</b> <b>imclient_authenticate</b> <b>(struct</b> <b>imclient</b> <b>*</b><u>imclient</u><b>,</b> <b>struct</b> <b>sasl_client</b> <b>**</b><u>availmech</u><b>,</b> <b>const</b> <b>char</b>
       <b>*</b><u>service</u><b>,</b> <b>const</b> <b>char</b> <b>*</b><u>user</u><b>,</b> <b>int</b> <u>protallowed</u><b>);</b>
       <b>int</b> <b>imclient_havetls</b> <b>();</b>
       <b>int</b> <b>imclient_starttls</b> <b>(struct</b> <b>imclient</b> <b>*</b><u>imclient</u><b>,</b> <b>char</b> <b>*</b><u>cert</u><b>_</b><u>file</u><b>,</b> <b>char</b> <b>*</b><u>key</u><b>_</b><u>file</u><b>,</b> <b>char</b> <b>*</b><u>CAfile</u><b>,</b> <b>char</b>
       <b>*</b><u>CApath</u><b>);</b>


<b>DESCRIPTION</b>
       The imclient library functions are distributed with Cyrus IMAP and IMSP.  These functions are used
       for building IMAP/IMSP client software. These functions handle Kerberos authentication and can set
       callbacks based on the keyword in untagged replies or based on the command tag at the end of command
       replies.

       Users must link with the -lcyrus switch, and must supply a function called <u>fatal</u> to be called in case
       of any error within <u>libcyrus.a.</u>

       All of the <b>imclient</b> functions begin with the prefix <u>imclient</u> and takes  an  argument of type <b>struct</b>
       <b>imclient</b> <b>*</b> as the first argument which is  initialized by <b>imclient_connect</b> and freed by
       <b>imclient_close.</b>

       See below for a description of each function.


       <b>imclient_connect()</b>
            Connects the client server to the host. If successful, it returns 0 and sets the imclient argu-<font color="#ffffff" class="whiteout">ment&nbsp;argument</font>
            ment to a pointer to an <b>imclient</b> struct. The <b>imclient</b> struct represents the current connection,
            flags, and  callbacks. On failure, the current <b>errno</b> is returned if a system call failed,  -1 is
            returned if the host name was not found, and  -2 is returned if the service name was not found.

       <b>imclient_close()</b>
            Closes and frees the <b>imclient</b> connection.

        <b>imclient_setflags()</b>
            Sets the flags specified by the <b>flags</b> argument on the <b>imclient</b> connection. Currently the only
            flag allowed is <b>IMCLIENT_CONN_NONSYNCLITERAL</b> (this flag indicates that the server supports non-<font color="#ffffff" class="whiteout">synchronizing&nbsp;nonsynchronizing</font>
            synchronizing literals described by the LITERAL+ extension).

       <b>imclient_clearflags()</b>
            Clears the flags specified by the <b>flags</b> argument on the <b>imclient</b> connection.

       <b>imclient_servername()</b>
            Returns a  char * pointer to the name of the server connected to by <b>imclient.</b>

       <b>imclient_addcallback()</b>
            Adds an untagged data callback to the <b>imclient</b> connection. The function <b>imclient_addcallback</b>
            takes callbacks of the type <b>imclient_proc_t</b> which is defined to be:
               typedef void imclient_proc_t (struct imclient *imclient, void *rock, struct imclient_reply
               *reply);
            and <b>struct</b> <b>imclient_reply</b> <b>*</b> is defined to be:
               struct imclient_reply {
                        char *keyword;
                        long msgno;
                        char *text;
               };

            After the first argument <b>imclient,</b> there can be zero or more instances of the set of <b>keyword,</b>
            <b>flags,</b> <b>proc,</b> and <b>rock,</b> each adding or changing a single callback.  Each instance  adds or
            changes the callback for <b>keyword.</b>  The argument, <b>flags,</b> specifies information about the parsing
            of the untagged data.  <b>proc</b> and <b>rock</b> specify the callback function and rock to invoke when the
            untagged data is received.  <b>proc</b> may be a null pointer, in which case no function is invoked.
            The callback function may not call the functions <b>imclient_close(),</b> <b>imclient_send(),</b>
            <b>imclient_eof(),</b> <b>imclient_processoneevent(),</b> or <b>imclient_authenticate()</b> on the connection. The
            callback function may over write  the text of untagged data.

       <b>imclient_send()</b>
            Sends a new command to the <b>imclient</b> connection.  <b>finishproc</b> and <b>finnishrock</b> are the function and
            rock called when the  command completes.  <b>functionproc</b> may be a null pointer, in which case no
            callback is made. The call back function may not call the functions <b>imclient_close(),</b>
            <b>imclient_send(),</b> <b>imclient_eof(),</b> <b>imclient_processoneevent(),</b> or <b>imclient_authenticate()</b> on the
            connection.  The argument, <b>fmt</b> , is a print like specification of the command. It must not
            include the tag as the tag is automatically added by imclient_send().  The defined %-sequences
            are:
               <b>%%</b> for %
               <b>%a</b> for an IMAP atom
               <b>%s</b> for an astring (which will be quoted or literalized as needed)
               <b>%d</b> for a decimal
               <b>%u</b> for an unsigned  decimal
               <b>%v</b> for #astring (argument is a null-terminated array of <b>char</b> <b>*</b> which are written as space
               separated astrings)

       <b>imclient_getselectinfo()</b>
            Gets the information for calling <a href="../man2/select.2.html#//apple_ref/doc/man/2/select"><b>select(2)</b></a><b>.</b>  <b>fd</b> is filled in with the file descriptor to
            <a href="../man2/select.2.html#//apple_ref/doc/man/2/select"><b>select(2)</b></a><b></b> for read.  <b>wanttowrite</b> is filled in with a nonzero value if select should be used for
            write as well.

       <b>imclient_processoneevent()</b>
            Processes one input or output event on the <b>imclient</b> connection.

       <b>imclient_authenticate()</b>
            Authenticates the <b>imclient</b> connection using one of the mechanisms in <b>availmech.</b>  The argument,
            <b>user,</b> if not NULL, specifies the user to authenticate as. If the user is NULL, the current user
            is used.  The argument <b>protallowed</b> is a bitmask of permissible protection mechanisms.
            On success, 0 is returned.  On failure (i.e., "BAD" keyboard, or no authentication mechanisms
            worked), 1 is returned. On extreme failure (premature "OK"), 2 is returned.

       <b>imclient_havetls()</b>
            Returns a Boolean indicating whether the <b>imclient</b> library was compiled with TLS (SSL) support.
            If so, <b>imclient_starttls()</b> may be used to secure the IMAP connection.

       <b>imclient_starttls()</b>
            Issues a STARTTLS command on an existing IMAP connection and negotiates the secure link.  The
            <b>cert_file</b> and <b>key_file</b> arguments specify the client certificate and secret key to use to authen-<font color="#ffffff" class="whiteout">ticate&nbsp;authenticate</font>
            ticate ourselves to the server.  If client authentication is not needed, set both of these argu-<font color="#ffffff" class="whiteout">ments&nbsp;arguments</font>
            ments to NULL.

            The <b>CAfile</b> and <b>CApath</b> arguments specify a file or directory, respectively, of CA certificates
            for validating server certificates.  (See <a href="SSL_CTX_load_verify_locations.3ssl.html#//apple_ref/doc/man/3/SSL_CTX_load_verify_locations"><b>SSL_CTX_load_verify_locations(3)</b></a><b></b> for details.)  If
            both of these are NULL, the client will be unable to validate the server's certificate, in which
            case the connection may succeed but a warning will be printed to stdout.


<b>EXAMPLES</b>
       The following code is a possible skeletion of <b>imclient</b> that relies on Kerberos to do authentication.
       This code preforms an IMAP CAPABILITY request and prints out the result.

       struct sasl_client;
       #include &lt;cyrus/xmalloc.h&gt; /* example uses xstrdup */
       #include &lt;cyrus/sasl.h&gt;
       #include &lt;cyrus/imclient.h&gt;
       #include &lt;stdio.h&gt;

       extern struct sasl_client krb_sasl_client;

       struct sasl_client *login_sasl_client[] = {
           &amp;krb_sasl_client,
           NULL
       };
       struct imclient *imclient;
       char server[] = "cyrus.andrew.cmu.edu" ;
       char port[] = "imap";

       void fatal(char* message, int rc) {
           fprintf(stderr, "fatal error: %s\n", message);
           exit(rc);
       }

       static void callback_capability(struct imclient *imclient,
                           void *rock,
                           struct imclient_reply *reply) {
           if (reply-&gt;text != NULL) {
            *((char**)rock) = xstrdup( reply-&gt;text );
           }
       }

       static void end_command (struct imclient *connection, void*
                      rock,  struct imclient_reply *inmsg) {
           (*(int*)rock)--;
       }

       main() {
           char* capability_string;
           int nc;

           if (imclient_connect(&amp;imclient, server, port)) {
            fprintf(stderr,
                 "error: Couldn't connect to %s %s\n",
                 server, port);
            <a href="../man1/exit.1.html#//apple_ref/doc/man/1/exit">exit(1)</a>;
           }

           if (imclient_authenticate(imclient, login_sasl_client, "imap"
                            /* service */,
                            NULL /* user */, SASL_PROT_ANY)) {
            <a href="../man1/exit.1.html#//apple_ref/doc/man/1/exit">exit(1)</a>;
           }

           imclient_addcallback(imclient, "CAPABILITY",
                       CALLBACK_NOLITERAL,
                       callback_capability,
                       &amp;capability_string,
                       NULL);

           nc = 1;

           imclient_send(imclient, end_command,
                   (void*) &amp;nc, "CAPABILITY");

           while(nc &gt; 0) {
            imclient_processoneevent(imclient);
           }

           if (strstr("LITERAL+", capability_string)) {
            imclient_setflags(imclient, IMCLIENT_CONN_NONSYNCLITERAL);
           }

           imclient_send(imclient, NULL, NULL, "LOGOUT");
           imclient_close(imclient);

           printf("capability text is: %s\n", capability_string);

           free(capability_string);
       }


<b>BUGS</b>
       No known bugs.


<b>SEE</b> <b>ALSO</b>
       <b>cyradm,</b> <b>imapd,</b> <b>imspd,</b> RFC2033 (IMAP LITERAL+ extension), RFC2060 (IMAP4rev1 specification), and
       <a href="../man2/select.2.html#//apple_ref/doc/man/2/select"><b>select(2)</b></a><b></b>


<b>KEYWORDS</b>
       IMAP, ACAP, IMSP, Kerberos, Authentication


<b>COPYRIGHT</b>
       Copyright 1997-2002, Carnegie Mellon University.  All Rights Reserved.

       See the source distribution for copying information.



CMU                                             Project Cyrus                                    IMCLIENT(3)
</tt></pre>
</td></tr></table>
	<table width="100%" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/documentation/Darwin/Reference/ManPages/man3/imclient.3.html%3Fid%3DTP40000894-7.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/documentation/Darwin/Reference/ManPages/man3/imclient.3.html%3Fid%3DTP40000894-7.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/documentation/Darwin/Reference/ManPages/man3/imclient.3.html%3Fid%3DTP40000894-7.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

</body></html>
