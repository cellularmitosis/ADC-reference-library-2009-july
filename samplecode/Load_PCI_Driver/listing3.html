<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>Load PCI Driver - /Load PCI Driver.c</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../samplecode/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; <A HREF="javascript:location.replace('index.html');">Load PCI Driver</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/HardwareDrivers/index.html" target="_blank">Reference Library > Hardware & Drivers</a></li>
	</ul>
</div>




</div></div></div>

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">Load PCI Driver</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/Load PCI Driver.c</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/FullPath.c</option>
<option value="listing2.html">/FullPath.h</option>
<option value="listing3.html">/Load PCI Driver.c</option>
<option value="listing4.html">/MoreFiles/DirectoryCopy.h</option>
<option value="listing5.html">/MoreFiles/FileCopy.h</option>
<option value="listing6.html">/MoreFiles/FSpCompat.h</option>
<option value="listing7.html">/MoreFiles/IterateDirectory.h</option>
<option value="listing8.html">/MoreFiles/MoreDesktopMgr.h</option>
<option value="listing9.html">/MoreFiles/MoreFiles.h</option>
<option value="listing10.html">/MoreFiles/MoreFilesExtras.h</option>
<option value="listing11.html">/MoreFiles/Optimization.h</option>
<option value="listing12.html">/MoreFiles/OptimizationEnd.h</option>
<option value="listing13.html">/MoreFiles/Search.h</option>
<option value="listing14.html">/SimpleApp/SimpleApp.h</option></select>
				</p>
				</form>
				<p><strong><a href="Load_PCI_Driver.zip">Download Sample</a></strong> (&#147;Load_PCI_Driver.zip&#148;, 340.5K)<BR>
<strong><a href="Load_PCI_Driver.dmg">Download Sample</a></strong> (&#147;Load_PCI_Driver.dmg&#148;, 445.4K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*  File:    Load PCI Driver.c  Contains:  Load PCI Driver Sample,This Code loads Wayne Flansburg PCI 'ndrv'        so you can see it load without having to have a PCI card installed.        This requires the PCI interfaces and libraries from ETO.  Written by: Matthew Xavier Mora    Copyright:  Copyright &copy; 1996-1999 by Apple Computer, Inc., All Rights Reserved.        You may incorporate this Apple sample source code into your program(s) without        restriction. This Apple sample source code has been provided &quot;AS IS&quot; and the        responsibility for its operation is yours. You are not permitted to redistribute        this Apple sample source code as &quot;Apple sample source code&quot; after having made        changes. If you're going to re-distribute the source, we require that you make        it clear in the source that the code was descended from Apple sample source        code, but that you've made changes.  Change History (most recent first):        8/3/1999  Karl Groethe  Updated for Metrowerks Codewarror Pro 2.1        06/11/97  mxm       Fixed the error -2538 by passing nil for the regID.        04/15/97  mxm        Cleaned it up for the Dev CD        03/28/97  mxm        Took out the MyFindSpaceInUnitTable routine. I wasn't using the                       InstallDriverFromFile correctly. HighestUnitNumber wasn't the problem.                      That's what I get for trying to program without the Documentation.                      Added Drag Manger and ODoOC support so you can drag a driver                      into the window or on the application and it will load it.                      Display more info from the driver.        03/25/97    mxm             Moved to a real app                                    Fixed the can't load the library a second time bug.                                      I was using HighestUnitNumber to get the unit number to load.                                     I thought this call found the last used unit number. It                                     actually expanded the unit table to the max number of                                     entries! I put in MyFindSpaceInUnitTable routine and use it instead.                                     Fix crashing Malph by moving it into an application shell. I don't                                      know why it would cause Malph to crash.                  02/01/96  mxm        I wrote the first version in the &quot;Writing PCI drivers&quot; class. Got it to load                      the sample driver I was writing. No real user interface                      to speak of.                      *///------------------------------------------------------------------#pragma mark Includes//------------------------------------------------------------------#include &lt;Devices.h&gt;#include &lt;NameRegistry.h&gt;#include &lt;StandardFile.h&gt;#include &lt;LowMem.h&gt;#include &lt;Dialogs.h&gt;#include &quot;SimpleApp.h&quot;#include &lt;stdio.h&gt;#include &lt;string.h&gt;#include &lt;TextUtils.h&gt;#include &lt;CodeFragments.h&gt;//------------------------------------------------------------------#pragma mark Prototypes//------------------------------------------------------------------pascal  OSErr  FSpGetFullPath(const FSSpec *spec, short *fullPathLength, Handle *fullPath);//------------------------------------------------------------------#pragma mark Globals//------------------------------------------------------------------short  gDrvrRefNum = 0; /* global variable for storing my driver reference number */long   gLoadButton;long  gUnloadButton;short   gVert;short  gLineHeight;NMRec  gAlertNMRec;Str255  gAlertStr = &quot;\pAn error occurred. Please bring Matt's PCI Loader to the front.&quot;;short  gError = 0;//------------------------------------------------------------------#pragma mark Defines//------------------------------------------------------------------#pragma mark -//------------------------------------------------------------------static void AlertUser(short err)//------------------------------------------------------------------{  // in this case just set the global and the idle routine will display the error  gError = err;}/*// I grabbed this code from somewhere//------------------------------------------------------------------static short MyFindSpaceInUnitTable(void)//------------------------------------------------------------------{  Ptr      curUTableBase, newUTableBase;  short      curUTableEntries, newUTableEntries;  short      refNum, unitNum;    // get current unit table values from low memory globals   curUTableEntries = LMGetUnitTableEntryCount();  curUTableBase   = LMGetUTableBase();    // search for empty space in the current unit table   for ( unitNum = curUTableEntries - 1;       unitNum &gt;= 48; // lowest available unit number       unitNum-- )  {    refNum = ~(unitNum);    if (GetDCtlEntry(refNum) == nil)      return(unitNum); // found a space   }      // no space in the current table, so make a new one     // increase the size of the table by 16 (an arbitrary value)  newUTableEntries = curUTableEntries + 16;    // allocate space for the new table   newUTableBase =  NewPtrSysClear((long)newUTableEntries * sizeof(Handle));  if (newUTableBase == nil) {    return(MemError());  }  // copy the old table to the new table   BlockMoveData(curUTableBase, newUTableBase, (long)curUTableEntries * sizeof(Handle));    // set the new unit table values in low memory   LMSetUTableBase(newUTableBase);  LMSetUnitTableEntryCount( newUTableEntries);    unitNum = newUTableEntries - 1;  // unitNum = 0; //uh bad thing man.  return(unitNum); }*///------------------------------------------------------------------static void ForceUpdate(void)//------------------------------------------------------------------{  if (gSACurrentWindow) {    SetPort(gSACurrentWindow);    InvalRect(&amp;gSACurrentWindow-&gt;portRect);  }  }//------------------------------------------------------------------static void UnloadDriver(void)//------------------------------------------------------------------{  short err;    if (gDrvrRefNum) {     err = RemoveDriver(gDrvrRefNum, true);    gDrvrRefNum = 0;  }}//------------------------------------------------------------------static short InstallDriver(FSSpecPtr spec) //------------------------------------------------------------------{  RegEntryID       device={0,0};  short         lowUnitNumber,hiUnitNumber ;    short         err = -1;          if (gDrvrRefNum) {    UnloadDriver();  }   lowUnitNumber = 48 ; // MyFindSpaceInUnitTable();   hiUnitNumber = HighestUnitNumber();     if (lowUnitNumber &gt; 0) {      err = InstallDriverFromFile(spec,nil,lowUnitNumber ,hiUnitNumber,&amp;gDrvrRefNum);    if (err != noErr) {      AlertUser(err);  // we can be called from inside a drag handler so just set a flag      SAEnableObject(gLoadButton);      SADisableObject(gUnloadButton);    } else {      SAEnableObject(gUnloadButton);      SADisableObject(gLoadButton);    }  }   ForceUpdate();  return err;  }// Load a driver via StandardFile//------------------------------------------------------------------static  short LoadDriver(void)//------------------------------------------------------------------{  short         err = -1;  OSType         typeList[4];  OSType *      typeListPtr = typeList;  StandardFileReply   reply;    typeList[0] = 'ndrv';      StandardGetFile(nil,1,typeList,&amp;reply);  if (reply.sfGood) {    err = InstallDriver(&amp;reply.sfFile);  }    return err;  }// ODOC handler//------------------------------------------------------------------static pascal OSErr   MyOpenFileProc(FSSpecPtr myFSSPtr)//------------------------------------------------------------------{  short err;    err =  InstallDriver(myFSSPtr) ;  return noErr;}//------------------------------------------------------------------static  pascal short DoIdle(EventRecord *evt)//------------------------------------------------------------------{    Str255 tempStr;      short err;#pragma unused (evt)  // in case we want to do something at idle time    if (gError) {    gAlertNMRec.qType     = nmType;    gAlertNMRec.nmFlags    = 0;    gAlertNMRec.nmPrivate  = 0;    gAlertNMRec.nmReserved  = 0;    gAlertNMRec.nmResp     = nil;    gAlertNMRec.nmStr     = gAlertStr;    gAlertNMRec.nmSound   = nil;    gAlertNMRec.nmMark     = 1;    gAlertNMRec.nmIcon     = nil;    err = AEInteractWithUser(kAEDefaultTimeout,&amp;gAlertNMRec,nil);          NumToString(gError,tempStr);    ParamText(tempStr,&quot;\p&quot;,&quot;\p&quot;,&quot;\p&quot;);    Alert(1002,nil);    gError = 0;  }  return noErr;}//------------------------------------------------------------------  static  pascal short DoLoadDriver(ButtonItemRef me,long refCon)//------------------------------------------------------------------{#pragma unused (me,refCon)  short err;    err = LoadDriver();  if (err == noErr ) {    SADisableMe();    SAEnableObject(gUnloadButton);    ForceUpdate();  }  return noErr;}//------------------------------------------------------------------  static  pascal short DoUnloadDriver(ButtonItemRef me,long refCon)//------------------------------------------------------------------{#pragma unused (me,refCon)  UnloadDriver();  SADisableMe();  SAEnableObject(gLoadButton);  ForceUpdate();    return noErr;}//------------------------------------------------------------------  static GetLineHeight(void)//------------------------------------------------------------------{  FontInfo info;    GetFontInfo(&amp;info);  return (info.ascent + info.descent + info.leading);}//------------------------------------------------------------------  static void DrawItem(StringPtr label,StringPtr text)//------------------------------------------------------------------{    DrawString (label);    DrawString (text);    MoveTo(5,gVert);    gVert += gLineHeight; }//------------------------------------------------------------------  static void DrawHex(StringPtr label,long n)//------------------------------------------------------------------{    char s[256];        sprintf(s,&quot;%0X&quot;,n);    DrawString (label);    DrawText(s,0,strlen(s));    MoveTo(5,gVert);    gVert += gLineHeight; }//------------------------------------------------------------------  static void DrawHandle(StringPtr label,Handle text)//------------------------------------------------------------------{  DrawString (label);  if (text) {    DrawText (*text,0,GetHandleSize(text));  }  MoveTo(5,gVert);  gVert += gLineHeight; }//------------------------------------------------------------------  static void DrawNumber(StringPtr label,long n)//------------------------------------------------------------------{    Str255 tempStr;  NumToString(n,tempStr);  DrawString (label);  DrawString (tempStr);  MoveTo(5,gVert);  gVert += gLineHeight; }//------------------------------------------------------------------  static  pascal short MyUpdate(long refCon)//------------------------------------------------------------------{#pragma unused (refCon)  Str255         tempStr;  UnitNumber       unitNum;  DriverFlags     flags;  DriverOpenCount   count;  RegEntryID       device;  CFragSystem7Locator  driverLoadLocation;  CFragConnectionID   fragmentConnID;  DriverEntryPointPtr fragmentMain;  DriverDescription   driverDesc;  FSSpec        fileSpec;  Handle         fullPath = nil;  short         err  = 0;  short        fullPathLength;    gLineHeight = GetLineHeight();    gVert = 120;  MoveTo(5,gVert);  gVert += gLineHeight;     if (gDrvrRefNum) {      DrawString(&quot;\pThe driver is loaded. refNum = (&quot;);    NumToString(gDrvrRefNum,tempStr);    DrawString (tempStr);    DrawString(&quot;\p)&quot;);    MoveTo(5,gVert);        gVert += gLineHeight;     driverLoadLocation.u.onDisk.fileSpec = &amp;fileSpec;    err =  GetDriverInformation(gDrvrRefNum,                  &amp;unitNum,                   &amp;flags,                   &amp;count,                  tempStr,                   &amp;device,                  &amp;driverLoadLocation,                  &amp;fragmentConnID,                  &amp;fragmentMain,                   &amp;driverDesc);        DrawItem(&quot;\pName: &quot;,tempStr);    DrawNumber(&quot;\pUnitNumber: &quot;,unitNum);      DrawNumber(&quot;\pCount: &quot;,count);    DrawHex(&quot;\pflags: &quot;,flags);    err = FSpGetFullPath(&amp;fileSpec,&amp;fullPathLength, &amp;fullPath);    if (fullPath) {      DrawHandle(&quot;\pPath: &quot;,fullPath);      DisposeHandle(fullPath);    }      DrawHex(&quot;\pFragment Main: 0x&quot;,(long)fragmentMain);      } else {    DrawString(&quot;\pNo Driver Loaded.             &quot;);  }    return noErr;}//---------------------------------------------------------------------------------------  static pascal OSErr MyPutData (ObjectItemRef orh,OSType kind,Ptr  data,long len,long flags)//---------------------------------------------------------------------------------------{#pragma unused (orh,len,flags)  HFSFlavor * theFile;    if (kind == flavorTypeHFS) {     theFile = (HFSFlavor *)data;        if (theFile-&gt;fileType == 'cfrg' ) {      InstallDriver(&amp;theFile-&gt;fileSpec);    }  }  return noErr;}// The drag receive handler//------------------------------------------------------------------static pascal short MyReceive(ObjectItemRef orh,DragReference theDrag)//------------------------------------------------------------------{#pragma unused(orh)  ItemReference  itemRef;  Size      dataSize;  HFSFlavor    theHFSFlavor;  OSErr      retCode;  // There is only one item, so get its reference number.  retCode = GetDragItemReferenceNumber(theDrag, 1, &amp;itemRef);    if (retCode == noErr) {    dataSize = sizeof(HFSFlavor);    retCode = GetFlavorData(theDrag, itemRef, flavorTypeHFS, &amp;theHFSFlavor, &amp;dataSize, 0);    if (retCode == noErr)  {      InstallDriver(&amp;theHFSFlavor.fileSpec) ;    }  }  return retCode;}//------------------------------------------------------------------void main(void)//------------------------------------------------------------------{   long   buttonID   = 1;  long   textID     = 2;  long  dragID     = 3;  Str255   tempStr;  Rect  r ;  long   gMyWindowID;  short  err;    InitSimpleApp(2,kUseStandardMenu);      // Simple App Sets up the Tool Box For us   gMyWindowID = GetDocumentWindow (128);   // Get our stored window   SetOpenFileProc (MyOpenFileProc);    // set open file proc. This is called on an ODOC event    SetWTitle(gSACurrentWindow,&quot;\pMatt's PCI Driver Loader&quot;);    InstallIdleProc(DoIdle);  SetWindowUpdateProc(gSACurrentWindow,MyUpdate );   //gSACurrentWindow for now, its a Kludge  GetIndString(tempStr,kStaticStrings,kButtonName);  // Get button name  SetRectDimensions(&amp;r, 180, 20);      // This Sets its size without changing it position  SetRectLocation(&amp;r, 10, 30);      // This Sets a rects anchor point  (void)InstallPushButton(&amp;buttonID,gSACurrentWindow,tempStr,&amp;r,0,DoLoadDriver,nil);  gLoadButton = buttonID;  OffsetRect(&amp;r,200,0);  GetIndString(tempStr,kStaticStrings,3);  // Get button name  (void)InstallPushButton(&amp;buttonID,gSACurrentWindow,tempStr,&amp;r,0,DoUnloadDriver,nil);  gUnloadButton = buttonID;  SADisableMe();      SetRect(&amp;r,4,55,gSACurrentWindow-&gt;portRect.right - 4,110);      GetIndString(tempStr,kStaticStrings,kAboutText);  // Get about this snippet text  (void)InstallStaticText(&amp;textID,gSACurrentWindow,tempStr,&amp;r);      // lets add drag and drop support for our window    err = InstallDragObject(&amp;dragID,gSACurrentWindow,&quot;\p&quot;,&amp;gSACurrentWindow-&gt;portRect, nil, nil, MyReceive, 0);  err = SAInstallStandardDragHandlers(gSACurrentWindow);        // enable dragging  err = SAAddWindowDragDataTypes(gSACurrentWindow,flavorTypeHFS);    // we accept flavorTypeHFS  Run();                                 //Let SimpleApp handle the rest      // lets check and see if the driver is still loaded and ask the   // user what to do if it is loaded  if (gDrvrRefNum) {    short itemHit;    itemHit = Alert(1001,nil);    if (itemHit == 1 ) {      UnloadDriver();    }  }}</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/Load_PCI_Driver/listing3.html%3Fid%3DDTS10000439-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/Load_PCI_Driver/listing3.html%3Fid%3DDTS10000439-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/Load_PCI_Driver/listing3.html%3Fid%3DDTS10000439-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>