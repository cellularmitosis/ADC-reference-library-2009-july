<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><html><head><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note PR15: Feeder Fodder</title><meta name="categories" content="Printing"><meta name="week-posted" content="Apr 1, 1991 - Apr 5, 1991"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002636" title="Feeder Fodder"></a><a name="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxPrinting-date.html">Printing</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="http://developer.apple.com/referencelibrary/Printing/index.html" target="_blank">Reference Library > Printing</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note PR15</div>
<div id="pageheadsub">Feeder Fodder</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc -->										<p id="menutext">					 <A HREF="#Section1">Introduction</A><BR><BR>					 <A HREF="#Section2">Implementation</A><BR><BR>					 <A HREF="#Section3">Go Ahead and Jump</A><BR><BR>					 <A HREF="#Section4">The Real MacCode</A><BR><BR>					 <A HREF="#Section5">Don't Feed The Print Monster</A><BR><BR>					 <A HREF="#Section6">Driving Miss Lasey</A><BR><BR>						<A HREF="#Section7">Conclusion</A><BR><BR>					  <A HREF="#References">References</A><BR><BR> <A HREF="#Downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><p id="introtext"> This Technical Note discusses the new Feeder button available in the 6.1, and7.0 versions of the LaserWriter driver.  This Feeder button mechanism allowsdevelopers to insert code into the LaserWriter driver to support a sheet feederconnected to a LaserWriter.  This Note provides a description of the button, aswell as information required to implement one.</p> <!-- end_intro_text --><!-- begin_date --><h3 align=center>[Apr 01 1991]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content --><a name=Section1></A> <h2>Introduction</h2><p>The LaserWriter driver now implements a standard method for handling sheetfeeders.  Most LaserWriter sheet feeders need a way to present a user with adialog as well as a way to download the PostScript code necessary to control the feeder.  In the past, most manufacturers resortedto modifying the LaserWriter driver's code resources; however, thisfunctionality is now possible without the need to patch existing resources inthe driver--by adding three new resources.</p><p>When the LaserWriter driver notices these three special resources in itsresource fork, it displays a Feeder button in the lower right corner of thePrint dialog box.  It is important to note that this feature is not providedfor general application use, but rather only for developers of sheet feedersand other LaserWriter add-on devices.  The button is always labeled Feeder, andthere can be only one set of Feeder resources in the LaserWriter driver.Because of this restriction, you should not attempt to use this feature toimplement anything other than a sheet feeder.</p><p>The first special resource contains code to implement the user interface of thefeeder, and the other two contain the PostScript code required to drive thefeeder.  When an application calls the LaserWriter driver to display the Printdialog box, the driver looks for three resources of type <code>'feed'</code> anddisplays the Feeder button in the lower right corner of the dialog box if theyare found.  If no <code>'feed'</code> resources are available, it does not displaythe Feeder button.</p><p>When a user selects Print, the driver displays the standard Print dialog boxwith the Feeder button.  If a user clicks on the Feeder button, the driverdisplays a dialog box in front of the Print dialog box, which allows the userto configure the feeder, then returns to the Print dialog box once the userconfirms or cancels the feeder configuration.  This feeder dialog box should<b>not</b> contain an option to print, as this could override choices made inthe standard Print dialog box.</p> <P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>Implementation</h2><p>To handle interaction with the user, you must install a resource of type<code>'feed'</code> (<code>ID = -8192</code>) into the LaserWriter driver with the coderequired to manage the dialog box.  Like all Printing Manager code resources,this resource begins with a jump table, followed by the actual code.  The codeis implemented as a procedure that is passed a single parameter.  Thisparameter is a rectangle defining the page size selected by the user.  Thispage size is equivalent to the <code>rPaper</code> rectangle in the print record,meaning it defines the actual page size, not just the printable area.  Therectangle is expressed in 72 dpi coordinates and has a negative origin.</p><P><A HREF="#top">Back to top</A></P><a name="Section3"></a><h2>Go Ahead and Jump</h2><p>The jump table consists of a 68000 <code>JMP</code> instruction that jumps to theproper offset in the resource.  In this case, there is only one routine, so thecode starts immediately following the jump table.  To make this step automatic,the jump table is created using a small assembly language header:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>IMPORT        Feeder                    ; Feeder is NOT defined here...Start        MAIN        EXPORT      ; This is the main entry point for the linker.JMP            Feeder                    ; The one jump table entry in this table.</pre>	</TD></TR></TABLE></CENTER><p>This example first imports the <code>Feeder</code> procedure, which can be definedexternally in the language of your choice.  Next is <code>Start</code>, the mainentry point to the jump table.  By passing this label to the link command, thejump table is located at the beginning of the resource.  The next line is theactual jump table entry, and the <code>END</code> is required to end theassembly-language header.  That's all there is to it.  The only thing oneshould have to change in this code fragment would be the name of the routine toimport.</p><P><A HREF="#top">Back to top</A></P><a name="Section4"></a><h2>The Real MacCode</h2><p>Now that the jump table is complete, it needs some place to jump.  Although MPWC and Pascal examples are provided in this Note, the code can be written in anylanguage.  As mentioned before, the code is implemented as a procedure thattakes one parameter.</p><h3>C Definition</h3><p>In C, this looks like:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    #include &lt;Types.h&gt;    #include &lt;Quickdraw.h&gt;    void FEEDER(Rect *r)    {        &lt;Code to present and handle dialog...&gt;</pre>	</TD></TR></TABLE></CENTER><p>Since the assembler converts all labels to uppercase, the name of the procedure<code>FEEDER</code> must be capitalized to match the case of the label in the jumptable.  If you are using MPW, you can use the assembler's <code>CASE</code>directive to prevent the assembler from capitalizing the labels.  Since therectangle is passed using the C calling convention (i.e., the caller strips theparameter), there is no need to declare the procedure as type <code>Pascal</code>.However, this convention does make things a little more interesting for thePascal version:</p><h3>Pascal Definition</h3><p>If you are using MPW, you can use the Pascal compiler's <code>C</code> directive todefine the Feeder procedure as using the C calling convention.  This makes thedefinition look like this:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    UNIT FeederSample;        INTERFACE            USES Types, Quickdraw;        PROCEDURE Feeder(r: Rect); C;        IMPLEMENTATION        PROCEDURE Feeder(r: Rect);        BEGIN            &lt;Code to present and handle dialog...&gt;        END;</pre>	</TD></TR></TABLE></CENTER><p>So this is straightforward.  The procedure Feeder is defined as having oneparameter (r), and the C directive is used so that the stack is handledcorrectly.</p><p>If you are using some other development environment that doesn't support the Cdirective, you have to do a little more work, making the definition look likethis:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    UNIT FeederSample;        INTERFACE            USES Types, Quickdraw;        PROCEDURE Feeder;        IMPLEMENTATION        FUNCTION StealRectalParam: Rect;            INLINE    $2EAE, 0008;        { MOVE.L        8(A6),(A7) }        PROCEDURE Feeder;        VAR            r:    Rect;        BEGIN            r := StealRectalParam;            &lt;Code to present and handle dialog...&gt;        END;</pre>	</TD></TR></TABLE></CENTER><p>First of all, a unit is defined, and the proper interfaces are included.  Thedefinition of the <code>Feeder</code> procedure in the <code>INTERFACE</code> sectionis required to make the label available to external modules.  In the<code>IMPLEMENTATION</code> section, one starts with the <code>StealRectalParam</code>function, which is used to get the rectangle passed by the Printing Managerwithout actually removing it from the stack.  If you declared the rectangle asa parameter to the <code>Feeder</code> procedure, <code>Feeder</code> would remove theparameter before returning, then when the caller tried to remove the parameteragain, the stack would be invalid and would cause a crash.</p><p>To solve this problem, define the <code>Feeder</code> procedure with no parameters.This way, the <code>Feeder</code> procedure leaves the parameter right where thecaller left it.  To get the parameter without removing it from the stack, usethe <code>StealRectalParam</code> function, which moves the parameter from itsnormal location (off of <code>A6</code>) into the location pointed to by the stackpointer.  Since <code>StealRectalParam</code> is a function, the stack pointer isalready pointing to the return value.  When <code>StealRectalParam</code> returns,the <code>Feeder</code> routine gets the rectangle parameter, without havingremoved it from the stack.</p><h3>Tickled Link</h3><p>Now you have the jump table and the code, but you still need to link themtogether.  This step is pretty simple, but remember to specify the startinglocation of the jump table.  It looks like the following:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    Link -w -t feed -c ZzZz -rt feed=-8192 -m START -sg Feeder [[partialdiff]]        Feeder.a.o [[partialdiff]]              # This file MUST be first.        Feeder.p.o [[partialdiff]]        &quot;{Libraries}&quot;Runtime.o [[partialdiff]]        &quot;{Libraries}&quot;Interface.o [[partialdiff]]        &quot;{PLibraries}&quot;SANELib.o [[partialdiff]]        &quot;{PLibraries}&quot;PasLib.o [[partialdiff]]</pre>	</TD></TR></TABLE></CENTER><p>First tell the linker to link the code into a <code>'feed'</code> resource with anID of -8192.  Next, specify that the resource begins with the code at label<code>START</code>.  This label was defined by the assembly-language used togenerate the jump table.  Finally, tell the linker to link all of the code intoa single segment named <code>Feeder</code>.  Obviously, the list of libraries andobject files changes depending upon the language used, but the directives tothe Link command should remain the same.</p><h3>Well Fed</h3><p>So that should be enough to get some code into the <code>'feed'</code> resource.Now you need to actually control the feeder during the print job.  To do this,you must use PostScript.  Your driver should also provide a <code>'feed'</code>resource of -8191 containing PostScript code.  This code is downloaded by theLaserWriter driver prior to downloading the rest of the job.  For thosefamiliar with the <code>'PREC'</code> 103 resource, the PostScript in the<code>'feed'</code> resource is downloaded <b>before</b> the <code>'PREC'</code> 103code.  Additional PostScript to be downloaded can be stored in <code>'feed'</code>-8190.  The PostScript code in the <code>'feed'</code> resource should redefine(i.e., patch) the PostScript operators required to handle switching feeders.  Alikely candidate is the <code>showpage</code> operator called at the end of eachpage.  As always, calling or redefining operators defined by the LaserPrep (md)dictionary is not supported.  If your device is connected via the LaserWriter'sserial port, you can license code from Adobe Systems, Inc. that makes itpossible to access the serial port while the LaserWriter is connected overAppleTalk.  For more information, contact Adobe at:</p><p>            Adobe Systems, Inc.<br>            1585 Charleston Road<br>            Mountain View, CA  94043<br>            (415) 961-4400</p><P>Once a user has confirmed the configuration from the dialog box, you can editthe PostScript code in the -8191 resource to reflect the choices made.However, when MultiFinder is active, you cannot add or change the size ofresources in the LaserWriter driver.  For this reason, you should pad the<code>'feed' </code>-8191 resource to the maximum size.  This padding can be doneby adding spaces at the end.  If you later need to resize the resource, you cansimply overwrite some of the spaces.  For more information on printer driversunder MultiFinder, see the <i>Learning to Drive</i> document, which is part of"Developer Essentials," and is available on AppleLink, the Apple FTP site, andthe Developer CD Series.</p><p>You probably need to provide other resources along with the <code>'feed'</code>resources; for example, you need <code>'DITL'</code> and <code>'DLOG'</code> resourcesfor the dialog box.  This is okay, but you should be sure to pick uniqueresource types to avoid confusing the LaserWriter driver.  In the case of aFeeder button, you are a guest in someone else's house.  It would be wise toavoid rearranging the furniture.</p><p>When the LaserWriter driver actually opens the connection to the printer, itlooks for <code>'feed'</code> resources -8191 and -8190.  If they exist, they aredownloaded.  For those familiar with the <code>'PREC' 103 </code>method ofdownloading PostScript code (refer to Technical Note #192, Surprised inLaserWriter 5.2 and Newer), the <code>'feed'</code> resources are downloaded<b>before</b> the <code>'PREC' 103 </code>resource.  In the case of backgroundprinting, the resources are copied into the spool file.  Since <code>'feed'</code>resources -8191 and -8190 are automatically downloaded by the LaserWriter, theymust contain PostScript code.  The format of these PostScript resources is astring of ASCII characters without any length byte or terminator.  The size ofthe string is determined by the size of the resource; there are no special sizerestrictions on these resources, and their only requirement is that theycontain PostScript code.  To make debugging easier, you should separate linesof PostScript using a carriage return character (13 or $0D hex).</p><P><A HREF="#top">Back to top</A></P><a name="Section5"></a><h2>Don't Feed The Print Monster</h2><p>One last important note concerns the 6.1 version of the LaserWriter driver,shipped on the Macintosh Printing Tools disk included with the PersonalLaserWriter LS and StyleWriter.  In this version of the driver, the Feederbutton will only work when Background printing is disabled.  There is a problemwith the driver finding the 'feed' resources when Background printing isenabled.  This problem has been solved in the 7.0 version of the driver whichshould be used instead of the 6.1 driver as soon as it is available.  Sincethere is no workaround for the problem, you don't really have to do anythingexcept for possibly noting it in your documentation.  Any note should recommendupgrading to the 7.0 version of the driver as soon as possible.</p><P><A HREF="#top">Back to top</A></P><a name="Section6"></a><h2>Driving Miss Lasey</h2><p>Now that you have the two or three <code>'feed'</code> resources, the big questionis installation.  How should you ship these things?  There are two methods.The first method involves licensing the LaserWriter driver from Apple SoftwareLicensing (SW.License on AppleLink).  This method is only required for"turn-key" systems, where all installation is done for the user and you mustship the LaserWriter driver as part of your product.  The second method, whichis by and large preferred as it requires no licensing, is to ship yourresources in an installer application.  This application simply opens theLaserWriter file and adds the necessary resources.</p><P><A HREF="#top">Back to top</A></P><a name="Section7"></a><h2>Conclusion</h2><p>So this should be all the information you need to implement the feed resourcesfor your device.  If you intend to drive a sheet feeder through theLaserWriter's serial port, be sure to contact Adobe Systems, Inc. for the mostcurrent implementation and licensing information.  Although the Feeder buttoncould theoretically be used for other purposes, it will always be labeled"Feeder" by the LaserWriter driver.  Because of this consistency, developersshould not attempt to extend its functionality beyond support for sheetfeeders.</p><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><P>PostScript Language Reference Manual, Adobe Systems Inc.</p><P>Technical Note M.IM.LWDriverSuprises -- <A HREF = "pr_20.html">Surprises in LaserWriter 5</A></p><P>PostScript is a registered trademark of Adobe Systems Incorporated.</p>         <P><A HREF="#top">Back to top</A></P>         <a name=Downloads></A>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (52K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/pr_15.pdf">Download</A></P>               </TD>            </TR>                    </TABLE>         <BR></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/pr/pr_15.html%3Fid%3DDTS10002636-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/pr/pr_15.html%3Fid%3DDTS10002636-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/pr/pr_15.html%3Fid%3DDTS10002636-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>