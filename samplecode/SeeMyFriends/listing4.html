<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
   "http://www.w3.org/TR/1999/REC-html401-19991224/loose.dtd">
<html>
<head>

	<!-- BEGIN META TAG INFO -->
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="home" href="http://developer.apple.com/">
	<link rel="find" href="http://developer.apple.com/search/">
	<link rel="stylesheet" type="text/css" href="../../documentation/css/adcstyle.css" title="fonts">
	<script language="JavaScript" src="../../documentation/js/adc.js" type="text/javascript"></script>
	<!-- END META TAG INFO -->
	
	<!-- BEGIN TITLE -->
	<title>SeeMyFriends - /SMFPeopleView.m</title>
	<!-- END TITLE -->
<script language="JavaScript">
function JumpToNewPage() {
	window.location=document.scpopupmenu.gotop.value;
	return true;
}
</script>

</head>

<!-- BEGIN BODY OPEN -->
<body>
<!--END BODY OPEN -->

<!-- START CENTER OPEN -->
<center>
<!-- END CENTER OPEN -->

	<!-- BEGIN LOGO AND SEARCH -->
	<!--#include virtual="/includes/adcnavbar"-->
	<!-- END LOGO AND SEARCH -->
		
		
	<!-- START BREADCRUMB -->
	<div id="breadcrumb">
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td scope="row"><img width="340" height="10" src="images/1dot.gif" alt=""></td>
			<td><img width="340" height="10" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr valign="middle">
			<td align="left" colspan="2">
			<a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../samplecode/index.html">Sample Code</a> &gt; <a href="../../samplecode/AppleApplications/index.html">Apple Applications</a> &gt; <a href="../../samplecode/AppleApplications/idxiSync-date.html">iSync</a> &gt; <A HREF="javascript:location.replace('index.html');">SeeMyFriends</A> &gt; 
			</td>
		</tr>
		<tr>
			<td colspan="2" scope="row"><img width="680" height="35" src="images/1dot.gif" alt=""></td>
		</tr>
	</table>
	</div>
	<!-- END BREADCRUMB -->

	

	<!-- START MAIN CONTENT -->
	
	<!-- START TITLE GRAPHIC AND INTRO-->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td><h1><div id="pagehead">SeeMyFriends</div></h1></td>
		</tr>
	</table>
	<!-- END TITLE GRAPHIC AND INTRO -->
	<!-- START WIDE COLUMN -->
	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr align="left" valign="top">
			<td id="scdetails">
				<h2>/SMFPeopleView.m</h2>
				<form name="scpopupmenu" onSubmit="return false;" method=post>
				<p><strong>View Source Code:</strong> 
					<select name="gotop" onChange="JumpToNewPage();" style="width:340px"><option selected value="ingnore">Select File</option>
<option value="listing1.html">/main.m</option>
<option value="listing2.html">/ReadMe.txt</option>
<option value="listing3.html">/SMFPeopleView.h</option>
<option value="listing4.html">/SMFPeopleView.m</option>
<option value="listing5.html">/SMFWindowController.h</option>
<option value="listing6.html">/SMFWindowController.m</option></select>
				</p>
				</form>
				<p><strong><a href="SeeMyFriends.zip">Download Sample</a></strong> (&#147;SeeMyFriends.zip&#148;, 87.2K)<BR>
<strong><a href="SeeMyFriends.dmg">Download Sample</a></strong> (&#147;SeeMyFriends.dmg&#148;, 147.8K)</p>
				<!--
				<p><strong><a href="#">Download Sample</a></strong> (&#147;filename.sit&#148;, 500K)</p>
				-->
			</td>
		</tr>
		<tr>
			<td scope="row"><img width="680" height="10" src="images/1dot.gif" alt=""><br>
			<img height="1" width="680" src="images/1dot_919699.gif" alt=""><br>
			<img width="680" height="20" src="images/1dot.gif" alt=""></td>
		</tr>
		<tr>
			<td scope="row">
	<!--googleon: index -->
<pre class="sourcecodebox">/*
 IMPORTANT: This Apple software is supplied to you by Apple Computer,
 Inc. (&quot;Apple&quot;) in consideration of your agreement to the following terms,
 and your use, installation, modification or redistribution of this Apple
 software constitutes acceptance of these terms.  If you do not agree with
 these terms, please do not use, install, modify or redistribute this Apple
 software.
 
 In consideration of your agreement to abide by the following terms, and
 subject to these terms, Apple grants you a personal, non-exclusive
 license, under Apple's copyrights in this original Apple software (the
 &quot;Apple Software&quot;), to use, reproduce, modify and redistribute the Apple
 Software, with or without modifications, in source and/or binary forms;
 provided that if you redistribute the Apple Software in its entirety and
 without modifications, you must retain this notice and the following text
 and disclaimers in all such redistributions of the Apple Software.
 Neither the name, trademarks, service marks or logos of Apple Computer,
 Inc. may be used to endorse or promote products derived from the Apple
 Software without specific prior written permission from Apple. Except as
 expressly stated in this notice, no other rights or licenses, express or
 implied, are granted by Apple herein, including but not limited to any
 patent rights that may be infringed by your derivative works or by other
 works in which the Apple Software may be incorporated.
 
 The Apple Software is provided by Apple on an &quot;AS IS&quot; basis.  APPLE MAKES
 NO WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION THE
 IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY AND FITNESS FOR A
 PARTICULAR PURPOSE, REGARDING THE APPLE SOFTWARE OR ITS USE AND OPERATION
 ALONE OR IN COMBINATION WITH YOUR PRODUCTS.
 
 IN NO EVENT SHALL APPLE BE LIABLE FOR ANY SPECIAL, INDIRECT, INCIDENTAL OR
 CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 INTERRUPTION) ARISING IN ANY WAY OUT OF THE USE, REPRODUCTION,
 MODIFICATION AND/OR DISTRIBUTION OF THE APPLE SOFTWARE, HOWEVER CAUSED AND
 WHETHER UNDER THEORY OF CONTRACT, TORT (INCLUDING NEGLIGENCE), STRICT
 LIABILITY OR OTHERWISE, EVEN IF APPLE HAS BEEN ADVISED OF THE POSSIBILITY
 OF SUCH DAMAGE.
 */

/*  
  SMFPeopleView.m
  SeeMyFriends
  
  Version: 1.1

  Copyright (c) 2006 Apple Computer, Inc. All rights reserved.
  
  This is the custom HIView drawing all people data.
*/

#import &lt;Carbon/Carbon.h&gt;
#import &quot;SMFPeopleView.h&quot;
#import &quot;SMFWindowController.h&quot;

// -----------------------------------------------------------------------------
//  constants
// -----------------------------------------------------------------------------
//

extern SMFWindowController *gMainWindowController;

#pragma mark -- CUSTOM HIVIEW FUNCTION DECLARATION -- 
OSStatus SMFPeopleViewRegister();
OSStatus SMFPeopleViewHandler(EventHandlerCallRef inCallRef, EventRef  inEvent,void *inUserData );

OSStatus SMFPeopleViewConstruct(EventRef inEvent );
OSStatus SMFPeopleViewDestruct(EventRef  inEvent, SMFPeopleViewData *inData );

OSStatus SMFPeopleViewDraw(EventRef  inEvent,SMFPeopleViewData *inData );
OSStatus SMFPeopleComputeEfficientSizeChange(EventRef inEvent, SMFPeopleViewData *inData );

OSStatus SMFPeopleViewGetData(EventRef inEvent, SMFPeopleViewData *inData );
OSStatus SMFPeopleViewSetData(EventRef inEvent, SMFPeopleViewData *inData );
OSStatus SMFPeopleViewSetOwningWindow(EventRef inEvent, SMFPeopleViewData *inData );

OSStatus SMFPeopleViewScrollableGetInfo(EventRef inEvent,SMFPeopleViewData *inData);
OSStatus SMFPeopleViewScrollableScrollTo(EventRef inEvent,SMFPeopleViewData *inData);


#pragma mark -- CUSTOM HIVIEW FUNCTION DEFINITIONS -- 
pascal OSStatus SMFPeopleViewHandler(EventHandlerCallRef  inCallRef, EventRef  inEvent,void *inUserData )
{
  OSStatus        err = eventNotHandledErr;
  UInt32          eventClass = GetEventClass( inEvent );
  UInt32          eventKind = GetEventKind( inEvent );
  SMFPeopleViewData*    data = (SMFPeopleViewData*) inUserData;

  switch ( eventClass )
  {
    case kEventClassHIObject:
    {
      switch ( eventKind )
      {
        case kEventHIObjectConstruct:
          err = SMFPeopleViewConstruct( inEvent );
          break;

        case kEventHIObjectDestruct:
          err = SMFPeopleViewDestruct( inEvent, data );
          break;
      }
    }
    break;
    
    case kEventClassControl:
    {
      switch ( eventKind )
      {

        case kEventControlDraw:
          err = SMFPeopleViewDraw( inEvent, data );
          break;
                        
        case kEventControlGetData:
          err = SMFPeopleViewGetData( inEvent, data );
          break;

        case kEventControlSetData:
          err = SMFPeopleViewSetData( inEvent, data );
          break;
        
        case kEventControlOwningWindowChanged:
          err = SMFPeopleViewSetOwningWindow( inEvent, data );
          break;
        
        case kEventControlInvalidateForSizeChange:        
          err = SMFPeopleComputeEfficientSizeChange( inEvent, data );
          break;
      }      
    }
    break;
    
    case kEventClassScrollable:
    {
      //We need to support these events as we need to be embeddded in a scroll view.
      
      switch ( eventKind ) {
        case kEventScrollableGetInfo:
          err = SMFPeopleViewScrollableGetInfo(inEvent, data);
          break;
          
        case kEventScrollableScrollTo:
          err = SMFPeopleViewScrollableScrollTo(inEvent, data);
          break;
      }
    }
  }
  
  return err;
}

// -----------------------------------------------------------------------------
//  SMFPeopleViewConstruct
// -----------------------------------------------------------------------------
//
OSStatus SMFPeopleViewConstruct(EventRef inEvent )
{
  OSStatus      err;
  SMFPeopleViewData*  data;
  SInt32 tmpInt32;
  
  // don't CallNextEventHandler!
  data = (SMFPeopleViewData*) malloc( sizeof( SMFPeopleViewData ) );
  require_action( data != NULL, EXIT, err = memFullErr );

  // Geometry
  data-&gt;_nbTotal = 0;
  data-&gt;_nbColumn = kPeopleViewNbColumnInit; //For now let's start at height
  data-&gt;_origX = 0.0;
  data-&gt;_origY = 0.0;
  data-&gt;changeDirection = 0;

  err = GetThemeMetric(kThemeMetricScrollBarWidth, &amp;tmpInt32);
  require_noerr( err, EXIT );
  data-&gt;_scrollBarWidth = (float) tmpInt32;

  //cache the icon
  err = GetIconRef(kOnSystemDisk, kSystemIconsCreator, kUnknownFSObjectIcon, &amp;data-&gt;_noImageIcon);
  require_noerr( err, EXIT );
  
  // Keep a copy of the created HIViewRef
  err = GetEventParameter( inEvent, kEventParamHIObjectInstance, typeHIObjectRef, NULL, sizeof( HIObjectRef ), NULL, (HIObjectRef*) &amp;data-&gt;view );
  require_noerr( err, EXIT );
  
  // Set the userData that will be used with all subsequent eventHandler calls
  err = SetEventParameter( inEvent, kEventParamHIObjectInstance, typeVoidPtr, sizeof( SMFPeopleViewData* ), &amp;data ); 

EXIT:
  if ( err != noErr )
    free( data );

  return err;
}


// -----------------------------------------------------------------------------
//  SMFPeopleViewDestruct
// -----------------------------------------------------------------------------
//
OSStatus SMFPeopleViewDestruct(EventRef  inEvent, SMFPeopleViewData*  inData)
{
#pragma unused( inEvent )
  // Clean up any allocated data
  ReleaseIconRef(inData-&gt;_noImageIcon);
  free( inData );
  return noErr;
}


// -----------------------------------------------------------------------------
//  SMFPeopleViewDraw
// -----------------------------------------------------------------------------
//
OSStatus SMFPeopleViewDraw(EventRef  inEvent, SMFPeopleViewData*  inData )
{
  OSStatus      err;
  HIRect        bounds;
  float        rowHeight;
  float        colWidth;
  int          cols;
  float        rows = 0;
  int          emptys = 0;
  HIRect        drawRect, tmpRect, textRect, imageRect;
  ControlPartCode    part;
  int          idx, i, size;
  CGContextRef    drawContext;
  CFTypeRef *      values;
  
  // Get ready to do the CG drawing boogaloo!
  err = GetEventParameter( inEvent, kEventParamCGContextRef, typeCGContextRef, NULL, sizeof( CGContextRef ), NULL, &amp;drawContext );
  require_noerr( err, EXIT );

  cols = inData-&gt;_nbColumn;
  
  if(0 == inData-&gt;_nbTotal) {

    err = HIViewGetBounds( inData-&gt;view, &amp;bounds );
    CGContextSetRGBFillColor( drawContext, 0.95, .95, .95, 1 );
    CGContextFillRect(drawContext, bounds);
  
  } else {
    
    HIThemeTextInfo txtInfo;
    CFDictionaryRef tmpPeople = [gMainWindowController allPeople];
    size = CFDictionaryGetCount(tmpPeople);
    values = (CFTypeRef *) malloc( size * sizeof(CFTypeRef) );
    CFDictionaryGetKeysAndValues(tmpPeople, NULL, (const void **) values);
  
    txtInfo.version = kHIThemeTextInfoVersionZero;
    txtInfo.state = kThemeStateActive;
    txtInfo.fontID = kThemeSmallSystemFont;
    txtInfo.horizontalFlushness = kHIThemeTextHorizontalFlushCenter;
    txtInfo.verticalFlushness = kHIThemeTextVerticalFlushBottom;
    txtInfo.options = 0;
    txtInfo.truncationPosition = kHIThemeTextTruncationEnd;
    txtInfo.truncationMaxLines = 1;
    
    emptys = inData-&gt;_nbTotal % cols;
    rows = 1 + ((inData-&gt;_nbTotal - emptys) / cols);

    drawRect.origin.x = 0;
    drawRect.origin.y = 0;
    drawRect.size.width = (float) kOnePeopleViewWidth;
    drawRect.size.height = (float) kOnePeopleViewHeigth;
    
    textRect = CGRectMake(drawRect.origin.x, drawRect.origin.y, drawRect.size.width, drawRect.size.height);
    textRect.origin.y -= 5.0;

    imageRect.origin.x = (kOnePeopleViewWidth - 32)/2;
    imageRect.origin.y = 5.0;
    imageRect.size.width = imageRect.size.height = 32;
    
    idx = i = 0;
    
    HIRect theRect;
    HIViewGetFrame(inData-&gt;view, &amp;theRect);

    HIRect theVisRect = CGRectMake(-inData-&gt;_origX, -inData-&gt;_origY, theRect.size.width, theRect.size.height);
    
    //This is the core drawing method for one contact. No real error checkin done in this sample. 
    //Basically it draws one people and then move to the next position.
    for(i = 0; i &lt; size; i++) {
      if(CGRectIntersectsRect(theVisRect, drawRect)) {
        //Draw background and border
        if(!CFBooleanGetValue(CFDictionaryGetValue((CFDictionaryRef) values[i], CFSTR(&quot;SearchSelected&quot;))))      
          CGContextSetRGBFillColor( drawContext, 1, 1, 1, 1 );          
        else 
          CGContextSetRGBFillColor( drawContext, 0.56, 0.70, 0.92, 1 );          
          
        CGContextFillRect(drawContext, drawRect);            
        CGRectInset(drawRect, 1, 1);
        CGContextSetRGBStrokeColor(drawContext, 0.95, .95, .95, 1);
        CGContextStrokeRect(drawContext, drawRect);  
          
          //Draw Name
        CGContextSetRGBFillColor( drawContext, 0, 0, 0, 1 );          
        CFStringRef tmpString = CFDictionaryGetValue((CFDictionaryRef) values[i], CFSTR(&quot;FullName&quot;));
        HIThemeDrawTextBox(tmpString, &amp;textRect, &amp;txtInfo, drawContext, kHIThemeOrientationNormal);
          //Draw image
        if(CFDictionaryContainsKey(values[i], CFSTR(&quot;image&quot;)))
          HIViewDrawCGImage(drawContext , &amp;imageRect, (CGImageRef) CFDictionaryGetValue((CFDictionaryRef) values[i], CFSTR(&quot;image&quot;)));
        else
          PlotIconRefInContext(drawContext, &amp;imageRect, kAlignAbsoluteCenter, kTransformNone, NULL, kPlotIconRefNormalFlags, inData-&gt;_noImageIcon);        
      }
      
      //update the position
      if(++idx == cols) {
        idx = 0;
        drawRect.origin.x = textRect.origin.x = 0.0;
        imageRect.origin.x = (kOnePeopleViewWidth - 32)/2;

        drawRect.origin.y+= kOnePeopleViewHeigth;
        textRect.origin.y+= kOnePeopleViewHeigth;
        imageRect.origin.y+= kOnePeopleViewHeigth;
      } else {
        drawRect.origin.x += kOnePeopleViewWidth;
        textRect.origin.x += kOnePeopleViewWidth;
        imageRect.origin.x += kOnePeopleViewWidth;
      }
    }
    
    if(0 != idx) {
      //there is some place on the right,let's colorize it as grey.
      CGRect leftOverRect = CGRectMake(drawRect.origin.x , drawRect.origin.y, (cols -idx) * kOnePeopleViewWidth , kOnePeopleViewHeigth);
      CGContextSetRGBFillColor( drawContext, 0.90, .90, .90, 1 );
      CGContextFillRect(drawContext, leftOverRect);
    } 
    
    err = HIViewGetBounds(inData-&gt;view, &amp;tmpRect);    
    if (drawRect.origin.y + drawRect.size.height &lt; tmpRect.size.height) {
      //there is some place below,let's colorize it as grey.
      if(0 != idx) {
        tmpRect.origin.y = drawRect.origin.y + drawRect.size.height;
        tmpRect.size.height  -= (drawRect.origin.y + drawRect.size.height);
      } else {
        tmpRect.origin.y = drawRect.origin.y + drawRect.size.height - kOnePeopleViewHeigth;
        tmpRect.size.height  -= (drawRect.origin.y + drawRect.size.height);
        tmpRect.size.height += kOnePeopleViewHeigth;
      }
      CGContextSetRGBFillColor( drawContext, 0.95, .95, .95, 1 );
      CGContextFillRect(drawContext, tmpRect);
    }    
  }

EXIT:
  return err;
}

OSStatus SMFPeopleComputeEfficientSizeChange(EventRef inEvent, SMFPeopleViewData *inData )
{
  OSStatus err = eventNotHandledErr;
  HIViewRef tmpCtl;
  HIShapeRef previousShape, newShape, updateShape;
  HIRect  previousRect, newRect;

  err = GetEventParameter( inEvent, kEventParamOriginalBounds, typeHIRect, NULL, sizeof( HIRect ), NULL, &amp;previousRect );
  require_noerr( err, EXIT );
  
  err = GetEventParameter( inEvent, kEventParamCurrentBounds, typeHIRect, NULL, sizeof( HIRect ), NULL, &amp;newRect );
  require_noerr( err, EXIT );

  previousShape = HIShapeCreateWithRect(&amp;previousRect);
  newShape = HIShapeCreateWithRect(&amp;newRect);  
  updateShape = HIShapeCreateDifference(newShape, previousShape);  

  if(!HIShapeIsEmpty(updateShape)) {
    err = HIViewSetNeedsDisplayInShape(inData-&gt;view, updateShape, true);
  }
  
  CFRelease(previousShape);
  CFRelease(newShape);
  CFRelease(updateShape);

EXIT:
  return err;
}

// -----------------------------------------------------------------------------
//  SMFPeopleViewGetData
// -----------------------------------------------------------------------------
//
OSStatus SMFPeopleViewGetData(EventRef  inEvent,SMFPeopleViewData *inData )
{
  OSStatus        err;
  OSType          tag;
  Ptr            ptr;
  Size          size;
  Size          outSize;
  ControlPartCode      part;
  
  err = GetEventParameter( inEvent, kEventParamControlPart, typeControlPartCode, NULL, sizeof( ControlPartCode ), NULL, &amp;part );
  require_noerr( err, EXIT );

  err = GetEventParameter( inEvent, kEventParamControlDataTag, typeEnumeration, NULL, sizeof( OSType ), NULL, &amp;tag );
  require_noerr( err, EXIT );

  err = GetEventParameter( inEvent, kEventParamControlDataBuffer, typePtr, NULL, sizeof( Ptr ), NULL, &amp;ptr );
  require_noerr( err, EXIT );

  err = GetEventParameter( inEvent, kEventParamControlDataBufferSize, typeLongInteger, NULL, sizeof( Size ), NULL, &amp;size );
  require_noerr( err, EXIT );

  switch ( tag )
  {
    case kControlSMFPeopleNumberTag:
      if ( size == sizeof( int ) )
        *( (int*) ptr ) = inData-&gt;_nbTotal;
      else
        err = errDataSizeMismatch;
      outSize = sizeof( int );
      break;
    case kControlSMFPeopleMaxColNumberTag:
      if ( size == sizeof( float ) )
        *( (float*) ptr ) = inData-&gt;_nbColumn;
      else
        err = errDataSizeMismatch;
      outSize = sizeof( float );
      break;
    default:
      err = errDataNotSupported;
      outSize = 0;
      break;
  }

  if ( err == noErr )
    err = SetEventParameter( inEvent, kEventParamControlDataBufferSize, typeLongInteger, sizeof( Size ), &amp;outSize );

EXIT:
  return err;
}

// -----------------------------------------------------------------------------
//  SMFPeopleViewSetData
// -----------------------------------------------------------------------------
//
OSStatus SMFPeopleViewSetData(EventRef inEvent, SMFPeopleViewData *inData )
{
  OSStatus        err;
  ControlPartCode      part;
  OSType          tag;
  Ptr            ptr;
  Size          size;
  
  err = GetEventParameter( inEvent, kEventParamControlPart, typeControlPartCode, NULL, sizeof( ControlPartCode ), NULL, &amp;part );
  require_noerr( err, EXIT );

  err = GetEventParameter( inEvent, kEventParamControlDataTag, typeEnumeration, NULL, sizeof( OSType ), NULL, &amp;tag );
  require_noerr( err, EXIT );

  err = GetEventParameter( inEvent, kEventParamControlDataBuffer, typePtr, NULL, sizeof( Ptr ), NULL, &amp;ptr );
  require_noerr( err, EXIT );

  err = GetEventParameter( inEvent, kEventParamControlDataBufferSize, typeLongInteger, NULL, sizeof( Size ), NULL, &amp;size );
  require_noerr( err, EXIT );

  switch ( tag )
  {
    case kControlSMFPeopleNumberTag:  
    {
      if ( size == sizeof( int ) )
        inData-&gt;_nbTotal = *( (int*) ptr );
      else
        err = errDataSizeMismatch;
      //here we need to compute the bounds again
      HIRect bounds, frames;
      
      err = HIViewGetFrame( inData-&gt;view, &amp;frames );
      int emptys = inData-&gt;_nbTotal % inData-&gt;_nbColumn;
      int rows = 1 + ((inData-&gt;_nbTotal - emptys) / inData-&gt;_nbColumn);
      frames.size.height = rows *kOnePeopleViewHeigth;
      frames.size.width = inData-&gt;_nbColumn *kOnePeopleViewWidth;
      err = HIViewSetFrame( inData-&gt;view, &amp;frames );
      
      EventRef tmpEvent;
      MacCreateEvent(kCFAllocatorDefault, kEventClassScrollable, kEventScrollableInfoChanged, 0, kEventAttributeNone, &amp;tmpEvent);
      SendEventToControl(tmpEvent, HIViewGetSuperview(inData-&gt;view));
      ReleaseEvent(tmpEvent);
      break;
    }
    case kControlSMFPeopleMaxColNumberTag:
      if ( size == sizeof( float ) ) {
        inData-&gt;_nbColumn = *( (float*) ptr );
         err= SMFPeopleViewSetOwningWindow(inEvent, inData ); //we reconstrain the limits
      } else
        err = errDataSizeMismatch;
      break;
    default:
      err = errDataNotSupported;
      break;
  }

EXIT:
  return err;
}

OSStatus SMFPeopleViewSetOwningWindow(EventRef inEvent, SMFPeopleViewData *inData )
{
  OSStatus err;
  HISize   outMinLimits,outMaxLimits;
  WindowRef owningWindow;
  
  //In fact we just use this event to constraint the owning window size, to the number of columns allowed.
  //The owning window never changes... really.
  owningWindow = HIViewGetWindow(inData-&gt;view);
  require_action(NULL != owningWindow, EXIT, err = errInvalidWindowRef);
  
  //set up size limit to adapt to the number of rows
  err = GetWindowResizeLimits(HIViewGetWindow(inData-&gt;view), &amp;outMinLimits, &amp;outMaxLimits);
  require_noerr( err, EXIT );
  
  outMaxLimits.width = (float) (inData-&gt;_nbColumn * kOnePeopleViewWidth) + inData-&gt;_scrollBarWidth;
  outMaxLimits.height = 5000; ///just put something very big... 
  err = SetWindowResizeLimits(HIViewGetWindow(inData-&gt;view), &amp;outMinLimits, &amp;outMaxLimits);

EXIT:
  return err;
}

OSStatus SMFPeopleViewScrollableGetInfo(EventRef inEvent,SMFPeopleViewData *inData)
{
  OSStatus      err;
  HIRect bounds;
          
  int emptys = inData-&gt;_nbTotal % inData-&gt;_nbColumn;
  int rows = 1 + ((inData-&gt;_nbTotal - emptys) / inData-&gt;_nbColumn);
  HISize tmpSize = {(float) inData-&gt;_nbColumn * kOnePeopleViewWidth, (float) rows*kOnePeopleViewHeigth};
  
  err = SetEventParameter(inEvent, kEventParamImageSize, typeHISize, sizeof(tmpSize), &amp;tmpSize);
  require_noerr( err, EXIT );

  HISize lineSize = {20.0, 20.0};
  err = SetEventParameter(inEvent, kEventParamLineSize, typeHISize, sizeof(lineSize), &amp;lineSize);
  require_noerr( err, EXIT );
  
  HIViewGetBounds(HIViewGetSuperview(inData-&gt;view), &amp;bounds);
  bounds.size.width -= inData-&gt;_scrollBarWidth;  
  bounds.size.height -= inData-&gt;_scrollBarWidth;  
  err = SetEventParameter(inEvent, kEventParamViewSize, typeHISize, sizeof(bounds.size), &amp;bounds.size);
  require_noerr( err, EXIT );
  
  HIPoint point = { inData-&gt;_origX, inData-&gt;_origY};
  err = SetEventParameter(inEvent, kEventParamOrigin, typeHIPoint, sizeof(point), &amp;point);

EXIT:  
  return err;
}


OSStatus SMFPeopleViewScrollableScrollTo(EventRef inEvent,SMFPeopleViewData *inData)
{
  OSStatus err = noErr;
  HIPoint tmpPoint;
  
  err = GetEventParameter( inEvent, kEventParamOrigin, typeHIPoint, NULL, sizeof( tmpPoint ), NULL, &amp;tmpPoint);
  require_noerr( err, EXIT );
  
  inData-&gt;_origX = -tmpPoint.x;
  inData-&gt;_origY = -tmpPoint.y;
  
  err = HIViewSetBoundsOrigin(inData-&gt;view, -inData-&gt;_origX, -inData-&gt;_origY);
  require_noerr( err, EXIT );
  
  err = HIViewSetNeedsDisplay(inData-&gt;view, true);

EXIT:
  return err;
}

//the registration function for our custom HIView. 
OSStatus SMFPeopleViewRegister()
{
  OSStatus        err = noErr;
  static HIObjectClassRef  sSMFPeopleViewClassRef = NULL;

  if ( sSMFPeopleViewClassRef == NULL )
  {
    EventTypeSpec    eventList[] = {
      { kEventClassHIObject, kEventHIObjectConstruct },
      { kEventClassHIObject, kEventHIObjectDestruct },
      { kEventClassControl, kEventControlDraw },
      { kEventClassControl, kEventControlInvalidateForSizeChange},
      { kEventClassControl, kEventControlGetData },
      { kEventClassScrollable, kEventScrollableGetInfo },
      { kEventClassScrollable, kEventScrollableScrollTo },
      { kEventClassControl, kEventControlOwningWindowChanged },
      { kEventClassControl, kEventControlSetData }};

    err = HIObjectRegisterSubclass(kSMFPeopleViewClassID,kHIViewClassID,0,
      SMFPeopleViewHandler,GetEventTypeCount( eventList ),eventList,NULL, &amp;sSMFPeopleViewClassRef );
  }
  
  return err;
}
</pre>
	<!--googleoff: index -->
			</td>
		</tr>
	</table>
	<!-- END WIDE COLUMN -->

	<!-- END MAIN CONTENT -->
		<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/samplecode/SeeMyFriends/listing4.html%3Fid%3DDTS10003683-1.1&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/samplecode/SeeMyFriends/listing4.html%3Fid%3DDTS10003683-1.1&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/samplecode/SeeMyFriends/listing4.html%3Fid%3DDTS10003683-1.1&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>

	<!-- START BOTTOM APPLE NAVIGATION -->
	<!--#include virtual="/includes/footer"-->
	<!-- END BOTTOM APPLE NAVIGATION -->

<!-- START CENTER CLOSE -->
</center>
<!-- END CENTER CLOSE -->

</body>
</html>