<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TN1083: Weak-Linking to a Code Fragment Manager-based Shared Library</title>    <meta name="keywords" content="Mac OS 8 CFM code fragment manager weak-linking shared library">    <meta name="Description" content="Technical Note TN1083: This Technical Note describes howto weak-link to a CFM-based shared library, and                                         how to check to make surethat the library is available at runtime. "> <meta name="categories" content="Runtime Architecture"><meta name="week-posted" content="Oct 28, 1996 - Nov 1, 1996"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002924" title="Weak-Linking to a Code Fragment Manager-based Shared Library"></a><A NAME="top"></A><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/Carbon/index.html">Carbon</a> &gt; <a href="../../technicalnotes/Carbon/idxRuntimeArchitecture-date.html">Runtime Architecture</a> &gt; </p><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1083</div>
<div id="pageheadsub">Weak-Linking to a Code Fragment Manager-based Shared Library</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"> <!-- begin_header_box --> <table width="600" cellpadding="0" cellspacing="0" border="0">	<tr>		<td width=300 valign="top" align=left scope="row">			<table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>				</tr>				<tr bgcolor="#e6e6e6">					<td background="images/tnmenubody.gif" width=300 align=left>						<span id="menutitle">							CONTENTS                             <br>                            <br>						</span>					</td>				</tr>				<tr bgcolor="#e6e6e6">					<td background="images/tnmenubody.gif" width=300 align=left><!-- begin_toc --><p id="menutext">    <A HREF = "#Section1">The Old Way: Installing Gestalt Selectors     and Calls into Trap Tables</a><BR><BR>    <A HREF = "#Section2">The New Way: Shared Libraries</a><BR><BR>    <A HREF = "#Section3">Checking the Library Imports</a><BR><BR>    <A HREF = "#Section4">Gestalt is Not Enough!</a><BR><BR>    <A HREF = "#Summary">Summary</a><BR><BR>    <A HREF = "#References">References</a><BR><BR>    <A HREF="#Downloads">Downloadables</A></p>                  <!-- end_toc --> 								</td>				</tr>				<tr>					<td width=300 align=left scope="row">						<img src="images/tnmenubottom.gif" alt="" width=300 height=16>					</td>				</tr>			</table>		</td>		<td width=300 valign="top" align=left>			<!-- begin_intro_text -->    <P id = "introtext">Many pieces of the Mac OS are now distributed as shared libraries, including (but not limited to) QuickTime, QuickDraw 3D, Apple Game Sprockets, and the Color Picker. In many cases, developers want to use a particular technology without always having to rely on its being present. While the Mac OS has had multiple technologies for shared libraries in the past, Apple is now standardizing on the Code Fragment Manager (CFM). This Note describes how to weak-link to a CFM-based shared library, and how to check to make sure that the library is available at runtime.</p><P id = "introtext">This Note is aimed at all Macintosh developers who are using shared libraries.</P><!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Apr 07 1997]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_header_box --> <BR><BR><hr width=500 align=center>          <BR><BR> <!-- begin_content -->    <a name="Section1"> </a>    <H2>The Old Way: Installing Gestalt Selectors     and Calls into Trap Tables</h2>       <P>In the classic 68K model, all system functions are dispatched through the trap table. New system software features simply patch themselves into previously unused sections of the table. In order to expose these features to applications, each piece of the system software installs a Gestalt selector. Applications that want to check on a particular feature make a Gestalt call to ensure that its selector is installed. For example, code to check for QuickTime looks like this: </P><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    theErr = Gestalt (gestaltQuickTime, &amp;result);    if (theErr != noErr)            return false;    else            return true;</pre>	</TD></TR></TABLE></CENTER><P>Ultimately, there are two tests that you can perform: (1) whether a manager is available, and (2) whether specific features within that manager are available, e.g., is 32-bit QuickDraw available? In the second case, the approach was to use Gestalt bits to identify "chunks" of functionality.</P>    <H3>Problems With the Old Model</h3>        <P>Many problems arose with the old model. One was that there were a limited number of locations in the Trap Table and eventually we would run out. To work around this, multiple system calls were often placed into a single trap, with a separate selector parameter to choose the correct routine. As a consequence of this workaround, it became difficult to patch selector-based traps successfully, limiting the ability to fix bugs in the system software.</P><P>Another problem is that most patches have to be loaded at extension time, which means that they must go into the system heap. These items are loaded even if they aren't being used by any application. </P><P>If Virtual Memory is enabled, it is not allowed to swap out blocks of memory on the System Heap, because it might swap out drivers or other crucial pieces of code. As a consequence, a large system heap severely limits the amount of memory available to VM. This means that the system may spend extra time swapping code or data in and out of memory, reducing performance. </P><P>Still another problem was the difficulty of implementing and accessing global variables in pieces of code other than applications.</P><P>Given all of these limitations with the old model, it became apparent that a new model was needed.</P><P><A HREF="#top">Back to top</A></p>    <a name="Section2"></A>    <H2>The New Way: Shared Libraries</h2>        <P>The new model uses Code Fragments -- a form of shared library. All forms of code are consistently packaged as Code Fragments, with full access to global variables. When Virtual Memory is used on PowerMacs, fragments are file-mapped into memory and are marked as read-only. This results in more efficient memory usage and some protection against programming errors.</P><P>If a fragment needs access to system software features, it imports them from another library. Most pieces of the system software are imported from a library named InterfaceLib, while others (e.g., QuickTime, QuickDraw 3D) place all of their functionality into their own library.</P>    <H3>Strong-Linking</h3>    <P>By default, all import libraries are strong-linked, which means that the application requires them to be available in order for the application to launch. When a CFM-based application is launched, it attempts to import all the libraries. If it cannot prepare a strong-linked library, the Finder will display an error message. For example: </P>    <p><code>The Application "MoofWars" could not be opened because "DrawSprocketLib"     could not be found.</code></p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>    This applies to any CFM shared library, not simply an application.</P></TD></TR></TABLE></CENTER><BR>    <H3>Weak-Linking</h3>    <P>An application can specify a library as being weak-linked. If a library is weak-linked, the application will launch even if that library is not available or can't be prepared due to memory constraints. Once a weak library is missing, it stays missing until the application is relaunched. Weak-linking is not a substitute for call-time binding of imports. CFM only does prepare-time binding of imports. In order to use a weak-linked library, we now need to determine if that library was prepared.</P><P>An entire imported library may be marked weak, meaning that it can be entirely missing. Individual imported symbols may also be marked weak, which means they can individually be missing. Marking a library weak implicitly marks all symbols from that library as weak. </P><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR>    The converse is not literally true from CFM's implementation. A strong library     must be available even if all symbols imported from it are weak. A "smart" linker     would "realize" that all the imported symbols were weak and mark the entire library     as weak.</P></TD></TR></TABLE></CENTER><BR><P>There are some "implementation details" of CFM that can make its behavior appear inconsistent. Currently, almost any failure when identifying import libraries will let weak libraries pass. This may change in the future, so that weak libraries are only allowed to literally be missing. Once the library is successfully found, all other failures are fatal. This will not change: for example, if there is insufficient application heap space to allocate the library's data section, the prepare will fail. Because implementation details may change in the future, you should refer to the latest draft of <CITE>Macintosh Runtime Architectures</CITE>, cited at the end of this Note.</p><P>The development environment is responsible for providing an interface to weak-linking. For example, CodeWarrior only permits the entire library to be weak-linked. This is presented as a pop-up menu in the Project window for each source library. In MPW, by contrast, you can either mark an entire library or individual symbols. Consult the documentation of your development environment for specific information on to how mark libraries or individual symbols; the reason for this is that the features that those tools provide are always changing -- e.g., MPW is currently being revised to make it easier to weak-link individual symbols. </P><P><A HREF="#top">Back to top</A></p>    <a name="Section3"></a>    <H2>Checking the Library Imports</h2>        <P>A code fragment contains an address for each symbol that it imports. When a fragment is prepared, CFM determines the address and fills in the pointers. In C, these pointers are exactly what you get when you look at the address of the imported routine or variable. When an imported symbol is not resolved, its address will be set to kUnresolvedCFragSymbolAddress (which is just a long-winded way of saying zero).The most common method of testing whether a shared library was successfully prepared is to pick one symbol in the library and compare it to kUnresolvedCFragSymbolAddress. For example, if you weak-linked to QuickDraw 3D, you would use the following code to make sure it was successfully prepared: </P><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>#include &lt;QD3D.h&gt;#include &lt;CodeFragments.h&gt;Boolean HasQuickDraw3D (void){    return ( (Ptr) Q3Initialize != (Ptr) kUnresolvedCFragSymbolAddress);}</pre>	</TD></TR></TABLE></CENTER><P>The presence of this symbol does not necessarily mean that all other symbols are also available. For example, if you are using ColorSync 1.0 and weak-link individual symbols from ColorSync 2.0, then you would separately test for the 2.0 symbols. </P><P>Another method for testing for a library is to call <CODE>GetSharedLibrary</CODE> using the <CODE>kFindCFrag</CODE> option. In order to do so, you need to obtain the name of the import library from the library's 'cfrg' resource. </P>    <H3>A Correction to the Code in <CITE>3D Graphics Programming     With QuickDraw 3D</CITE></h3>    <P>The code provided above supersedes the code provided in <CITE>3D Graphics Programming With QuickDraw 3D</CITE>. That code casts the function pointer to a Boolean, clearing the top 24 bits before testing the address. The following disassembly shows this: </P><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>Boolean BuggyHasQuickDraw3D (void){return((Boolean) Q3Initialize != kUnresolvedCFragSymbolAddress);}00000084: 80C20000  lwz      r6,Q3Initialize(RTOC)00000088: 54C6063E  clrlwi   r6,r6,240000008C: 28060000  cmplwi   r6,$0000</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></p>    <a name="Section4"></a>    <H2>Gestalt is Not Enough!</h2><P>A few pieces of system software also include extensions that install Gestalt calls.  For example, QuickTime needs to be able to run under both CFM and the classic 68K model, so it still patches the trap table and installs a Gestalt function. QuickDraw 3D actually includes extension code that does nothing more than install a Gestalt selector.</P><P>If you are writing an PowerPC native or CFM-68K application that imports from one of these pieces of system software, it is possible for the Gestalt selector to be installed, but for the library to be unavailable to your application when it launches. So, if you weak-link to the library, you have to check both the Gestalt selector and the library imports; otherwise, your application will crash the first time you call a routine in the library: </P><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>Boolean HasQuickTime (void){    OSErr theErr = noErr;    long result;    theErr = Gestalt (gestaltQuickTime, &amp;result);    if (theErr != noErr)        return false;    theErr = Gestalt (gestaltQuickTimeFeatures, &amp;result);    if (theErr != noErr)        return false;    if (!(result &amp; (1 &lt;&lt; gestaltPPCQuickTimeLibPresent)))        return false;    // This is only required if we weak link, as the entry points for    // the QuickTime PowerPlug might not have been resolved.#if GENERATINGCFM    return ((Ptr) EnterMovies != (Ptr)kUnresolvedCFragSymbolAddress);#else    return true;#endif}</pre>	</TD></TR></TABLE></CENTER><p>Note that the Code Fragment Manager now also exists in the CFM68K runtime, so it is not sufficient merely to test for PowerPC. The header file ConditionalMacros.h sets up a number of conditionals, including GENERATINGCFM, which is set to true when compiling under PowerPC or CFM68K. Wrapping your test for weak-linked symbols in #if GENERATINGCFM is the recommended way to conditionalize the test.</p><P><A HREF="#top">Back to top</A></p><a name="Summary"></a><H2>Summary</h2><P>Apple has now standardized on the Code Fragment Manager, which offers a consistent interface for all code in the Mac OS. The Code Fragment Manager has also moved back to the 68K. Weak-linking allows a particular fragment to not be dependent on another fragment. You must test to make sure that weak-linked fragments are available before using them.</P><P><A HREF="#top">Back to top</A></p><a name="References"></a><h2>References</h2>           <p><a href="http://developer.apple.com/documentation/mac/PPCSoftware/PPCSoftware-2.html">    Inside Macintosh: PowerPC System Software</A>  </p>    <p><CITE>3D Graphics Programming With QuickDraw 3D</CITE>, p. 1-16  </p>    <p>A draft of <CITE>Macintosh Runtime Architectures</CITE>     is available in E.T.O.#21    </p><P><A HREF="#top">Back to top</A></p> <A NAME=Downloads></A>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="500">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (196K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tn1083.pdf">Download</A></P>               </TD>            </TR></TABLE><P><A HREF="#top">Back to top</A></P></TD></TR></table></center><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1083.html%3Fid%3DDTS10002924-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1083.html%3Fid%3DDTS10002924-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1083.html%3Fid%3DDTS10002924-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --><hr width=500 align=center></BODY></HTML>