<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>The Structure of a Component (IM: MTb)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING342></A>


<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="MoreToolbox-341.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="MoreToolbox-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="MoreToolbox-513.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="MoreToolbox-343.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="MoreToolbox-2.html"><B>More Macintosh Toolbox</B></A> / <BR><DD><A HREF="MoreToolbox-333.html"><B>Chapter 6 - Component Manager</B></A> / <A HREF="MoreToolbox-341.html"><B>Creating Components</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING342-0></A>
<H2><A NAME=MARKER-9-54></A>The Structure of a Component</H2>
 <A NAME=MARKER-2-7></A>Every component must have a single entry point that returns a value of type <CODE>ComponentResult</CODE> (a long integer). Whenever the Component Manager receives a request for your component, it calls your component's entry point and passes <BR>any parameters, along with information about the current connection, in a component parameters record. The Component Manager also passes a handle to the global storage (if any) associated with that instance of your component.<P>
 When your component receives a request, it should examine the parameters to determine the nature of the request, perform the appropriate processing, set an error code if necessary, and return an appropriate function result to the Component Manager.<P>
 The component parameters record is defined by a data structure of type <CODE>ComponentParameters</CODE>.<P>
<PRE>
TYPE ComponentParameters = 
      PACKED RECORD
         flags:      Char;                   {reserved}
         paramSize:  Char;                   {size of parameters}
         what:       Integer;                {request code}
         params:     ARRAY[0..0] OF LongInt; {actual parameters}
      END;
</PRE>
 The <CODE>what</CODE> field contains a value that specifies the type of request. Negative values are reserved for definition by Apple. You can use values greater than or equal to 0 to define other requests that are supported by your component. Follow these guidelines when defining your request codes: request codes between 0 and 256 are reserved for definition by components of a given type and a given type-subtype. Use request codes greater than 256 for requests that are unique to your component. For example, a certain component of a certain type-subtype might support values 0 through 5 as requests that are supported by all components of that type, values 128 through 140 as requests that are supported by all components of that given type-subtype, and values 257 through 260 as requests supported only by that component. <P>
 <A HREF=#MARKER-9-10>Table 6-1</A> shows the request codes defined by Apple and the actions your component should take upon receiving them. Note that four of the request codes--open, close, can do, and version--are required. Your component must respond to these four request codes. These request codes are described in greater detail in <A HREF=MoreToolbox-343.html#MARKER-9-59>"Handling Requests for Service" beginning on page 6-18</A>.
<TABLE BORDER="0" CELLPADDING=3>
<CAPTION><A NAME=MARKER-9-10></A><B>Table 6-1 Request codes</B> (Continued)</CAPTION>
<TH>Request code<TH>Action your component should perform<TH>Required<TR>
<TD><A NAME=MARKER-2-11></A>kComponentOpenSelect<TD>Open a connection<TD>Yes<TR>
<TD>kComponentCloseSelect<TD>Close an open connection<TD>Yes<TR>
<TD>kComponentCanDoSelect<TD>Determine whether your component supports a particular request<TD>Yes<TR>
<TD>kComponentVersionSelect<TD>Return your component's version number<TD>Yes<TR>
<TD>kComponentRegisterSelect<TD>Determine whether your component can operate in the current environment<TD>No<TR>
<TD>kComponentTargetSelect<TD>Call another component whenever it would call itself (as a result of your component being used by another component)<TD>No<TR>
<TD>kComponentUnregisterSelect<TD>Perform any operations that are necessary as a result of your component being unregistered<TD>No</TABLE>
<P>
 The example drawing component (shown in <A HREF=#MARKER-9-56>Listing 6-5 on page 6-16</A>) supports the four required request codes, and in addition supports the request codes that are required for all components of the type <CODE>'draw'</CODE>. All drawing components must support these request codes:<P>
<PRE>
CONST
      kDrawerSetUpSelect      = 0;  {set up drawing region}
      kDrawerDrawSelect       = 1;  {draw the object}
      kDrawerEraseSelect      = 2;  {erase the object}
      kDrawerClickSelect      = 3;  {determine if cursor is }
                                    { inside of the object}
      kDrawerMoveSelect       = 4;  {move the object}
</PRE>
 The <CODE>params</CODE> field of the component parameters record is an array that contains the parameters specified by the application that called your component. You can directly extract the parameters from this array, or you can use the <CODE>CallComponentFunction</CODE> or <CODE>CallComponentFunctionWithStorage</CODE> function to extract the parameters from this array and pass these parameters to a subroutine of your component (see <A HREF=MoreToolbox-373.html#MARKER-9-311>page 6-61</A> and <A HREF=MoreToolbox-374.html#MARKER-9-315>page 6-62</A> for more information about these functions).<P>
 <A HREF=#MARKER-9-56>Listing 6-5</A> shows the structure of a drawing component--a simple component that draws an object on the screen. The component subtype of a drawing component indicates the type of object the component draws. This particular drawing component is of the subtype <CODE>'oval'</CODE>; it draws oval objects.<P>
 Whenever an application calls your component, the Component Manager calls your component's main entry point (for example, the <CODE>OvalDrawer</CODE> function). This entry point must be the first function in the component's code segment.<P>
 As previously described, the Component Manager passes two parameters to your component: a component parameters record and a parameter of type <CODE>Handle</CODE>. <BR>The parameters specified by the calling application are contained in the component parameters record. Your component can access the parameters directly from this record. Alternatively, as shown in <A HREF=#MARKER-9-56>Listing 6-5</A>, you can use Component Manager routines to extract the parameters from this array and invoke a subroutine of your component. By taking advantage of these routines, you can simplify the structure of your component code.<P>
 The <CODE>OvalDrawer</CODE> function first examines the value of the <CODE>what</CODE> field of the component parameters record. The <CODE>what</CODE> field contains the request code. The <CODE>OvalDrawer</CODE> function performs the action specified by the request code. The <CODE>OvalDrawer</CODE> function uses a number of subroutines to carry out the desired action. It uses the Component Manager routines <CODE>CallComponentFunction</CODE> and <CODE>CallComponentFunctionWithStorage</CODE> to extract the parameters from the component parameters record and to call the specified component's subroutine with these parameters.<P>
 For example, when the drawing component receives the request code <CODE>kComponentOpenSelect</CODE>, it calls the function <CODE>CallComponentFunction</CODE>. It passes the component parameters record and a pointer to the component's <CODE>OvalOpen</CODE> subroutine as parameters to <CODE>CallComponentFunction</CODE>. This function extracts the parameters and calls the <CODE>OvalOpen</CODE> function. The <CODE>OvalOpen</CODE> function allocates memory for this instance of the component. Your component can allocate memory to hold global data when it receives an open request. To do this, allocate the memory and then call the <CODE>SetComponentInstanceStorage</CODE> function. This function associates the allocated memory with the current instance of your component. The next time this instance of your component is called, the Component Manager passes a handle to your previously allocated memory in the <CODE>storage</CODE> parameter. For additional information on handling the open request, see <A HREF=MoreToolbox-343.html#MARKER-9-63>"Responding to the Open Request" on page 6-18</A>.<P>
 When the drawing component receives the drawing setup request (indicated by the <CODE>kDrawerSetupSelect</CODE> constant), it calls the Component Manager function <CODE>CallComponentFunctionWithStorage</CODE>. Like <CODE>CallComponentFunction</CODE>, this function extracts the parameters and calls the specified subroutine (<CODE>OvalSetup</CODE>) . The <CODE>CallComponentFunctionWithStorage</CODE> function also passes as a parameter to the subroutine a handle to the memory associated with this instance of the component. The <CODE>OvalSetup</CODE> subroutine can use this memory as needed. For additional information on handling the drawing setup request, see <A HREF=MoreToolbox-343.html#MARKER-9-104>"Responding to Component-Specific Requests" on page 6-25</A>.<P>
<B>Listing 6-5  <A NAME=MARKER-9-56></A><A NAME=MARKER-21-57></A>A drawing component for ovals</B><P>
<PRE>
UNIT Ovals;
INTERFACE
{include a USES statement if required}

FUNCTION OvalDrawer (params: ComponentParameters; 
                     storage: Handle): ComponentResult;

IMPLEMENTATION

CONST
   kOvalDrawerVersion      = 0;  {version number of this component}

   kDrawerSetUpSelect      = 0;  {set up drawing region}
   kDrawerDrawSelect       = 1;  {draw the object}
   kDrawerEraseSelect      = 2;  {erase the object}
   kDrawerClickSelect      = 3;  {determine if cursor is }
                                 { inside of the object}
   kDrawerMoveSelect       = 4;  {move the object}
TYPE
   GlobalsRecord =
      RECORD
         bounds:              Rect;
         boundsRgn:           RgnHandle;
         self:                ComponentInstance;
      END;
   GlobalsPtr     = ^GlobalsRecord;
   GlobalsHandle  = ^GlobalsPtr;

{any subroutines used by the component go here}

FUNCTION OvalDrawer (params: ComponentParameters; 
                     storage: Handle): ComponentResult;
BEGIN
   {perform action corresponding to request code}
   IF params.what &lt; 0 THEN    {handle the required request codes}
      CASE (params.what) OF   
      kComponentOpenSelect: 
         OvalDrawer := CallComponentFunction(params,
                                             ComponentRoutine(@OvalOpen));
      kComponentCloseSelect: 
         OvalDrawer := CallComponentFunctionWithStorage(storage, params,
                                              ComponentRoutine(@OvalClose));
      kComponentCanDoSelect: 
         OvalDrawer := CallComponentFunction(params,
                                             ComponentRoutine(@OvalCanDo));
      kComponentVersionSelect: 
         OvalDrawer := kOvalDrawerVersion;
      OTHERWISE 
         OvalDrawer := badComponentSelector;
      END {of CASE}
   ELSE                    {handle component-specific request codes}
      CASE (params.what) OF
      kDrawerSetupSelect: 
         OvalDrawer := CallComponentFunctionWithStorage
                                             (storage, params, 
                                              ComponentRoutine(@OvalSetup));
      kDrawerDrawSelect: 
         OvalDrawer := CallComponentFunctionWithStorage
                                             (storage, params, 
                                              ComponentRoutine(@OvalDraw));
      kDrawerEraseSelect: 
         OvalDrawer := CallComponentFunctionWithStorage
                                             (storage, params, 
                                              ComponentRoutine(@OvalErase));
      kDrawerClickSelect: 
         OvalDrawer := CallComponentFunctionWithStorage
                                             (storage, params, 
                                              ComponentRoutine(@OvalClick));
      kDrawerMoveSelect: 
         OvalDrawer := CallComponentFunctionWithStorage
                                             (storage, params, 
                                              ComponentRoutine(@OvalMoveTo));
     OTHERWISE 
         OvalDrawer := badComponentSelector;
   END;  {of CASE}
END; {of OvalDrawer}

END.
</PRE>
 The next section describes how your component should respond to the required request codes. Following sections provide more information on<P>
<UL>
<LI>defining your component's interfaces
<LI>registering your component
<LI>how to store your component in a component resource file<A NAME=MARKER-2-58></A><P>
</UL>
</BLOCKQUOTE>
<HR>
<center>
<A HREF="MoreToolbox-341.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="MoreToolbox-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="MoreToolbox-513.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="MoreToolbox-343.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="MoreToolbox-3.html">&copy; Apple Computer, Inc.</A><br>6 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>   
