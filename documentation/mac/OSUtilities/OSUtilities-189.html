<!-- Generated by Harlequin WebMaker 2.2.3 (23-Apr-1996)
LispWorks 3.2.2 -->
<HTML> <HEAD>
<TITLE>System Initialization and Startup (IM: U)</TITLE>
<LINK REL="stylesheet" TYPE="text/css" HREF="../../Resources/CSS/frameset_styles.css">
<script type="text/javascript" language="JavaScript" src="../../Resources/JavaScript/page.js"></script>
</head>

<BODY BGCOLOR="#FFFFFF" TEXT="#000000">

<div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;">
<div class="legacybox" style="position: relative;">
<h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../Resources/Images/closebutton.png" width="14" height="14" border="0" align="top" alt="close button"></a></span></h1><p><b>Important:</b>
The information in this document is obsolete and should not be used for new development.</p></div></div></div>


<A NAME=HEADING189></A>



<!-- start of header -->

<!--#include virtual="/includes/framesetheader" -->

<!-- end of header -->


<!-- Main Body -->

<CENTER>
<P>
<A HREF="OSUtilities-188.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="OSUtilities-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="OSUtilities-222.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="OSUtilities-190.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<FONT SIZE=-1><DL><DT><a href="../../macos8/mac8.html" onmouseover="window.status='Macintosh Documentation'; return true"><B>Inside Macintosh:</B></A> <A HREF="OSUtilities-2.html"><B>Operating System Utilities</B></A> / <BR><DD><A HREF="OSUtilities-188.html"><B>Chapter 9 - Start Manager</B></A></DL></FONT><P>
<HR>
<BLOCKQUOTE>
<A NAME=HEADING189-0></A>
<H1>System Initialization and Startup<A NAME=MARKER-2-7></A><A NAME=MARKER-2-8></A><A NAME=MARKER-2-9></A></H1>
 When a Macintosh computer is first turned on, but before it can load and run an application, it must go through system initialization and system startup. At <B>system initialization</B>, the system initialization code located in ROM is executed: memory is tested and initialized, slot cards are initialized, ROM drivers are installed, device drivers are located, and more. The next section<I>,</I> "System Initialization," describes the various steps included in system initialization. At <B>system startup</B>, the system code that is located on the startup disk is executed: various software modules are initialized and system extensions are run. The section <A HREF=#MARKER-9-12>"System Startup" on page 9-4</A> describes various steps included in system startup.<P>
<DL>
<DT><B>WARNING</B>
<DD>The system initialization and system startup process is not the same for all Macintosh models. In addition, the system initialization sequence and system startup sequence listed in this chapter are both subject to change; therefor use the information in these sections only for informational purposes. <EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 You should read this section if you provide a system extension that installs software, such as a device driver or other code, during system initialization or system startup.<P>
<A NAME=HEADING189-4></A>
<H2><A NAME=MARKER-2-10></A><A NAME=MARKER-9-11></A>System Initialization</H2>
 Initialization on a Macintosh computer begins as soon as the power is first supplied to it. Built-in hardware circuits initialize the main processor and other ICs and temporarily alter the memory mapping to make an image of the ROM appear at the location where RAM normally starts (address 0), while making RAM appear at a location higher in memory. This mapping scheme allows the startup routines in the initialization code to obtain critical low-memory vectors. After the initialization code begins executing and obtains the low-memory vectors, it resets the memory mapping back to normal. For further details on this process, see the <I>Guide to Macintosh Family Hardware.</I><P>
 The following list summarizes the events that typically take place when the initialization code in ROM is executed. <P>
<DL>
<DT><B>IMPORTANT</B>
<DD>The system initialization sequence is subject to change; the information in this section is provided for informational purposes only. <EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
<OL>
<LI>Hardware is initialized. The initialization code performs a set of diagnostic tests to verify functionality of some vital hardware components. If the diagnostics succeed, the initialization code initializes these hardware components. If diagnostics fail, the initialization code issues diagnostic tones to indicate the type of hardware failure.<BR>The initialization code determines how much RAM is available and tests it, then validates the parameter RAM (PRAM). Parameter RAM contains a user's preferences for settings of various control panel settings and port configurations.<BR>The initialization code determines the global timing variables, <CODE>TimeDBRA</CODE>, <CODE>TimeSCCDB</CODE>, and <CODE>TimeSCSIDB</CODE>. (See <A HREF=#MARKER-9-42>"Global Timing Variables" on page 9-9</A> for more information) and initializes the Resource Manager, Notification Manager, Time Manager, and Deferred Task Manager.
<LI>On machines with expansion slots, the initialization code initializes the Slot Manager. The Slot Manager then initializes any installed cards by executing the primary initialization code in each card's declaration ROM. Video expansion cards, including built-in video, initialize themselves by determining the type of connected monitor, and then set the display to 1 bit per pixel, and display a gray screen (alternating black and white dots). 
<LI>The initialization code initializes the Vertical Retrace Manager and Gestalt Manager. ROM drivers for all built-in functionality are installed in the unit table and initialized. The initialization code initializes the Apple Desktop Bus (ADB) Manager that then initializes each ADB device. The initialization code initializes the Sound Manager and SCSI Manager.
<LI>The initialization code loads drivers from all on-line SCSI devices. 
<LI>The initialization code chooses the boot device, and calls the boot blocks to begin initialization of the System Software.<P>
</OL>
 Having initialized the computer's slots, drivers, and hardware, as well as some of the Operating System managers, the initialization code dispatches to the startup code, which immediately begins the startup procedure described in the next section, <BR><A HREF=#MARKER-9-12>"System Startup."</A><P>
<A NAME=HEADING189-14></A>
<H2><A NAME=MARKER-9-12></A><A NAME=MARKER-2-13></A><A NAME=MARKER-2-14></A>System Startup</H2>
 System startup begins as soon as the initialization code in ROM transfers control to the system startup code. The system startup code is responsible for initializing AppleTalk, the debugger, and system extensions. System extensions are covered in detail in the section <A HREF=OSUtilities-214.html#MARKER-9-36>"Writing a System Extension" beginning on page 9-10</A>.<P>
 This section covers the startup sequence for Macintosh computers running System 7 or later; it then describes the boot blocks and defines the boot block header.<P>
 The following list summarizes the events that take place when the system startup code is executed. <P>
<DL>
<DT><B>IMPORTANT</B>
<DD>The system startup sequence is subject to change; the information in this section is provided for informational purposes only. <EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
<OL>
<LI>The system startup code looks for an appropriate startup device. It first checks the internal 3.5-inch floppy drive. If a disk is found, it attempts to read it and looks for a System file. If it doesn't find a disk or System file, it checks the default startup device specified by the user in the Startup Disk control panel. If no default device is specified or if the device specified is not connected, it checks for other devices connected to the SCSI port, beginning with the internal drive and proceeding successively from drive 6 through drive 1. If it doesn't find a startup device, it displays the question-mark disk icon until a disk is inserted. If the startup device itself fails, the startup code displays the sad Macintosh icon until the computer is turned off.
<LI>After selecting a startup device, the system startup code reads system startup information from the startup device. The system startup information is located in the boot blocks, the logical blocks 0 and 1 on the startup disk. The boot blocks contain important information such as the name of the System file and the Finder. The boot blocks are described in detail in the next section.
<LI>The system startup code displays the happy Macintosh icon.
<LI>The system startup code reads the System file and uses that information to initialize the System Error Handler and the Font Manager.
<LI>The system startup code verifies that the necessary hardware is available to boot the system software and displays on the startup screen an alert box with the message "Welcome to Macintosh."
<LI>The system startup code performs miscellaneous tasks: it verifies that enough RAM is available to boot the system software, it loads and turns on Virtual Memory if it is enabled in the Memory control panel, it loads the debugger, if present. (The system startup information contains the name of the debugger --usually MacsBug), it sets up the disk cache for the file system, and it loads and executes CPU-specific software patches. At this point, the system begins to trace mouse movement.
<LI>For any NuBus cards installed, the system startup code executes the secondary init code on the card's declaration ROM<A NAME=MARKER-2-15></A>.
<LI>The system startup code loads and initializes all script systems, including components for all keyboard input methods. It also executes the initialization resources in the System file.
<LI><A NAME=MARKER-2-42></A>The system startup code loads and executes system extensions. (System extensions can be located in the Extensions folder, in the Control Panels folder, and in the System Folder).
<LI>The system startup code launches the Process Manager, which takes over at this point and launches the Finder. The Finder then displays the desktop and the menu bar. The desktop shows all mounted volumes; it also shows any windows that were open the last time the computer was shut down. The Memory Manager sets up a large, unsegmented application heap, which is divided into partitions as applications start up.<P>
</OL>
 At this point, the system has successfully booted.<P>
 The next section, "Boot Blocks," describes the format of the boot block header. This header contains information that the startup code uses to start up the system.<P>
<A NAME=HEADING189-31></A>
<H3><A NAME=MARKER-2-17></A><A NAME=MARKER-9-18></A>Boot Blocks</H3>
 <A NAME=MARKER-2-19></A>The first two logical blocks on every Macintosh volume are <B>boot blocks.</B> These blocks contain <B>system startup information:</B> instructions and information necessary to start up (or "boot") a Macintosh computer. This information consists of certain configurable system parameters (such as the capacity of the event queue, the number of open files allowed, and so forth) and is contained in a boot block header. The system startup information also includes actual machine-language instructions that could be used to load and execute the System file. Usually these instructions follow immediately after the boot block header. Generally, however, the boot code stored on disk is ignored in favor of boot code stored in a resource in the System file.<A NAME=MARKER-2-4></A><A NAME=MARKER-2-21></A><P>
 The boot block header has a structure that can be described by the <CODE>BootBlkHdr</CODE> data type.<P>
<DL>
<DT><B>WARNING</B>
<DD>The format of the boot block header is subject to change. If your application relies on the information presented here, it should check the boot block header version number and react gracefully if that number is greater than that documented here.<EM></EM>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>
 Note that there are two boot block header formats. The current format includes two fields at the end that are not contained in the older format. These fields allow the Operating System to size the system heap relative to the amount of available physical RAM. A boot block header that conforms to the older format sizes the system heap absolutely, using values specified in the header itself. You can determine whether a boot block header uses the current or the older format by inspecting a bit in the high-order byte of the <CODE>bbVersion</CODE> field, as explained in its field description.<A NAME=MARKER-2-11></A><P>
<PRE>
TYPE BootBlkHdr =          {boot block header}
RECORD
   bbID:          Integer; {boot blocks signature}
   bbEntry:       LongInt; {entry point to boot blocks}
   bbVersion:     Integer; {boot blocks version number}
   bbPageFlags:   Integer; {used internally}
   bbSysName:     Str15;   {System filename}
   bbShellName:   Str15;   {Finder filename}
   bbDbg1Name:    Str15;   {first debugger filename}
   bbDbg2Name:    Str15;   {second debugger filename}
   bbScreenName:  Str15;   {name of startup screen}
   bbHelloName:   Str15;   {name of startup program}
   bbScrapName:   Str15;   {name of system scrap file}
   bbCntFCBs:     Integer; {number of FCBs to allocate}
   bbCntEvts:     Integer; {number of event queue elements}
   bb128KSHeap:   LongInt; {system heap size on 128K Mac}
   bb256KSHeap:   LongInt; {system heap size on 256K Mac}
   bbSysHeapSize: LongInt; {system heap size on all machines}
   filler:        Integer; {reserved}
   bbSysHeapExtra:LongInt; {additional system heap space}
   bbSysHeapFract:LongInt; {fraction of RAM for system heap}
END;
</PRE>
<DL>
<H5>Field Description</H5>
<DT><A NAME=MARKER-2-13></A><CODE>bbID</CODE>
<DD> A signature word. For Macintosh volumes, this field always contains the value $4C4B.
<DT><A NAME=MARKER-2-15></A><CODE>bbEntry</CODE>
<DD> The entry point to the boot code stored in the boot blocks. This field contains machine-language instructions that translate to <CODE>BRA.S *+$90</CODE> (or <CODE>BRA.S *+$88</CODE>, if the older block header format is used), which jumps to the main boot code following the boot block header. This field is ignored, however, if bit 6 is clear in the high-order byte of the <CODE>bbVersion</CODE> field or if the low-order byte in that field contains $D.
<DT><CODE><A NAME=MARKER-2-19></A>bbVersion</CODE>
<DD> A flag byte and boot block version number. The high-order byte of this field is a flag byte whose bits have the following meanings:
<TABLE BORDER="0" CELLPADDING=3><TH ALIGN=LEFT>Bit<TH>Meaning<TR>
<TD>0-4<TD>Reserved; must be 0<TR>
<TD>5<TD>Set if relative system heap sizing is to be used<TR>
<TD>6<TD>Set if the boot code in boot blocks is to be executed<TR>
<TD>7<TD>Set if new boot block header format is used</TABLE>

<DT>
<DD> If bit 7 is clear, then bits 5 and 6 are ignored and the version number is found in the low-order byte of this field. If that byte contains a value that is less than $15, the Operating System ignores any values in the <CODE>bb128KSHeap</CODE> and <CODE>bbSysHeapSize</CODE> fields and configures the system heap to the default value contained in the <CODE>bbSysHeapSize</CODE> field. If that byte contains a value that is greater than or equal to $15, the Operating System sets the system heap to the value in <CODE>bbSysHeapSize</CODE>. In addition, the Operating System executes the boot code in the <CODE>bbEntry</CODE> field only if the low-order byte contains $D.
<DT>
<DD> If bit 7 is set, the Operating System inspects bit 6 to determine whether to execute the boot code contained in the <CODE>bbEntry</CODE> field and inspects bit 5 to determine whether to use relative sizing of the system heap. If bit 5 is clear, the Operating System sets the system heap to the value in <CODE>bbSysHeapSize</CODE>. If bit 5 is set, the system heap is extended by the value in <CODE>bbSysHeapExtra</CODE> plus the fraction of available RAM specified in <CODE>bbSysHeapFract</CODE>.
<DT><CODE><A NAME=MARKER-2-20></A>bbPageFlags</CODE>
<DD> Used internally.
<DT><CODE><A NAME=MARKER-2-21></A>bbSysName</CODE>
<DD> The name of the System file.
<DT><CODE><A NAME=MARKER-2-22></A>bbShellName</CODE>
<DD> The name of the shell file. Usually, the system shell is the Finder.
<DT><CODE><A NAME=MARKER-2-23></A>bbDbg1Name</CODE>
<DD> The name of the first debugger installed during the boot process. Typically this is Macsbug.
<DT><CODE><A NAME=MARKER-2-24></A>bbDbg2Name</CODE>
<DD> The name of the second debugger installed during the boot process. Typically, this is Disassembler.
<DT><CODE><A NAME=MARKER-2-25></A>bbScreenName</CODE>
<DD> The name of the file containing the information (welcome message) initially displayed on the startup screen. Usually, this is StartUpScreen.
<DT><CODE><A NAME=MARKER-2-26></A>bbHelloName</CODE>
<DD> The name of the startup program. Usually, this is the Finder.
<DT><CODE><A NAME=MARKER-2-27></A>bbScrapName</CODE>
<DD> The name of the system scrap file. Usually, this is the Clipboard.
<DT><CODE><A NAME=MARKER-2-28></A>bbCntFCBs</CODE>
<DD> The number of file control blocks (FCBs) to put in the FCB buffer. In System 7 and later, this field specifies only the initial number of FCBs in the FCB buffer because the Operating System can usually resize the FCB buffer if necessary. See the chapter "File Manager" in <I><A HREF="../Files/Files-2.html">Inside Macintosh: Files</A></I> for details on the file control block (FCB) buffer.
<DT><CODE><A NAME=MARKER-2-29></A>bbCntEvts</CODE>
<DD> The number of event queue elements to allocate. This number determines the maximum number of events that can be stored by the Event Manager at any one time. Usually this field contains the value 20.
<DT><CODE><A NAME=MARKER-2-30></A>bb128KSHeap</CODE>
<DD> The size of the system heap on a Macintosh computer having 128 KB of RAM.
<DT><CODE><A NAME=MARKER-2-37></A>bb256KSHeap</CODE>
<DD> Reserved.
<DT><CODE><A NAME=MARKER-2-38></A>bbSysHeapSize</CODE>
<DD> The size of the system heap on a Macintosh computer having 512 KB or more of RAM. This field might be ignored, as explained in the description of the <CODE>bbVersion</CODE> field.
<DT><CODE>filler</CODE>
<DD> Reserved.
<DT><CODE><A NAME=MARKER-2-39></A>bbSysHeapExtra</CODE>
<DD> The minimum amount of additional system heap space required. If bit 5 of the high-order word of the <CODE>bbVersion</CODE> field is set, this value is added to the <CODE>bbSysHeapSize</CODE>.
<DT><CODE><A NAME=MARKER-2-40></A>bbSysHeapFract</CODE>
<DD> The fraction of RAM available to be used for the system heap. If bit 5 of the high-order word of the <CODE>bbVersion</CODE> field is set, this fraction of available RAM is added to the <CODE>bbSysHeapSize</CODE>.<A NAME=MARKER-9-1></A> 
</DL>
<A NAME=HEADING189-58></A>
<H2><A NAME=MARKER-9-42></A>Global Timing Variables</H2>
 During system initialization, the initialization code initializes the following global variables with timing information.<A NAME=MARKER-2-43></A>
<TABLE BORDER="0" CELLPADDING=3><TD>Variable<TD>Contents<TR>
<TD>TimeDBRA<TD>The number of times the DBRA (decrement branch always instruction) can be executed per millisecond.<TR>
<TD>TimeSCCDB<TD><CODE>The number of times the SCC can be accessed per millisecond.<A NAME=MARKER-2-1></A></CODE><TR>
<TD>TimeSCSIDB<TD><CODE>The number of times the SCSI can be accessed per millisecond.<A NAME=MARKER-2-2></A></CODE></TABLE>
<P>
<DL>
<DT><B>Note</B>
<DD>The <CODE>TimeDBRA</CODE> value is calculated in ROM and is affected by the processing method of the CPU. Accordingly, for routines running in RAM, it is not necessarily a good measure of how fast the computer is.<EM></EM><A NAME=MARKER-2-44></A>  <IMG ALIGN = BOTTOM SRC = "graphics/triangle.gif">
</DL>

</BLOCKQUOTE>
<HR>
<center>
<A HREF="OSUtilities-188.html"><IMG ALIGN = BOTTOM SRC = "prev.gif" border=none hspace=20 alt="Previous"></A> <A HREF="OSUtilities-2.html"><IMG ALIGN = BOTTOM SRC = "content.gif" border=none hspace=20 alt="Book Contents"></A> <A HREF="OSUtilities-222.html"><IMG ALIGN = BOTTOM SRC = "index.gif" border=none hspace=20 alt="Book Index"></A> <A HREF="OSUtilities-190.html"><IMG ALIGN = BOTTOM SRC = "next.gif" border=none hspace=20 alt="Next"></A> </CENTER><P>
<center><font size=-1><A HREF="OSUtilities-3.html">&copy; Apple Computer, Inc.</A><br>6 JUL 1996</center></font><P>

<!-- start of footer  -->

<!--#include virtual="/includes/framesetfooter" -->

<!-- end of footer -->


</BODY>
</HTML>  
