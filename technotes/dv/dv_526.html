<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 01-August-01 --><!-- Includes revisions to graphics tags --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note DV526: Docking Manager Q&amp;As</title><meta name="keywords" content="Mac OS 8 Docking Manager DockingDispatch  dockingStation dockHeadphoneAttached dockHasVideo dockingAttr"><meta name="Description" content="Technical Note DV526: This Technical Note contains a collectionof archived Q&amp;As relating to Docking Manager --questionssent the Developer Support Center (DSC) along with answersfrom the DSC engineers. Archived Q&amp;As include: DockingDispatchtrap supervisor mode bug workaround (this bug occurs whenusing DockingDispatch trap to get information about the Duoenvironment), dockHardwareAttr dockHasVideo bit, dockingAttrdockingStation bit,and the dockSoundAttr dockHeadphoneAttachedbit.">                                       <meta name="categories" content="Devices"><meta name="week-posted" content="Apr 26, 1993 - May 7, 1993"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002420" title="Docking Manager Q&As"></a><A NAME="top"></A><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxHardwareDrivers-date.html">Hardware & Drivers</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/HardwareDrivers/idxAppleHardware-date.html" target="_blank">Hardware & Drivers > Apple Hardware</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note DV526</div>
<div id="pageheadsub">Docking Manager Q&amp;As</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"><!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr>        <td width=300 valign="top" align=left scope="row">            <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>                        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>                                         <span id="menutitle">                            CONTENTS                             <br>                            <br>                        </span>                    </td>                </tr>                <tr bgcolor="#e6e6e6">                    <td background="images/tnmenubody.gif" width=300 align=left>					<!-- begin_toc --><p id="menutext"><A HREF="#Section1">DockingDispatch trap supervisor mode bug and workaround</a><BR><BR><A HREF="#Section2">dockHardwareAttr dockHasVideo bit</a><BR><BR><A HREF="#Section3">dockingAttr dockingStation bit</a><BR><BR><A HREF="#Section4">dockSoundAttr dockHeadphoneAttached bit</a><BR><BR><A HREF="#downloads">Downloadables</A></P>                   <!-- end_toc -->                  </td>                </tr>                <tr>                    <td width=300 align=left scope="row">                        <img src="images/tnmenubottom.gif" alt="" width=300 height=16>                    </td>                </tr>            </table>        </td>        <td width=300 valign="top" align=left><!-- begin_intro_text --><p id = "introtext">This Technical Note contains a collection of archived Q&amp;As relating to a specific topic--questions sent the Developer Support Center (DSC) along with answers from the DSC engineers. Current Q&amp;As can be found on the <a href="../../qa/index.html">Macintosh Technical Q&amp;As web site</a>.</p><!-- end_intro_text --><!-- begin_date --><h3 align=center>[May 01 1993]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR>          <!-- begin_content --><A NAME=Section1></A><h2>DockingDispatch trap supervisor mode bug and workaround</h2><p>Date Written:  12/29/92</p><p>Last reviewed: 6/24/93</p><p>We're having a fatal problem using the DockingDispatch ($AA57) trap to getinformation about the Duo environment. When we call with a 'hdwr' selector,running virtual memory on a Duo 230 and a Duo Dock, we get a privilegeviolation on a</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    MOVEC   VBR,A0</pre>	</TD></TR></TABLE></CENTER><p>in some sort of patch (dock handler?) in the system heap. The 68030 isn't insupervisory mode. When we run without VM in the same setup, the 68030 is insupervisory mode and all is copacetic. When we try VM on a dockless Duo, or ona PowerBook 180 (with or without external video) the 'hdwr' selector worksfine. Is there any documentation or guidance about which traps aren't safe tocall because they require supervisory mode?</p><p>___</p><p>We recently discovered a bug in the configuration ROM on the Duo Dock. The bugis with a call to the _DockingDispatch trap using the hardware attributeselector when VM is on (only on the Duo Dock). The docking handler doesn't gointo supervisor mode when running its hardware detection tests, and so whenthat call is made while running in user mode, the machine crashes, justifiablyso, with a privilege error.</p><p>The declaration ROM can't be patched at this point, so the only alternative isto surround the _DockingDispatch call with code to force entry into supervisormode, as shown in the code fragment below.</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>;------------------------------------------------------------------------;; Input:       None;; Destroys:    D0/A1;;;; Function:    When VM is running we must switch to supervisor mode so;              that we may run necessary privileged instructions.;---------------------------------------------------------------------------------------SetSupervisorMode      MOVE.L  (SP)+,A1          ; Save a copy of return address-we might switch stacks      MOVEQ  #8,D0              ; Set selector to Set Supervisor Mode for VM      _DebugUtil                ;      CMPI.W  #paramErr,D0      ; IF VM is on THEN  D0 = Status Register      BNE.S  @Cont              ; ELSE      MOVE.W  SR,D0             ;   Save the current Status Register@Cont   ANDI.W  #$EFFF,SR            ; Make sure that we're in the interrupt stack      JMP    (A1)               ; Get out of here</pre>	</TD></TR></TABLE></CENTER>      <p>Upon returning from _DockingDispatch, return to user mode is different becausethere's only a selector to _DebugUtil to go into supervisor mode--no selectorto return or set user mode. That you'd have to do manually with the statusregister. Here's an example from some system code:</p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>SetHardwareToUserMode    move.l  sp,usp            ; set the usp to the current stack    move.l  4(sp),sp    andi.w  #($FFFF-$2000),sr ; throw me into user mode (and onto usp)    rts                       ; and return on usp</pre>	</TD></TR></TABLE></CENTER><P><A HREF="#top">Back to top</A></P><a name="Section2"></a><h2>dockHardwareAttr dockHasVideo bit</h2><p>Date Written:  11/4/92</p><p>Last reviewed:  6/14/93</p><p>What are the implications of returning (or not returning) true for dockHasVideoin dockHardwareAttr? Is it sufficient to statically indicate that a barsupports a monitor? After all, the video driver can later determine whether amonitor is actually attached. Or is there an added benefit to reporting thepresence of a monitor when DockingDispatch is called?</p><p>___</p><p>The dockHasVideo bit is used by the Docking Manager to determine whether or notit's reasonable to go to sleep. Sleeping is prevented under the followingcircumstances: the dockNoSleep bit is set in dockDockingAttr; the dockHasVideobit is set in dockHardwareAttr; or the dockHasFPU bit is set indockHardwareAttr. Apple's docking bars don't set the sleep bit indockDockingAttr, but the two hardware bits are set. This way, sleep can workdifferently in the future without having to change the bars.</p><p>The determination of whether a bar can go to sleep or not is made at dockinginitialization time. This occurs before slot PrimaryInits are run, so the videodriver isn't yet up and running. If the hardware bit is set statically, thatwill indicate to the Docking Manager that video always exists, as in the caseof the DuoDock. This will currently prevent the possibility of putting thesystem to sleep. Apple's MiniDock handles this situation by running through avery stripped down version of PrimaryInit with the sole purpose of determiningwhether or not a monitor is physically attached.</p><P><A HREF="#top">Back to top</A></P><a name="Section3"></a><h2>dockingAttr dockingStation bit</h2><p>Date Written:  11/4/92</p><p>Last reviewed:  3/1/93</p><p>Does dockingStation true in DockingAttr imply enclosure (no LCD), AC power, SCCand modem port blocked, or what?</p><p>___</p><p>Our equates don't refer to dockingStation. Setting bit 3, dockNoLCDScreen,means that the internal LCD screen on the Duo shouldn't be used.</p><p>Bit 4, dockEnclosingBar, means that the unit is physically enclosed by the bar,as in the case of the DuoDock. We're not aware of that information being usedfor anything specific. It implies the ports on the back are blocked, but that'sa secondary implication. Certainly the MiniDock blocks the ports on the back aswell, and it's not considered a docking station, so its dockEnclosingBar bit isn't set.</p><P><A HREF="#top">Back to top</A></P><a name="Section4"></a><h2>dockSoundAttr dockHeadphoneAttached bit</h2><p>Date Written:  11/4/92</p><p>Last reviewed:  6/14/93</p><p>What are the implications of reporting dockHeadphoneAttached in dockSoundAttr?This seems superfluous because the presence of a headphone is directly detectedat the main expansion connector, thus enabling or disabling power to soundportions of the bar via +5V SOUND.</p><p>___</p><p>Currently, there are no implications for either setting or clearing that bit.In the future, this may change, but neither DuoDock nor MiniDock set this bit,primarily for the reason you mention.</p><P><A HREF="#top">Back to top</A></P>         <a name="downloads"></a>         <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center>                                    <img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (52K)</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/dv_526.pdf">Download</A></P>               </TD>            </TR>         </TABLE>         <BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER><!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/dv/dv_526.html%3Fid%3DDTS10002420-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/dv/dv_526.html%3Fid%3DDTS10002420-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/dv/dv_526.html%3Fid%3DDTS10002420-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>