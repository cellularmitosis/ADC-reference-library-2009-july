<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!--Template 06-20-02--><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Q&amp;A FL11: Securely Erasing, Accessing and Dismounting a Macintosh Partition</title><meta name="keywords" content="Mac OS 8 accessing and dismounting partition secure erasing"><meta name="Description" content="Technical Q&amp;A FL11: Q&amp;A gives suggestions on how to set upone's disk volume for secure erasures. Q&amp;A mentions severalresources with information on magnetic disks and informationrecovery from disks and then lists all the steps for unmountingand accessing your disk volume to allow for secure erasure."><meta name="categories" content="Files"><meta name="week-posted" content="Jan 11, 1999 - Jan 15, 1999"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10001197" title="Securely Erasing, Accessing and Dismounting a Macintosh Partition"></a><!-- top_of_header_marker_comment --><!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalqas/index.html">Technical Q&As</a> &gt; <a href="../../technicalqas/Carbon/index.html">Carbon</a> &gt; <a href="../../technicalqas/Carbon/idxUserExperience-date.html">User Experience</a> &gt; </p><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Q&amp;A FL11</div>
<div id="pageheadsub">Securely Erasing, Accessing and Dismounting a Macintosh Partition</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment -->						<!-- begin_content --> <CENTER><TABLE BORDER=0 CELLPADDING=0 WIDTH=600><TR> <td align="left"><hr width=500 align=center><p id=p2>Q: I have heard that data from an erased volume can beeasily recovered.  I am concerned about the confidentially of the data on my disk, and am trying to write code to securely erase the contents of a Macintosh disk partition (and automatically re-initialize it as a Mac OS volume). I plan to write zeros into the data a number of times, but I am not sure how to gain write access to a  partition in some absolute manner from the start to end.  How can I accomplish this?</p><p id=p4>A: The first piece of advice I have for you is that the best way to ensure that data stays confidential is to never ever write to a disk in clear-text. The best solution is to use something like <a href="http://www.nai.com/products/security/pgpdisk/pgpdisk.asp" target="_blank">PGPdisk</a> to  encrypt information automatically before it gets written to disk.</p><p id=p4>The other thing you need to consider is that simply writing an alternating pattern of zeros and ones to a disk is no longer sufficient to "securely erase" a drive.  The recent research on the behavior of erase bands of magnetic media recording and the availability of magnetic force microscopy for the analysis of magnetic media suggests the feasibility of a recovery attack on erased data.  Further, it has been suggested that the media sanitization guidelines might also be inadequate for the  magnetic encoding scheme used by modern disk drives. Knowing what pattern to write is a science in itself.  I suggest you  read Peter Gutmann's paper,  <a href="http://www.cs.auckland.ac.nz/%7Epgut001/secure_del.html" target="_blank"> "Secure Deletion of Data from Magnetic and Solid-State Memory"</a>, for more information on this subject.</p><p id=p4>Assuming that you do have a pattern in mind, the best way to erase the Mac OS volume is to access the partition itself through the disk driver.  Once you know the disk driver's refnum and the length of the volume, you can simply make low level <code>PBWrite</code> calls to the disk driver and write your pattern.</p><p id=p4>Your first step is to  familiarize yourself with the data structures used in the Mac OS file system, which are all documented in <I>Inside Macintosh: Files and Devices</I>.  </p><p id=p4>You might also consider  breaking into MacsBug and typing the '<CODE>vol</CODE>' and '<CODE>drive</CODE>' commands to see what I mean.  Try dumping the volume table with '<CODE>vol</CODE>'then taking the VCB address (<CODE>xxxxxxxx</CODE>) and dumping that by typing '<CODE>DM xxxxxxxx VCB</CODE>'.</p><p id=p4>What your code needs to do is as follows:</p><ol><li>For a given volume, perform a  <code>PBHGetVInfo</code> and record the <code>ioVDRefNum</code> and the <code>ioVDrvInfo</code> values, which you will need later to talk to the disk driver (read pp. 2-145, Inside Mac: Files). An easy way to do this is to reuse some of the code from the <CODE>MoreFiles</CODE> sample code available from the DTS developer CD's. Specifically, use the <code>FindDrive</code> function from  MoreFilesExtras.c, which will give you back the <CODE>vRefNum</CODE> and the <code>DrvQElPtr</code>. </li><Li>You need to then calculate and record the size of the volume. An easy way to do this is to leverage the <CODE>MoreFiles</CODE> code, <code>GetDiskBlocks</code> (from MoreFilesExtras.c) by passing in the <CODE>vRefNum</CODE> for the volume.  </li><li>Your next task is to attempt to unmount the volume from the Mac OS files system; you can do this by calling <code>PBUnmountVol</code> passing in the <code>ioVRefNum</code>. Chances are the unmount will fail because some files might be open. You will know this if the <code>PBUnmountVol</code> call returns a <code>fBusyErr</code>.   At this point your user will have to close those files or quit applications that have them open.<p id=p4>If you plan to do it programmatically you <i>could</i> call <code>PBGetFCBInfo</code> passing in the <code>vRefnum</code> from the volume and a starting index of 1 (in <CODE>ioFCBIndx</CODE>) to build a table of open files.  You have to then present the user with a list of possible applications that might have that file open (look at the file type '<CODE>APPL</CODE>' to figure out the application name). </p><p id=p4>Of course, a better alternative would be to ask the Finder to unmount the volume using an Apple Event (I'd suggest that).</p> </li><li>Once the volume is unmounted from the <CODE>filesystem</CODE>, you can then access the partition by calling the low level <code>PBWrite</code> function (as documented on pp. 1-73, Inside Mac: Devices).<p id=p4>Remember that you need to not only pass in to <code>PBWrite</code> the drive number (from the <CODE>ioVDrvInfo</CODE> of the <CODE>PBHGetVInfo</CODE>) in the <CODE>ioVRefNum</CODE> field, but also the driver reference number (from the <CODE>ioVFRefNum</CODE>  of the <CODE>PBHGetVInfo</CODE>) in the <CODE>ioRefNum</CODE> field. </p></li><li>Once you have written your formatting pattern, you can then attempt to remount the volume with <CODE>PBMount</CODE>; this will cause the <CODE>filesystem</CODE> to query the user to re-initialize the partition as a Mac volume.</li></ol><p id=p4>You should find that accessing the partition with the device manager is very simple, but I also warn you (from experience) that writing this kind of code can be risky. Make sure that you do your development on a machine other than your everyday production machine; otherwise, you risk losing your own important files. Be careful.</p></td></tr></table></center><!-- end_content --><!-- begin_date --><H4 ALIGN=center>[Jan 11 1999]</H4><!-- end_date --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/qa/fl/fl11.html%3Fid%3DDTS10001197-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/qa/fl/fl11.html%3Fid%3DDTS10001197-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/qa/fl/fl11.html%3Fid%3DDTS10001197-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --> <hr width=500 align=center> </BODY> </HTML>