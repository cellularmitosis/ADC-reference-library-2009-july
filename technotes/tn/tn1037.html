<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"			"http://www.w3.org/TR/REC-html40/loose.dtd"><HTML><!-- Template 03-24-01 --><HEAD><LINK REL="stylesheet" HREF="../../adcstyle.css" TYPE="text/css"><LINK REL="stylesheet" HREF="../../style.css" TYPE="text/css"><title>Technical Note TN1037: QuickDraw GX MappingLibrary.c: Its Uses and Limitations</title>    <meta name="keywords" content="Mac OS 8 QuickDraw GX MappingLibrary.c PolyToPolyMap graphics">    <meta name="Description" content="Technical Note TN1037: This Technical Note discusses MappingLibrary.cfrom the QuickDraw GX Libraries. The information in thisTechnote is still relevant up to and including Mac OS 7.6with QuickDraw GX 1.1.5. Apple no longer supports QuickDrawGX."><meta name="categories" content="QuickDraw GX"><meta name="week-posted" content="Apr 1, 1996 - Apr 5, 1996"><LINK REL="stylesheet" HREF="../../css/adcstyle.css" TYPE="text/css"><script language="JavaScript" type="text/javascript" src="../../js/adc.js"></script></HEAD><BODY BGCOLOR="#FFFFFF"><a name="//apple_ref/doc/uid/DTS10002879" title="QuickDraw GX MappingLibrary.c: Its Uses and Limitations"></a><A NAME="top"></A> <!-- begin_header_information --><!--#include virtual="/adcnavbar" --><p><a href="http://developer.apple.com/">ADC Home</a> &gt; <a href="../../referencelibrary/index.html">Reference Library</a> &gt; <a href="../../technicalnotes/index.html">Technical Notes</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/index.html">Legacy Documents</a> &gt; <a href="../../technicalnotes/LegacyTechnologies/idxGraphicsImaging-date.html">Graphics & Imaging</a> &gt; </p><div style="width:100%; position:fixed;"><div align="center" id="watermark" style="position: relative; margin-left:auto; margin-right:auto; z-index:20; width:500px;"><div class="legacybox"><h1>Legacy Document<span class=closebutton><a href="javascript:closeWatermark()"><img src="../../images/closebutton.png" width="14" height="14" border="0"  alt="close button"></a></span></h1>

<p><strong>Important: </strong>This document is part of the Legacy section of the ADC Reference Library. This information should not be used for new development.</p>

<div class="reflibtopic">
	<p>Current information on this Reference Library topic can be found here:</p>
	<ul>
				<li><a href="../../referencelibrary/GraphicsImaging/index.html" target="_blank">Reference Library > Graphics & Imaging</a></li>
	</ul>
</div>




</div></div></div><!-- end_header_information --><!-- bottom_of_header_marker_comment --><!-- top_of_titles_marker_comment --><CENTER><table width="600" cellpadding="0" cellspacing="0" border="0">
<tr><td align="left" scope="row">
<h1>
<div id="pagehead">Technical Note TN1037</div>
<div id="pageheadsub">QuickDraw GX MappingLibrary.c: Its Uses and Limitations</div>
</h1>
</td></tr></table></CENTER><!-- bottom_of_titles_marker_comment --><CENTER><TABLE BORDER=0 CELLSPACING=1 WIDTH=600><TR><td align="left"> <!-- begin_header_box --><table width="600" cellpadding="0" cellspacing="0" border="0">    <tr><td width=300 valign="top" align=left scope="row">    <table border="0" width="300" cellpadding="0" cellspacing="0">			<tr>        <td width=300 align=left> <img src="images/tnmenutop.gif" alt="" align="bottom" width=300 height=7></td></tr><tr bgcolor="#e6e6e6">    <td background="images/tnmenubody.gif" width=300 align=left><span id="menutitle">    CONTENTS     <BR>    <BR></span>    </td></tr><tr bgcolor="#e6e6e6">    <td background="images/tnmenubody.gif" width=300 align=left><!-- begin_toc --><P id = "menutext"><A HREF = "#RTFToC1">About the GX Libraries</a><br><br><A HREF = "#RTFToC2">What is in MappingLibrary.c?</a><br><br><A HREF = "#RTFToC3">Working with MappingLibrary.c</a><br><br><A HREF = "#RTFToC4">PolyToPolyMap Limitations and Solutions</a><br><br><A HREF = "#RTFToC5">Summary</a><br><br><A HREF = "#References">References</a><br><br><A HREF="#Downloads">Downloadables</A></P>   <!-- end_toc -->  </td></tr><tr>    <td width=300 align=left scope="row"><img src="images/tnmenubottom.gif" alt="" width=300 height=16>    </td></tr>    </table></td><td width=300 valign="top" align=left><!-- begin_intro_text -->  <P id = "introtext">This Technote discusses MappingLibrary.c from the QuickDraw GX Libraries.</p><P id = "introtext">This Note is intended for Macintosh QuickDraw GX developers who are usingMappingLibrary.c or who are considering using it for their QuickDraw GXgraphics applications.</p><TABLE BORDER="0"><TR>    <td bgcolor="#EEEEEE" align=left>        <P id = "introtext"><B>Important for all Apple Printing and Graphics Developers: </B></p><P id = "introtext">        The information in this Technote is still relevant up to and including        <A HREF = "tn1090.html">Mac OS 7.6</A>        with QuickDraw GX 1.1.5. Beginning with the release of Mac OS 8.0,        however, Apple plans to deliver a system which incorporates QuickDraw GX        graphics and typography <B>only</B>. QuickDraw GX printer drivers and GX printing        extensions will <B>not</B> be supported in Mac OS 8.0 or in future Mac OS releases. Apple's        goal is to simplify the user experience of printing by unifying the Macintosh        graphic and printing architectures and standardizing on the classic Printing        Manager. </P>            </TD></TR></TABLE><!-- end_intro_text --><!-- begin_date --><h3>&nbsp;Updated: [Mar 1 1996]</h3><!-- end_date -->                </TD>             </TR>          </TABLE>          <!-- end_table_box --> <BR><BR>          <hr width=500 align=center>          <BR><BR> <!-- begin_content --><a name="RTFToC1"></a><h2>About the GX Libraries</h2><P>For better or worse, the development of QuickDraw GX took seven years fromconception to initial release. During that time, there were many requests forfeature enhancements and interface improvements that, if implemented, mighthave taken seven more years to complete. As it turns out, some of theseenhancements could readily be built on existing services, but there was no timeto test or document these services with the rigor required to make them fullypart of the released system.</p><P>The GX Libraries fill this gap by providing services built on top of the restof GX in source form. This Technote and others document these services. SinceGX libraries are provided as source, it is reasonable for developers to modifythem to meet their specific needs. Care was taken for the libraries not todepend on the implementation details of GX, so that future versions of GXshould not invalidate them, in original or modified form.</p><P>The libraries are likely to evolve to take advantage of improved algorithms,new Macintosh or GX services; if you modify one for your application's specificneeds, it's worth occasionally reviewing the GX library provided by Apple tostay synchronized with any improvements.</p><BR><P><A HREF="#top">Back to top</A></P><a name="RTFToC2"></a><h2>What is in MappingLibrary.c?</h2><P>The GX Library, MappingLibrary.c, generates mappings that project thecoordinates of one polygon onto another. It was written by Robert Johnson, theresident mathematics whiz.</p><P>MappingLibrary.c has one multi-purpose function: <code>PolyToPolyMap</code>. Its declarationis: </p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>void PolyToPolyMap(const gxPolygon *source, const gxPolygon *dest,                    gxMapping *map)</pre>	</TD></TR></TABLE></CENTER><P>This function takes a pair of polygons as parameters and returns a mapping.Both polygons should have the same number of points; the number can vary from 1to 4. Thus, both polygons contain either a point, a line, a triangle, or aquadrilateral. The mapping returned by the function projects the first polygononto the second.</p><BR><CENTER><TABLE BORDER=0 WIDTH=550><TR><td bgcolor="#E6E6E6" align=left><P><B>Note:</B><BR><code>PolyToPolyMap</code> is roughly the inverse function of <code>MapPoints</code>, whichcomputes how a mapping will transform a list of points. For more information on<code>MapPoints</code>, see p. 8-66 of <cite>Inside Macintosh: QuickDraw GX Environment andUtilities.</cite></P></TD></TR></TABLE></CENTER><BR><P><A HREF="#top">Back to top</A></P><a name="RTFToC3"></a><h2>Working with MappingLibrary.c</h2><P><code>PolyToPolyMap</code> can be used to compute the mapping that projects one shape into aspecified area. Just as the QuickDraw routines <code>MapPt</code>, <code>MapRect</code>, <code>MapRgn</code> and<code>MapPoly</code> allow mapping geometries from a source rectangle to a destinationrectangle, <code>PolyToPolyMap</code> can be used to do the same thing with any QuickDraw GXshape. Here's an example: </p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>#include &quot;GraphicsLibraries.h&quot;static void MapAnything(gxShape shape, gxRectangle source, gxRectangle destination){    struct{                long countOf2;                gxPoint points[2];             } sourcePoly, destPoly;    gxMapping map;    sourcePoly.countOf2 = 3;    sourcePoly.points[0].x = source.left;    sourcePoly.points[0].y = source.top;    sourcePoly.points[1].x = source.right;    sourcePoly.points[1].y = source.top;    sourcePoly.points[2].x = source.right;    sourcePoly.points[2].y = source.bottom;    destPoly.countOf2 = 2;    destPoly.points[0].x = destination.left;    destPoly.points[0].y = destination.top;    destPoly.points[1].x = destination.right;    destPoly.points[1].y = destination.top;    destPoly.points[2].x = destination.right;    destPoly.points[2].y = destination.bottom;    PolyToPolyMap((gxPolygon*) &amp;sourcePoly, (gxPolygon*) &amp;destPoly,                        &amp;map);    GXMapShape(shape, &amp;map);}</pre>	</TD></TR></TABLE></CENTER><P>This example describes the two rectangles as a pair of triangles from the upperleft to the upper right to the lower right. The mapping returned by <code>PolyToPolyMap</code> maps the firsttriangle to the second. Similarly, it will map the shape so that its former scaleand position relative to the first rectangle is the same as its subsequentscale and position relative to the second rectangle.</p><P>If the two polygons passed to <code>PolyToPolyMap</code> contain points, the resultingmapping will translate one point to the other. If they contain lines, themapping translates and scales. If they contain triangles, the mapping isaffine; that is, it translates, scales, skews and/or rotates from one to theother. If they contain quadrilaterals, then the perspective elements of thematrix can be used as well to project one to the other.</p><P><A HREF="#top">Back to top</A></P><a name="RTFToC4"></a><h2>PolyToPolyMap Limitations and Solutions</h2><P>There are limitations that developers need to be aware of. For instance, if thequadrilateral points form a bow tie (they cross), then <code>PolyToPolyMap</code> can'tsucceed. It will likely generate an overflow in one of the math calculations,and pin the resulting value to <code>0x7FFFFFFF</code> or <code>0x80000000</code> (GX's equivalents toplus and minus infinity). You may also find that more pedestrian pairs ofquadrilaterals can fail.</p><P>This is why the libraries are supplied in source form -- so developers can fixand personalize them.</p><h3>A Sample Quadrilateral Limitation and Solutions</h3><P>The limitation that causes some quadrilaterals to fail is in lines 107 through115 of MappingLibrary.c; the calls to <code>FractDivide</code> can go out of range. Onesimple solution is to replace these calls with <code>FixedDivide</code> and replace the fouroccurrences of <code>FractMultiply</code> in lines 117 through 121 with <code>FixedMultiply</code>. Thismay affect the accuracy of the results, however.</p><P>A more ambitious solution is to determine the number of significant bits in therelevant variables, then maximize the precision without overflowing.</p><P>Replace lines 106 - 109 with: </p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>    Fract a1;    Fract numerator, denominator;    if ( x2 &gt; 0 ? y2 &gt; 0 ? x2 &gt; y2 : x2 &gt; -y2 : y2 &gt; 0 ? -x2 &gt; y2 : x2                &lt; y2) {         numerator = MultiplyDivide(x0 - x1, y2, x2) - y0 + y1;        denominator = MultiplyDivide(x1, y2, x2) - y1;} else {        numerator = x0 - x1 - MultiplyDivide(y0 - y1, x2, y2);        denominator = x1 - MultiplyDivide(y1, x2, y2);}Fract absNum = numerator, absDenom = denominator;if (absNum &lt; 0)    absNum = -absNum;if (absDenom &lt; 0)    absDenom = -absDenom;absDenom += absDenom;int a1Shift = 0;while (absNum &gt;= absDenom) {    a1Shift++;    absNum &lt;&lt;= 1;}a1 = FractDivide(numerator &lt;&lt; a1Shift, denominator);scaleY &lt;&lt;= a1Shift;</pre>	</TD></TR></TABLE></CENTER><P>(You'll have to twiddle the variable declarations if you're using C instead ofC++.)</p><P>Repeat this substitution in lines 112 - 115 to compute a2, a2Shift andscaleX.</p><P>Then replace line 120 with: </p><CENTER><TABLE BORDER=0 CELLPADDING=5 WIDTH=550><TR>	<td bgcolor="#E6E6E6" align=left><pre>*destPtr++ = FixedDivide(FractMultiply(a1, source[1].x) +    (source[1].x - source[0].x &lt;&lt; a1Shift), scaleY);</pre>	</TD></TR></TABLE></CENTER><P>Similarly, update lines 117, 118 and 121.</p><P>The complete integration of these changes is left to the reader.</p><P>With these changes, <code>PolyToPolyMap</code> will return the correct result for mostvisibly useful pairs of polygons. In the four point case, useful polygons areones that are convex; that is, they shouldn't look like arrowheads, haveconsecutive line segments that form a straight line, or as mentioned before,cross over themselves. In the three point case, useful polygons enclose anarea; that is, the triangles do not degenerate into lines; and in the two pointcase, the lines should not degenerate into points.</p><P><A HREF="#top">Back to top</A></P><a name="RTFToC5"></a><h2>Summary</h2><P>GX Libraries have a wealth of information and show how to use QuickDraw GX tosolve real problems. The Mapping Library shows how to use GX to constructmappings that project shapes into the desired coordinates so that one to fourreference points match up. This makes creating perspective mappings easywithout resorting to using QuickDraw 3D.</p><BR><P><A HREF="#top">Back to top</A></P><a name="References"></a><h2>References</h2><p>MacOS SDK CD, Development Kits (Disc 1): QuickDraw GX: Programming Stuff: GXLibraries</p><p><i>Inside Macintosh: QuickDraw GX Objects</i></p><p><i>Inside Macintosh: QuickDraw GX Environment and Utilities</i></p><BR><P><A HREF="#top">Back to top</A></P>          <A NAME=Downloads></A>                  <H2>Downloadables</H2>                  <TABLE BORDER=0 CELLPADDING=3 WIDTH="100%">            <TR>               <td width=50 align=left>                  <P ALIGN=center><img src="images/acrobatsmall.gif" width=22 height=23 align=middle alt="Acrobat gif"></P>               </TD>               <td align="left">                  <P>Acrobat version of this Note (56K).</P>               </TD>               <td width=60 align=left>                  <P><A HREF="pdf/tn1037.pdf">Download</A></P>               </TD>            </TR>         </TABLE>         <BR><BR><P><A HREF="#top">Back to top</A></P></TD></TR></TABLE></CENTER>		<!-- end_content --><!-- begin_footer_information -->	<table width="680" border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td><div style="width: 100%; height: 1px; background-color: #919699; margin-top: 5px; margin-bottom: 15px"></div></td>
		</tr>
		<tr>
			<td align="center"><br/>
				<table border="0" cellpadding="0" cellspacing="0" class="graybox">
					<tr>
						<th>Did this document help you?</th>
					</tr>
					<tr>
						<td>
						    <div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=1&url=/technotes/tn/tn1037.html%3Fid%3DDTS10002879-1.0&media=dvd" target=_new>Yes</a>:  Tell us what works for you.</div>
							<div style="margin-bottom: 8px"><a href="http://developer.apple.com/feedback/?v=2&url=/technotes/tn/tn1037.html%3Fid%3DDTS10002879-1.0&media=dvd" target=_new>It&#8217;s good, but:</a> Report typos, inaccuracies, and so forth.</div>
							<div><a href="http://developer.apple.com/feedback/?v=3&url=/technotes/tn/tn1037.html%3Fid%3DDTS10002879-1.0&media=dvd" target=_new>It wasn&#8217;t helpful</a>: Tell us what would have helped.</div>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
<!--#include virtual="/includes/footer"--><!-- end_footer_information --></BODY></HTML>