<HTML><HEAD><META NAME="GENERATOR" CONTENT="Adobe FrameMaker 5.5/HTML Export Filter"><script language="JavaScript" src="frametest.js"></script><TITLE> Addressing Mode Conversion</TITLE></HEAD><BODY BGCOLOR="#ffffff"><DIV><a name="top"></a><!-- start of banner --><!--#include virtual="/includes/framesetheader" --><!-- end of banner --><!-- start of path --><font face="Geneva,Helvetica,Arial" size="1"><b><br>PATH<spacer type="horizontal" size="5">&nbsp;</b><a href="http://developer.apple.com/" target="_top">ADC Home</a> &gt; <a href="../../../../index.html#//apple_ref/doc/uid/TP30000440" target="_top">Documentation</a> &gt; <!-- a href="" target="_top" -->Hardware<!-- /a -->  <b>&gt; </b><a href="../../devicemgrs.html" target="_top">Device Managers and Drivers</a> <b>&gt; </b><a href="../pci_srvcs.html" target="_top">PCI Card Services</a> <b>&gt; </b>Designing PCI Cards and Drivers for Power Macintosh Computers</font><br><br><!-- end of path --><A HREF="PCI_BOOK.1e.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.1e.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.20.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><HR></DIV><H1 CLASS="H2.Heading2"><A NAME="pgfId=3393"> </A>Addressing Mode Conversion</H1><P CLASS="T1.Text1"><A NAME="pgfId=3394"> </A>With the PCI bus (in the 32-bit version that Power Macintosh uses), fields more than 4 bytes long must be transferred in multiple operations. When writing a field from one location to another by means of multiple transfers, the bus must take into account the addressing modes of both the source and destination of the data so that it can disassemble and reassemble the field correctly. <A NAME="marker=3395"> </A>One way to convert data from one addressing mode to the other is to reverse the order of bytes within each field, so that a pointer to the most significant byte of a field will point to the least significant byte, and vice versa. Note that the addresses of the data bytes do not change. This technique, called <B CLASS="bold">address-invariant byte swapping,</B> maintains the address invariants of data bytes. It is illustrated in <A HREF="PCI_BOOK.1f.html#15713" CLASS="XRef">Figure&nbsp;2-2</A>.</P><P CLASS="Fg.Figure"><B><A NAME="pgfId=3403"> </A>Figure&nbsp;2-2	<A NAME="15713"> </A>Big-endian to big-endian bus transfer</B></P><DIV><IMG SRC="PCI_BOOK-6.gif"></DIV><DIV><blockquote><p CLASS="NoteHead"><b><A NAME="pgfId=13787"> </A>Note</b></p><P CLASS="Note"><A NAME="pgfId=3404"> </A>The difference between big-endian and little-endian formats applies only to data; the Macintosh system always transfers addresses as unbroken 32-bit quantities. </P></blockquote><P CLASS="T1.Text1"><A NAME="pgfId=3410"> </A><A NAME="marker=3408"> </A>PowerPC processors and processors of the Motorola <A NAME="marker=3409"> </A>68000 family use big-endian addressing; <A NAME="marker=3411"> </A>Intel processors and the PCI bus use little-endian addressing. Different I/O chips, expansion card memories, and peripheral devices may use one addressing mode or the other, so data in versatile computing systems such as Power Macintosh must often be accessed in either form.</P><P CLASS="T1.Text1"><A NAME="pgfId=3415"> </A><A HREF="PCI_BOOK.1f.html#15713" CLASS="XRef">Figure&nbsp;2-2</A> illustrates what happens when data from a big-endian source passes over the little-endian PCI bus and is written to a big-endian destination. The bytes in the source and destination are numbered from 0 to 7.</P><P CLASS="T1.Text1"><A NAME="pgfId=3416"> </A>The Power Macintosh hardware supports both big-endian and little-endian addressing. To accommodate various combinations of source and destination byte formats, Power Macintosh systems contain two mechanisms that translate between these <A NAME="marker=3417"> </A>addressing modes:</P><UL><LI CLASS="B1.Bullet1"><A NAME="pgfId=3418"> </A>A group of byte-reversed indexed load and store actions are included in the PowerPC instruction set--for example, the <TT CLASS="cv">lwbrx</TT> (load word byte-reversed index) instruction. These instructions can convert either big-endian or little-endian data to the other format, because the two formats are complementary. C programs can perform the same operations by using endian swap routines.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3420"> </A>The <A NAME="marker=3419"> </A>PowerPC processor supports a little-endian addressing mode that changes the way in which real addresses are used to access physical storage. It applies a logical exclusive-OR operation with a constant to the lowest 3 bits of the address, using a different constant for each size of data. This modifies each address to the value it would have if the PowerPC processor used little-endian addressing.</LI></UL><P CLASS="T1.Text1"><A NAME="pgfId=3421"> </A>The PowerPC system software also contains a pair of utility routines that convert 16- and 32-bit values into the other endian format by means of byte swapping. These utilities are described in <A HREF="PCI_BOOK.1d0.html#20337" CLASS="XRef">Byte Swapping Routines</A>.</P><P CLASS="T1.Text1"><A NAME="pgfId=3427"> </A>For more detailed information about endian conversion, see <A HREF="PCI_BOOK.243.html#39323" CLASS="XRef">Big-Endian and Little-Endian Addressing</A>.</P><P CLASS="T1.Text1"><A NAME="pgfId=3429"> </A>Programs and subsystems that exchange data only internally can usually adopt either big-endian or little-endian addressing without taking into account the difference between the two. As long as they operate consistently, they will always store and retrieve data correctly. Systems that exchange data with other devices or subsystems, however, including those that communicate over the PCI bus, may need to determine the addressing mode of the external system and adapt their data formats accordingly.</P><P CLASS="T1.Text1"><A NAME="pgfId=3430"> </A>When designing PCI cards for Power Macintosh computers, including their associated software, observe the following general cautions about byte formats:</P><UL><LI CLASS="B1.Bullet1"><A NAME="pgfId=3431"> </A>The PowerPC microprocessor and the PCI host bridges are set for big-endian addressing when running a big-endian operating system such as Mac OS.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3432"> </A>Most compilers do not provide support for switching data from one addressing mode to another or for using the PowerPC mechanisms that switch modes. Such support can be provided, for example, by a set of C macros that redefine the access mechanisms for basic data types.</LI><LI CLASS="B1.Bullet1"><A NAME="pgfId=3433"> </A>Frame buffers for video and graphics must support the Macintosh big-endian pixel format, as described in <A HREF="PCI_BOOK.21.html#15864" CLASS="XRef">Frame Buffers</A> later in this chapter.<A NAME="marker=3437"> </A></LI></UL></DIV><HR>&#169 1999 Apple Computer, Inc. &#150 (Last Updated 26 March 99)<P><A HREF="PCI_BOOK.1e.html"><img src="images/up.gif" border="0" width="36" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.1e.html"><img src="images/previous.gif" border="0" width="66" height="16"></A><nobr>&nbsp;</nobr><A HREF="PCI_BOOK.20.html"><img src="images/next.gif" border="0" width="49" height="16"></A><!-- insert Show/Hide frames --><a href="javascript:testFrame()"><script><!--document.write(frameLink);//--></script><!-- end Show/Hide frames --></A><!-- start of footer --><!--#include virtual="/includes/framesetfooter" --><!-- end of footer --></body></HTML>